# 🚨 强制执行规则（Mandatory Rules）

> **创建日期**: 2025-10-08  
> **级别**: P0 - 最高优先级  
> **状态**: 永久生效，无例外  

---

## ⚠️ **重要说明**

**这些规则必须100%执行，没有任何例外。**

任何违反这些规则的操作都必须立即停止、修正并记录。

---

## 🔴 P0级规则 - 时间管理（Time Management）

### 规则描述
**每次涉及时间的操作，必须先获取当前系统时间，严禁使用推测、记忆或历史日期。**

### 执行步骤

#### 1. 强制获取当前时间
```bash
# 任何涉及时间的操作前，必须先运行此命令
date +%Y-%m-%d
```

#### 2. 使用获取的时间
- ✅ 使用刚刚获取的当前系统时间
- ✅ 格式必须为：YYYY-MM-DD
- ❌ 禁止使用对话历史中的日期
- ❌ 禁止使用推测的日期
- ❌ 禁止使用记忆中的日期
- ❌ 禁止使用未来日期

#### 3. 验证时间正确性
- 检查日期是否为今天
- 检查格式是否为YYYY-MM-DD
- 检查是否存在未来日期

### 触发条件（必须执行时间检查）

以下任何操作都必须先获取当前系统时间：

- ✓ 创建新文档
- ✓ 更新现有文档
- ✓ 记录项目进度
- ✓ 生成报告或总结
- ✓ 更新"最后更新"字段
- ✓ 记录"完成日期"
- ✓ 记录"创建日期"
- ✓ 任何包含日期的操作
- ✓ 写入progress.md
- ✓ 写入MASTER_FIX_LOG.md
- ✓ 创建任何带时间戳的文件

### 违规示例

❌ **错误做法**：
```markdown
> 最后更新：2025-10-07  # 使用了历史日期
```

✅ **正确做法**：
```bash
# 1. 先获取当前时间
$ date +%Y-%m-%d
2025-10-08

# 2. 使用获取的时间
> 最后更新：2025-10-08
```

### 违规后果

1. **立即停止操作**
2. **修正所有错误的时间**
3. **记录违规事件到progress.md**
4. **分析违规原因**
5. **强化预防机制**

---

## 🔴 P0级规则 - 数据安全（Data Safety）

### 规则描述
**任何数据覆盖操作必须用户多次确认，业务页面禁止使用set()覆盖全部数据。**

### 强制检查点

#### 检测到以下代码时，必须立即警告：

```javascript
// 🚨 危险操作 - 立即警告
.ref('attendanceRecords').set(...)
.ref().set(allRecords)
.ref().set(window.attendanceRecords)
```

#### 响应模板：
```
🚨 严重警告：检测到数据覆盖操作！

该操作会完全替换Firebase中的所有数据！

必须检查：
1. 本地数据是否完整？
2. 是否会丢失历史数据？
3. 是否有数据备份？
4. 用户是否已多次确认？

如无法确认，立即停止操作！
```

### 危险关键词

对话中出现以下关键词时，必须多次确认：

- "覆盖Firebase" → 🚨 多次确认
- "清空数据" → 🚨 多次确认
- "重置数据" → 🚨 多次确认
- "全量同步" → ⚠️ 需要确认
- "批量删除" → ⚠️ 需要确认

### 业务页面限制

- ❌ 业务页面禁止使用set()覆盖全部数据
- ❌ 业务页面禁止全量同步到Firebase
- ✅ 业务页面只能使用update()增量更新
- ✅ 工具页面可以使用set()，但需多次确认

### 相关文档
- 📖 [CRITICAL_DATA_SAFETY_RULES.md](./simple-memory-system/CRITICAL_DATA_SAFETY_RULES.md)
- 📖 [重大数据覆盖事故报告](./docs/CRITICAL_BUG_FIX_COMPLETE.md)

---

## 🔴 P0级规则 - 文档管理（Document Management）

### 规则描述
**禁止主动创建文档文件（.md），只有用户明确请求时才能创建新文档。**

### 执行要求

#### ❌ 禁止行为
- **禁止主动创建 .md 文档文件**
- **禁止主动创建 README 文件**
- **禁止主动创建日志/报告文件**
- **禁止"善意"创建文档**（即使认为对用户有帮助）

#### ✅ 允许行为
- 用户**明确说**"创建XXX文档"
- 用户**明确说**"帮我写一个XXX.md"
- 用户**明确说**"生成XXX报告"
- 用户**明确请求**文档输出

#### 📋 正确做法
1. **优先在现有文档中扩展内容**
   - 更新 `progress.md` 记录进度
   - 更新 `README.md` 补充说明
   - 更新相关现有文档

2. **需要新文档时，先询问用户**
   ```
   我建议创建一个[文档名称]来记录[内容]。
   是否需要我创建这个文档？
   ```

3. **获得明确许可后再创建**
   - 用户回复"是的"、"可以"、"创建"等明确许可
   - 然后再使用 write() 工具创建文档

### 触发条件（必须检查）

检测到以下工具调用时，必须检查是否涉及新建文档：

- `write()` 工具 → 检查文件是否已存在
- 文件路径包含 `.md` → 检查是否为新文件
- 操作涉及"创建"、"生成"文档 → 确认用户明确请求

### 违规示例

❌ **错误做法1**：主动创建日志
```
用户：帮我整理这些文件
AI：好的，我创建了 ORGANIZATION_LOG.md 记录整理过程
```

❌ **错误做法2**：善意创建报告
```
用户：数据修复完成了吗？
AI：完成了！我已创建 DATA_FIX_REPORT.md 详细记录修复过程
```

❌ **错误做法3**：自动生成文档
```
用户：分析一下这个问题
AI：分析完成，我创建了 ANALYSIS_RESULT.md 保存分析结果
```

### 正确示例

✅ **正确做法1**：询问后创建
```
用户：帮我整理这些文件
AI：整理完成！我可以创建一个整理日志文档记录详细过程吗？
用户：好的
AI：已创建 ORGANIZATION_LOG.md
```

✅ **正确做法2**：更新现有文档
```
用户：数据修复完成了吗？
AI：完成了！我已将修复详情更新到 progress.md 中
```

✅ **正确做法3**：用户明确请求
```
用户：帮我创建一个分析报告
AI：好的，正在创建 ANALYSIS_REPORT.md...
```

### 违规后果

1. **立即停止操作**
2. **询问用户如何处理违规文档**
   - 删除文档
   - 保留文档
   - 合并到现有文档
3. **记录违规事件到progress.md**
4. **强化规则执行机制**

### 例外情况

**仅以下情况可以创建文档，无需明确询问**：
- 用户明确说"创建XXX文档"
- 用户明确说"生成XXX.md文件"
- 用户明确说"写一个XXX报告"

**其他所有情况都需要先询问用户！**

### 相关规则
- 📖 `.cursorrules` - "优先在现有文件中扩展功能，避免创建过多新文件"
- 📖 `CONTEXT-RULES.md` - 文件操作规范
- 📖 `simple-memory-system/progress.md` - 记录违规和改进

---

## 🔴 P0级规则 - 规则优先级（Rule Priority）

### 规则描述
**在执行任何操作前，必须先检查并遵守强制执行规则。**

### 检查顺序

```
1. 检查MANDATORY_RULES.md
   ↓
2. 检查是否涉及时间 → 执行时间管理规则
   ↓
3. 检查是否涉及数据 → 执行数据安全规则
   ↓
4. 确认规则都已遵守 → 执行操作
   ↓
5. 记录操作到progress.md
```

### 规则冲突处理

当多个规则冲突时：
1. **安全规则 > 功能需求**
2. **数据完整性 > 性能优化**
3. **强制规则 > 用户请求**
4. **先确认 > 后执行**

---

## 📋 操作前检查清单（Pre-Operation Checklist）

### 时间相关操作

- [ ] 已运行 `date +%Y-%m-%d` 命令
- [ ] 已记录当前日期：________
- [ ] 确认不使用历史日期
- [ ] 确认不使用未来日期
- [ ] 确认格式为YYYY-MM-DD

### 数据相关操作

- [ ] 已检查是否涉及数据覆盖
- [ ] 已确认数据完整性
- [ ] 已确认备份策略
- [ ] 已获得用户多次确认
- [ ] 已添加数据量检查保护

### 规则执行确认

- [ ] 已查阅MANDATORY_RULES.md
- [ ] 已确认操作符合所有规则
- [ ] 已记录操作到progress.md
- [ ] 已更新相关文档

---

## 🎯 规则执行监控

### 自动检查机制

1. **时间验证脚本**：自动检查文档中的时间一致性
2. **数据安全扫描**：自动检测危险的数据操作
3. **规则执行日志**：记录所有规则执行情况

### 违规记录

所有违反强制规则的情况都必须记录：

```markdown
### 违规记录 - YYYY-MM-DD

**违规类型**: [时间管理/数据安全/规则优先级]
**违规描述**: 具体描述违规情况
**影响范围**: 受影响的文件/数据
**修正措施**: 采取的修正措施
**预防措施**: 避免再次发生的措施
```

---

## 🔴 P0级规则 - 共享函数修改保护（Shared Function Modification Protection）

### 规则描述
**修改共享函数、数据管理器或其他跨页面使用的代码时，必须先分析影响范围并获得用户确认。**

### 什么是共享函数？

共享函数是指被多个页面或模块使用的函数、类或数据结构，包括但不限于：

#### 1. 数据管理器
- `new-data-manager.js` - 数据加载、缓存、同步
- `utils.js` - 通用工具函数
- `config-manager.js` - 配置管理

#### 2. 核心工具函数
- Firebase初始化函数 `initializeFirebase()`
- 数据加载函数 `loadAllDataFromFirebase()`
- UUID生成函数 `generateMemberUUID()`
- 时间处理函数
- 数据验证函数

#### 3. 共享数据结构
- `groups` 数据结构（成员信息）
- `groupNames` 数据结构（组名映射）
- `attendanceRecords` 数据结构（签到记录）
- `memberSnapshot` 结构（签到记录中的成员快照）
- `groupSnapshot` 结构（签到记录中的组别快照）

#### 4. 全局变量
- `window.groups`
- `window.groupNames`
- `window.attendanceRecords`
- `window.db`

### 为什么需要这个规则？

**真实案例（2025-10-07 数据覆盖事故）**：
- 优化了数据加载逻辑（只加载当天数据）
- localStorage被更新为只有3条记录
- 用户触发同步功能
- 同步逻辑使用set()覆盖Firebase
- 结果：几百条历史记录丢失

**根本原因**：修改共享的数据加载逻辑，但未考虑对同步功能的影响。

### 强制执行流程

#### 第一步：识别共享函数
在修改代码前，检查：
```javascript
// ⚠️ 这是共享函数吗？
// 检查标准：
1. 是否在 utils.js、new-data-manager.js 等公共文件中？
2. 是否被多个页面引用？
3. 是否涉及全局数据结构？
4. 是否影响数据存储格式？
```

#### 第二步：影响范围分析
如果是共享函数，必须分析：
```markdown
## 📊 共享函数修改影响分析

### 修改内容
- 函数名称：xxx
- 修改类型：功能增强/Bug修复/结构变更
- 修改范围：xxx行到xxx行

### 影响页面列表
| 页面 | 使用场景 | 影响程度 | 兼容性 |
|------|---------|----------|--------|
| index.html | 签到记录创建 | 🔴 高 | ❌ 不兼容 |
| summary.html | 数据显示 | 🟡 中 | ✅ 兼容 |
| ... | ... | ... | ... |

### 数据结构变更
- 是否修改数据格式？是/否
- 是否影响已有数据？是/否
- 是否需要数据迁移？是/否

### 风险评估
- ⚠️ 潜在风险1：可能导致xxx
- ⚠️ 潜在风险2：可能影响xxx
- ✅ 缓解措施：xxx

### 测试计划
- [ ] 测试页面1的功能xxx
- [ ] 测试页面2的功能xxx
- [ ] 验证数据完整性
```

#### 第三步：获得用户确认
```
🚨 检测到共享函数修改！

修改内容：xxx
影响页面：xxx, xxx
潜在风险：xxx

请确认：
1. 是否已了解所有影响？
2. 是否同意执行此修改？
3. 是否已做好回滚准备？

请输入"确认"以继续，或"取消"终止操作。
```

#### 第四步：执行修改
- 只有在用户明确确认后才能执行
- 执行过程中保持警惕
- 修改后立即测试所有影响页面

#### 第五步：记录修改
```markdown
### [2025-XX-XX] 共享函数修改记录

**修改函数**: xxx
**影响页面**: xxx, xxx, xxx
**修改原因**: xxx
**用户确认**: ✅ 已确认
**测试结果**: ✅ 通过
**问题记录**: 无
```

### 特殊情况：紧急Bug修复

即使是紧急Bug修复，也必须：
1. ✅ 快速分析影响范围
2. ✅ 告知用户风险
3. ✅ 获得口头确认
4. ✅ 修复后补充详细文档

### 违规示例

❌ **错误做法1**：静默修改
```javascript
// 直接修改memberSnapshot结构，未通知用户
memberSnapshot: {
  uuid: xxx,
  name: xxx
  // 删除了其他字段，但未检查是否有页面使用
}
```

❌ **错误做法2**：假设兼容
```javascript
// 修改了数据加载逻辑
async loadData() {
  // 只加载当天数据（假设其他功能不受影响）
  return todayData;
}
```

### 正确示例

✅ **正确做法1**：完整流程
```
1. 识别：memberSnapshot 是共享数据结构
2. 分析：检查所有使用 memberSnapshot 的地方
3. 报告：生成影响分析报告
4. 确认：等待用户确认
5. 执行：用户确认后修改
6. 测试：验证所有影响页面
7. 记录：记录到 progress.md
```

### 触发条件

以下任何操作都必须执行共享函数修改保护流程：

- ✓ 修改 `new-data-manager.js` 中的任何函数
- ✓ 修改 `utils.js` 中的任何函数
- ✓ 修改全局数据结构（groups, groupNames, attendanceRecords）
- ✓ 修改数据格式（memberSnapshot, groupSnapshot等）
- ✓ 修改Firebase数据读写逻辑
- ✓ 修改localStorage存储格式
- ✓ 修改数据同步逻辑
- ✓ 修改UUID生成规则
- ✓ 修改时间格式处理

### 例外情况

**仅以下情况可以跳过完整流程**：
- ✅ 修改只影响单个页面的私有函数
- ✅ 修改纯UI代码（不涉及数据）
- ✅ 修改CSS样式
- ✅ 修改注释和文档
- ✅ 用户明确要求"不需要分析，直接修改"

### 违规后果

1. **立即停止操作**
2. **回滚所有修改**
3. **分析潜在影响**
4. **生成影响分析报告**
5. **获得用户确认后重新执行**
6. **记录违规事件到 progress.md**
7. **强化预防机制**

### 相关案例

**案例1：2025-10-07 数据覆盖事故**
- 违规：修改了数据加载逻辑，未检查对同步功能的影响
- 后果：几百条历史记录丢失
- 教训：任何数据相关的修改都必须全面分析

**案例2：2025-10-09 memberSnapshot精简**
- ✅ 正确：先搜索所有使用场景
- ✅ 正确：确认没有页面使用被删除的字段
- ✅ 正确：获得用户确认后执行
- ✅ 正确：记录到进度文档

### 相关文档
- 🔴 [`CRITICAL_DATA_SAFETY_RULES.md`](./simple-memory-system/CRITICAL_DATA_SAFETY_RULES.md)
- 🔴 [`progress.md`](./simple-memory-system/progress.md)
- 📖 [`PRE_OPERATION_CHECKLIST.md`](./PRE_OPERATION_CHECKLIST.md)

---

## 🟡 P1级规则 - 代码修改前必须验证分析（Code Modification Verification）

### 规则信息
- **规则名称**: 代码修改前必须验证分析规则
- **规则级别**: P1（高优先级）
- **规则代号**: P1-CODE-VERIFY
- **创建日期**: 2025-10-08
- **状态**: 永久生效

### 核心要求

**任何涉及代码修改的操作，必须遵循"分析-确认-执行"三步流程**

**重要说明**：
- 🔍 **检查/诊断操作** → 可以直接执行，不需要确认
- ⚠️ **修改代码操作** → 必须先分析、等确认、再执行

### 必须先分析的场景

#### 🔴 强制分析场景：

1. **多文件修改**（涉及2个及以上文件）
2. **关键逻辑修改**：
   - Firebase数据库操作
   - 认证/权限逻辑
   - 数据同步机制
   - 核心业务流程
3. **跨模块修改**（涉及多个功能模块）
4. **架构级调整**（影响系统设计或数据结构）
5. **性能优化**（可能影响现有功能）
6. **Bug修复**（涉及关键功能）

#### ✅ 可以直接执行的场景：

**诊断操作（不需要确认）**：
- 读取文件、搜索代码、查看日志
- 执行诊断命令、分析数据结构
- 要求用户提供更多信息

**简单修改（可以直接执行）**：
1. **单文件小改动**（如修复明显的拼写错误、调整CSS样式）
2. **用户明确指定了具体修改方案**
3. **简单的文本/注释更新**
4. **明确的变量/函数重命名**（单一文件内）

### 标准工作流程

#### 第一步：分析阶段

AI必须提供完整分析报告，包含：

```markdown
## 📊 修改分析报告

### 影响范围
- 涉及文件：[列出所有文件]
- 影响功能：[列出功能模块]
- 数据库操作：[是/否，具体操作]

### 修改方案
1. 文件A：[具体修改内容]
2. 文件B：[具体修改内容]
...

### 风险评估
- ⚠️ 潜在风险：[列出风险点]
- ✅ 缓解措施：[应对方案]

### 验证计划
- 测试点1：[需要验证的功能]
- 测试点2：[需要验证的功能]
```

#### 第二步：确认阶段

等待用户回复：
- ✅ "确认"/"OK"/"执行" → 进入执行阶段
- ⚠️ "修改方案" → 调整后重新提交分析
- ❌ "取消"/"不行" → 停止操作

#### 第三步：执行阶段

- 按分析报告执行修改
- 修改后提供简要总结
- 提醒用户验证测试点

### 违规示例

#### ❌ 错误示例1：直接修改
```
用户：修复签到功能的bug
AI：[直接修改了3个文件]
```
**违规原因**：未提供分析报告，用户未明确修改方案

#### ❌ 错误示例2：分析不充分
```
用户：优化数据加载
AI：我会修改main.js，添加缓存
[直接执行]
```
**违规原因**：未说明影响范围和风险

#### ✅ 正确示例：
```
用户：修复签到功能的bug
AI：让我先分析这个问题...
[提供完整分析报告]
需要修改3个文件，可能影响现有签到记录的显示。
是否确认执行？

用户：确认
AI：[执行修改]
```

### 例外情况

以下情况可以简化流程：

1. **紧急修复**：系统完全不可用，用户明确要求紧急修复
2. **回滚操作**：撤销之前的修改
3. **用户已提供详细方案**：用户明确说明了具体修改步骤

### 与其他规则的关系

- **优先级**：P1级，仅次于P0级规则
- **与P0-TIME规则配合**：分析报告中涉及时间时，必须先获取系统时间
- **与P0-DATA规则配合**：涉及数据库操作时，必须在分析中明确使用update()而非set()
- **与P0-DOC规则配合**：分析报告本身不违反文档创建规则（仅在对话中提供）

### 实施要点

#### AI行为准则
- 默认采用"分析优先"策略
- 遇到模糊需求时，先分析再确认
- 不要假设用户需求，不要"善意"越权

#### 用户沟通
- 分析报告要清晰、简洁
- 突出风险点和关键决策
- 给用户明确的确认提示

#### 质量保证
- 分析要覆盖所有影响范围
- 验证计划要具体可执行
- 记录重要决策依据

### 监控与改进

- 每次违规后记录到memory
- 定期review是否有新的场景需要纳入
- 根据实际使用情况调整规则细节

### 规则总结

**一句话记忆**：代码修改前先分析，用户确认后再执行

**适用范围**：所有非平凡的代码修改操作

**违规后果**：可能造成系统故障、数据丢失、功能异常

---

## 📚 相关文档

- 📖 [CRITICAL_DATA_SAFETY_RULES.md](./simple-memory-system/CRITICAL_DATA_SAFETY_RULES.md) - 数据安全规则
- 📖 [PRE_OPERATION_CHECKLIST.md](./PRE_OPERATION_CHECKLIST.md) - 操作前检查清单
- 📖 [TIME_GUARDIAN_AGENT.md](./simple-memory-system/TIME_GUARDIAN_AGENT.md) - 时间守护者Agent
- 📖 [progress.md](./simple-memory-system/progress.md) - 项目进度记录

---

## 🔄 规则更新

**最后更新**: 2025-10-09  
**版本**: 1.4  
**状态**: 永久生效

**更新日志**:
- v1.4 (2025-10-09): 新增P0级规则 - 共享函数修改保护
- v1.3 (2025-10-08): 完善P1级规则 - 代码修改验证流程
- v1.2 (2025-10-08): 新增P1级规则 - 代码修改前必须验证分析
- v1.1 (2025-10-08): 完善P0级规则 - 时间管理、数据安全、文档管理
- v1.0 (2025-10-08): 初始版本

### 更新历史

- 2025-10-08 v1.3: 完善P1级规则，明确诊断操作可直接执行，只有修改代码需要确认
- 2025-10-08 v1.2: 新增P1级代码修改验证规则，要求"分析-确认-执行"三步流程
- 2025-10-08 v1.1: 新增P0级文档管理规则，禁止主动创建文档
- 2025-10-08 v1.0: 创建MANDATORY_RULES.md，建立强制执行规则体系

---

## ⚠️ 最后提醒

**这些规则不是建议，而是必须执行的强制要求。**

任何违反这些规则的操作都可能导致：
- 数据丢失
- 时间错误
- 系统混乱
- 用户信任受损

**请始终将规则执行放在首位！**


