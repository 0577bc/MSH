<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>成员管理</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="./src/style.css?v=202510141952">
  <!-- 引入配置文件 -->
  <script src="./src/smart-config-loader.js"></script>
  <!-- 引入配置管理器 -->
  <script src="./src/config-manager.js"></script>
  <!-- 引入CSRF保护 -->
  <script src="./src/csrf-protection.js"></script>
  <!-- 引入缓存管理器 -->
  <script src="./src/cache-manager.js"></script>
  <!-- 引入性能监控 -->
  <script src="./src/performance-monitor.js"></script>
  <!-- 引入 Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>
  <main id="groupManagementContent">
    <header class="page-header">
      <h1>成员管理</h1>
      <div class="header-actions">
        <button id="backToAdminButton" type="button" class="back-button" aria-label="返回管理页面">返回管理页面</button>
        <button id="backToMainButton" type="button" class="back-button" aria-label="返回签到页面">返回签到页面</button>
      </div>
    </header>


    <!-- 添加小组表单 -->
    <div id="addGroupForm" class="form-dialog hidden-form">
      <div class="dialog-content">
        <h3>添加小组</h3>
        <form id="addGroupFormElement">
          <div class="form-group">
            <label for="newGroupName">小组名称：</label>
            <input type="text" id="newGroupName" placeholder="请输入小组名称" required aria-label="小组名称">
          </div>
          <div class="form-group">
            <label for="newGroupDescription">小组描述：</label>
            <textarea id="newGroupDescription" placeholder="请输入小组描述（可选）" rows="3" aria-label="小组描述"></textarea>
          </div>
          <div class="dialog-buttons">
            <button id="saveGroupButton" type="button" class="primary-button">保存</button>
            <button id="cancelGroupButton" type="button" class="secondary-button">取消</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- 修改小组名称表单 -->
    <div id="editGroupForm" class="form-dialog hidden-form">
      <div class="dialog-content">
        <h3>修改小组名称</h3>
        <form id="editGroupFormElement">
          <div class="form-group">
            <label for="editGroupName">新小组名称：</label>
            <input type="text" id="editGroupName" placeholder="请输入新的小组名称" required aria-label="新小组名称">
          </div>
          <div class="form-group">
            <label for="editGroupDescription">小组描述：</label>
            <textarea id="editGroupDescription" placeholder="请输入小组描述（可选）" rows="3" aria-label="小组描述"></textarea>
          </div>
          <div class="dialog-buttons">
            <button id="saveEditGroupButton" type="button" class="primary-button">保存</button>
            <button id="cancelEditGroupButton" type="button" class="secondary-button">取消</button>
          </div>
        </form>
      </div>
    </div>


    <!-- 删除小组确认对话框 -->
    <div id="deleteGroupDialog" class="form-dialog hidden-form">
      <div class="dialog-content">
        <h3>确认删除小组</h3>
        <div class="delete-warning">
          <p>⚠️ 警告：删除小组将同时删除该小组的所有成员和签到记录！</p>
          <p>此操作不可撤销，请谨慎操作。</p>
        </div>
        <div class="group-info">
          <p><strong>小组名称：</strong><span id="deleteGroupName"></span></p>
          <p><strong>成员数量：</strong><span id="deleteGroupMemberCount"></span></p>
        </div>
        <div class="dialog-buttons">
          <button id="confirmDeleteGroupButton" type="button" class="danger-button">确认删除</button>
          <button id="cancelDeleteGroupButton" type="button" class="secondary-button">取消</button>
        </div>
      </div>
    </div>

    <!-- 小组成员管理 -->
    <section class="admin-section">
      <div class="section-header">
        <h2>小组成员管理</h2>
        <div class="member-actions">
          <button id="addMemberButton" type="button" class="primary-button" aria-label="添加成员">+ 添加成员</button>
          <button id="addGroupButton" type="button" class="primary-button" aria-label="添加小组">+ 添加小组</button>
          <button id="editGroupNameButton" type="button" class="warning-button" aria-label="修改组名">✏️ 修改组名</button>
          <button id="regenerateIdsButton" type="button" class="success-button" aria-label="重新生成序号">重新生成序号</button>
          <button id="uuidEditorButton" type="button" class="success-button" aria-label="UUID编辑器">UUID编辑器</button>
          <button id="excludeStatsButton" type="button" class="success-button" aria-label="未签到不统计">未签到不统计</button>
          <button id="exportMembersButton" type="button" class="info-button" aria-label="导出成员信息">📊 导出成员</button>
        </div>
      </div>
      
      <div class="member-management-controls">
        <div class="group-selection-row">
          <label for="groupSelect">选择小组：</label>
          <select id="groupSelect" aria-label="选择小组" required>
            <option value="">--请选择小组--</option>
          </select>
          <label for="memberSearch">人员检索：</label>
          <input type="text" id="memberSearch" placeholder="输入姓名搜索" aria-label="人员检索">
          <div id="memberSuggestions" class="suggestions-box hidden"></div>
        </div>
      </div>

      <!-- 成员列表 -->
      <div class="member-list-container">
        <table id="memberTable" aria-label="小组成员列表">
          <caption>小组成员列表</caption>
          <thead>
            <tr>
              <th>序号</th>
              <th>姓名</th>
              <th>花名</th>
              <th>性别</th>
              <th>联系方式</th>
              <th>是否受洗</th>
              <th>年龄段</th>
              <th class="hidden-column">UUID</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="memberList">
            <!-- 动态内容由 group-management.js 填充 -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- 添加成员表单 -->
    <div id="addMemberForm" class="form-dialog hidden-form">
      <div class="dialog-content">
        <h3>添加成员</h3>
        <form id="addMemberFormElement">
          <div class="form-group">
            <label for="addMemberName">姓名：</label>
            <input type="text" id="addMemberName" placeholder="请输入成员姓名" required aria-label="成员姓名">
          </div>
          <div class="form-group">
            <label for="addMemberNickname">花名：</label>
            <input type="text" id="addMemberNickname" placeholder="请输入花名" aria-label="花名">
          </div>
          <div class="form-group">
            <label for="addMemberPhone">联系方式：</label>
            <input type="text" id="addMemberPhone" placeholder="请输入联系方式" aria-label="联系方式">
          </div>
          <div class="form-group">
            <label for="addMemberGender">性别：</label>
            <select id="addMemberGender" required aria-label="性别">
              <option value="">--请选择性别--</option>
              <option value="男">男</option>
              <option value="女">女</option>
            </select>
          </div>
          <div class="form-group">
            <label for="addMemberBaptized">是否受洗：</label>
            <select id="addMemberBaptized" required aria-label="是否受洗">
              <option value="">--请选择--</option>
              <option value="是">是</option>
              <option value="否">否</option>
            </select>
          </div>
          <div class="form-group">
            <label for="addMemberAge">年龄段：</label>
            <select id="addMemberAge" required aria-label="年龄段">
              <option value="">--请选择年龄段--</option>
              <option value="10后">10后</option>
              <option value="05后">05后</option>
              <option value="00后">00后</option>
              <option value="95后">95后</option>
              <option value="90后">90后</option>
              <option value="85后">85后</option>
              <option value="80后">80后</option>
              <option value="75后">75后</option>
              <option value="70后">70后</option>
              <option value="65后">65后</option>
              <option value="60后">60后</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <div class="dialog-buttons">
            <button id="saveMemberButton" type="button" class="primary-button">保存</button>
            <button id="cancelMemberButton" type="button" class="secondary-button">取消</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 编辑成员表单 -->
    <div id="editMemberForm" class="form-dialog hidden-form">
      <div class="dialog-content">
        <h3>编辑成员</h3>
        <form id="editMemberFormElement">
          <table class="edit-member-table">
            <tr>
              <td class="edit-member-cell">
                <div class="form-group">
                  <label for="editMemberName">姓名：</label>
                  <input type="text" id="editMemberName" placeholder="请输入成员姓名" required aria-label="成员姓名">
                </div>
              </td>
              <td class="edit-member-cell">
                <div class="form-group">
                  <label for="editMemberNickname">花名：</label>
                  <input type="text" id="editMemberNickname" placeholder="请输入花名" aria-label="花名">
                </div>
              </td>
            </tr>
            <tr>
              <td class="edit-member-cell">
                <div class="form-group">
                  <label for="editMemberPhone">联系方式：</label>
                  <input type="text" id="editMemberPhone" placeholder="请输入联系方式" aria-label="联系方式">
                </div>
              </td>
              <td class="edit-member-cell">
                <div class="form-group">
                  <label for="editMemberGender">性别：</label>
                  <select id="editMemberGender" required aria-label="性别">
                    <option value="">--请选择性别--</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                  </select>
                </div>
              </td>
            </tr>
            <tr>
              <td class="edit-member-cell">
                <div class="form-group">
                  <label for="editMemberBaptized">是否受洗：</label>
                  <select id="editMemberBaptized" required aria-label="是否受洗">
                    <option value="">--请选择--</option>
                    <option value="是">是</option>
                    <option value="否">否</option>
                  </select>
                </div>
              </td>
              <td class="edit-member-cell">
                <div class="form-group">
                  <label for="editMemberAge">年龄段：</label>
                  <select id="editMemberAge" required aria-label="年龄段">
                    <option value="">--请选择年龄段--</option>
                    <option value="10后">10后</option>
                    <option value="05后">05后</option>
                    <option value="00后">00后</option>
                    <option value="95后">95后</option>
                    <option value="90后">90后</option>
                    <option value="85后">85后</option>
                    <option value="80后">80后</option>
                    <option value="75后">75后</option>
                    <option value="70后">70后</option>
                    <option value="65后">65后</option>
                    <option value="60后">60后</option>
                    <option value="其他">其他</option>
                  </select>
                </div>
              </td>
            </tr>
            <tr>
              <td colspan="2" class="edit-member-uuid-cell">
                <div class="form-group hidden-uuid" id="editMemberUuid">
                  <label>UUID：</label>
                  <div class="uuid-display"></div>
                </div>
              </td>
            </tr>
          </table>
          <div class="dialog-buttons">
            <button id="saveEditMemberButton" type="button" class="primary-button">保存</button>
            <button id="cancelEditMemberButton" type="button" class="secondary-button">取消</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 未签到不统计管理 - 已迁移到独立页面 tools/msh-system/excluded-members-viewer.html -->

    <!-- 删除成员确认对话框 -->
    <div id="deleteMemberDialog" class="form-dialog hidden-form">
      <div class="dialog-content">
        <h3>确认删除成员</h3>
        <div class="delete-warning">
          <p>⚠️ 警告：删除成员将同时删除该成员的所有签到记录！</p>
          <p>此操作不可撤销，请谨慎操作。</p>
        </div>
        <div class="member-info">
          <p><strong>成员姓名：</strong><span id="deleteMemberName"></span></p>
          <p><strong>所属小组：</strong><span id="deleteMemberGroup"></span></p>
        </div>
        <div class="dialog-buttons">
          <button id="confirmDeleteMemberButton" type="button" class="danger-button">确认删除</button>
          <button id="cancelDeleteMemberButton" type="button" class="secondary-button">取消</button>
        </div>
      </div>
    </div>

    <!-- 导出成员信息对话框 -->
    <div id="exportMembersDialog" class="form-dialog hidden-form">
      <div class="dialog-content">
        <h3>导出成员信息</h3>
        <div class="export-options">
          <div class="export-format-section">
            <h4>导出格式</h4>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="exportFormat" value="csv" checked>
                <span>CSV格式（Excel兼容）</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="exportFormat" value="json">
                <span>JSON格式</span>
              </label>
            </div>
          </div>
          
          <div class="export-scope-section">
            <h4>导出范围</h4>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="exportScope" value="current" checked>
                <span>当前选择的小组</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="exportScope" value="all">
                <span>所有小组</span>
              </label>
            </div>
          </div>
          
          <div class="export-fields-section">
            <h4>导出字段</h4>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" name="exportFields" value="groupName" checked disabled>
                <span>小组名称</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="exportFields" value="uuid" checked>
                <span>UUID</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="exportFields" value="name" checked disabled>
                <span>姓名</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="exportFields" value="nickname" checked>
                <span>花名</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="exportFields" value="gender">
                <span>性别</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="exportFields" value="phone">
                <span>联系方式</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="exportFields" value="baptized">
                <span>是否受洗</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="exportFields" value="age">
                <span>年龄段</span>
              </label>
            </div>
          </div>
        </div>
        
        <div class="dialog-buttons">
          <button id="cancelExportButton" type="button" class="secondary-button">取消</button>
          <button id="confirmExportButton" type="button" class="primary-button">确认导出</button>
        </div>
      </div>
    </div>
  </main>

  <!-- 工具函数模块 -->
    <script src="./src/core/firebase-utils.js"></script>
    <script src="./src/core/time-utils.js"></script>
    <script src="./src/core/security-utils.js"></script>
    <script src="./src/data/uuid-manager.js"></script>
    <script src="./src/features/sunday-tracking-utils.js"></script>
    <script src="./src/data/sync-managers.js"></script>
  <script src="./src/navigation-utils.js"></script>
  <!-- 数据管理器模块 -->
    <script src="./src/new-data-manager.js"></script>
  <!-- 小组管理模块 -->
    <script src="./src/group-management/shared-state.js"></script>
    <script src="./src/group-management/init-module.js"></script>
    <script src="./src/group-management/event-handlers.js"></script>
    <script src="./src/group-management/group-member-operations.js"></script>
    <script src="./src/group-management/search-export.js"></script>
    <script src="./src/group-management/group-name-editor.js"></script>
    <script src="./src/group-management/index.js"></script>
</body>
</html>
