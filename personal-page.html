<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸ªäººäº‹ä»¶é¡µé¢ - MSHç®¡ç†ç³»ç»Ÿ</title>
  <link rel="icon" href="./favicon.ico" type="image/x-icon">
  <!-- æ ·å¼æ¨¡å— -->
    <link rel="stylesheet" href="./src/styles/base.css">
    <link rel="stylesheet" href="./src/styles/components.css">
    <link rel="stylesheet" href="./src/styles/utils.css">

  <!-- é…ç½®åŠä¾èµ– -->
  <script src="./src/smart-config-loader.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="./src/config-manager.js"></script>
  <script src="./src/csrf-protection.js"></script>
  <script src="./src/cache-manager.js"></script>
  <script src="./src/security.js"></script>

  <!-- å·¥å…·å‡½æ•° -->
    <script src="./src/core/firebase-utils.js"></script>
    <script src="./src/core/time-utils.js"></script>
    <script src="./src/core/security-utils.js"></script>
    <script src="./src/data/uuid-manager.js"></script>
    <script src="./src/features/sunday-tracking-utils.js"></script>
    <script src="./src/data/sync-managers.js"></script>
  <!-- æ•°æ®ç®¡ç†å™¨ -->
    <script src="./src/new-data-manager.js"></script>

  <style>
    .page-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    .header-main {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }

    .header-meta {
      display: flex;
      justify-content: flex-end;
      align-items: flex-start;
      margin-top: 12px;
    }

    .sync-container {
      min-width: 220px;
      text-align: right;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .filter-card,
    .event-card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(15, 26, 56, 0.08);
      border: 1px solid rgba(15, 26, 56, 0.06);
    }

    .filter-card {
      padding: 20px 24px;
      margin-bottom: 24px;
    }

    .filter-row {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      align-items: flex-end;
    }

    .field-group label {
      display: block;
      font-size: 14px;
      color: #415674;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .field-group select,
    .field-group input,
    .field-group textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #d6deeb;
      padding: 10px 12px;
      font-size: 14px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .field-group select:focus,
    .field-group input:focus,
    .field-group textarea:focus {
      outline: none;
      border-color: #2787f5;
      box-shadow: 0 0 0 3px rgba(39, 135, 245, 0.15);
    }

    .search-input-wrapper {
      position: relative;
    }

    .search-input-wrapper input {
      padding-right: 36px;
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      opacity: 0.5;
    }


    .event-list {
      display: grid;
      gap: 20px;
    }

    .event-card {
      padding: 20px 24px;
    }

    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .event-title {
      font-size: 18px;
      font-weight: 600;
      color: #0f1a38;
      margin: 0;
    }

    .event-meta {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      margin-bottom: 16px;
    }

    .meta-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(246, 249, 255, 0.8);
      border: 1px solid rgba(15, 26, 56, 0.06);
    }

    .meta-item span:first-child {
      font-size: 13px;
      color: #61738f;
    }

    .meta-item span:last-child {
      font-size: 15px;
      color: #0f1a38;
      font-weight: 600;
    }

    .follow-up-block {
      border: 1px solid rgba(15, 26, 56, 0.08);
      border-radius: 10px;
      padding: 16px;
      background: rgba(249, 252, 255, 0.85);
      margin-bottom: 12px;
    }

    .event-card.focused {
      border: 2px solid rgba(47, 128, 237, 0.6);
      box-shadow: 0 14px 28px rgba(47, 128, 237, 0.18);
    }

    .follow-up-block h3 {
      margin: 0 0 8px;
      font-size: 15px;
      color: #0f1a38;
    }

    .follow-up-content {
      margin: 0;
      font-size: 14px;
      color: #42506a;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .follow-up-empty {
      padding: 12px;
      border-radius: 8px;
      color: #8591a9;
      background: rgba(15, 26, 56, 0.04);
      font-size: 14px;
    }

    .follow-up-form textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2f80ed, #56ccf2);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(47, 128, 237, 0.25);
    }

    .btn-primary:disabled {
      background: #c9d4e5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .badge-active {
      background: rgba(46, 196, 182, 0.16);
      color: #2ec4b6;
    }

    .badge-resolved {
      background: rgba(94, 114, 228, 0.15);
      color: #5e72e4;
    }

    .badge-terminated {
      background: rgba(245, 54, 92, 0.15);
      color: #f5365c;
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      border-radius: 12px;
      border: 1px dashed rgba(15, 26, 56, 0.12);
      background: rgba(246, 249, 255, 0.6);
      color: #61738f;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(3px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      font-size: 16px;
      color: #415674;
      display: none;
    }

    .feedback-bar {
      position: fixed;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%);
      min-width: 280px;
      max-width: 420px;
      padding: 14px 18px;
      border-radius: 12px;
      background: #0f1a38;
      color: #ffffff;
      font-size: 14px;
      box-shadow: 0 18px 32px rgba(15, 26, 56, 0.28);
      display: none;
      z-index: 1000;
      text-align: center;
    }

    .feedback-bar.success {
      background: #2ec4b6;
    }

    .feedback-bar.error {
      background: #f5365c;
    }

    .manual-hint {
      margin-top: 12px;
      font-size: 13px;
      color: #8591a9;
    }

    .calendar-card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(15, 26, 56, 0.08);
      border: 1px solid rgba(15, 26, 56, 0.06);
      padding: 20px 24px;
      margin-bottom: 24px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
    }

    .calendar-title {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .calendar-title h2 {
      margin: 0;
      font-size: 18px;
      color: #0f1a38;
    }

    .calendar-title p {
      margin: 0;
      font-size: 14px;
      color: #61738f;
    }

    .calendar-controls {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      background: rgba(39, 135, 245, 0.1);
      border-radius: 999px;
      padding: 6px 12px;
    }

    .calendar-controls button {
      border: none;
      background: transparent;
      color: #2787f5;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
      padding: 4px 8px;
    }

    .calendar-controls button:hover {
      text-decoration: underline;
    }

    .calendar-month {
      font-size: 15px;
      font-weight: 600;
      color: #0f1a38;
    }

    .calendar-weekdays {
      margin-bottom: 6px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }

    .calendar-weekday {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: #61738f;
      padding: 6px 0;
    }

    .calendar-day {
      position: relative;
      border-radius: 10px;
      padding: 10px 8px;
      min-height: 80px;
      background: rgba(246, 249, 255, 0.9);
      border: 1px solid rgba(15, 26, 56, 0.05);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    .calendar-day:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(15, 26, 56, 0.08);
    }

    .calendar-day.other-month {
      background: rgba(244, 246, 250, 0.6);
      color: #9faabe;
    }

    .calendar-day.today {
      border: 1px solid rgba(39, 135, 245, 0.8);
    }

    .calendar-day.sunday {
      background: rgba(255, 248, 225, 0.9);
    }

    .calendar-day.present {
      background: rgba(46, 196, 182, 0.16);
      border-color: rgba(46, 196, 182, 0.4);
    }

    .calendar-day.absent {
      background: rgba(245, 54, 92, 0.12);
      border-color: rgba(245, 54, 92, 0.4);
    }

    .day-number {
      font-size: 18px;
      font-weight: 600;
      color: #0f1a38;
    }

    .calendar-day.other-month .day-number {
      color: #9faabe;
    }

    .day-info {
      margin-top: 6px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 999px;
      padding: 4px 6px;
      display: inline-block;
    }

    .day-info.present {
      background: rgba(46, 196, 182, 0.24);
      color: #178f81;
    }

    .day-info.absent {
      background: rgba(245, 54, 92, 0.18);
      color: #bf1f45;
    }

    .calendar-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 16px;
      font-size: 12px;
      color: #61738f;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 26, 56, 0.04);
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .legend-color.present {
      background: rgba(46, 196, 182, 0.7);
    }

    .legend-color.absent {
      background: rgba(245, 54, 92, 0.7);
    }

    .legend-color.sunday {
      background: rgba(255, 193, 7, 0.7);
    }

    .legend-color.today {
      background: rgba(39, 135, 245, 0.7);
    }

    .calendar-empty {
      text-align: center;
      padding: 40px 0;
      color: #8591a9;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .page-container {
        padding: 16px 12px 32px;
      }

      .header-main {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .header-actions {
        flex-wrap: wrap;
        gap: 8px;
      }

      .event-card {
        padding: 16px 18px;
      }

    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...</div>
  <div class="feedback-bar" id="feedbackBar"></div>

  <div class="page-container">
    <header class="page-header">
      <div class="header-main">
        <div>
          <h1>ä¸ªäººäº‹ä»¶é¡µé¢</h1>
          <p class="page-subtitle">æŒ‰æˆå‘˜æŸ¥çœ‹ç¼ºå‹¤äº‹ä»¶ï¼Œæµ‹è¯•é˜¶æ®µå¯ç›´æ¥å½•å…¥å›è®¿ä¿¡æ¯ã€‚</p>
        </div>
        <div class="header-actions">
          <button id="backToEvents" type="button" class="btn btn-secondary" aria-label="è¿”å›äº‹ä»¶ç®¡ç†é¡µé¢">è¿”å›äº‹ä»¶ç®¡ç†</button>
          <button id="backToSummary" type="button" class="btn btn-secondary" aria-label="è¿”å›æ±‡æ€»é¡µé¢">è¿”å›æ±‡æ€»é¡µé¢</button>
        </div>
      </div>
      <div class="header-meta">
        <div id="syncButtonContainer" class="sync-container"></div>
      </div>
    </header>

    <section class="filter-card">
      <div class="filter-row">
        <div class="field-group">
          <label for="groupFilter">æŒ‰å°ç»„ç­›é€‰</label>
          <select id="groupFilter" aria-label="é€‰æ‹©å°ç»„">
            <option value="all">å…¨éƒ¨å°ç»„</option>
          </select>
        </div>
        <div class="field-group search-input-wrapper">
          <label for="memberInput">æˆå‘˜æœç´¢</label>
          <input type="text" id="memberInput" list="memberOptions" placeholder="è¾“å…¥å§“åæˆ–èŠ±åï¼Œå»ºè®®ä»æç¤ºä¸­é€‰æ‹©" aria-label="æœç´¢æˆå‘˜">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none">
            <path d="M21 21L15.8 15.8M17 10.5C17 14.09 14.09 17 10.5 17C6.91 17 4 14.09 4 10.5C4 6.91 6.91 4 10.5 4C14.09 4 17 6.91 17 10.5Z" stroke="#415674" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <datalist id="memberOptions"></datalist>
        </div>
        <div class="field-group">
          <label>&nbsp;</label>
          <button id="clearSelection" type="button" class="btn-secondary" style="width:100%;">æ¸…ç©ºé€‰æ‹©</button>
        </div>
      </div>
      <p class="manual-hint">âš ï¸ å½“å‰å¤„äºæµ‹è¯•å½•å…¥æ¨¡å¼ï¼šç›´æ¥åœ¨ä¸‹æ–¹äº‹ä»¶å¡ç‰‡ä¸­å¡«å†™å›è®¿å†…å®¹ï¼Œç³»ç»Ÿä¼šç«‹å³ä¿å­˜åˆ° Firebaseã€‚</p>
    </section>
    
    <section id="calendarSection" class="calendar-card" style="display:none;">
      <div class="calendar-header">
        <div class="calendar-title">
          <h2>ç­¾åˆ°æ—¥å†</h2>
          <p id="calendarMemberLabel">è¯·é€‰æ‹©æˆå‘˜ä»¥æŸ¥çœ‹ç­¾åˆ°çŠ¶æ€</p>
        </div>
      <div class="calendar-controls">
          <button id="calendarPrev" type="button" aria-label="ä¸Šä¸€ä¸ªæœˆ">â€¹ ä¸Šæœˆ</button>
          <span id="calendarCurrent" class="calendar-month"></span>
          <button id="calendarNext" type="button" aria-label="ä¸‹ä¸€ä¸ªæœˆ">ä¸‹æœˆ â€º</button>
        </div>
      </div>
      <div class="calendar-weekdays calendar-grid">
        <div class="calendar-weekday">æ—¥</div>
        <div class="calendar-weekday">ä¸€</div>
        <div class="calendar-weekday">äºŒ</div>
        <div class="calendar-weekday">ä¸‰</div>
        <div class="calendar-weekday">å››</div>
        <div class="calendar-weekday">äº”</div>
        <div class="calendar-weekday">å…­</div>
      </div>
      <div id="calendarGrid" class="calendar-grid"></div>
      <div class="calendar-legend">
        <div class="legend-item">
          <span class="legend-color present"></span>
          <span>å·²ç­¾åˆ°</span>
        </div>
        <div class="legend-item">
          <span class="legend-color absent"></span>
          <span>æœªç­¾åˆ°</span>
        </div>
        <div class="legend-item">
          <span class="legend-color sunday"></span>
          <span>ä¸»æ—¥</span>
        </div>
        <div class="legend-item">
          <span class="legend-color today"></span>
          <span>ä»Šå¤©</span>
        </div>
      </div>
    </section>
    
    <section id="eventSection" class="event-list-section">
      <div id="eventListEmpty" class="empty-state">
        è¯·é€‰æ‹©æˆå‘˜åæŸ¥çœ‹ç¼ºå‹¤äº‹ä»¶åŠå›è®¿ä¿¡æ¯ã€‚
      </div>
      <div id="eventList" class="event-list" style="display:none;"></div>
    </section>
  </div>

  <script>
    (function() {
      const state = {
        groups: {},
        groupNames: {},
        members: [],
        filteredMembers: [],
        events: [],
        selectedGroup: 'all',
        selectedMemberUUID: null,
        selectedMember: null,
        autoHighlightEventId: null,
        attendanceRecords: [],
        attendanceRecordsLoaded: false,
        attendanceRecordsFetchedAt: null,
        calendarDate: new Date()
      };

      const elements = {
        loading: document.getElementById('loadingOverlay'),
        feedback: document.getElementById('feedbackBar'),
        groupFilter: document.getElementById('groupFilter'),
        memberInput: document.getElementById('memberInput'),
        memberOptions: document.getElementById('memberOptions'),
        clearSelection: document.getElementById('clearSelection'),
        eventList: document.getElementById('eventList'),
        eventListEmpty: document.getElementById('eventListEmpty'),
        backToEvents: document.getElementById('backToEvents'),
        backToSummary: document.getElementById('backToSummary'),
        calendarSection: document.getElementById('calendarSection'),
        calendarMemberLabel: document.getElementById('calendarMemberLabel'),
        calendarPrev: document.getElementById('calendarPrev'),
        calendarNext: document.getElementById('calendarNext'),
        calendarCurrent: document.getElementById('calendarCurrent'),
        calendarGrid: document.getElementById('calendarGrid')
      };

      if (elements.calendarGrid) {
        elements.calendarGrid.innerHTML = '<div class="calendar-empty">è¯·é€‰æ‹©æˆå‘˜åæŸ¥çœ‹ç­¾åˆ°çŠ¶æ€ã€‚</div>';
      }

      const memberLabelMap = new Map();

      function showLoading(show = true) {
        elements.loading.style.display = show ? 'flex' : 'none';
      }

      function showFeedback(message, type = 'info', duration = 3200) {
        elements.feedback.textContent = message;
        elements.feedback.className = `feedback-bar ${type}`;
        elements.feedback.style.display = 'block';
        setTimeout(() => {
          elements.feedback.style.display = 'none';
        }, duration);
      }

      async function waitForFirebaseConfig(maxAttempts = 60, delay = 100) {
        let attempts = 0;
        while (!window.firebaseConfig && attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, delay));
          attempts++;
        }
        if (!window.firebaseConfig) {
          throw new Error('Firebaseé…ç½®åŠ è½½è¶…æ—¶');
        }
      }

      async function initializeFirebase() {
        await waitForFirebaseConfig();
        const { app, db, success } = window.utils.initializeFirebase();
        if (!success) {
          throw new Error('Firebaseåˆå§‹åŒ–å¤±è´¥');
        }
        window.firebaseApp = app;
        window.db = db;
        console.log('âœ… personal-page Firebase åˆå§‹åŒ–å®Œæˆ');
      }

      async function ensureNewDataManagerReady() {
        if (!window.newDataManager) {
          console.warn('âš ï¸ newDataManager æœªåŠ è½½ï¼Œå°†ç›´æ¥ä»Firebaseè¯»å–æ•°æ®');
          return;
        }

        if (!window.newDataManager.isDataLoaded) {
          try {
            await window.newDataManager.loadAllDataFromFirebase();
          } catch (error) {
            console.warn('âš ï¸ newDataManageråŠ è½½å¤±è´¥ï¼Œé™çº§ä¸ºç›´æ¥è¯»å–Firebase', error);
          }
        }
        if (typeof window.newDataManager.createSyncButton === 'function') {
          window.newDataManager.createSyncButton('syncButtonContainer');
        }
      }

      async function loadGroupsAndMembers() {
        let groupsData = window.groups;
        let groupNameData = window.groupNames;

        if ((!groupsData || Object.keys(groupsData).length === 0) && window.newDataManager) {
          try {
            groupsData = await window.newDataManager.loadGroups();
            groupNameData = await window.newDataManager.loadGroupNames();
            window.groups = groupsData;
            window.groupNames = groupNameData;
          } catch (error) {
            console.warn('âš ï¸ ä»newDataManageråŠ è½½å°ç»„æ•°æ®å¤±è´¥ï¼Œå°è¯•ç›´æ¥è¯»å–Firebase', error);
          }
        }

        if (!groupsData || Object.keys(groupsData).length === 0) {
          const groupsSnapshot = await window.db.ref('groups').once('value');
          groupsData = groupsSnapshot.val() || {};
          window.groups = groupsData;
        }

        if (!groupNameData || Object.keys(groupNameData).length === 0) {
          const groupNamesSnapshot = await window.db.ref('groupNames').once('value');
          groupNameData = groupNamesSnapshot.val() || {};
          window.groupNames = groupNameData;
        }

        state.groups = groupsData;
        state.groupNames = groupNameData;

        const members = [];
        Object.entries(groupsData).forEach(([groupKey, memberList]) => {
          (memberList || []).forEach(member => {
            if (member && !(member.excluded === true || member.excluded === 'true')) {
              const displayName = window.utils.getDisplayName(member);
              members.push({
                uuid: member.uuid || member.memberUUID || window.utils.generateUUID(),
                raw: member,
                groupKey,
                groupName: groupNameData[groupKey] || groupKey,
                displayName
              });
            }
          });
        });

        members.sort((a, b) => a.displayName.localeCompare(b.displayName, 'zh-CN'));
        state.members = members;
        rebuildMemberOptions();
        populateGroupFilter();
      }

      function populateGroupFilter() {
        const filter = elements.groupFilter;
        filter.innerHTML = '<option value="all">å…¨éƒ¨å°ç»„</option>';
        const groupEntries = Object.entries(state.groupNames);
        groupEntries.sort((a, b) => a[1].localeCompare(b[1], 'zh-CN'));
        groupEntries.forEach(([key, value]) => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = value;
          filter.appendChild(option);
        });
      }

      async function loadAttendanceRecords(options = {}) {
        const { force = false, minRecords = 1 } = options;
        try {
          let recordsSource = null;
          let fetchedFrom = 'cache';

          const cachedRecords = Array.isArray(window.attendanceRecords)
            ? window.attendanceRecords
            : normalizeAttendanceRecords(window.attendanceRecords);

          const hasUsableCache = Array.isArray(cachedRecords) && cachedRecords.length >= minRecords;

          if (!force && hasUsableCache) {
            recordsSource = cachedRecords;
          } else if (window.db) {
            recordsSource = await fetchAttendanceRecordsFromFirebase();
            fetchedFrom = 'firebase';
          } else if (Array.isArray(cachedRecords)) {
            recordsSource = cachedRecords;
          } else {
            recordsSource = [];
          }

          const normalizedRecords = normalizeAttendanceRecords(recordsSource);
          state.attendanceRecords = normalizedRecords;
          state.attendanceRecordsLoaded = normalizedRecords.length > 0;
          state.attendanceRecordsFetchedAt = new Date();
          window.attendanceRecords = normalizedRecords;

          if (window.utils?.SundayTrackingManager?._clearAttendanceCache) {
            try {
              window.utils.SundayTrackingManager._clearAttendanceCache();
            } catch (clearError) {
              console.warn('æ¸…é™¤SundayTrackingManagerè€ƒå‹¤ç¼“å­˜å¤±è´¥:', clearError);
            }
          } else if (window.utils?.SundayTrackingManager?._clearCache) {
            try {
              window.utils.SundayTrackingManager._clearCache();
            } catch (clearError) {
              console.warn('æ¸…é™¤SundayTrackingManagerç¼“å­˜å¤±è´¥:', clearError);
            }
          }

          try {
            localStorage.setItem('msh_attendance_records', JSON.stringify(normalizedRecords));
          } catch (storageError) {
            console.warn('æ— æ³•å°†ç­¾åˆ°è®°å½•å†™å…¥æœ¬åœ°å­˜å‚¨:', storageError);
          }

          console.log(`ğŸ“… å·²åŠ è½½ç­¾åˆ°è®°å½•: ${state.attendanceRecords.length} æ¡ï¼ˆæ¥æº: ${fetchedFrom}ï¼‰`);
          return normalizedRecords.length;
        } catch (error) {
          console.error('åŠ è½½ç­¾åˆ°è®°å½•å¤±è´¥:', error);
          state.attendanceRecords = [];
          state.attendanceRecordsLoaded = false;
          return 0;
        }
      }

      async function fetchAttendanceRecordsFromFirebase() {
        if (!window.db) {
          throw new Error('Firebaseæ•°æ®åº“æœªåˆå§‹åŒ–');
        }
        console.log('ğŸ“¡ æ­£åœ¨ä»FirebaseåŠ è½½ç­¾åˆ°è®°å½•...');
        const snapshot = await window.db.ref('attendanceRecords').once('value');
        const value = snapshot.val();
        return value || [];
      }

      function rebuildMemberOptions() {
        memberLabelMap.clear();
        elements.memberOptions.innerHTML = '';

        state.filteredMembers = state.members.filter(member => {
          if (state.selectedGroup === 'all') return true;
          return member.groupKey === state.selectedGroup;
        });

        state.filteredMembers.forEach(member => {
          const label = `${member.displayName}ï¼ˆ${member.groupName}ï¼‰`;
          memberLabelMap.set(label, member);
          const option = document.createElement('option');
          option.value = label;
          elements.memberOptions.appendChild(option);
        });
      }

      async function loadTrackingRecordsFromFirebase() {
        if (!window.db) {
          throw new Error('Firebaseæ•°æ®åº“æœªåˆå§‹åŒ–');
        }

        const snapshot = await window.db.ref('trackingRecords').once('value');
        const recordsObj = snapshot.val() || {};

        const records = Object.keys(recordsObj).map(recordId => {
          const record = recordsObj[recordId] || {};
          if (!record.recordId) {
            record.recordId = recordId;
          }
          return record;
        });

        localStorage.setItem('msh_sunday_tracking', JSON.stringify(records));
        if (window.utils?.SundayTrackingManager?._clearCache) {
          window.utils.SundayTrackingManager._clearCache();
        }

        console.log(`âœ… å·²ä»FirebaseåŠ è½½${records.length}æ¡è·Ÿè¸ªè®°å½•`);
      }

      async function refreshTrackingData() {
        state.events = window.utils.SundayTrackingManager.getTrackingRecords() || [];
        if (!state.events || state.events.length === 0) {
          await loadTrackingRecordsFromFirebase();
          state.events = window.utils.SundayTrackingManager.getTrackingRecords() || [];
        }
      }

      function clearSelection() {
        state.selectedMemberUUID = null;
        state.selectedMember = null;
        elements.memberInput.value = '';
        if (elements.calendarSection) {
          elements.calendarSection.style.display = 'none';
        }
        if (elements.calendarMemberLabel) {
          elements.calendarMemberLabel.textContent = 'è¯·é€‰æ‹©æˆå‘˜ä»¥æŸ¥çœ‹ç­¾åˆ°çŠ¶æ€';
        }
        if (elements.calendarCurrent) {
          elements.calendarCurrent.textContent = '';
        }
        if (elements.calendarGrid) {
          elements.calendarGrid.innerHTML = '<div class="calendar-empty">è¯·é€‰æ‹©æˆå‘˜åæŸ¥çœ‹ç­¾åˆ°çŠ¶æ€ã€‚</div>';
        }
        elements.eventList.style.display = 'none';
        elements.eventListEmpty.style.display = 'block';
      }

      function renderEventList() {
        if (!state.selectedMemberUUID) {
          elements.eventList.style.display = 'none';
          elements.eventListEmpty.style.display = 'block';
          return;
        }

        const events = state.events
          .filter(event => event.memberUUID === state.selectedMemberUUID)
          .sort((a, b) => {
            const orderMap = { active: 1, resolved: 2, terminated: 3 };
            const orderA = orderMap[a.status] || 99;
            const orderB = orderMap[b.status] || 99;
            if (orderA !== orderB) return orderA - orderB;
            const startA = a.trackingStartDate || a.startDate || '';
            const startB = b.trackingStartDate || b.startDate || '';
            return startB.localeCompare(startA);
          });

        if (events.length === 0) {
          elements.eventList.style.display = 'none';
          elements.eventListEmpty.style.display = 'block';
          elements.eventListEmpty.textContent = 'å½“å‰æˆå‘˜æ²¡æœ‰ç¼ºå‹¤äº‹ä»¶ã€‚';
          return;
        }

        elements.eventList.innerHTML = '';
        events.forEach(event => {
          const card = document.createElement('article');
          card.className = 'event-card';
          card.dataset.eventId = event.recordId;

          const statusBadge = document.createElement('span');
          statusBadge.className = `badge ${
            event.status === 'active'
              ? 'badge-active'
              : event.status === 'resolved'
                ? 'badge-resolved'
                : 'badge-terminated'
          }`;
          statusBadge.textContent =
            event.status === 'active'
              ? 'è·Ÿè¸ªä¸­'
              : event.status === 'resolved'
                ? 'å·²è§£å†³'
                : 'å·²ç»ˆæ­¢';

          const header = document.createElement('div');
          header.className = 'event-header';
          const title = document.createElement('h3');
          title.className = 'event-title';
          title.textContent = `${event.eventDescription || 'è¿ç»­ç¼ºå‹¤äº‹ä»¶'}`;
          header.appendChild(title);
          header.appendChild(statusBadge);
          card.appendChild(header);

          const meta = document.createElement('div');
          meta.className = 'event-meta';
          meta.innerHTML = `
            <div class="meta-item">
              <span>è¿ç»­ç¼ºå‹¤</span>
              <span>${event.consecutiveAbsences || 0} æ¬¡</span>
            </div>
            <div class="meta-item">
              <span>å¼€å§‹å‘¨</span>
              <span>${(event.trackingStartDate || event.startDate || 'æœªçŸ¥').replace('T', ' ')}</span>
            </div>
            <div class="meta-item">
              <span>æœ€è¿‘æ›´æ–°</span>
              <span>${(event.updatedAt || event.createdAt || 'æœªçŸ¥').replace('T', ' ').split('.')[0]}</span>
            </div>
          `;
          card.appendChild(meta);

          const followUpContainer = document.createElement('div');
          followUpContainer.className = 'follow-up-block';
          const followUpTitle = document.createElement('h3');
          followUpTitle.textContent = 'æœ€æ–°å›è®¿è®°å½•';
          followUpContainer.appendChild(followUpTitle);

          if (event.latestFollowUp && event.latestFollowUp.content) {
            const followUp = document.createElement('p');
            followUp.className = 'follow-up-content';
            const submittedAt = event.latestFollowUp.submittedAt
              ? new Date(event.latestFollowUp.submittedAt).toLocaleString('zh-CN', { hour12: false })
              : 'æœªçŸ¥æ—¶é—´';
            followUp.textContent = `${event.latestFollowUp.content}\nâ€”â€” ${submittedAt}`;
            followUpContainer.appendChild(followUp);
          } else {
            const empty = document.createElement('div');
            empty.className = 'follow-up-empty';
            empty.textContent = 'æš‚æ— å›è®¿ä¿¡æ¯ï¼Œè¯·å¡«å†™åä¿å­˜ã€‚';
            followUpContainer.appendChild(empty);
          }

          card.appendChild(followUpContainer);

          const formWrapper = document.createElement('div');
          formWrapper.className = 'follow-up-form';
          const textarea = document.createElement('textarea');
          textarea.id = `followUpInput-${event.recordId}`;
          textarea.placeholder = 'åœ¨æ­¤å½•å…¥å›è®¿å†…å®¹ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰';
          textarea.setAttribute('aria-label', 'å›è®¿å†…å®¹');
          formWrapper.appendChild(textarea);

          const actions = document.createElement('div');
          actions.className = 'form-actions';
          const saveButton = document.createElement('button');
          saveButton.type = 'button';
          saveButton.className = 'btn-primary';
          saveButton.textContent = 'ä¿å­˜å›è®¿';
          saveButton.dataset.eventId = event.recordId;
          saveButton.addEventListener('click', () => handleSaveFollowUp(event.recordId));
          actions.appendChild(saveButton);
          formWrapper.appendChild(actions);

          card.appendChild(formWrapper);
          elements.eventList.appendChild(card);
        });

        elements.eventList.style.display = 'grid';
        elements.eventListEmpty.style.display = 'none';

        if (state.autoHighlightEventId) {
          highlightEventCardById(state.autoHighlightEventId);
          state.autoHighlightEventId = null;
        }
      }

      async function handleMemberSelection() {
        const inputVal = elements.memberInput.value.trim();
        if (!inputVal || !memberLabelMap.has(inputVal)) {
          clearSelection();
          return;
        }

        const member = memberLabelMap.get(inputVal);
        state.selectedMemberUUID = member.uuid;
        state.selectedMember = member;
        elements.calendarMemberLabel.textContent = `${member.displayName} Â· ${member.groupName}`;
        if (elements.calendarSection) {
          elements.calendarSection.style.display = 'block';
        }
        state.calendarDate = new Date();
        await refreshTrackingData();
        renderEventList();
        await renderCalendar();
      }

      async function handleSaveFollowUp(recordId) {
        const textarea = document.getElementById(`followUpInput-${recordId}`);
        if (!textarea) return;

        const content = textarea.value.trim();
        if (!content) {
          showFeedback('è¯·å…ˆå¡«å†™å›è®¿å†…å®¹', 'error');
          textarea.focus();
          return;
        }

        const button = textarea.parentElement.querySelector('button');
        if (button) {
          button.disabled = true;
        }

        try {
          const result = window.utils.SundayTrackingManager.updateLatestFollowUp(recordId, {
            content,
            memberUUID: state.selectedMemberUUID,
            source: 'manual-test',
            submittedAt: new Date().toISOString()
          });

          if (!result.success) {
            const reason = result.reason || 'save_failed';
            showFeedback(`ä¿å­˜å¤±è´¥ï¼š${reason}`, 'error');
            return;
          }

          textarea.value = '';
          await refreshTrackingData();
          state.autoHighlightEventId = recordId;
          renderEventList();
          showFeedback('å›è®¿è®°å½•å·²ä¿å­˜ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰', 'success');
        } catch (error) {
          console.error('ä¿å­˜å›è®¿å¤±è´¥:', error);
          showFeedback('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
        } finally {
          if (button) {
            button.disabled = false;
          }
        }
      }

      function highlightEventCardById(eventId) {
        if (!eventId) {
          return;
        }
        const previous = elements.eventList.querySelector('.event-card.focused');
        if (previous) {
          previous.classList.remove('focused');
        }
        const targetCard = elements.eventList.querySelector(`.event-card[data-event-id="${eventId}"]`);
        if (targetCard) {
          targetCard.classList.add('focused');
          targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }

      async function handleInitialSelection() {
        const params = new URLSearchParams(window.location.search);
        const memberUUID = params.get('uuid');
        if (!memberUUID) {
          return;
        }

        const targetMember = state.members.find(member => member.uuid === memberUUID);
        if (!targetMember) {
          console.warn(`âš ï¸ æœªæ‰¾åˆ°UUIDä¸º ${memberUUID} çš„æˆå‘˜ï¼Œå–æ¶ˆè‡ªåŠ¨é€‰æ‹©`);
          return;
        }

        state.selectedGroup = 'all';
        elements.groupFilter.value = 'all';
        rebuildMemberOptions();

        const displayLabel = `${targetMember.displayName}ï¼ˆ${targetMember.groupName}ï¼‰`;
        elements.memberInput.value = displayLabel;
        state.autoHighlightEventId = params.get('eventId');
        await handleMemberSelection();

        if (state.autoHighlightEventId && !state.events.some(event => event.recordId === state.autoHighlightEventId)) {
          console.warn(`âš ï¸ æœªæ‰¾åˆ°äº‹ä»¶ ${state.autoHighlightEventId}ï¼Œå–æ¶ˆé«˜äº®`);
          state.autoHighlightEventId = null;
        }
      }

      function bindEvents() {
        elements.groupFilter.addEventListener('change', () => {
          state.selectedGroup = elements.groupFilter.value;
          rebuildMemberOptions();
          clearSelection();
        });

        elements.memberInput.addEventListener('change', handleMemberSelection);
        elements.memberInput.addEventListener('blur', handleMemberSelection);
        elements.clearSelection.addEventListener('click', () => {
          state.selectedGroup = 'all';
          elements.groupFilter.value = 'all';
          rebuildMemberOptions();
          clearSelection();
        });

        if (elements.calendarPrev) {
          elements.calendarPrev.addEventListener('click', async () => {
            state.calendarDate.setMonth(state.calendarDate.getMonth() - 1);
            await renderCalendar();
          });
        }

        if (elements.calendarNext) {
          elements.calendarNext.addEventListener('click', async () => {
            state.calendarDate.setMonth(state.calendarDate.getMonth() + 1);
            await renderCalendar();
          });
        }

        if (elements.backToEvents) {
          elements.backToEvents.addEventListener('click', () => {
            window.location.href = 'absence-events.html';
          });
        }

        elements.backToSummary.addEventListener('click', () => {
          window.location.href = 'summary.html';
        });

        window.addEventListener('attendanceRecordsUpdated', async () => {
          console.log('ğŸ”” æ£€æµ‹åˆ°ç­¾åˆ°è®°å½•æ›´æ–°äº‹ä»¶ï¼Œé‡æ–°åŠ è½½æ•°æ®');
          await loadAttendanceRecords({ force: true });
          await refreshTrackingData();
          renderEventList();
          await renderCalendar();
        });

        window.addEventListener('groupsUpdated', async () => {
          console.log('ğŸ”” æ£€æµ‹åˆ°å°ç»„æ•°æ®æ›´æ–°äº‹ä»¶ï¼Œé‡æ–°åŠ è½½æˆå‘˜');
          await loadGroupsAndMembers();
          await loadAttendanceRecords({ force: true });
          await refreshTrackingData();
          renderEventList();
          await renderCalendar();
        });
      }

      async function initializePage() {
        try {
          showLoading(true);
          await initializeFirebase();
          await ensureNewDataManagerReady();
          await loadGroupsAndMembers();
          await loadAttendanceRecords();
          await loadTrackingRecordsFromFirebase();
          await refreshTrackingData();
          bindEvents();
          await handleInitialSelection();
          showFeedback('æ•°æ®åŠ è½½å®Œæˆï¼Œå¯å¼€å§‹æµ‹è¯•å½•å…¥ã€‚', 'success', 2500);
        } catch (error) {
          console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
          showFeedback('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®ã€‚', 'error', 5000);
        } finally {
          showLoading(false);
        }
      }

      document.addEventListener('DOMContentLoaded', initializePage);
      window.handleSaveFollowUp = handleSaveFollowUp;
      window.renderCalendar = renderCalendar;

      function normalizeAttendanceRecords(input) {
        if (!input) return [];

        if (Array.isArray(input)) {
          return input.filter(item => item && typeof item === 'object');
        }

        if (typeof input === 'object') {
          const keys = Object.keys(input);
          if (keys.some(key => ['memberUUID', 'memberUuid', 'memberId', 'time', 'date', 'name', 'group'].includes(key))) {
            return [input];
          }
          return keys.flatMap(key => normalizeAttendanceRecords(input[key]));
        }

        return [];
      }

      function getRecordDateString(record) {
        if (!record || typeof record !== 'object') return '';
        if (record.date) {
          return String(record.date).slice(0, 10);
        }
        if (record.time) {
          if (window.utils && typeof window.utils.getLocalDateFromISO === 'function') {
            return window.utils.getLocalDateFromISO(record.time);
          }
          const date = new Date(record.time);
          return window.utils && typeof window.utils.getLocalDateString === 'function'
            ? window.utils.getLocalDateString(date)
            : date.toISOString().split('T')[0];
        }
        if (record.timestamp) {
          const date = new Date(record.timestamp);
          return window.utils && typeof window.utils.getLocalDateString === 'function'
            ? window.utils.getLocalDateString(date)
            : date.toISOString().split('T')[0];
        }
        return '';
      }

      async function renderCalendar() {
        if (!elements.calendarGrid) {
          return;
        }

        if (!state.selectedMemberUUID) {
          if (elements.calendarSection) {
            elements.calendarSection.style.display = 'none';
          }
          if (elements.calendarGrid) {
            elements.calendarGrid.innerHTML = '<div class="calendar-empty">è¯·é€‰æ‹©æˆå‘˜åæŸ¥çœ‹ç­¾åˆ°çŠ¶æ€ã€‚</div>';
          }
          return;
        }

        if (!state.attendanceRecordsLoaded || state.attendanceRecords.length === 0) {
          const loadedCount = await loadAttendanceRecords({ force: true, minRecords: 1 });
          if (!loadedCount) {
            elements.calendarGrid.innerHTML = '<div class="calendar-empty">æœªæŸ¥è¯¢åˆ°è¯¥æˆå‘˜çš„ç­¾åˆ°è®°å½•ã€‚</div>';
            return;
          }
        }

        const current = new Date(state.calendarDate.getTime());
        const year = current.getFullYear();
        const month = current.getMonth();

        if (elements.calendarCurrent) {
          elements.calendarCurrent.textContent = `${year}å¹´${month + 1}æœˆ`;
        }

        const records = getMemberAttendanceRecords(state.selectedMemberUUID);
        const calendarHtml = generateCalendarGrid(year, month, records);
        elements.calendarGrid.innerHTML = calendarHtml;
      }

      function getMemberAttendanceRecords(memberUUID) {
        if (!memberUUID) return [];

        const manager = window.utils?.SundayTrackingManager;
        if (manager && typeof manager.getMemberAttendanceRecords === 'function') {
          try {
            const managedRecords = manager.getMemberAttendanceRecords(memberUUID);
            if (Array.isArray(managedRecords) && managedRecords.length > 0) {
              return managedRecords;
            }
          } catch (error) {
            console.warn('é€šè¿‡SundayTrackingManagerè·å–ç­¾åˆ°è®°å½•å¤±è´¥ï¼Œå°†å›é€€åˆ°æœ¬åœ°åŒ¹é…é€»è¾‘', error);
          }
        }

        const sourceRecords = Array.isArray(state.attendanceRecords)
          ? state.attendanceRecords
          : normalizeAttendanceRecords(state.attendanceRecords);

        if (!Array.isArray(sourceRecords) || sourceRecords.length === 0) {
          return [];
        }

        const member = state.members.find(item => item.uuid === memberUUID);
        const candidateNames = new Set();
        if (member) {
          if (member.displayName) candidateNames.add(member.displayName.trim());
          if (member.raw) {
            ['name', 'nickname', 'fullName', 'realname', 'realName'].forEach(key => {
              if (member.raw[key]) {
                candidateNames.add(String(member.raw[key]).trim());
              }
            });
          }
        }

        const normalizedRecords = [];

        sourceRecords.forEach(record => {
          if (!record || typeof record !== 'object') {
            return;
          }

          const recordUUID =
            record.memberUUID ||
            record.memberUuid ||
            record.memberId ||
            (record.memberSnapshot && (record.memberSnapshot.uuid || record.memberSnapshot.memberUUID));

          if (recordUUID === memberUUID) {
            normalizedRecords.push(record);
            return;
          }

          if (candidateNames.size === 0) {
            return;
          }

          const recordNames = new Set();
          ['name', 'nickname', 'displayName'].forEach(key => {
            if (record[key]) {
              recordNames.add(String(record[key]).trim());
            }
          });

          if (record.memberSnapshot) {
            ['name', 'nickname', 'displayName', 'fullName', 'realName'].forEach(key => {
              if (record.memberSnapshot[key]) {
                recordNames.add(String(record.memberSnapshot[key]).trim());
              }
            });
          }

          const hasMatch = Array.from(recordNames).some(name => name && candidateNames.has(name));
          if (hasMatch) {
            normalizedRecords.push({
              ...record,
              memberUUID: record.memberUUID || memberUUID
            });
          }
        });

        return normalizedRecords;
      }

      function generateCalendarGrid(year, month, records) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const firstWeekday = firstDay.getDay();
        const totalDays = lastDay.getDate();
        const prevMonthLastDay = new Date(year, month, 0).getDate();
        const today = new Date();

        const cells = [];

        for (let i = firstWeekday - 1; i >= 0; i--) {
          const day = prevMonthLastDay - i;
          cells.push(renderCalendarDay(new Date(year, month - 1, day), day, records, true, today));
        }

        for (let day = 1; day <= totalDays; day++) {
          cells.push(renderCalendarDay(new Date(year, month, day), day, records, false, today));
        }

        while (cells.length < 42) {
          const nextDay = cells.length - (firstWeekday + totalDays) + 1;
          cells.push(renderCalendarDay(new Date(year, month + 1, nextDay), nextDay, records, true, today));
        }

        return cells.join('');
      }

      function renderCalendarDay(date, displayDay, records, otherMonth, today) {
        const classes = ['calendar-day'];
        const isToday = isSameDate(date, today);
        const isSunday = date.getDay() === 0;
        const targetDateKey = getDateKey(date);
        const hasAttendance = records.some(record => {
          const recordDateKey = getRecordDateString(record);
          return recordDateKey && recordDateKey === targetDateKey;
        });

        if (otherMonth) classes.push('other-month');
        if (isSunday) classes.push('sunday');
        if (isToday) classes.push('today');
        if (hasAttendance) {
          classes.push('present');
        } else if (isSunday && !otherMonth) {
          classes.push('absent');
        }

        let info = '';
        if (hasAttendance) {
          info = '<div class="day-info present">å·²ç­¾åˆ°</div>';
        } else if (isSunday && !otherMonth) {
          info = '<div class="day-info absent">æœªç­¾åˆ°</div>';
        }

        return `
          <div class="${classes.join(' ')}" data-date="${targetDateKey}">
            <div class="day-number">${displayDay}</div>
            ${info}
          </div>
        `;
      }

      function isSameDate(a, b) {
        return a instanceof Date && b instanceof Date &&
               !Number.isNaN(a.getTime()) && !Number.isNaN(b.getTime()) &&
               a.getFullYear() === b.getFullYear() &&
               a.getMonth() === b.getMonth() &&
               a.getDate() === b.getDate();
      }

      function getDateKey(date) {
        if (!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
        if (window.utils && typeof window.utils.getLocalDateString === 'function') {
          return window.utils.getLocalDateString(date);
        }
        const localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
        return localDate.toISOString().split('T')[0];
      }
    })();
  </script>
</body>
</html>

