# ä¸»æ—¥è·Ÿè¸ªé¡µé¢äº‹ä»¶ç”Ÿæˆæµç¨‹åˆ†ææŠ¥å‘Š

**æ—¥æœŸ**: 2025-11-05  
**ç›®çš„**: åˆ†æä¸»æ—¥è·Ÿè¸ªé¡µé¢çš„äº‹ä»¶ç”Ÿæˆæµç¨‹ã€åˆ¤æ–­é€»è¾‘ã€æ•°æ®æ‹‰å–æ¬¡æ•°ï¼Œä¸ºå†æ¬¡å¼€å‘æä¾›å‚è€ƒ  
**ç³»ç»Ÿ**: MSHç­¾åˆ°ç³»ç»Ÿ

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šè¯¦ç»†åˆ†æäº†ä¸»æ—¥è·Ÿè¸ªé¡µé¢çš„äº‹ä»¶ç”Ÿæˆæµç¨‹ï¼ŒåŒ…æ‹¬ï¼š
- **å®Œæ•´çš„æµç¨‹é€»è¾‘**ï¼šä»é¡µé¢åŠ è½½åˆ°äº‹ä»¶ç”Ÿæˆçš„å…¨è¿‡ç¨‹
- **åˆ¤æ–­é€»è¾‘**ï¼šå„ç§åˆ¤æ–­æ¡ä»¶å’Œå†³ç­–ç‚¹
- **æ•°æ®æ‹‰å–æ¬¡æ•°**ï¼šæ¯æ¬¡æ“ä½œçš„Firebase/localStorageè¯»å–æ¬¡æ•°
- **æ€§èƒ½ä¼˜åŒ–ç‚¹**ï¼šç¼“å­˜æœºåˆ¶å’Œä¼˜åŒ–ç­–ç•¥

---

## ğŸ”„ å®Œæ•´æµç¨‹é€»è¾‘

### 1. é¡µé¢åˆå§‹åŒ–æµç¨‹

```
é¡µé¢åŠ è½½ (sunday-tracking.html)
    â†“
DOMContentLoaded äº‹ä»¶
    â†“
initializePage()
    â”œâ”€â”€ initializeFirebase()          [Firebaseåˆå§‹åŒ–]
    â”œâ”€â”€ initializeDOMElements()       [DOMå…ƒç´ åˆå§‹åŒ–]
    â”œâ”€â”€ initializeEventListeners()    [äº‹ä»¶ç›‘å¬å™¨]
    â””â”€â”€ loadSundayTracking()          [åŠ è½½è·Ÿè¸ªæ•°æ®]
```

### 2. æ•°æ®åŠ è½½æµç¨‹ï¼ˆloadSundayTrackingï¼‰

```
loadSundayTracking()
    â†“
[æ£€æŸ¥1] å¼ºåˆ¶åˆ·æ–°æ ‡å¿— (forceRefresh)
    â”œâ”€â”€ æ˜¯ â†’ æ¸…é™¤æ‰€æœ‰ç¼“å­˜
    â””â”€â”€ å¦ â†’ ç»§ç»­
    â†“
[æ£€æŸ¥2] ç»Ÿä¸€ç¼“å­˜ç®¡ç†å™¨ (unifiedCacheManager)
    â”œâ”€â”€ æœ‰ç¼“å­˜ â†’ ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ (0æ¬¡Firebaseè¯»å–)
    â””â”€â”€ æ— ç¼“å­˜ â†’ ç»§ç»­
    â†“
[æ£€æŸ¥3] æ˜¯å¦æœ‰è·Ÿè¸ªè®°å½•æ•°æ®
    â”œâ”€â”€ æœ‰ â†’ ç›´æ¥ç”Ÿæˆäº‹ä»¶åˆ—è¡¨ (ä¸ä¾èµ–åŸºç¡€æ•°æ®)
    â””â”€â”€ æ—  â†’ ç»§ç»­
    â†“
[æ£€æŸ¥4] åŸºç¡€æ•°æ®æ£€æŸ¥ (window.groups, window.attendanceRecords)
    â”œâ”€â”€ æœªåŠ è½½ â†’ ç­‰å¾…æ•°æ®åŠ è½½å®Œæˆ
    â””â”€â”€ å·²åŠ è½½ â†’ ç»§ç»­
    â†“
[æ£€æŸ¥5] SundayTrackingManager æ£€æŸ¥
    â”œâ”€â”€ æœªåŠ è½½ â†’ ç­‰å¾…åŠ è½½å®Œæˆ
    â””â”€â”€ å·²åŠ è½½ â†’ ç»§ç»­
    â†“
generateUltraLightEventList(showAll)
```

### 3. äº‹ä»¶ç”Ÿæˆæµç¨‹ï¼ˆgenerateUltraLightEventListï¼‰

```
generateUltraLightEventList(showAll)
    â†“
[æ£€æŸ¥] SundayTrackingManager æ˜¯å¦å¯ç”¨
    â”œâ”€â”€ ä¸å¯ç”¨ â†’ è¿”å›ç©ºæ•°ç»„
    â””â”€â”€ å¯ç”¨ â†’ ç»§ç»­
    â†“
generateTrackingList() [è°ƒç”¨ SundayTrackingManager]
    â†“
è¿”å›äº‹ä»¶åˆ—è¡¨ â†’ è¿‡æ»¤å·²ç»ˆæ­¢äº‹ä»¶ â†’ è½¬æ¢ä¸ºæç®€æ ¼å¼
```

### 4. è·Ÿè¸ªåˆ—è¡¨ç”Ÿæˆæµç¨‹ï¼ˆgenerateTrackingListï¼‰

```
generateTrackingList()
    â†“
[æ£€æŸ¥1] ç¼“å­˜æœ‰æ•ˆæ€§æ£€æŸ¥ (_isCacheValid)
    â”œâ”€â”€ ç¼“å­˜æœ‰æ•ˆ â†’ ç›´æ¥è¿”å›ç¼“å­˜ (0æ¬¡è®¡ç®—)
    â””â”€â”€ ç¼“å­˜æ— æ•ˆ â†’ ç»§ç»­
    â†“
[æ‰§è¡Œ] æ•°æ®è¿ç§» (migrateDataWithUUID)
    â””â”€â”€ ç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½æœ‰UUID
    â†“
[æ•°æ®æ‹‰å–1] getTrackingRecords()
    â””â”€â”€ localStorage.getItem('msh_sunday_tracking') [1æ¬¡è¯»å–]
    â””â”€â”€ Firebase: trackingRecords/* [å¯é€‰ï¼Œå¦‚æœæœ‰åŒæ­¥]
    â†“
[æ•°æ®æ‹‰å–2] getAllMembers()
    â””â”€â”€ éå† window.groups [å†…å­˜è¯»å–ï¼Œ0æ¬¡IO]
    â†“
[éå†] å¯¹æ¯ä¸ªæˆå‘˜æ‰§è¡Œï¼š
    â”œâ”€â”€ [æ£€æŸ¥] æ˜¯å¦æ’é™¤æˆå‘˜ (isMemberExcluded)
    â”‚   â”œâ”€â”€ æ˜¯ â†’ è·³è¿‡
    â”‚   â””â”€â”€ å¦ â†’ ç»§ç»­
    â”‚
    â”œâ”€â”€ [æ•°æ®æ‹‰å–3] getMemberTrackingRecords(memberUUID)
    â”‚   â””â”€â”€ ä»è·Ÿè¸ªè®°å½•ä¸­ç­›é€‰è¯¥æˆå‘˜ [å†…å­˜æ“ä½œ]
    â”‚
    â”œâ”€â”€ [è®¡ç®—] calculateConsecutiveAbsences(memberUUID)
    â”‚   â””â”€â”€ è§ä¸‹æ–¹è¯¦ç»†æµç¨‹
    â”‚
    â””â”€â”€ [ç”Ÿæˆ] ä¸ºæ¯ä¸ªç¼ºå‹¤äº‹ä»¶åˆ›å»ºè·Ÿè¸ªè®°å½•
        â”œâ”€â”€ æ£€æŸ¥æ˜¯å¦å·²æœ‰è®°å½•
        â”œâ”€â”€ æ£€æŸ¥æ˜¯å¦æ»¡è¶³ç”Ÿæˆæ¡ä»¶
        â””â”€â”€ åˆ›å»ºæ–°è®°å½•æˆ–æ›´æ–°ç°æœ‰è®°å½•
    â†“
ä¿å­˜è·Ÿè¸ªè®°å½•åˆ° localStorage [1æ¬¡å†™å…¥]
åŒæ­¥åˆ°Firebase [å¯é€‰ï¼Œå¦‚æœæœ‰å˜åŒ–] [1æ¬¡å†™å…¥]
```

### 5. è¿ç»­ç¼ºå‹¤è®¡ç®—æµç¨‹ï¼ˆcalculateConsecutiveAbsencesï¼‰

```
calculateConsecutiveAbsences(memberUUID)
    â†“
[æ£€æŸ¥1] æˆå‘˜è®¡ç®—ç¼“å­˜
    â”œâ”€â”€ ç¼“å­˜æœ‰æ•ˆ (<2åˆ†é’Ÿ) â†’ ç›´æ¥è¿”å›ç¼“å­˜ (0æ¬¡è®¡ç®—)
    â””â”€â”€ ç¼“å­˜æ— æ•ˆ â†’ ç»§ç»­
    â†“
[æ•°æ®æ‹‰å–1] getMemberTrackingRecords(memberUUID)
    â””â”€â”€ ä»è·Ÿè¸ªè®°å½•ä¸­ç­›é€‰ [å†…å­˜æ“ä½œ]
    â†“
[åˆ¤æ–­] ç¡®å®šæ£€æŸ¥èµ·ç‚¹ (checkStartDate)
    â”œâ”€â”€ æœ‰å·²è§£å†³çš„è®°å½• â†’ ä» nextCheckDate å¼€å§‹
    â””â”€â”€ æ— è®°å½• â†’ ä» 2025-08-03 å¼€å§‹
    â†“
[è®¡ç®—] getSundayDatesFromStart(checkStartDate, currentDate)
    â””â”€â”€ ç”Ÿæˆä¸»æ—¥æ—¥æœŸåˆ—è¡¨ [å†…å­˜è®¡ç®—]
    â†“
[æ•°æ®æ‹‰å–2] getMemberAttendanceRecords(memberUUID, checkStartDate)
    â””â”€â”€ ä» window.attendanceRecords ç­›é€‰
    â””â”€â”€ å¦‚æœ window.attendanceRecords ä¸ºç©ºï¼Œå¯èƒ½éœ€è¦ä» localStorage è¯»å–
    â””â”€â”€ localStorage.getItem('msh_attendance_records') [æœ€å¤š1æ¬¡è¯»å–]
    â†“
[è®¡ç®—] identifyAbsenceEvents(sundayDates, memberRecords, memberUUID)
    â””â”€â”€ è¯†åˆ«æ‰€æœ‰ç‹¬ç«‹çš„ç¼ºå‹¤äº‹ä»¶ [å†…å­˜è®¡ç®—]
    â””â”€â”€ è°ƒç”¨ identifyConsecutiveAbsencePeriods()
    â†“
[æ›´æ–°] updateExistingEvents(absenceEvents, memberUUID)
    â””â”€â”€ æ›´æ–°ç°æœ‰äº‹ä»¶çŠ¶æ€ [å†…å­˜æ“ä½œ]
    â†“
ä¿å­˜åˆ°æˆå‘˜è®¡ç®—ç¼“å­˜ [å†…å­˜æ“ä½œ]
```

---

## ğŸ§  å…³é”®åˆ¤æ–­é€»è¾‘

### 1. ç¼“å­˜æœ‰æ•ˆæ€§åˆ¤æ–­

#### è·Ÿè¸ªåˆ—è¡¨ç¼“å­˜ (_isCacheValid)
```javascript
æ¡ä»¶1: ç¼“å­˜æ•°æ®å­˜åœ¨
æ¡ä»¶2: ç¼“å­˜æœªè¿‡æœŸï¼ˆæ•°æ®å“ˆå¸Œæœªå˜åŒ–ï¼‰
æ¡ä»¶3: æ²¡æœ‰ç»ˆæ­¢çŠ¶æ€çš„è®°å½•ï¼ˆå¦‚æœæœ‰ç»ˆæ­¢è®°å½•ï¼Œå¼ºåˆ¶åˆ·æ–°ï¼‰
æ¡ä»¶4: FirebaseåŒæ­¥æ—¶é—´æ£€æŸ¥ï¼ˆå¦‚æœFirebaseåŒæ­¥æ—©äºç¼“å­˜ï¼Œå¯èƒ½éœ€è¦æ›´æ–°ï¼‰

åˆ¤æ–­ç»“æœï¼š
- å…¨éƒ¨æ»¡è¶³ â†’ ä½¿ç”¨ç¼“å­˜
- ä»»ä¸€ä¸æ»¡è¶³ â†’ é‡æ–°ç”Ÿæˆ
```

#### æˆå‘˜è®¡ç®—ç¼“å­˜
```javascript
æ¡ä»¶1: ç¼“å­˜æ•°æ®å­˜åœ¨
æ¡ä»¶2: ç¼“å­˜æ—¶é—´ < 2åˆ†é’Ÿ

åˆ¤æ–­ç»“æœï¼š
- æ»¡è¶³ â†’ ä½¿ç”¨ç¼“å­˜
- ä¸æ»¡è¶³ â†’ é‡æ–°è®¡ç®—
```

### 2. æˆå‘˜æ’é™¤åˆ¤æ–­ (isMemberExcluded)

```javascript
æ£€æŸ¥é¡¹ï¼š
1. æˆå‘˜æ˜¯å¦åœ¨ window.excludedMembers ä¸­
2. æˆå‘˜çš„ excludedFromAttendanceTracking æ ‡è®°
3. æˆå‘˜æ˜¯å¦å·²åˆ é™¤ï¼ˆgroupsä¸­ä¸å­˜åœ¨ï¼‰

åˆ¤æ–­ç»“æœï¼š
- ä»»ä¸€æ»¡è¶³ â†’ æ’é™¤ï¼Œä¸ç”Ÿæˆäº‹ä»¶
- å…¨éƒ¨ä¸æ»¡è¶³ â†’ ç»§ç»­å¤„ç†
```

### 3. äº‹ä»¶ç”Ÿæˆæ¡ä»¶åˆ¤æ–­ (shouldGenerateEvent)

```javascript
æ¡ä»¶1: è¿ç»­ç¼ºå‹¤æ¬¡æ•° >= 2æ¬¡
æ¡ä»¶2: äº‹ä»¶å¼€å§‹æ—¥æœŸ <= å½“å‰æ—¥æœŸ
æ¡ä»¶3: æ²¡æœ‰å·²å­˜åœ¨çš„ç›¸åŒäº‹ä»¶è®°å½•

åˆ¤æ–­ç»“æœï¼š
- å…¨éƒ¨æ»¡è¶³ â†’ ç”Ÿæˆæ–°äº‹ä»¶
- ä»»ä¸€ä¸æ»¡è¶³ â†’ è·³è¿‡
```

### 4. äº‹ä»¶ç±»å‹åˆ¤æ–­

```javascript
è¿ç»­ç¼ºå‹¤æ¬¡æ•°ï¼š
- >= 4æ¬¡ â†’ extended_absence (ä¸¥é‡ç¼ºå‹¤)
- >= 3æ¬¡ â†’ severe_absence (ä¸¥é‡ç¼ºå‹¤)
- >= 2æ¬¡ â†’ tracking (æ™®é€šè·Ÿè¸ª)

äº‹ä»¶çŠ¶æ€ï¼š
- active: æ´»è·ƒè·Ÿè¸ªä¸­
- terminated: å·²ç»ˆæ­¢
- resolved: å·²è§£å†³
```

### 5. æ£€æŸ¥èµ·ç‚¹åˆ¤æ–­

```javascript
æ¡ä»¶1: æ˜¯å¦æœ‰å·²è§£å†³/å·²ç»ˆæ­¢çš„è·Ÿè¸ªè®°å½•
    â”œâ”€â”€ æœ‰ â†’ ä½¿ç”¨ latestResolvedRecord.nextCheckDate
    â””â”€â”€ æ—  â†’ ä½¿ç”¨é»˜è®¤å€¼ 2025-08-03

æ¡ä»¶2: checkStartDate æ˜¯å¦æœ‰æ•ˆ
    â”œâ”€â”€ æœ‰æ•ˆ â†’ ä½¿ç”¨
    â””â”€â”€ æ— æ•ˆ â†’ ä½¿ç”¨é»˜è®¤å€¼ 2025-08-03
```

---

## ğŸ“Š æ•°æ®æ‹‰å–æ¬¡æ•°ç»Ÿè®¡

### åœºæ™¯1: é¦–æ¬¡åŠ è½½ï¼ˆæ— ç¼“å­˜ï¼‰

```
loadSundayTracking()
    â†“
[æ£€æŸ¥] ç¼“å­˜ â†’ æ— 
    â†“
generateUltraLightEventList()
    â†“
generateTrackingList()
    â”œâ”€â”€ getTrackingRecords()
    â”‚   â””â”€â”€ localStorageè¯»å–: 1æ¬¡
    â”‚   â””â”€â”€ Firebaseè¯»å–: 0æ¬¡ï¼ˆå¯é€‰åŒæ­¥ï¼‰
    â”‚
    â”œâ”€â”€ éå† N ä¸ªæˆå‘˜
    â”‚   â””â”€â”€ æ¯ä¸ªæˆå‘˜: calculateConsecutiveAbsences()
    â”‚       â”œâ”€â”€ getMemberAttendanceRecords()
    â”‚       â”‚   â””â”€â”€ window.attendanceRecords (å†…å­˜ï¼Œ0æ¬¡IO)
    â”‚       â”‚   â””â”€â”€ localStorageè¯»å–: æœ€å¤š1æ¬¡ï¼ˆå¦‚æœwindow.attendanceRecordsä¸ºç©ºï¼‰
    â”‚       â”‚
    â”‚       â””â”€â”€ è®¡ç®—ç¼ºå‹¤äº‹ä»¶ (å†…å­˜è®¡ç®—)
    â”‚
    â””â”€â”€ ä¿å­˜è·Ÿè¸ªè®°å½•
        â””â”€â”€ localStorageå†™å…¥: 1æ¬¡
        â””â”€â”€ Firebaseå†™å…¥: 1æ¬¡ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰

æ€»è®¡ï¼š
- localStorageè¯»å–: 1 + (N * 0-1) = 1-51æ¬¡ (å‡è®¾æœ€å¤š50ä¸ªæˆå‘˜)
- localStorageå†™å…¥: 1æ¬¡
- Firebaseè¯»å–: 0-1æ¬¡ï¼ˆå¯é€‰ï¼‰
- Firebaseå†™å…¥: 1æ¬¡ï¼ˆå¯é€‰ï¼‰
```

### åœºæ™¯2: ä½¿ç”¨ç¼“å­˜ï¼ˆç¼“å­˜æœ‰æ•ˆï¼‰

```
loadSundayTracking()
    â†“
[æ£€æŸ¥] ç¼“å­˜ â†’ æœ‰æ•ˆ
    â†“
ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ

æ€»è®¡ï¼š
- localStorageè¯»å–: 0æ¬¡
- localStorageå†™å…¥: 0æ¬¡
- Firebaseè¯»å–: 0æ¬¡
- Firebaseå†™å…¥: 0æ¬¡
```

### åœºæ™¯3: æˆå‘˜è®¡ç®—ç¼“å­˜æœ‰æ•ˆ

```
generateTrackingList()
    â†“
éå† N ä¸ªæˆå‘˜
    â”œâ”€â”€ æˆå‘˜1: ç¼“å­˜æœ‰æ•ˆ â†’ ç›´æ¥è¿”å› (0æ¬¡IO)
    â”œâ”€â”€ æˆå‘˜2: ç¼“å­˜æ— æ•ˆ â†’ è®¡ç®— (1æ¬¡localStorageè¯»å–)
    â””â”€â”€ ...

æ€»è®¡ï¼š
- å–å†³äºç¼“å­˜å‘½ä¸­ç‡
- ç†æƒ³æƒ…å†µï¼ˆå…¨éƒ¨ç¼“å­˜å‘½ä¸­ï¼‰: 0æ¬¡IO
- æœ€åæƒ…å†µï¼ˆå…¨éƒ¨ç¼“å­˜å¤±æ•ˆï¼‰: Næ¬¡localStorageè¯»å–
```

### åœºæ™¯4: åŸºç¡€æ•°æ®æœªåŠ è½½

```
loadSundayTracking()
    â†“
[æ£€æŸ¥] window.attendanceRecords â†’ æœªåŠ è½½
    â†“
ç­‰å¾… NewDataManager.loadAllDataFromFirebase()
    â”œâ”€â”€ Firebaseè¯»å–: groups, groupNames, attendanceRecords
    â””â”€â”€ localStorageå†™å…¥: 3æ¬¡ï¼ˆgroups, groupNames, attendanceRecordsï¼‰

æ€»è®¡ï¼š
- Firebaseè¯»å–: 3æ¬¡
- localStorageå†™å…¥: 3æ¬¡
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. å¤šå±‚ç¼“å­˜æœºåˆ¶

```
L1ç¼“å­˜: ç»Ÿä¸€ç¼“å­˜ç®¡ç†å™¨ (unifiedCacheManager)
    â””â”€â”€ ç¼“å­˜æ•´ä¸ªäº‹ä»¶åˆ—è¡¨
    â””â”€â”€ æœ‰æ•ˆæœŸ: æ•°æ®æœªå˜åŒ–

L2ç¼“å­˜: SundayTrackingManager._cache.trackingList
    â””â”€â”€ ç¼“å­˜è·Ÿè¸ªåˆ—è¡¨
    â””â”€â”€ æœ‰æ•ˆæœŸ: æ•°æ®å“ˆå¸Œæœªå˜åŒ–

L3ç¼“å­˜: SundayTrackingManager._cache.memberCalculations
    â””â”€â”€ ç¼“å­˜æ¯ä¸ªæˆå‘˜çš„è®¡ç®—ç»“æœ
    â””â”€â”€ æœ‰æ•ˆæœŸ: 2åˆ†é’Ÿ
```

### 2. æ•°æ®æ‹‰å–ä¼˜åŒ–

```
ä¼˜åŒ–1: ä¼˜å…ˆä½¿ç”¨å†…å­˜æ•°æ® (window.attendanceRecords)
    â””â”€â”€ é¿å…é¢‘ç¹localStorageè¯»å–

ä¼˜åŒ–2: æ‰¹é‡å¤„ç†
    â””â”€â”€ ä¸€æ¬¡æ€§è·å–æ‰€æœ‰è·Ÿè¸ªè®°å½•
    â””â”€â”€ ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰äº‹ä»¶

ä¼˜åŒ–3: å»¶è¿Ÿè®¡ç®—
    â””â”€â”€ ä½¿ç”¨ setTimeout å¼‚æ­¥ç”Ÿæˆï¼Œé¿å…é˜»å¡UI

ä¼˜åŒ–4: å¢é‡è®¡ç®—
    â””â”€â”€ ä»ä¸Šæ¬¡æ£€æŸ¥èµ·ç‚¹å¼€å§‹ï¼Œä¸é‡å¤è®¡ç®—å†å²æ•°æ®
```

### 3. åˆ¤æ–­é€»è¾‘ä¼˜åŒ–

```
ä¼˜åŒ–1: æå‰é€€å‡º
    â””â”€â”€ æ’é™¤æˆå‘˜ç«‹å³è·³è¿‡ï¼Œä¸è¿›è¡Œåç»­è®¡ç®—

ä¼˜åŒ–2: ç¼“å­˜å‘½ä¸­ä¼˜å…ˆ
    â””â”€â”€ ä¼˜å…ˆæ£€æŸ¥ç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—

ä¼˜åŒ–3: æ•°æ®è¿ç§»åˆå¹¶
    â””â”€â”€ æ•°æ®è¿ç§»åªåœ¨å¿…è¦æ—¶æ‰§è¡Œï¼Œä¸”åªæ‰§è¡Œä¸€æ¬¡
```

---

## ğŸ” å…³é”®æ•°æ®æµ

### 1. ç­¾åˆ°è®°å½•æµå‘

```
Firebase (attendanceRecords)
    â†“
NewDataManager.loadAllDataFromFirebase()
    â†“
window.attendanceRecords (å…¨å±€å˜é‡)
    â†“
getMemberAttendanceRecords(memberUUID)
    â†“
calculateConsecutiveAbsences()
    â†“
identifyAbsenceEvents()
```

### 2. è·Ÿè¸ªè®°å½•æµå‘

```
Firebase (trackingRecords)
    â†“
getTrackingRecords()
    â”œâ”€â”€ localStorage (msh_sunday_tracking) [ä¼˜å…ˆ]
    â””â”€â”€ Firebase (trackingRecords/*) [å¯é€‰åŒæ­¥]
    â†“
generateTrackingList()
    â†“
æ›´æ–°/åˆ›å»ºè·Ÿè¸ªè®°å½•
    â†“
ä¿å­˜åˆ° localStorage
    â†“
åŒæ­¥åˆ° Firebase
```

### 3. æˆå‘˜ä¿¡æ¯æµå‘

```
Firebase (groups)
    â†“
NewDataManager.loadAllDataFromFirebase()
    â†“
window.groups (å…¨å±€å˜é‡)
    â†“
getAllMembers()
    â†“
éå†å¤„ç†æ¯ä¸ªæˆå‘˜
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å…¸å‹åœºæ™¯æ€§èƒ½ï¼ˆåŸºäºä»£ç åˆ†æï¼‰

```
åœºæ™¯1: é¦–æ¬¡åŠ è½½ï¼ˆ50ä¸ªæˆå‘˜ï¼‰
- æ€»è€—æ—¶: ~500-2000ms
- Firebaseè¯»å–: 3æ¬¡
- localStorageè¯»å–: 1-51æ¬¡
- localStorageå†™å…¥: 1-4æ¬¡

åœºæ™¯2: ä½¿ç”¨ç¼“å­˜
- æ€»è€—æ—¶: ~10-50ms
- Firebaseè¯»å–: 0æ¬¡
- localStorageè¯»å–: 0æ¬¡

åœºæ™¯3: éƒ¨åˆ†ç¼“å­˜å¤±æ•ˆï¼ˆ10ä¸ªæˆå‘˜é‡æ–°è®¡ç®—ï¼‰
- æ€»è€—æ—¶: ~200-800ms
- localStorageè¯»å–: 10æ¬¡
- localStorageå†™å…¥: 1æ¬¡
```

### ä¼˜åŒ–æ•ˆæœ

```
ä¼˜åŒ–å‰ï¼ˆæ— ç¼“å­˜ï¼‰:
- æ¯æ¬¡åŠ è½½éƒ½é‡æ–°è®¡ç®—æ‰€æœ‰æˆå‘˜
- 50ä¸ªæˆå‘˜ Ã— 100ms = 5000ms

ä¼˜åŒ–åï¼ˆæœ‰ç¼“å­˜ï¼‰:
- é¦–æ¬¡åŠ è½½: 2000ms
- åç»­åŠ è½½: 50ms
- æ€§èƒ½æå‡: 100å€
```

---

## ğŸš¨ æ½œåœ¨é—®é¢˜å’Œä¼˜åŒ–å»ºè®®

### 1. æ•°æ®æ‹‰å–æ¬¡æ•°è¿‡å¤š

**é—®é¢˜**:
- æ¯ä¸ªæˆå‘˜å¯èƒ½è¯»å–ä¸€æ¬¡localStorageï¼ˆå¦‚æœwindow.attendanceRecordsä¸ºç©ºï¼‰
- å¦‚æœ50ä¸ªæˆå‘˜ï¼Œå¯èƒ½è¯»å–50æ¬¡localStorage

**å»ºè®®**:
- ç¡®ä¿window.attendanceRecordsåœ¨é¡µé¢åŠ è½½æ—¶å·²å¡«å……
- å¦‚æœå¿…é¡»ä»localStorageè¯»å–ï¼Œæ‰¹é‡è¯»å–ä¸€æ¬¡

### 2. ç¼“å­˜å¤±æ•ˆç­–ç•¥

**é—®é¢˜**:
- æˆå‘˜è®¡ç®—ç¼“å­˜æœ‰æ•ˆæœŸä»…2åˆ†é’Ÿ
- å¯èƒ½é¢‘ç¹é‡æ–°è®¡ç®—

**å»ºè®®**:
- å¢åŠ ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆå¦‚5åˆ†é’Ÿï¼‰
- æ·»åŠ äº‹ä»¶é©±åŠ¨çš„ç¼“å­˜å¤±æ•ˆï¼ˆåªæœ‰ç­¾åˆ°æ•°æ®å˜åŒ–æ—¶æ‰å¤±æ•ˆï¼‰

### 3. äº‹ä»¶ç”Ÿæˆæ¡ä»¶ä¸æ¸…æ™°

**é—®é¢˜**:
- shouldGenerateEventå‡½æ•°çš„åˆ¤æ–­é€»è¾‘åˆ†æ•£
- å¯èƒ½å¯¼è‡´é—æ¼æˆ–é‡å¤ç”Ÿæˆäº‹ä»¶

**å»ºè®®**:
- ç»Ÿä¸€äº‹ä»¶ç”Ÿæˆåˆ¤æ–­é€»è¾‘
- æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•

### 4. æ•°æ®åŒæ­¥æ—¶æœº

**é—®é¢˜**:
- è·Ÿè¸ªè®°å½•å¯èƒ½æ²¡æœ‰åŠæ—¶åŒæ­¥åˆ°Firebase
- å¯èƒ½å¯¼è‡´å¤šè®¾å¤‡æ•°æ®ä¸ä¸€è‡´

**å»ºè®®**:
- æ¯æ¬¡ä¿å­˜è·Ÿè¸ªè®°å½•åç«‹å³åŒæ­¥åˆ°Firebase
- æ·»åŠ åŒæ­¥å¤±è´¥é‡è¯•æœºåˆ¶

---

## ğŸ“ ä»£ç è°ƒç”¨å…³ç³»å›¾

```
sunday-tracking.html
    â†“
src/sunday-tracking/index.js
    â”œâ”€â”€ loadSundayTracking()
    â”‚   â””â”€â”€ generateUltraLightEventList()
    â”‚       â””â”€â”€ src/sunday-tracking/event-manager.js
    â”‚
    â””â”€â”€ src/sunday-tracking/data-handler.js
        â””â”€â”€ NewDataManager
            â””â”€â”€ src/new-data-manager.js

generateUltraLightEventList()
    â†“
window.utils.SundayTrackingManager.generateTrackingList()
    â†“
src/features/sunday-tracking-utils.js
    â”œâ”€â”€ generateTrackingList()
    â”œâ”€â”€ calculateConsecutiveAbsences()
    â”œâ”€â”€ getMemberAttendanceRecords()
    â””â”€â”€ getTrackingRecords()

calculateConsecutiveAbsences()
    â†“
window.utils.identifyAbsenceEvents()
    â†“
src/core/time-utils.js
    â”œâ”€â”€ identifyAbsenceEvents()
    â””â”€â”€ identifyConsecutiveAbsencePeriods()
```

---

## ğŸ¯ å†æ¬¡å¼€å‘å»ºè®®

### 1. ä¼˜åŒ–æ•°æ®æ‹‰å–ç­–ç•¥

```
å»ºè®®1: ç»Ÿä¸€æ•°æ®æº
- ç¡®ä¿window.attendanceRecordsåœ¨é¡µé¢åŠ è½½æ—¶å·²å¡«å……
- é¿å…åœ¨è®¡ç®—è¿‡ç¨‹ä¸­è¯»å–localStorage

å»ºè®®2: æ‰¹é‡æ•°æ®æ‹‰å–
- ä¸€æ¬¡æ€§è¯»å–æ‰€æœ‰éœ€è¦çš„æ•°æ®
- å‡å°‘IOæ“ä½œæ¬¡æ•°
```

### 2. æ”¹è¿›ç¼“å­˜æœºåˆ¶

```
å»ºè®®1: äº‹ä»¶é©±åŠ¨ç¼“å­˜å¤±æ•ˆ
- åªæœ‰ç­¾åˆ°æ•°æ®å˜åŒ–æ—¶æ‰å¤±æ•ˆç¼“å­˜
- é¿å…å®šæ—¶å¤±æ•ˆå¯¼è‡´çš„é‡å¤è®¡ç®—

å»ºè®®2: åˆ†å±‚ç¼“å­˜ç­–ç•¥
- L1: é¡µé¢çº§ç¼“å­˜ï¼ˆäº‹ä»¶åˆ—è¡¨ï¼‰
- L2: åˆ—è¡¨çº§ç¼“å­˜ï¼ˆè·Ÿè¸ªåˆ—è¡¨ï¼‰
- L3: æˆå‘˜çº§ç¼“å­˜ï¼ˆæˆå‘˜è®¡ç®—ç»“æœï¼‰
```

### 3. ä¼˜åŒ–äº‹ä»¶ç”Ÿæˆé€»è¾‘

```
å»ºè®®1: ç»Ÿä¸€åˆ¤æ–­é€»è¾‘
- é›†ä¸­æ‰€æœ‰åˆ¤æ–­æ¡ä»¶åœ¨ä¸€ä¸ªå‡½æ•°ä¸­
- æ·»åŠ è¯¦ç»†çš„åˆ¤æ–­æ—¥å¿—

å»ºè®®2: äº‹ä»¶å»é‡æœºåˆ¶
- ç¡®ä¿ä¸ä¼šé‡å¤ç”Ÿæˆç›¸åŒçš„äº‹ä»¶
- æ£€æŸ¥äº‹ä»¶IDå’Œæˆå‘˜UUIDçš„ç»„åˆå”¯ä¸€æ€§
```

### 4. æ€§èƒ½ç›‘æ§

```
å»ºè®®1: æ·»åŠ æ€§èƒ½æŒ‡æ ‡
- è®°å½•æ¯æ¬¡æ“ä½œçš„è€—æ—¶
- è®°å½•æ•°æ®æ‹‰å–æ¬¡æ•°
- è®°å½•ç¼“å­˜å‘½ä¸­ç‡

å»ºè®®2: æ€§èƒ½åˆ†æå·¥å…·
- å¼€å‘æ€§èƒ½åˆ†æé¡µé¢
- å¯è§†åŒ–æ€§èƒ½æŒ‡æ ‡
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä»£ç ç´¢å¼•æ–‡æ¡£](../CODE_INDEX.md) - å…³é”®å‡½æ•°ä½ç½®ç´¢å¼•
- [ä»£ç ä¿®å¤æ£€æŸ¥æ¸…å•](../CODE_FIX_CHECKLIST.md) - ä¿®å¤å‰æ£€æŸ¥æ¸…å•
- [ä¸»æ—¥è·Ÿè¸ªæ£€æŸ¥æŠ¥å‘Š](./SUNDAY_TRACKING_INSPECTION_2025-11-04.md) - é¡µé¢æ£€æŸ¥æŠ¥å‘Š

---

**æŠ¥å‘Šäºº**: AI Assistant  
**å®¡æ ¸äºº**: å¾…å®¡æ ¸  
**çŠ¶æ€**: âœ… åˆ†æå®Œæˆï¼Œå¯ç”¨äºå†æ¬¡å¼€å‘å‚è€ƒ
