# MSH 签到系统

一个基于Web的签到管理系统，支持多小组管理、实时数据同步和自动备份。

## 🚀 快速开始

### 本地开发
```bash
# 使用Python启动本地服务器
python -m http.server 8000

# 或使用Node.js
npx http-server -p 8000
```

访问 `http://localhost:8000` 开始使用。

## ✨ 最新更新 (2025-09-22)

### 🔧 事件创建逻辑修复 (重要修复)
- **智能事件分割**: 修复事件创建逻辑，现在能正确基于中间签到记录分割缺勤事件
- **逻辑优化**: 实现`shouldStartNewAbsenceEvent`函数，智能判断是否应该开始新事件
- **数据准确性**: 确保生成的事件数量符合实际的签到情况，解决用户报告的问题
- **调试工具**: 创建专门的调试工具验证修复效果，确保逻辑正确性
- **性能保持**: 修复过程中保持原有的性能优化效果

### 🚀 Sunday Tracking性能优化 (重大更新)
- **核心算法优化**: 实现时间预排除策略，计算时间减少80-90%，从O(n*m)优化到O(n+m)
- **Firebase同步完善**: 实现100%数据同步覆盖，所有跟踪记录操作都同步到Firebase
- **智能缓存优化**: 缓存时间从5分钟延长到30分钟，智能失效判断，与Firebase同步协调
- **页面加载优化**: 添加加载状态指示和延迟加载策略，提升用户体验
- **数据预加载**: 实现后台数据预计算，进一步提升页面响应速度
- **性能监控**: 详细的性能日志和优化效果统计

### 🛡️ 页面关闭保护机制 (新增)
- **数据安全保护**: 在签到页面添加页面关闭保护机制，防止未同步数据丢失
- **智能检测**: 自动检测未同步的本地数据变更
- **用户友好**: 提供清晰的确认对话框和同步选项
- **自动同步**: 用户选择时自动执行数据同步，确保数据安全
- **强制关闭警告**: 用户选择不同步时显示数据丢失警告

### 🚀 智能数据拉取和统一导航机制 (重大更新)
- **智能数据拉取策略**: 实现基于数据新鲜度的智能拉取机制，减少80%的不必要网络请求
- **统一返回导航**: 创建统一的页面返回机制，包含数据同步检查和智能返回策略
- **数据新鲜度检查**: 5分钟内的数据认为新鲜，跳过重新加载，大幅提升页面切换速度
- **智能合并机制**: 实现三路合并算法，自动处理数据冲突，保护本地新增数据
- **页面跳转优化**: 优先使用`history.back()`保持页面状态，fallback到直接跳转
- **同步预览界面**: 提供详细的合并预览，让用户了解数据变化情况

### 📊 新增人员显示逻辑统一
- **数据源统一**: daily-report页面和index页面现在使用相同的数据源和逻辑
- **显示一致性**: 基于groups数据中的addedViaNewcomerButton和joinDate字段统一判断
- **简化维护**: 移除了对dailyNewcomers的依赖，避免数据过期和同步问题
- **实时更新**: 基于实时groups数据，无需额外同步机制

### ⏰ 签到规则完善
- **严格限制**: 实施0:00-10:40时间段内只允许一次签到的规则
- **时间槽优化**: 10:40-11:30为禁止签到时段，11:30后为下午签到
- **自动更新**: 手动编辑签到时间时timeSlot字段自动更新
- **统计准确**: Summary页面基于memberUUID去重统计，确保数据准确性

### 🔧 成员管理功能完善
- **成员移动功能**: 恢复成员在小组间移动的功能，支持历史签到记录完整性保护
- **修改组名功能**: 恢复修改小组名称的功能，支持实时同步到Firebase
- **数据导出功能**: 新增成员信息导出功能，支持CSV和JSON格式，可自定义导出字段
- **导出特性**: 
  - 支持导出当前小组或所有小组
  - 可选择性导出字段（小组名称、UUID、姓名、花名、性别等）
  - 自动生成带时间戳的文件名
  - 支持中文字符导出（CSV添加BOM）

## ✨ 历史更新 (2025-01-18)

### 🎯 Firebase数据拉取优化（重要）
- **统一数据状态管理**: 所有页面使用统一的`window.newDataManager.isDataLoaded`检查
- **避免重复拉取**: 完全消除页面切换时的重复Firebase数据拉取
- **性能大幅提升**: 页面切换速度提升约80%，网络请求减少约90%
- **等待机制**: 实现最多1秒的等待机制，每100ms检查一次NewDataManager状态
- **双重检查**: 检查`isDataLoaded`标志和本地数据存在性
- **优雅降级**: 如果等待超时，仍能正常工作

### 🎯 管理员页面界面优化
- **删除重复控件**: 从admin.html页面删除"查看签到原始记录"按钮
- **功能整合**: 该功能已在查看签到汇总页面(summary.html)中提供
- **界面简化**: 减少重复功能，提升用户体验
- **代码清理**: 删除对应的HTML和JavaScript代码

### 🎯 未签到不统计模块搜索功能优化
- **搜索控件修复**: 按照index页面姓名检索控件标准修复未签到不统计搜索控件
- **数据验证增强**: 添加完整的数据源验证和错误处理机制
- **搜索逻辑优化**: 支持多种字段名和花名搜索，提高搜索准确性
- **排除列表搜索**: 新增排除列表搜索功能，支持搜索已排除人员
- **智能搜索**: 支持按姓名、花名、组别进行过滤，大小写不敏感
- **用户体验**: 统一的显示格式和交互方式，实时搜索和清除功能

### 🎯 成员管理页面小组选择控件修复
- **小组选择控件**: 修复小组选择控件显示数字索引而不是实际小组名称的问题
- **数据格式转换**: 修复数组格式数据到对象格式的转换逻辑
- **sortGroups函数调用**: 修复utils.sortGroups函数调用参数错误的问题
- **小组名称映射**: 正确显示小组名称映射关系（如"乐清1组"显示为"静静组"）
- **选项排序**: 小组选项按正确顺序排列，"未分组"排在最后

## ✨ 历史更新 (2025-01-16)

### 🎯 成员管理页面恢复
- **页面恢复**: 重新创建完整的成员管理页面和功能
- **界面优化**: 页面标题改为"成员管理"，按钮布局优化
- **功能完整**: 恢复所有成员管理功能，包括添加、编辑、删除、搜索
- **花名管理**: 恢复成员花名编辑功能
- **未签到不统计**: 恢复排除成员管理功能
- **UUID编辑器**: 恢复UUID管理页面，支持UUID查看、编辑和管理

### 🎯 主日跟踪逻辑修复
- **事件终止机制**: 修复缺勤事件不会因签到自动结束，需要手动终止
- **组别名称显示**: 修复表格中显示正确的组别名称（如"静静组"）
- **多事件系统**: 完善多缺勤事件识别和管理系统
- **按钮名称更新**: "忽略"按钮改为"事件终止"

### 🎯 主日跟踪功能优化
- **筛选逻辑修复**: 修复连续缺勤计算逻辑，确保准确识别连续2次以上缺勤
- **事件类型分类**: 根据缺勤周数分类显示（2周、3周、4周以上缺勤）
- **小组筛选功能**: 可以筛选显示特定小组的跟踪事件
- **智能导出**: 按小组分组导出跟踪记录，包含序号和详细信息
- **界面优化**: 去掉不必要的控件，添加实时统计功能
- **性能优化**: 实现时间预排除策略，计算时间减少80-90%
- **Firebase同步**: 100%数据同步覆盖，确保数据安全
- **智能缓存**: 30分钟缓存有效期，大幅提升页面响应速度

### 🎯 用户体验优化
- **保存流程优化**: 编辑完成后立即关闭页面，数据同步在后台执行
- **同步机制改进**: 修复重复同步问题，减少同步弹窗次数
- **人员检索功能**: 在成员管理页面添加智能搜索功能
- **界面控件优化**: 统一控件样式，调整大小和布局
- **导航逻辑完善**: 修正页面间导航链接

### 🔧 技术改进
- **连续缺勤算法**: 修复从最新主日向前计算连续缺勤的逻辑
- **事件分类系统**: 实现2周、3周、4周以上缺勤的分类显示
- **防重复提交**: 应用防重复提交机制到所有保存操作
- **表单保护**: 增强表单提交防护，防止页面意外刷新
- **后台同步**: 优化数据同步流程，提升用户体验

## 📁 项目结构

```
MSH/
├── index.html                    # 主页面
├── admin.html                    # 管理页面
├── group-management.html         # 成员管理页面
├── summary.html                  # 签到汇总页面
├── sunday-tracking.html          # 主日跟踪页面
├── daily-report.html             # 日报页面
├── attendance-records.html       # 签到记录页面
├── delete-management.html        # 数据删除管理页面
├── config.js                     # 系统配置
├── manifest.json                 # PWA配置
├── favicon.ico                   # 网站图标
├── src/                          # 源代码目录
│   ├── main.js                   # 主逻辑
│   ├── admin.js                  # 管理逻辑
│   ├── group-management.js       # 成员管理逻辑
│   ├── summary.js                # 汇总逻辑
│   ├── sunday-tracking.js        # 主日跟踪逻辑
│   ├── daily-report.js           # 日报逻辑
│   ├── attendance-records.js     # 签到记录逻辑
│   ├── utils.js                  # 工具函数
│   ├── new-data-manager.js       # 新数据管理器（智能拉取和合并）
│   ├── navigation-utils.js       # 统一导航工具
│   ├── data-manager.js           # 数据管理
│   ├── session-storage-manager.js # SessionStorage管理
│   ├── independent-backup-manager.js # 独立备份管理
│   ├── style.css                 # 主样式
│   ├── virtual-scroll.css        # 虚拟滚动样式
│   ├── virtual-scroll.js         # 虚拟滚动功能
│   ├── security.js               # 安全模块
│   ├── performance-monitor.js    # 性能监控
│   ├── csrf-protection.js        # CSRF保护
│   ├── cache-manager.js          # 缓存管理
│   ├── config-manager.js         # 配置管理
│   └── service-worker.js         # 服务工作者
```

## 🔧 核心功能

### 数据存储架构
- **SessionStorage**: 会话级本地存储，浏览器关闭后自动清除
- **Firebase**: 云端实时数据库，永久保存和同步
- **独立备份**: 24小时自动备份，保留10天，与操作数据完全隔离
- **智能缓存**: 基于数据新鲜度的智能缓存机制，减少80%的网络请求
- **数据合并**: 三路合并算法处理本地和远程数据冲突

### 主要功能
- ✅ 多小组签到管理
- ✅ 实时数据同步
- ✅ 自动备份系统
- ✅ 签到汇总统计
- ✅ 日报生成
- ✅ 管理员权限控制
- ✅ 数据导入导出
- ✅ 离线支持
- ✅ 智能数据拉取
- ✅ 统一页面导航
- ✅ 页面关闭保护
- ✅ 数据冲突自动解决
- ✅ 页面状态保持
- ✅ 成员移动功能
- ✅ 修改组名功能
- ✅ 数据导出功能

## 🛠️ 管理工具

### 存储备份管理

## ⚙️ 配置

### Firebase配置
在 `config.js` 中配置Firebase连接信息：
```javascript
window.firebaseConfig = {
  apiKey: "your-api-key",
  authDomain: "your-project.firebaseapp.com",
  databaseURL: "https://your-project.firebaseio.com",
  projectId: "your-project-id",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "your-app-id"
};
```

### 系统配置
在 `config.js` 中配置系统参数：
- 小组名称和成员
- 管理员设置
- 系统选项

## 🔒 安全特性

- **CSRF保护**: 防止跨站请求伪造
- **输入验证**: 所有用户输入都经过验证
- **权限控制**: 基于Firebase安全规则
- **数据加密**: 敏感数据加密存储
- **备份隔离**: 备份系统与操作数据完全独立

## 📊 性能优化

- **智能缓存**: 5分钟缓存减少网络请求
- **虚拟滚动**: 大数据量高效渲染
- **异步处理**: 非阻塞数据操作
- **压缩存储**: 自动数据压缩
- **性能监控**: 实时性能统计

## 🚀 部署

### GitHub Pages
1. 将代码推送到GitHub仓库
2. 在仓库设置中启用GitHub Pages
3. 选择部署分支
4. 访问生成的URL

### 其他静态托管
- Netlify
- Vercel
- Firebase Hosting
- 任何支持静态文件的服务器

## 📝 使用说明

### 管理员登录
- 访问 `admin.html`
- 输入管理员密码
- 进行系统管理操作

### 签到操作
- 访问主页面
- 选择小组
- 点击成员进行签到

### 查看汇总
- 访问 `summary.html`
- 选择日期查看签到统计
- 导出数据或生成报告

## 🔧 故障排除

### 常见问题
1. **Firebase连接失败**: 检查网络连接和配置
2. **数据同步问题**: 使用管理工具检查状态
3. **备份恢复失败**: 验证备份文件完整性
4. **性能问题**: 检查缓存和网络状态

### 技术支持
- 使用内置的诊断工具
- 查看浏览器控制台错误
- 检查网络连接状态
- 验证Firebase配置

## 📄 许可证

本项目采用MIT许可证。

## 🤝 贡献

欢迎提交Issue和Pull Request来改进项目。

---

**注意**: 请确保在生产环境中正确配置Firebase安全规则和API密钥。
