# 系统需求文档

## 项目概述
MSH（主日学管理系统）是一个基于Web的教会主日学管理系统，用于管理小组、成员、签到记录等数据。

## 技术栈
- **前端**: HTML5, CSS3, JavaScript (ES6+)
- **后端**: Firebase Realtime Database
- **数据管理**: NewDataManager (自定义数据管理器)
- **存储**: localStorage + Firebase同步

## 核心功能模块

### 1. 主日学跟踪页面 (sunday-tracking.html)
- **功能**: 跟踪成员缺勤情况，生成缺勤事件
- **核心逻辑**: 
  - 自动检测连续缺勤
  - **智能事件分割**: 基于中间签到记录正确分割缺勤事件
  - 支持手动终止和重启事件
  - 统一显示所有事件状态（包括已终止事件）
- **数据同步**: 实时同步到Firebase
- **性能优化**:
  - **核心算法优化**: 时间预排除策略，计算时间减少80-90%
  - **Firebase同步完善**: 100%数据同步覆盖
  - **智能缓存优化**: 30分钟缓存有效期，智能失效判断
  - **页面加载优化**: 加载状态指示和延迟加载策略
  - **数据预加载**: 后台数据预计算，进一步提升响应速度
- **事件创建逻辑**:
  - **智能分割**: 实现`shouldStartNewAbsenceEvent`函数判断是否开始新事件
  - **中间签到检测**: 检查事件期间是否有签到记录来分割事件
  - **数据准确性**: 确保生成的事件数量符合实际签到情况

### 2. 删除管理页面 (delete-management.html)
- **功能**: 管理数据删除操作
- **子功能**:
  - 删除签到记录（支持多选）
  - 删除人员（同时删除相关签到记录）
  - 删除小组（同时删除所有成员和相关数据）
  - 批量清理历史数据
- **关键修复**: 
  - 修复了人员选择器被意外清空的问题
  - 确保删除按钮正确启用/禁用
  - 优化了数据同步逻辑

### 3. 数据管理器 (NewDataManager)
- **功能**: 统一的数据管理接口
- **特性**:
  - 本地存储 + Firebase同步
  - 自动数据变更检测
  - 批量操作优化
  - 数据完整性验证
  - **智能数据拉取**: 基于数据新鲜度的智能拉取机制
  - **智能合并**: 三路合并算法处理数据冲突
  - **实例复用**: 避免重复初始化和数据拉取
  - **数据预加载**: Sunday Tracking数据后台预计算

### 4. 统一导航系统 (NavigationUtils)
- **功能**: 统一的页面导航和返回机制
- **特性**:
  - 智能返回策略（优先使用history.back()）
  - 数据同步检查（返回前检查未同步数据）
  - 同步进度指示器

### 5. 页面关闭保护机制
- **功能**: 防止用户意外关闭页面导致数据丢失
- **实现位置**: 签到页面 (index.html)
- **保护机制**:
  - 检测未同步的本地数据变更
  - 页面关闭前弹出确认对话框
  - 提供同步选项或强制关闭警告
  - 自动执行数据同步（用户选择时）
- **用户体验**:
  - 友好的提示信息
  - 明确的选项说明
  - 数据安全保护

### 6. 成员管理页面 (group-management.html)
- **功能**: 小组成员管理和数据导出
- **核心功能**:
  - 添加、编辑、删除小组成员
  - 成员移动功能（在小组间移动成员）
  - 修改小组名称
  - 成员信息导出（CSV/JSON格式）
  - UUID编辑器
  - 未签到不统计管理
- **数据导出特性**:
  - 支持导出当前小组或所有小组
  - 可自定义导出字段（小组名称、UUID、姓名、花名等）
  - 支持CSV格式（Excel兼容）和JSON格式
  - 自动生成带时间戳的文件名
  - 支持中文字符导出
  - 错误处理和fallback机制
  - 页面加载优化

## 数据模型

### 小组 (Groups)
```javascript
{
  "groupKey": {
    "name": "成员姓名",
    "group": "小组标识"
  }
}
```

### 签到记录 (Attendance Records)
```javascript
[
  {
    "name": "成员姓名",
    "group": "小组标识", 
    "time": "2025-01-10T09:30:00.000Z",
    "type": "early|onTime|late|afternoon|invalid"
  }
]
```

### 跟踪记录 (Tracking Records)
```javascript
[
  {
    "recordId": "unique_id",
    "memberName": "成员姓名",
    "startDate": "2025-01-10",
    "status": "active|terminated|resolved",
    "createdAt": "2025-01-10T09:30:00.000Z",
    "updatedAt": "2025-01-10T09:30:00.000Z"
  }
]
```

## 系统要求

### 浏览器支持
- Chrome 80+
- Firefox 75+
- Safari 13+
- Edge 80+

### 网络要求
- 稳定的互联网连接（用于Firebase同步）
- 支持WebSocket连接

### 存储要求
- 浏览器支持localStorage
- 建议至少100MB可用存储空间

## 部署要求

### Firebase配置
- 需要有效的Firebase项目
- 配置Realtime Database规则
- 设置适当的权限控制

### 安全考虑
- 数据加密传输
- 用户身份验证（如需要）
- 数据备份策略

## 性能优化

### 数据加载
- 使用缓存机制减少重复加载
- 批量操作减少同步次数
- 懒加载非关键数据

### 用户体验
- 响应式设计
- 实时数据更新
- 操作反馈和确认

## 维护和更新

### 数据备份
- 定期导出数据
- Firebase自动备份
- 本地数据保护机制

### 版本控制
- 代码版本管理
- 数据迁移脚本
- 向后兼容性

## 故障排除

### 常见问题
1. **数据同步失败**: 检查网络连接和Firebase配置
2. **删除功能异常**: 确保选择器状态正确
3. **页面加载缓慢**: 检查数据量和网络状况

### 调试工具
- 浏览器开发者工具
- Firebase控制台
- 内置日志系统

## 更新日志

### 最新更新 (2025-09-21)

#### 🚀 智能数据拉取和统一导航机制 (重大更新)
- **智能数据拉取策略**: 实现基于数据新鲜度的智能拉取机制，减少80%的不必要网络请求
- **统一返回导航**: 创建统一的页面返回机制，包含数据同步检查和智能返回策略
- **数据新鲜度检查**: 5分钟内的数据认为新鲜，跳过重新加载，大幅提升页面切换速度
- **智能合并机制**: 实现三路合并算法，自动处理数据冲突，保护本地新增数据
- **页面跳转优化**: 优先使用`history.back()`保持页面状态，fallback到直接跳转

#### 📊 新增人员显示逻辑统一
- **数据源统一**: 修复daily-report页面新增人员显示问题，与index页面使用相同的数据源和逻辑
- **显示一致性**: 基于groups数据中的addedViaNewcomerButton和joinDate字段统一判断
- **简化维护**: 移除了对dailyNewcomers的依赖，避免数据过期和同步问题

#### ⏰ 签到规则完善
- **严格限制**: 实施0:00-10:40时间段内只允许一次签到的规则
- **时间槽优化**: 10:40-11:30为禁止签到时段，11:30后为下午签到
- **自动更新**: 手动编辑签到时间时timeSlot字段自动更新
- **统计准确**: Summary页面基于memberUUID去重统计，确保数据准确性

#### 🔧 成员管理功能完善
- **成员移动功能**: 恢复成员在小组间移动的功能，支持历史签到记录完整性保护
- **修改组名功能**: 恢复修改小组名称的功能，支持实时同步到Firebase
- **数据导出功能**: 新增成员信息导出功能，支持CSV和JSON格式，可自定义导出字段
- **导出特性**: 
  - 支持导出当前小组或所有小组
  - 可选择性导出字段（小组名称、UUID、姓名、花名、性别等）
  - 自动生成带时间戳的文件名
  - 支持中文字符导出（CSV添加BOM）

### 历史更新 (2025-01-10)
- 修复删除管理页面人员选择器问题
- 优化数据同步性能
- 改进用户界面反馈
- 增强错误处理机制

---

*本文档会随着系统更新而持续维护*
