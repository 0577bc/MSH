# åŒæ­¥æœºåˆ¶è§„èŒƒ-é«˜çº§æƒé™ - MSHç³»ç»Ÿæ•°æ®ä¿å­˜å’ŒåŒæ­¥æ ‡å‡†

## æ–‡æ¡£ä¿¡æ¯
- **æ–‡æ¡£åç§°**: åŒæ­¥æœºåˆ¶è§„èŒƒ-é«˜çº§æƒé™
- **ç‰ˆæœ¬**: 2.2
- **åˆ›å»ºæ—¥æœŸ**: 2025-01-18
- **æœ€åæ›´æ–°**: 2025-01-18
- **é€‚ç”¨èŒƒå›´**: MSHç³»ç»Ÿé«˜çº§æƒé™é¡µé¢ï¼ˆå•ç”¨æˆ·æ“ä½œï¼Œä¸ä½¿ç”¨NewDataManagerï¼‰
- **é‡è¦çº§åˆ«**: â­â­â­â­â­ (æ ¸å¿ƒè§„èŒƒï¼Œä¸å¯åˆ é™¤)

## æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº†MSHç³»ç»Ÿä¸­æ•°æ®ä¿å­˜å’ŒåŒæ­¥çš„æ ‡å‡†æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§ã€å¯é æ€§å’Œç”¨æˆ·ä½“éªŒçš„å‹å¥½æ€§ã€‚æ‰€æœ‰é¡µé¢åœ¨å®ç°æ•°æ®æ“ä½œåŠŸèƒ½æ—¶éƒ½åº”éµå¾ªæ­¤è§„èŒƒã€‚

## æ ¸å¿ƒæ¶æ„

### æ•°æ®æµç¨‹
```
é¡µé¢åŠ è½½ â†’ Firebaseæ‹‰å– â†’ æœ¬åœ°ç¼“å­˜ â†’ ç”¨æˆ·æ“ä½œ â†’ æœ¬åœ°ä¿®æ”¹ â†’ æ ‡è®°å˜æ›´ â†’ æ‰‹åŠ¨ä¿å­˜ â†’ ç›´æ¥FirebaseåŒæ­¥
```

### å…³é”®ç»„ä»¶
1. **æ•°æ®çŠ¶æ€ç®¡ç†**
2. **Firebaseæ•°æ®æ‹‰å–æœºåˆ¶**
3. **æ•°æ®å˜æ›´æ ‡è®°ç³»ç»Ÿ**
4. **ç›´æ¥FirebaseåŒæ­¥ç­–ç•¥**
5. **ç”¨æˆ·æç¤ºæœºåˆ¶**
6. **é”™è¯¯å¤„ç†å’Œå›é€€**

## è¯¦ç»†è§„èŒƒ

### 1. æ•°æ®çŠ¶æ€ç®¡ç†

#### å¿…éœ€å˜é‡
```javascript
// æ•°æ®çŠ¶æ€æ ‡å¿—
let hasChanges = false;        // å˜æ›´æ ‡å¿—
let allData = [];             // ä¸»æ•°æ®å­˜å‚¨
let filteredData = [];        // æ˜¾ç¤ºæ•°æ®ï¼ˆå¯é€‰ï¼‰
let selectedItem = null;      // å½“å‰é€‰ä¸­é¡¹ï¼ˆå¯é€‰ï¼‰
```

#### æ•°æ®åŠ è½½æœºåˆ¶
```javascript
function loadData() {
    try {
        // 1. ä¼˜å…ˆä»å…¨å±€å˜é‡è·å–æ•°æ®
        allData = window.dataKey || [];
        
        // 2. å¦‚æœå…¨å±€å˜é‡ä¸ºç©ºï¼Œä»localStorageè¯»å–
        if (allData.length === 0) {
            const storedData = localStorage.getItem('msh_dataKey');
            if (storedData) {
                allData = JSON.parse(storedData);
                window.dataKey = allData;
            }
        }
        
        // 3. æ›´æ–°æ˜¾ç¤º
        updateDisplay();
        updateStats();
        
        log('æ•°æ®åŠ è½½å®Œæˆ', 'success');
    } catch (error) {
        log(`æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
    }
}
```

### 2. Firebaseæ•°æ®æ‹‰å–æœºåˆ¶

#### æ‹‰å–æ—¶æœºå’Œç­–ç•¥
```javascript
// Firebaseæ•°æ®æ‹‰å–çš„æ ‡å‡†å®ç°
async function initializeFirebaseData() {
    try {
        // 1. æ£€æŸ¥Firebaseæ˜¯å¦å·²åˆå§‹åŒ–
        if (!firebase.apps.length) {
            firebase.initializeApp(window.firebaseConfig);
        }
        
        // 2. æ£€æŸ¥æœ¬åœ°æ•°æ®æ˜¯å¦æœ‰æ•ˆ
        const localData = localStorage.getItem('msh_dataKey');
        const localTimestamp = localStorage.getItem('msh_dataKey_timestamp');
        const isLocalDataValid = localData && localTimestamp && 
            (Date.now() - parseInt(localTimestamp)) < 300000; // 5åˆ†é’Ÿå†…æœ‰æ•ˆ
        
        // 3. æ‹‰å–ç­–ç•¥
        if (isLocalDataValid) {
            log('ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®ï¼Œè·³è¿‡Firebaseæ‹‰å–', 'info');
            return JSON.parse(localData);
        } else {
            log('æœ¬åœ°æ•°æ®è¿‡æœŸæˆ–ä¸å­˜åœ¨ï¼Œä»Firebaseæ‹‰å–', 'info');
            return await pullFromFirebase();
        }
    } catch (error) {
        log(`Firebaseåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
        return null;
    }
}

// ä»Firebaseæ‹‰å–æ•°æ®
async function pullFromFirebase() {
    try {
        const db = firebase.database();
        const snapshot = await db.ref('dataKey').once('value');
        const firebaseData = snapshot.val();
        
        if (firebaseData) {
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('msh_dataKey', JSON.stringify(firebaseData));
            localStorage.setItem('msh_dataKey_timestamp', Date.now().toString());
            log('âœ… æ•°æ®å·²ä»Firebaseæ‹‰å–å¹¶ç¼“å­˜', 'success');
            return firebaseData;
        } else {
            log('âš ï¸ Firebaseä¸­æ²¡æœ‰æ•°æ®', 'warning');
            return [];
        }
    } catch (error) {
        log(`âŒ Firebaseæ‹‰å–å¤±è´¥: ${error.message}`, 'error');
        throw error;
    }
}
```

#### æ‹‰å–é¢‘ç‡æ§åˆ¶
```javascript
// æ•°æ®æ‹‰å–é¢‘ç‡æ§åˆ¶
const DATA_PULL_INTERVALS = {
    INITIAL: 0,           // åˆå§‹æ‹‰å–ï¼šç«‹å³
    RETRY: 5000,          // é‡è¯•æ‹‰å–ï¼š5ç§’å
    REFRESH: 300000,      // åˆ·æ–°æ‹‰å–ï¼š5åˆ†é’Ÿå
    BACKGROUND: 1800000   // åå°æ‹‰å–ï¼š30åˆ†é’Ÿå
};

// æ™ºèƒ½æ‹‰å–ç­–ç•¥
async function smartDataPull() {
    const lastPullTime = localStorage.getItem('msh_lastPullTime');
    const now = Date.now();
    
    if (!lastPullTime) {
        // é¦–æ¬¡æ‹‰å–
        log('é¦–æ¬¡è®¿é—®ï¼Œç«‹å³ä»Firebaseæ‹‰å–æ•°æ®');
        return await pullFromFirebase();
    }
    
    const timeSinceLastPull = now - parseInt(lastPullTime);
    
    if (timeSinceLastPull > DATA_PULL_INTERVALS.REFRESH) {
        // æ•°æ®è¿‡æœŸï¼Œéœ€è¦åˆ·æ–°
        log('æœ¬åœ°æ•°æ®è¿‡æœŸï¼Œä»Firebaseåˆ·æ–°æ•°æ®');
        return await pullFromFirebase();
    } else {
        // ä½¿ç”¨æœ¬åœ°ç¼“å­˜
        log('ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®');
        return JSON.parse(localStorage.getItem('msh_dataKey') || '[]');
    }
}
```

#### æ‹‰å–æ¬¡æ•°ç»Ÿè®¡
```javascript
// æ‹‰å–æ¬¡æ•°ç»Ÿè®¡å’Œç®¡ç†
const pullStats = {
    totalPulls: 0,
    successfulPulls: 0,
    failedPulls: 0,
    lastPullTime: null,
    pullHistory: []
};

function recordPullAttempt(success, error = null) {
    pullStats.totalPulls++;
    pullStats.lastPullTime = new Date().toISOString();
    
    if (success) {
        pullStats.successfulPulls++;
        pullStats.pullHistory.push({
            timestamp: pullStats.lastPullTime,
            status: 'success',
            source: 'firebase'
        });
    } else {
        pullStats.failedPulls++;
        pullStats.pullHistory.push({
            timestamp: pullStats.lastPullTime,
            status: 'failed',
            error: error?.message || 'unknown',
            source: 'firebase'
        });
    }
    
    // ä¿æŒå†å²è®°å½•ä¸è¶…è¿‡100æ¡
    if (pullStats.pullHistory.length > 100) {
        pullStats.pullHistory = pullStats.pullHistory.slice(-100);
    }
}

// è·å–æ‹‰å–ç»Ÿè®¡ä¿¡æ¯
function getPullStats() {
    return {
        ...pullStats,
        successRate: pullStats.totalPulls > 0 ? 
            (pullStats.successfulPulls / pullStats.totalPulls * 100).toFixed(2) + '%' : '0%'
    };
}
```

#### è‡ªåŠ¨æ‹‰å–æœºåˆ¶
```javascript
// è‡ªåŠ¨æ‹‰å–å®šæ—¶å™¨
let autoPullTimer = null;

function startAutoPull() {
    // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
    if (autoPullTimer) {
        clearInterval(autoPullTimer);
    }
    
    // è®¾ç½®è‡ªåŠ¨æ‹‰å–ï¼ˆæ¯30åˆ†é’Ÿï¼‰
    autoPullTimer = setInterval(async () => {
        try {
            log('ğŸ”„ æ‰§è¡Œè‡ªåŠ¨æ•°æ®æ‹‰å–...');
            await pullFromFirebase();
            recordPullAttempt(true);
        } catch (error) {
            log(`âŒ è‡ªåŠ¨æ‹‰å–å¤±è´¥: ${error.message}`, 'error');
            recordPullAttempt(false, error);
        }
    }, DATA_PULL_INTERVALS.BACKGROUND);
    
    log('âœ… è‡ªåŠ¨æ‹‰å–æœºåˆ¶å·²å¯åŠ¨');
}

function stopAutoPull() {
    if (autoPullTimer) {
        clearInterval(autoPullTimer);
        autoPullTimer = null;
        log('â¹ï¸ è‡ªåŠ¨æ‹‰å–æœºåˆ¶å·²åœæ­¢');
    }
}
```

#### å•ç”¨æˆ·æ“ä½œä¼˜åŒ–
```javascript
// å•ç”¨æˆ·æ“ä½œæ¨¡å¼è¯´æ˜
// åœ¨å•ç”¨æˆ·æ“ä½œæ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š
// 1. é¦–æ¬¡å®Œæ•´æ‹‰å–åï¼Œä¸å†è¿›è¡Œè‡ªåŠ¨æ‹‰å–
// 2. æ‰€æœ‰æ“ä½œåŸºäºæœ¬åœ°æ•°æ®è¿›è¡Œ
// 3. é€šè¿‡ç²¾ç¡®çš„æ•°æ®å˜æ›´æ ‡è®°ç¡®ä¿åŒæ­¥å‡†ç¡®æ€§
// 4. æå‡æ“ä½œæ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ

// æ£€æŸ¥æ˜¯å¦ä¸ºå•ç”¨æˆ·æ¨¡å¼
function isSingleUserMode() {
    // å¯ä»¥é€šè¿‡é…ç½®æˆ–ç¯å¢ƒå˜é‡åˆ¤æ–­
    return window.singleUserMode || true; // é»˜è®¤å•ç”¨æˆ·æ¨¡å¼
}

// å•ç”¨æˆ·æ¨¡å¼ä¸‹çš„æ•°æ®æ“ä½œ
function performSingleUserOperation(operation, dataType, itemId, data) {
    if (!isSingleUserMode()) {
        log('âš ï¸ å½“å‰ä¸æ˜¯å•ç”¨æˆ·æ¨¡å¼ï¼Œè¯·ä½¿ç”¨å¤šç”¨æˆ·åŒæ­¥æœºåˆ¶', 'warning');
        return;
    }
    
    // æ‰§è¡Œå•ç”¨æˆ·ä¼˜åŒ–æ“ä½œ
    switch (operation) {
        case 'add':
            addData(dataType, data);
            break;
        case 'modify':
            modifyData(dataType, itemId, data);
            break;
        case 'delete':
            deleteData(dataType, itemId);
            break;
        default:
            log(`âŒ æœªçŸ¥æ“ä½œç±»å‹: ${operation}`, 'error');
    }
}
```

### 3. æ•°æ®å˜æ›´æ ‡è®°ç³»ç»Ÿ

#### å˜æ›´ç±»å‹å®šä¹‰
```javascript
// æ•°æ®å˜æ›´ç±»å‹
const CHANGE_TYPES = {
    ADDED: 'added',         // æ–°å¢
    MODIFIED: 'modified',   // ä¿®æ”¹
    DELETED: 'deleted'      // åˆ é™¤
};

// æ•°æ®å˜æ›´è®°å½•ç»“æ„
const dataChanges = {
    groups: {
        added: [],      // æ–°å¢çš„å°ç»„
        modified: [],   // ä¿®æ”¹çš„å°ç»„
        deleted: []     // åˆ é™¤çš„å°ç»„
    },
    attendanceRecords: {
        added: [],
        modified: [],
        deleted: []
    },
    groupNames: {
        added: [],
        modified: [],
        deleted: []
    },
    excludedMembers: {
        added: [],
        modified: [],
        deleted: []
    }
};
```

#### æ•°æ®å®šä½æœºåˆ¶
```javascript
// ç”Ÿæˆæ•°æ®å®šä½æ ‡è¯†
function generateDataLocation(dataType, itemId, operation) {
    return {
        type: dataType,           // æ•°æ®ç±»å‹
        id: itemId,              // å”¯ä¸€æ ‡è¯†
        timestamp: Date.now(),   // æ—¶é—´æˆ³
        operation: operation     // æ“ä½œç±»å‹
    };
}

// è®°å½•æ•°æ®å˜æ›´
function recordDataChange(dataType, itemId, operation, data) {
    const location = generateDataLocation(dataType, itemId, operation);
    const changeRecord = {
        location: location,
        data: data,
        timestamp: new Date().toISOString(),
        checksum: generateChecksum(data)  // æ•°æ®æ ¡éªŒå’Œ
    };
    
    dataChanges[dataType][operation].push(changeRecord);
    hasChanges = true;
    showSaveWarning();
    
    log(`ğŸ“ è®°å½•æ•°æ®å˜æ›´: ${dataType}.${operation} - ${itemId}`, 'info');
}

// ç”Ÿæˆæ•°æ®æ ¡éªŒå’Œ
function generateChecksum(data) {
    return btoa(JSON.stringify(data)).slice(0, 16);
}
```

#### å˜æ›´æ£€æµ‹æœºåˆ¶

#### æ•°æ®ä¿®æ”¹æ ‡å‡†æµç¨‹
```javascript
// æ–°å¢æ•°æ®
function addData(dataType, newData) {
    try {
        // 1. ç”Ÿæˆå”¯ä¸€ID
        const itemId = generateUniqueId();
        newData.id = itemId;
        newData.createdAt = new Date().toISOString();
        newData.updatedAt = new Date().toISOString();
        
        // 2. æ·»åŠ åˆ°æœ¬åœ°æ•°æ®
        allData.push(newData);
        
        // 3. è®°å½•å˜æ›´
        recordDataChange(dataType, itemId, CHANGE_TYPES.ADDED, newData);
        
        // 4. æ›´æ–°æ˜¾ç¤º
        updateDisplay();
        updateStats();
        
        log(`âœ… æ•°æ®æ–°å¢æˆåŠŸ: ${dataType} - ${itemId}`, 'success');
    } catch (error) {
        log(`âŒ æ•°æ®æ–°å¢å¤±è´¥: ${error.message}`, 'error');
    }
}

// ä¿®æ”¹æ•°æ®
function modifyData(dataType, itemId, newData) {
    try {
        // 1. æŸ¥æ‰¾å¹¶ä¿®æ”¹åŸå§‹æ•°æ®
        const originalItem = allData.find(item => item.id === itemId);
        if (originalItem) {
            const oldData = { ...originalItem };
            Object.assign(originalItem, newData);
            originalItem.updatedAt = new Date().toISOString();
            
            // 2. è®°å½•å˜æ›´
            recordDataChange(dataType, itemId, CHANGE_TYPES.MODIFIED, {
                old: oldData,
                new: originalItem
            });
        }
        
        // 3. æ›´æ–°æ˜¾ç¤º
        updateDisplay();
        updateStats();
        
        log(`âœ… æ•°æ®ä¿®æ”¹æˆåŠŸ: ${dataType} - ${itemId}`, 'success');
    } catch (error) {
        log(`âŒ æ•°æ®ä¿®æ”¹å¤±è´¥: ${error.message}`, 'error');
    }
}

// åˆ é™¤æ•°æ®
function deleteData(dataType, itemId) {
    try {
        // 1. æŸ¥æ‰¾è¦åˆ é™¤çš„æ•°æ®
        const itemIndex = allData.findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            const deletedItem = allData[itemIndex];
            
            // 2. ä»æœ¬åœ°æ•°æ®ä¸­ç§»é™¤
            allData.splice(itemIndex, 1);
            
            // 3. è®°å½•å˜æ›´
            recordDataChange(dataType, itemId, CHANGE_TYPES.DELETED, deletedItem);
        }
        
        // 4. æ›´æ–°æ˜¾ç¤º
        updateDisplay();
        updateStats();
        
        log(`âœ… æ•°æ®åˆ é™¤æˆåŠŸ: ${dataType} - ${itemId}`, 'success');
    } catch (error) {
        log(`âŒ æ•°æ®åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
    }
}

// ç”Ÿæˆå”¯ä¸€ID
function generateUniqueId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}
```

#### ä¿å­˜è­¦å‘Šæœºåˆ¶
```javascript
// æ˜¾ç¤ºä¿å­˜è­¦å‘Š
function showSaveWarning() {
    const warning = document.getElementById('saveWarning');
    if (warning) {
        warning.style.display = 'block';
    }
}

// éšè—ä¿å­˜è­¦å‘Š
function hideSaveWarning() {
    const warning = document.getElementById('saveWarning');
    if (warning) {
        warning.style.display = 'none';
    }
}
```

### 4. ç›´æ¥FirebaseåŒæ­¥ç­–ç•¥

#### åŒæ­¥åŸåˆ™
1. **ä¸ä½¿ç”¨NewDataManager**: é¿å…è‡ªåŠ¨åŒæ­¥æœºåˆ¶å¹²æ‰°
2. **ç›´æ¥FirebaseåŒæ­¥**: æ‰‹åŠ¨æ§åˆ¶åŒæ­¥æ—¶æœº
3. **æœ¬åœ°å­˜å‚¨å¤‡ä»½**: ç¡®ä¿æ•°æ®å®‰å…¨

#### ç›´æ¥FirebaseåŒæ­¥å®ç°
```javascript
async function saveAllChanges() {
    if (!hasChanges) {
        log('æ²¡æœ‰éœ€è¦ä¿å­˜çš„æ›´æ”¹', 'info');
        return;
    }
    
    try {
        log('å¼€å§‹ç›´æ¥åŒæ­¥æ‰€æœ‰æ›´æ”¹åˆ°Firebase...');
        
        // 1. ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('msh_dataKey', JSON.stringify(allData));
        localStorage.setItem('msh_dataKey_timestamp', Date.now().toString());
        log('âœ… æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
        
        // 2. æ›´æ–°å…¨å±€å˜é‡
        window.dataKey = allData;
        log('âœ… å…¨å±€å˜é‡å·²æ›´æ–°');
        
        // 3. ç›´æ¥FirebaseåŒæ­¥
        if (window.db) {
            try {
                log('ğŸ”„ æ­£åœ¨ç›´æ¥åŒæ­¥åˆ°Firebase...');
                await syncDataToFirebase();
                log('âœ… æ•°æ®å·²ç›´æ¥åŒæ­¥åˆ°Firebase', 'success');
            } catch (firebaseError) {
                log(`âŒ FirebaseåŒæ­¥å¤±è´¥: ${firebaseError.message}`, 'error');
                throw firebaseError;
            }
        } else {
            log('âŒ Firebaseæœªåˆå§‹åŒ–ï¼Œæ— æ³•åŒæ­¥', 'error');
            throw new Error('Firebaseæœªåˆå§‹åŒ–');
        }
        
        // 4. æ¸…é™¤å˜æ›´æ ‡å¿—
        hasChanges = false;
        clearDataChanges();
        hideSaveWarning();
        log('ğŸ‰ æ‰€æœ‰æ›´æ”¹å·²åŒæ­¥å®Œæˆï¼', 'success');
        
    } catch (error) {
        log(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
        // ä¿å­˜å¤±è´¥æ—¶ï¼Œæ•°æ®ä»ç„¶åœ¨æœ¬åœ°å­˜å‚¨ä¸­ï¼Œç”¨æˆ·å¯ä»¥é‡è¯•
    }
}

// ç›´æ¥åŒæ­¥æ•°æ®åˆ°Firebase
async function syncDataToFirebase() {
    const db = firebase.database();
    
    // æ ¹æ®æ•°æ®ç±»å‹è¿›è¡Œä¸åŒçš„åŒæ­¥ç­–ç•¥
    for (const dataType in dataChanges) {
        const changes = dataChanges[dataType];
        
        if (changes.added.length > 0 || changes.modified.length > 0 || changes.deleted.length > 0) {
            log(`ğŸ”„ åŒæ­¥ ${dataType} æ•°æ®å˜æ›´...`);
            
            // å¤„ç†æ–°å¢æ•°æ®
            for (const item of changes.added) {
                await db.ref(`${dataType}/${item.location.id}`).set(item.data);
                log(`âœ… æ–°å¢ ${dataType}: ${item.location.id}`);
            }
            
            // å¤„ç†ä¿®æ”¹æ•°æ®
            for (const item of changes.modified) {
                await db.ref(`${dataType}/${item.location.id}`).update(item.data.new);
                log(`âœ… ä¿®æ”¹ ${dataType}: ${item.location.id}`);
            }
            
            // å¤„ç†åˆ é™¤æ•°æ®
            for (const item of changes.deleted) {
                await db.ref(`${dataType}/${item.location.id}`).remove();
                log(`âœ… åˆ é™¤ ${dataType}: ${item.location.id}`);
            }
        }
    }
}

// æ¸…é™¤æ•°æ®å˜æ›´è®°å½•
function clearDataChanges() {
    for (const dataType in dataChanges) {
        dataChanges[dataType].added = [];
        dataChanges[dataType].modified = [];
        dataChanges[dataType].deleted = [];
    }
    log('ğŸ§¹ æ•°æ®å˜æ›´è®°å½•å·²æ¸…é™¤');
}
```

### 4. ç”¨æˆ·æç¤ºæœºåˆ¶

#### é¡µé¢ç¦»å¼€æé†’
```javascript
// é¡µé¢å¸è½½å‰æé†’ä¿å­˜
window.addEventListener('beforeunload', (e) => {
    if (hasChanges) {
        e.preventDefault();
        e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
    }
});
```

#### å¯¼èˆªç¡®è®¤
```javascript
function navigateToPage(url) {
    if (hasChanges) {
        const confirmLeave = confirm('æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ');
        if (!confirmLeave) {
            return;
        }
    }
    window.location.href = url;
}
```

### 5. é”™è¯¯å¤„ç†å’Œå›é€€

#### é˜²é‡å¤æäº¤æœºåˆ¶
```javascript
function preventDuplicateExecution(operationName) {
    const flagName = `isExecuting_${operationName}`;
    if (window[flagName]) {
        console.log(`${operationName} æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤æ‰§è¡Œ`);
        return false;
    }
    
    window[flagName] = true;
    return true;
}

function clearExecutionFlag(operationName) {
    const flagName = `isExecuting_${operationName}`;
    window[flagName] = false;
}
```

#### å¼‚æ­¥æ“ä½œåŒ…è£…
```javascript
async function safeAsyncOperation(operationName, operation) {
    if (!preventDuplicateExecution(operationName)) {
        return;
    }
    
    try {
        const result = await operation();
        return result;
    } catch (error) {
        log(`${operationName} æ“ä½œå¤±è´¥: ${error.message}`, 'error');
        throw error;
    } finally {
        clearExecutionFlag(operationName);
    }
}
```

## åº”ç”¨åˆ°æ–°é¡µé¢çš„æ­¥éª¤

### 1. å¤åˆ¶åŸºç¡€ç»“æ„
```javascript
// æ•°æ®çŠ¶æ€å˜é‡
let hasChanges = false;
let allData = [];
let filteredData = [];
let dataChanges = {
    // æ ¹æ®å®é™…éœ€è¦å®šä¹‰æ•°æ®ç±»å‹
    attendanceRecords: { added: [], modified: [], deleted: [] },
    groups: { added: [], modified: [], deleted: [] }
};

// åŸºç¡€å‡½æ•°
function loadData() { /* å®ç° */ }
function initializeFirebaseData() { /* å®ç° */ }
function pullFromFirebase() { /* å®ç° */ }
function showSaveWarning() { /* å®ç° */ }
function hideSaveWarning() { /* å®ç° */ }
async function saveAllChanges() { /* å®ç° */ }
```

### 2. æ·»åŠ UIå…ƒç´ 
```html
<!-- ä¿å­˜è­¦å‘Š -->
<div class="warning hidden" id="saveWarning">
    <h4>âš ï¸ é‡è¦æé†’</h4>
    <p>æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼è¯·ç‚¹å‡»"ä¿å­˜æ‰€æœ‰æ›´æ”¹"æŒ‰é’®å°†æ•°æ®åŒæ­¥åˆ°Firebaseã€‚</p>
</div>

<!-- ä¿å­˜æŒ‰é’® -->
<button onclick="saveAllChanges()" class="success-button">ğŸ’¾ ä¿å­˜æ‰€æœ‰æ›´æ”¹</button>
```

### 3. å®ç°æ•°æ®æ“ä½œ
```javascript
// æ‰€æœ‰æ•°æ®ä¿®æ”¹æ“ä½œéƒ½åº”éµå¾ªæ­¤æ¨¡å¼
function modifyData() {
    // 1. ä¿®æ”¹æ•°æ®
    // 2. è®¾ç½® hasChanges = true
    // 3. è°ƒç”¨ showSaveWarning()
    // 4. æ›´æ–°æ˜¾ç¤º
}
```

### 4. æ·»åŠ äº‹ä»¶ç›‘å¬
```javascript
// é¡µé¢åŠ è½½æ—¶
document.addEventListener('DOMContentLoaded', async () => {
    // 1. åˆå§‹åŒ–Firebaseæ•°æ®
    await initializeFirebaseData();
    
    // 2. åŠ è½½æœ¬åœ°æ•°æ®
    loadData();
});

// é¡µé¢ç¦»å¼€æ—¶
window.addEventListener('beforeunload', (e) => {
    // æ£€æŸ¥æœªä¿å­˜æ›´æ”¹
    if (hasChanges) {
        e.preventDefault();
        e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
    }
});
```

## æœ€ä½³å®è·µ

### 1. æ•°æ®ä¸€è‡´æ€§
- å§‹ç»ˆä¿®æ”¹åŸå§‹æ•°æ®ï¼Œç„¶åæ›´æ–°æ˜¾ç¤º
- ä½¿ç”¨æ—¶é—´æˆ³æ ‡è®°æ•°æ®ä¿®æ”¹æ—¶é—´
- ä¿æŒæœ¬åœ°å­˜å‚¨å’Œå…¨å±€å˜é‡åŒæ­¥

### 2. ç”¨æˆ·ä½“éªŒ
- åŠæ—¶æ˜¾ç¤ºä¿å­˜è­¦å‘Š
- æä¾›æ¸…æ™°çš„æ“ä½œåé¦ˆ
- é˜²æ­¢æ„å¤–æ•°æ®ä¸¢å¤±

### 3. é”™è¯¯å¤„ç†
- å®ç°å¤šçº§å›é€€æœºåˆ¶
- è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
- æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

### 4. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨é˜²é‡å¤æäº¤æœºåˆ¶
- æ‰¹é‡å¤„ç†æ•°æ®å˜æ›´
- åˆç†ä½¿ç”¨å¼‚æ­¥æ“ä½œ

## æ³¨æ„äº‹é¡¹

1. **é‡è¦æ–‡ä»¶ä¿æŠ¤**: æ­¤æ–‡æ¡£ä¸ºç³»ç»Ÿæ ¸å¿ƒè§„èŒƒï¼Œåœ¨æ–‡ä»¶æ¸…ç†æ—¶ä¸å¯åˆ é™¤
2. **ç‰ˆæœ¬æ§åˆ¶**: ä»»ä½•ä¿®æ”¹éƒ½åº”æ›´æ–°ç‰ˆæœ¬å·å’Œä¿®æ”¹æ—¥æœŸ
3. **å…¼å®¹æ€§**: æ–°å®ç°åº”å‘åå…¼å®¹ç°æœ‰é¡µé¢
4. **æµ‹è¯•**: æ¯ä¸ªæ–°é¡µé¢éƒ½åº”æµ‹è¯•å®Œæ•´çš„æ•°æ®æµç¨‹

## ç›¸å…³æ–‡ä»¶

- `src/new-data-manager.js` - ç»Ÿä¸€æ•°æ®ç®¡ç†å™¨
- `src/utils.js` - å·¥å…·å‡½æ•°
- `config.js` - Firebaseé…ç½®
- å„é¡µé¢çš„å…·ä½“å®ç°æ–‡ä»¶

---

**æ–‡æ¡£çŠ¶æ€**: æ´»è·ƒä½¿ç”¨ä¸­  
**æœ€åæ›´æ–°**: 2025-01-18 (v2.1 - ç§»é™¤NewDataManagerä¾èµ–ï¼Œå®ç°ç›´æ¥FirebaseåŒæ­¥æœºåˆ¶)  
**ç»´æŠ¤è€…**: MSHç³»ç»Ÿå¼€å‘å›¢é˜Ÿ
