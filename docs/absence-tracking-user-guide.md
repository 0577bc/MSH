# 缺勤跟踪系统使用说明

**创建日期**: 2025-11-07  
**系统版本**: MSH签到系统 v3.0 (简化版)  
**计算起始日期**: 2025-09-01

---

## 系统组成

### 1. 缺勤计算工具
**路径**: `tools/msh-system/absence-calculator.html`  
**功能**: 批量计算历史缺勤数据

### 2. 主日跟踪页面
**路径**: `absence-tracking.html`  
**功能**: 查看缺勤事件，增量计算最新一周

---

## Firebase数据结构

### absenceCalc/{sundayDate}/{memberUUID}
存储每周的缺勤计算结果
```javascript
{
  count: 2,           // 缺勤标记（连续缺勤次数）
  name: "姓名",
  group: "group0",
  date: "2025-08-10"
}
```

### absenceEvents/{eventId}
存储缺勤事件（标记>=2时生成）
```javascript
{
  memberUUID: "uuid",
  memberName: "姓名",
  group: "group0",
  startDate: "2025-08-03",  // 开始缺勤日期
  endDate: "2025-08-10",    // 最后缺勤日期
  count: 2,                 // 缺勤次数
  weeks: ["2025-08-03", "2025-08-10"],
  status: "active",
  createdAt: "2025-11-07T10:00:00.000Z"
}
```

---

## 使用流程

### 首次使用

1. 访问 `tools/msh-system/absence-calculator.html`
2. 点击"开始计算（9月至今）"
3. 等待计算完成（会显示进度）
4. 计算完成后，访问 `absence-tracking.html` 查看结果

### 日常使用

1. 访问 `absence-tracking.html`
2. 查看当前活跃的缺勤事件
3. 点击"计算最新一周"按钮更新数据
4. 可使用小组筛选功能查看特定小组

---

## 计算逻辑

### 标记规则
- **标记0**: 有签到
- **标记1**: 首次缺勤
- **标记2**: 连续2周缺勤 → **生成事件**
- **标记3+**: 连续缺勤 → **更新事件**

### 计算步骤

#### 第1周（例如：9月1周）
1. 获取该周主日签到数据
2. 对比所有成员（排除排除人员）
3. 缺勤的标记1，保存到Firebase

#### 第2周（例如：9月2周）
1. 获取该周主日签到数据
2. 对比所有成员
3. 获取上周（9月1周）的计算结果
4. 处理逻辑：
   - 上周标记1 + 本周有签到 → 清除标记
   - 上周无标记 + 本周缺勤 → 标记1
   - 上周标记1 + 本周缺勤 → 标记2，**生成事件**
5. 保存计算结果和事件到Firebase

#### 第3周及以后
1. 获取该周主日签到数据
2. 获取上周的计算结果
3. 处理逻辑：
   - 上周标记N + 本周有签到 → 清除标记
   - 上周无标记 + 本周缺勤 → 标记1
   - 上周标记1 + 本周缺勤 → 标记2，**生成事件**
   - 上周标记2+ + 本周缺勤 → 标记+1，**更新事件**
4. 保存结果

---

## 注意事项

### 数据安全
- 计算结果使用 `set()` 方法（覆盖整周数据，清除已签到成员的标记）
- 事件更新使用 `update()` 方法（增量更新，不覆盖其他事件）

**重要说明**：
- `absenceCalc` 必须使用 `set()` 覆盖，否则已签到成员的标记无法清除
- 例如：成员A在第1周缺勤（标记1），第2周签到，必须清除标记，否则第3周会错误地累加为标记2

### 计算规则
- 只计算主日（周日）的签到数据
- 排除标记为 `excluded: true` 的成员
- 使用成员的 `uuid` 或 `name` 作为唯一标识

### 性能优化
- 批量计算时每周之间有200ms延迟，避免Firebase压力过大
- 增量计算只处理最新一周数据

---

## 常见问题

**Q: 如何重新计算某一周的数据？**  
A: 目前需要从该周开始重新运行计算工具。

**Q: 如果成员中途有签到，事件会怎样？**  
A: 事件不会自动删除，但缺勤标记会清除。

**Q: 事件的开始日期如何确定？**  
A: 开始日期是连续缺勤的第一个主日。

---

## 技术细节

### 配置加载
使用 `window.firebaseConfig`（由 `smart-config-loader.js` 加载）

### Firebase路径
- `absenceCalc/{sundayDate}` - 计算结果
- `absenceEvents` - 事件列表

### 主日识别
```javascript
// 检查日期是否为周日
date.getDay() === 0
```

---

**文档版本**: 1.0  
**最后更新**: 2025-11-07

