# MSH表单系统 - 部署执行计划

## 🚨 当前状态分析

### 连接测试结果
- ✅ **网络连通性**: 正常 (延迟11-12ms)
- ✅ **SSH端口**: 开放 (端口22可访问)
- ❌ **SSH认证**: 失败 (Permission denied)

### 问题诊断
1. **SSH配置问题**: 服务器可能禁用了密码认证
2. **安全组规则**: 可能只允许密钥认证
3. **密码错误**: 密码可能不正确
4. **用户权限**: root用户可能被禁用

---

## 🛠️ 修复方案

### 方案A：通过阿里云控制台修复 (推荐)
**优势**: 无需SSH连接，直接通过Web界面操作
**步骤**:
1. 登录阿里云控制台
2. 进入ECS实例详情页
3. 点击"远程连接" -> "VNC连接"
4. 通过VNC连接ECS实例
5. 检查SSH配置并修复

### 方案B：重置SSH配置
**步骤**:
1. 通过阿里云控制台连接ECS
2. 检查SSH配置文件: `/etc/ssh/sshd_config`
3. 确保以下配置正确:
   ```bash
   PasswordAuthentication yes
   PubkeyAuthentication yes
   PermitRootLogin yes
   ```
4. 重启SSH服务: `sudo systemctl restart sshd`

### 方案C：重置root密码
**步骤**:
1. 通过阿里云控制台重置root密码
2. 重启ECS实例
3. 使用新密码测试SSH连接

---

## 🚀 部署执行计划

### 阶段1：修复SSH连接 (预计10分钟)
1. **通过阿里云控制台连接ECS**
2. **检查SSH配置**
3. **修复SSH配置问题**
4. **测试SSH连接**

### 阶段2：执行自动化部署 (预计30分钟)
1. **上传部署脚本到ECS**
2. **执行自动化部署脚本**
3. **验证部署结果**
4. **测试应用功能**

### 阶段3：验证部署结果 (预计10分钟)
1. **检查应用状态**
2. **测试API接口**
3. **验证数据库连接**
4. **生成部署报告**

---

## 📋 详细执行步骤

### 步骤1：修复SSH连接
```bash
# 1. 登录阿里云控制台
# 2. 进入ECS实例详情页
# 3. 点击"远程连接" -> "VNC连接"
# 4. 通过VNC连接ECS实例

# 5. 检查SSH配置
sudo nano /etc/ssh/sshd_config

# 6. 确保以下配置正确
PasswordAuthentication yes
PubkeyAuthentication yes
PermitRootLogin yes

# 7. 重启SSH服务
sudo systemctl restart sshd

# 8. 测试SSH连接
ssh root@112.124.97.58
```

### 步骤2：执行自动化部署
```bash
# 1. 上传部署脚本
scp docs/technical/AUTO_DEPLOYMENT_SCRIPT.md root@112.124.97.58:/tmp/auto-deploy.sh

# 2. SSH连接到ECS
ssh root@112.124.97.58

# 3. 设置执行权限
chmod +x /tmp/auto-deploy.sh

# 4. 执行部署脚本
/tmp/auto-deploy.sh
```

### 步骤3：验证部署结果
```bash
# 1. 检查PM2状态
pm2 status

# 2. 测试健康检查接口
curl http://localhost:3000/health

# 3. 检查应用日志
pm2 logs msh-form-system

# 4. 验证数据库连接
node test-db.js
```

---

## 🎯 备用执行方案

### 方案A：完全通过阿里云控制台
**优势**: 无需SSH连接，直接通过Web界面操作
**步骤**:
1. 通过VNC连接ECS实例
2. 在ECS实例上直接执行部署命令
3. 通过Web界面监控部署进度

### 方案B：使用阿里云CLI工具
**优势**: 自动化程度高，无需手动操作
**步骤**:
1. 安装阿里云CLI工具
2. 配置访问密钥
3. 使用CLI工具执行部署

### 方案C：使用Docker容器
**优势**: 环境隔离，部署简单
**步骤**:
1. 创建Docker镜像
2. 通过阿里云控制台部署容器
3. 配置容器网络和存储

---

## 📊 执行时间估算

### 修复SSH连接
- **检查配置**: 2分钟
- **修复配置**: 3分钟
- **重启服务**: 1分钟
- **测试连接**: 2分钟
- **总计**: 8分钟

### 执行自动化部署
- **上传脚本**: 2分钟
- **执行脚本**: 25分钟
- **验证结果**: 3分钟
- **总计**: 30分钟

### 验证部署结果
- **检查状态**: 2分钟
- **测试接口**: 3分钟
- **生成报告**: 2分钟
- **总计**: 7分钟

**总预计时间**: 45分钟

---

## 🚨 风险控制

### 风险识别
1. **SSH连接失败**: 无法远程操作
2. **部署脚本错误**: 部署失败
3. **数据库连接失败**: 应用无法启动
4. **网络问题**: 无法访问外部资源

### 风险缓解
1. **备用连接方式**: 阿里云控制台VNC连接
2. **脚本测试**: 本地测试脚本功能
3. **数据库验证**: 提前测试数据库连接
4. **网络检查**: 验证网络连通性

### 应急方案
1. **回滚机制**: 保留原始配置
2. **备份策略**: 定期备份重要数据
3. **监控告警**: 实时监控部署状态
4. **技术支持**: 联系阿里云技术支持

---

## 🎯 立即执行

### 第一步：修复SSH连接
1. **通过阿里云控制台连接ECS**
2. **检查SSH配置**
3. **修复SSH配置问题**
4. **测试SSH连接**

### 第二步：执行自动化部署
1. **上传部署脚本**
2. **SSH连接到ECS**
3. **执行部署脚本**
4. **监控部署进度**

### 第三步：验证部署结果
1. **检查应用状态**
2. **测试API接口**
3. **验证数据库连接**
4. **生成部署报告**

---

**总结**: 🎯 **部署执行计划已制定！** 当前SSH连接存在问题，需要先修复SSH配置，然后执行自动化部署。预计总时间45分钟，包含修复、部署和验证三个阶段。建议通过阿里云控制台VNC连接进行修复。
