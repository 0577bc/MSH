# 规则：Progress Recorder Agent 触发条件

> 最后更新：2025-10-08  
> 版本：v2.0 - 完整版  
> 文档类型：完整触发规则（所有场景）

## 📋 文档说明

本文档是完整版触发规则，包含所有场景（P0/P1/P2级 + 特殊场景）。

**推荐使用：**
- **日常开发** → 优先使用 [`cloud-essential.md`](./cloud-essential.md)（精简版，P0/P1核心规则）
- **特殊场景** → 查阅本文档（完整版，包含所有触发条件）

---

## 🚨 **最高级别强制触发规则（2025-10-08更新）**

**优先级：** 🔴 **P0 - 最高级别**  
**来源：** 重大数据覆盖事故教训 + 时间管理规则反复被忽略

### 🔴 时间管理强制触发（P0级 - 2025-10-08新增）⏰⏰⏰

**触发时机：任何涉及时间的操作前，必须强制触发**

当检测到以下操作时，**必须立即暂停并执行时间检查**：

1. **文件写入操作**
   - `write()` 工具调用 → ⏰ **强制时间检查**
   - `search_replace()` 工具调用 → ⏰ **强制时间检查**
   - `edit_notebook()` 工具调用 → ⏰ **强制时间检查**
   
   **强制执行步骤：**
   ```
   1. 暂停当前操作
   2. 运行 date +%Y-%m-%d 获取当前系统时间
   3. 在响应中显示：
      🕐 时间检查：当前系统时间 YYYY-MM-DD
   4. 确认使用的是刚获取的时间
   5. 继续执行操作
   ```

2. **包含日期的对话**
   - 对话包含"最后更新" → ⏰ **必须获取当前时间**
   - 对话包含"完成日期" → ⏰ **必须获取当前时间**
   - 对话包含"创建日期" → ⏰ **必须获取当前时间**
   - 对话包含"记录时间" → ⏰ **必须获取当前时间**
   - 对话包含"今天" → ⏰ **必须获取当前时间**
   - 对话包含"当前日期" → ⏰ **必须获取当前时间**

3. **文档更新操作**
   - 更新 progress.md → ⏰ **强制时间检查**
   - 更新任何带时间戳的文档 → ⏰ **强制时间检查**
   - 创建新文档 → ⏰ **强制时间检查**
   - 生成报告 → ⏰ **强制时间检查**

**强制响应模板：**
```
🕐 时间检查 - 强制执行

正在执行涉及时间的操作，必须先获取当前系统时间...

$ date +%Y-%m-%d
[显示获取的当前时间]

✓ 时间检查完成
✓ 使用时间：[刚获取的时间]
✓ 格式验证：YYYY-MM-DD

现在继续执行操作...
```

**禁止行为：**
- ❌ 使用对话历史中的日期
- ❌ 使用推测的日期
- ❌ 使用记忆中的日期
- ❌ 跳过时间检查步骤

**违规处理：**
1. 立即停止操作
2. 修正错误的时间
3. 记录违规事件
4. 重新执行时间检查

### 数据安全强制触发（立即警告）⚠️⚠️⚠️

当检测到以下代码或对话时，**必须立即中断并警告用户**：

1. **代码包含数据覆盖操作**
   - `.ref('attendanceRecords').set(` → 🚨 **立即警告**
   - `.ref().set(allRecords)` → 🚨 **立即警告**
   - `.ref().set(window.attendanceRecords)` → 🚨 **立即警告**
   
   **响应：**
   ```
   🚨 严重警告：检测到数据覆盖操作！
   
   该操作会完全替换Firebase中的所有数据！
   
   必须检查：
   1. 本地数据是否完整？
   2. 是否会丢失历史数据？
   3. 是否有数据备份？
   4. 用户是否已多次确认？
   
   如无法确认，立即停止操作！
   ```

2. **对话包含危险关键词**
   - "覆盖Firebase" → 🚨 **多次确认**
   - "清空数据" → 🚨 **多次确认**
   - "重置数据" → 🚨 **多次确认**
   - "全量同步" → ⚠️ **需要确认**

---

### 🔴 文档管理强制触发（P0级 - 2025-10-08新增）📝📝📝

**触发时机：任何可能创建新文档的操作前，必须强制检查**

当检测到以下操作时，**必须立即检查是否有用户明确许可**：

1. **工具调用检测**
   - `write()` 工具 + `.md` 文件 → 📝 **检查是否新建文档**
   - 文件路径不存在 + `.md` 扩展名 → 📝 **强制检查许可**
   
   **强制执行步骤：**
   ```
   1. 检查文件是否已存在
   2. 如果是新文件，检查用户是否明确请求
   3. 用户话语是否包含"创建"、"生成"、"写一个"等明确指令
   4. 如果没有明确请求 → 禁止创建，询问用户
   5. 如果有明确请求 → 可以创建
   ```

2. **用户话语检测**
   
   **✅ 允许创建的明确请求：**
   - "创建XXX文档" → ✅ **可以创建**
   - "生成XXX.md" → ✅ **可以创建**
   - "写一个XXX报告" → ✅ **可以创建**
   - "帮我创建XXX" → ✅ **可以创建**
   
   **❌ 不算明确请求：**
   - "帮我整理XXX" → ❌ **不能主动创建文档**
   - "分析一下XXX" → ❌ **不能主动创建文档**
   - "修复XXX问题" → ❌ **不能主动创建文档**
   - "完成XXX任务" → ❌ **不能主动创建文档**

3. **正确响应模板**

   **场景1：需要创建文档但无明确请求**
   ```
   ✅ 操作已完成！
   
   我可以创建一个 [文档名称].md 来详细记录 [内容描述] 吗？
   或者我可以将信息更新到现有的 progress.md 中。
   
   你希望我怎么做？
   ```
   
   **场景2：有明确请求，直接创建**
   ```
   ✅ 正在创建 [文档名称].md...
   
   文档已创建完成！
   ```

**禁止行为：**
- ❌ 主动创建日志文档（即使认为有用）
- ❌ 主动创建报告文档（即使认为有用）
- ❌ "善意"创建文档（即使是为了帮助用户）
- ❌ 跳过用户明确许可步骤

**违规处理：**
1. 发现违规后立即停止
2. 询问用户如何处理（删除/保留/合并）
3. 记录违规事件到 progress.md
4. 强化预防机制

---
   - "批量删除" → ⚠️ **需要确认**

3. **业务页面使用全量操作**
   - 业务页面 + set() → 🚨 **禁止**
   - 业务页面 + 全量加载 → ⚠️ **检查目的**

### 强制执行流程

```
检测到危险操作
    ↓
暂停代码生成
    ↓
显示警告信息
    ↓
询问用户确认
    ↓
用户明确确认？
    ├─ 否 → 取消操作
    └─ 是 → 添加保护机制后执行
```

---

## 增强触发条件

当对话中出现以下情况时，必须唤醒 Progress Recorder Agent：

1. **用户明确要求**：记录、总结、归档、回顾操作（如 /srecap, /sarchive 等）
2. **高级意图识别**：识别具体触发场景和上下文
3. **重要决策**：主 Agent 做出关键性决策、架构选择或明确项目约束
4. **风险识别**：讨论中涉及风险、假设或重要待办事项
5. **🚨 数据安全**：任何可能导致数据丢失的操作（最高优先级）

## 高级触发场景

### 决策场景
- "我们决定使用React因为..." → 触发[DECISION]
- "选择这个方案的原因是..." → 触发[DECISION]
- "最终决定采用..." → 触发[DECISION]

### 待办场景
- "这个TODO很重要" → 触发[TODO] [HIGH]
- "需要完成的任务" → 触发[TODO]
- "下一步要做的是..." → 触发[TODO]

### 风险场景
- "存在安全风险" → 触发[RISK] [HIGH]
- "可能的问题" → 触发[RISK]
- "需要注意的" → 触发[RISK]

### 学习场景
- "学到了..." → 触发[LEARNED]
- "经验是..." → 触发[LEARNED]
- "教训是..." → 触发[LEARNED]
- "解决了bug..." → 触发[LEARNED]
- "问题原因是..." → 触发[LEARNED]

### Bug解决场景
- "解决了用户认证的bug" → 触发[LEARNED]
- "问题原因是JWT配置错误" → 触发[LEARNED]
- "修复了登录问题" → 触发[LEARNED]

### 代码片段场景
- "代码片段..." → 触发[CODE]
- "实现逻辑是..." → 触发[CODE]
- "关键代码..." → 触发[CODE]
- "核心算法..." → 触发[CODE]

### 修复场景
- "修复了..." → 触发[FIX]
- "解决了bug..." → 触发[FIX]
- "问题修复完成" → 触发[FIX]
- "修复结果..." → 触发[FIX]
- "技术改进..." → 触发[FIX]

### 文档生成规则
- "修复确认前不生成文档" → 触发[RULE]
- "用户确认后才更新修复文档" → 触发[RULE]
- "避免擅自创建报告" → 触发[RULE]

### 文件组织规则
- "功能模块化管理" → 触发[RULE]
- "相关文件统一到专门目录" → 触发[RULE]
- "创建索引页面" → 触发[RULE]
- "更新引用路径" → 触发[RULE]
- "避免根目录文件混乱" → 触发[RULE]
- "整合文档到统一目录" → 触发[RULE]
- "建立文档索引" → 触发[RULE]

### 优化场景
- "性能优化" → 触发[OPTIMIZATION]
- "代码优化" → 触发[OPTIMIZATION]
- "数据加载优化" → 触发[OPTIMIZATION]
- "减少数据传输" → 触发[OPTIMIZATION]
- "简化代码" → 触发[OPTIMIZATION]
- "增量同步" → 触发[OPTIMIZATION]
- "数据完整性验证" → 触发[OPTIMIZATION]
- "优化完成" → 触发[OPTIMIZATION] [COMPLETED]

### 数据加载优化场景（V2.0新增）
- "页面加载慢" → 触发[DATA_LOADING] 检查是否全量加载
- "数据加载慢" → 触发[DATA_LOADING] 建议按需加载
- "summary加载数据" → 触发[DATA_LOADING] 提醒只加载基础数据
- "按日期加载" → 触发[DATA_LOADING] 推荐Firebase查询策略
- "签到记录全量加载" → 触发[DATA_LOADING] 建议按日期分片
- "SessionStorage缓存" → 触发[DATA_LOADING] 参考缓存策略
- "优化加载速度" → 触发[DATA_LOADING] 参考V2.0方案
- "工具页面" → 触发[TOOLS_PAGE] 提醒工具页面需要全量数据
- "uuid编辑器" → 触发[TOOLS_PAGE] 使用全量加载策略
- **响应策略**：
  1. 先判断是业务页面还是工具页面
  2. 业务页面：检查是否按需加载
  3. 工具页面：确认是否需要全量数据
  4. 建议使用按日期查询（业务页面）
  5. 推荐SessionStorage缓存（业务页面）
  6. 参考文档：OPTIMIZED_DATA_LOADING_STRATEGY_V2.md、TOOLS_VS_BUSINESS_PAGES.md

### 开发场景触发规则
- "建立新功能" → 触发[DEV]
- "建立新页面" → 触发[DEV]
- "建立页面" → 触发[DEV]
- "实现API调用" → 触发[DEV]
- "使用fetch" → 触发[DEV]
- "调用外部API" → 触发[DEV]
- "集成外部服务" → 触发[DEV]
- "建立表单功能" → 触发[DEV]
- "建立表单" → 触发[DEV]
- "实现数据提交" → 触发[DEV]
- "创建页面" → 触发[DEV]
- "开发新功能" → 触发[DEV]
- "开发表单功能" → 触发[DEV]

### 开发检查清单触发
- "建立页面前检查" → 触发[CHECKLIST]
- "建立表单前检查" → 触发[CHECKLIST]
- "API调用前检查" → 触发[CHECKLIST]
- "fetch请求前检查" → 触发[CHECKLIST]
- "外部服务集成前检查" → 触发[CHECKLIST]
- "表单提交前检查" → 触发[CHECKLIST]
- "数据请求前检查" → 触发[CHECKLIST]

### 外部表单架构触发
- "外部表单数据处理" → 触发[ARCHITECTURE]
- "阿里云平台处理" → 触发[ARCHITECTURE]
- "表单数据存储" → 触发[ARCHITECTURE]
- "API服务调用" → 触发[ARCHITECTURE]
- "数据流向" → 触发[ARCHITECTURE]

### 外部表单安全原则触发 ⚠️ 原则性问题
- "外部表单数据同步" → 触发[RULE]
- "Firebase数据拉取" → 触发[RULE]
- "自动数据获取" → 触发[RULE]
- "数据安全隔离" → 触发[RULE]
- "系统隔离" → 触发[RULE]
- "手动同步" → 触发[RULE]
- "国内使用限制" → 触发[RULE]
- "外部系统自动拉取" → 触发[RULE]
- "Firebase信息获取" → 触发[RULE]

### 时间管理规则触发 ⚠️ 原则性问题
- "记录时间" → 触发[RULE]
- "文档时间" → 触发[RULE]
- "时间格式" → 触发[RULE]
- "当前日期" → 触发[RULE]
- "时间准确性" → 触发[RULE]
- "时间验证" → 触发[RULE]
- "时间一致性" → 触发[RULE]
- "时间错误" → 触发[RULE]
- "未来日期" → 触发[RULE]
- "系统时间" → 触发[RULE]
- "date命令" → 触发[RULE]
- "YYYY-MM-DD" → 触发[RULE]
- "时间获取" → 触发[RULE]
- "时间修正" → 触发[RULE]
- "时间检查" → 触发[RULE]
- "时间标准化" → 触发[RULE]

## 自动标记建议机制

### 智能推荐规则
- **检测"风险"关键词**：推荐[RISK]标记，用户确认
- **检测"代码"关键词**：推荐[CODE]标记，用户确认
- **检测"决策"关键词**：推荐[DECISION]标记，用户确认
- **检测"学习"关键词**：推荐[LEARNED]标记，用户确认

### 建议格式
```markdown
🤖 自动标记建议：
- 检测到"风险"关键词
- 推荐标记：[RISK]
- 推荐优先级：[HIGH]
- 确认？(y/n/edit)
```

## 强制记忆机制

### 强制记录规则
- **/force记 "内容"**：无阈值直接写入
- **紧急记录**：用于重要信息立即保存
- **绕过触发**：不依赖关键词检测
- **直接写入**：立即保存到progress.md

### 使用场景
- 重要会议记录
- 紧急问题解决
- 关键决策保存
- 临时想法记录

## 建议预览机制

### 预览流程
1. **检测触发**：识别到重要内容
2. **生成建议**：分析内容类型和优先级
3. **输出预览**：显示"推荐[TODO] [HIGH]，确认？"
4. **用户确认**：等待用户确认或修正
5. **记录内容**：确认后写入progress.md

### 预览格式
```markdown
🤖 建议记录：
- 类型：[TODO]
- 优先级：[HIGH]
- 内容：实现用户认证功能
- 确认？(y/n/edit)
```

## 触发过滤规则

### 增强过滤机制
- **关键词阈值**：关键词出现2次以上才触发
- **上下文判断**：结合对话意图，忽略无关内容
- **场景识别**：识别具体触发场景，提高准确性
- **重复内容过滤**：避免记录重复信息

### 语义判断标准
- **实质性内容**：包含具体技术决策或项目信息
- **上下文相关**：与当前项目或任务相关
- **重要性评估**：对项目进展有实际影响
- **场景匹配**：符合预定义的触发场景

## 触发方式

### 自动触发
- **智能检测**：使用增强正则匹配检测关键词
- **场景分析**：识别具体触发场景和上下文
- **建议预览**：输出建议等待用户确认
- **直接写入**：确认后写入progress.md

### 手动触发
- **/srecap**：查看项目状态，生成总结
- **/sarchive**：归档已完成内容到 archive.md
- **/sstatus**：查看当前进度
- **/sverify**：审阅最近5条记录，确认准确性
- **/sfeedback**：记录用户满意度，优化系统配合度
- **/slearn**：查看用户偏好学习记录
- **/saudit**：扫描progress.md中的潜在敏感信息
- **/ssecure**：检查安全配置状态
- **/smonitor**：查看系统状态和性能指标
- **/sstats**：查看使用统计和趋势
- **/shealth**：执行健康检查和诊断
- **/force记**：强制记录重要信息
- **/sclear**：删除指定记录（支持--tag、--date、--all参数）

## 记录规则

### 标准化标记系统
- `[TODO]` - 待办事项
- `[DONE]` - 已完成
- `[DECISION]` - 重要决策
- `[RISK]` - 风险点
- `[CONSTRAINT]` - 约束条件
- `[LEARNED]` - 学到的知识
- `[IDEA]` - 新想法
- `[CODE]` - 代码片段
- `[FIX]` - 修复记录
- `[RULE]` - 规则记录
- `[DEV]` - 开发场景
- `[CHECKLIST]` - 检查清单
- `[ARCHITECTURE]` - 架构规则

### 优先级标记（可选）
- `[HIGH]` - 高优先级
- `[MEDIUM]` - 中优先级（默认）
- `[LOW]` - 低优先级

### 格式验证
- **自动补充**：缺失优先级时自动添加`[MEDIUM]`
- **日期更新**：自动使用当前日期
- **格式检查**：确保标记格式正确

## 自动化归档

### 归档触发条件
- **文件大小**：progress.md超过500行
- **完成数量**：DONE项超过10个
- **时间间隔**：建议每月或每阶段一次
- **手动触发**：用户执行 /sarchive 命令
- **自动执行**：auto_archive=true时强制归档（默认开启）

### 归档流程
1. 从 progress.md 中提取已完成内容
2. 移动到 archive.md
3. 生成归档总结
4. 更新 progress.md 时间戳
5. 自动提交到 Git
6. 发送归档确认通知
7. 记录到通知历史

### 压缩机制

#### 明确压缩规则
- **按日总结**：每日归档时生成"日总结：X个DONE，包括项目1、项目2"
- **按话题总结**：相关项目归类总结
- **按周总结**：每周生成"周报：X个DONE，包括架构设计等"

#### 压缩算法
- **日总结**：当日完成项目 + 重要决策 + 解决风险
- **话题总结**：按项目类型归类（前端、后端、测试等）
- **周总结**：本周完成项目 + 重要决策 + 解决风险 + 代码贡献

## 输出格式

### 记录格式
```markdown
- [类型] [优先级] 内容描述 [日期]
```

### 归档格式
```markdown
## [日期] 归档内容
- [类型] 内容描述
```

### 通知格式
```markdown
✅ 已记录：[类型] 内容描述
📊 当前进度：TODO: X个, DONE: Y个
⚠️ 建议归档：文件已超过500行
🔒 安全提醒：检测到潜在敏感信息
📊 归档总结：已归档5个DONE：架构设计、基础功能等
🤖 自动标记建议：检测到"风险"关键词，推荐[RISK]标记
⚡ 强制记忆：使用/force记记录紧急信息
```

## 配置参数

- **归档阈值**：500行或10个DONE项
- **自动归档**：auto_archive=true（默认开启）
- **通知记录**：auto_notify=true（默认开启）
- **Git集成**：auto_commit=true（默认开启）
- **备份策略**：Git自动提交
- **搜索范围**：当前项目
- **文件限制**：progress.md建议 < 1000行
- **触发冷却**：5分钟内最多触发3次
- **通知历史**：保留最近50条
- **压缩机制**：自动总结归档内容
- **自动标记**：auto_suggest=true（默认开启）
- **强制记忆**：force_memory=true（默认开启）
- **全局搜索**：global_search=true（默认开启）
- **忘记权**：forget_right=true（默认开启）
