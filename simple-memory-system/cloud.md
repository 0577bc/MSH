# 规则：Progress Recorder Agent 触发条件

## 增强触发条件

当对话中出现以下情况时，必须唤醒 Progress Recorder Agent：

1. **用户明确要求**：记录、总结、归档、回顾操作（如 /srecap, /sarchive 等）
2. **高级意图识别**：识别具体触发场景和上下文
3. **重要决策**：主 Agent 做出关键性决策、架构选择或明确项目约束
4. **风险识别**：讨论中涉及风险、假设或重要待办事项

## 高级触发场景

### 决策场景
- "我们决定使用React因为..." → 触发[DECISION]
- "选择这个方案的原因是..." → 触发[DECISION]
- "最终决定采用..." → 触发[DECISION]

### 待办场景
- "这个TODO很重要" → 触发[TODO] [HIGH]
- "需要完成的任务" → 触发[TODO]
- "下一步要做的是..." → 触发[TODO]

### 风险场景
- "存在安全风险" → 触发[RISK] [HIGH]
- "可能的问题" → 触发[RISK]
- "需要注意的" → 触发[RISK]

### 学习场景
- "学到了..." → 触发[LEARNED]
- "经验是..." → 触发[LEARNED]
- "教训是..." → 触发[LEARNED]
- "解决了bug..." → 触发[LEARNED]
- "问题原因是..." → 触发[LEARNED]

### Bug解决场景
- "解决了用户认证的bug" → 触发[LEARNED]
- "问题原因是JWT配置错误" → 触发[LEARNED]
- "修复了登录问题" → 触发[LEARNED]

### 代码片段场景
- "代码片段..." → 触发[CODE]
- "实现逻辑是..." → 触发[CODE]
- "关键代码..." → 触发[CODE]
- "核心算法..." → 触发[CODE]

## 自动标记建议机制

### 智能推荐规则
- **检测"风险"关键词**：推荐[RISK]标记，用户确认
- **检测"代码"关键词**：推荐[CODE]标记，用户确认
- **检测"决策"关键词**：推荐[DECISION]标记，用户确认
- **检测"学习"关键词**：推荐[LEARNED]标记，用户确认

### 建议格式
```markdown
🤖 自动标记建议：
- 检测到"风险"关键词
- 推荐标记：[RISK]
- 推荐优先级：[HIGH]
- 确认？(y/n/edit)
```

## 强制记忆机制

### 强制记录规则
- **/force记 "内容"**：无阈值直接写入
- **紧急记录**：用于重要信息立即保存
- **绕过触发**：不依赖关键词检测
- **直接写入**：立即保存到progress.md

### 使用场景
- 重要会议记录
- 紧急问题解决
- 关键决策保存
- 临时想法记录

## 建议预览机制

### 预览流程
1. **检测触发**：识别到重要内容
2. **生成建议**：分析内容类型和优先级
3. **输出预览**：显示"推荐[TODO] [HIGH]，确认？"
4. **用户确认**：等待用户确认或修正
5. **记录内容**：确认后写入progress.md

### 预览格式
```markdown
🤖 建议记录：
- 类型：[TODO]
- 优先级：[HIGH]
- 内容：实现用户认证功能
- 确认？(y/n/edit)
```

## 触发过滤规则

### 增强过滤机制
- **关键词阈值**：关键词出现2次以上才触发
- **上下文判断**：结合对话意图，忽略无关内容
- **场景识别**：识别具体触发场景，提高准确性
- **重复内容过滤**：避免记录重复信息

### 语义判断标准
- **实质性内容**：包含具体技术决策或项目信息
- **上下文相关**：与当前项目或任务相关
- **重要性评估**：对项目进展有实际影响
- **场景匹配**：符合预定义的触发场景

## 触发方式

### 自动触发
- **智能检测**：使用增强正则匹配检测关键词
- **场景分析**：识别具体触发场景和上下文
- **建议预览**：输出建议等待用户确认
- **直接写入**：确认后写入progress.md

### 手动触发
- **/srecap**：查看项目状态，生成总结
- **/sarchive**：归档已完成内容到 archive.md
- **/sstatus**：查看当前进度
- **/sverify**：审阅最近5条记录，确认准确性
- **/sfeedback**：记录用户满意度，优化系统配合度
- **/slearn**：查看用户偏好学习记录
- **/saudit**：扫描progress.md中的潜在敏感信息
- **/ssecure**：检查安全配置状态
- **/smonitor**：查看系统状态和性能指标
- **/sstats**：查看使用统计和趋势
- **/shealth**：执行健康检查和诊断
- **/force记**：强制记录重要信息
- **/sclear**：删除指定记录（支持--tag、--date、--all参数）

## 记录规则

### 标准化标记系统
- `[TODO]` - 待办事项
- `[DONE]` - 已完成
- `[DECISION]` - 重要决策
- `[RISK]` - 风险点
- `[CONSTRAINT]` - 约束条件
- `[LEARNED]` - 学到的知识
- `[IDEA]` - 新想法
- `[CODE]` - 代码片段

### 优先级标记（可选）
- `[HIGH]` - 高优先级
- `[MEDIUM]` - 中优先级（默认）
- `[LOW]` - 低优先级

### 格式验证
- **自动补充**：缺失优先级时自动添加`[MEDIUM]`
- **日期更新**：自动使用当前日期
- **格式检查**：确保标记格式正确

## 自动化归档

### 归档触发条件
- **文件大小**：progress.md超过500行
- **完成数量**：DONE项超过10个
- **时间间隔**：建议每月或每阶段一次
- **手动触发**：用户执行 /sarchive 命令
- **自动执行**：auto_archive=true时强制归档（默认开启）

### 归档流程
1. 从 progress.md 中提取已完成内容
2. 移动到 archive.md
3. 生成归档总结
4. 更新 progress.md 时间戳
5. 自动提交到 Git
6. 发送归档确认通知
7. 记录到通知历史

### 压缩机制

#### 明确压缩规则
- **按日总结**：每日归档时生成"日总结：X个DONE，包括项目1、项目2"
- **按话题总结**：相关项目归类总结
- **按周总结**：每周生成"周报：X个DONE，包括架构设计等"

#### 压缩算法
- **日总结**：当日完成项目 + 重要决策 + 解决风险
- **话题总结**：按项目类型归类（前端、后端、测试等）
- **周总结**：本周完成项目 + 重要决策 + 解决风险 + 代码贡献

## 输出格式

### 记录格式
```markdown
- [类型] [优先级] 内容描述 [日期]
```

### 归档格式
```markdown
## [日期] 归档内容
- [类型] 内容描述
```

### 通知格式
```markdown
✅ 已记录：[类型] 内容描述
📊 当前进度：TODO: X个, DONE: Y个
⚠️ 建议归档：文件已超过500行
🔒 安全提醒：检测到潜在敏感信息
📊 归档总结：已归档5个DONE：架构设计、基础功能等
🤖 自动标记建议：检测到"风险"关键词，推荐[RISK]标记
⚡ 强制记忆：使用/force记记录紧急信息
```

## 配置参数

- **归档阈值**：500行或10个DONE项
- **自动归档**：auto_archive=true（默认开启）
- **通知记录**：auto_notify=true（默认开启）
- **Git集成**：auto_commit=true（默认开启）
- **备份策略**：Git自动提交
- **搜索范围**：当前项目
- **文件限制**：progress.md建议 < 1000行
- **触发冷却**：5分钟内最多触发3次
- **通知历史**：保留最近50条
- **压缩机制**：自动总结归档内容
- **自动标记**：auto_suggest=true（默认开启）
- **强制记忆**：force_memory=true（默认开启）
- **全局搜索**：global_search=true（默认开启）
- **忘记权**：forget_right=true（默认开启）
