<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº‹ä»¶ç®¡ç†</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    .controls {
      margin: 20px 0;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    button, .toggle-button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: white;
    }
    button:hover, .toggle-button:hover {
      background: #0056b3;
    }
    button:disabled, .toggle-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border: 1px solid #ddd;
    }
    th {
      background: #007bff;
      color: white;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
    tr:hover {
      background: #f0f0f0;
    }
    .track-btn {
      background: #17a2b8;
      margin-right: 8px;
    }
    .track-btn:hover {
      background: #138496;
    }
    .count-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
      min-width: 30px;
      text-align: center;
    }
    .count-2 {
      background: #ffc107;
      color: #000;
    }
    .count-3 {
      background: #ff9800;
      color: #fff;
    }
    .count-high {
      background: #f44336;
      color: #fff;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    .status-active {
      color: #28a745;
      font-weight: bold;
    }
    .filter {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    select {
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-width: 150px;
    }
    .toggle-button {
      background: #6c757d;
    }
    .toggle-button.active {
      background: #17a2b8;
    }
    .status-closed {
      color: #6c757d;
      font-weight: bold;
    }
    .action-cell {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .action-cell button {
      min-width: 90px;
      background: #6c757d;
    }
    .action-cell button:hover {
      background: #5a6268;
    }
    .action-cell button.fetch-btn {
      background: #ffc107;
      color: #333;
    }
    .action-cell button.fetch-btn.fetching {
      background: #f5a623;
      color: #fff;
    }
    .action-cell button.delete-btn {
      background: #fd7e14;
      color: #fff;
    }
    .action-cell button.delete-btn.deleting {
      background: #e2690f;
    }
    .action-cell button.delete-btn.deleted {
      background: #adb5bd;
      color: #f8f9fa;
      cursor: not-allowed;
    }
    .action-cell button.delete-btn:disabled {
      background: #f3b98a;
      color: #fafafa;
      cursor: not-allowed;
    }
    .action-cell button.close-btn {
      background: #dc3545;
    }
    .action-cell button.close-btn:hover {
      background: #b52a37;
    }
    .action-cell button.close-btn.disabled,
    .action-cell button.close-btn:disabled {
      background: #adb5bd;
      cursor: not-allowed;
    }
    .action-cell button.close-btn.disabled:hover,
    .action-cell button.close-btn:disabled:hover {
      background: #adb5bd;
    }
    .action-cell button.forward-btn {
      background: #17a2b8;
    }
    .action-cell button.forward-btn.forwarded {
      background: #20c997;
    }
    .action-cell button.forward-btn:disabled {
      background: #ffc107;
      color: #333;
    }
    .event-count {
      margin-left: auto;
    }
    .bulk-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .bulk-actions button {
      background: #343a40;
      color: #fff;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .bulk-actions button:disabled {
      background: #adb5bd;
      color: #f8f9fa;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>äº‹ä»¶ç®¡ç†</h1>
  
  <div class="controls">
    <button onclick="window.location.href='summary.html'">è¿”å›æ±‡æ€»</button>
    <button onclick="window.location.href='absence-tracking.html'">ğŸ“Š ç¼ºå‹¤è®°å½•</button>
    <button onclick="loadEvents()">åˆ·æ–°</button>
    <button id="toggleClosedBtn" class="toggle-button" onclick="toggleClosedEvents()">æ˜¾ç¤ºå·²å…³é—­äº‹ä»¶</button>
    
    <div class="filter">
      <label for="groupFilter">ç­›é€‰å°ç»„:</label>
      <select id="groupFilter" onchange="filterEvents()" aria-label="é€‰æ‹©å°ç»„ç­›é€‰">
        <option value="">å…¨éƒ¨å°ç»„</option>
      </select>
    </div>
    
    <span class="event-count">
      å…± <strong id="eventCount">0</strong> ä¸ªäº‹ä»¶
    </span>
  </div>
  <div class="bulk-actions">
    <button id="bulkForwardBtn" type="button" onclick="bulkForwardEvents()">ä¸€é”®è½¬å‘ (0)</button>
    <button id="bulkFetchBtn" type="button" onclick="bulkFetchFollowUps()">ä¸€é”®æŠ“å– (0)</button>
    <button id="bulkDeleteBtn" type="button" onclick="bulkDeleteExternalEvents()">ä¸€é”®åˆ é™¤å¤–éƒ¨äº‹ä»¶ (0)</button>
  </div>
  
  <table id="eventTable">
    <thead>
      <tr>
        <th>å§“å</th>
        <th>ç»„åˆ«</th>
        <th>ç¼ºå‹¤æ¬¡æ•°</th>
        <th>ç¼ºå‹¤å‘¨</th>
        <th>çŠ¶æ€</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="eventList">
      <tr>
        <td colspan="6" class="empty-state">åŠ è½½ä¸­...</td>
      </tr>
    </tbody>
  </table>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script src="./src/smart-config-loader.js"></script>
  <script>
    let db;
    let allEvents = [];
    let closedEvents = [];
    let groupNames = {};
    let showClosed = false;
    let forwardingEventId = null;
    let fetchingEventId = null;
    let deletingEventId = null;
    const bulkButtons = {
      forward: null,
      fetch: null,
      delete: null
    };
    const BULK_REQUEST_DELAY = 400;

    async function initFirebase() {
      let attempts = 0;
      while (!window.firebaseConfig && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      if (!window.firebaseConfig) {
        throw new Error('Firebaseé…ç½®åŠ è½½è¶…æ—¶');
      }
      if (!firebase.apps.length) {
        firebase.initializeApp(window.firebaseConfig);
      }
      db = firebase.database();
    }

    async function loadGroupNames() {
      const snapshot = await db.ref('groupNames').once('value');
      groupNames = snapshot.val() || {};
      const select = document.getElementById('groupFilter');
      Object.entries(groupNames).forEach(([key, name]) => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = name;
        select.appendChild(option);
      });
    }

    function normalizeEvent(recordId, rawEvent = {}, trackingRecord = {}) {
      const latestFollowUp = trackingRecord.latestFollowUp || rawEvent.latestFollowUp || null;
      const weeksSource = Array.isArray(trackingRecord.weeks)
        ? trackingRecord.weeks
        : Array.isArray(rawEvent.weeks)
          ? rawEvent.weeks
          : [];
      const weeks = [...new Set(weeksSource.filter(Boolean))].sort();
      const startDate = trackingRecord.startDate || rawEvent.startDate || weeks[0] || null;
      const endDate = trackingRecord.endDate || rawEvent.endDate || weeks[weeks.length - 1] || null;
      const status = trackingRecord.status || rawEvent.status || 'active';
      const memberSnapshot = trackingRecord.memberSnapshot || rawEvent.memberSnapshot || null;
      const createdAt = trackingRecord.createdAt || rawEvent.createdAt || new Date().toISOString();
      const updatedAt = trackingRecord.updatedAt || rawEvent.updatedAt || createdAt;
      const memberUUID = trackingRecord.memberUUID || rawEvent.memberUUID || null;
      const memberName = trackingRecord.memberName || rawEvent.memberName || 'æœªçŸ¥æˆå‘˜';
      const group = trackingRecord.group || rawEvent.group || '';
      const count = trackingRecord.count || rawEvent.count || weeks.length;
      const externalDeleted = trackingRecord.externalDeleted === true || rawEvent.externalDeleted === true;
      const externalDeletedAt = trackingRecord.externalDeletedAt || rawEvent.externalDeletedAt || null;

      return {
        id: recordId,
        recordId: rawEvent.recordId || trackingRecord.recordId || recordId,
        memberUUID,
        memberName,
        group,
        weeks,
        startDate,
        endDate,
        count,
        status,
        latestFollowUp,
        forwarded: rawEvent.forwarded || false,
        forwardDate: rawEvent.forwardDate || null,
        forwardStatus: rawEvent.forwardStatus || null,
        forwardResponse: rawEvent.forwardResponse || null,
        uuidMatchRequired: rawEvent.uuidMatchRequired || false,
        memberSnapshot,
        createdAt,
        updatedAt,
        externalDeleted,
        externalDeletedAt
      };
    }

    async function loadEvents() {
      try {
        const [eventsSnapshot, trackingSnapshot] = await Promise.all([
          db.ref('absenceEvents').once('value'),
          db.ref('trackingRecords').once('value')
        ]);
        const events = eventsSnapshot.val() || {};
        const trackingRecords = trackingSnapshot.val() || {};
        const allIds = new Set([
          ...Object.keys(events),
          ...Object.keys(trackingRecords)
        ]);

        const mappedEvents = Array.from(allIds)
          .map(recordId => normalizeEvent(recordId, events[recordId], trackingRecords[recordId]))
          .sort((a, b) => {
            if (a.group !== b.group) {
              return (a.group || '').localeCompare(b.group || '');
            }
            return (b.count || 0) - (a.count || 0);
          });

        allEvents = mappedEvents.filter(event => event.status === 'active');
        closedEvents = mappedEvents.filter(event => event.status !== 'active');

        const list = showClosed ? closedEvents : allEvents;
        displayEvents(list);
        document.getElementById('eventCount').textContent = list.length;
        updateBulkButtons();
      } catch (error) {
        console.error('åŠ è½½äº‹ä»¶å¤±è´¥:', error);
        alert('åŠ è½½äº‹ä»¶å¤±è´¥: ' + error.message);
      }
    }

    function formatWeekLabel(dateStr) {
      if (!dateStr) {
        return 'æœªçŸ¥';
      }
      const date = new Date(dateStr);
      if (Number.isNaN(date.getTime())) {
        return dateStr;
      }
      const month = date.getMonth() + 1;
      const week = Math.ceil(date.getDate() / 7);
      return `${month}æœˆ${week}å‘¨`;
    }

    function formatWeekRange(event) {
      if (Array.isArray(event.weeks) && event.weeks.length > 0) {
        const sortedWeeks = [...event.weeks];
        const startLabel = formatWeekLabel(sortedWeeks[0]);
        const endLabel = formatWeekLabel(sortedWeeks[sortedWeeks.length - 1]);
        return startLabel === endLabel ? startLabel : `${startLabel}-${endLabel}`;
      }
      const startLabel = formatWeekLabel(event.startDate);
      const endLabel = formatWeekLabel(event.endDate);
      if (!endLabel || endLabel === 'æœªçŸ¥') {
        return startLabel;
      }
      return startLabel === endLabel ? startLabel : `${startLabel}-${endLabel}`;
    }

    function displayEvents(events) {
      const tbody = document.getElementById('eventList');
      if (events.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">æš‚æ— è·Ÿè¸ªäº‹ä»¶</td></tr>';
        return;
      }

      tbody.innerHTML = events.map(event => {
        const groupName = groupNames[event.group] || event.group || 'æœªåˆ†ç»„';
        const countClass = event.count === 2 ? 'count-2' : (event.count === 3 ? 'count-3' : 'count-high');
        const weekRange = formatWeekRange(event);
        const isActive = event.status === 'active';
        const statusClass = isActive ? 'status-active' : 'status-closed';
        const statusLabel = isActive ? 'æ´»è·ƒ' : 'å·²å…³é—­';
        const memberUUID = event.memberUUID || '';
        const latestFollowUpContent = event.latestFollowUp && typeof event.latestFollowUp.content === 'string'
          ? event.latestFollowUp.content.trim()
          : '';
        const hasFollowUp = latestFollowUpContent.length > 0;
        const externalDeleted = event.externalDeleted === true;
        const canDeleteExternal = hasFollowUp && !externalDeleted;
        const trackButton = memberUUID
          ? `<button class="track-btn" onclick="openTrackingPage('${memberUUID}', '${event.id}')">è·Ÿè¸ª</button>`
          : '';

        const isForwarded = event.forwarded === true;
        const forwardDateText = event.forwardDate ? new Date(event.forwardDate).toLocaleString('zh-CN') : '';
        const forwardTitle = isForwarded ? `å·²äº ${forwardDateText} è½¬å‘åˆ°å¤–éƒ¨è¡¨å•` : 'è½¬å‘åˆ°å¤–éƒ¨è¡¨å•';
        const isProcessing = forwardingEventId === event.id;
        const forwardLabel = isProcessing ? 'è½¬å‘ä¸­...' : (isForwarded ? 'å·²è½¬å‘' : 'è½¬å‘');
        const forwardClass = `forward-btn ${isForwarded ? 'forwarded' : ''}`;
        const forwardDisabledAttr = isProcessing ? 'disabled' : '';

        const isFetching = fetchingEventId === event.id;
        const fetchLabel = isFetching ? 'æŠ“å–ä¸­...' : 'æŠ“å–';
        const fetchClass = `fetch-btn${isFetching ? ' fetching' : ''}`;
        const fetchDisabledAttr = isFetching ? 'disabled' : '';

        const fetchButton = `
          <button
            class="${fetchClass}"
            data-fetch-id="${event.id}"
            title="æŠ“å–å¤–éƒ¨å›è®¿è®°å½•"
            onclick="fetchLatestFollowUp('${event.id}')"
            ${fetchDisabledAttr}
          >
            ${fetchLabel}
          </button>
        `;

        const forwardButton = `
          <button
            class="${forwardClass}"
            data-forward-id="${event.id}"
            data-forwarded="${isForwarded ? 'true' : 'false'}"
            title="${forwardTitle}"
            onclick="forwardAbsenceEvent('${event.id}')"
            ${forwardDisabledAttr}
          >
            ${forwardLabel}
          </button>
        `;

        const isDeleting = deletingEventId === event.id;
        const deleteLabel = externalDeleted
          ? 'å·²åˆ å¤–éƒ¨äº‹ä»¶'
          : (isDeleting ? 'åˆ é™¤ä¸­...' : 'åˆ é™¤å¤–éƒ¨äº‹ä»¶');
        const deleteDisabledAttr = externalDeleted
          ? 'disabled aria-disabled="true" title="å¤–éƒ¨äº‹ä»¶å·²åˆ é™¤"'
          : (!canDeleteExternal
            ? 'disabled aria-disabled="true" title="æŠ“å–å›è®¿åæ–¹å¯åˆ é™¤å¤–éƒ¨äº‹ä»¶"'
            : (isDeleting ? 'disabled' : ''));
        const deleteClass = `delete-btn${isDeleting ? ' deleting' : ''}${externalDeleted ? ' deleted' : ''}`;
        const deleteAction = externalDeleted
          ? 'return false;'
          : (canDeleteExternal ? `deleteExternalEvent('${event.id}')` : 'return false;');
        const deleteButton = `
          <button
            class="${deleteClass}"
            data-delete-id="${event.id}"
            data-external-deleted="${externalDeleted ? 'true' : 'false'}"
            title="${externalDeleted ? 'å¤–éƒ¨äº‹ä»¶å·²åˆ é™¤' : (canDeleteExternal ? 'åˆ é™¤äº‘è¡¨å•ä¸­çš„å¯¹åº”äº‹ä»¶ä¸å›è®¿è®°å½•' : 'æŠ“å–å›è®¿åæ–¹å¯åˆ é™¤å¤–éƒ¨äº‹ä»¶')}"
            onclick="${deleteAction}"
            ${deleteDisabledAttr}
          >
            ${deleteLabel}
          </button>
        `;

        const closeButton = isActive
          ? `<button class="close-btn${hasFollowUp ? '' : ' disabled'}" ${hasFollowUp ? `onclick="closeEvent('${event.id}')"` : 'disabled aria-disabled="true" title="éœ€å…ˆå½•å…¥å›è®¿ä¿¡æ¯æ‰å¯å…³é—­äº‹ä»¶"'}>å…³é—­</button>`
          : '';

        return `
          <tr data-group="${event.group}">
            <td>${event.memberName}</td>
            <td>${groupName}</td>
            <td><span class="count-badge ${countClass}">${event.count}æ¬¡</span></td>
            <td>${weekRange}</td>
            <td><span class="${statusClass}">${statusLabel}</span></td>
            <td class="action-cell">${trackButton}${fetchButton}${forwardButton}${deleteButton}${closeButton}</td>
          </tr>
        `;
      }).join('');
    }

    function ensureBulkButtonRefs() {
      if (!bulkButtons.forward) {
        bulkButtons.forward = document.getElementById('bulkForwardBtn');
      }
      if (!bulkButtons.fetch) {
        bulkButtons.fetch = document.getElementById('bulkFetchBtn');
      }
      if (!bulkButtons.delete) {
        bulkButtons.delete = document.getElementById('bulkDeleteBtn');
      }
    }

    function getAllEventItems() {
      return [...allEvents, ...closedEvents].filter(item => item && typeof item === 'object');
    }

    function getBulkCandidates() {
      const events = getAllEventItems();
      const forwardCandidates = events.filter(event =>
        event.status === 'active'
        && event.forwarded !== true
        && event.memberUUID
      );
      const fetchCandidates = events.filter(event => {
        const content = event.latestFollowUp && typeof event.latestFollowUp.content === 'string'
          ? event.latestFollowUp.content.trim()
          : '';
        return event.status === 'active'
          && event.forwarded === true
          && content.length === 0;
      });
      const deleteCandidates = events.filter(event => {
        const content = event.latestFollowUp && typeof event.latestFollowUp.content === 'string'
          ? event.latestFollowUp.content.trim()
          : '';
        return event.status === 'active'
          && content.length > 0
          && event.externalDeleted !== true;
      });
      return {
        forward: forwardCandidates,
        fetch: fetchCandidates,
        delete: deleteCandidates
      };
    }

    function updateBulkButtons() {
      ensureBulkButtonRefs();
      const counts = getBulkCandidates();
      if (bulkButtons.forward) {
        bulkButtons.forward.textContent = `ä¸€é”®è½¬å‘ (${counts.forward.length})`;
        bulkButtons.forward.disabled = counts.forward.length === 0;
      }
      if (bulkButtons.fetch) {
        bulkButtons.fetch.textContent = `ä¸€é”®æŠ“å– (${counts.fetch.length})`;
        bulkButtons.fetch.disabled = counts.fetch.length === 0;
      }
      if (bulkButtons.delete) {
        bulkButtons.delete.textContent = `ä¸€é”®åˆ é™¤å¤–éƒ¨äº‹ä»¶ (${counts.delete.length})`;
        bulkButtons.delete.disabled = counts.delete.length === 0;
      }
    }

    function setBulkButtonProcessing(type, { total = 0, completed = 0, label = '' } = {}) {
      ensureBulkButtonRefs();
      const mapping = {
        forward: bulkButtons.forward,
        fetch: bulkButtons.fetch,
        delete: bulkButtons.delete
      };
      const button = mapping[type];
      if (!button) {
        return;
      }
      if (label) {
        button.textContent = `${label} (${completed}/${total})`;
      }
      button.disabled = true;
    }

    function resetBulkButton(type) {
      ensureBulkButtonRefs();
      const counts = getBulkCandidates();
      if (type === 'forward' && bulkButtons.forward) {
        bulkButtons.forward.disabled = counts.forward.length === 0;
        bulkButtons.forward.textContent = `ä¸€é”®è½¬å‘ (${counts.forward.length})`;
      }
      if (type === 'fetch' && bulkButtons.fetch) {
        bulkButtons.fetch.disabled = counts.fetch.length === 0;
        bulkButtons.fetch.textContent = `ä¸€é”®æŠ“å– (${counts.fetch.length})`;
      }
      if (type === 'delete' && bulkButtons.delete) {
        bulkButtons.delete.disabled = counts.delete.length === 0;
        bulkButtons.delete.textContent = `ä¸€é”®åˆ é™¤å¤–éƒ¨äº‹ä»¶ (${counts.delete.length})`;
      }
    }

    function delay(ms = 0) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function filterEvents() {
      const selectedGroup = document.getElementById('groupFilter').value;
      const source = showClosed ? closedEvents : allEvents;
      if (!selectedGroup) {
        displayEvents(source);
        document.getElementById('eventCount').textContent = source.length;
        return;
      }
      const filtered = source.filter(event => event.group === selectedGroup);
      displayEvents(filtered);
      document.getElementById('eventCount').textContent = filtered.length;
    }

    async function closeEvent(recordId) {
      const targetEvent = allEvents.find(event => event.id === recordId) || closedEvents.find(event => event.id === recordId);
      if (!targetEvent) {
        alert('æœªæ‰¾åˆ°äº‹ä»¶è®°å½•ï¼Œæ— æ³•å…³é—­');
        return;
      }
      const latestFollowUpContent = targetEvent.latestFollowUp && typeof targetEvent.latestFollowUp.content === 'string'
        ? targetEvent.latestFollowUp.content.trim()
        : '';
      if (!latestFollowUpContent) {
        alert('è¯·å…ˆåœ¨ä¸ªäººäº‹ä»¶é¡µé¢å½•å…¥æœ‰æ•ˆçš„å›è®¿ä¿¡æ¯åå†å…³é—­äº‹ä»¶ã€‚');
        return;
      }
      if (!confirm(`ç¡®è®¤å…³é—­ ${targetEvent.memberName} çš„ç¼ºå‹¤äº‹ä»¶å—ï¼Ÿ`)) {
        return;
      }
      try {
        const today = new Date();
        const resolvedDate = today.toISOString().split('T')[0];
        const payload = {
          status: 'resolved',
          resolvedDate,
          updatedAt: today.toISOString()
        };
        await Promise.all([
          db.ref(`absenceEvents/${recordId}`).update(payload),
          db.ref(`trackingRecords/${recordId}`).update(payload)
        ]);
        alert('äº‹ä»¶å·²å…³é—­');
        await loadEvents();
      } catch (error) {
        console.error('å…³é—­äº‹ä»¶å¤±è´¥:', error);
        alert('å…³é—­äº‹ä»¶å¤±è´¥: ' + error.message);
      }
    }

    function findEventById(recordId) {
      return allEvents.find(event => event.id === recordId)
        || closedEvents.find(event => event.id === recordId)
        || null;
    }

    function updateForwardButtonState(recordId, state) {
      const button = document.querySelector(`button[data-forward-id="${recordId}"]`);
      if (!button) {
        return;
      }
      const { loading = false, forwarded = null } = state || {};
      if (loading) {
        button.disabled = true;
        button.textContent = 'è½¬å‘ä¸­...';
      } else {
        button.disabled = false;
        const isForwarded = forwarded !== null ? forwarded : button.dataset.forwarded === 'true';
        button.dataset.forwarded = isForwarded ? 'true' : 'false';
        button.textContent = isForwarded ? 'å·²è½¬å‘' : 'è½¬å‘';
        if (isForwarded) {
          button.classList.add('forwarded');
        } else {
          button.classList.remove('forwarded');
        }
      }
    }

    function updateFetchButtonState(recordId, state) {
      const button = document.querySelector(`button[data-fetch-id="${recordId}"]`);
      if (!button) {
        return;
      }
      const { loading = false, success = false } = state || {};
      if (loading) {
        button.disabled = true;
        button.textContent = 'æŠ“å–ä¸­...';
        button.classList.add('fetching');
        return;
      }
      button.disabled = false;
      button.classList.remove('fetching');
      button.textContent = success ? 'å·²æŠ“å–' : 'æŠ“å–';
      if (success) {
        setTimeout(() => {
          const target = document.querySelector(`button[data-fetch-id="${recordId}"]`);
          if (target) {
            target.textContent = 'æŠ“å–';
          }
        }, 2000);
      }
    }

    function updateDeleteButtonState(recordId, state) {
      const button = document.querySelector(`button[data-delete-id="${recordId}"]`);
      if (!button) {
        return;
      }
      const { loading = false } = state || {};
      const externalDeleted = button.dataset.externalDeleted === 'true' || button.classList.contains('deleted');
      if (loading) {
        button.disabled = true;
        button.textContent = 'åˆ é™¤ä¸­...';
        button.classList.add('deleting');
      } else {
        button.classList.remove('deleting');
        if (externalDeleted) {
          button.disabled = true;
          button.textContent = 'å·²åˆ å¤–éƒ¨äº‹ä»¶';
          button.classList.add('deleted');
          button.title = 'å¤–éƒ¨äº‹ä»¶å·²åˆ é™¤';
        } else {
          button.disabled = false;
          button.textContent = 'åˆ é™¤å¤–éƒ¨äº‹ä»¶';
          button.classList.remove('deleted');
          button.title = 'åˆ é™¤äº‘è¡¨å•ä¸­çš„å¯¹åº”äº‹ä»¶ä¸å›è®¿è®°å½•';
        }
      }
    }

    async function getExternalFormToken() {
      if (!window.externalFormConfig || !window.externalFormConfig.apiBaseUrl) {
        throw new Error('å¤–éƒ¨è¡¨å•ç³»ç»Ÿæœªé…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
      }
      if (window.externalFormConfig.auth && window.externalFormConfig.auth.token) {
        return window.externalFormConfig.auth.token;
      }
      const response = await fetch(`${window.externalFormConfig.apiBaseUrl}${window.externalFormConfig.endpoints.login}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: window.externalFormConfig.auth.username,
          password: window.externalFormConfig.auth.password
        })
      });
      if (!response.ok) {
        throw new Error(`ç™»å½•å¤–éƒ¨è¡¨å•ç³»ç»Ÿå¤±è´¥ï¼š${response.status}`);
      }
      const result = await response.json();
      const token = (result && (result.token || (result.data && result.data.token))) || null;
      if (!token) {
        throw new Error('å¤–éƒ¨è¡¨å•ç³»ç»Ÿç™»å½•å“åº”ç¼ºå°‘token');
      }
      window.externalFormConfig.auth.token = token;
      if (result.data && result.data.user) {
        window.externalFormConfig.auth.user = result.data.user;
      }
      return token;
    }

    async function forwardAbsenceEvent(recordId, options = {}) {
      const {
        silent = false,
        skipReload = false,
        throwOnError = false
      } = options;
      try {
        const targetEvent = findEventById(recordId);
        if (!targetEvent) {
          const message = 'æœªæ‰¾åˆ°äº‹ä»¶è®°å½•ï¼Œæ— æ³•è½¬å‘';
          if (!silent) {
            alert(message);
          } else {
            console.warn(message);
          }
          if (throwOnError) {
            throw new Error(message);
          }
          return { success: false, reason: 'not_found' };
        }
        if (!window.externalFormConfig || !window.externalFormConfig.features || window.externalFormConfig.features.enableForwarding !== true) {
          const message = 'å¤–éƒ¨è¡¨å•è½¬å‘åŠŸèƒ½æœªå¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
          if (!silent) {
            alert(message);
          } else {
            console.warn(message);
          }
          if (throwOnError) {
            throw new Error(message);
          }
          return { success: false, reason: 'feature_disabled' };
        }
        const memberUUID = targetEvent.memberUUID;
        if (!memberUUID) {
          const message = 'å½“å‰äº‹ä»¶ç¼ºå°‘æˆå‘˜UUIDï¼Œè¯·å…ˆè¡¥é½æˆå‘˜UUIDåå†å°è¯•è½¬å‘ã€‚';
          if (!silent) {
            alert(message);
          } else {
            console.warn(message);
          }
          if (throwOnError) {
            throw new Error(message);
          }
          return { success: false, reason: 'missing_uuid' };
        }
        if (targetEvent.forwarded === true) {
          const forwardDate = targetEvent.forwardDate ? new Date(targetEvent.forwardDate).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';
          const message = `è¯¥äº‹ä»¶å·²äº ${forwardDate} è½¬å‘è¿‡ï¼\n\næ˜¯å¦è¦é‡æ–°è½¬å‘ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"é‡æ–°è½¬å‘\nç‚¹å‡»"å–æ¶ˆ"å–æ¶ˆæ“ä½œ`;
          if (silent) {
            console.warn('æ‰¹é‡æ¨¡å¼è·³è¿‡å·²è½¬å‘äº‹ä»¶', recordId);
            if (throwOnError) {
              throw new Error('äº‹ä»¶å·²è½¬å‘');
            }
            return { success: false, reason: 'already_forwarded' };
          }
          const confirmResend = confirm(message);
          if (!confirmResend) {
            return { success: false, reason: 'user_cancel' };
          }
        }
        if (forwardingEventId) {
          const message = 'å·²æœ‰è½¬å‘æ“ä½œæ­£åœ¨è¿›è¡Œï¼Œè¯·ç¨å€™å†è¯•';
          if (!silent) {
            alert(message);
          } else {
            console.warn(message);
          }
          if (throwOnError) {
            throw new Error(message);
          }
          return { success: false, reason: 'busy' };
        }
        forwardingEventId = recordId;
        updateForwardButtonState(recordId, { loading: true });

        const token = await getExternalFormToken();
        const displayGroupName = targetEvent.groupDisplayName
          || groupNames[targetEvent.group]
          || targetEvent.group
          || 'æœªçŸ¥ç»„åˆ«';
        const weeks = Array.isArray(targetEvent.weeks) ? targetEvent.weeks : [];
        const startDate = targetEvent.startDate || (weeks.length > 0 ? weeks[0] : new Date().toISOString().split('T')[0]);
        const eventName = `${targetEvent.memberName || 'æœªçŸ¥æˆå‘˜'} è¿ç»­ç¼ºå‹¤ ${targetEvent.count || weeks.length} æ¬¡`;
        const detailPayload = {
          absenceEventId: recordId,
          memberName: targetEvent.memberName || 'æœªçŸ¥æˆå‘˜',
          memberUUID,
          group: displayGroupName,
          startDate,
          consecutiveAbsences: targetEvent.count || weeks.length,
          absenceWeeks: weeks,
          generatedAt: new Date().toISOString(),
          source: 'msh-absence-events'
        };

        const eventData = {
          name: eventName,
          description: `è‡ªåŠ¨è½¬å‘çš„ç¼ºå‹¤äº‹ä»¶ï¼š\n${JSON.stringify(detailPayload, null, 2)}`,
          event_date: startDate,
          status: 'active'
        };

        const response = await fetch(`${window.externalFormConfig.apiBaseUrl}${window.externalFormConfig.endpoints.submissions}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(eventData)
        });

        const resultText = await response.text();
        let result = {};
        try {
          result = JSON.parse(resultText);
        } catch (parseError) {
          console.warn('æ— æ³•è§£æå¤–éƒ¨è¡¨å•å“åº”', parseError);
        }

        if (response.status !== 201) {
          const errorMessage = (result && (result.message || result.error)) || resultText || 'å¤–éƒ¨è¡¨å•è¿”å›æœªçŸ¥é”™è¯¯';
          throw new Error(`HTTP ${response.status}: ${errorMessage}`);
        }

        const now = new Date().toISOString();
        const updates = {
          forwarded: true,
          forwardDate: now,
          forwardStatus: 'pending',
          forwardResponse: result,
          uuidMatchRequired: true,
          updatedAt: now
        };
        await db.ref(`absenceEvents/${recordId}`).update(updates);
        Object.assign(targetEvent, updates);
        updateForwardButtonState(recordId, { loading: false, forwarded: true });
        if (!silent) {
          alert('äº‹ä»¶å·²æˆåŠŸè½¬å‘åˆ°å¤–éƒ¨è¡¨å•ï¼Œç­‰å¾…UUIDåŒ¹é…ç¡®è®¤ï¼');
        } else {
          console.log(`äº‹ä»¶ ${recordId} å·²è½¬å‘åˆ°å¤–éƒ¨è¡¨å•`);
        }
        forwardingEventId = null;
        if (!skipReload) {
          await loadEvents();
        } else {
          updateBulkButtons();
        }
        return { success: true };
      } catch (error) {
        console.error('è½¬å‘åˆ°å¤–éƒ¨è¡¨å•å¤±è´¥:', error);
        if (!silent) {
          alert('è½¬å‘å¤±è´¥ï¼š' + error.message);
        } else {
          console.warn('è½¬å‘å¤±è´¥ï¼ˆæ‰¹é‡æ¨¡å¼ï¼‰:', error);
        }
        if (forwardingEventId) {
          updateForwardButtonState(forwardingEventId, { loading: false });
        }
        if (throwOnError) {
          throw error;
        }
        return { success: false, error };
      } finally {
        forwardingEventId = null;
      }
    }

    async function fetchLatestFollowUp(recordId, options = {}) {
      const {
        silent = false,
        skipReload = false,
        throwOnError = false
      } = options;
      try {
        const targetEvent = findEventById(recordId);
        if (!targetEvent) {
          const message = 'æœªæ‰¾åˆ°äº‹ä»¶è®°å½•ï¼Œæ— æ³•æŠ“å–å›è®¿';
          if (!silent) {
            alert(message);
          } else {
            console.warn(message);
          }
          if (throwOnError) {
            throw new Error(message);
          }
          return { success: false, reason: 'not_found' };
        }
        if (!window.externalFormConfig || !window.externalFormConfig.apiBaseUrl) {
          const message = 'å¤–éƒ¨è¡¨å•ç³»ç»Ÿæœªé…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
          if (!silent) {
            alert(message);
          } else {
            console.warn(message);
          }
          if (throwOnError) {
            throw new Error(message);
          }
          return { success: false, reason: 'config_missing' };
        }
        if (window.externalFormConfig.features && window.externalFormConfig.features.enableFetching === false) {
          const message = 'å¤–éƒ¨è¡¨å•æŠ“å–åŠŸèƒ½æœªå¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
          if (!silent) {
            alert(message);
          } else {
            console.warn(message);
          }
          if (throwOnError) {
            throw new Error(message);
          }
          return { success: false, reason: 'feature_disabled' };
        }
        if (!targetEvent.memberUUID) {
          const message = 'å½“å‰äº‹ä»¶ç¼ºå°‘æˆå‘˜UUIDï¼Œæ— æ³•åŒ¹é…å¤–éƒ¨è¡¨å•è®°å½•ã€‚';
          if (!silent) {
            alert(message);
          } else {
            console.warn(message);
          }
          if (throwOnError) {
            throw new Error(message);
          }
          return { success: false, reason: 'missing_uuid' };
        }
        if (fetchingEventId) {
          const message = 'å·²æœ‰æŠ“å–æ“ä½œæ­£åœ¨è¿›è¡Œï¼Œè¯·ç¨å€™å†è¯•';
          if (!silent) {
            alert(message);
          } else {
            console.warn(message);
          }
          if (throwOnError) {
            throw new Error(message);
          }
          return { success: false, reason: 'busy' };
        }
        fetchingEventId = recordId;
        updateFetchButtonState(recordId, { loading: true });

        console.groupCollapsed(
          'ğŸ” æŠ“å–å¤–éƒ¨å›è®¿è°ƒè¯•',
          recordId,
          new Date().toLocaleString('zh-CN', { hour12: false })
        );
        console.log('recordId:', recordId);
        console.log('targetEvent:', targetEvent);
        console.log('externalFormConfig:', window.externalFormConfig);

        const apiBase = window.externalFormConfig.apiBaseUrl.replace(/\/+$/, '');
        const lookupPath =
          (window.externalFormConfig.endpoints && window.externalFormConfig.endpoints.lookup) || '/events/lookup';
        const url = new URL(`${apiBase}${lookupPath}`);
        url.searchParams.set('absenceEventId', recordId);
        url.searchParams.set('includeFeedbacks', 'true');

        const headers = { 'Content-Type': 'application/json' };
        const requestInfo = {
          url: url.toString(),
          headers: { ...headers }
        };
        console.log('è¯·æ±‚ä¿¡æ¯:', requestInfo);

        let response = await fetch(requestInfo.url, { headers: requestInfo.headers });

        if (response.status === 401 && window.externalFormConfig.endpoints && window.externalFormConfig.endpoints.login) {
          try {
            const token = await getExternalFormToken();
            headers.Authorization = `Bearer ${token}`;
            requestInfo.headers = { ...headers };
            console.log('é‡æ–°è·å–tokenåé‡æ–°è¯·æ±‚:', requestInfo);
            response = await fetch(requestInfo.url, { headers: requestInfo.headers });
          } catch (authError) {
            console.warn('è·å–å¤–éƒ¨è¡¨å•tokenå¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŒ¿åè¯·æ±‚', authError);
          }
        }

        const resultText = await response.text();
        console.log('å“åº”çŠ¶æ€:', response.status);
        console.log('å“åº”æ–‡æœ¬:', resultText);
        let result = {};
        try {
          result = JSON.parse(resultText);
        } catch (parseError) {
          console.warn('æ— æ³•è§£æå¤–éƒ¨è¡¨å•æŠ“å–å“åº”', parseError);
        }

        if (!response.ok) {
          const message =
            (result && (result.message || result.error)) || `HTTP ${response.status}` || 'å¤–éƒ¨è¡¨å•è¿”å›é”™è¯¯';
          console.error('æŠ“å–æ¥å£è¿”å›é200çŠ¶æ€', {
            status: response.status,
            statusText: response.statusText,
            result
          });
          throw new Error(message);
        }

        const rawData = result.data || {};
        const eventData = rawData.event || rawData;
        if (!eventData || !eventData.external_event_id) {
          console.warn('æŠ“å–ç»“æœç¼ºå°‘äº‹ä»¶æ•°æ®', rawData);
        }

        const feedbacks = Array.isArray(rawData.feedbacks)
          ? rawData.feedbacks
          : Array.isArray(eventData && eventData.feedbacks)
            ? eventData.feedbacks
            : [];

        if (!feedbacks.length) {
          if (!silent) {
            alert('å¤–éƒ¨è¡¨å•æš‚æ— æ–°çš„å›è®¿è®°å½•ã€‚');
          } else {
            console.log(`äº‹ä»¶ ${recordId} æš‚æ— æ–°çš„å›è®¿è®°å½•`);
          }
          updateFetchButtonState(recordId, { loading: false, success: false });
          fetchingEventId = null;
          if (throwOnError) {
            throw new Error('å¤–éƒ¨è¡¨å•æš‚æ— æ–°çš„å›è®¿è®°å½•');
          }
          return { success: false, reason: 'no_feedback' };
        }

        const latest = feedbacks[0] || null;
        const feedbackContent = latest && typeof latest.feedback_text === 'string'
          ? latest.feedback_text.trim()
          : '';
        if (!feedbackContent) {
          if (!silent) {
            alert('å¤–éƒ¨è¡¨å•è¿”å›çš„å›è®¿è®°å½•ä¸ºç©ºï¼Œå·²å¿½ç•¥ã€‚');
          } else {
            console.warn(`äº‹ä»¶ ${recordId} çš„å›è®¿è®°å½•ä¸ºç©º`);
          }
          updateFetchButtonState(recordId, { loading: false, success: false });
          fetchingEventId = null;
          if (throwOnError) {
            throw new Error('å›è®¿è®°å½•ä¸ºç©º');
          }
          return { success: false, reason: 'empty_feedback' };
        }

        const submittedAt = latest.created_at || latest.updated_at || new Date().toISOString();
        const followUpPayload = {
          content: feedbackContent,
          memberUUID: targetEvent.memberUUID,
          source: 'external-form',
          externalFeedbackId: latest.id || null,
          externalEventId: eventData && eventData.external_event_id ? eventData.external_event_id : recordId,
          fetchedAt: new Date().toISOString(),
          submittedAt,
          createdAt: latest.created_at || submittedAt,
          updatedAt: latest.updated_at || submittedAt
        };

        const now = new Date().toISOString();
        await Promise.all([
          db.ref(`absenceEvents/${recordId}`).update({
            latestFollowUp: followUpPayload,
            updatedAt: now
          }),
          db.ref(`trackingRecords/${recordId}`).update({
            latestFollowUp: followUpPayload,
            updatedAt: now
          })
        ]);

        targetEvent.latestFollowUp = followUpPayload;
        targetEvent.updatedAt = now;

        updateFetchButtonState(recordId, { loading: false, success: true });
        fetchingEventId = null;
        if (!silent) {
          alert('å·²æˆåŠŸæŠ“å–æœ€æ–°å›è®¿è®°å½•ï¼');
        } else {
          console.log(`äº‹ä»¶ ${recordId} å·²æŠ“å–æœ€æ–°å›è®¿è®°å½•`);
        }
        if (!skipReload) {
          await loadEvents();
        } else {
          updateBulkButtons();
        }
        console.groupEnd();
        return { success: true };
      } catch (error) {
        console.error('æŠ“å–å¤–éƒ¨å›è®¿å¤±è´¥:', error);
        if (!silent) {
          alert('æŠ“å–å¤±è´¥ï¼š' + error.message);
        } else {
          console.warn('æŠ“å–å¤±è´¥ï¼ˆæ‰¹é‡æ¨¡å¼ï¼‰:', error);
        }
        if (fetchingEventId) {
          updateFetchButtonState(fetchingEventId, { loading: false, success: false });
        }
        if (throwOnError) {
          throw error;
        }
        return { success: false, error };
      } finally {
        fetchingEventId = null;
        if (console.groupEnd) {
          console.groupEnd();
        }
      }
    }

    async function deleteExternalEvent(recordId, options = {}) {
      const {
        silent = false,
        skipReload = false,
        throwOnError = false,
        skipConfirm = false
      } = options;
      try {
        const targetEvent = findEventById(recordId);
        if (!targetEvent) {
          const message = 'æœªæ‰¾åˆ°äº‹ä»¶è®°å½•ï¼Œæ— æ³•åˆ é™¤å¤–éƒ¨äº‹ä»¶';
          if (!silent) {
            alert(message);
          } else {
            console.warn(message);
          }
          if (throwOnError) {
            throw new Error(message);
          }
          return { success: false, reason: 'not_found' };
        }
        const latestFollowUpContent = targetEvent.latestFollowUp && typeof targetEvent.latestFollowUp.content === 'string'
          ? targetEvent.latestFollowUp.content.trim()
          : '';
        if (!latestFollowUpContent) {
          const message = 'éœ€å…ˆæŠ“å–åˆ°æœ‰æ•ˆå›è®¿è®°å½•åæ‰èƒ½åˆ é™¤å¤–éƒ¨äº‹ä»¶ã€‚';
          if (!silent) {
            alert(message);
          } else {
            console.warn(message);
          }
          if (throwOnError) {
            throw new Error(message);
          }
          return { success: false, reason: 'missing_followup' };
        }
        if (!window.externalFormConfig || !window.externalFormConfig.apiBaseUrl) {
          const message = 'å¤–éƒ¨è¡¨å•ç³»ç»Ÿæœªé…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
          if (!silent) {
            alert(message);
          } else {
            console.warn(message);
          }
          if (throwOnError) {
            throw new Error(message);
          }
          return { success: false, reason: 'config_missing' };
        }
        if (deletingEventId) {
          const message = 'å·²æœ‰åˆ é™¤æ“ä½œæ­£åœ¨è¿›è¡Œï¼Œè¯·ç¨å€™å†è¯•';
          if (!silent) {
            alert(message);
          } else {
            console.warn(message);
          }
          if (throwOnError) {
            throw new Error(message);
          }
          return { success: false, reason: 'busy' };
        }
        if (!skipConfirm) {
          const confirmDelete = confirm(`æ­¤æ“ä½œå°†åˆ é™¤äº‘è¡¨å•ä¸­çš„äº‹ä»¶åŠå…¶å›è®¿è®°å½•ï¼š\n\næˆå‘˜ï¼š${targetEvent.memberName}\nç¼ºå‹¤æ¬¡æ•°ï¼š${targetEvent.count} æ¬¡\n\nç¡®å®šç»§ç»­ï¼Ÿ`);
          if (!confirmDelete) {
            return { success: false, reason: 'user_cancel' };
          }
        }

        console.groupCollapsed(
          'ğŸ—‘ï¸ åˆ é™¤å¤–éƒ¨äº‹ä»¶è°ƒè¯•',
          recordId,
          new Date().toLocaleString('zh-CN', { hour12: false })
        );
        console.log('recordId:', recordId);
        console.log('targetEvent:', targetEvent);
        console.log('externalFormConfig:', window.externalFormConfig);

        deletingEventId = recordId;
        updateDeleteButtonState(recordId, { loading: true });

        const apiBase = window.externalFormConfig.apiBaseUrl.replace(/\/+$/, '');
        const deleteEndpoint = window.externalFormConfig.endpoints && window.externalFormConfig.endpoints.deleteByExternalId
          ? window.externalFormConfig.endpoints.deleteByExternalId
          : 'events/byExternalId';
        const normalizedEndpoint = deleteEndpoint.replace(/^\/+/, '');
        const requestUrl = `${apiBase}/${normalizedEndpoint}/${encodeURIComponent(recordId)}`;
        console.log('è¯·æ±‚URL:', requestUrl);

        const headers = { 'Content-Type': 'application/json' };
        console.log('è¯·æ±‚Headers:', headers);
        let response = await fetch(requestUrl, {
          method: 'DELETE',
          headers
        });

        if (response.status === 401 && window.externalFormConfig.endpoints && window.externalFormConfig.endpoints.login) {
          try {
            const token = await getExternalFormToken();
            headers.Authorization = `Bearer ${token}`;
            console.log('é‡æ–°è·å–tokenåè¯·æ±‚Headers:', headers);
            response = await fetch(requestUrl, {
              method: 'DELETE',
              headers
            });
          } catch (tokenError) {
            console.warn('è·å–å¤–éƒ¨è¡¨å•tokenå¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŒ¿åè¯·æ±‚', tokenError);
          }
        }

        const resultText = await response.text();
        console.log('å“åº”çŠ¶æ€:', response.status);
        console.log('å“åº”æ–‡æœ¬:', resultText);
        let result = {};
        try {
          result = JSON.parse(resultText);
        } catch (parseError) {
          console.warn('æ— æ³•è§£æå¤–éƒ¨äº‹ä»¶åˆ é™¤å“åº”', parseError);
        }

        if (!response.ok) {
          const message =
            (result && (result.message || result.error)) || `HTTP ${response.status}` || 'å¤–éƒ¨è¡¨å•è¿”å›é”™è¯¯';
          throw new Error(message);
        }

        if (result.code === 200) {
          const deletedCount = result.data && typeof result.data.deletedFeedbacksCount === 'number'
            ? result.data.deletedFeedbacksCount
            : 0;
          await markExternalEventDeleted(recordId, targetEvent);
          if (!silent) {
            alert(`å¤–éƒ¨äº‹ä»¶å·²åˆ é™¤ã€‚\nåˆ é™¤çš„å›è®¿è®°å½•æ•°é‡ï¼š${deletedCount} æ¡ã€‚`);
          } else {
            console.log(`äº‹ä»¶ ${recordId} å¤–éƒ¨è®°å½•å·²åˆ é™¤ï¼Œå›è®¿æ•° ${deletedCount}`);
          }
          if (!skipReload) {
            await loadEvents();
          } else {
            updateBulkButtons();
          }
          console.groupEnd();
          return { success: true };
        }

        if (result.code === 404) {
          await markExternalEventDeleted(recordId, targetEvent);
          if (!silent) {
            alert('å¤–éƒ¨äº‹ä»¶ä¸å­˜åœ¨ï¼Œå·²è§†ä¸ºåˆ é™¤çŠ¶æ€ã€‚');
          } else {
            console.log(`äº‹ä»¶ ${recordId} å¤–éƒ¨è®°å½•ä¸å­˜åœ¨ï¼Œå·²æ ‡è®°åˆ é™¤çŠ¶æ€`);
          }
          if (!skipReload) {
            await loadEvents();
          } else {
            updateBulkButtons();
          }
          console.groupEnd();
          return { success: true, note: 'not_found' };
        }

        const fallbackMessage = result.message || 'åˆ é™¤å¤–éƒ¨äº‹ä»¶å¤±è´¥ï¼Œäº‘è¡¨å•è¿”å›æœªçŸ¥çŠ¶æ€ã€‚';
        throw new Error(fallbackMessage);
      } catch (error) {
        console.error('åˆ é™¤å¤–éƒ¨äº‹ä»¶å¤±è´¥:', error);
        if (!silent) {
          alert('åˆ é™¤å¤–éƒ¨äº‹ä»¶å¤±è´¥ï¼š' + error.message);
        } else {
          console.warn('åˆ é™¤å¤–éƒ¨äº‹ä»¶å¤±è´¥ï¼ˆæ‰¹é‡æ¨¡å¼ï¼‰:', error);
        }
        if (throwOnError) {
          throw error;
        }
        return { success: false, error };
      } finally {
        if (deletingEventId) {
          updateDeleteButtonState(deletingEventId, { loading: false });
        }
        deletingEventId = null;
        if (console.groupEnd) {
          console.groupEnd();
        }
      }
    }

    async function bulkForwardEvents() {
      ensureBulkButtonRefs();
      const candidates = getBulkCandidates().forward;
      if (candidates.length === 0) {
        alert('æš‚æ— å¯è½¬å‘çš„äº‹ä»¶ã€‚');
        return;
      }
      if (!window.externalFormConfig || !window.externalFormConfig.features || window.externalFormConfig.features.enableForwarding !== true) {
        alert('å¤–éƒ¨è¡¨å•è½¬å‘åŠŸèƒ½æœªå¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
        return;
      }
      if (!confirm(`å°†è½¬å‘ ${candidates.length} ä¸ªæœªè½¬å‘äº‹ä»¶åˆ°å¤–éƒ¨è¡¨å•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
        return;
      }
      let success = 0;
      let failed = 0;
      for (let i = 0; i < candidates.length; i += 1) {
        setBulkButtonProcessing('forward', { total: candidates.length, completed: i, label: 'è½¬å‘ä¸­' });
        const event = candidates[i];
        try {
          await forwardAbsenceEvent(event.id, { silent: true, skipReload: true, throwOnError: true });
          success += 1;
        } catch (error) {
          failed += 1;
          console.warn('æ‰¹é‡è½¬å‘å¤±è´¥', event.id, error);
        }
        setBulkButtonProcessing('forward', { total: candidates.length, completed: i + 1, label: 'è½¬å‘ä¸­' });
        if (i < candidates.length - 1) {
          await delay(BULK_REQUEST_DELAY);
        }
      }
      await loadEvents();
      resetBulkButton('forward');
      updateBulkButtons();
      alert(`æ‰¹é‡è½¬å‘å®Œæˆï¼šæˆåŠŸ ${success} æ¡ï¼Œå¤±è´¥ ${failed} æ¡ã€‚`);
    }

    async function bulkFetchFollowUps() {
      ensureBulkButtonRefs();
      const candidates = getBulkCandidates().fetch;
      if (candidates.length === 0) {
        alert('æš‚æ— éœ€è¦æŠ“å–å›è®¿çš„äº‹ä»¶ã€‚');
        return;
      }
      if (!window.externalFormConfig || !window.externalFormConfig.apiBaseUrl) {
        alert('å¤–éƒ¨è¡¨å•ç³»ç»Ÿæœªé…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
        return;
      }
      if (window.externalFormConfig.features && window.externalFormConfig.features.enableFetching === false) {
        alert('å¤–éƒ¨è¡¨å•æŠ“å–åŠŸèƒ½æœªå¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
        return;
      }
      if (!confirm(`å°†ä¸º ${candidates.length} ä¸ªäº‹ä»¶æŠ“å–æœ€æ–°å›è®¿è®°å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
        return;
      }
      let success = 0;
      let failed = 0;
      for (let i = 0; i < candidates.length; i += 1) {
        setBulkButtonProcessing('fetch', { total: candidates.length, completed: i, label: 'æŠ“å–ä¸­' });
        const event = candidates[i];
        try {
          await fetchLatestFollowUp(event.id, { silent: true, skipReload: true, throwOnError: true });
          success += 1;
        } catch (error) {
          failed += 1;
          console.warn('æ‰¹é‡æŠ“å–å¤±è´¥', event.id, error);
        }
        setBulkButtonProcessing('fetch', { total: candidates.length, completed: i + 1, label: 'æŠ“å–ä¸­' });
        if (i < candidates.length - 1) {
          await delay(BULK_REQUEST_DELAY);
        }
      }
      await loadEvents();
      resetBulkButton('fetch');
      updateBulkButtons();
      alert(`æ‰¹é‡æŠ“å–å®Œæˆï¼šæˆåŠŸ ${success} æ¡ï¼Œå¤±è´¥ ${failed} æ¡ã€‚`);
    }

    async function bulkDeleteExternalEvents() {
      ensureBulkButtonRefs();
      const candidates = getBulkCandidates().delete;
      if (candidates.length === 0) {
        alert('æš‚æ— å¯åˆ é™¤çš„å¤–éƒ¨äº‹ä»¶ã€‚');
        return;
      }
      if (!window.externalFormConfig || !window.externalFormConfig.apiBaseUrl) {
        alert('å¤–éƒ¨è¡¨å•ç³»ç»Ÿæœªé…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
        return;
      }
      if (!confirm(`å°†åˆ é™¤ ${candidates.length} ä¸ªå¤–éƒ¨äº‹ä»¶åŠå…¶å›è®¿è®°å½•ï¼Œæ“ä½œä¸å¯æ’¤é”€ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
        return;
      }
      let success = 0;
      let failed = 0;
      for (let i = 0; i < candidates.length; i += 1) {
        setBulkButtonProcessing('delete', { total: candidates.length, completed: i, label: 'åˆ é™¤ä¸­' });
        const event = candidates[i];
        try {
          await deleteExternalEvent(event.id, { silent: true, skipReload: true, throwOnError: true, skipConfirm: true });
          success += 1;
        } catch (error) {
          failed += 1;
          console.warn('æ‰¹é‡åˆ é™¤å¤–éƒ¨äº‹ä»¶å¤±è´¥', event.id, error);
        }
        setBulkButtonProcessing('delete', { total: candidates.length, completed: i + 1, label: 'åˆ é™¤ä¸­' });
        if (i < candidates.length - 1) {
          await delay(BULK_REQUEST_DELAY);
        }
      }
      await loadEvents();
      resetBulkButton('delete');
      updateBulkButtons();
      alert(`æ‰¹é‡åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${success} æ¡ï¼Œå¤±è´¥ ${failed} æ¡ã€‚`);
    }

    async function markExternalEventDeleted(recordId, targetEvent) {
      const now = new Date().toISOString();
      const payload = {
        externalDeleted: true,
        externalDeletedAt: now,
        updatedAt: now
      };
      try {
        if (db) {
          await Promise.all([
            db.ref(`absenceEvents/${recordId}`).update(payload),
            db.ref(`trackingRecords/${recordId}`).update(payload)
          ]);
        }
      } catch (error) {
        console.warn('æ ‡è®°å¤–éƒ¨äº‹ä»¶å·²åˆ é™¤å¤±è´¥:', error);
      }
      if (targetEvent) {
        targetEvent.externalDeleted = true;
        targetEvent.externalDeletedAt = now;
      }
      const button = document.querySelector(`button[data-delete-id="${recordId}"]`);
      if (button) {
        button.dataset.externalDeleted = 'true';
        button.disabled = true;
        button.textContent = 'å·²åˆ å¤–éƒ¨äº‹ä»¶';
        button.classList.remove('deleting');
        button.classList.add('deleted');
        button.title = 'å¤–éƒ¨äº‹ä»¶å·²åˆ é™¤';
      }
      updateBulkButtons();
    }

    function openTrackingPage(memberUUID, recordId) {
      if (!memberUUID) {
        alert('å½“å‰äº‹ä»¶ç¼ºå°‘æˆå‘˜UUIDï¼Œæ— æ³•è·³è½¬åˆ°ä¸ªäººé¡µé¢ã€‚');
        return;
      }
      const url = new URL(window.location.origin + window.location.pathname);
      url.pathname = url.pathname.replace(/[^/]+$/, 'personal-page.html');
      url.searchParams.set('uuid', memberUUID);
      if (recordId) {
        url.searchParams.set('eventId', recordId);
      }
      const pageUrl = url.toString();
      const popup = window.open(pageUrl, '_blank');
      if (!popup) {
        alert('æµè§ˆå™¨å·²æ‹¦æˆªå¼¹å‡ºçª—å£ï¼Œè¯·å…è®¸åé‡è¯•ã€‚æ‚¨ä¹Ÿå¯ä»¥å¤åˆ¶ç²˜è´´æ­¤é“¾æ¥ï¼š\n' + pageUrl);
      } else {
        popup.opener = null;
      }
    }

    function toggleClosedEvents() {
      showClosed = !showClosed;
      const toggleBtn = document.getElementById('toggleClosedBtn');
      if (showClosed) {
        toggleBtn.textContent = 'éšè—å·²å…³é—­äº‹ä»¶';
        toggleBtn.classList.add('active');
        displayEvents(closedEvents);
        document.getElementById('eventCount').textContent = closedEvents.length;
      } else {
        toggleBtn.textContent = 'æ˜¾ç¤ºå·²å…³é—­äº‹ä»¶';
        toggleBtn.classList.remove('active');
        displayEvents(allEvents);
        document.getElementById('eventCount').textContent = allEvents.length;
      }
      document.getElementById('groupFilter').value = '';
      updateBulkButtons();
    }

    window.addEventListener('load', async () => {
      await initFirebase();
      await loadGroupNames();
      await loadEvents();
      ensureBulkButtonRefs();
      updateBulkButtons();
    });

    window.openTrackingPage = openTrackingPage;
    window.fetchLatestFollowUp = fetchLatestFollowUp;
    window.deleteExternalEvent = deleteExternalEvent;
    window.bulkForwardEvents = bulkForwardEvents;
    window.bulkFetchFollowUps = bulkFetchFollowUps;
    window.bulkDeleteExternalEvents = bulkDeleteExternalEvents;
  </script>
</body>
</html>

