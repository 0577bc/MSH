<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‰∫ã‰ª∂ÁÆ°ÁêÜ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    .controls {
      margin: 20px 0;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    button, .toggle-button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: white;
    }
    button:hover, .toggle-button:hover {
      background: #0056b3;
    }
    button:disabled, .toggle-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border: 1px solid #ddd;
    }
    th {
      background: #007bff;
      color: white;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
    tr:hover {
      background: #f0f0f0;
    }
    .track-btn {
      background: #17a2b8;
      margin-right: 8px;
    }
    .track-btn:hover {
      background: #138496;
    }
    .count-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
      min-width: 30px;
      text-align: center;
    }
    .count-2 {
      background: #ffc107;
      color: #000;
    }
    .count-3 {
      background: #ff9800;
      color: #fff;
    }
    .count-high {
      background: #f44336;
      color: #fff;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    .status-active {
      color: #28a745;
      font-weight: bold;
    }
    .filter {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    select {
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-width: 150px;
    }
    .toggle-button {
      background: #6c757d;
    }
    .toggle-button.active {
      background: #17a2b8;
    }
    .status-closed {
      color: #6c757d;
      font-weight: bold;
    }
    .action-cell {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .action-cell button {
      min-width: 90px;
      background: #6c757d;
    }
    .action-cell button:hover {
      background: #5a6268;
    }
    .action-cell button.close-btn {
      background: #dc3545;
    }
    .action-cell button.close-btn:hover {
      background: #b52a37;
    }
    .action-cell button.close-btn.disabled,
    .action-cell button.close-btn:disabled {
      background: #adb5bd;
      cursor: not-allowed;
    }
    .action-cell button.close-btn.disabled:hover,
    .action-cell button.close-btn:disabled:hover {
      background: #adb5bd;
    }
    .action-cell button.forward-btn {
      background: #17a2b8;
    }
    .action-cell button.forward-btn.forwarded {
      background: #20c997;
    }
    .action-cell button.forward-btn:disabled {
      background: #ffc107;
      color: #333;
    }
    .event-count {
      margin-left: auto;
    }
  </style>
</head>
<body>
  <h1>‰∫ã‰ª∂ÁÆ°ÁêÜ</h1>
  
  <div class="controls">
    <button onclick="window.location.href='summary.html'">ËøîÂõûÊ±áÊÄª</button>
    <button onclick="window.location.href='absence-tracking.html'">üìä Áº∫Âã§ËÆ∞ÂΩï</button>
    <button onclick="loadEvents()">Âà∑Êñ∞</button>
    <button id="toggleClosedBtn" class="toggle-button" onclick="toggleClosedEvents()">ÊòæÁ§∫Â∑≤ÂÖ≥Èó≠‰∫ã‰ª∂</button>
    
    <div class="filter">
      <label for="groupFilter">Á≠õÈÄâÂ∞èÁªÑ:</label>
      <select id="groupFilter" onchange="filterEvents()" aria-label="ÈÄâÊã©Â∞èÁªÑÁ≠õÈÄâ">
        <option value="">ÂÖ®ÈÉ®Â∞èÁªÑ</option>
      </select>
    </div>
    
    <span class="event-count">
      ÂÖ± <strong id="eventCount">0</strong> ‰∏™‰∫ã‰ª∂
    </span>
  </div>
  
  <table id="eventTable">
    <thead>
      <tr>
        <th>ÂßìÂêç</th>
        <th>ÁªÑÂà´</th>
        <th>Áº∫Âã§Ê¨°Êï∞</th>
        <th>Áº∫Âã§Âë®</th>
        <th>Áä∂ÊÄÅ</th>
        <th>Êìç‰Ωú</th>
      </tr>
    </thead>
    <tbody id="eventList">
      <tr>
        <td colspan="6" class="empty-state">Âä†ËΩΩ‰∏≠...</td>
      </tr>
    </tbody>
  </table>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script src="./src/smart-config-loader.js"></script>
  <script>
    let db;
    let allEvents = [];
    let closedEvents = [];
    let groupNames = {};
    let showClosed = false;
    let forwardingEventId = null;

    async function initFirebase() {
      let attempts = 0;
      while (!window.firebaseConfig && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      if (!window.firebaseConfig) {
        throw new Error('FirebaseÈÖçÁΩÆÂä†ËΩΩË∂ÖÊó∂');
      }
      if (!firebase.apps.length) {
        firebase.initializeApp(window.firebaseConfig);
      }
      db = firebase.database();
    }

    async function loadGroupNames() {
      const snapshot = await db.ref('groupNames').once('value');
      groupNames = snapshot.val() || {};
      const select = document.getElementById('groupFilter');
      Object.entries(groupNames).forEach(([key, name]) => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = name;
        select.appendChild(option);
      });
    }

    function normalizeEvent(recordId, rawEvent = {}, trackingRecord = {}) {
      const latestFollowUp = trackingRecord.latestFollowUp || rawEvent.latestFollowUp || null;
      const weeksSource = Array.isArray(trackingRecord.weeks)
        ? trackingRecord.weeks
        : Array.isArray(rawEvent.weeks)
          ? rawEvent.weeks
          : [];
      const weeks = [...new Set(weeksSource.filter(Boolean))].sort();
      const startDate = trackingRecord.startDate || rawEvent.startDate || weeks[0] || null;
      const endDate = trackingRecord.endDate || rawEvent.endDate || weeks[weeks.length - 1] || null;
      const status = trackingRecord.status || rawEvent.status || 'active';
      const memberSnapshot = trackingRecord.memberSnapshot || rawEvent.memberSnapshot || null;
      const createdAt = trackingRecord.createdAt || rawEvent.createdAt || new Date().toISOString();
      const updatedAt = trackingRecord.updatedAt || rawEvent.updatedAt || createdAt;
      const memberUUID = trackingRecord.memberUUID || rawEvent.memberUUID || null;
      const memberName = trackingRecord.memberName || rawEvent.memberName || 'Êú™Áü•ÊàêÂëò';
      const group = trackingRecord.group || rawEvent.group || '';
      const count = trackingRecord.count || rawEvent.count || weeks.length;

      return {
        id: recordId,
        recordId: rawEvent.recordId || trackingRecord.recordId || recordId,
        memberUUID,
        memberName,
        group,
        weeks,
        startDate,
        endDate,
        count,
        status,
        latestFollowUp,
        forwarded: rawEvent.forwarded || false,
        forwardDate: rawEvent.forwardDate || null,
        forwardStatus: rawEvent.forwardStatus || null,
        forwardResponse: rawEvent.forwardResponse || null,
        uuidMatchRequired: rawEvent.uuidMatchRequired || false,
        memberSnapshot,
        createdAt,
        updatedAt
      };
    }

    async function loadEvents() {
      try {
        const [eventsSnapshot, trackingSnapshot] = await Promise.all([
          db.ref('absenceEvents').once('value'),
          db.ref('trackingRecords').once('value')
        ]);
        const events = eventsSnapshot.val() || {};
        const trackingRecords = trackingSnapshot.val() || {};
        const allIds = new Set([
          ...Object.keys(events),
          ...Object.keys(trackingRecords)
        ]);

        const mappedEvents = Array.from(allIds)
          .map(recordId => normalizeEvent(recordId, events[recordId], trackingRecords[recordId]))
          .sort((a, b) => {
            if (a.group !== b.group) {
              return (a.group || '').localeCompare(b.group || '');
            }
            return (b.count || 0) - (a.count || 0);
          });

        allEvents = mappedEvents.filter(event => event.status === 'active');
        closedEvents = mappedEvents.filter(event => event.status !== 'active');

        const list = showClosed ? closedEvents : allEvents;
        displayEvents(list);
        document.getElementById('eventCount').textContent = list.length;
      } catch (error) {
        console.error('Âä†ËΩΩ‰∫ã‰ª∂Â§±Ë¥•:', error);
        alert('Âä†ËΩΩ‰∫ã‰ª∂Â§±Ë¥•: ' + error.message);
      }
    }

    function formatWeekLabel(dateStr) {
      if (!dateStr) {
        return 'Êú™Áü•';
      }
      const date = new Date(dateStr);
      if (Number.isNaN(date.getTime())) {
        return dateStr;
      }
      const month = date.getMonth() + 1;
      const week = Math.ceil(date.getDate() / 7);
      return `${month}Êúà${week}Âë®`;
    }

    function formatWeekRange(event) {
      if (Array.isArray(event.weeks) && event.weeks.length > 0) {
        const sortedWeeks = [...event.weeks];
        const startLabel = formatWeekLabel(sortedWeeks[0]);
        const endLabel = formatWeekLabel(sortedWeeks[sortedWeeks.length - 1]);
        return startLabel === endLabel ? startLabel : `${startLabel}-${endLabel}`;
      }
      const startLabel = formatWeekLabel(event.startDate);
      const endLabel = formatWeekLabel(event.endDate);
      if (!endLabel || endLabel === 'Êú™Áü•') {
        return startLabel;
      }
      return startLabel === endLabel ? startLabel : `${startLabel}-${endLabel}`;
    }

    function displayEvents(events) {
      const tbody = document.getElementById('eventList');
      if (events.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">ÊöÇÊó†Ë∑üË∏™‰∫ã‰ª∂</td></tr>';
        return;
      }

      tbody.innerHTML = events.map(event => {
        const groupName = groupNames[event.group] || event.group || 'Êú™ÂàÜÁªÑ';
        const countClass = event.count === 2 ? 'count-2' : (event.count === 3 ? 'count-3' : 'count-high');
        const weekRange = formatWeekRange(event);
        const isActive = event.status === 'active';
        const statusClass = isActive ? 'status-active' : 'status-closed';
        const statusLabel = isActive ? 'Ê¥ªË∑É' : 'Â∑≤ÂÖ≥Èó≠';
        const memberUUID = event.memberUUID || '';
        const latestFollowUpContent = event.latestFollowUp && typeof event.latestFollowUp.content === 'string'
          ? event.latestFollowUp.content.trim()
          : '';
        const hasFollowUp = latestFollowUpContent.length > 0;
        const trackButton = memberUUID
          ? `<button class="track-btn" onclick="openTrackingPage('${memberUUID}', '${event.id}')">Ë∑üË∏™</button>`
          : '';

        const isForwarded = event.forwarded === true;
        const forwardDateText = event.forwardDate ? new Date(event.forwardDate).toLocaleString('zh-CN') : '';
        const forwardTitle = isForwarded ? `Â∑≤‰∫é ${forwardDateText} ËΩ¨ÂèëÂà∞Â§ñÈÉ®Ë°®Âçï` : 'ËΩ¨ÂèëÂà∞Â§ñÈÉ®Ë°®Âçï';
        const isProcessing = forwardingEventId === event.id;
        const forwardLabel = isProcessing ? 'ËΩ¨Âèë‰∏≠...' : (isForwarded ? 'Â∑≤ËΩ¨Âèë' : 'ËΩ¨Âèë');
        const forwardClass = `forward-btn ${isForwarded ? 'forwarded' : ''}`;
        const forwardDisabledAttr = isProcessing ? 'disabled' : '';

        const forwardButton = `
          <button
            class="${forwardClass}"
            data-forward-id="${event.id}"
            data-forwarded="${isForwarded ? 'true' : 'false'}"
            title="${forwardTitle}"
            onclick="forwardAbsenceEvent('${event.id}')"
            ${forwardDisabledAttr}
          >
            ${forwardLabel}
          </button>
        `;

        const closeButton = isActive
          ? `<button class="close-btn${hasFollowUp ? '' : ' disabled'}" ${hasFollowUp ? `onclick="closeEvent('${event.id}')"` : 'disabled aria-disabled="true" title="ÈúÄÂÖàÂΩïÂÖ•ÂõûËÆø‰ø°ÊÅØÊâçÂèØÂÖ≥Èó≠‰∫ã‰ª∂"'}>ÂÖ≥Èó≠</button>`
          : '';

        return `
          <tr data-group="${event.group}">
            <td>${event.memberName}</td>
            <td>${groupName}</td>
            <td><span class="count-badge ${countClass}">${event.count}Ê¨°</span></td>
            <td>${weekRange}</td>
            <td><span class="${statusClass}">${statusLabel}</span></td>
            <td class="action-cell">${trackButton}${forwardButton}${closeButton}</td>
          </tr>
        `;
      }).join('');
    }

    function filterEvents() {
      const selectedGroup = document.getElementById('groupFilter').value;
      const source = showClosed ? closedEvents : allEvents;
      if (!selectedGroup) {
        displayEvents(source);
        document.getElementById('eventCount').textContent = source.length;
        return;
      }
      const filtered = source.filter(event => event.group === selectedGroup);
      displayEvents(filtered);
      document.getElementById('eventCount').textContent = filtered.length;
    }

    async function closeEvent(recordId) {
      const targetEvent = allEvents.find(event => event.id === recordId) || closedEvents.find(event => event.id === recordId);
      if (!targetEvent) {
        alert('Êú™ÊâæÂà∞‰∫ã‰ª∂ËÆ∞ÂΩïÔºåÊó†Ê≥ïÂÖ≥Èó≠');
        return;
      }
      const latestFollowUpContent = targetEvent.latestFollowUp && typeof targetEvent.latestFollowUp.content === 'string'
        ? targetEvent.latestFollowUp.content.trim()
        : '';
      if (!latestFollowUpContent) {
        alert('ËØ∑ÂÖàÂú®‰∏™‰∫∫‰∫ã‰ª∂È°µÈù¢ÂΩïÂÖ•ÊúâÊïàÁöÑÂõûËÆø‰ø°ÊÅØÂêéÂÜçÂÖ≥Èó≠‰∫ã‰ª∂„ÄÇ');
        return;
      }
      if (!confirm(`Á°ÆËÆ§ÂÖ≥Èó≠ ${targetEvent.memberName} ÁöÑÁº∫Âã§‰∫ã‰ª∂ÂêóÔºü`)) {
        return;
      }
      try {
        const today = new Date();
        const resolvedDate = today.toISOString().split('T')[0];
        const payload = {
          status: 'resolved',
          resolvedDate,
          updatedAt: today.toISOString()
        };
        await Promise.all([
          db.ref(`absenceEvents/${recordId}`).update(payload),
          db.ref(`trackingRecords/${recordId}`).update(payload)
        ]);
        alert('‰∫ã‰ª∂Â∑≤ÂÖ≥Èó≠');
        await loadEvents();
      } catch (error) {
        console.error('ÂÖ≥Èó≠‰∫ã‰ª∂Â§±Ë¥•:', error);
        alert('ÂÖ≥Èó≠‰∫ã‰ª∂Â§±Ë¥•: ' + error.message);
      }
    }

    function findEventById(recordId) {
      return allEvents.find(event => event.id === recordId)
        || closedEvents.find(event => event.id === recordId)
        || null;
    }

    function updateForwardButtonState(recordId, state) {
      const button = document.querySelector(`button[data-forward-id="${recordId}"]`);
      if (!button) {
        return;
      }
      const { loading = false, forwarded = null } = state || {};
      if (loading) {
        button.disabled = true;
        button.textContent = 'ËΩ¨Âèë‰∏≠...';
      } else {
        button.disabled = false;
        const isForwarded = forwarded !== null ? forwarded : button.dataset.forwarded === 'true';
        button.dataset.forwarded = isForwarded ? 'true' : 'false';
        button.textContent = isForwarded ? 'Â∑≤ËΩ¨Âèë' : 'ËΩ¨Âèë';
        if (isForwarded) {
          button.classList.add('forwarded');
        } else {
          button.classList.remove('forwarded');
        }
      }
    }

    async function getExternalFormToken() {
      if (!window.externalFormConfig || !window.externalFormConfig.apiBaseUrl) {
        throw new Error('Â§ñÈÉ®Ë°®ÂçïÁ≥ªÁªüÊú™ÈÖçÁΩÆÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò');
      }
      if (window.externalFormConfig.auth && window.externalFormConfig.auth.token) {
        return window.externalFormConfig.auth.token;
      }
      const response = await fetch(`${window.externalFormConfig.apiBaseUrl}${window.externalFormConfig.endpoints.login}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: window.externalFormConfig.auth.username,
          password: window.externalFormConfig.auth.password
        })
      });
      if (!response.ok) {
        throw new Error(`ÁôªÂΩïÂ§ñÈÉ®Ë°®ÂçïÁ≥ªÁªüÂ§±Ë¥•Ôºö${response.status}`);
      }
      const result = await response.json();
      const token = (result && (result.token || (result.data && result.data.token))) || null;
      if (!token) {
        throw new Error('Â§ñÈÉ®Ë°®ÂçïÁ≥ªÁªüÁôªÂΩïÂìçÂ∫îÁº∫Â∞ëtoken');
      }
      window.externalFormConfig.auth.token = token;
      if (result.data && result.data.user) {
        window.externalFormConfig.auth.user = result.data.user;
      }
      return token;
    }

    async function forwardAbsenceEvent(recordId) {
      try {
        const targetEvent = findEventById(recordId);
        if (!targetEvent) {
          alert('Êú™ÊâæÂà∞‰∫ã‰ª∂ËÆ∞ÂΩïÔºåÊó†Ê≥ïËΩ¨Âèë');
          return;
        }
        if (!window.externalFormConfig || !window.externalFormConfig.features || window.externalFormConfig.features.enableForwarding !== true) {
          alert('Â§ñÈÉ®Ë°®ÂçïËΩ¨ÂèëÂäüËÉΩÊú™ÂêØÁî®ÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò');
          return;
        }
        const memberUUID = targetEvent.memberUUID;
        if (!memberUUID) {
          alert('ÂΩìÂâç‰∫ã‰ª∂Áº∫Â∞ëÊàêÂëòUUIDÔºåËØ∑ÂÖàË°•ÈΩêÊàêÂëòUUIDÂêéÂÜçÂ∞ùËØïËΩ¨Âèë„ÄÇ');
          return;
        }
        if (targetEvent.forwarded === true) {
          const forwardDate = targetEvent.forwardDate ? new Date(targetEvent.forwardDate).toLocaleString('zh-CN') : 'Êú™Áü•Êó∂Èó¥';
          const confirmResend = confirm(`ËØ•‰∫ã‰ª∂Â∑≤‰∫é ${forwardDate} ËΩ¨ÂèëËøáÔºÅ\n\nÊòØÂê¶Ë¶ÅÈáçÊñ∞ËΩ¨ÂèëÔºü\n\nÁÇπÂáª"Á°ÆÂÆö"ÈáçÊñ∞ËΩ¨Âèë\nÁÇπÂáª"ÂèñÊ∂à"ÂèñÊ∂àÊìç‰Ωú`);
          if (!confirmResend) {
            return;
          }
        }
        if (forwardingEventId) {
          alert('Â∑≤ÊúâËΩ¨ÂèëÊìç‰ΩúÊ≠£Âú®ËøõË°åÔºåËØ∑Á®çÂÄôÂÜçËØï');
          return;
        }
        forwardingEventId = recordId;
        updateForwardButtonState(recordId, { loading: true });

        const token = await getExternalFormToken();
        const displayGroupName = targetEvent.groupDisplayName
          || groupNames[targetEvent.group]
          || targetEvent.group
          || 'Êú™Áü•ÁªÑÂà´';
        const weeks = Array.isArray(targetEvent.weeks) ? targetEvent.weeks : [];
        const startDate = targetEvent.startDate || (weeks.length > 0 ? weeks[0] : new Date().toISOString().split('T')[0]);
        const eventName = `${targetEvent.memberName || 'Êú™Áü•ÊàêÂëò'} ËøûÁª≠Áº∫Âã§ ${targetEvent.count || weeks.length} Ê¨°`;
        const detailPayload = {
          absenceEventId: recordId,
          memberName: targetEvent.memberName || 'Êú™Áü•ÊàêÂëò',
          memberUUID,
          group: displayGroupName,
          startDate,
          consecutiveAbsences: targetEvent.count || weeks.length,
          absenceWeeks: weeks,
          generatedAt: new Date().toISOString(),
          source: 'msh-absence-events'
        };

        const eventData = {
          name: eventName,
          description: `Ëá™Âä®ËΩ¨ÂèëÁöÑÁº∫Âã§‰∫ã‰ª∂Ôºö\n${JSON.stringify(detailPayload, null, 2)}`,
          event_date: startDate,
          status: 'active'
        };

        const response = await fetch(`${window.externalFormConfig.apiBaseUrl}${window.externalFormConfig.endpoints.submissions}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(eventData)
        });

        const resultText = await response.text();
        let result = {};
        try {
          result = JSON.parse(resultText);
        } catch (parseError) {
          console.warn('Êó†Ê≥ïËß£ÊûêÂ§ñÈÉ®Ë°®ÂçïÂìçÂ∫î', parseError);
        }

        if (response.status !== 201) {
          const errorMessage = (result && (result.message || result.error)) || resultText || 'Â§ñÈÉ®Ë°®ÂçïËøîÂõûÊú™Áü•ÈîôËØØ';
          throw new Error(`HTTP ${response.status}: ${errorMessage}`);
        }

        const now = new Date().toISOString();
        const updates = {
          forwarded: true,
          forwardDate: now,
          forwardStatus: 'pending',
          forwardResponse: result,
          uuidMatchRequired: true,
          updatedAt: now
        };
        await db.ref(`absenceEvents/${recordId}`).update(updates);
        Object.assign(targetEvent, updates);
        updateForwardButtonState(recordId, { loading: false, forwarded: true });
        alert('‰∫ã‰ª∂Â∑≤ÊàêÂäüËΩ¨ÂèëÂà∞Â§ñÈÉ®Ë°®ÂçïÔºåÁ≠âÂæÖUUIDÂåπÈÖçÁ°ÆËÆ§ÔºÅ');
        forwardingEventId = null;
        await loadEvents();
      } catch (error) {
        console.error('ËΩ¨ÂèëÂà∞Â§ñÈÉ®Ë°®ÂçïÂ§±Ë¥•:', error);
        alert('ËΩ¨ÂèëÂ§±Ë¥•Ôºö' + error.message);
        if (forwardingEventId) {
          updateForwardButtonState(forwardingEventId, { loading: false });
        }
      } finally {
        forwardingEventId = null;
      }
    }

    function openTrackingPage(memberUUID, recordId) {
      if (!memberUUID) {
        alert('ÂΩìÂâç‰∫ã‰ª∂Áº∫Â∞ëÊàêÂëòUUIDÔºåÊó†Ê≥ïË∑≥ËΩ¨Âà∞‰∏™‰∫∫È°µÈù¢„ÄÇ');
        return;
      }
      const url = new URL(window.location.origin + window.location.pathname);
      url.pathname = url.pathname.replace(/[^/]+$/, 'personal-page.html');
      url.searchParams.set('uuid', memberUUID);
      if (recordId) {
        url.searchParams.set('eventId', recordId);
      }
      const pageUrl = url.toString();
      const popup = window.open(pageUrl, '_blank');
      if (!popup) {
        alert('ÊµèËßàÂô®Â∑≤Êã¶Êà™ÂºπÂá∫Á™óÂè£ÔºåËØ∑ÂÖÅËÆ∏ÂêéÈáçËØï„ÄÇÊÇ®‰πüÂèØ‰ª•Â§çÂà∂Á≤òË¥¥Ê≠§ÈìæÊé•Ôºö\n' + pageUrl);
      } else {
        popup.opener = null;
      }
    }

    function toggleClosedEvents() {
      showClosed = !showClosed;
      const toggleBtn = document.getElementById('toggleClosedBtn');
      if (showClosed) {
        toggleBtn.textContent = 'ÈöêËóèÂ∑≤ÂÖ≥Èó≠‰∫ã‰ª∂';
        toggleBtn.classList.add('active');
        displayEvents(closedEvents);
        document.getElementById('eventCount').textContent = closedEvents.length;
      } else {
        toggleBtn.textContent = 'ÊòæÁ§∫Â∑≤ÂÖ≥Èó≠‰∫ã‰ª∂';
        toggleBtn.classList.remove('active');
        displayEvents(allEvents);
        document.getElementById('eventCount').textContent = allEvents.length;
      }
      document.getElementById('groupFilter').value = '';
    }

    window.addEventListener('load', async () => {
      await initFirebase();
      await loadGroupNames();
      await loadEvents();
    });

    window.openTrackingPage = openTrackingPage;
  </script>
</body>
</html>

