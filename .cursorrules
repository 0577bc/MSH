# MSH 签到系统 - Cursor AI 规则

## 🚨 强制执行规则（Mandatory Rules - 最高优先级）

**在执行任何操作前，必须先检查并遵守以下规则：**

### 🔴 P0级规则 - 系统识别（新增 2025-10-08）
**在执行任何操作前，必须先识别当前工作的系统**

**系统标识**:
- **MSH系统**: 路径 `/Users/benchen/MSH/` (不包含 `cloud-forms/`)
  - 技术栈: Firebase Realtime Database v8
  - 配置文件: `config.js`
  - 记录标识: [MSH]
  
- **云表单系统**: 路径 `/Users/benchen/MSH/cloud-forms/`
  - 技术栈: 阿里云 ECS + RDS MySQL
  - 配置文件: `cloud-forms/config.js`
  - 记录标识: [云表单]

**识别方法**:
1. 查看文件路径 → 包含 `cloud-forms/` = 云表单系统
2. 查看技术关键词 → `firebase` = MSH，`阿里云/MySQL` = 云表单
3. 查看功能模块 → 小组签到 = MSH，小家签到 = 云表单

**严禁操作**:
- ❌ 在云表单系统中使用Firebase
- ❌ 在MSH系统中使用阿里云MySQL
- ❌ 混用两个系统的配置文件
- ❌ 在记录中不标注系统标识

**详细规则**: [simple-memory-system/SYSTEM_CONTEXT.md](./simple-memory-system/SYSTEM_CONTEXT.md)

### 🔴 P0级规则 - 时间管理
**任何涉及时间的操作，必须先运行 `date +%Y-%m-%d` 命令获取当前系统时间**

- ✅ 使用刚刚获取的当前系统时间
- ❌ 严禁使用对话历史中的日期
- ❌ 严禁使用推测或记忆中的日期
- ❌ 严禁使用未来日期
- 📋 格式必须为：YYYY-MM-DD

**触发条件：**创建新文档、更新现有文档、记录进度、生成报告、任何包含日期的操作

### 🔴 P0级规则 - 数据安全
**任何数据覆盖操作必须用户多次确认，业务页面禁止使用set()覆盖全部数据**

- 🚨 检测到 `.ref().set()` 时必须立即警告
- 🚨 对话包含"覆盖Firebase"时必须多次确认
- ❌ 业务页面禁止全量同步
- ✅ 只能使用update()增量更新

### 🔴 P0级规则 - 文档管理
**禁止主动创建文档文件（.md），只有用户明确请求时才能创建新文档**

- ❌ 禁止主动创建 .md 文档
- ❌ 禁止主动创建 README 文件
- ❌ 禁止"善意"创建文档
- ✅ 只在用户明确请求时创建
- ✅ 优先在现有文档中扩展内容

**详细规则：** [MANDATORY_RULES.md](./MANDATORY_RULES.md)

### 🔴 P0级规则 - 共享函数修改保护（新增 2025-10-09）
**修改共享函数或数据结构时，必须先分析影响范围并获得用户确认**

**共享函数包括**：
- `new-data-manager.js` - 数据管理器
- `utils.js` - 工具函数
- 全局数据结构（groups, groupNames, attendanceRecords）
- 数据格式（memberSnapshot, groupSnapshot等）
- Firebase数据读写逻辑

**强制流程**：
1. 🔍 识别是否为共享函数
2. 📊 分析影响范围（列出所有使用该函数的页面）
3. ⚠️ 评估潜在风险
4. ✅ 获得用户确认
5. 🔧 执行修改
6. 📝 记录修改

**触发场景**：
- 修改 new-data-manager.js 中的任何函数
- 修改 utils.js 中的任何函数
- 修改数据结构（memberSnapshot, groupSnapshot）
- 修改Firebase读写逻辑
- 修改localStorage存储格式

**为什么重要**：2025-10-07数据覆盖事故的根本原因就是修改了共享的数据加载逻辑，但未考虑对其他功能的影响，导致几百条历史记录丢失。

**详细规则：** [MANDATORY_RULES.md](./MANDATORY_RULES.md)

### 🔴 P0级规则 - 代码修复前强制检查（新增 2025-11-05）
**在执行任何代码修复前，必须先完成以下检查，避免重复实现已有功能**

**1. 代码探索（必须执行）**
- [ ] **多维度关键词搜索**
  - 使用 `codebase_search` 搜索功能关键词（包括同义词、近义词）
  - 使用 `grep -r "关键词"` 搜索函数名模式
  - 搜索变量名、类名等所有相关标识符
  - 示例：修复"缺勤计算"时，应搜索 `calculate`, `absence`, `tracking`, `连续缺勤` 等

- [ ] **查看相关工具类/管理器的完整API**
  - 使用 `grep -A 50 "class\|object\|Manager\|Utils"` 查看完整定义
  - 列出所有可用方法和函数
  - 确认是否有现成的函数可以调用
  - 示例：修复主日跟踪时，应先查看 `SundayTrackingManager` 的所有方法

- [ ] **查看函数调用关系**
  - 使用 `grep -r "functionName"` 查找所有调用位置
  - 理解数据流向和函数依赖关系
  - 确认函数是否已在其他地方使用

**2. 现有功能检查（必须执行）**
- [ ] **确认是否有已存在的类似功能**
  - 搜索是否有相同或相似功能的函数
  - 检查是否有现成的解决方案
  - 查看历史修复记录和相关文档

- [ ] **确认是否可以通过调用现有函数解决**
  - 优先使用现有功能，避免重复实现
  - 评估是否可以通过组合现有函数解决问题
  - 确认是否需要修改还是直接调用

**3. 方案设计（必须执行）**
- [ ] **优先使用现有功能**
  - 如果已有相同功能，直接使用，不要重新实现
  - 如果功能相似，考虑扩展现有功能而非新建
  - 复用优于重写

- [ ] **最小化修改原则**
  - 只修改必要的部分
  - 避免大范围重构
  - 保持代码简洁

- [ ] **维护成本评估**
  - 评估修改后的维护成本
  - 考虑代码复杂度和可读性
  - 确保修改不会增加系统复杂度

**违反后果**:
- 如果跳过代码探索步骤，可能导致：
  - ❌ 重复实现已有功能（如本次的 `calculateConsecutiveAbsences`）
  - ❌ 代码复杂度增加（200+行 vs 20+行）
  - ❌ 维护成本上升
  - ❌ 系统不稳定

**执行检查**:
在执行代码修复前，必须先完成以上所有检查项，并在对话中明确说明：
1. 搜索了哪些关键词
2. 查看了哪些工具类的API
3. 发现了哪些现有功能
4. 为什么选择当前的实现方案

**详细规则**: [docs/reports/MEMORY_SYSTEM_EFFECTIVENESS_ANALYSIS_2025-11-05.md](./docs/reports/MEMORY_SYSTEM_EFFECTIVENESS_ANALYSIS_2025-11-05.md)

### 🟡 P1级规则 - 代码修改验证
**任何涉及代码修改的操作，必须遵循"分析-确认-执行"三步流程**

**重要说明**：
- 🔍 **检查/诊断操作** → 可以直接执行，不需要确认
- ⚠️ **修改代码操作** → 必须先分析、等确认、再执行

**标准流程**：
- 📊 先提供分析报告（影响范围、修改方案、风险评估）
- ✅ 等待用户确认
- 🔧 确认后再执行修改

**适用场景：**多文件修改、关键逻辑修改、跨模块修改、架构调整、性能优化、Bug修复

**详细规则：** [MANDATORY_RULES.md](./MANDATORY_RULES.md)

---

## 项目上下文文件
请始终参考以下文件来理解项目上下文：

1. **MANDATORY_RULES.md** - 🚨 强制执行规则（最高优先级）
2. **PROJECT-OVERVIEW.md** - 项目概述、技术栈、架构决策
3. **DESIGN-SYSTEM.json** - 编码规范、命名约定、UI模式
4. **CONTEXT-RULES.md** - AI行为指导、开发规范、质量要求
5. **cursorworkflow/WORKFLOW-STATE.md** - 当前任务状态、执行计划

## 外部记忆系统集成
请参考以下文件来使用智能记忆系统：

1. **simple-memory-system/progress.md** - 项目进度记录（精简版，重点关注）
2. **simple-memory-system/cloud-essential.md** - 核心触发规则（P0/P1级，日常必读）
3. **simple-memory-system/cloud.md** - 完整触发规则（特殊场景参考）
4. **simple-memory-system/memory.json** - 用户偏好学习数据
5. **simple-memory-system/archive.md** - 历史归档记录（查询历史）

## 核心原则

### 代码生成
- 生成完整可运行的代码，禁止使用 TODO 或占位符
- 遵循 DESIGN-SYSTEM.json 中的命名规范和代码风格
- 所有异步操作必须包含 try-catch 错误处理
- 使用中文注释，详细说明功能

### 项目特性
- 这是一个基于 Firebase 的 PWA 签到管理系统
- 支持多小组管理，使用 UUID 系统
- 保持 Firebase SDK v8 兼容性
- 维护 PWA 功能完整性

### 文件操作
- 使用绝对路径 `/Users/benchen/MSH/` 作为根目录
- 优先在现有文件中扩展功能，避免创建过多新文件
- 重要修改前检查备份

### 工作流集成
- 在开始任务前，读取 WORKFLOW-STATE.md 了解当前状态
- 完成任务后，更新 WORKFLOW-STATE.md 记录进度
- 使用"读-解-行-更"循环进行自主工作

## 常用提示模板

### 开始新任务
```
启动自主工作流：目标[具体任务描述]，参考 PROJECT-OVERVIEW.md 中的架构决策，遵循 DESIGN-SYSTEM.json 中的编码规范。
```

### 代码修改
```
基于 DESIGN-SYSTEM.json，修改 [具体功能]，参考 [相关文件] 的现有模式，确保遵循 CONTEXT-RULES.md 中的开发规范。
```

### 问题解决
```
遇到问题：先读取 WORKFLOW-STATE.md 了解当前状态，然后参考 CONTEXT-RULES.md 中的错误处理原则，提供解决方案。
```

## 技术栈提醒
- **前端**: HTML5, CSS3, JavaScript (ES6+)
- **后端**: Firebase Realtime Database v8
- **PWA**: Service Worker, Manifest
- **部署**: 静态文件服务器

## 质量要求
- 所有代码必须完整可运行
- 保持现有功能兼容性
- 遵循无障碍设计原则
- 考虑移动端和桌面端兼容性

## 安全考虑
- 使用现有的 CSRF 保护机制
- 验证所有用户输入
- 遵循 Firebase 安全规则
- 保护敏感数据

---

**版本**: 1.3  
**创建日期**: 2025-09-27  
**最后更新**: 2025-11-05  
**适用项目**: MSH 签到系统

**更新说明**：
- v1.3 (2025-11-05): 添加P0级规则 - 代码修复前强制检查，避免重复实现已有功能
- v1.2 (2025-10-08): 完善P1级规则，明确诊断操作可直接执行
- v1.1 (2025-10-08): 添加P0/P1级规则
- v1.0 (2025-09-27): 初始版本