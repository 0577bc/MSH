<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸»æ—¥ç¼ºå‹¤è®°å½•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    .controls {
      margin: 20px 0;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: white;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .calc-btn {
      background: #28a745;
    }
    .calc-btn:hover {
      background: #218838;
    }
    .event-btn {
      background: #ff9800;
    }
    .event-btn:hover {
      background: #f57c00;
    }
    .result-panel {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
    }
    .stat-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }
    .stat-label {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
    }
    .group-section {
      margin-bottom: 20px;
      border-left: 4px solid #2196f3;
      padding-left: 15px;
    }
    .group-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    .member-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .member-tag {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      color: white;
    }
    .placeholder-text {
      text-align: center;
      color: #999;
    }
    .tag-1 { background: #9e9e9e; }
    .tag-2 { background: #ffc107; }
    .tag-3 { background: #ff9800; }
    .tag-high { background: #f44336; }
  </style>
</head>
<body>
  <h1>ä¸»æ—¥ç¼ºå‹¤è®°å½•</h1>
  
  <div class="controls">
    <button onclick="window.location.href='summary.html'">è¿”å›æ±‡æ€»</button>
    <button id="refreshLatestButton" class="calc-btn">åˆ·æ–°æœ€æ–°æ•°æ®</button>
    <button class="event-btn" onclick="window.location.href='absence-events.html'">ğŸ“‹ äº‹ä»¶ç®¡ç†</button>
  </div>
  
  <!-- æœ¬å‘¨è®¡ç®—ç»“æœ -->
  <div class="result-panel" id="currentWeekPanel">
    <h2>æœ¬å‘¨è®¡ç®—ç»“æœ</h2>
    <div id="currentWeekContent">
      <p class="placeholder-text">ç‚¹å‡»"åˆ·æ–°æœ€æ–°æ•°æ®"æŒ‰é’®æŸ¥çœ‹</p>
    </div>
  </div>
  
  <!-- ä¸Šå‘¨è®¡ç®—ç»“æœ -->
  <div class="result-panel" id="lastWeekPanel">
    <h2>ä¸Šå‘¨è®¡ç®—ç»“æœ</h2>
    <div id="lastWeekContent">
      <p class="placeholder-text">ç‚¹å‡»"åˆ·æ–°æœ€æ–°æ•°æ®"æŒ‰é’®æŸ¥çœ‹</p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script src="./src/smart-config-loader.js"></script>
  <script>
    let db;
    let groupNames = {};
    let memberMap = { members: [], nameToUuid: {}, uuidToMember: {} };
    
    async function initFirebase() {
      let attempts = 0;
      while (!window.firebaseConfig && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      if (!window.firebaseConfig) {
        throw new Error('Firebaseé…ç½®åŠ è½½è¶…æ—¶');
      }
      if (!firebase.apps.length) {
        firebase.initializeApp(window.firebaseConfig);
      }
      db = firebase.database();
      console.log('Firebaseåˆå§‹åŒ–æˆåŠŸ');
    }
    
    async function loadGroupNames() {
      const snapshot = await db.ref('groupNames').once('value');
      groupNames = snapshot.val() || {};
    }

    function buildMemberMap(groups) {
      const members = [];
      const nameToUuid = {};
      const uuidToMember = {};
      Object.entries(groups || {}).forEach(([groupKey, groupMembers]) => {
        if (!Array.isArray(groupMembers)) {
          return;
        }
        groupMembers.forEach(member => {
          if (!member || member.excluded) {
            return;
          }
          const uuid = member.uuid || member.memberUUID || member.id || member.name;
          if (!uuid) {
            return;
          }
          const name = member.name || member.nickname || uuid;
          members.push({ uuid, name, group: groupKey });
          uuidToMember[uuid] = { uuid, name, group: groupKey };
          if (name) {
            nameToUuid[name] = uuid;
          }
          const nickname = member.nickname || member.alias || member.èŠ±å;
          if (nickname) {
            nameToUuid[nickname] = uuid;
          }
        });
      });
      return { members, nameToUuid, uuidToMember };
    }

    function resolveAttendanceUUID(record) {
      if (!record) {
        return null;
      }
      if (record.memberUUID) {
        return record.memberUUID;
      }
      if (record.memberSnapshot && record.memberSnapshot.uuid) {
        return record.memberSnapshot.uuid;
      }
      const candidates = [
        record.memberName,
        record.name,
        record.memberSnapshot && record.memberSnapshot.name,
        record.memberSnapshot && record.memberSnapshot.nickname,
        record.memberSnapshot && record.memberSnapshot.èŠ±å,
        record.nickname,
        record.alias
      ];
      for (const candidate of candidates) {
        if (candidate && memberMap.nameToUuid[candidate]) {
          return memberMap.nameToUuid[candidate];
        }
      }
      return null;
    }

    function getLatestSunday() {
      const today = new Date();
      const day = today.getDay();
      const diff = day === 0 ? 0 : -day;
      const sunday = new Date(today);
      sunday.setDate(today.getDate() + diff);
      return sunday.toISOString().split('T')[0];
    }
    
    function getPreviousSunday(dateStr) {
      const date = new Date(dateStr);
      date.setDate(date.getDate() - 7);
      return date.toISOString().split('T')[0];
    }
    
    async function fetchAttendanceCount(sundayDate) {
      const snapshot = await db.ref('attendanceRecords')
        .orderByChild('date')
        .equalTo(sundayDate)
        .once('value');
      if (!snapshot.exists()) {
        return 0;
      }
      const signedUUIDs = new Set();
      snapshot.forEach(child => {
        const uuid = resolveAttendanceUUID(child.val());
        if (uuid) {
          signedUUIDs.add(uuid);
        }
      });
      return signedUUIDs.size;
    }

    async function fetchAbsenceCalc(sundayDate) {
      const snapshot = await db.ref(`absenceCalc/${sundayDate}`).once('value');
      return snapshot.val() || {};
    }

    function buildAbsenceByGroup(calcResult) {
      const absenceByGroup = {};
      Object.entries(calcResult).forEach(([uuid, data]) => {
        const groupKey = data.group || (memberMap.uuidToMember[uuid] && memberMap.uuidToMember[uuid].group) || 'æœªåˆ†ç»„';
        if (!absenceByGroup[groupKey]) {
          absenceByGroup[groupKey] = [];
        }
        absenceByGroup[groupKey].push({
          name: data.name || (memberMap.uuidToMember[uuid] && memberMap.uuidToMember[uuid].name) || uuid,
          count: data.count || 0
        });
      });
      Object.values(absenceByGroup).forEach(members => {
        members.sort((a, b) => {
          if (a.count !== b.count) {
            return b.count - a.count;
          }
          return a.name.localeCompare(b.name, 'zh-Hans');
        });
      });
      return absenceByGroup;
    }

    function getTagClass(count) {
      if (count <= 1) {
        return 'tag-1';
      }
      if (count === 2) {
        return 'tag-2';
      }
      if (count === 3) {
        return 'tag-3';
      }
      return 'tag-high';
    }

    function displayCalcResult(sundayDate, calcResult, signedCount, targetDiv) {
      const absenceCount = Object.keys(calcResult).length;
      const totalMembers = memberMap.members.length;
      let html = `
        <div class="stat-cards">
          <div class="stat-card">
            <div class="stat-label">æ—¥æœŸ</div>
            <div class="stat-value" style="color: #2196f3; font-size: 24px;">${sundayDate}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ç­¾åˆ°äººæ•°</div>
            <div class="stat-value" style="color: #28a745;">${signedCount}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ç¼ºå‹¤äººæ•°</div>
            <div class="stat-value" style="color: #f44336;">${absenceCount}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">æ€»æˆå‘˜</div>
            <div class="stat-value" style="color: #666;">${totalMembers}</div>
          </div>
        </div>
      `;
      
      const absenceByGroup = buildAbsenceByGroup(calcResult);
      const sortedGroups = Object.keys(absenceByGroup).sort((a, b) => (groupNames[a] || a).localeCompare(groupNames[b] || b, 'zh-Hans'));
      if (sortedGroups.length === 0) {
        html += '<p style="text-align: center; color: #28a745; font-size: 18px; margin-top: 20px;">ğŸ‰ æœ¬å‘¨å…¨å‘˜ç­¾åˆ°ï¼</p>';
      } else {
        html += '<div style="margin-top: 20px;">';
        sortedGroups.forEach(groupKey => {
          const groupName = groupNames[groupKey] || groupKey;
          const members = absenceByGroup[groupKey];
          html += `
            <div class="group-section">
              <div class="group-title">${groupName} (${members.length}äºº)</div>
              <div class="member-tags">
          `;
          members.forEach(member => {
            html += `<span class="member-tag ${getTagClass(member.count)}">${member.name} (${member.count}æ¬¡)</span>`;
          });
          html += '</div></div>';
        });
        html += '</div>';
      }
      
      targetDiv.innerHTML = html;
    }
    
    async function loadWeekResult(sundayDate, targetDivId) {
      try {
        const [calcResult, signedCount] = await Promise.all([
          fetchAbsenceCalc(sundayDate),
          fetchAttendanceCount(sundayDate)
        ]);
        const targetDiv = document.getElementById(targetDivId);
        if (!targetDiv) {
          return;
        }
        displayCalcResult(sundayDate, calcResult, signedCount, targetDiv);
      } catch (error) {
        console.error('åŠ è½½è®¡ç®—ç»“æœå¤±è´¥:', error);
        const targetDiv = document.getElementById(targetDivId);
        if (targetDiv) {
          targetDiv.innerHTML = `<p style="color: red;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
        }
      }
    }

    async function refreshLatestData(event) {
      const button = event && event.currentTarget;
      if (button) {
        button.disabled = true;
        button.textContent = 'åˆ·æ–°ä¸­...';
      }
      try {
        const latestSunday = getLatestSunday();
        const prevSunday = getPreviousSunday(latestSunday);
        await loadWeekResult(latestSunday, 'currentWeekContent');
        await loadWeekResult(prevSunday, 'lastWeekContent');
        if (!memberMap.members.length) {
          const groupsSnapshot = await db.ref('groups').once('value');
          memberMap = buildMemberMap(groupsSnapshot.val() || {});
        }
      } catch (error) {
        console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
        alert('åˆ·æ–°å¤±è´¥: ' + error.message);
      } finally {
        if (button) {
          button.disabled = false;
          button.textContent = 'åˆ·æ–°æœ€æ–°æ•°æ®';
        }
      }
    }

    window.addEventListener('load', async () => {
      await initFirebase();
      await loadGroupNames();
      const groupsSnapshot = await db.ref('groups').once('value');
      memberMap = buildMemberMap(groupsSnapshot.val() || {});
      await refreshLatestData();
      const refreshButton = document.getElementById('refreshLatestButton');
      if (refreshButton) {
        refreshButton.addEventListener('click', refreshLatestData);
      }
    });
  </script>
</body>
</html>
