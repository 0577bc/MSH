<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â° ä¿®å¤æ—¶é—´æ ¼å¼å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }

        .alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .stats {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stats.active {
            display: grid;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            margin: 10px 0;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 20px 0;
        }

        .log-entry {
            margin: 5px 0;
        }

        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .log-info { color: #3498db; }

        #progress {
            display: none;
        }

        #progress.active {
            display: block;
        }

        .progress-bar {
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>â° æ—¶é—´æ ¼å¼ä¿®å¤å·¥å…·</h1>

        <div class="alert">
            <h3>âš ï¸ é—®é¢˜è¯Šæ–­</h3>
            <p><strong>é—®é¢˜ï¼š</strong>å¤‡ä»½æ•°æ®ä¸­çš„timeå­—æ®µæ ¼å¼ä¸º <code>"2025/8/1 09:55:00"</code></p>
            <p><strong>éœ€è¦ï¼š</strong>è½¬æ¢ä¸ºæ—¶é—´æˆ³æ ¼å¼ï¼ˆæ¯«ç§’ï¼‰æˆ–ISOå­—ç¬¦ä¸²æ ¼å¼</p>
            <p><strong>å½±å“ï¼š</strong>æ—¥æŠ¥è¡¨å’Œç­¾åˆ°è®°å½•é¡µé¢æ— æ³•æ­£ç¡®æŸ¥è¯¢æ•°æ®</p>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalRecords">0</div>
                <div class="stat-label">æ€»è®°å½•æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="fixedRecords">0</div>
                <div class="stat-label">å·²ä¿®å¤è®°å½•</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="errorRecords">0</div>
                <div class="stat-label">é”™è¯¯è®°å½•</div>
            </div>
        </div>

        <div id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <button class="btn-primary" onclick="checkAndFixLocalStorage()">
            ğŸ” æ£€æŸ¥å¹¶ä¿®å¤æœ¬åœ°å­˜å‚¨æ•°æ®
        </button>

        <button class="btn-success" onclick="checkAndFixFirebase()">
            â˜ï¸ æ£€æŸ¥å¹¶ä¿®å¤Firebaseæ•°æ®
        </button>

        <div class="log" id="log"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="../../src/smart-config-loader.js"></script>

    <script>
        let db = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateProgress(percent) {
            const progressDiv = document.getElementById('progress');
            const progressFill = document.getElementById('progressFill');
            progressDiv.classList.add('active');
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
        }

        function updateStats(total, fixed, errors) {
            document.getElementById('stats').classList.add('active');
            document.getElementById('totalRecords').textContent = total;
            document.getElementById('fixedRecords').textContent = fixed;
            document.getElementById('errorRecords').textContent = errors;
        }

        // è½¬æ¢æ—¶é—´æ ¼å¼
        function convertTimeFormat(timeStr) {
            // å¦‚æœå·²ç»æ˜¯æ•°å­—ï¼ˆæ—¶é—´æˆ³ï¼‰ï¼Œç›´æ¥è¿”å›
            if (typeof timeStr === 'number') {
                return timeStr;
            }

            // å¦‚æœå·²ç»æ˜¯ISOæ ¼å¼ï¼Œè½¬æ¢ä¸ºæ—¶é—´æˆ³
            if (timeStr.includes('T') && timeStr.includes('Z')) {
                return new Date(timeStr).getTime();
            }

            // å¤„ç† "2025/8/1 09:55:00" æ ¼å¼
            if (timeStr.includes('/')) {
                // æ›¿æ¢ä¸ºæ ‡å‡†æ ¼å¼
                const standardFormat = timeStr.replace(/\//g, '-');
                // ç¡®ä¿æœˆæ—¥éƒ½æ˜¯ä¸¤ä½æ•°
                const parts = standardFormat.split(' ');
                const dateParts = parts[0].split('-');
                const year = dateParts[0];
                const month = dateParts[1].padStart(2, '0');
                const day = dateParts[2].padStart(2, '0');
                const time = parts[1];
                
                const dateStr = `${year}-${month}-${day}T${time}`;
                const timestamp = new Date(dateStr).getTime();
                
                if (isNaN(timestamp)) {
                    throw new Error(`æ— æ³•è½¬æ¢æ—¶é—´: ${timeStr}`);
                }
                
                return timestamp;
            }

            throw new Error(`æœªçŸ¥æ—¶é—´æ ¼å¼: ${timeStr}`);
        }

        // æ£€æŸ¥å¹¶ä¿®å¤æœ¬åœ°å­˜å‚¨æ•°æ®
        function checkAndFixLocalStorage() {
            log('ğŸ” å¼€å§‹æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ•°æ®...', 'info');
            
            const localData = localStorage.getItem('msh_attendanceRecords');
            if (!localData) {
                log('âŒ æœ¬åœ°å­˜å‚¨æ— æ•°æ®', 'error');
                alert('æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰ç­¾åˆ°è®°å½•ï¼');
                return;
            }

            try {
                const records = JSON.parse(localData);
                log(`ğŸ“Š æ‰¾åˆ° ${records.length} æ¡è®°å½•`, 'info');

                let totalRecords = records.length;
                let fixedCount = 0;
                let errorCount = 0;

                const fixedRecords = records.map((record, index) => {
                    if (index % 50 === 0) {
                        updateProgress(Math.round((index / totalRecords) * 100));
                    }

                    try {
                        const originalTime = record.time;
                        const timestamp = convertTimeFormat(originalTime);
                        
                        if (timestamp !== originalTime) {
                            fixedCount++;
                            return {
                                ...record,
                                time: timestamp
                            };
                        }
                        
                        return record;
                    } catch (error) {
                        errorCount++;
                        log(`âš ï¸ è®°å½•${index}è½¬æ¢å¤±è´¥: ${error.message}`, 'warning');
                        return record;
                    }
                });

                updateProgress(100);
                updateStats(totalRecords, fixedCount, errorCount);

                if (fixedCount > 0) {
                    // ä¿å­˜ä¿®å¤åçš„æ•°æ®
                    localStorage.setItem('msh_attendanceRecords', JSON.stringify(fixedRecords));
                    window.attendanceRecords = fixedRecords;
                    
                    log(`âœ… æˆåŠŸä¿®å¤ ${fixedCount} æ¡è®°å½•`, 'success');
                    log(`âœ… å·²æ›´æ–°æœ¬åœ°å­˜å‚¨å’Œå…¨å±€å˜é‡`, 'success');
                    alert(`âœ… æˆåŠŸä¿®å¤ ${fixedCount} æ¡è®°å½•ï¼\né”™è¯¯ï¼š${errorCount} æ¡`);
                } else {
                    log('âœ… æ‰€æœ‰è®°å½•æ ¼å¼æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤', 'success');
                    alert('æ‰€æœ‰è®°å½•æ ¼å¼æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤ï¼');
                }

            } catch (error) {
                log(`âŒ å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                alert('å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        // æ£€æŸ¥å¹¶ä¿®å¤Firebaseæ•°æ®
        async function checkAndFixFirebase() {
            if (!db) {
                log('âŒ Firebaseæœªè¿æ¥', 'error');
                alert('Firebaseæœªè¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
                return;
            }

            log('ğŸ” å¼€å§‹æ£€æŸ¥Firebaseæ•°æ®...', 'info');

            try {
                const snapshot = await db.ref('attendanceRecords').once('value');
                const data = snapshot.val();

                if (!data) {
                    log('âŒ Firebaseæ— æ•°æ®', 'error');
                    alert('Firebaseä¸­æ²¡æœ‰ç­¾åˆ°è®°å½•ï¼');
                    return;
                }

                const records = Array.isArray(data) ? data : Object.values(data);
                log(`ğŸ“Š æ‰¾åˆ° ${records.length} æ¡è®°å½•`, 'info');

                let totalRecords = records.length;
                let fixedCount = 0;
                let errorCount = 0;

                const fixedRecords = records.map((record, index) => {
                    if (index % 50 === 0) {
                        updateProgress(Math.round((index / totalRecords) * 100));
                    }

                    try {
                        const originalTime = record.time;
                        const timestamp = convertTimeFormat(originalTime);
                        
                        if (timestamp !== originalTime) {
                            fixedCount++;
                            return {
                                ...record,
                                time: timestamp
                            };
                        }
                        
                        return record;
                    } catch (error) {
                        errorCount++;
                        log(`âš ï¸ è®°å½•${index}è½¬æ¢å¤±è´¥: ${error.message}`, 'warning');
                        return record;
                    }
                });

                updateProgress(100);
                updateStats(totalRecords, fixedCount, errorCount);

                if (fixedCount > 0) {
                    const confirm = window.confirm(`âš ï¸ ç¡®å®šè¦ä¿®å¤ ${fixedCount} æ¡è®°å½•å¹¶åŒæ­¥åˆ°Firebaseå—ï¼Ÿ`);
                    if (!confirm) {
                        log('âŒ ç”¨æˆ·å–æ¶ˆæ“ä½œ', 'warning');
                        return;
                    }

                    // ä¿å­˜åˆ°Firebase
                    await db.ref('attendanceRecords').set(fixedRecords);
                    
                    // åŒæ—¶æ›´æ–°æœ¬åœ°
                    localStorage.setItem('msh_attendanceRecords', JSON.stringify(fixedRecords));
                    window.attendanceRecords = fixedRecords;
                    
                    log(`âœ… æˆåŠŸä¿®å¤å¹¶åŒæ­¥ ${fixedCount} æ¡è®°å½•`, 'success');
                    alert(`âœ… æˆåŠŸä¿®å¤ ${fixedCount} æ¡è®°å½•ï¼\né”™è¯¯ï¼š${errorCount} æ¡`);
                } else {
                    log('âœ… æ‰€æœ‰è®°å½•æ ¼å¼æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤', 'success');
                    alert('æ‰€æœ‰è®°å½•æ ¼å¼æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤ï¼');
                }

            } catch (error) {
                log(`âŒ å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                alert('å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        // åˆå§‹åŒ–Firebase
        window.addEventListener('load', () => {
            try {
                if (typeof firebase !== 'undefined' && window.firebaseConfig) {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(window.firebaseConfig);
                    }
                    db = firebase.database();
                    log('âœ… Firebaseåˆå§‹åŒ–æˆåŠŸ', 'success');
                } else {
                    log('âš ï¸ Firebaseé…ç½®æœªæ‰¾åˆ°', 'warning');
                }
            } catch (error) {
                log(`âŒ Firebaseåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }

            log('ç³»ç»Ÿå°±ç»ªï¼Œè¯·é€‰æ‹©æ“ä½œ', 'info');
        });
    </script>
</body>
</html>


