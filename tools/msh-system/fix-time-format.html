<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â° æ—¶é—´æ ¼å¼ & æ—¶åŒºä¿®å¤å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }

        .alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .stats {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stats.active {
            display: grid;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            margin: 10px 0;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 20px 0;
        }

        .log-entry {
            margin: 5px 0;
        }

        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .log-info { color: #3498db; }

        #progress {
            display: none;
        }

        #progress.active {
            display: block;
        }

        .progress-bar {
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>â° æ—¶é—´æ ¼å¼ & æ—¶åŒºä¿®å¤å·¥å…·</h1>

        <div class="alert">
            <h3>ğŸ› ï¸ å·¥å…·åŠŸèƒ½</h3>
            <p><strong>åŠŸèƒ½1ï¼š</strong>ä¿®å¤timeå­—æ®µæ ¼å¼ï¼ˆ<code>"2025/8/1 09:55:00"</code> â†’ æ—¶é—´æˆ³æˆ–ISOæ ¼å¼ï¼‰</p>
            <p><strong>åŠŸèƒ½2ï¼š</strong>ä¿®å¤dateå­—æ®µæ—¶åŒºé—®é¢˜ï¼ˆUTCæ—¶åŒº â†’ æœ¬åœ°æ—¶åŒºï¼ŒYYYY-MM-DDæ ¼å¼ï¼‰</p>
            <p><strong>è¯´æ˜ï¼š</strong>2025-10-10å‰çš„è®°å½•å¯èƒ½å­˜åœ¨æ—¶åŒºé—®é¢˜ï¼Œå‡Œæ™¨ç­¾åˆ°è¢«é”™è¯¯è®°å½•ä¸ºå‰ä¸€å¤©</p>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalRecords">0</div>
                <div class="stat-label">æ€»è®°å½•æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="fixedRecords">0</div>
                <div class="stat-label">å·²ä¿®å¤è®°å½•</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="errorRecords">0</div>
                <div class="stat-label">é”™è¯¯è®°å½•</div>
            </div>
        </div>

        <div id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <h3 style="margin-top: 30px; color: #667eea;">åŠŸèƒ½1ï¼šTimeå­—æ®µæ ¼å¼ä¿®å¤</h3>
        <button class="btn-primary" onclick="checkAndFixLocalStorage()">
            ğŸ” æ£€æŸ¥å¹¶ä¿®å¤æœ¬åœ°å­˜å‚¨æ•°æ®
        </button>

        <button class="btn-success" onclick="checkAndFixFirebase()">
            â˜ï¸ æ£€æŸ¥å¹¶ä¿®å¤Firebaseæ•°æ®
        </button>

        <h3 style="margin-top: 30px; color: #667eea;">åŠŸèƒ½2ï¼šDateå­—æ®µæ—¶åŒºä¿®å¤</h3>
        <button class="btn-primary" onclick="scanDateFieldTimezone()">
            ğŸ” æ‰«æDateå­—æ®µæ—¶åŒºé—®é¢˜ï¼ˆåªè¯»ï¼‰
        </button>

        <button class="btn-success" onclick="fixDateFieldTimezone()">
            ğŸ”§ ä¿®å¤Dateå­—æ®µæ—¶åŒºå¹¶åŒæ­¥Firebase
        </button>

        <div class="log" id="log"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="../../src/smart-config-loader.js"></script>

    <script>
        let db = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateProgress(percent) {
            const progressDiv = document.getElementById('progress');
            const progressFill = document.getElementById('progressFill');
            progressDiv.classList.add('active');
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
        }

        function updateStats(total, fixed, errors) {
            document.getElementById('stats').classList.add('active');
            document.getElementById('totalRecords').textContent = total;
            document.getElementById('fixedRecords').textContent = fixed;
            document.getElementById('errorRecords').textContent = errors;
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        
        // ä»ISOæ—¶é—´å­—ç¬¦ä¸²è·å–æœ¬åœ°æ—¥æœŸï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰
        function getLocalDateFromISO(isoString) {
            const date = new Date(isoString);
            // ä½¿ç”¨æ—¶åŒºåç§»é‡è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´
            const localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
            return localDate.toISOString().split('T')[0];
        }

        // è½¬æ¢æ—¶é—´æ ¼å¼
        function convertTimeFormat(timeStr) {
            // å¦‚æœå·²ç»æ˜¯æ•°å­—ï¼ˆæ—¶é—´æˆ³ï¼‰ï¼Œç›´æ¥è¿”å›
            if (typeof timeStr === 'number') {
                return timeStr;
            }

            // å¦‚æœå·²ç»æ˜¯ISOæ ¼å¼ï¼Œè½¬æ¢ä¸ºæ—¶é—´æˆ³
            if (timeStr.includes('T') && timeStr.includes('Z')) {
                return new Date(timeStr).getTime();
            }

            // å¤„ç† "2025/8/1 09:55:00" æ ¼å¼
            if (timeStr.includes('/')) {
                // æ›¿æ¢ä¸ºæ ‡å‡†æ ¼å¼
                const standardFormat = timeStr.replace(/\//g, '-');
                // ç¡®ä¿æœˆæ—¥éƒ½æ˜¯ä¸¤ä½æ•°
                const parts = standardFormat.split(' ');
                const dateParts = parts[0].split('-');
                const year = dateParts[0];
                const month = dateParts[1].padStart(2, '0');
                const day = dateParts[2].padStart(2, '0');
                const time = parts[1];
                
                const dateStr = `${year}-${month}-${day}T${time}`;
                const timestamp = new Date(dateStr).getTime();
                
                if (isNaN(timestamp)) {
                    throw new Error(`æ— æ³•è½¬æ¢æ—¶é—´: ${timeStr}`);
                }
                
                return timestamp;
            }

            throw new Error(`æœªçŸ¥æ—¶é—´æ ¼å¼: ${timeStr}`);
        }

        // æ£€æŸ¥å¹¶ä¿®å¤æœ¬åœ°å­˜å‚¨æ•°æ®
        function checkAndFixLocalStorage() {
            log('ğŸ” å¼€å§‹æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ•°æ®...', 'info');
            
            const localData = localStorage.getItem('msh_attendanceRecords');
            if (!localData) {
                log('âŒ æœ¬åœ°å­˜å‚¨æ— æ•°æ®', 'error');
                alert('æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰ç­¾åˆ°è®°å½•ï¼');
                return;
            }

            try {
                const records = JSON.parse(localData);
                log(`ğŸ“Š æ‰¾åˆ° ${records.length} æ¡è®°å½•`, 'info');

                let totalRecords = records.length;
                let fixedCount = 0;
                let errorCount = 0;

                const fixedRecords = records.map((record, index) => {
                    if (index % 50 === 0) {
                        updateProgress(Math.round((index / totalRecords) * 100));
                    }

                    try {
                        const originalTime = record.time;
                        const timestamp = convertTimeFormat(originalTime);
                        
                        if (timestamp !== originalTime) {
                            fixedCount++;
                            return {
                                ...record,
                                time: timestamp
                            };
                        }
                        
                        return record;
                    } catch (error) {
                        errorCount++;
                        log(`âš ï¸ è®°å½•${index}è½¬æ¢å¤±è´¥: ${error.message}`, 'warning');
                        return record;
                    }
                });

                updateProgress(100);
                updateStats(totalRecords, fixedCount, errorCount);

                if (fixedCount > 0) {
                    // ä¿å­˜ä¿®å¤åçš„æ•°æ®
                    localStorage.setItem('msh_attendanceRecords', JSON.stringify(fixedRecords));
                    window.attendanceRecords = fixedRecords;
                    
                    log(`âœ… æˆåŠŸä¿®å¤ ${fixedCount} æ¡è®°å½•`, 'success');
                    log(`âœ… å·²æ›´æ–°æœ¬åœ°å­˜å‚¨å’Œå…¨å±€å˜é‡`, 'success');
                    alert(`âœ… æˆåŠŸä¿®å¤ ${fixedCount} æ¡è®°å½•ï¼\né”™è¯¯ï¼š${errorCount} æ¡`);
                } else {
                    log('âœ… æ‰€æœ‰è®°å½•æ ¼å¼æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤', 'success');
                    alert('æ‰€æœ‰è®°å½•æ ¼å¼æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤ï¼');
                }

            } catch (error) {
                log(`âŒ å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                alert('å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        // æ£€æŸ¥å¹¶ä¿®å¤Firebaseæ•°æ®
        async function checkAndFixFirebase() {
            if (!db) {
                log('âŒ Firebaseæœªè¿æ¥', 'error');
                alert('Firebaseæœªè¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
                return;
            }

            log('ğŸ” å¼€å§‹æ£€æŸ¥Firebaseæ•°æ®...', 'info');

            try {
                const snapshot = await db.ref('attendanceRecords').once('value');
                const data = snapshot.val();

                if (!data) {
                    log('âŒ Firebaseæ— æ•°æ®', 'error');
                    alert('Firebaseä¸­æ²¡æœ‰ç­¾åˆ°è®°å½•ï¼');
                    return;
                }

                const records = Array.isArray(data) ? data : Object.values(data);
                log(`ğŸ“Š æ‰¾åˆ° ${records.length} æ¡è®°å½•`, 'info');

                let totalRecords = records.length;
                let fixedCount = 0;
                let errorCount = 0;

                const fixedRecords = records.map((record, index) => {
                    if (index % 50 === 0) {
                        updateProgress(Math.round((index / totalRecords) * 100));
                    }

                    try {
                        const originalTime = record.time;
                        const timestamp = convertTimeFormat(originalTime);
                        
                        if (timestamp !== originalTime) {
                            fixedCount++;
                            return {
                                ...record,
                                time: timestamp
                            };
                        }
                        
                        return record;
                    } catch (error) {
                        errorCount++;
                        log(`âš ï¸ è®°å½•${index}è½¬æ¢å¤±è´¥: ${error.message}`, 'warning');
                        return record;
                    }
                });

                updateProgress(100);
                updateStats(totalRecords, fixedCount, errorCount);

                if (fixedCount > 0) {
                    const confirm = window.confirm(`âš ï¸ ç¡®å®šè¦ä¿®å¤ ${fixedCount} æ¡è®°å½•å¹¶åŒæ­¥åˆ°Firebaseå—ï¼Ÿ`);
                    if (!confirm) {
                        log('âŒ ç”¨æˆ·å–æ¶ˆæ“ä½œ', 'warning');
                        return;
                    }

                    // ä¿å­˜åˆ°Firebase
                    await db.ref('attendanceRecords').set(fixedRecords);
                    
                    // åŒæ—¶æ›´æ–°æœ¬åœ°
                    localStorage.setItem('msh_attendanceRecords', JSON.stringify(fixedRecords));
                    window.attendanceRecords = fixedRecords;
                    
                    log(`âœ… æˆåŠŸä¿®å¤å¹¶åŒæ­¥ ${fixedCount} æ¡è®°å½•`, 'success');
                    alert(`âœ… æˆåŠŸä¿®å¤ ${fixedCount} æ¡è®°å½•ï¼\né”™è¯¯ï¼š${errorCount} æ¡`);
                } else {
                    log('âœ… æ‰€æœ‰è®°å½•æ ¼å¼æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤', 'success');
                    alert('æ‰€æœ‰è®°å½•æ ¼å¼æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤ï¼');
                }

            } catch (error) {
                log(`âŒ å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                alert('å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        // ==================== Dateå­—æ®µæ—¶åŒºä¿®å¤åŠŸèƒ½ ====================
        
        // æ‰«æDateå­—æ®µæ—¶åŒºé—®é¢˜ï¼ˆåªè¯»ï¼‰
        async function scanDateFieldTimezone() {
            if (!db) {
                log('âŒ Firebaseæœªè¿æ¥', 'error');
                alert('Firebaseæœªè¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
                return;
            }

            log('ğŸ” å¼€å§‹æ‰«æDateå­—æ®µæ—¶åŒºé—®é¢˜...', 'info');
            log('ğŸ“‹ è¿™æ˜¯åªè¯»æ‰«æï¼Œä¸ä¼šä¿®æ”¹ä»»ä½•æ•°æ®', 'info');

            try {
                const snapshot = await db.ref('attendanceRecords').once('value');
                const data = snapshot.val();

                if (!data) {
                    log('âŒ Firebaseæ— æ•°æ®', 'error');
                    alert('Firebaseä¸­æ²¡æœ‰ç­¾åˆ°è®°å½•ï¼');
                    return;
                }

                const records = Array.isArray(data) ? data : Object.values(data);
                log(`ğŸ“Š æ‰¾åˆ° ${records.length} æ¡è®°å½•`, 'info');

                let totalRecords = records.length;
                let problemCount = 0;
                let missingDateCount = 0;
                const problemRecords = [];

                records.forEach((record, index) => {
                    if (index % 100 === 0) {
                        updateProgress(Math.round((index / totalRecords) * 100));
                    }

                    // æ£€æŸ¥æ˜¯å¦ç¼ºå°‘dateå­—æ®µ
                    if (!record.date) {
                        missingDateCount++;
                        problemRecords.push({
                            index,
                            name: record.name,
                            time: record.time,
                            issue: 'ç¼ºå°‘dateå­—æ®µ'
                        });
                        problemCount++;
                        return;
                    }

                    // æ£€æŸ¥dateå­—æ®µæ˜¯å¦ä¸timeå­—æ®µåŒ¹é…
                    if (record.time) {
                        const correctDate = getLocalDateFromISO(record.time);
                        if (record.date !== correctDate) {
                            problemRecords.push({
                                index,
                                name: record.name,
                                time: record.time,
                                currentDate: record.date,
                                correctDate: correctDate,
                                issue: 'æ—¶åŒºä¸åŒ¹é…'
                            });
                            problemCount++;
                        }
                    }
                });

                updateProgress(100);
                updateStats(totalRecords, 0, problemCount);

                log('', 'info');
                log('ğŸ“Š æ‰«æç»“æœç»Ÿè®¡:', 'success');
                log(`   æ€»è®°å½•æ•°: ${totalRecords}`, 'info');
                log(`   é—®é¢˜è®°å½•æ•°: ${problemCount}`, problemCount > 0 ? 'warning' : 'success');
                log(`   - ç¼ºå°‘dateå­—æ®µ: ${missingDateCount}`, 'warning');
                log(`   - æ—¶åŒºä¸åŒ¹é…: ${problemCount - missingDateCount}`, 'warning');

                if (problemCount > 0) {
                    log('', 'info');
                    log('ğŸ“‹ å‰10æ¡é—®é¢˜è®°å½•ç¤ºä¾‹:', 'warning');
                    problemRecords.slice(0, 10).forEach(p => {
                        if (p.issue === 'ç¼ºå°‘dateå­—æ®µ') {
                            log(`   [${p.index}] ${p.name} - time: ${p.time} - ${p.issue}`, 'warning');
                        } else {
                            log(`   [${p.index}] ${p.name} - å½“å‰: ${p.currentDate} â†’ æ­£ç¡®: ${p.correctDate}`, 'warning');
                        }
                    });
                    log('', 'info');
                    log('ğŸ’¡ å‘ç°é—®é¢˜è®°å½•ï¼å¯ä»¥ç‚¹å‡»"ä¿®å¤Dateå­—æ®µæ—¶åŒº"æŒ‰é’®è¿›è¡Œä¿®å¤', 'info');
                    alert(`ğŸ“Š æ‰«æå®Œæˆï¼\n\næ€»è®°å½•æ•°: ${totalRecords}\né—®é¢˜è®°å½•: ${problemCount} æ¡\n\nè¯¦æƒ…è¯·æŸ¥çœ‹æ—¥å¿—`);
                } else {
                    log('âœ… æ‰€æœ‰è®°å½•çš„dateå­—æ®µéƒ½æ­£ç¡®ï¼æ— éœ€ä¿®å¤', 'success');
                    alert('âœ… æ‰€æœ‰è®°å½•çš„dateå­—æ®µéƒ½æ­£ç¡®ï¼æ— éœ€ä¿®å¤');
                }

            } catch (error) {
                log(`âŒ æ‰«æå¤±è´¥: ${error.message}`, 'error');
                alert('æ‰«æå¤±è´¥: ' + error.message);
            }
        }

        // ä¿®å¤Dateå­—æ®µæ—¶åŒºå¹¶åŒæ­¥Firebase
        async function fixDateFieldTimezone() {
            if (!db) {
                log('âŒ Firebaseæœªè¿æ¥', 'error');
                alert('Firebaseæœªè¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
                return;
            }

            const confirmScan = confirm('âš ï¸ ä¿®å¤å‰å»ºè®®å…ˆè¿è¡Œæ‰«æåŠŸèƒ½æŸ¥çœ‹é—®é¢˜æ•°é‡\n\næ˜¯å¦å·²ç»è¿è¡Œè¿‡æ‰«æï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­ä¿®å¤\nç‚¹å‡»"å–æ¶ˆ"å…ˆè¿è¡Œæ‰«æ');
            if (!confirmScan) {
                log('ğŸ’¡ è¯·å…ˆç‚¹å‡»"æ‰«æDateå­—æ®µæ—¶åŒºé—®é¢˜"æŒ‰é’®', 'info');
                return;
            }

            log('ğŸ”§ å¼€å§‹ä¿®å¤Dateå­—æ®µæ—¶åŒºé—®é¢˜...', 'info');

            try {
                const snapshot = await db.ref('attendanceRecords').once('value');
                const data = snapshot.val();

                if (!data) {
                    log('âŒ Firebaseæ— æ•°æ®', 'error');
                    alert('Firebaseä¸­æ²¡æœ‰ç­¾åˆ°è®°å½•ï¼');
                    return;
                }

                const records = Array.isArray(data) ? data : Object.values(data);
                log(`ğŸ“Š æ‰¾åˆ° ${records.length} æ¡è®°å½•`, 'info');

                let totalRecords = records.length;
                let fixedCount = 0;
                let errorCount = 0;

                const fixedRecords = records.map((record, index) => {
                    if (index % 50 === 0) {
                        updateProgress(Math.round((index / totalRecords) * 100));
                    }

                    try {
                        // å¦‚æœç¼ºå°‘dateå­—æ®µï¼Œæˆ–dateå­—æ®µä¸timeä¸åŒ¹é…
                        if (record.time) {
                            const correctDate = getLocalDateFromISO(record.time);
                            
                            if (!record.date || record.date !== correctDate) {
                                fixedCount++;
                                return {
                                    ...record,
                                    date: correctDate
                                };
                            }
                        }
                        
                        return record;
                    } catch (error) {
                        errorCount++;
                        log(`âš ï¸ è®°å½•${index}ä¿®å¤å¤±è´¥: ${error.message}`, 'warning');
                        return record;
                    }
                });

                updateProgress(100);
                updateStats(totalRecords, fixedCount, errorCount);

                if (fixedCount > 0) {
                    const confirmFix = confirm(`âš ï¸ å³å°†ä¿®å¤ ${fixedCount} æ¡è®°å½•å¹¶åŒæ­¥åˆ°Firebase\n\næ­¤æ“ä½œä¼šè¦†ç›–Firebaseä¸­çš„æ‰€æœ‰ç­¾åˆ°è®°å½•ï¼\n\næ˜¯å¦ç¡®å®šç»§ç»­ï¼Ÿ`);
                    if (!confirmFix) {
                        log('âŒ ç”¨æˆ·å–æ¶ˆæ“ä½œ', 'warning');
                        return;
                    }

                    log('ğŸ’¾ æ­£åœ¨å¤‡ä»½å½“å‰æ•°æ®...', 'info');
                    // åˆ›å»ºå¤‡ä»½ï¼ˆä½¿ç”¨æ—¶é—´æˆ³ï¼‰
                    const backupKey = `attendanceRecords_backup_${Date.now()}`;
                    await db.ref(backupKey).set(records);
                    log(`âœ… å¤‡ä»½å·²åˆ›å»º: ${backupKey}`, 'success');

                    // ä¿å­˜ä¿®å¤åçš„æ•°æ®åˆ°Firebase
                    log('ğŸ“¤ æ­£åœ¨åŒæ­¥åˆ°Firebase...', 'info');
                    await db.ref('attendanceRecords').set(fixedRecords);
                    
                    // åŒæ—¶æ›´æ–°æœ¬åœ°
                    localStorage.setItem('msh_attendanceRecords', JSON.stringify(fixedRecords));
                    window.attendanceRecords = fixedRecords;
                    
                    log(`âœ… æˆåŠŸä¿®å¤å¹¶åŒæ­¥ ${fixedCount} æ¡è®°å½•`, 'success');
                    log(`âœ… å·²æ›´æ–°Firebaseã€æœ¬åœ°å­˜å‚¨å’Œå…¨å±€å˜é‡`, 'success');
                    alert(`âœ… ä¿®å¤å®Œæˆï¼\n\nä¿®å¤è®°å½•: ${fixedCount} æ¡\né”™è¯¯è®°å½•: ${errorCount} æ¡\n\nå¤‡ä»½èŠ‚ç‚¹: ${backupKey}`);
                } else {
                    log('âœ… æ‰€æœ‰è®°å½•çš„dateå­—æ®µéƒ½æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤', 'success');
                    alert('æ‰€æœ‰è®°å½•çš„dateå­—æ®µéƒ½æ­£ç¡®ï¼Œæ— éœ€ä¿®å¤ï¼');
                }

            } catch (error) {
                log(`âŒ ä¿®å¤å¤±è´¥: ${error.message}`, 'error');
                alert('ä¿®å¤å¤±è´¥: ' + error.message);
            }
        }

        // åˆå§‹åŒ–Firebase
        window.addEventListener('load', () => {
            try {
                if (typeof firebase !== 'undefined' && window.firebaseConfig) {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(window.firebaseConfig);
                    }
                    db = firebase.database();
                    log('âœ… Firebaseåˆå§‹åŒ–æˆåŠŸ', 'success');
                } else {
                    log('âš ï¸ Firebaseé…ç½®æœªæ‰¾åˆ°', 'warning');
                }
            } catch (error) {
                log(`âŒ Firebaseåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }

            log('ç³»ç»Ÿå°±ç»ªï¼Œè¯·é€‰æ‹©æ“ä½œ', 'info');
            log('ğŸ’¡ å»ºè®®ï¼šå…ˆä½¿ç”¨æ‰«æåŠŸèƒ½æŸ¥çœ‹é—®é¢˜æ•°é‡ï¼Œå†å†³å®šæ˜¯å¦ä¿®å¤', 'info');
        });
    </script>
</body>
</html>


