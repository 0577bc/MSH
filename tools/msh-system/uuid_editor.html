<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UUID编辑器 - 签到记录管理</title>
    
    <!-- Firebase SDK v8 (兼容版本) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- 系统依赖文件 -->
    <script src="../../src/smart-config-loader.js"></script>
    <script src="../../src/utils.js"></script>
    <script src="../../src/new-data-manager.js"></script>
    
    <!-- 外部样式文件 -->
    <link rel="stylesheet" href="../../src/uuid-editor.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 UUID编辑器 - 签到记录管理</h1>
            <div>
                <button onclick="goBackToGroupManagement()" class="back-button">成员管理</button>
                <button onclick="loadData()">🔄 刷新数据（本地）</button>
                <button onclick="loadDataFromFirebase()">☁️ 从Firebase加载</button>
                <button onclick="checkSystemStatus()">🔍 检查系统状态</button>
                <button onclick="initializeSystem()">⚙️ 初始化系统</button>
                <button onclick="debugExcludedMembers()" class="warning-button">🔍 调试排除人员</button>
                <button onclick="upgradeExcludedMembersUUID()" class="danger-button">⚠️ 升级排除人员UUID</button>
                <button onclick="saveAllChanges()" class="success-button">💾 保存所有更改</button>
            </div>
        </div>
        
        <div class="warning hidden" id="saveWarning">
            <h4>⚠️ 重要提醒</h4>
            <p>您有未保存的更改！请点击"保存所有更改"按钮将数据同步到Firebase，否则数据仅保存在本地。</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalRecords">0</div>
                <div class="stat-label">总记录数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="missingUUID">0</div>
                <div class="stat-label">缺少UUID</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="hasUUID">0</div>
                <div class="stat-label">有UUID</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="coverage">0%</div>
                <div class="stat-label">UUID覆盖率</div>
            </div>
        </div>
        
        <div class="filters">
            <label for="dateFilter">日期筛选：</label>
            <input type="date" id="dateFilter" title="选择日期进行筛选" onchange="filterRecords()">
            <label for="groupFilter">组别筛选：</label>
            <select id="groupFilter" title="选择组别进行筛选" onchange="filterRecords()">
                <option value="">所有组别</option>
            </select>
            <label for="uuidFilter">UUID状态：</label>
            <select id="uuidFilter" title="选择UUID状态进行筛选" onchange="filterRecords()">
                <option value="">全部</option>
                <option value="missing">缺少UUID</option>
                <option value="has">有UUID</option>
            </select>
            <label for="memberSearch">成员搜索：</label>
            <input type="text" id="memberSearch" placeholder="输入姓名或花名" title="输入成员姓名或花名进行搜索" onkeyup="filterRecords()">
        </div>
        
        <div class="actions">
            <button onclick="autoFillUUIDs()" class="success-button">自动填充UUID</button>
            <button onclick="detectDuplicateNames()" class="warning-button">🔍 同名检测</button>
            <button onclick="clearFilters()">清除筛选</button>
        </div>
        
        <div class="table-container">
            <table id="recordsTable">
                <thead>
                    <tr>
                        <th>选择</th>
                        <th>日期</th>
                        <th>时间</th>
                        <th>组别</th>
                        <th>成员姓名</th>
                        <th>UUID</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="recordsBody">
                </tbody>
            </table>
        </div>
        
        <div class="log" id="log">
            <div>🔧 UUID编辑器已加载</div>
            <div>💡 提示：如需编辑UUID，请先点击"从Firebase加载"按钮加载全部签到记录</div>
        </div>
    </div>

    <script>
        let allRecords = [];
        let filteredRecords = [];
        let groups = {};
        let groupNames = {};
        let hasChanges = false;
        
        // 日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // 加载数据（从本地）
        function loadData() {
            log('开始加载数据（本地优先）...');
            
            try {
                // 加载签到记录
                allRecords = window.attendanceRecords || [];
                if (allRecords.length === 0) {
                    const storedRecords = localStorage.getItem('msh_attendanceRecords');
                    if (storedRecords) {
                        allRecords = JSON.parse(storedRecords);
                        window.attendanceRecords = allRecords;
                        log(`从本地存储读取签到记录: ${allRecords.length} 条`);
                    }
                }
                
                // 加载组别数据
                groups = window.groups || {};
                if (Object.keys(groups).length === 0) {
                    const storedGroups = localStorage.getItem('msh_groups');
                    if (storedGroups) {
                        groups = JSON.parse(storedGroups);
                        window.groups = groups;
                    }
                }
                
                // 加载组别名称
                groupNames = window.groupNames || {};
                if (Object.keys(groupNames).length === 0) {
                    const storedGroupNames = localStorage.getItem('msh_group_names');
                    if (storedGroupNames) {
                        groupNames = JSON.parse(storedGroupNames);
                        window.groupNames = groupNames;
                    }
                }
                
                // 加载排除人员数据
                if (!window.excludedMembers || Object.keys(window.excludedMembers).length === 0) {
                    const storedExcludedMembers = localStorage.getItem('msh_excludedMembers');
                    if (storedExcludedMembers) {
                        try {
                            const excludedData = JSON.parse(storedExcludedMembers);
                            // 确保转换为对象格式
                            if (Array.isArray(excludedData)) {
                                window.excludedMembers = {};
                                excludedData.forEach((member, index) => {
                                    window.excludedMembers[member.uuid || `member_${index}`] = member;
                                });
                            } else {
                                window.excludedMembers = excludedData;
                            }
                            log(`从本地存储加载排除人员数据: ${Object.keys(window.excludedMembers).length} 个`);
                        } catch (error) {
                            log(`加载排除人员数据失败: ${error.message}`, 'error');
                            window.excludedMembers = {};
                        }
                    } else {
                        // 尝试从Firebase加载
                        log('本地存储中没有排除人员数据，尝试从Firebase加载...');
                        try {
                            if (window.db) {
                                window.db.ref('excludedMembers').once('value').then(snapshot => {
                                    if (snapshot.exists()) {
                                        const firebaseData = snapshot.val();
                                        log(`从Firebase获取到排除人员数据: ${Array.isArray(firebaseData) ? firebaseData.length : Object.keys(firebaseData || {}).length} 个`);
                                        
                                        // 转换为对象格式
                                        if (Array.isArray(firebaseData)) {
                                            window.excludedMembers = {};
                                            firebaseData.forEach((member, index) => {
                                                window.excludedMembers[member.uuid || `member_${index}`] = member;
                                            });
                                        } else {
                                            window.excludedMembers = firebaseData || {};
                                        }
                                        
                                        // 保存到localStorage
                                        localStorage.setItem('msh_excludedMembers', JSON.stringify(window.excludedMembers));
                                        log(`已从Firebase加载并保存排除人员数据: ${Object.keys(window.excludedMembers).length} 个`);
                                    } else {
                                        log('Firebase中也没有排除人员数据');
                                        window.excludedMembers = {};
                                    }
                                }).catch(error => {
                                    log(`从Firebase加载排除人员数据失败: ${error.message}`, 'error');
                                    window.excludedMembers = {};
                                });
                            } else {
                                log('Firebase不可用，无法加载排除人员数据');
                                window.excludedMembers = {};
                            }
                        } catch (error) {
                            log(`Firebase加载过程出错: ${error.message}`, 'error');
                            window.excludedMembers = {};
                        }
                    }
                } else {
                    log(`使用已有的排除人员数据: ${Object.keys(window.excludedMembers).length} 个`);
                }
                
                if (allRecords.length === 0) {
                    log('未找到签到记录数据', 'error');
                    return;
                }
                
                // 更新统计信息
                updateStats();
                
                // 加载筛选器选项
                loadFilterOptions();
                
                // 显示所有记录
                filteredRecords = [...allRecords];
                displayRecords();
                
                log(`数据加载完成: ${allRecords.length} 条记录`, 'success');
                
            } catch (error) {
                log(`数据加载失败: ${error.message}`, 'error');
            }
        }
        
        // 【新增】从Firebase加载全部数据（工具软件需要）
        async function loadDataFromFirebase() {
            log('🔄 开始从Firebase加载全部数据...', 'info');
            
            try {
                // 确保Firebase已初始化
                if (!window.db) {
                    log('⚠️ Firebase未初始化，尝试初始化...', 'info');
                    const initOk = initializeFirebase();
                    if (!initOk) {
                        log('❌ Firebase初始化失败，无法加载数据', 'error');
                        alert('Firebase初始化失败，请检查配置！');
                        return;
                    }
                }
                
                log('📡 正在从Firebase加载数据，请稍候...', 'info');
                
                // 并行加载所有数据
                const [recordsSnap, groupsSnap, groupNamesSnap, excludedSnap] = await Promise.all([
                    window.db.ref('attendanceRecords').once('value'),
                    window.db.ref('groups').once('value'),
                    window.db.ref('groupNames').once('value'),
                    window.db.ref('excludedMembers').once('value')
                ]);
                
                // 处理签到记录
                const firebaseRecords = recordsSnap.val();
                log(`🔍 Firebase原始数据类型: ${Array.isArray(firebaseRecords) ? 'Array' : typeof firebaseRecords}`, 'info');
                
                if (firebaseRecords) {
                    // Firebase数据可能是对象或数组
                    if (Array.isArray(firebaseRecords)) {
                        allRecords = firebaseRecords;
                        log(`🔍 Firebase数据是数组，直接使用: ${allRecords.length} 条`, 'info');
                    } else if (typeof firebaseRecords === 'object') {
                        allRecords = Object.values(firebaseRecords);
                        log(`🔍 Firebase数据是对象，转换为数组: ${Object.keys(firebaseRecords).length} 个键 → ${allRecords.length} 条记录`, 'info');
                    } else {
                        log(`⚠️ Firebase数据格式异常: ${typeof firebaseRecords}`, 'warning');
                        allRecords = [];
                    }
                    
                    // 过滤无效数据
                    const validRecords = allRecords.filter(record => record && record.name && record.time);
                    if (validRecords.length !== allRecords.length) {
                        log(`⚠️ 过滤了 ${allRecords.length - validRecords.length} 条无效记录`, 'warning');
                        allRecords = validRecords;
                    }
                    
                    window.attendanceRecords = allRecords;
                    localStorage.setItem('msh_attendanceRecords', JSON.stringify(allRecords));
                    log(`✅ 签到记录加载完成: ${allRecords.length} 条`, 'success');
                    
                    // 显示记录的日期范围
                    if (allRecords.length > 0) {
                        const dates = allRecords.map(r => new Date(r.time)).sort((a, b) => a - b);
                        const earliest = dates[0].toLocaleDateString('zh-CN');
                        const latest = dates[dates.length - 1].toLocaleDateString('zh-CN');
                        log(`📅 记录日期范围: ${earliest} 至 ${latest}`, 'info');
                    }
                } else {
                    log('⚠️ Firebase中没有签到记录数据', 'warning');
                    allRecords = [];
                }
                
                // 处理组别数据
                groups = groupsSnap.val() || {};
                window.groups = groups;
                localStorage.setItem('msh_groups', JSON.stringify(groups));
                log(`✅ 组别数据加载完成: ${Object.keys(groups).length} 个组`, 'success');
                
                // 处理组别名称
                groupNames = groupNamesSnap.val() || {};
                window.groupNames = groupNames;
                localStorage.setItem('msh_group_names', JSON.stringify(groupNames));
                log(`✅ 组别名称加载完成: ${Object.keys(groupNames).length} 个`, 'success');
                
                // 处理排除人员
                const excludedData = excludedSnap.val();
                if (excludedData) {
                    // 转换为对象格式
                    if (Array.isArray(excludedData)) {
                        window.excludedMembers = {};
                        excludedData.forEach((member, index) => {
                            window.excludedMembers[member.uuid || `member_${index}`] = member;
                        });
                    } else {
                        window.excludedMembers = excludedData;
                    }
                    localStorage.setItem('msh_excludedMembers', JSON.stringify(excludedData));
                    log(`✅ 排除人员加载完成: ${Array.isArray(excludedData) ? excludedData.length : Object.keys(excludedData).length} 个`, 'success');
                } else {
                    log('⚠️ Firebase中没有排除人员数据', 'warning');
                }
                
                // 更新UI
                updateStats();
                loadFilterOptions();
                filteredRecords = [...allRecords];
                displayRecords();
                
                log('🎉 从Firebase加载全部数据完成！', 'success');
                alert('✅ 数据加载成功！\n\n' + 
                      `签到记录：${allRecords.length} 条\n` +
                      `组别：${Object.keys(groups).length} 个\n` +
                      `排除人员：${window.excludedMembers ? Object.keys(window.excludedMembers).length : 0} 个`);
                
            } catch (error) {
                log(`❌ 从Firebase加载数据失败: ${error.message}`, 'error');
                alert('数据加载失败，请检查网络连接和Firebase配置！\n\n错误信息：' + error.message);
            }
        }
        
        // 更新统计信息
        function updateStats() {
            const total = allRecords.length;
            const missing = allRecords.filter(record => !record.memberUUID).length;
            const has = total - missing;
            const coverage = total > 0 ? Math.round((has / total) * 100) : 0;
            
            document.getElementById('totalRecords').textContent = total;
            document.getElementById('missingUUID').textContent = missing;
            document.getElementById('hasUUID').textContent = has;
            document.getElementById('coverage').textContent = coverage + '%';
        }
        
        // 加载筛选器选项
        function loadFilterOptions() {
            const groupFilter = document.getElementById('groupFilter');
            groupFilter.innerHTML = '<option value="">所有组别</option>';
            
            const uniqueGroups = [...new Set(allRecords.map(record => record.group))];
            log(`加载组别筛选器，发现 ${uniqueGroups.length} 个组别: ${uniqueGroups.join(', ')}`, 'info');
            
            uniqueGroups.sort().forEach(groupId => {
                const option = document.createElement('option');
                option.value = groupId;
                option.textContent = groupNames[groupId] || groupId;
                groupFilter.appendChild(option);
                log(`添加组别选项: ${groupId} → ${groupNames[groupId] || groupId}`, 'info');
            });
        }
        
        // 筛选记录
        function filterRecords() {
            const dateFilter = document.getElementById('dateFilter').value;
            const groupFilter = document.getElementById('groupFilter').value;
            const uuidFilter = document.getElementById('uuidFilter').value;
            const memberSearch = document.getElementById('memberSearch').value.toLowerCase();
            
            log(`筛选条件: 日期=${dateFilter}, 组别=${groupFilter}, UUID=${uuidFilter}, 搜索="${memberSearch}"`, 'info');
            
            filteredRecords = allRecords.filter(record => {
                // 日期筛选
                if (dateFilter) {
                    const recordDate = new Date(record.time).toISOString().split('T')[0];
                    if (recordDate !== dateFilter) return false;
                }
                
                // 组别筛选
                if (groupFilter && record.group !== groupFilter) {
                    return false;
                }
                
                // UUID状态筛选
                if (uuidFilter === 'missing' && record.memberUUID) return false;
                if (uuidFilter === 'has' && !record.memberUUID) return false;
                
                // 成员搜索（支持姓名和花名）
                if (memberSearch) {
                    const nameMatch = record.name && record.name.toLowerCase().includes(memberSearch);
                    const nicknameMatch = record.nickname && record.nickname.toLowerCase().includes(memberSearch);
                    const aliasMatch = record.alias && record.alias.toLowerCase().includes(memberSearch);
                    const 花名Match = record.花名 && record.花名.toLowerCase().includes(memberSearch);
                    
                    if (!nameMatch && !nicknameMatch && !aliasMatch && !花名Match) return false;
                }
                
                return true;
            });
            
            displayRecords();
            log(`筛选完成: 显示 ${filteredRecords.length} 条记录`);
        }
        
        // 显示记录
        function displayRecords() {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';
            
            filteredRecords.forEach((record, index) => {
                const row = document.createElement('tr');
                const hasUUID = !!record.memberUUID;
                
                row.className = hasUUID ? 'has-uuid' : 'missing-uuid';
                
                const recordDate = new Date(record.time).toLocaleDateString('zh-CN');
                const recordTime = new Date(record.time).toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // 使用更稳定的标识符：优先使用recordId，否则使用记录的原始索引
                let recordId;
                if (record.recordId) {
                    recordId = record.recordId;
                } else {
                    // 使用记录在allRecords中的原始索引
                    const originalIndex = allRecords.findIndex(r => 
                        r.name === record.name && 
                        r.group === record.group && 
                        r.time === record.time
                    );
                    recordId = `temp_${originalIndex}`;
                }
                
                row.innerHTML = `
                    <td><input type="checkbox" onchange="toggleSelection('${recordId}')"></td>
                    <td>${recordDate}</td>
                    <td>${recordTime}</td>
                    <td>${groupNames[record.group] || record.group}</td>
                    <td>${record.name}</td>
                    <td class="uuid-cell" id="uuid-${recordId}">${record.memberUUID || '缺少UUID'}</td>
                    <td>
                        <button class="edit-button" onclick="editUUID('${recordId}')">编辑</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // 编辑UUID
        function editUUID(recordId) {
            log(`开始编辑记录ID: ${recordId}`);
            
            // 查找对应的记录
            let record = null;
            
            for (let i = 0; i < filteredRecords.length; i++) {
                const r = filteredRecords[i];
                let currentRecordId;
                
                if (r.recordId) {
                    currentRecordId = r.recordId;
                } else {
                    // 使用记录在allRecords中的原始索引
                    const originalIndex = allRecords.findIndex(ar => 
                        ar.name === r.name && 
                        ar.group === r.group && 
                        ar.time === r.time
                    );
                    currentRecordId = `temp_${originalIndex}`;
                }
                
                if (currentRecordId === recordId) {
                    record = r;
                    log(`找到记录: ${r.name} (${r.group}), 原始索引: ${allRecords.findIndex(ar => ar.name === r.name && ar.group === r.group && ar.time === r.time)}`);
                    break;
                }
            }
            
            if (!record) {
                log(`未找到记录ID: ${recordId}`, 'error');
                return;
            }
            
            const uuidCell = document.getElementById(`uuid-${recordId}`);
            const row = uuidCell.closest('tr');
            
            if (row.classList.contains('editing')) {
                return; // 已经在编辑状态
            }
            
            row.classList.add('editing');
            
            const currentUUID = record.memberUUID || '';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'input-field';
            input.value = currentUUID;
            input.placeholder = '输入UUID或留空';
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.marginTop = '5px';
            
            const saveButton = document.createElement('button');
            saveButton.className = 'save-button';
            saveButton.textContent = '保存';
            saveButton.onclick = () => saveUUID(recordId, input.value);
            
            const cancelButton = document.createElement('button');
            cancelButton.className = 'cancel-button';
            cancelButton.textContent = '取消';
            cancelButton.onclick = () => cancelEdit(recordId);
            
            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(cancelButton);
            
            uuidCell.innerHTML = '';
            uuidCell.appendChild(input);
            uuidCell.appendChild(buttonContainer);
            
            input.focus();
        }
        
        // 保存UUID
        function saveUUID(recordId, newUUID) {
            log(`开始保存UUID: ${recordId} -> ${newUUID}`);
            
            // 查找对应的记录
            let record = null;
            
            for (let i = 0; i < filteredRecords.length; i++) {
                const r = filteredRecords[i];
                let currentRecordId;
                
                if (r.recordId) {
                    currentRecordId = r.recordId;
                } else {
                    // 使用记录在allRecords中的原始索引
                    const originalIndex = allRecords.findIndex(ar => 
                        ar.name === r.name && 
                        ar.group === r.group && 
                        ar.time === r.time
                    );
                    currentRecordId = `temp_${originalIndex}`;
                }
                
                if (currentRecordId === recordId) {
                    record = r;
                    log(`找到要保存的记录: ${r.name} (${r.group})`);
                    break;
                }
            }
            
            if (!record) {
                log(`未找到记录ID: ${recordId}`, 'error');
                return;
            }
            
            // 查找原始记录
            let originalRecord = null;
            if (record.recordId) {
                originalRecord = allRecords.find(r => r.recordId === record.recordId);
            } else {
                // 通过姓名、组别、时间匹配
                originalRecord = allRecords.find(r => 
                    r.name === record.name && 
                    r.group === record.group && 
                    r.time === record.time
                );
            }
            
            if (originalRecord) {
                originalRecord.memberUUID = newUUID.trim() || null;
                hasChanges = true;
                showSaveWarning();
                log(`已更新 ${record.name} 的UUID: ${newUUID || '已清除'}`, 'success');
            } else {
                log(`未找到原始记录: ${record.name}`, 'error');
            }
            
            // 重新显示记录
            displayRecords();
            updateStats();
        }
        
        // 取消编辑
        function cancelEdit(recordId) {
            displayRecords();
        }
        
        // 切换选择状态
        function toggleSelection(recordId) {
            // 查找对应的记录
            let record = null;
            
            for (let i = 0; i < filteredRecords.length; i++) {
                const r = filteredRecords[i];
                let currentRecordId;
                
                if (r.recordId) {
                    currentRecordId = r.recordId;
                } else {
                    // 使用记录在allRecords中的原始索引
                    const originalIndex = allRecords.findIndex(ar => 
                        ar.name === r.name && 
                        ar.group === r.group && 
                        ar.time === r.time
                    );
                    currentRecordId = `temp_${originalIndex}`;
                }
                
                if (currentRecordId === recordId) {
                    record = r;
                    break;
                }
            }
            
            if (record) {
                log(`${record.name} (${record.group}) 选择状态已切换`);
            }
        }
        
        
        // 自动填充UUID
        function autoFillUUIDs() {
            let filledCount = 0;
            
            filteredRecords.forEach(record => {
                if (!record.memberUUID) {
                    // 查找对应的成员
                    const member = findMemberByName(record.name, record.group);
                    if (member && member.uuid) {
                        const originalRecord = allRecords.find(r => r.recordId === record.recordId);
                        if (originalRecord) {
                            originalRecord.memberUUID = member.uuid;
                            filledCount++;
                        }
                    }
                }
            });
            
            hasChanges = true;
            showSaveWarning();
            displayRecords();
            updateStats();
            log(`自动填充完成: ${filledCount} 个UUID已填充`, 'success');
        }
        
        // 查找成员
        function findMemberByName(name, group) {
            if (groups[group]) {
                return groups[group].find(member => member.name === name);
            }
            return null;
        }
        
        // 显示保存警告
        function showSaveWarning() {
            const warning = document.getElementById('saveWarning');
            if (warning) {
                warning.style.display = 'block';
            }
        }
        
        // 隐藏保存警告
        function hideSaveWarning() {
            const warning = document.getElementById('saveWarning');
            if (warning) {
                warning.style.display = 'none';
            }
        }
        
        
        // 清除筛选
        function clearFilters() {
            document.getElementById('dateFilter').value = '';
            document.getElementById('groupFilter').value = '';
            document.getElementById('uuidFilter').value = '';
            document.getElementById('memberSearch').value = '';
            filterRecords();
        }
        
        // 保存所有更改 - 使用直接Firebase同步机制
        async function saveAllChanges() {
            if (!hasChanges) {
                log('没有需要保存的更改', 'info');
                return;
            }
            
            try {
                log('开始直接同步所有更改到Firebase...');
                
                // 1. 保存到本地存储
                localStorage.setItem('msh_attendanceRecords', JSON.stringify(allRecords));
                localStorage.setItem('msh_attendanceRecords_timestamp', Date.now().toString());
                log('✅ 数据已保存到本地存储');
                
                // 2. 更新全局变量
                window.attendanceRecords = allRecords;
                log('✅ 全局变量已更新');
                
                // 3. 直接Firebase同步
                if (window.db) {
                    try {
                        log('🔄 正在直接同步到Firebase...');
                        await window.db.ref('attendanceRecords').set(allRecords);
                        log('✅ 数据已直接同步到Firebase', 'success');
                    } catch (firebaseError) {
                        log(`❌ Firebase同步失败: ${firebaseError.message}`, 'error');
                        throw firebaseError;
                    }
                } else {
                    log('❌ Firebase未初始化，无法同步', 'error');
                    throw new Error('Firebase未初始化');
                }
                
                // 4. 清除变更标志
                hasChanges = false;
                hideSaveWarning();
                log('🎉 所有更改已同步完成！', 'success');
                
            } catch (error) {
                log(`❌ 保存失败: ${error.message}`, 'error');
                // 保存失败时，数据仍然在本地存储中，用户可以重试
            }
        }
        
        // 检查系统状态
        function checkSystemStatus() {
            log('🔍 检查系统状态...');
            
            const status = {
                firebase: !!window.db,
                firebaseConfig: !!window.firebaseConfig,
                attendanceRecords: !!window.attendanceRecords,
                groups: !!window.groups
            };
            
            log(`Firebase: ${status.firebase ? '✅ 可用' : '❌ 不可用'}`);
            log(`Firebase配置: ${status.firebaseConfig ? '✅ 可用' : '❌ 不可用'}`);
            log(`签到记录: ${status.attendanceRecords ? '✅ 可用' : '❌ 不可用'}`);
            log(`成员数据: ${status.groups ? '✅ 可用' : '❌ 不可用'}`);
            
            if (!status.firebase) {
                log('⚠️ 警告: Firebase未初始化，数据将仅保存在本地', 'error');
            }
            
            return status;
        }
        
        // 初始化Firebase
        function initializeFirebase() {
            try {
                if (window.firebaseConfig) {
                    // 检查Firebase是否已经初始化
                    if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length === 0) {
                        firebase.initializeApp(window.firebaseConfig);
                    }
                    
                    // 设置数据库引用
                    if (typeof firebase !== 'undefined') {
                        window.db = firebase.database();
                        log('✅ Firebase初始化成功');
                        return true;
                    } else {
                        log('❌ Firebase SDK未加载', 'error');
                        return false;
                    }
                } else {
                    log('❌ Firebase配置未找到', 'error');
                    return false;
                }
            } catch (error) {
                log(`❌ Firebase初始化失败: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 初始化完成检查
        function checkInitializationComplete() {
            const firebaseOk = !!window.db;
            const dataOk = !!window.attendanceRecords;
            
            if (firebaseOk && dataOk) {
                log('✅ 系统初始化完成，所有组件可用', 'success');
                return true;
            } else {
                log('⚠️ 系统初始化未完成，部分组件不可用', 'error');
                return false;
            }
        }
        
        // 手动初始化系统
        async function initializeSystem() {
            log('🔄 开始手动初始化系统...');
            
            // 等待Firebase SDK加载
            await waitForFirebase();
            
            const firebaseOk = initializeFirebase();
            
            if (firebaseOk) {
                log('🎉 系统初始化完成！', 'success');
            } else {
                log('⚠️ 系统初始化失败，请检查Firebase配置', 'error');
            }
            
            // 重新检查系统状态
            setTimeout(() => {
                checkSystemStatus();
            }, 500);
        }
        
        // 等待Firebase SDK加载
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (typeof firebase !== 'undefined') {
                        log('✅ Firebase SDK已加载');
                        resolve(true);
                    } else {
                        log('⏳ 等待Firebase SDK加载...');
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }
        
        // 页面加载完成后自动初始化
        window.addEventListener('load', async () => {
            log('🔧 UUID编辑器已加载');
            
            // 等待Firebase SDK加载
            await waitForFirebase();
            
            // 初始化Firebase
            const firebaseOk = initializeFirebase();
            
            // 检查系统状态
            setTimeout(() => {
                checkSystemStatus();
                
                // 尝试从本地加载数据
                loadData();
                
                // 如果本地没有数据，提示用户
                if (allRecords.length === 0) {
                    log('⚠️ 本地没有数据，请点击"从Firebase加载"按钮', 'warning');
                    alert('💡 提示：检测到本地没有数据\n\n请点击"从Firebase加载"按钮加载全部签到记录');
                }
            }, 1000);
        });
        
        // 返回成员管理页面
        function goBackToGroupManagement() {
            console.log('🔍 点击返回成员管理按钮');
            if (hasChanges) {
                const confirmLeave = confirm('您有未保存的更改，确定要离开吗？');
                if (!confirmLeave) {
                    console.log('❌ 用户取消离开');
                    return;
                }
            }
            console.log('✅ 正在跳转到成员管理页面...');
            window.location.href = '../../group-management.html';
        }
        
        // 同名检测功能
        function detectDuplicateNames() {
            log('🔍 开始检测同名记录...');
            
            // 按姓名分组
            const nameGroups = {};
            allRecords.forEach(record => {
                if (!nameGroups[record.name]) {
                    nameGroups[record.name] = [];
                }
                nameGroups[record.name].push(record);
            });
            
            // 找出有多个UUID的同名记录
            const duplicates = [];
            Object.keys(nameGroups).forEach(name => {
                const records = nameGroups[name];
                const uuids = new Set();
                
                records.forEach(record => {
                    if (record.memberUUID) {
                        uuids.add(record.memberUUID);
                    }
                });
                
                // 如果有多个不同的UUID，则认为是重复
                if (uuids.size > 1) {
                    duplicates.push({
                        name: name,
                        records: records,
                        uuids: Array.from(uuids)
                    });
                }
            });
            
            if (duplicates.length === 0) {
                log('✅ 未发现同名不同UUID的记录', 'success');
                alert('✅ 检测完成！未发现同名不同UUID的异常数据，数据一致性良好。');
                return;
            }
            
            log(`⚠️ 发现 ${duplicates.length} 个同名不同UUID的情况:`, 'error');
            duplicates.forEach(duplicate => {
                log(`- ${duplicate.name}: ${duplicate.uuids.join(', ')}`, 'error');
            });
            
            // 筛选显示重复记录
            const duplicateRecords = [];
            duplicates.forEach(duplicate => {
                duplicateRecords.push(...duplicate.records);
            });
            
            filteredRecords = duplicateRecords;
            displayRecords();
            log(`已筛选显示 ${duplicateRecords.length} 条重复记录`);
        }
        
        // ==================== 排除人员UUID管理功能 ====================
        
        // 调试排除人员匹配
        async function debugExcludedMembers() {
            log('开始调试排除人员匹配...', 'info');
            
            try {
                const excludedMembersData = window.utils.loadExcludedMembers();
                const excludedMembers = Array.isArray(excludedMembersData) ? excludedMembersData : Object.values(excludedMembersData || {});
                const groups = window.groups || {};
                
                log(`排除人员总数: ${excludedMembers.length}`, 'info');
                log(`实际小组数: ${Object.keys(groups).length}`, 'info');
                
                // 显示实际小组和成员
                log('实际小组和成员数据:', 'info');
                Object.keys(groups).forEach(group => {
                    const groupMembers = groups[group];
                    log(`${group} (${groupMembers.length}人):`, 'info');
                    groupMembers.slice(0, 3).forEach(member => {
                        const nickname = member.nickname || member.Nickname || member.花名 || member.alias || '';
                        log(`  - ${member.name} ${nickname ? `(${nickname})` : ''} [UUID: ${member.uuid ? member.uuid.substring(0, 8) + '...' : '无'}]`, 'info');
                    });
                    if (groupMembers.length > 3) {
                        log(`  ... 还有 ${groupMembers.length - 3} 人`, 'info');
                    }
                });
                
                // 检查组别名称映射
                log('检查组别名称映射:', 'info');
                const groupNames = window.groupNames || {};
                Object.keys(groupNames).forEach(groupId => {
                    const groupName = groupNames[groupId];
                    log(`  ${groupId} → ${groupName}`, 'info');
                });
                
                // 分析前10个排除人员
                log('排除人员详细分析:', 'info');
                excludedMembers.slice(0, 10).forEach((excluded, index) => {
                    log(`${index + 1}. 排除人员: "${excluded.name}" (${excluded.group}) [UUID: ${excluded.uuid ? excluded.uuid.substring(0, 8) + '...' : '无'}]`, 'info');
                    
                    // 通过组别名称找到对应的组别ID（支持双向匹配）
                    let targetGroupId = null;
                    let matchType = '';
                    
                    // 1. 直接组别ID匹配
                    if (groups[excluded.group]) {
                        targetGroupId = excluded.group;
                        matchType = '直接ID匹配';
                    } else {
                        // 2. 通过组别名称映射匹配
                        Object.keys(groupNames).forEach(groupId => {
                            if (groupNames[groupId] === excluded.group) {
                                targetGroupId = groupId;
                                matchType = '名称映射匹配';
                            }
                        });
                    }
                    
                    if (!targetGroupId) {
                        log(`   ❌ 组别名称不存在: ${excluded.group}`, 'warning');
                        
                        // 尝试在所有组中搜索该成员
                        log(`   🔍 在所有组中搜索成员 "${excluded.name}":`, 'info');
                        let foundInGroups = [];
                        
                        Object.keys(groups).forEach(groupId => {
                            const groupMembers = groups[groupId];
                            const groupName = groupNames[groupId] || groupId;
                            
                            groupMembers.forEach(member => {
                                if (member.name === excluded.name) {
                                    foundInGroups.push(`${groupName} (${groupId})`);
                                } else {
                                    const memberNickname = member.nickname || member.Nickname || member.花名 || member.alias || '';
                                    if (memberNickname && memberNickname === excluded.name) {
                                        foundInGroups.push(`${groupName} (${groupId}) - 花名匹配`);
                                    }
                                }
                            });
                        });
                        
                        if (foundInGroups.length > 0) {
                            log(`   🎯 找到成员在以下组中:`, 'success');
                            foundInGroups.forEach(group => {
                                log(`      - ${group}`, 'success');
                            });
                        } else {
                            log(`   ❌ 在所有组中都未找到该成员`, 'error');
                        }
                    } else {
                        log(`   ✅ 找到组别ID: ${targetGroupId} (${matchType})`, 'success');
                        
                        // 在该组中查找相似成员
                        const groupMembers = groups[targetGroupId];
                        let foundSimilar = [];
                        
                        groupMembers.forEach(member => {
                            if (member.name === excluded.name) {
                                foundSimilar.push(`完全匹配: ${member.name}`);
                            } else if (member.name.includes(excluded.name) || excluded.name.includes(member.name)) {
                                foundSimilar.push(`部分匹配: ${member.name}`);
                            }
                            
                            const memberNickname = member.nickname || member.Nickname || member.花名 || member.alias || '';
                            if (memberNickname && memberNickname === excluded.name) {
                                foundSimilar.push(`花名匹配: ${memberNickname} → ${member.name}`);
                            } else if (memberNickname && (memberNickname.includes(excluded.name) || excluded.name.includes(memberNickname))) {
                                foundSimilar.push(`花名部分匹配: ${memberNickname} → ${member.name}`);
                            }
                        });
                        
                        if (foundSimilar.length > 0) {
                            log(`   🎯 找到相似成员:`, 'success');
                            foundSimilar.forEach(similar => {
                                log(`      - ${similar}`, 'success');
                            });
                        } else {
                            log(`   ❌ 在该组中未找到相似成员`, 'error');
                        }
                    }
                });
                
                log('排除人员匹配调试完成', 'success');
                
            } catch (error) {
                log(`调试失败: ${error.message}`, 'error');
            }
        }

        // 升级排除人员UUID
        async function upgradeExcludedMembersUUID() {
            log('开始升级排除人员UUID支持（支持姓名和花名匹配）...', 'info');
            
            try {
                const excludedMembersData = window.utils.loadExcludedMembers();
                const excludedMembers = Array.isArray(excludedMembersData) ? excludedMembersData : Object.values(excludedMembersData || {});
                const groups = window.groups || {};
                const groupNames = window.groupNames || {};
                
                // 升级排除人员UUID
                const upgradedMembers = excludedMembers.map(excluded => {
                    // 如果已经有UUID，直接返回
                    if (excluded.uuid) {
                        return excluded;
                    }
                    
                    // 查找匹配的成员（支持姓名和花名匹配）
                    let foundMember = null;
                    let actualGroupId = null;
                    let actualGroupName = null;
                    let matchType = '';
                    
                    // 1. 通过组别名称找到组别ID
                    let targetGroupId = null;
                    Object.keys(groupNames).forEach(groupId => {
                        if (groupNames[groupId] === excluded.group) {
                            targetGroupId = groupId;
                        }
                    });
                    
                    if (targetGroupId && groups[targetGroupId]) {
                        // 在该组中查找匹配成员
                        const groupMembers = groups[targetGroupId];
                        groupMembers.forEach(member => {
                            if (foundMember) return;
                            
                            // 直接姓名匹配
                            if (member.name === excluded.name) {
                                foundMember = member;
                                actualGroupId = targetGroupId;
                                actualGroupName = excluded.group;
                                matchType = '直接姓名匹配';
                            }
                            // 花名匹配
                            else {
                                const memberNickname = member.nickname || member.Nickname || member.花名 || member.alias || '';
                                if (memberNickname && memberNickname === excluded.name) {
                                    foundMember = member;
                                    actualGroupId = targetGroupId;
                                    actualGroupName = excluded.group;
                                    matchType = '花名匹配';
                                }
                            }
                        });
                    }
                    
                    // 2. 如果没找到，在所有组中搜索
                    if (!foundMember) {
                        Object.keys(groups).forEach(groupId => {
                            if (foundMember) return;
                            
                            const groupMembers = groups[groupId];
                            const groupName = groupNames[groupId] || groupId;
                            
                            groupMembers.forEach(member => {
                                if (foundMember) return;
                                
                                // 直接姓名匹配
                                if (member.name === excluded.name) {
                                    foundMember = member;
                                    actualGroupId = groupId;
                                    actualGroupName = groupName;
                                    matchType = '跨组姓名匹配';
                                }
                                // 花名匹配
                                else {
                                    const memberNickname = member.nickname || member.Nickname || member.花名 || member.alias || '';
                                    if (memberNickname && memberNickname === excluded.name) {
                                        foundMember = member;
                                        actualGroupId = groupId;
                                        actualGroupName = groupName;
                                        matchType = '跨组花名匹配';
                                    }
                                }
                            });
                        });
                    }
                    
                    // 如果找到匹配的成员，复制UUID
                    if (foundMember && foundMember.uuid) {
                        log(`升级: ${excluded.name} (${excluded.group} → ${actualGroupName}) [${matchType}] UUID: ${foundMember.uuid.substring(0, 8)}...`, 'success');
                        return {
                            ...excluded,
                            uuid: foundMember.uuid,
                            group: actualGroupName  // 更新为实际组别名称
                        };
                    } else {
                        log(`警告: 未找到 ${excluded.name} (${excluded.group}) 的匹配成员`, 'warning');
                        return excluded;
                    }
                });
                
                const upgradedCount = upgradedMembers.filter(member => member.uuid).length;
                log(`升级完成，共 ${upgradedCount} 个排除人员有UUID`, 'success');
                
                // 保存升级后的数据
                localStorage.setItem('msh_excludedMembers', JSON.stringify(upgradedMembers));
                log('已保存到本地存储', 'success');
                
                // 同步到Firebase
                try {
                    if (window.db) {
                        await window.db.ref('excludedMembers').set(upgradedMembers);
                        log('已同步到Firebase', 'success');
                    } else {
                        log('Firebase不可用，无法同步', 'warning');
                    }
                } catch (error) {
                    log(`同步到Firebase失败: ${error.message}`, 'error');
                }
                
                // 更新全局变量
                if (window.excludedMembers !== undefined) {
                    // 转换为对象格式
                    const excludedMembersObj = {};
                    upgradedMembers.forEach((member, index) => {
                        excludedMembersObj[member.uuid || `member_${index}`] = member;
                    });
                    window.excludedMembers = excludedMembersObj;
                    log('已更新全局变量', 'success');
                }
                
                // 提示用户刷新日报表页面
                log('请刷新日报表页面查看效果', 'info');
                
            } catch (error) {
                log(`升级失败: ${error.message}`, 'error');
            }
        }

        // 页面卸载前提醒保存
        window.addEventListener('beforeunload', (e) => {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = '您有未保存的更改，确定要离开吗？';
            }
        });
    </script>
</body>
</html>
