<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UUIDç¼–è¾‘å™¨ - ç­¾åˆ°è®°å½•ç®¡ç†</title>
    
    <!-- Firebase SDK v8 (å…¼å®¹ç‰ˆæœ¬) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- ç³»ç»Ÿä¾èµ–æ–‡ä»¶ -->
    <script src="../../src/smart-config-loader.js"></script>
    <script src="../../src/utils.js"></script>
    <script src="../../src/new-data-manager.js"></script>
    
    <!-- å¤–éƒ¨æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="../../src/uuid-editor.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ UUIDç¼–è¾‘å™¨ - ç­¾åˆ°è®°å½•ç®¡ç†</h1>
            <div>
                <button onclick="goBackToGroupManagement()" class="back-button">æˆå‘˜ç®¡ç†</button>
                <button onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®ï¼ˆæœ¬åœ°ï¼‰</button>
                <button onclick="loadDataFromFirebase()">â˜ï¸ ä»FirebaseåŠ è½½</button>
                <button onclick="checkSystemStatus()">ğŸ” æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
                <button onclick="initializeSystem()">âš™ï¸ åˆå§‹åŒ–ç³»ç»Ÿ</button>
                <button onclick="debugExcludedMembers()" class="warning-button">ğŸ” è°ƒè¯•æ’é™¤äººå‘˜</button>
                <button onclick="upgradeExcludedMembersUUID()" class="danger-button">âš ï¸ å‡çº§æ’é™¤äººå‘˜UUID</button>
                <button onclick="saveAllChanges()" class="success-button">ğŸ’¾ ä¿å­˜æ‰€æœ‰æ›´æ”¹</button>
            </div>
        </div>
        
        <div class="warning hidden" id="saveWarning">
            <h4>âš ï¸ é‡è¦æé†’</h4>
            <p>æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼è¯·ç‚¹å‡»"ä¿å­˜æ‰€æœ‰æ›´æ”¹"æŒ‰é’®å°†æ•°æ®åŒæ­¥åˆ°Firebaseï¼Œå¦åˆ™æ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ°ã€‚</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalRecords">0</div>
                <div class="stat-label">æ€»è®°å½•æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="missingUUID">0</div>
                <div class="stat-label">ç¼ºå°‘UUID</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="hasUUID">0</div>
                <div class="stat-label">æœ‰UUID</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="coverage">0%</div>
                <div class="stat-label">UUIDè¦†ç›–ç‡</div>
            </div>
        </div>
        
        <div class="filters">
            <label for="dateFilter">æ—¥æœŸç­›é€‰ï¼š</label>
            <input type="date" id="dateFilter" title="é€‰æ‹©æ—¥æœŸè¿›è¡Œç­›é€‰" onchange="filterRecords()">
            <label for="groupFilter">ç»„åˆ«ç­›é€‰ï¼š</label>
            <select id="groupFilter" title="é€‰æ‹©ç»„åˆ«è¿›è¡Œç­›é€‰" onchange="filterRecords()">
                <option value="">æ‰€æœ‰ç»„åˆ«</option>
            </select>
            <label for="uuidFilter">UUIDçŠ¶æ€ï¼š</label>
            <select id="uuidFilter" title="é€‰æ‹©UUIDçŠ¶æ€è¿›è¡Œç­›é€‰" onchange="filterRecords()">
                <option value="">å…¨éƒ¨</option>
                <option value="missing">ç¼ºå°‘UUID</option>
                <option value="has">æœ‰UUID</option>
            </select>
            <label for="memberSearch">æˆå‘˜æœç´¢ï¼š</label>
            <input type="text" id="memberSearch" placeholder="è¾“å…¥å§“åæˆ–èŠ±å" title="è¾“å…¥æˆå‘˜å§“åæˆ–èŠ±åè¿›è¡Œæœç´¢" onkeyup="filterRecords()">
        </div>
        
        <div class="actions">
            <button onclick="autoFillUUIDs()" class="success-button">è‡ªåŠ¨å¡«å……UUID</button>
            <button onclick="detectDuplicateNames()" class="warning-button">ğŸ” åŒåæ£€æµ‹</button>
            <button onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
        </div>
        
        <div class="table-container">
            <table id="recordsTable">
                <thead>
                    <tr>
                        <th>é€‰æ‹©</th>
                        <th>æ—¥æœŸ</th>
                        <th>æ—¶é—´</th>
                        <th>ç»„åˆ«</th>
                        <th>æˆå‘˜å§“å</th>
                        <th>UUID</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="recordsBody">
                </tbody>
            </table>
        </div>
        
        <div class="log" id="log">
            <div>ğŸ”§ UUIDç¼–è¾‘å™¨å·²åŠ è½½</div>
            <div>ğŸ’¡ æç¤ºï¼šå¦‚éœ€ç¼–è¾‘UUIDï¼Œè¯·å…ˆç‚¹å‡»"ä»FirebaseåŠ è½½"æŒ‰é’®åŠ è½½å…¨éƒ¨ç­¾åˆ°è®°å½•</div>
        </div>
    </div>

    <script>
        let allRecords = [];
        let filteredRecords = [];
        let groups = {};
        let groupNames = {};
        let hasChanges = false;
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // åŠ è½½æ•°æ®ï¼ˆä»æœ¬åœ°ï¼‰
        function loadData() {
            log('å¼€å§‹åŠ è½½æ•°æ®ï¼ˆæœ¬åœ°ä¼˜å…ˆï¼‰...');
            
            try {
                // åŠ è½½ç­¾åˆ°è®°å½•
                allRecords = window.attendanceRecords || [];
                if (allRecords.length === 0) {
                    const storedRecords = localStorage.getItem('msh_attendanceRecords');
                    if (storedRecords) {
                        allRecords = JSON.parse(storedRecords);
                        window.attendanceRecords = allRecords;
                        log(`ä»æœ¬åœ°å­˜å‚¨è¯»å–ç­¾åˆ°è®°å½•: ${allRecords.length} æ¡`);
                    }
                }
                
                // åŠ è½½ç»„åˆ«æ•°æ®
                groups = window.groups || {};
                if (Object.keys(groups).length === 0) {
                    const storedGroups = localStorage.getItem('msh_groups');
                    if (storedGroups) {
                        groups = JSON.parse(storedGroups);
                        window.groups = groups;
                    }
                }
                
                // åŠ è½½ç»„åˆ«åç§°
                groupNames = window.groupNames || {};
                if (Object.keys(groupNames).length === 0) {
                    const storedGroupNames = localStorage.getItem('msh_group_names');
                    if (storedGroupNames) {
                        groupNames = JSON.parse(storedGroupNames);
                        window.groupNames = groupNames;
                    }
                }
                
                // åŠ è½½æ’é™¤äººå‘˜æ•°æ®
                if (!window.excludedMembers || Object.keys(window.excludedMembers).length === 0) {
                    const storedExcludedMembers = localStorage.getItem('msh_excludedMembers');
                    if (storedExcludedMembers) {
                        try {
                            const excludedData = JSON.parse(storedExcludedMembers);
                            // ç¡®ä¿è½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼
                            if (Array.isArray(excludedData)) {
                                window.excludedMembers = {};
                                excludedData.forEach((member, index) => {
                                    window.excludedMembers[member.uuid || `member_${index}`] = member;
                                });
                            } else {
                                window.excludedMembers = excludedData;
                            }
                            log(`ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ’é™¤äººå‘˜æ•°æ®: ${Object.keys(window.excludedMembers).length} ä¸ª`);
                        } catch (error) {
                            log(`åŠ è½½æ’é™¤äººå‘˜æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                            window.excludedMembers = {};
                        }
                    } else {
                        // å°è¯•ä»FirebaseåŠ è½½
                        log('æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰æ’é™¤äººå‘˜æ•°æ®ï¼Œå°è¯•ä»FirebaseåŠ è½½...');
                        try {
                            if (window.db) {
                                window.db.ref('excludedMembers').once('value').then(snapshot => {
                                    if (snapshot.exists()) {
                                        const firebaseData = snapshot.val();
                                        log(`ä»Firebaseè·å–åˆ°æ’é™¤äººå‘˜æ•°æ®: ${Array.isArray(firebaseData) ? firebaseData.length : Object.keys(firebaseData || {}).length} ä¸ª`);
                                        
                                        // è½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼
                                        if (Array.isArray(firebaseData)) {
                                            window.excludedMembers = {};
                                            firebaseData.forEach((member, index) => {
                                                window.excludedMembers[member.uuid || `member_${index}`] = member;
                                            });
                                        } else {
                                            window.excludedMembers = firebaseData || {};
                                        }
                                        
                                        // ä¿å­˜åˆ°localStorage
                                        localStorage.setItem('msh_excludedMembers', JSON.stringify(window.excludedMembers));
                                        log(`å·²ä»FirebaseåŠ è½½å¹¶ä¿å­˜æ’é™¤äººå‘˜æ•°æ®: ${Object.keys(window.excludedMembers).length} ä¸ª`);
                                    } else {
                                        log('Firebaseä¸­ä¹Ÿæ²¡æœ‰æ’é™¤äººå‘˜æ•°æ®');
                                        window.excludedMembers = {};
                                    }
                                }).catch(error => {
                                    log(`ä»FirebaseåŠ è½½æ’é™¤äººå‘˜æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                                    window.excludedMembers = {};
                                });
                            } else {
                                log('Firebaseä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½æ’é™¤äººå‘˜æ•°æ®');
                                window.excludedMembers = {};
                            }
                        } catch (error) {
                            log(`FirebaseåŠ è½½è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
                            window.excludedMembers = {};
                        }
                    }
                } else {
                    log(`ä½¿ç”¨å·²æœ‰çš„æ’é™¤äººå‘˜æ•°æ®: ${Object.keys(window.excludedMembers).length} ä¸ª`);
                }
                
                if (allRecords.length === 0) {
                    log('æœªæ‰¾åˆ°ç­¾åˆ°è®°å½•æ•°æ®', 'error');
                    return;
                }
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateStats();
                
                // åŠ è½½ç­›é€‰å™¨é€‰é¡¹
                loadFilterOptions();
                
                // æ˜¾ç¤ºæ‰€æœ‰è®°å½•
                filteredRecords = [...allRecords];
                displayRecords();
                
                log(`æ•°æ®åŠ è½½å®Œæˆ: ${allRecords.length} æ¡è®°å½•`, 'success');
                
            } catch (error) {
                log(`æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // ã€æ–°å¢ã€‘ä»FirebaseåŠ è½½å…¨éƒ¨æ•°æ®ï¼ˆå·¥å…·è½¯ä»¶éœ€è¦ï¼‰
        async function loadDataFromFirebase() {
            log('ğŸ”„ å¼€å§‹ä»FirebaseåŠ è½½å…¨éƒ¨æ•°æ®...', 'info');
            
            try {
                // ç¡®ä¿Firebaseå·²åˆå§‹åŒ–
                if (!window.db) {
                    log('âš ï¸ Firebaseæœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–...', 'info');
                    const initOk = initializeFirebase();
                    if (!initOk) {
                        log('âŒ Firebaseåˆå§‹åŒ–å¤±è´¥ï¼Œæ— æ³•åŠ è½½æ•°æ®', 'error');
                        alert('Firebaseåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ï¼');
                        return;
                    }
                }
                
                log('ğŸ“¡ æ­£åœ¨ä»FirebaseåŠ è½½æ•°æ®ï¼Œè¯·ç¨å€™...', 'info');
                
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
                const [recordsSnap, groupsSnap, groupNamesSnap, excludedSnap] = await Promise.all([
                    window.db.ref('attendanceRecords').once('value'),
                    window.db.ref('groups').once('value'),
                    window.db.ref('groupNames').once('value'),
                    window.db.ref('excludedMembers').once('value')
                ]);
                
                // å¤„ç†ç­¾åˆ°è®°å½•
                const firebaseRecords = recordsSnap.val();
                log(`ğŸ” FirebaseåŸå§‹æ•°æ®ç±»å‹: ${Array.isArray(firebaseRecords) ? 'Array' : typeof firebaseRecords}`, 'info');
                
                if (firebaseRecords) {
                    // Firebaseæ•°æ®å¯èƒ½æ˜¯å¯¹è±¡æˆ–æ•°ç»„
                    if (Array.isArray(firebaseRecords)) {
                        allRecords = firebaseRecords;
                        log(`ğŸ” Firebaseæ•°æ®æ˜¯æ•°ç»„ï¼Œç›´æ¥ä½¿ç”¨: ${allRecords.length} æ¡`, 'info');
                    } else if (typeof firebaseRecords === 'object') {
                        allRecords = Object.values(firebaseRecords);
                        log(`ğŸ” Firebaseæ•°æ®æ˜¯å¯¹è±¡ï¼Œè½¬æ¢ä¸ºæ•°ç»„: ${Object.keys(firebaseRecords).length} ä¸ªé”® â†’ ${allRecords.length} æ¡è®°å½•`, 'info');
                    } else {
                        log(`âš ï¸ Firebaseæ•°æ®æ ¼å¼å¼‚å¸¸: ${typeof firebaseRecords}`, 'warning');
                        allRecords = [];
                    }
                    
                    // è¿‡æ»¤æ— æ•ˆæ•°æ®
                    const validRecords = allRecords.filter(record => record && record.name && record.time);
                    if (validRecords.length !== allRecords.length) {
                        log(`âš ï¸ è¿‡æ»¤äº† ${allRecords.length - validRecords.length} æ¡æ— æ•ˆè®°å½•`, 'warning');
                        allRecords = validRecords;
                    }
                    
                    window.attendanceRecords = allRecords;
                    localStorage.setItem('msh_attendanceRecords', JSON.stringify(allRecords));
                    log(`âœ… ç­¾åˆ°è®°å½•åŠ è½½å®Œæˆ: ${allRecords.length} æ¡`, 'success');
                    
                    // æ˜¾ç¤ºè®°å½•çš„æ—¥æœŸèŒƒå›´
                    if (allRecords.length > 0) {
                        const dates = allRecords.map(r => new Date(r.time)).sort((a, b) => a - b);
                        const earliest = dates[0].toLocaleDateString('zh-CN');
                        const latest = dates[dates.length - 1].toLocaleDateString('zh-CN');
                        log(`ğŸ“… è®°å½•æ—¥æœŸèŒƒå›´: ${earliest} è‡³ ${latest}`, 'info');
                    }
                } else {
                    log('âš ï¸ Firebaseä¸­æ²¡æœ‰ç­¾åˆ°è®°å½•æ•°æ®', 'warning');
                    allRecords = [];
                }
                
                // å¤„ç†ç»„åˆ«æ•°æ®
                groups = groupsSnap.val() || {};
                window.groups = groups;
                localStorage.setItem('msh_groups', JSON.stringify(groups));
                log(`âœ… ç»„åˆ«æ•°æ®åŠ è½½å®Œæˆ: ${Object.keys(groups).length} ä¸ªç»„`, 'success');
                
                // å¤„ç†ç»„åˆ«åç§°
                groupNames = groupNamesSnap.val() || {};
                window.groupNames = groupNames;
                localStorage.setItem('msh_group_names', JSON.stringify(groupNames));
                log(`âœ… ç»„åˆ«åç§°åŠ è½½å®Œæˆ: ${Object.keys(groupNames).length} ä¸ª`, 'success');
                
                // å¤„ç†æ’é™¤äººå‘˜
                const excludedData = excludedSnap.val();
                if (excludedData) {
                    // è½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼
                    if (Array.isArray(excludedData)) {
                        window.excludedMembers = {};
                        excludedData.forEach((member, index) => {
                            window.excludedMembers[member.uuid || `member_${index}`] = member;
                        });
                    } else {
                        window.excludedMembers = excludedData;
                    }
                    localStorage.setItem('msh_excludedMembers', JSON.stringify(excludedData));
                    log(`âœ… æ’é™¤äººå‘˜åŠ è½½å®Œæˆ: ${Array.isArray(excludedData) ? excludedData.length : Object.keys(excludedData).length} ä¸ª`, 'success');
                } else {
                    log('âš ï¸ Firebaseä¸­æ²¡æœ‰æ’é™¤äººå‘˜æ•°æ®', 'warning');
                }
                
                // æ›´æ–°UI
                updateStats();
                loadFilterOptions();
                filteredRecords = [...allRecords];
                displayRecords();
                
                log('ğŸ‰ ä»FirebaseåŠ è½½å…¨éƒ¨æ•°æ®å®Œæˆï¼', 'success');
                alert('âœ… æ•°æ®åŠ è½½æˆåŠŸï¼\n\n' + 
                      `ç­¾åˆ°è®°å½•ï¼š${allRecords.length} æ¡\n` +
                      `ç»„åˆ«ï¼š${Object.keys(groups).length} ä¸ª\n` +
                      `æ’é™¤äººå‘˜ï¼š${window.excludedMembers ? Object.keys(window.excludedMembers).length : 0} ä¸ª`);
                
            } catch (error) {
                log(`âŒ ä»FirebaseåŠ è½½æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                alert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒFirebaseé…ç½®ï¼\n\né”™è¯¯ä¿¡æ¯ï¼š' + error.message);
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const total = allRecords.length;
            const missing = allRecords.filter(record => !record.memberUUID).length;
            const has = total - missing;
            const coverage = total > 0 ? Math.round((has / total) * 100) : 0;
            
            document.getElementById('totalRecords').textContent = total;
            document.getElementById('missingUUID').textContent = missing;
            document.getElementById('hasUUID').textContent = has;
            document.getElementById('coverage').textContent = coverage + '%';
        }
        
        // åŠ è½½ç­›é€‰å™¨é€‰é¡¹
        function loadFilterOptions() {
            const groupFilter = document.getElementById('groupFilter');
            groupFilter.innerHTML = '<option value="">æ‰€æœ‰ç»„åˆ«</option>';
            
            const uniqueGroups = [...new Set(allRecords.map(record => record.group))];
            log(`åŠ è½½ç»„åˆ«ç­›é€‰å™¨ï¼Œå‘ç° ${uniqueGroups.length} ä¸ªç»„åˆ«: ${uniqueGroups.join(', ')}`, 'info');
            
            uniqueGroups.sort().forEach(groupId => {
                const option = document.createElement('option');
                option.value = groupId;
                option.textContent = groupNames[groupId] || groupId;
                groupFilter.appendChild(option);
                log(`æ·»åŠ ç»„åˆ«é€‰é¡¹: ${groupId} â†’ ${groupNames[groupId] || groupId}`, 'info');
            });
        }
        
        // ç­›é€‰è®°å½•
        function filterRecords() {
            const dateFilter = document.getElementById('dateFilter').value;
            const groupFilter = document.getElementById('groupFilter').value;
            const uuidFilter = document.getElementById('uuidFilter').value;
            const memberSearch = document.getElementById('memberSearch').value.toLowerCase();
            
            log(`ç­›é€‰æ¡ä»¶: æ—¥æœŸ=${dateFilter}, ç»„åˆ«=${groupFilter}, UUID=${uuidFilter}, æœç´¢="${memberSearch}"`, 'info');
            
            filteredRecords = allRecords.filter(record => {
                // æ—¥æœŸç­›é€‰
                if (dateFilter) {
                    const recordDate = new Date(record.time).toISOString().split('T')[0];
                    if (recordDate !== dateFilter) return false;
                }
                
                // ç»„åˆ«ç­›é€‰
                if (groupFilter && record.group !== groupFilter) {
                    return false;
                }
                
                // UUIDçŠ¶æ€ç­›é€‰
                if (uuidFilter === 'missing' && record.memberUUID) return false;
                if (uuidFilter === 'has' && !record.memberUUID) return false;
                
                // æˆå‘˜æœç´¢ï¼ˆæ”¯æŒå§“åå’ŒèŠ±åï¼‰
                if (memberSearch) {
                    const nameMatch = record.name && record.name.toLowerCase().includes(memberSearch);
                    const nicknameMatch = record.nickname && record.nickname.toLowerCase().includes(memberSearch);
                    const aliasMatch = record.alias && record.alias.toLowerCase().includes(memberSearch);
                    const èŠ±åMatch = record.èŠ±å && record.èŠ±å.toLowerCase().includes(memberSearch);
                    
                    if (!nameMatch && !nicknameMatch && !aliasMatch && !èŠ±åMatch) return false;
                }
                
                return true;
            });
            
            displayRecords();
            log(`ç­›é€‰å®Œæˆ: æ˜¾ç¤º ${filteredRecords.length} æ¡è®°å½•`);
        }
        
        // æ˜¾ç¤ºè®°å½•
        function displayRecords() {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';
            
            filteredRecords.forEach((record, index) => {
                const row = document.createElement('tr');
                const hasUUID = !!record.memberUUID;
                
                row.className = hasUUID ? 'has-uuid' : 'missing-uuid';
                
                const recordDate = new Date(record.time).toLocaleDateString('zh-CN');
                const recordTime = new Date(record.time).toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // ä½¿ç”¨æ›´ç¨³å®šçš„æ ‡è¯†ç¬¦ï¼šä¼˜å…ˆä½¿ç”¨recordIdï¼Œå¦åˆ™ä½¿ç”¨è®°å½•çš„åŸå§‹ç´¢å¼•
                let recordId;
                if (record.recordId) {
                    recordId = record.recordId;
                } else {
                    // ä½¿ç”¨è®°å½•åœ¨allRecordsä¸­çš„åŸå§‹ç´¢å¼•
                    const originalIndex = allRecords.findIndex(r => 
                        r.name === record.name && 
                        r.group === record.group && 
                        r.time === record.time
                    );
                    recordId = `temp_${originalIndex}`;
                }
                
                row.innerHTML = `
                    <td><input type="checkbox" onchange="toggleSelection('${recordId}')"></td>
                    <td>${recordDate}</td>
                    <td>${recordTime}</td>
                    <td>${groupNames[record.group] || record.group}</td>
                    <td>${record.name}</td>
                    <td class="uuid-cell" id="uuid-${recordId}">${record.memberUUID || 'ç¼ºå°‘UUID'}</td>
                    <td>
                        <button class="edit-button" onclick="editUUID('${recordId}')">ç¼–è¾‘</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // ç¼–è¾‘UUID
        function editUUID(recordId) {
            log(`å¼€å§‹ç¼–è¾‘è®°å½•ID: ${recordId}`);
            
            // æŸ¥æ‰¾å¯¹åº”çš„è®°å½•
            let record = null;
            
            for (let i = 0; i < filteredRecords.length; i++) {
                const r = filteredRecords[i];
                let currentRecordId;
                
                if (r.recordId) {
                    currentRecordId = r.recordId;
                } else {
                    // ä½¿ç”¨è®°å½•åœ¨allRecordsä¸­çš„åŸå§‹ç´¢å¼•
                    const originalIndex = allRecords.findIndex(ar => 
                        ar.name === r.name && 
                        ar.group === r.group && 
                        ar.time === r.time
                    );
                    currentRecordId = `temp_${originalIndex}`;
                }
                
                if (currentRecordId === recordId) {
                    record = r;
                    log(`æ‰¾åˆ°è®°å½•: ${r.name} (${r.group}), åŸå§‹ç´¢å¼•: ${allRecords.findIndex(ar => ar.name === r.name && ar.group === r.group && ar.time === r.time)}`);
                    break;
                }
            }
            
            if (!record) {
                log(`æœªæ‰¾åˆ°è®°å½•ID: ${recordId}`, 'error');
                return;
            }
            
            const uuidCell = document.getElementById(`uuid-${recordId}`);
            const row = uuidCell.closest('tr');
            
            if (row.classList.contains('editing')) {
                return; // å·²ç»åœ¨ç¼–è¾‘çŠ¶æ€
            }
            
            row.classList.add('editing');
            
            const currentUUID = record.memberUUID || '';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'input-field';
            input.value = currentUUID;
            input.placeholder = 'è¾“å…¥UUIDæˆ–ç•™ç©º';
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.marginTop = '5px';
            
            const saveButton = document.createElement('button');
            saveButton.className = 'save-button';
            saveButton.textContent = 'ä¿å­˜';
            saveButton.onclick = () => saveUUID(recordId, input.value);
            
            const cancelButton = document.createElement('button');
            cancelButton.className = 'cancel-button';
            cancelButton.textContent = 'å–æ¶ˆ';
            cancelButton.onclick = () => cancelEdit(recordId);
            
            buttonContainer.appendChild(saveButton);
            buttonContainer.appendChild(cancelButton);
            
            uuidCell.innerHTML = '';
            uuidCell.appendChild(input);
            uuidCell.appendChild(buttonContainer);
            
            input.focus();
        }
        
        // ä¿å­˜UUID
        function saveUUID(recordId, newUUID) {
            log(`å¼€å§‹ä¿å­˜UUID: ${recordId} -> ${newUUID}`);
            
            // æŸ¥æ‰¾å¯¹åº”çš„è®°å½•
            let record = null;
            
            for (let i = 0; i < filteredRecords.length; i++) {
                const r = filteredRecords[i];
                let currentRecordId;
                
                if (r.recordId) {
                    currentRecordId = r.recordId;
                } else {
                    // ä½¿ç”¨è®°å½•åœ¨allRecordsä¸­çš„åŸå§‹ç´¢å¼•
                    const originalIndex = allRecords.findIndex(ar => 
                        ar.name === r.name && 
                        ar.group === r.group && 
                        ar.time === r.time
                    );
                    currentRecordId = `temp_${originalIndex}`;
                }
                
                if (currentRecordId === recordId) {
                    record = r;
                    log(`æ‰¾åˆ°è¦ä¿å­˜çš„è®°å½•: ${r.name} (${r.group})`);
                    break;
                }
            }
            
            if (!record) {
                log(`æœªæ‰¾åˆ°è®°å½•ID: ${recordId}`, 'error');
                return;
            }
            
            // æŸ¥æ‰¾åŸå§‹è®°å½•
            let originalRecord = null;
            if (record.recordId) {
                originalRecord = allRecords.find(r => r.recordId === record.recordId);
            } else {
                // é€šè¿‡å§“åã€ç»„åˆ«ã€æ—¶é—´åŒ¹é…
                originalRecord = allRecords.find(r => 
                    r.name === record.name && 
                    r.group === record.group && 
                    r.time === record.time
                );
            }
            
            if (originalRecord) {
                originalRecord.memberUUID = newUUID.trim() || null;
                hasChanges = true;
                showSaveWarning();
                log(`å·²æ›´æ–° ${record.name} çš„UUID: ${newUUID || 'å·²æ¸…é™¤'}`, 'success');
            } else {
                log(`æœªæ‰¾åˆ°åŸå§‹è®°å½•: ${record.name}`, 'error');
            }
            
            // é‡æ–°æ˜¾ç¤ºè®°å½•
            displayRecords();
            updateStats();
        }
        
        // å–æ¶ˆç¼–è¾‘
        function cancelEdit(recordId) {
            displayRecords();
        }
        
        // åˆ‡æ¢é€‰æ‹©çŠ¶æ€
        function toggleSelection(recordId) {
            // æŸ¥æ‰¾å¯¹åº”çš„è®°å½•
            let record = null;
            
            for (let i = 0; i < filteredRecords.length; i++) {
                const r = filteredRecords[i];
                let currentRecordId;
                
                if (r.recordId) {
                    currentRecordId = r.recordId;
                } else {
                    // ä½¿ç”¨è®°å½•åœ¨allRecordsä¸­çš„åŸå§‹ç´¢å¼•
                    const originalIndex = allRecords.findIndex(ar => 
                        ar.name === r.name && 
                        ar.group === r.group && 
                        ar.time === r.time
                    );
                    currentRecordId = `temp_${originalIndex}`;
                }
                
                if (currentRecordId === recordId) {
                    record = r;
                    break;
                }
            }
            
            if (record) {
                log(`${record.name} (${record.group}) é€‰æ‹©çŠ¶æ€å·²åˆ‡æ¢`);
            }
        }
        
        
        // è‡ªåŠ¨å¡«å……UUID
        function autoFillUUIDs() {
            let filledCount = 0;
            
            filteredRecords.forEach(record => {
                if (!record.memberUUID) {
                    // æŸ¥æ‰¾å¯¹åº”çš„æˆå‘˜
                    const member = findMemberByName(record.name, record.group);
                    if (member && member.uuid) {
                        const originalRecord = allRecords.find(r => r.recordId === record.recordId);
                        if (originalRecord) {
                            originalRecord.memberUUID = member.uuid;
                            filledCount++;
                        }
                    }
                }
            });
            
            hasChanges = true;
            showSaveWarning();
            displayRecords();
            updateStats();
            log(`è‡ªåŠ¨å¡«å……å®Œæˆ: ${filledCount} ä¸ªUUIDå·²å¡«å……`, 'success');
        }
        
        // æŸ¥æ‰¾æˆå‘˜
        function findMemberByName(name, group) {
            if (groups[group]) {
                return groups[group].find(member => member.name === name);
            }
            return null;
        }
        
        // æ˜¾ç¤ºä¿å­˜è­¦å‘Š
        function showSaveWarning() {
            const warning = document.getElementById('saveWarning');
            if (warning) {
                warning.style.display = 'block';
            }
        }
        
        // éšè—ä¿å­˜è­¦å‘Š
        function hideSaveWarning() {
            const warning = document.getElementById('saveWarning');
            if (warning) {
                warning.style.display = 'none';
            }
        }
        
        
        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            document.getElementById('dateFilter').value = '';
            document.getElementById('groupFilter').value = '';
            document.getElementById('uuidFilter').value = '';
            document.getElementById('memberSearch').value = '';
            filterRecords();
        }
        
        // ä¿å­˜æ‰€æœ‰æ›´æ”¹ - ä½¿ç”¨ç›´æ¥FirebaseåŒæ­¥æœºåˆ¶
        async function saveAllChanges() {
            if (!hasChanges) {
                log('æ²¡æœ‰éœ€è¦ä¿å­˜çš„æ›´æ”¹', 'info');
                return;
            }
            
            try {
                log('å¼€å§‹ç›´æ¥åŒæ­¥æ‰€æœ‰æ›´æ”¹åˆ°Firebase...');
                
                // 1. ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('msh_attendanceRecords', JSON.stringify(allRecords));
                localStorage.setItem('msh_attendanceRecords_timestamp', Date.now().toString());
                log('âœ… æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                
                // 2. æ›´æ–°å…¨å±€å˜é‡
                window.attendanceRecords = allRecords;
                log('âœ… å…¨å±€å˜é‡å·²æ›´æ–°');
                
                // 3. ç›´æ¥FirebaseåŒæ­¥
                if (window.db) {
                    try {
                        log('ğŸ”„ æ­£åœ¨ç›´æ¥åŒæ­¥åˆ°Firebase...');
                        await window.db.ref('attendanceRecords').set(allRecords);
                        log('âœ… æ•°æ®å·²ç›´æ¥åŒæ­¥åˆ°Firebase', 'success');
                    } catch (firebaseError) {
                        log(`âŒ FirebaseåŒæ­¥å¤±è´¥: ${firebaseError.message}`, 'error');
                        throw firebaseError;
                    }
                } else {
                    log('âŒ Firebaseæœªåˆå§‹åŒ–ï¼Œæ— æ³•åŒæ­¥', 'error');
                    throw new Error('Firebaseæœªåˆå§‹åŒ–');
                }
                
                // 4. æ¸…é™¤å˜æ›´æ ‡å¿—
                hasChanges = false;
                hideSaveWarning();
                log('ğŸ‰ æ‰€æœ‰æ›´æ”¹å·²åŒæ­¥å®Œæˆï¼', 'success');
                
            } catch (error) {
                log(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                // ä¿å­˜å¤±è´¥æ—¶ï¼Œæ•°æ®ä»ç„¶åœ¨æœ¬åœ°å­˜å‚¨ä¸­ï¼Œç”¨æˆ·å¯ä»¥é‡è¯•
            }
        }
        
        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        function checkSystemStatus() {
            log('ğŸ” æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...');
            
            const status = {
                firebase: !!window.db,
                firebaseConfig: !!window.firebaseConfig,
                attendanceRecords: !!window.attendanceRecords,
                groups: !!window.groups
            };
            
            log(`Firebase: ${status.firebase ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`);
            log(`Firebaseé…ç½®: ${status.firebaseConfig ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`);
            log(`ç­¾åˆ°è®°å½•: ${status.attendanceRecords ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`);
            log(`æˆå‘˜æ•°æ®: ${status.groups ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`);
            
            if (!status.firebase) {
                log('âš ï¸ è­¦å‘Š: Firebaseæœªåˆå§‹åŒ–ï¼Œæ•°æ®å°†ä»…ä¿å­˜åœ¨æœ¬åœ°', 'error');
            }
            
            return status;
        }
        
        // åˆå§‹åŒ–Firebase
        function initializeFirebase() {
            try {
                if (window.firebaseConfig) {
                    // æ£€æŸ¥Firebaseæ˜¯å¦å·²ç»åˆå§‹åŒ–
                    if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length === 0) {
                        firebase.initializeApp(window.firebaseConfig);
                    }
                    
                    // è®¾ç½®æ•°æ®åº“å¼•ç”¨
                    if (typeof firebase !== 'undefined') {
                        window.db = firebase.database();
                        log('âœ… Firebaseåˆå§‹åŒ–æˆåŠŸ');
                        return true;
                    } else {
                        log('âŒ Firebase SDKæœªåŠ è½½', 'error');
                        return false;
                    }
                } else {
                    log('âŒ Firebaseé…ç½®æœªæ‰¾åˆ°', 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ Firebaseåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        // åˆå§‹åŒ–å®Œæˆæ£€æŸ¥
        function checkInitializationComplete() {
            const firebaseOk = !!window.db;
            const dataOk = !!window.attendanceRecords;
            
            if (firebaseOk && dataOk) {
                log('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œæ‰€æœ‰ç»„ä»¶å¯ç”¨', 'success');
                return true;
            } else {
                log('âš ï¸ ç³»ç»Ÿåˆå§‹åŒ–æœªå®Œæˆï¼Œéƒ¨åˆ†ç»„ä»¶ä¸å¯ç”¨', 'error');
                return false;
            }
        }
        
        // æ‰‹åŠ¨åˆå§‹åŒ–ç³»ç»Ÿ
        async function initializeSystem() {
            log('ğŸ”„ å¼€å§‹æ‰‹åŠ¨åˆå§‹åŒ–ç³»ç»Ÿ...');
            
            // ç­‰å¾…Firebase SDKåŠ è½½
            await waitForFirebase();
            
            const firebaseOk = initializeFirebase();
            
            if (firebaseOk) {
                log('ğŸ‰ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼', 'success');
            } else {
                log('âš ï¸ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥Firebaseé…ç½®', 'error');
            }
            
            // é‡æ–°æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
            setTimeout(() => {
                checkSystemStatus();
            }, 500);
        }
        
        // ç­‰å¾…Firebase SDKåŠ è½½
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (typeof firebase !== 'undefined') {
                        log('âœ… Firebase SDKå·²åŠ è½½');
                        resolve(true);
                    } else {
                        log('â³ ç­‰å¾…Firebase SDKåŠ è½½...');
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            log('ğŸ”§ UUIDç¼–è¾‘å™¨å·²åŠ è½½');
            
            // ç­‰å¾…Firebase SDKåŠ è½½
            await waitForFirebase();
            
            // åˆå§‹åŒ–Firebase
            const firebaseOk = initializeFirebase();
            
            // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
            setTimeout(() => {
                checkSystemStatus();
                
                // å°è¯•ä»æœ¬åœ°åŠ è½½æ•°æ®
                loadData();
                
                // å¦‚æœæœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œæç¤ºç”¨æˆ·
                if (allRecords.length === 0) {
                    log('âš ï¸ æœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œè¯·ç‚¹å‡»"ä»FirebaseåŠ è½½"æŒ‰é’®', 'warning');
                    alert('ğŸ’¡ æç¤ºï¼šæ£€æµ‹åˆ°æœ¬åœ°æ²¡æœ‰æ•°æ®\n\nè¯·ç‚¹å‡»"ä»FirebaseåŠ è½½"æŒ‰é’®åŠ è½½å…¨éƒ¨ç­¾åˆ°è®°å½•');
                }
            }, 1000);
        });
        
        // è¿”å›æˆå‘˜ç®¡ç†é¡µé¢
        function goBackToGroupManagement() {
            console.log('ğŸ” ç‚¹å‡»è¿”å›æˆå‘˜ç®¡ç†æŒ‰é’®');
            if (hasChanges) {
                const confirmLeave = confirm('æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ');
                if (!confirmLeave) {
                    console.log('âŒ ç”¨æˆ·å–æ¶ˆç¦»å¼€');
                    return;
                }
            }
            console.log('âœ… æ­£åœ¨è·³è½¬åˆ°æˆå‘˜ç®¡ç†é¡µé¢...');
            window.location.href = '../../group-management.html';
        }
        
        // åŒåæ£€æµ‹åŠŸèƒ½
        function detectDuplicateNames() {
            log('ğŸ” å¼€å§‹æ£€æµ‹åŒåè®°å½•...');
            
            // æŒ‰å§“ååˆ†ç»„
            const nameGroups = {};
            allRecords.forEach(record => {
                if (!nameGroups[record.name]) {
                    nameGroups[record.name] = [];
                }
                nameGroups[record.name].push(record);
            });
            
            // æ‰¾å‡ºæœ‰å¤šä¸ªUUIDçš„åŒåè®°å½•
            const duplicates = [];
            Object.keys(nameGroups).forEach(name => {
                const records = nameGroups[name];
                const uuids = new Set();
                
                records.forEach(record => {
                    if (record.memberUUID) {
                        uuids.add(record.memberUUID);
                    }
                });
                
                // å¦‚æœæœ‰å¤šä¸ªä¸åŒçš„UUIDï¼Œåˆ™è®¤ä¸ºæ˜¯é‡å¤
                if (uuids.size > 1) {
                    duplicates.push({
                        name: name,
                        records: records,
                        uuids: Array.from(uuids)
                    });
                }
            });
            
            if (duplicates.length === 0) {
                log('âœ… æœªå‘ç°åŒåä¸åŒUUIDçš„è®°å½•', 'success');
                alert('âœ… æ£€æµ‹å®Œæˆï¼æœªå‘ç°åŒåä¸åŒUUIDçš„å¼‚å¸¸æ•°æ®ï¼Œæ•°æ®ä¸€è‡´æ€§è‰¯å¥½ã€‚');
                return;
            }
            
            log(`âš ï¸ å‘ç° ${duplicates.length} ä¸ªåŒåä¸åŒUUIDçš„æƒ…å†µ:`, 'error');
            duplicates.forEach(duplicate => {
                log(`- ${duplicate.name}: ${duplicate.uuids.join(', ')}`, 'error');
            });
            
            // ç­›é€‰æ˜¾ç¤ºé‡å¤è®°å½•
            const duplicateRecords = [];
            duplicates.forEach(duplicate => {
                duplicateRecords.push(...duplicate.records);
            });
            
            filteredRecords = duplicateRecords;
            displayRecords();
            log(`å·²ç­›é€‰æ˜¾ç¤º ${duplicateRecords.length} æ¡é‡å¤è®°å½•`);
        }
        
        // ==================== æ’é™¤äººå‘˜UUIDç®¡ç†åŠŸèƒ½ ====================
        
        // è°ƒè¯•æ’é™¤äººå‘˜åŒ¹é…
        async function debugExcludedMembers() {
            log('å¼€å§‹è°ƒè¯•æ’é™¤äººå‘˜åŒ¹é…...', 'info');
            
            try {
                const excludedMembersData = window.utils.loadExcludedMembers();
                const excludedMembers = Array.isArray(excludedMembersData) ? excludedMembersData : Object.values(excludedMembersData || {});
                const groups = window.groups || {};
                
                log(`æ’é™¤äººå‘˜æ€»æ•°: ${excludedMembers.length}`, 'info');
                log(`å®é™…å°ç»„æ•°: ${Object.keys(groups).length}`, 'info');
                
                // æ˜¾ç¤ºå®é™…å°ç»„å’Œæˆå‘˜
                log('å®é™…å°ç»„å’Œæˆå‘˜æ•°æ®:', 'info');
                Object.keys(groups).forEach(group => {
                    const groupMembers = groups[group];
                    log(`${group} (${groupMembers.length}äºº):`, 'info');
                    groupMembers.slice(0, 3).forEach(member => {
                        const nickname = member.nickname || member.Nickname || member.èŠ±å || member.alias || '';
                        log(`  - ${member.name} ${nickname ? `(${nickname})` : ''} [UUID: ${member.uuid ? member.uuid.substring(0, 8) + '...' : 'æ— '}]`, 'info');
                    });
                    if (groupMembers.length > 3) {
                        log(`  ... è¿˜æœ‰ ${groupMembers.length - 3} äºº`, 'info');
                    }
                });
                
                // æ£€æŸ¥ç»„åˆ«åç§°æ˜ å°„
                log('æ£€æŸ¥ç»„åˆ«åç§°æ˜ å°„:', 'info');
                const groupNames = window.groupNames || {};
                Object.keys(groupNames).forEach(groupId => {
                    const groupName = groupNames[groupId];
                    log(`  ${groupId} â†’ ${groupName}`, 'info');
                });
                
                // åˆ†æå‰10ä¸ªæ’é™¤äººå‘˜
                log('æ’é™¤äººå‘˜è¯¦ç»†åˆ†æ:', 'info');
                excludedMembers.slice(0, 10).forEach((excluded, index) => {
                    log(`${index + 1}. æ’é™¤äººå‘˜: "${excluded.name}" (${excluded.group}) [UUID: ${excluded.uuid ? excluded.uuid.substring(0, 8) + '...' : 'æ— '}]`, 'info');
                    
                    // é€šè¿‡ç»„åˆ«åç§°æ‰¾åˆ°å¯¹åº”çš„ç»„åˆ«IDï¼ˆæ”¯æŒåŒå‘åŒ¹é…ï¼‰
                    let targetGroupId = null;
                    let matchType = '';
                    
                    // 1. ç›´æ¥ç»„åˆ«IDåŒ¹é…
                    if (groups[excluded.group]) {
                        targetGroupId = excluded.group;
                        matchType = 'ç›´æ¥IDåŒ¹é…';
                    } else {
                        // 2. é€šè¿‡ç»„åˆ«åç§°æ˜ å°„åŒ¹é…
                        Object.keys(groupNames).forEach(groupId => {
                            if (groupNames[groupId] === excluded.group) {
                                targetGroupId = groupId;
                                matchType = 'åç§°æ˜ å°„åŒ¹é…';
                            }
                        });
                    }
                    
                    if (!targetGroupId) {
                        log(`   âŒ ç»„åˆ«åç§°ä¸å­˜åœ¨: ${excluded.group}`, 'warning');
                        
                        // å°è¯•åœ¨æ‰€æœ‰ç»„ä¸­æœç´¢è¯¥æˆå‘˜
                        log(`   ğŸ” åœ¨æ‰€æœ‰ç»„ä¸­æœç´¢æˆå‘˜ "${excluded.name}":`, 'info');
                        let foundInGroups = [];
                        
                        Object.keys(groups).forEach(groupId => {
                            const groupMembers = groups[groupId];
                            const groupName = groupNames[groupId] || groupId;
                            
                            groupMembers.forEach(member => {
                                if (member.name === excluded.name) {
                                    foundInGroups.push(`${groupName} (${groupId})`);
                                } else {
                                    const memberNickname = member.nickname || member.Nickname || member.èŠ±å || member.alias || '';
                                    if (memberNickname && memberNickname === excluded.name) {
                                        foundInGroups.push(`${groupName} (${groupId}) - èŠ±ååŒ¹é…`);
                                    }
                                }
                            });
                        });
                        
                        if (foundInGroups.length > 0) {
                            log(`   ğŸ¯ æ‰¾åˆ°æˆå‘˜åœ¨ä»¥ä¸‹ç»„ä¸­:`, 'success');
                            foundInGroups.forEach(group => {
                                log(`      - ${group}`, 'success');
                            });
                        } else {
                            log(`   âŒ åœ¨æ‰€æœ‰ç»„ä¸­éƒ½æœªæ‰¾åˆ°è¯¥æˆå‘˜`, 'error');
                        }
                    } else {
                        log(`   âœ… æ‰¾åˆ°ç»„åˆ«ID: ${targetGroupId} (${matchType})`, 'success');
                        
                        // åœ¨è¯¥ç»„ä¸­æŸ¥æ‰¾ç›¸ä¼¼æˆå‘˜
                        const groupMembers = groups[targetGroupId];
                        let foundSimilar = [];
                        
                        groupMembers.forEach(member => {
                            if (member.name === excluded.name) {
                                foundSimilar.push(`å®Œå…¨åŒ¹é…: ${member.name}`);
                            } else if (member.name.includes(excluded.name) || excluded.name.includes(member.name)) {
                                foundSimilar.push(`éƒ¨åˆ†åŒ¹é…: ${member.name}`);
                            }
                            
                            const memberNickname = member.nickname || member.Nickname || member.èŠ±å || member.alias || '';
                            if (memberNickname && memberNickname === excluded.name) {
                                foundSimilar.push(`èŠ±ååŒ¹é…: ${memberNickname} â†’ ${member.name}`);
                            } else if (memberNickname && (memberNickname.includes(excluded.name) || excluded.name.includes(memberNickname))) {
                                foundSimilar.push(`èŠ±åéƒ¨åˆ†åŒ¹é…: ${memberNickname} â†’ ${member.name}`);
                            }
                        });
                        
                        if (foundSimilar.length > 0) {
                            log(`   ğŸ¯ æ‰¾åˆ°ç›¸ä¼¼æˆå‘˜:`, 'success');
                            foundSimilar.forEach(similar => {
                                log(`      - ${similar}`, 'success');
                            });
                        } else {
                            log(`   âŒ åœ¨è¯¥ç»„ä¸­æœªæ‰¾åˆ°ç›¸ä¼¼æˆå‘˜`, 'error');
                        }
                    }
                });
                
                log('æ’é™¤äººå‘˜åŒ¹é…è°ƒè¯•å®Œæˆ', 'success');
                
            } catch (error) {
                log(`è°ƒè¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å‡çº§æ’é™¤äººå‘˜UUID
        async function upgradeExcludedMembersUUID() {
            log('å¼€å§‹å‡çº§æ’é™¤äººå‘˜UUIDæ”¯æŒï¼ˆæ”¯æŒå§“åå’ŒèŠ±ååŒ¹é…ï¼‰...', 'info');
            
            try {
                const excludedMembersData = window.utils.loadExcludedMembers();
                const excludedMembers = Array.isArray(excludedMembersData) ? excludedMembersData : Object.values(excludedMembersData || {});
                const groups = window.groups || {};
                const groupNames = window.groupNames || {};
                
                // å‡çº§æ’é™¤äººå‘˜UUID
                const upgradedMembers = excludedMembers.map(excluded => {
                    // å¦‚æœå·²ç»æœ‰UUIDï¼Œç›´æ¥è¿”å›
                    if (excluded.uuid) {
                        return excluded;
                    }
                    
                    // æŸ¥æ‰¾åŒ¹é…çš„æˆå‘˜ï¼ˆæ”¯æŒå§“åå’ŒèŠ±ååŒ¹é…ï¼‰
                    let foundMember = null;
                    let actualGroupId = null;
                    let actualGroupName = null;
                    let matchType = '';
                    
                    // 1. é€šè¿‡ç»„åˆ«åç§°æ‰¾åˆ°ç»„åˆ«ID
                    let targetGroupId = null;
                    Object.keys(groupNames).forEach(groupId => {
                        if (groupNames[groupId] === excluded.group) {
                            targetGroupId = groupId;
                        }
                    });
                    
                    if (targetGroupId && groups[targetGroupId]) {
                        // åœ¨è¯¥ç»„ä¸­æŸ¥æ‰¾åŒ¹é…æˆå‘˜
                        const groupMembers = groups[targetGroupId];
                        groupMembers.forEach(member => {
                            if (foundMember) return;
                            
                            // ç›´æ¥å§“ååŒ¹é…
                            if (member.name === excluded.name) {
                                foundMember = member;
                                actualGroupId = targetGroupId;
                                actualGroupName = excluded.group;
                                matchType = 'ç›´æ¥å§“ååŒ¹é…';
                            }
                            // èŠ±ååŒ¹é…
                            else {
                                const memberNickname = member.nickname || member.Nickname || member.èŠ±å || member.alias || '';
                                if (memberNickname && memberNickname === excluded.name) {
                                    foundMember = member;
                                    actualGroupId = targetGroupId;
                                    actualGroupName = excluded.group;
                                    matchType = 'èŠ±ååŒ¹é…';
                                }
                            }
                        });
                    }
                    
                    // 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåœ¨æ‰€æœ‰ç»„ä¸­æœç´¢
                    if (!foundMember) {
                        Object.keys(groups).forEach(groupId => {
                            if (foundMember) return;
                            
                            const groupMembers = groups[groupId];
                            const groupName = groupNames[groupId] || groupId;
                            
                            groupMembers.forEach(member => {
                                if (foundMember) return;
                                
                                // ç›´æ¥å§“ååŒ¹é…
                                if (member.name === excluded.name) {
                                    foundMember = member;
                                    actualGroupId = groupId;
                                    actualGroupName = groupName;
                                    matchType = 'è·¨ç»„å§“ååŒ¹é…';
                                }
                                // èŠ±ååŒ¹é…
                                else {
                                    const memberNickname = member.nickname || member.Nickname || member.èŠ±å || member.alias || '';
                                    if (memberNickname && memberNickname === excluded.name) {
                                        foundMember = member;
                                        actualGroupId = groupId;
                                        actualGroupName = groupName;
                                        matchType = 'è·¨ç»„èŠ±ååŒ¹é…';
                                    }
                                }
                            });
                        });
                    }
                    
                    // å¦‚æœæ‰¾åˆ°åŒ¹é…çš„æˆå‘˜ï¼Œå¤åˆ¶UUID
                    if (foundMember && foundMember.uuid) {
                        log(`å‡çº§: ${excluded.name} (${excluded.group} â†’ ${actualGroupName}) [${matchType}] UUID: ${foundMember.uuid.substring(0, 8)}...`, 'success');
                        return {
                            ...excluded,
                            uuid: foundMember.uuid,
                            group: actualGroupName  // æ›´æ–°ä¸ºå®é™…ç»„åˆ«åç§°
                        };
                    } else {
                        log(`è­¦å‘Š: æœªæ‰¾åˆ° ${excluded.name} (${excluded.group}) çš„åŒ¹é…æˆå‘˜`, 'warning');
                        return excluded;
                    }
                });
                
                const upgradedCount = upgradedMembers.filter(member => member.uuid).length;
                log(`å‡çº§å®Œæˆï¼Œå…± ${upgradedCount} ä¸ªæ’é™¤äººå‘˜æœ‰UUID`, 'success');
                
                // ä¿å­˜å‡çº§åçš„æ•°æ®
                localStorage.setItem('msh_excludedMembers', JSON.stringify(upgradedMembers));
                log('å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨', 'success');
                
                // åŒæ­¥åˆ°Firebase
                try {
                    if (window.db) {
                        await window.db.ref('excludedMembers').set(upgradedMembers);
                        log('å·²åŒæ­¥åˆ°Firebase', 'success');
                    } else {
                        log('Firebaseä¸å¯ç”¨ï¼Œæ— æ³•åŒæ­¥', 'warning');
                    }
                } catch (error) {
                    log(`åŒæ­¥åˆ°Firebaseå¤±è´¥: ${error.message}`, 'error');
                }
                
                // æ›´æ–°å…¨å±€å˜é‡
                if (window.excludedMembers !== undefined) {
                    // è½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼
                    const excludedMembersObj = {};
                    upgradedMembers.forEach((member, index) => {
                        excludedMembersObj[member.uuid || `member_${index}`] = member;
                    });
                    window.excludedMembers = excludedMembersObj;
                    log('å·²æ›´æ–°å…¨å±€å˜é‡', 'success');
                }
                
                // æç¤ºç”¨æˆ·åˆ·æ–°æ—¥æŠ¥è¡¨é¡µé¢
                log('è¯·åˆ·æ–°æ—¥æŠ¥è¡¨é¡µé¢æŸ¥çœ‹æ•ˆæœ', 'info');
                
            } catch (error) {
                log(`å‡çº§å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢å¸è½½å‰æé†’ä¿å­˜
        window.addEventListener('beforeunload', (e) => {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
            }
        });
    </script>
</body>
</html>
