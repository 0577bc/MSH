<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>未签到不统计人员管理</title>
  <link rel="stylesheet" href="../../src/style.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
    }

    .header h1 {
      margin: 0 0 10px 0;
      font-size: 28px;
      font-weight: 600;
    }

    .header p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }

    .content {
      padding: 30px;
    }

    .toolbar {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      align-items: center;
    }

    .toolbar select, .toolbar button {
      padding: 10px 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .toolbar select {
      min-width: 200px;
      background: white;
    }

    .toolbar button {
      background: #667eea;
      color: white;
      border: none;
      font-weight: 500;
    }

    .toolbar button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .stat-card.green {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .stat-card.orange {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.blue {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .stat-number {
      font-size: 36px;
      font-weight: bold;
      margin: 0;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #2c3e50;
      margin: 30px 0 20px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .members-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }

    .member-list-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #e9ecef;
    }

    .member-list-card h3 {
      margin: 0 0 15px 0;
      font-size: 18px;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      background: #667eea;
      color: white;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge.success {
      background: #28a745;
    }

    .badge.warning {
      background: #ffc107;
      color: #333;
    }

    .member-item {
      background: white;
      padding: 12px 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }

    .member-item:hover {
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .member-item.excluded {
      border-left-color: #f5576c;
      opacity: 0.7;
    }

    .member-name {
      font-weight: 500;
      color: #2c3e50;
    }

    .member-info {
      font-size: 12px;
      color: #6c757d;
      margin-top: 3px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .group-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .group-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .group-table th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .group-table td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    .group-table tbody tr:hover {
      background: #f8f9fa;
    }

    .group-name {
      font-weight: 600;
      color: #2c3e50;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 4px;
      transition: width 0.3s;
    }

    .back-button {
      display: inline-block;
      padding: 10px 20px;
      background: #6c757d;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .back-button:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      .members-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <!-- 引入配置文件 -->
  <script src="../../src/smart-config-loader.js"></script>
  <!-- 引入 Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- 引入工具函数模块 -->
  <script src="../../src/core/firebase-utils.js"></script>
  <script src="../../src/core/time-utils.js"></script>
  <script src="../../src/core/security-utils.js"></script>
  <script src="../../src/data/uuid-manager.js"></script>
  <script src="../../src/features/sunday-tracking-utils.js"></script>
  <script src="../../src/data/sync-managers.js"></script>
  <script src="../../src/utils.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📊 未签到不统计人员管理</h1>
      <p>查看和统计各小组的排除人员信息</p>
    </div>

    <div class="content">
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <a href="../../admin.html" class="back-button">← 返回管理页面</a>
        <a href="index.html" class="back-button">← 返回工具列表</a>
      </div>

      <!-- 筛选工具栏 -->
      <div class="toolbar">
        <select id="groupFilter" title="选择要查看的小组" aria-label="选择小组筛选器">
          <option value="all">所有小组</option>
        </select>
        <button id="editButton" type="button" style="background: #28a745; color: white;">✏️ 编辑排除人员</button>
        <button id="refreshButton" type="button">🔄 刷新数据</button>
        <button id="exportButton" type="button">📥 导出报表</button>
      </div>

      <!-- 统计卡片 -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">总人数</div>
          <div class="stat-number" id="totalMembers">0</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-label">已排除人数</div>
          <div class="stat-number" id="excludedMembers">0</div>
        </div>
        <div class="stat-card green">
          <div class="stat-label">参与统计人数</div>
          <div class="stat-number" id="activeMembers">0</div>
        </div>
        <div class="stat-card blue">
          <div class="stat-label">排除率</div>
          <div class="stat-number" id="excludedRate">0%</div>
        </div>
      </div>

      <!-- 各组统计表格 -->
      <div class="section-title">📈 各小组统计概览</div>
      <table class="group-table" id="groupStatsTable">
        <thead>
          <tr>
            <th>小组名称</th>
            <th>总人数</th>
            <th>已排除</th>
            <th>参与统计</th>
            <th>排除率</th>
            <th>排除率可视化</th>
          </tr>
        </thead>
        <tbody id="groupStatsBody">
          <!-- 动态生成 -->
        </tbody>
      </table>

      <!-- 详细人员列表 -->
      <div id="detailSection" style="display: none;">
        <div class="section-title" id="detailSectionTitle">📋 人员详细列表</div>
        <div class="members-grid" id="membersGrid">
          <!-- 动态生成 -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== 全局变量 ====================
    let groups = {};
    let groupNames = {};
    let currentFilter = 'all';

    // ==================== 初始化 ====================
    document.addEventListener('DOMContentLoaded', async () => {
      await initializeData();
      setupEventListeners();
      renderAll();
    });

    // ==================== Firebase初始化和数据加载 ====================
    async function initializeData() {
      try {
        // 初始化Firebase
        if (!firebase.apps.length && window.firebaseConfig) {
          firebase.initializeApp(window.firebaseConfig);
        }

        const db = firebase.database();

        // 加载数据（只需要groups和groupNames，排除信息在成员对象中）
        const [groupsSnap, groupNamesSnap] = await Promise.all([
          db.ref('groups').once('value'),
          db.ref('groupNames').once('value')
        ]);

        groups = groupsSnap.val() || {};
        groupNames = groupNamesSnap.val() || {};

        // 统计排除人员数量（从groups中的excluded标记）
        let excludedCount = 0;
        Object.keys(groups).forEach(groupId => {
          const members = groups[groupId] || [];
          excludedCount += members.filter(m => m.excluded === true || m.excluded === 'true').length;
        });

        const groupsCount = Object.keys(groups).length;
        const groupNamesCount = Object.keys(groupNames).length;
        
        console.log('✅ 数据加载成功:');
        console.log('  - 小组数量:', groupsCount);
        console.log('  - 组名数量:', groupNamesCount);
        console.log('  - 排除人数:', excludedCount, '（从成员标记统计）');
      } catch (error) {
        console.error('❌ 数据加载失败:', error);
        alert('数据加载失败，请刷新页面重试');
      }
    }

    // ==================== 事件监听 ====================
    function setupEventListeners() {
      const groupFilter = document.getElementById('groupFilter');
      const editButton = document.getElementById('editButton');
      const refreshButton = document.getElementById('refreshButton');
      const exportButton = document.getElementById('exportButton');

      groupFilter.addEventListener('change', (e) => {
        currentFilter = e.target.value;
        
        // 控制详细列表显示
        const detailSection = document.getElementById('detailSection');
        if (currentFilter === 'all') {
          detailSection.style.display = 'none';
        } else {
          detailSection.style.display = 'block';
        }
        
        renderAll();
      });

      editButton.addEventListener('click', () => {
        window.location.href = 'excluded-members-editor.html';
      });

      refreshButton.addEventListener('click', async () => {
        refreshButton.textContent = '🔄 加载中...';
        refreshButton.disabled = true;
        await initializeData();
        renderAll();
        refreshButton.textContent = '🔄 刷新数据';
        refreshButton.disabled = false;
      });

      exportButton.addEventListener('click', exportReport);
    }

    // ==================== 辅助函数 ====================
    /**
     * 检查成员是否被排除（简化版 - 使用成员标记）
     * @param {Object} member - 成员对象
     * @param {string} groupId - 组ID（保留参数用于兼容）
     * @returns {boolean} 是否被排除
     */
    function isMemberExcluded(member, groupId) {
      if (!member) return false;
      
      // 新逻辑：直接检查成员的 excluded 属性
      return member.excluded === true || member.excluded === 'true';
    }

    // ==================== 渲染函数 ====================
    function renderAll() {
      populateGroupFilter();
      renderStats();
      renderGroupStatsTable();
      renderMembersGrid();
    }

    // 填充小组筛选器
    function populateGroupFilter() {
      const groupFilter = document.getElementById('groupFilter');
      const currentValue = groupFilter.value;
      
      groupFilter.innerHTML = '<option value="all">所有小组</option>';
      
      const sortedGroups = window.utils.sortGroups(groups, groupNames);
      sortedGroups.forEach(groupId => {
        const option = document.createElement('option');
        option.value = groupId;
        option.textContent = groupNames[groupId] || groupId;
        groupFilter.appendChild(option);
      });
      
      // 恢复之前的选择
      groupFilter.value = currentValue;
    }

    // 渲染统计卡片
    function renderStats() {
      let totalCount = 0;
      let excludedCount = 0;

      const groupsToCount = currentFilter === 'all' 
        ? Object.keys(groups) 
        : [currentFilter];

      groupsToCount.forEach(groupId => {
        const members = groups[groupId] || [];
        members.forEach(member => {
          totalCount++;
          if (isMemberExcluded(member, groupId)) {
            excludedCount++;
          }
        });
      });

      const activeCount = totalCount - excludedCount;
      const excludedRate = totalCount > 0 
        ? Math.round((excludedCount / totalCount) * 100) 
        : 0;

      document.getElementById('totalMembers').textContent = totalCount;
      document.getElementById('excludedMembers').textContent = excludedCount;
      document.getElementById('activeMembers').textContent = activeCount;
      document.getElementById('excludedRate').textContent = excludedRate + '%';
    }

    // 渲染各组统计表格
    function renderGroupStatsTable() {
      const tbody = document.getElementById('groupStatsBody');
      tbody.innerHTML = '';

      const groupsToShow = currentFilter === 'all' 
        ? window.utils.sortGroups(groups, groupNames)
        : [currentFilter];

      groupsToShow.forEach(groupId => {
        const members = groups[groupId] || [];
        const totalCount = members.length;
        const excludedCount = members.filter(m => 
          isMemberExcluded(m, groupId)
        ).length;
        const activeCount = totalCount - excludedCount;
        const excludedRate = totalCount > 0 
          ? Math.round((excludedCount / totalCount) * 100) 
          : 0;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="group-name">${groupNames[groupId] || groupId}</td>
          <td>${totalCount}</td>
          <td><span class="badge warning">${excludedCount}</span></td>
          <td><span class="badge success">${activeCount}</span></td>
          <td>${excludedRate}%</td>
          <td>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${excludedRate}%"></div>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // 渲染人员列表
    function renderMembersGrid() {
      const grid = document.getElementById('membersGrid');
      const detailTitle = document.getElementById('detailSectionTitle');
      grid.innerHTML = '';

      const groupsToShow = currentFilter === 'all' 
        ? window.utils.sortGroups(groups, groupNames)
        : [currentFilter];

      if (currentFilter === 'all') {
        detailTitle.textContent = '📋 各小组人员详细列表';
      } else {
        detailTitle.textContent = `📋 ${groupNames[currentFilter] || currentFilter} - 人员详细列表`;
      }

      groupsToShow.forEach(groupId => {
        const members = groups[groupId] || [];
        const groupName = groupNames[groupId] || groupId;

        // 分类人员
        const excludedMembersList = members.filter(m => 
          isMemberExcluded(m, groupId)
        );
        const activeMembers = members.filter(m => 
          !isMemberExcluded(m, groupId)
        );

        // 参与统计人员
        if (activeMembers.length > 0) {
          const activeCard = createMemberListCard(
            groupName,
            '参与统计',
            activeMembers,
            false
          );
          grid.appendChild(activeCard);
        }

        // 已排除人员
        if (excludedMembersList.length > 0) {
          const excludedCard = createMemberListCard(
            groupName,
            '已排除',
            excludedMembersList,
            true
          );
          grid.appendChild(excludedCard);
        }
      });

      if (grid.children.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📭</div>
            <p>该小组暂无人员数据</p>
          </div>
        `;
      }
    }

    // 创建人员列表卡片
    function createMemberListCard(groupName, type, members, isExcluded) {
      const card = document.createElement('div');
      card.className = 'member-list-card';

      const badgeClass = isExcluded ? 'warning' : 'success';
      const title = currentFilter === 'all' 
        ? `${groupName} - ${type}` 
        : type;

      card.innerHTML = `
        <h3>
          ${title}
          <span class="badge ${badgeClass}">${members.length}人</span>
        </h3>
        <div class="member-list"></div>
      `;

      const memberList = card.querySelector('.member-list');
      members.forEach(member => {
        const item = document.createElement('div');
        item.className = `member-item ${isExcluded ? 'excluded' : ''}`;
        
        const displayName = window.utils.getDisplayName(member);
        const realName = member.name || '';
        const nickname = member.nickname || member.Nickname || '';
        
        // 显示格式：姓名(花名) 或 只显示姓名
        let nameDisplay = realName;
        if (nickname && nickname !== realName) {
          nameDisplay = `${realName}(${nickname})`;
        }

        item.innerHTML = `
          <div>
            <div class="member-name">${nameDisplay}</div>
            <div class="member-info">
              UUID: ${member.uuid || '无'}
            </div>
          </div>
          ${isExcluded ? '<span class="badge warning">不统计</span>' : ''}
        `;
        memberList.appendChild(item);
      });

      return card;
    }

    // ==================== 导出功能 ====================
    function exportReport() {
      const timestamp = new Date().toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      }).replace(/\//g, '-');

      let report = `未签到不统计人员报表\n`;
      report += `生成时间：${timestamp}\n`;
      report += `筛选条件：${currentFilter === 'all' ? '所有小组' : groupNames[currentFilter] || currentFilter}\n`;
      report += `\n${'='.repeat(60)}\n\n`;

      // 统计概览
      const totalCount = parseInt(document.getElementById('totalMembers').textContent);
      const excludedCount = parseInt(document.getElementById('excludedMembers').textContent);
      const activeCount = parseInt(document.getElementById('activeMembers').textContent);
      const excludedRate = document.getElementById('excludedRate').textContent;

      report += `统计概览：\n`;
      report += `总人数：${totalCount}\n`;
      report += `已排除人数：${excludedCount}\n`;
      report += `参与统计人数：${activeCount}\n`;
      report += `排除率：${excludedRate}\n`;
      report += `\n${'='.repeat(60)}\n\n`;

      // 各组详细数据
      const groupsToShow = currentFilter === 'all' 
        ? window.utils.sortGroups(groups, groupNames)
        : [currentFilter];

      groupsToShow.forEach(groupId => {
        const members = groups[groupId] || [];
        const groupName = groupNames[groupId] || groupId;
        
        const excludedMembersList = members.filter(m => 
          m.excluded === true || m.excluded === 'true'
        );
        const activeMembers = members.filter(m => 
          !(m.excluded === true || m.excluded === 'true')
        );

        report += `【${groupName}】\n`;
        report += `总人数：${members.length}\n`;
        report += `已排除：${excludedMembersList.length}\n`;
        report += `参与统计：${activeMembers.length}\n\n`;

        if (excludedMembersList.length > 0) {
          report += `已排除人员：\n`;
          excludedMembersList.forEach(m => {
            const displayName = window.utils.getDisplayName(m);
            report += `  - ${displayName} (UUID: ${m.uuid || '无'})\n`;
          });
          report += `\n`;
        }

        if (activeMembers.length > 0) {
          report += `参与统计人员：\n`;
          activeMembers.forEach(m => {
            const displayName = window.utils.getDisplayName(m);
            report += `  - ${displayName} (UUID: ${m.uuid || '无'})\n`;
          });
          report += `\n`;
        }

        report += `${'-'.repeat(60)}\n\n`;
      });

      // 下载文件
      const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `未签到不统计人员报表_${timestamp.replace(/[:\s]/g, '')}.txt`;
      link.click();

      alert('报表已导出！');
    }
  </script>
</body>
</html>
