<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœªç­¾åˆ°ä¸ç»Ÿè®¡äººå‘˜ç®¡ç†</title>
  <link rel="stylesheet" href="../../src/style.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
    }

    .header h1 {
      margin: 0 0 10px 0;
      font-size: 28px;
      font-weight: 600;
    }

    .header p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }

    .content {
      padding: 30px;
    }

    .toolbar {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      align-items: center;
    }

    .toolbar select, .toolbar button {
      padding: 10px 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .toolbar select {
      min-width: 200px;
      background: white;
    }

    .toolbar button {
      background: #667eea;
      color: white;
      border: none;
      font-weight: 500;
    }

    .toolbar button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .stat-card.green {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .stat-card.orange {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.blue {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .stat-number {
      font-size: 36px;
      font-weight: bold;
      margin: 0;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #2c3e50;
      margin: 30px 0 20px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .members-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }

    .member-list-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #e9ecef;
    }

    .member-list-card h3 {
      margin: 0 0 15px 0;
      font-size: 18px;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      background: #667eea;
      color: white;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge.success {
      background: #28a745;
    }

    .badge.warning {
      background: #ffc107;
      color: #333;
    }

    .member-item {
      background: white;
      padding: 12px 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }

    .member-item:hover {
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .member-item.excluded {
      border-left-color: #f5576c;
      opacity: 0.7;
    }

    .member-name {
      font-weight: 500;
      color: #2c3e50;
    }

    .member-info {
      font-size: 12px;
      color: #6c757d;
      margin-top: 3px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .group-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .group-table thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .group-table th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .group-table td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    .group-table tbody tr:hover {
      background: #f8f9fa;
    }

    .group-name {
      font-weight: 600;
      color: #2c3e50;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 4px;
      transition: width 0.3s;
    }

    .back-button {
      display: inline-block;
      padding: 10px 20px;
      background: #6c757d;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .back-button:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      .members-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <!-- å¼•å…¥é…ç½®æ–‡ä»¶ -->
  <script src="../../src/smart-config-loader.js"></script>
  <!-- å¼•å…¥ Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- å¼•å…¥å·¥å…·å‡½æ•°æ¨¡å— -->
  <script src="../../src/core/firebase-utils.js"></script>
  <script src="../../src/core/time-utils.js"></script>
  <script src="../../src/core/security-utils.js"></script>
  <script src="../../src/data/uuid-manager.js"></script>
  <script src="../../src/features/sunday-tracking-utils.js"></script>
  <script src="../../src/data/sync-managers.js"></script>
  <script src="../../src/utils.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š æœªç­¾åˆ°ä¸ç»Ÿè®¡äººå‘˜ç®¡ç†</h1>
      <p>æŸ¥çœ‹å’Œç»Ÿè®¡å„å°ç»„çš„æ’é™¤äººå‘˜ä¿¡æ¯</p>
    </div>

    <div class="content">
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <a href="../../admin.html" class="back-button">â† è¿”å›ç®¡ç†é¡µé¢</a>
        <a href="index.html" class="back-button">â† è¿”å›å·¥å…·åˆ—è¡¨</a>
      </div>

      <!-- ç­›é€‰å·¥å…·æ  -->
      <div class="toolbar">
        <select id="groupFilter" title="é€‰æ‹©è¦æŸ¥çœ‹çš„å°ç»„" aria-label="é€‰æ‹©å°ç»„ç­›é€‰å™¨">
          <option value="all">æ‰€æœ‰å°ç»„</option>
        </select>
        <button id="editButton" type="button" style="background: #28a745; color: white;">âœï¸ ç¼–è¾‘æ’é™¤äººå‘˜</button>
        <button id="refreshButton" type="button">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        <button id="exportButton" type="button">ğŸ“¥ å¯¼å‡ºæŠ¥è¡¨</button>
      </div>

      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">æ€»äººæ•°</div>
          <div class="stat-number" id="totalMembers">0</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-label">å·²æ’é™¤äººæ•°</div>
          <div class="stat-number" id="excludedMembers">0</div>
        </div>
        <div class="stat-card green">
          <div class="stat-label">å‚ä¸ç»Ÿè®¡äººæ•°</div>
          <div class="stat-number" id="activeMembers">0</div>
        </div>
        <div class="stat-card blue">
          <div class="stat-label">æ’é™¤ç‡</div>
          <div class="stat-number" id="excludedRate">0%</div>
        </div>
      </div>

      <!-- å„ç»„ç»Ÿè®¡è¡¨æ ¼ -->
      <div class="section-title">ğŸ“ˆ å„å°ç»„ç»Ÿè®¡æ¦‚è§ˆ</div>
      <table class="group-table" id="groupStatsTable">
        <thead>
          <tr>
            <th>å°ç»„åç§°</th>
            <th>æ€»äººæ•°</th>
            <th>å·²æ’é™¤</th>
            <th>å‚ä¸ç»Ÿè®¡</th>
            <th>æ’é™¤ç‡</th>
            <th>æ’é™¤ç‡å¯è§†åŒ–</th>
          </tr>
        </thead>
        <tbody id="groupStatsBody">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </tbody>
      </table>

      <!-- è¯¦ç»†äººå‘˜åˆ—è¡¨ -->
      <div id="detailSection" style="display: none;">
        <div class="section-title" id="detailSectionTitle">ğŸ“‹ äººå‘˜è¯¦ç»†åˆ—è¡¨</div>
        <div class="members-grid" id="membersGrid">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== å…¨å±€å˜é‡ ====================
    let groups = {};
    let groupNames = {};
    let currentFilter = 'all';

    // ==================== åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', async () => {
      await initializeData();
      setupEventListeners();
      renderAll();
    });

    // ==================== Firebaseåˆå§‹åŒ–å’Œæ•°æ®åŠ è½½ ====================
    async function initializeData() {
      try {
        // åˆå§‹åŒ–Firebase
        if (!firebase.apps.length && window.firebaseConfig) {
          firebase.initializeApp(window.firebaseConfig);
        }

        const db = firebase.database();

        // åŠ è½½æ•°æ®ï¼ˆåªéœ€è¦groupså’ŒgroupNamesï¼Œæ’é™¤ä¿¡æ¯åœ¨æˆå‘˜å¯¹è±¡ä¸­ï¼‰
        const [groupsSnap, groupNamesSnap] = await Promise.all([
          db.ref('groups').once('value'),
          db.ref('groupNames').once('value')
        ]);

        groups = groupsSnap.val() || {};
        groupNames = groupNamesSnap.val() || {};

        // ç»Ÿè®¡æ’é™¤äººå‘˜æ•°é‡ï¼ˆä»groupsä¸­çš„excludedæ ‡è®°ï¼‰
        let excludedCount = 0;
        Object.keys(groups).forEach(groupId => {
          const members = groups[groupId] || [];
          excludedCount += members.filter(m => m.excluded === true || m.excluded === 'true').length;
        });

        const groupsCount = Object.keys(groups).length;
        const groupNamesCount = Object.keys(groupNames).length;
        
        console.log('âœ… æ•°æ®åŠ è½½æˆåŠŸ:');
        console.log('  - å°ç»„æ•°é‡:', groupsCount);
        console.log('  - ç»„åæ•°é‡:', groupNamesCount);
        console.log('  - æ’é™¤äººæ•°:', excludedCount, 'ï¼ˆä»æˆå‘˜æ ‡è®°ç»Ÿè®¡ï¼‰');
      } catch (error) {
        console.error('âŒ æ•°æ®åŠ è½½å¤±è´¥:', error);
        alert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    }

    // ==================== äº‹ä»¶ç›‘å¬ ====================
    function setupEventListeners() {
      const groupFilter = document.getElementById('groupFilter');
      const editButton = document.getElementById('editButton');
      const refreshButton = document.getElementById('refreshButton');
      const exportButton = document.getElementById('exportButton');

      groupFilter.addEventListener('change', (e) => {
        currentFilter = e.target.value;
        
        // æ§åˆ¶è¯¦ç»†åˆ—è¡¨æ˜¾ç¤º
        const detailSection = document.getElementById('detailSection');
        if (currentFilter === 'all') {
          detailSection.style.display = 'none';
        } else {
          detailSection.style.display = 'block';
        }
        
        renderAll();
      });

      editButton.addEventListener('click', () => {
        window.location.href = 'excluded-members-editor.html';
      });

      refreshButton.addEventListener('click', async () => {
        refreshButton.textContent = 'ğŸ”„ åŠ è½½ä¸­...';
        refreshButton.disabled = true;
        await initializeData();
        renderAll();
        refreshButton.textContent = 'ğŸ”„ åˆ·æ–°æ•°æ®';
        refreshButton.disabled = false;
      });

      exportButton.addEventListener('click', exportReport);
    }

    // ==================== è¾…åŠ©å‡½æ•° ====================
    /**
     * æ£€æŸ¥æˆå‘˜æ˜¯å¦è¢«æ’é™¤ï¼ˆç®€åŒ–ç‰ˆ - ä½¿ç”¨æˆå‘˜æ ‡è®°ï¼‰
     * @param {Object} member - æˆå‘˜å¯¹è±¡
     * @param {string} groupId - ç»„IDï¼ˆä¿ç•™å‚æ•°ç”¨äºå…¼å®¹ï¼‰
     * @returns {boolean} æ˜¯å¦è¢«æ’é™¤
     */
    function isMemberExcluded(member, groupId) {
      if (!member) return false;
      
      // æ–°é€»è¾‘ï¼šç›´æ¥æ£€æŸ¥æˆå‘˜çš„ excluded å±æ€§
      return member.excluded === true || member.excluded === 'true';
    }

    // ==================== æ¸²æŸ“å‡½æ•° ====================
    function renderAll() {
      populateGroupFilter();
      renderStats();
      renderGroupStatsTable();
      renderMembersGrid();
    }

    // å¡«å……å°ç»„ç­›é€‰å™¨
    function populateGroupFilter() {
      const groupFilter = document.getElementById('groupFilter');
      const currentValue = groupFilter.value;
      
      groupFilter.innerHTML = '<option value="all">æ‰€æœ‰å°ç»„</option>';
      
      const sortedGroups = window.utils.sortGroups(groups, groupNames);
      sortedGroups.forEach(groupId => {
        const option = document.createElement('option');
        option.value = groupId;
        option.textContent = groupNames[groupId] || groupId;
        groupFilter.appendChild(option);
      });
      
      // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
      groupFilter.value = currentValue;
    }

    // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
    function renderStats() {
      let totalCount = 0;
      let excludedCount = 0;

      const groupsToCount = currentFilter === 'all' 
        ? Object.keys(groups) 
        : [currentFilter];

      groupsToCount.forEach(groupId => {
        const members = groups[groupId] || [];
        members.forEach(member => {
          totalCount++;
          if (isMemberExcluded(member, groupId)) {
            excludedCount++;
          }
        });
      });

      const activeCount = totalCount - excludedCount;
      const excludedRate = totalCount > 0 
        ? Math.round((excludedCount / totalCount) * 100) 
        : 0;

      document.getElementById('totalMembers').textContent = totalCount;
      document.getElementById('excludedMembers').textContent = excludedCount;
      document.getElementById('activeMembers').textContent = activeCount;
      document.getElementById('excludedRate').textContent = excludedRate + '%';
    }

    // æ¸²æŸ“å„ç»„ç»Ÿè®¡è¡¨æ ¼
    function renderGroupStatsTable() {
      const tbody = document.getElementById('groupStatsBody');
      tbody.innerHTML = '';

      const groupsToShow = currentFilter === 'all' 
        ? window.utils.sortGroups(groups, groupNames)
        : [currentFilter];

      groupsToShow.forEach(groupId => {
        const members = groups[groupId] || [];
        const totalCount = members.length;
        const excludedCount = members.filter(m => 
          isMemberExcluded(m, groupId)
        ).length;
        const activeCount = totalCount - excludedCount;
        const excludedRate = totalCount > 0 
          ? Math.round((excludedCount / totalCount) * 100) 
          : 0;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="group-name">${groupNames[groupId] || groupId}</td>
          <td>${totalCount}</td>
          <td><span class="badge warning">${excludedCount}</span></td>
          <td><span class="badge success">${activeCount}</span></td>
          <td>${excludedRate}%</td>
          <td>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${excludedRate}%"></div>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // æ¸²æŸ“äººå‘˜åˆ—è¡¨
    function renderMembersGrid() {
      const grid = document.getElementById('membersGrid');
      const detailTitle = document.getElementById('detailSectionTitle');
      grid.innerHTML = '';

      const groupsToShow = currentFilter === 'all' 
        ? window.utils.sortGroups(groups, groupNames)
        : [currentFilter];

      if (currentFilter === 'all') {
        detailTitle.textContent = 'ğŸ“‹ å„å°ç»„äººå‘˜è¯¦ç»†åˆ—è¡¨';
      } else {
        detailTitle.textContent = `ğŸ“‹ ${groupNames[currentFilter] || currentFilter} - äººå‘˜è¯¦ç»†åˆ—è¡¨`;
      }

      groupsToShow.forEach(groupId => {
        const members = groups[groupId] || [];
        const groupName = groupNames[groupId] || groupId;

        // åˆ†ç±»äººå‘˜
        const excludedMembersList = members.filter(m => 
          isMemberExcluded(m, groupId)
        );
        const activeMembers = members.filter(m => 
          !isMemberExcluded(m, groupId)
        );

        // å‚ä¸ç»Ÿè®¡äººå‘˜
        if (activeMembers.length > 0) {
          const activeCard = createMemberListCard(
            groupName,
            'å‚ä¸ç»Ÿè®¡',
            activeMembers,
            false
          );
          grid.appendChild(activeCard);
        }

        // å·²æ’é™¤äººå‘˜
        if (excludedMembersList.length > 0) {
          const excludedCard = createMemberListCard(
            groupName,
            'å·²æ’é™¤',
            excludedMembersList,
            true
          );
          grid.appendChild(excludedCard);
        }
      });

      if (grid.children.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“­</div>
            <p>è¯¥å°ç»„æš‚æ— äººå‘˜æ•°æ®</p>
          </div>
        `;
      }
    }

    // åˆ›å»ºäººå‘˜åˆ—è¡¨å¡ç‰‡
    function createMemberListCard(groupName, type, members, isExcluded) {
      const card = document.createElement('div');
      card.className = 'member-list-card';

      const badgeClass = isExcluded ? 'warning' : 'success';
      const title = currentFilter === 'all' 
        ? `${groupName} - ${type}` 
        : type;

      card.innerHTML = `
        <h3>
          ${title}
          <span class="badge ${badgeClass}">${members.length}äºº</span>
        </h3>
        <div class="member-list"></div>
      `;

      const memberList = card.querySelector('.member-list');
      members.forEach(member => {
        const item = document.createElement('div');
        item.className = `member-item ${isExcluded ? 'excluded' : ''}`;
        
        const displayName = window.utils.getDisplayName(member);
        const realName = member.name || '';
        const nickname = member.nickname || member.Nickname || '';
        
        // æ˜¾ç¤ºæ ¼å¼ï¼šå§“å(èŠ±å) æˆ– åªæ˜¾ç¤ºå§“å
        let nameDisplay = realName;
        if (nickname && nickname !== realName) {
          nameDisplay = `${realName}(${nickname})`;
        }

        item.innerHTML = `
          <div>
            <div class="member-name">${nameDisplay}</div>
            <div class="member-info">
              UUID: ${member.uuid || 'æ— '}
            </div>
          </div>
          ${isExcluded ? '<span class="badge warning">ä¸ç»Ÿè®¡</span>' : ''}
        `;
        memberList.appendChild(item);
      });

      return card;
    }

    // ==================== å¯¼å‡ºåŠŸèƒ½ ====================
    function exportReport() {
      const timestamp = new Date().toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      }).replace(/\//g, '-');

      let report = `æœªç­¾åˆ°ä¸ç»Ÿè®¡äººå‘˜æŠ¥è¡¨\n`;
      report += `ç”Ÿæˆæ—¶é—´ï¼š${timestamp}\n`;
      report += `ç­›é€‰æ¡ä»¶ï¼š${currentFilter === 'all' ? 'æ‰€æœ‰å°ç»„' : groupNames[currentFilter] || currentFilter}\n`;
      report += `\n${'='.repeat(60)}\n\n`;

      // ç»Ÿè®¡æ¦‚è§ˆ
      const totalCount = parseInt(document.getElementById('totalMembers').textContent);
      const excludedCount = parseInt(document.getElementById('excludedMembers').textContent);
      const activeCount = parseInt(document.getElementById('activeMembers').textContent);
      const excludedRate = document.getElementById('excludedRate').textContent;

      report += `ç»Ÿè®¡æ¦‚è§ˆï¼š\n`;
      report += `æ€»äººæ•°ï¼š${totalCount}\n`;
      report += `å·²æ’é™¤äººæ•°ï¼š${excludedCount}\n`;
      report += `å‚ä¸ç»Ÿè®¡äººæ•°ï¼š${activeCount}\n`;
      report += `æ’é™¤ç‡ï¼š${excludedRate}\n`;
      report += `\n${'='.repeat(60)}\n\n`;

      // å„ç»„è¯¦ç»†æ•°æ®
      const groupsToShow = currentFilter === 'all' 
        ? window.utils.sortGroups(groups, groupNames)
        : [currentFilter];

      groupsToShow.forEach(groupId => {
        const members = groups[groupId] || [];
        const groupName = groupNames[groupId] || groupId;
        
        const excludedMembersList = members.filter(m => 
          m.excluded === true || m.excluded === 'true'
        );
        const activeMembers = members.filter(m => 
          !(m.excluded === true || m.excluded === 'true')
        );

        report += `ã€${groupName}ã€‘\n`;
        report += `æ€»äººæ•°ï¼š${members.length}\n`;
        report += `å·²æ’é™¤ï¼š${excludedMembersList.length}\n`;
        report += `å‚ä¸ç»Ÿè®¡ï¼š${activeMembers.length}\n\n`;

        if (excludedMembersList.length > 0) {
          report += `å·²æ’é™¤äººå‘˜ï¼š\n`;
          excludedMembersList.forEach(m => {
            const displayName = window.utils.getDisplayName(m);
            report += `  - ${displayName} (UUID: ${m.uuid || 'æ— '})\n`;
          });
          report += `\n`;
        }

        if (activeMembers.length > 0) {
          report += `å‚ä¸ç»Ÿè®¡äººå‘˜ï¼š\n`;
          activeMembers.forEach(m => {
            const displayName = window.utils.getDisplayName(m);
            report += `  - ${displayName} (UUID: ${m.uuid || 'æ— '})\n`;
          });
          report += `\n`;
        }

        report += `${'-'.repeat(60)}\n\n`;
      });

      // ä¸‹è½½æ–‡ä»¶
      const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `æœªç­¾åˆ°ä¸ç»Ÿè®¡äººå‘˜æŠ¥è¡¨_${timestamp.replace(/[:\s]/g, '')}.txt`;
      link.click();

      alert('æŠ¥è¡¨å·²å¯¼å‡ºï¼');
    }
  </script>
</body>
</html>
