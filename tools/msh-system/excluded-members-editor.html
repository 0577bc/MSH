<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¼–è¾‘æ’é™¤äººå‘˜</title>
  <link rel="stylesheet" href="../../src/style.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      padding: 30px;
    }

    .header h1 {
      margin: 0 0 10px 0;
      font-size: 28px;
      font-weight: 600;
    }

    .header p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }

    .content {
      padding: 30px;
    }

    .back-button {
      display: inline-block;
      padding: 10px 20px;
      background: #6c757d;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .back-button:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .section h3 {
      margin: 0 0 15px 0;
      color: #2c3e50;
      font-size: 18px;
    }

    .search-box {
      position: relative;
      margin-bottom: 15px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .search-box input:focus {
      border-color: #28a745;
      outline: none;
    }

    .suggestions-box {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-top: 5px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 100;
    }

    .suggestions-box.hidden {
      display: none;
    }

    .suggestion-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .suggestion-item:hover {
      background: #f8f9fa;
    }

    .suggestion-item.selected {
      background: #e7f5ff;
    }

    .member-info-display {
      flex: 1;
    }

    .member-name {
      font-weight: 600;
      color: #2c3e50;
    }

    .member-group {
      font-size: 12px;
      color: #6c757d;
      margin-top: 2px;
    }

    .select-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .selected-members-box {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      min-height: 100px;
      max-height: 300px;
      overflow-y: auto;
    }

    .selected-member-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #e7f5ff;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .selected-member-item:last-child {
      margin-bottom: 0;
    }

    .remove-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }

    .remove-btn:hover {
      background: #c82333;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .primary-button, .secondary-button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .primary-button {
      background: #28a745;
      color: white;
    }

    .primary-button:hover {
      background: #218838;
      transform: translateY(-2px);
    }

    .secondary-button {
      background: #6c757d;
      color: white;
    }

    .secondary-button:hover {
      background: #5a6268;
    }

    .excluded-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .excluded-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: white;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 4px solid #dc3545;
    }

    .excluded-item:hover {
      background: #f8f9fa;
      transform: translateX(5px);
      transition: all 0.3s;
    }

    .no-data {
      text-align: center;
      color: #6c757d;
      padding: 20px;
    }

    .count-badge {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
    }
  </style>
  <!-- å¼•å…¥é…ç½®æ–‡ä»¶ -->
  <script src="../../src/smart-config-loader.js"></script>
  <!-- å¼•å…¥ Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- å¼•å…¥å·¥å…·å‡½æ•°æ¨¡å— -->
  <script src="../../src/core/firebase-utils.js"></script>
  <script src="../../src/core/time-utils.js"></script>
  <script src="../../src/core/security-utils.js"></script>
  <script src="../../src/data/uuid-manager.js"></script>
  <script src="../../src/features/sunday-tracking-utils.js"></script>
  <script src="../../src/data/sync-managers.js"></script>
  <script src="../../src/utils.js"></script>
  <!-- å¼•å…¥æ–°æ•°æ®ç®¡ç†å™¨ -->
  <script src="../../src/new-data-manager.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>âœï¸ ç¼–è¾‘æ’é™¤äººå‘˜</h1>
      <p>æ·»åŠ æˆ–ç§»é™¤æœªç­¾åˆ°ä¸ç»Ÿè®¡äººå‘˜ Â· ä½¿ç”¨å¢é‡åŒæ­¥ï¼Œå®‰å…¨å¯é </p>
    </div>

    <div class="content">
      <a href="excluded-members-viewer.html" class="back-button">â† è¿”å›æŸ¥çœ‹é¡µé¢</a>

      <!-- æœç´¢æ·»åŠ åŒºåŸŸ -->
      <div class="section">
        <h3>â• æ·»åŠ æ’é™¤äººå‘˜</h3>
        
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="æœç´¢äººå‘˜å§“åã€èŠ±åæˆ–å°ç»„åç§°..." aria-label="æœç´¢æˆå‘˜">
          <div id="suggestions" class="suggestions-box hidden"></div>
        </div>

        <div>
          <h4>å·²é€‰æ‹©çš„äººå‘˜ <span class="count-badge" id="selectedCount">0</span></h4>
          <div class="selected-members-box" id="selectedMembersList">
            <div class="no-data">è¯·æœç´¢å¹¶é€‰æ‹©è¦æ’é™¤çš„äººå‘˜</div>
          </div>
        </div>

        <div class="action-buttons">
          <button id="addButton" class="primary-button" type="button">âœ… æ·»åŠ åˆ°æ’é™¤åˆ—è¡¨</button>
          <button id="clearButton" class="secondary-button" type="button">ğŸ—‘ï¸ æ¸…ç©ºé€‰æ‹©</button>
        </div>
      </div>

      <!-- å·²æ’é™¤äººå‘˜åˆ—è¡¨ -->
      <div class="section">
        <h3>ğŸ“‹ å·²æ’é™¤äººå‘˜åˆ—è¡¨ <span class="count-badge" id="excludedCount">0</span></h3>
        <div class="excluded-list" id="excludedList">
          <div class="no-data">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== å…¨å±€å˜é‡ ====================
    let groups = {};
    let groupNames = {};
    let selectedMembers = [];

    // ==================== åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', async () => {
      await initializeData();
      setupEventListeners();
      loadExcludedList();
    });

    // ==================== æ•°æ®åŠ è½½ ====================
    async function initializeData() {
      try {
        // åˆå§‹åŒ–Firebase
        if (!firebase.apps.length && window.firebaseConfig) {
          firebase.initializeApp(window.firebaseConfig);
        }

        const db = firebase.database();

        // åŠ è½½æ•°æ®ï¼ˆåªéœ€è¦groupså’ŒgroupNamesï¼‰
        const [groupsSnap, groupNamesSnap] = await Promise.all([
          db.ref('groups').once('value'),
          db.ref('groupNames').once('value')
        ]);

        groups = groupsSnap.val() || {};
        groupNames = groupNamesSnap.val() || {};

        console.log('âœ… æ•°æ®åŠ è½½æˆåŠŸ', {
          groups: Object.keys(groups).length,
          groupNames: Object.keys(groupNames).length
        });
      } catch (error) {
        console.error('âŒ æ•°æ®åŠ è½½å¤±è´¥:', error);
        alert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    }

    // ==================== äº‹ä»¶ç›‘å¬ ====================
    function setupEventListeners() {
      const searchInput = document.getElementById('searchInput');
      const addButton = document.getElementById('addButton');
      const clearButton = document.getElementById('clearButton');

      searchInput.addEventListener('input', handleSearch);
      addButton.addEventListener('click', addToExcludeList);
      clearButton.addEventListener('click', clearSelection);
    }

    // ==================== æœç´¢åŠŸèƒ½ ====================
    function handleSearch() {
      const query = document.getElementById('searchInput').value.trim();
      const suggestionsBox = document.getElementById('suggestions');

      if (query.length < 1) {
        suggestionsBox.classList.add('hidden');
        return;
      }

      const lowerQuery = query.toLowerCase();
      const suggestions = [];

      // æœç´¢æˆå‘˜
      Object.keys(groups).forEach(groupKey => {
        const members = groups[groupKey] || [];
        members.forEach(member => {
          if (!member || !member.name) return;

          const memberName = member.name.toLowerCase();
          const nickname = (member.nickname || '').toLowerCase();
          const groupName = (groupNames[groupKey] || groupKey).toLowerCase();

          // æ£€æŸ¥æ˜¯å¦åŒ¹é…
          if (memberName.includes(lowerQuery) || 
              nickname.includes(lowerQuery) || 
              groupName.includes(lowerQuery)) {
            
            // æ£€æŸ¥æ˜¯å¦å·²åœ¨æ’é™¤åˆ—è¡¨ä¸­ï¼ˆç›´æ¥æ£€æŸ¥æˆå‘˜çš„excludedå±æ€§ï¼‰
            const isExcluded = member.excluded === true || member.excluded === 'true';

            if (!isExcluded) {
              // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©
              const isSelected = selectedMembers.some(selected => 
                selected.uuid === member.uuid || 
                (selected.name === member.name && selected.groupKey === groupKey)
              );

              suggestions.push({
                ...member,
                groupKey: groupKey,
                groupName: groupNames[groupKey] || groupKey,
                isSelected: isSelected
              });
            }
          }
        });
      });

      showSuggestions(suggestions);
    }

    function showSuggestions(suggestions) {
      const suggestionsBox = document.getElementById('suggestions');
      suggestionsBox.innerHTML = '';

      if (suggestions.length === 0) {
        suggestionsBox.classList.add('hidden');
        return;
      }

      suggestionsBox.classList.remove('hidden');

      suggestions.slice(0, 15).forEach(member => {
        const item = document.createElement('div');
        item.className = `suggestion-item ${member.isSelected ? 'selected' : ''}`;
        
        const realName = member.name || '';
        const nickname = member.nickname || '';
        let nameDisplay = realName;
        if (nickname && nickname !== realName) {
          nameDisplay = `${realName}(${nickname})`;
        }

        item.innerHTML = `
          <div class="member-info-display">
            <div class="member-name">${nameDisplay}</div>
            <div class="member-group">${member.groupName}</div>
          </div>
          <input type="checkbox" class="select-checkbox" ${member.isSelected ? 'checked' : ''}>
        `;

        item.addEventListener('click', (e) => {
          if (e.target.type !== 'checkbox') {
            toggleSelection(member);
          } else {
            toggleSelection(member);
          }
        });

        suggestionsBox.appendChild(item);
      });
    }

    // ==================== é€‰æ‹©ç®¡ç† ====================
    function toggleSelection(member) {
      const existingIndex = selectedMembers.findIndex(selected => 
        selected.uuid === member.uuid || 
        (selected.name === member.name && selected.groupKey === member.groupKey)
      );

      if (existingIndex >= 0) {
        selectedMembers.splice(existingIndex, 1);
      } else {
        selectedMembers.push({
          name: member.name,
          nickname: member.nickname,
          groupKey: member.groupKey,
          groupName: member.groupName,
          uuid: member.uuid
        });
      }

      updateSelectedDisplay();
      handleSearch(); // åˆ·æ–°æœç´¢ç»“æœä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
    }

    function updateSelectedDisplay() {
      const selectedList = document.getElementById('selectedMembersList');
      const selectedCount = document.getElementById('selectedCount');

      selectedCount.textContent = selectedMembers.length;

      if (selectedMembers.length === 0) {
        selectedList.innerHTML = '<div class="no-data">è¯·æœç´¢å¹¶é€‰æ‹©è¦æ’é™¤çš„äººå‘˜</div>';
        return;
      }

      selectedList.innerHTML = '';
      selectedMembers.forEach(member => {
        const item = document.createElement('div');
        item.className = 'selected-member-item';

        const realName = member.name || '';
        const nickname = member.nickname || '';
        let nameDisplay = realName;
        if (nickname && nickname !== realName) {
          nameDisplay = `${realName}(${nickname})`;
        }

        item.innerHTML = `
          <div class="member-info-display">
            <div class="member-name">${nameDisplay}</div>
            <div class="member-group">${member.groupName}</div>
          </div>
          <button class="remove-btn" onclick="removeSelected('${member.uuid || member.name}', '${member.groupKey}')">Ã—</button>
        `;
        selectedList.appendChild(item);
      });
    }

    window.removeSelected = function(identifier, groupKey) {
      selectedMembers = selectedMembers.filter(member => 
        !(member.uuid === identifier || (member.name === identifier && member.groupKey === groupKey))
      );
      updateSelectedDisplay();
      handleSearch();
    };

    function clearSelection() {
      selectedMembers = [];
      updateSelectedDisplay();
      document.getElementById('searchInput').value = '';
      document.getElementById('suggestions').classList.add('hidden');
    }

    // ==================== æ·»åŠ åˆ°æ’é™¤åˆ—è¡¨ ====================
    async function addToExcludeList() {
      if (selectedMembers.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦æ’é™¤çš„äººå‘˜ï¼');
        return;
      }

      if (!confirm(`ç¡®å®šè¦æ·»åŠ  ${selectedMembers.length} ä¸ªäººå‘˜åˆ°æ’é™¤åˆ—è¡¨å—ï¼Ÿ`)) {
        return;
      }

      try {
        const db = firebase.database();
        const updates = {};
        let addedCount = 0;

        // ğŸ”’ æ–°é€»è¾‘ï¼šåœ¨æˆå‘˜å¯¹è±¡ä¸Šè®¾ç½® excluded: true æ ‡è®°
        for (const member of selectedMembers) {
          const groupKey = member.groupKey;
          const groupMembers = groups[groupKey] || [];
          
          // æ‰¾åˆ°æˆå‘˜åœ¨æ•°ç»„ä¸­çš„ä½ç½®
          const memberIndex = groupMembers.findIndex(m => 
            (m.uuid && m.uuid === member.uuid) ||
            (m.name === member.name)
          );

          if (memberIndex >= 0) {
            // ä½¿ç”¨update()è®¾ç½®excludedæ ‡è®°
            updates[`groups/${groupKey}/${memberIndex}/excluded`] = true;
            addedCount++;
            console.log(`  âœ… æ ‡è®°æˆå‘˜ï¼šgroups/${groupKey}/${memberIndex} - ${member.name}`);
          } else {
            console.warn(`  âš ï¸ æœªæ‰¾åˆ°æˆå‘˜ï¼š${member.name} (${groupKey})`);
          }
        }

        if (addedCount === 0) {
          alert('æœªæ‰¾åˆ°ä»»ä½•è¦æ’é™¤çš„æˆå‘˜ï¼');
          return;
        }

        // âœ… å®‰å…¨è§„åˆ™ï¼šä½¿ç”¨update()å¢é‡æ›´æ–°ï¼Œä¸è¦†ç›–å…¶ä»–æ•°æ®
        console.log('ğŸ”’ å®‰å…¨æ“ä½œï¼šä½¿ç”¨ update() è®¾ç½®æˆå‘˜çš„ excluded æ ‡è®°');
        console.log('ğŸ“ æ›´æ–°å†…å®¹ï¼ˆå‰3ä¸ªï¼‰:', Object.keys(updates).slice(0, 3));
        
        await db.ref().update(updates);

        console.log(`âœ… æˆåŠŸæ ‡è®° ${addedCount} ä¸ªæˆå‘˜ä¸ºæ’é™¤çŠ¶æ€`);
        
        // æ¸…é™¤localStorageç¼“å­˜
        localStorage.removeItem('msh_groups');
        console.log('ğŸ”„ å·²æ¸…é™¤æœ¬åœ°ç¼“å­˜ï¼Œå…¶ä»–é¡µé¢å°†é‡æ–°åŠ è½½æœ€æ–°æ•°æ®');
        
        alert(`âœ… æˆåŠŸæ·»åŠ  ${addedCount} ä¸ªäººå‘˜åˆ°æ’é™¤åˆ—è¡¨ï¼\n\næç¤ºï¼šå¦‚æœæ—¥æŠ¥è¡¨å·²æ‰“å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢ä»¥æŸ¥çœ‹æœ€æ–°ç»Ÿè®¡ã€‚`);

        // é‡æ–°åŠ è½½æ•°æ®
        await initializeData();

        // æ¸…ç©ºé€‰æ‹©
        clearSelection();

        // åˆ·æ–°å·²æ’é™¤åˆ—è¡¨
        loadExcludedList();

      } catch (error) {
        console.error('âŒ æ·»åŠ å¤±è´¥:', error);
        alert('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
      }
    }

    // ==================== æ˜¾ç¤ºå·²æ’é™¤åˆ—è¡¨ ====================
    function loadExcludedList() {
      const excludedList = document.getElementById('excludedList');
      const excludedCount = document.getElementById('excludedCount');

      // ä»groupsä¸­æå–æ‰€æœ‰ excluded: true çš„æˆå‘˜
      const list = [];
      Object.keys(groups).forEach(groupId => {
        const members = groups[groupId] || [];
        members.forEach((member, index) => {
          if (member.excluded === true || member.excluded === 'true') {
            list.push({
              ...member,
              groupId: groupId,
              memberIndex: index,
              groupName: groupNames[groupId] || groupId
            });
          }
        });
      });

      excludedCount.textContent = list.length;

      if (list.length === 0) {
        excludedList.innerHTML = '<div class="no-data">æš‚æ— æ’é™¤äººå‘˜</div>';
        return;
      }

      excludedList.innerHTML = '';
      
      list.forEach(member => {
        const item = document.createElement('div');
        item.className = 'excluded-item';

        const realName = member.name || '';
        const nickname = member.nickname || '';
        let nameDisplay = realName;
        if (nickname && nickname !== realName) {
          nameDisplay = `${realName}(${nickname})`;
        }

        item.innerHTML = `
          <div>
            <div class="member-name">${nameDisplay}</div>
            <div class="member-group">${member.groupName}</div>
          </div>
          <button class="remove-btn" onclick="removeFromExcludeList('${member.groupId}', ${member.memberIndex})">ç§»é™¤</button>
        `;
        excludedList.appendChild(item);
      });
    }

    // ==================== ä»æ’é™¤åˆ—è¡¨ç§»é™¤ ====================
    window.removeFromExcludeList = async function(groupId, memberIndex) {
      const member = groups[groupId]?.[memberIndex];
      if (!member) {
        alert('æœªæ‰¾åˆ°è¯¥æˆå‘˜ï¼');
        return;
      }

      const realName = member.name || '';
      const nickname = member.nickname || '';
      let nameDisplay = realName;
      if (nickname && nickname !== realName) {
        nameDisplay = `${realName}(${nickname})`;
      }

      if (!confirm(`ç¡®å®šè¦ç§»é™¤ ${nameDisplay}(${groupNames[groupId] || groupId}) å—ï¼Ÿ`)) {
        return;
      }

      try {
        const db = firebase.database();

        // âœ… æ–°é€»è¾‘ï¼šç§»é™¤æˆå‘˜çš„ excluded æ ‡è®°ï¼ˆè®¾ç½®ä¸ºfalseæˆ–åˆ é™¤è¯¥å­—æ®µï¼‰
        console.log(`ğŸ”’ å®‰å…¨æ“ä½œï¼šç§»é™¤æˆå‘˜çš„ excluded æ ‡è®° groups/${groupId}/${memberIndex}/excluded`);
        
        // ä½¿ç”¨ update è®¾ç½®ä¸º null æ¥åˆ é™¤å­—æ®µ
        await db.ref(`groups/${groupId}/${memberIndex}/excluded`).remove();

        console.log(`âœ… å·²ç§»é™¤ ${nameDisplay}ï¼ˆç§»é™¤excludedæ ‡è®°ï¼‰`);
        
        // æ¸…é™¤localStorageç¼“å­˜
        localStorage.removeItem('msh_groups');
        console.log('ğŸ”„ å·²æ¸…é™¤æœ¬åœ°ç¼“å­˜ï¼Œå…¶ä»–é¡µé¢å°†é‡æ–°åŠ è½½æœ€æ–°æ•°æ®');
        
        alert(`âœ… å·²æˆåŠŸç§»é™¤ ${nameDisplay}ï¼\n\næç¤ºï¼šå¦‚æœæ—¥æŠ¥è¡¨å·²æ‰“å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢ä»¥æŸ¥çœ‹æœ€æ–°ç»Ÿè®¡ã€‚`);

        // é‡æ–°åŠ è½½æ•°æ®
        await initializeData();

        // åˆ·æ–°åˆ—è¡¨
        loadExcludedList();

      } catch (error) {
        console.error('âŒ ç§»é™¤å¤±è´¥:', error);
        alert('ç§»é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
      }
    };
  </script>
</body>
</html>
