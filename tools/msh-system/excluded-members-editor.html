<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>编辑排除人员</title>
  <link rel="stylesheet" href="../../src/style.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      padding: 30px;
    }

    .header h1 {
      margin: 0 0 10px 0;
      font-size: 28px;
      font-weight: 600;
    }

    .header p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }

    .content {
      padding: 30px;
    }

    .back-button {
      display: inline-block;
      padding: 10px 20px;
      background: #6c757d;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .back-button:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .section h3 {
      margin: 0 0 15px 0;
      color: #2c3e50;
      font-size: 18px;
    }

    .search-box {
      position: relative;
      margin-bottom: 15px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .search-box input:focus {
      border-color: #28a745;
      outline: none;
    }

    .suggestions-box {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-top: 5px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 100;
    }

    .suggestions-box.hidden {
      display: none;
    }

    .suggestion-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .suggestion-item:hover {
      background: #f8f9fa;
    }

    .suggestion-item.selected {
      background: #e7f5ff;
    }

    .member-info-display {
      flex: 1;
    }

    .member-name {
      font-weight: 600;
      color: #2c3e50;
    }

    .member-group {
      font-size: 12px;
      color: #6c757d;
      margin-top: 2px;
    }

    .select-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .selected-members-box {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      min-height: 100px;
      max-height: 300px;
      overflow-y: auto;
    }

    .selected-member-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #e7f5ff;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .selected-member-item:last-child {
      margin-bottom: 0;
    }

    .remove-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }

    .remove-btn:hover {
      background: #c82333;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .primary-button, .secondary-button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .primary-button {
      background: #28a745;
      color: white;
    }

    .primary-button:hover {
      background: #218838;
      transform: translateY(-2px);
    }

    .secondary-button {
      background: #6c757d;
      color: white;
    }

    .secondary-button:hover {
      background: #5a6268;
    }

    .excluded-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .excluded-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: white;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 4px solid #dc3545;
    }

    .excluded-item:hover {
      background: #f8f9fa;
      transform: translateX(5px);
      transition: all 0.3s;
    }

    .no-data {
      text-align: center;
      color: #6c757d;
      padding: 20px;
    }

    .count-badge {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
    }
  </style>
  <!-- 引入配置文件 -->
  <script src="../../src/smart-config-loader.js"></script>
  <!-- 引入 Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- 引入工具函数模块 -->
  <script src="../../src/core/firebase-utils.js"></script>
  <script src="../../src/core/time-utils.js"></script>
  <script src="../../src/core/security-utils.js"></script>
  <script src="../../src/data/uuid-manager.js"></script>
  <script src="../../src/features/sunday-tracking-utils.js"></script>
  <script src="../../src/data/sync-managers.js"></script>
  <script src="../../src/utils.js"></script>
  <!-- 引入新数据管理器 -->
  <script src="../../src/new-data-manager.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>✏️ 编辑排除人员</h1>
      <p>添加或移除未签到不统计人员 · 使用增量同步，安全可靠</p>
    </div>

    <div class="content">
      <a href="excluded-members-viewer.html" class="back-button">← 返回查看页面</a>

      <!-- 搜索添加区域 -->
      <div class="section">
        <h3>➕ 添加排除人员</h3>
        
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="搜索人员姓名、花名或小组名称..." aria-label="搜索成员">
          <div id="suggestions" class="suggestions-box hidden"></div>
        </div>

        <div>
          <h4>已选择的人员 <span class="count-badge" id="selectedCount">0</span></h4>
          <div class="selected-members-box" id="selectedMembersList">
            <div class="no-data">请搜索并选择要排除的人员</div>
          </div>
        </div>

        <div class="action-buttons">
          <button id="addButton" class="primary-button" type="button">✅ 添加到排除列表</button>
          <button id="clearButton" class="secondary-button" type="button">🗑️ 清空选择</button>
        </div>
      </div>

      <!-- 已排除人员列表 -->
      <div class="section">
        <h3>📋 已排除人员列表 <span class="count-badge" id="excludedCount">0</span></h3>
        <div class="excluded-list" id="excludedList">
          <div class="no-data">加载中...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== 全局变量 ====================
    let groups = {};
    let groupNames = {};
    let selectedMembers = [];

    // ==================== 初始化 ====================
    document.addEventListener('DOMContentLoaded', async () => {
      await initializeData();
      setupEventListeners();
      loadExcludedList();
    });

    // ==================== 数据加载 ====================
    async function initializeData() {
      try {
        // 初始化Firebase
        if (!firebase.apps.length && window.firebaseConfig) {
          firebase.initializeApp(window.firebaseConfig);
        }

        const db = firebase.database();

        // 加载数据（只需要groups和groupNames）
        const [groupsSnap, groupNamesSnap] = await Promise.all([
          db.ref('groups').once('value'),
          db.ref('groupNames').once('value')
        ]);

        groups = groupsSnap.val() || {};
        groupNames = groupNamesSnap.val() || {};

        console.log('✅ 数据加载成功', {
          groups: Object.keys(groups).length,
          groupNames: Object.keys(groupNames).length
        });
      } catch (error) {
        console.error('❌ 数据加载失败:', error);
        alert('数据加载失败，请刷新页面重试');
      }
    }

    // ==================== 事件监听 ====================
    function setupEventListeners() {
      const searchInput = document.getElementById('searchInput');
      const addButton = document.getElementById('addButton');
      const clearButton = document.getElementById('clearButton');

      searchInput.addEventListener('input', handleSearch);
      addButton.addEventListener('click', addToExcludeList);
      clearButton.addEventListener('click', clearSelection);
    }

    // ==================== 搜索功能 ====================
    function handleSearch() {
      const query = document.getElementById('searchInput').value.trim();
      const suggestionsBox = document.getElementById('suggestions');

      if (query.length < 1) {
        suggestionsBox.classList.add('hidden');
        return;
      }

      const lowerQuery = query.toLowerCase();
      const suggestions = [];

      // 搜索成员
      Object.keys(groups).forEach(groupKey => {
        const members = groups[groupKey] || [];
        members.forEach(member => {
          if (!member || !member.name) return;

          const memberName = member.name.toLowerCase();
          const nickname = (member.nickname || '').toLowerCase();
          const groupName = (groupNames[groupKey] || groupKey).toLowerCase();

          // 检查是否匹配
          if (memberName.includes(lowerQuery) || 
              nickname.includes(lowerQuery) || 
              groupName.includes(lowerQuery)) {
            
            // 检查是否已在排除列表中（直接检查成员的excluded属性）
            const isExcluded = member.excluded === true || member.excluded === 'true';

            if (!isExcluded) {
              // 检查是否已选择
              const isSelected = selectedMembers.some(selected => 
                selected.uuid === member.uuid || 
                (selected.name === member.name && selected.groupKey === groupKey)
              );

              suggestions.push({
                ...member,
                groupKey: groupKey,
                groupName: groupNames[groupKey] || groupKey,
                isSelected: isSelected
              });
            }
          }
        });
      });

      showSuggestions(suggestions);
    }

    function showSuggestions(suggestions) {
      const suggestionsBox = document.getElementById('suggestions');
      suggestionsBox.innerHTML = '';

      if (suggestions.length === 0) {
        suggestionsBox.classList.add('hidden');
        return;
      }

      suggestionsBox.classList.remove('hidden');

      suggestions.slice(0, 15).forEach(member => {
        const item = document.createElement('div');
        item.className = `suggestion-item ${member.isSelected ? 'selected' : ''}`;
        
        const realName = member.name || '';
        const nickname = member.nickname || '';
        let nameDisplay = realName;
        if (nickname && nickname !== realName) {
          nameDisplay = `${realName}(${nickname})`;
        }

        item.innerHTML = `
          <div class="member-info-display">
            <div class="member-name">${nameDisplay}</div>
            <div class="member-group">${member.groupName}</div>
          </div>
          <input type="checkbox" class="select-checkbox" ${member.isSelected ? 'checked' : ''}>
        `;

        item.addEventListener('click', (e) => {
          if (e.target.type !== 'checkbox') {
            toggleSelection(member);
          } else {
            toggleSelection(member);
          }
        });

        suggestionsBox.appendChild(item);
      });
    }

    // ==================== 选择管理 ====================
    function toggleSelection(member) {
      const existingIndex = selectedMembers.findIndex(selected => 
        selected.uuid === member.uuid || 
        (selected.name === member.name && selected.groupKey === member.groupKey)
      );

      if (existingIndex >= 0) {
        selectedMembers.splice(existingIndex, 1);
      } else {
        selectedMembers.push({
          name: member.name,
          nickname: member.nickname,
          groupKey: member.groupKey,
          groupName: member.groupName,
          uuid: member.uuid
        });
      }

      updateSelectedDisplay();
      handleSearch(); // 刷新搜索结果以更新选中状态
    }

    function updateSelectedDisplay() {
      const selectedList = document.getElementById('selectedMembersList');
      const selectedCount = document.getElementById('selectedCount');

      selectedCount.textContent = selectedMembers.length;

      if (selectedMembers.length === 0) {
        selectedList.innerHTML = '<div class="no-data">请搜索并选择要排除的人员</div>';
        return;
      }

      selectedList.innerHTML = '';
      selectedMembers.forEach(member => {
        const item = document.createElement('div');
        item.className = 'selected-member-item';

        const realName = member.name || '';
        const nickname = member.nickname || '';
        let nameDisplay = realName;
        if (nickname && nickname !== realName) {
          nameDisplay = `${realName}(${nickname})`;
        }

        item.innerHTML = `
          <div class="member-info-display">
            <div class="member-name">${nameDisplay}</div>
            <div class="member-group">${member.groupName}</div>
          </div>
          <button class="remove-btn" onclick="removeSelected('${member.uuid || member.name}', '${member.groupKey}')">×</button>
        `;
        selectedList.appendChild(item);
      });
    }

    window.removeSelected = function(identifier, groupKey) {
      selectedMembers = selectedMembers.filter(member => 
        !(member.uuid === identifier || (member.name === identifier && member.groupKey === groupKey))
      );
      updateSelectedDisplay();
      handleSearch();
    };

    function clearSelection() {
      selectedMembers = [];
      updateSelectedDisplay();
      document.getElementById('searchInput').value = '';
      document.getElementById('suggestions').classList.add('hidden');
    }

    // ==================== 添加到排除列表 ====================
    async function addToExcludeList() {
      if (selectedMembers.length === 0) {
        alert('请先选择要排除的人员！');
        return;
      }

      if (!confirm(`确定要添加 ${selectedMembers.length} 个人员到排除列表吗？`)) {
        return;
      }

      try {
        const db = firebase.database();
        const updates = {};
        let addedCount = 0;

        // 🔒 新逻辑：在成员对象上设置 excluded: true 标记
        for (const member of selectedMembers) {
          const groupKey = member.groupKey;
          const groupMembers = groups[groupKey] || [];
          
          // 找到成员在数组中的位置
          const memberIndex = groupMembers.findIndex(m => 
            (m.uuid && m.uuid === member.uuid) ||
            (m.name === member.name)
          );

          if (memberIndex >= 0) {
            // 使用update()设置excluded标记
            updates[`groups/${groupKey}/${memberIndex}/excluded`] = true;
            addedCount++;
            console.log(`  ✅ 标记成员：groups/${groupKey}/${memberIndex} - ${member.name}`);
          } else {
            console.warn(`  ⚠️ 未找到成员：${member.name} (${groupKey})`);
          }
        }

        if (addedCount === 0) {
          alert('未找到任何要排除的成员！');
          return;
        }

        // ✅ 安全规则：使用update()增量更新，不覆盖其他数据
        console.log('🔒 安全操作：使用 update() 设置成员的 excluded 标记');
        console.log('📝 更新内容（前3个）:', Object.keys(updates).slice(0, 3));
        
        await db.ref().update(updates);

        console.log(`✅ 成功标记 ${addedCount} 个成员为排除状态`);
        
        // 清除localStorage缓存
        localStorage.removeItem('msh_groups');
        console.log('🔄 已清除本地缓存，其他页面将重新加载最新数据');
        
        alert(`✅ 成功添加 ${addedCount} 个人员到排除列表！\n\n提示：如果日报表已打开，请刷新页面以查看最新统计。`);

        // 重新加载数据
        await initializeData();

        // 清空选择
        clearSelection();

        // 刷新已排除列表
        loadExcludedList();

      } catch (error) {
        console.error('❌ 添加失败:', error);
        alert('添加失败，请重试！');
      }
    }

    // ==================== 显示已排除列表 ====================
    function loadExcludedList() {
      const excludedList = document.getElementById('excludedList');
      const excludedCount = document.getElementById('excludedCount');

      // 从groups中提取所有 excluded: true 的成员
      const list = [];
      Object.keys(groups).forEach(groupId => {
        const members = groups[groupId] || [];
        members.forEach((member, index) => {
          if (member.excluded === true || member.excluded === 'true') {
            list.push({
              ...member,
              groupId: groupId,
              memberIndex: index,
              groupName: groupNames[groupId] || groupId
            });
          }
        });
      });

      excludedCount.textContent = list.length;

      if (list.length === 0) {
        excludedList.innerHTML = '<div class="no-data">暂无排除人员</div>';
        return;
      }

      excludedList.innerHTML = '';
      
      list.forEach(member => {
        const item = document.createElement('div');
        item.className = 'excluded-item';

        const realName = member.name || '';
        const nickname = member.nickname || '';
        let nameDisplay = realName;
        if (nickname && nickname !== realName) {
          nameDisplay = `${realName}(${nickname})`;
        }

        item.innerHTML = `
          <div>
            <div class="member-name">${nameDisplay}</div>
            <div class="member-group">${member.groupName}</div>
          </div>
          <button class="remove-btn" onclick="removeFromExcludeList('${member.groupId}', ${member.memberIndex})">移除</button>
        `;
        excludedList.appendChild(item);
      });
    }

    // ==================== 从排除列表移除 ====================
    window.removeFromExcludeList = async function(groupId, memberIndex) {
      const member = groups[groupId]?.[memberIndex];
      if (!member) {
        alert('未找到该成员！');
        return;
      }

      const realName = member.name || '';
      const nickname = member.nickname || '';
      let nameDisplay = realName;
      if (nickname && nickname !== realName) {
        nameDisplay = `${realName}(${nickname})`;
      }

      if (!confirm(`确定要移除 ${nameDisplay}(${groupNames[groupId] || groupId}) 吗？`)) {
        return;
      }

      try {
        const db = firebase.database();

        // ✅ 新逻辑：移除成员的 excluded 标记（设置为false或删除该字段）
        console.log(`🔒 安全操作：移除成员的 excluded 标记 groups/${groupId}/${memberIndex}/excluded`);
        
        // 使用 update 设置为 null 来删除字段
        await db.ref(`groups/${groupId}/${memberIndex}/excluded`).remove();

        console.log(`✅ 已移除 ${nameDisplay}（移除excluded标记）`);
        
        // 清除localStorage缓存
        localStorage.removeItem('msh_groups');
        console.log('🔄 已清除本地缓存，其他页面将重新加载最新数据');
        
        alert(`✅ 已成功移除 ${nameDisplay}！\n\n提示：如果日报表已打开，请刷新页面以查看最新统计。`);

        // 重新加载数据
        await initializeData();

        // 刷新列表
        loadExcludedList();

      } catch (error) {
        console.error('❌ 移除失败:', error);
        alert('移除失败，请重试！');
      }
    };
  </script>
</body>
</html>
