<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆå‘˜åˆ†å¸ƒæ£€æŸ¥å·¥å…· - MSHç­¾åˆ°ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 2.2em;
        }
        
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 0;
        }
        
        .control-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(17, 153, 142, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(240, 147, 251, 0.4);
        }
        
        .import-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .import-preview {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .import-preview h4 {
            margin-top: 0;
            color: #495057;
        }
        
        .import-data {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .section-title {
            color: #2c3e50;
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .group-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .group-title {
            color: #34495e;
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .member-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .member-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .member-card.unassigned {
            border-left-color: #e74c3c;
        }
        
        .member-card.duplicate {
            border-left-color: #f39c12;
        }
        
        .member-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .member-info {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .member-stats {
            margin-top: 8px;
            font-size: 0.85em;
            color: #95a5a6;
        }
        
        .log-panel {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-info { color: #3498db; }
        .log-success { color: #2ecc71; }
        .log-warning { color: #f39c12; }
        .log-error { color: #e74c3c; }
        
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .summary-table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .summary-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .summary-table tr:hover {
            background: #f8f9fa;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .export-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .sync-section {
            margin-top: 20px;
            padding: 20px;
            background: #e8f4fd;
            border-radius: 8px;
            border: 1px solid #b3d9ff;
        }
        
        .sync-status {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .sync-status h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .sync-status-data {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” æˆå‘˜åˆ†å¸ƒæ£€æŸ¥å·¥å…·</h1>
            <p>æ£€æŸ¥MSHç³»ç»Ÿä¸­æ‰€æœ‰äººå‘˜ä¿¡æ¯ï¼Œåˆ†ææˆå‘˜åˆ†å¸ƒæƒ…å†µ</p>
        </div>
        
        <div class="stats-panel">
            <div class="stat-card">
                <h3>ç­¾åˆ°è®°å½•æ€»æ•°</h3>
                <p class="number" id="totalSignins">-</p>
            </div>
            <div class="stat-card">
                <h3>å”¯ä¸€æˆå‘˜æ•°</h3>
                <p class="number" id="uniqueMembers">-</p>
            </div>
            <div class="stat-card">
                <h3>å°ç»„æ•°é‡</h3>
                <p class="number" id="groupCount">-</p>
            </div>
            <div class="stat-card">
                <h3>æœªåˆ†ç»„äººå‘˜</h3>
                <p class="number" id="unassignedCount">-</p>
            </div>
        </div>
        
        <div class="control-panel">
            <button class="btn btn-primary" onclick="loadAllData()">ğŸ“Š åŠ è½½æ‰€æœ‰æ•°æ®</button>
            <button class="btn btn-success" onclick="analyzeMemberDistribution()">ğŸ” åˆ†ææˆå‘˜åˆ†å¸ƒ</button>
            <button class="btn btn-warning" onclick="exportResults()">ğŸ“¤ å¯¼å‡ºç»“æœ</button>
            <button class="btn btn-primary" onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
        </div>
        
        <div class="import-section">
            <h3 class="section-title">ğŸ“¥ æ‰¹é‡å¯¼å…¥åŠŸèƒ½</h3>
            <div class="control-panel">
                <input type="file" id="importFile" accept=".js,.json" style="display: none;" onchange="handleFileImport(event)">
                <button class="btn btn-success" onclick="document.getElementById('importFile').click()">ğŸ“ é€‰æ‹©å¯¼å…¥æ–‡ä»¶</button>
                <button class="btn btn-warning" onclick="importToGroup0()">ğŸ“¥ å¯¼å…¥åˆ°æœªåˆ†ç»„</button>
                <button class="btn btn-primary" onclick="previewImport()">ğŸ‘ï¸ é¢„è§ˆå¯¼å…¥æ•°æ®</button>
            </div>
            <div id="importPreview" class="import-preview" style="display: none;">
                <h4>å¯¼å…¥é¢„è§ˆ</h4>
                <div id="importData"></div>
            </div>
        </div>
        
        <div class="sync-section">
            <h3 class="section-title">ğŸ”„ æ•°æ®åŒæ­¥æ§åˆ¶</h3>
            <div class="control-panel">
                <button class="btn btn-info" onclick="syncToFirebase()">â˜ï¸ åŒæ­¥åˆ°Firebase</button>
                <button class="btn btn-warning" onclick="syncFromFirebase()">â¬‡ï¸ ä»FirebaseåŒæ­¥</button>
                <button class="btn btn-success" onclick="forceSyncAll()">ğŸ”„ å¼ºåˆ¶å…¨é‡åŒæ­¥</button>
                <button class="btn btn-primary" onclick="checkSyncStatus()">ğŸ“Š æ£€æŸ¥åŒæ­¥çŠ¶æ€</button>
            </div>
            <div id="syncStatus" class="sync-status" style="display: none;">
                <h4>åŒæ­¥çŠ¶æ€</h4>
                <div id="syncStatusData"></div>
            </div>
        </div>
        
        <div class="results-section" id="resultsSection" style="display: none;">
            <h2 class="section-title">ğŸ“‹ åˆ†æç»“æœ</h2>
            
            <div id="unassignedMembersSection" class="group-section">
                <h3 class="group-title">âŒ æœªåˆ†ç»„äººå‘˜</h3>
                <div id="unassignedMembersList" class="member-list"></div>
            </div>
            
            <div id="duplicateMembersSection" class="group-section">
                <h3 class="group-title">âš ï¸ å¤šç»„é‡å¤äººå‘˜</h3>
                <div id="duplicateMembersList" class="member-list"></div>
            </div>
            
            <div id="groupSummarySection" class="group-section">
                <h3 class="group-title">ğŸ“Š å°ç»„æˆå‘˜ç»Ÿè®¡</h3>
                <table class="summary-table" id="groupSummaryTable">
                    <thead>
                        <tr>
                            <th>å°ç»„åç§°</th>
                            <th>ç­¾åˆ°æˆå‘˜æ•°</th>
                            <th>ç­¾åˆ°æ¬¡æ•°</th>
                            <th>å¹³å‡ç­¾åˆ°</th>
                            <th>æœ€åç­¾åˆ°</th>
                        </tr>
                    </thead>
                    <tbody id="groupSummaryBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="export-section" id="exportSection" style="display: none;">
            <h3 class="section-title">ğŸ“¤ å¯¼å‡ºé€‰é¡¹</h3>
            <div class="control-panel">
                <button class="btn btn-success" onclick="exportUnassignedMembers()">å¯¼å‡ºæœªåˆ†ç»„äººå‘˜</button>
                <button class="btn btn-warning" onclick="exportDuplicateMembers()">å¯¼å‡ºé‡å¤äººå‘˜</button>
                <button class="btn btn-primary" onclick="exportFullReport()">å¯¼å‡ºå®Œæ•´æŠ¥å‘Š</button>
            </div>
        </div>
        
        <div class="log-panel" id="logPanel">
            <div class="log-entry log-info">[INFO] æˆå‘˜åˆ†å¸ƒæ£€æŸ¥å·¥å…·å·²å¯åŠ¨</div>
            <div class="log-entry log-info">[INFO] è¯·ç‚¹å‡»"åŠ è½½æ‰€æœ‰æ•°æ®"å¼€å§‹åˆ†æ</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- é…ç½®å’Œå·¥å…·å‡½æ•° -->
    <script src="../../config.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let allAttendanceRecords = [];
        let allGroups = {};
        let allMembers = {};
        let analysisResults = {};
        
        // æ—¥å¿—å‡½æ•°
        function addLog(type, message) {
            const logPanel = document.getElementById('logPanel');
            const timestamp = new Date().toLocaleString('zh-CN');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            addLog('info', 'å¼€å§‹åŠ è½½æ‰€æœ‰æ•°æ®...');
            
            try {
                // åŠ è½½ç­¾åˆ°è®°å½•
                await loadAttendanceRecords();
                
                // åŠ è½½å°ç»„æ•°æ®
                await loadGroupsData();
                
                // æ›´æ–°ç»Ÿè®¡é¢æ¿
                updateStatsPanel();
                
                addLog('success', 'æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆï¼');
                addLog('info', `ç­¾åˆ°è®°å½•: ${allAttendanceRecords.length} æ¡`);
                addLog('info', `å°ç»„æ•°æ®: ${Object.keys(allGroups).length} ä¸ªå°ç»„`);
                
            } catch (error) {
                addLog('error', `æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ç­¾åˆ°è®°å½•
        async function loadAttendanceRecords() {
            addLog('info', 'åŠ è½½ç­¾åˆ°è®°å½•...');
            
            try {
                // åˆå§‹åŒ–Firebase
                if (firebase.apps.length === 0) {
                    // æ£€æŸ¥Firebaseé…ç½®æ˜¯å¦å·²åŠ è½½
                    if (typeof window.firebaseConfig !== 'undefined' && window.firebaseConfig) {
                        firebase.initializeApp(window.firebaseConfig);
                    } else {
                        throw new Error('Firebaseé…ç½®æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥config.jsæ–‡ä»¶');
                    }
                }
                
                // ä»FirebaseåŠ è½½
                const ref = firebase.database().ref('attendanceRecords');
                const snapshot = await ref.once('value');
                const firebaseData = snapshot.val() || {};
                
                // è½¬æ¢ä¸ºæ•°ç»„
                allAttendanceRecords = Object.values(firebaseData);
                
                addLog('success', `ä»FirebaseåŠ è½½äº† ${allAttendanceRecords.length} æ¡ç­¾åˆ°è®°å½•`);
                
            } catch (error) {
                addLog('error', `ä»FirebaseåŠ è½½å¤±è´¥: ${error.message}`);
                
                // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                try {
                    const localData = localStorage.getItem('msh_attendanceRecords');
                    if (localData) {
                        allAttendanceRecords = JSON.parse(localData);
                        addLog('success', `ä»æœ¬åœ°å­˜å‚¨åŠ è½½äº† ${allAttendanceRecords.length} æ¡ç­¾åˆ°è®°å½•`);
                    } else {
                        throw new Error('æœ¬åœ°å­˜å‚¨ä¸­ä¹Ÿæ²¡æœ‰ç­¾åˆ°è®°å½•');
                    }
                } catch (localError) {
                    throw new Error(`æ•°æ®åŠ è½½å¤±è´¥: Firebaseé”™è¯¯ - ${error.message}, æœ¬åœ°å­˜å‚¨é”™è¯¯ - ${localError.message}`);
                }
            }
        }
        
        // åŠ è½½å°ç»„æ•°æ®
        async function loadGroupsData() {
            addLog('info', 'åŠ è½½å°ç»„æ•°æ®...');
            
            try {
                // åˆå§‹åŒ–Firebase
                if (firebase.apps.length === 0) {
                    // æ£€æŸ¥Firebaseé…ç½®æ˜¯å¦å·²åŠ è½½
                    if (typeof window.firebaseConfig !== 'undefined' && window.firebaseConfig) {
                        firebase.initializeApp(window.firebaseConfig);
                    } else {
                        throw new Error('Firebaseé…ç½®æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥config.jsæ–‡ä»¶');
                    }
                }
                
                // åŠ è½½groupsæ•°æ®
                const groupsRef = firebase.database().ref('groups');
                const groupsSnapshot = await groupsRef.once('value');
                allGroups = groupsSnapshot.val() || {};
                
                // æ”¶é›†æ‰€æœ‰æˆå‘˜ä¿¡æ¯
                allMembers = {};
                Object.keys(allGroups).forEach(groupName => {
                    const members = allGroups[groupName] || [];
                    members.forEach(member => {
                        if (member.uuid) {
                            allMembers[member.uuid] = {
                                ...member,
                                assignedGroup: groupName
                            };
                        }
                    });
                });
                
                addLog('success', `åŠ è½½äº† ${Object.keys(allGroups).length} ä¸ªå°ç»„çš„æ•°æ®`);
                addLog('info', `æ€»å…± ${Object.keys(allMembers).length} åå·²åˆ†é…æˆå‘˜`);
                
            } catch (error) {
                addLog('error', `å°ç»„æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
                
                // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                try {
                    const localGroupsData = localStorage.getItem('msh_groups');
                    if (localGroupsData) {
                        allGroups = JSON.parse(localGroupsData);
                        
                        // æ”¶é›†æ‰€æœ‰æˆå‘˜ä¿¡æ¯
                        allMembers = {};
                        Object.keys(allGroups).forEach(groupName => {
                            const members = allGroups[groupName] || [];
                            members.forEach(member => {
                                if (member.uuid) {
                                    allMembers[member.uuid] = {
                                        ...member,
                                        assignedGroup: groupName
                                    };
                                }
                            });
                        });
                        
                        addLog('success', `ä»æœ¬åœ°å­˜å‚¨åŠ è½½äº† ${Object.keys(allGroups).length} ä¸ªå°ç»„çš„æ•°æ®`);
                        addLog('info', `æ€»å…± ${Object.keys(allMembers).length} åå·²åˆ†é…æˆå‘˜`);
                    } else {
                        throw new Error('æœ¬åœ°å­˜å‚¨ä¸­ä¹Ÿæ²¡æœ‰å°ç»„æ•°æ®');
                    }
                } catch (localError) {
                    throw new Error(`å°ç»„æ•°æ®åŠ è½½å¤±è´¥: Firebaseé”™è¯¯ - ${error.message}, æœ¬åœ°å­˜å‚¨é”™è¯¯ - ${localError.message}`);
                }
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡é¢æ¿
        function updateStatsPanel() {
            // è®¡ç®—å”¯ä¸€æˆå‘˜æ•°ï¼ˆåŸºäºUUIDï¼‰
            const uniqueMemberUUIDs = new Set();
            allAttendanceRecords.forEach(record => {
                if (record.memberUUID) {
                    uniqueMemberUUIDs.add(record.memberUUID);
                }
            });
            
            document.getElementById('totalSignins').textContent = allAttendanceRecords.length;
            document.getElementById('uniqueMembers').textContent = uniqueMemberUUIDs.size;
            document.getElementById('groupCount').textContent = Object.keys(allGroups).length;
            
            // è®¡ç®—æœªåˆ†ç»„äººå‘˜æ•°ï¼ˆå°†åœ¨åˆ†æä¸­æ›´æ–°ï¼‰
            document.getElementById('unassignedCount').textContent = '-';
        }
        
        // åˆ†ææˆå‘˜åˆ†å¸ƒ
        function analyzeMemberDistribution() {
            if (allAttendanceRecords.length === 0) {
                addLog('error', 'è¯·å…ˆåŠ è½½ç­¾åˆ°æ•°æ®');
                return;
            }
            
            addLog('info', 'å¼€å§‹åˆ†ææˆå‘˜åˆ†å¸ƒ...');
            
            // è°ƒè¯•ä¿¡æ¯
            console.log('ğŸ” åˆ†ææ•°æ®:', {
                attendanceRecords: allAttendanceRecords.length,
                groups: Object.keys(allGroups).length,
                groupNames: Object.keys(JSON.parse(localStorage.getItem('msh_groupNames') || '{}')).length
            });
            
            // è°ƒè¯•ï¼šæ˜¾ç¤ºæ‰€æœ‰å°ç»„ä¿¡æ¯
            const currentGroupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
            console.log('ğŸ” å½“å‰å°ç»„ä¿¡æ¯:', Object.keys(allGroups).map(key => ({
                key,
                name: currentGroupNames[key],
                memberCount: allGroups[key]?.length || 0
            })));
            
            // è°ƒè¯•ï¼šæ˜¾ç¤ºå°ç»„åç§°æ˜ å°„
            console.log('ğŸ” å°ç»„åç§°æ˜ å°„:', currentGroupNames);
            
            // è°ƒè¯•ï¼šæ˜¾ç¤ºç­¾åˆ°è®°å½•ä¸­çš„å°ç»„åç§°
            const signinGroupNames = new Set();
            allAttendanceRecords.forEach(record => {
                if (record.groupSnapshot && record.groupSnapshot.groupName) {
                    signinGroupNames.add(record.groupSnapshot.groupName);
                }
            });
            console.log('ğŸ” ç­¾åˆ°è®°å½•ä¸­çš„å°ç»„åç§°:', Array.from(signinGroupNames));
            
            // æ”¶é›†æ‰€æœ‰ç­¾åˆ°æˆå‘˜ä¿¡æ¯
            const signinMembers = {};
            const groupSigninStats = {};
            
            allAttendanceRecords.forEach(record => {
                if (record.memberUUID) {
                    const uuid = record.memberUUID;
                    const memberName = record.memberSnapshot?.name || record.name || 'æœªçŸ¥';
                    const memberNickname = record.memberSnapshot?.nickname || '';
                    // è·å–æ­£ç¡®çš„å°ç»„åç§°
                    let groupName = 'æœªçŸ¥';
                    if (record.groupSnapshot?.groupName) {
                        groupName = record.groupSnapshot.groupName;
                    } else if (record.group) {
                        // é€šè¿‡groupNamesæ˜ å°„è·å–æ­£ç¡®çš„å°ç»„åç§°
                        const groupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
                        groupName = groupNames[record.group] || record.group;
                    }
                    
                    if (!signinMembers[uuid]) {
                        signinMembers[uuid] = {
                            uuid: uuid,
                            name: memberName,
                            nickname: memberNickname,
                            groups: new Set(),
                            signinCount: 0,
                            lastSignin: null,
                            records: []
                        };
                    }
                    
                    signinMembers[uuid].groups.add(groupName);
                    signinMembers[uuid].signinCount++;
                    signinMembers[uuid].records.push(record);
                    
                    if (!signinMembers[uuid].lastSignin || new Date(record.time) > new Date(signinMembers[uuid].lastSignin)) {
                        signinMembers[uuid].lastSignin = record.time;
                    }
                    
                    // ç»Ÿè®¡å°ç»„ç­¾åˆ°æ•°æ® - åªç»Ÿè®¡å½“å‰å­˜åœ¨çš„å°ç»„
                    const currentGroupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
                    const currentGroupKeys = Object.keys(allGroups);
                    
                    // æ£€æŸ¥è¿™ä¸ªå°ç»„åç§°æ˜¯å¦å¯¹åº”å½“å‰å­˜åœ¨çš„å°ç»„
                    let isCurrentGroup = false;
                    let currentGroupKey = null;
                    
                    // é€šè¿‡groupNamesæ˜ å°„æ‰¾åˆ°å¯¹åº”çš„å°ç»„é”®
                    for (const [key, name] of Object.entries(currentGroupNames)) {
                        if (name === groupName && currentGroupKeys.includes(key)) {
                            isCurrentGroup = true;
                            currentGroupKey = key;
                            break;
                        }
                    }
                    
                    // åªç»Ÿè®¡å½“å‰å­˜åœ¨çš„å°ç»„
                    if (isCurrentGroup && currentGroupKey) {
                        if (!groupSigninStats[groupName]) {
                            groupSigninStats[groupName] = {
                                members: new Set(),
                                signinCount: 0,
                                lastSignin: null,
                                groupKey: currentGroupKey
                            };
                        }
                        
                        groupSigninStats[groupName].members.add(uuid);
                        groupSigninStats[groupName].signinCount++;
                        
                        if (!groupSigninStats[groupName].lastSignin || new Date(record.time) > new Date(groupSigninStats[groupName].lastSignin)) {
                            groupSigninStats[groupName].lastSignin = record.time;
                        }
                    }
                }
            });
            
            // åˆ†æç»“æœ
            analysisResults = {
                signinMembers: signinMembers,
                groupSigninStats: groupSigninStats,
                unassignedMembers: [],
                duplicateMembers: []
            };
            
            // æ‰¾å‡ºæœªåˆ†ç»„äººå‘˜ï¼ˆæœ‰ç­¾åˆ°è®°å½•ä½†æ²¡æœ‰åœ¨å°ç»„ç®¡ç†ä¸­åˆ†é…ï¼‰
            Object.values(signinMembers).forEach(member => {
                // æ£€æŸ¥æˆå‘˜æ˜¯å¦åœ¨ä»»ä½•å°ç»„ä¸­
                let isAssigned = false;
                let assignedGroup = null;
                
                Object.keys(allGroups).forEach(groupKey => {
                    if (allGroups[groupKey] && Array.isArray(allGroups[groupKey])) {
                        const memberInGroup = allGroups[groupKey].find(m => m.uuid === member.uuid);
                        if (memberInGroup) {
                            isAssigned = true;
                            assignedGroup = groupKey;
                        }
                    }
                });
                
                if (!isAssigned) {
                    // è¿›ä¸€æ­¥æ£€æŸ¥ï¼šé€šè¿‡ç­¾åˆ°è®°å½•ä¸­çš„å°ç»„åç§°æ˜ å°„æ¥éªŒè¯
                    let isActuallyAssigned = false;
                    const currentGroupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
                    
                    console.log(`ğŸ” æ£€æŸ¥æˆå‘˜ ${member.name} çš„ç­¾åˆ°å°ç»„æ˜ å°„:`, {
                        signinGroups: Array.from(member.groups),
                        currentGroupNames: currentGroupNames
                    });
                    
                    // æ£€æŸ¥æˆå‘˜çš„ç­¾åˆ°å°ç»„æ˜¯å¦å¯¹åº”å½“å‰å­˜åœ¨çš„å°ç»„
                    for (const signinGroup of member.groups) {
                        for (const [groupKey, groupName] of Object.entries(currentGroupNames)) {
                            if (groupName === signinGroup && allGroups[groupKey]) {
                                console.log(`ğŸ” æ‰¾åˆ°åŒ¹é…: ${signinGroup} -> ${groupKey} (${groupName})`);
                                console.log(`ğŸ” å°ç»„ ${groupKey} ä¸­çš„æˆå‘˜:`, allGroups[groupKey].map(m => ({ name: m.name, uuid: m.uuid?.substring(0, 8) + '...' })));
                                console.log(`ğŸ” æŸ¥æ‰¾æˆå‘˜: ${member.name} (${member.uuid?.substring(0, 8) + '...'})`);
                                
                                // æ£€æŸ¥è¿™ä¸ªæˆå‘˜æ˜¯å¦åœ¨è¿™ä¸ªå°ç»„ä¸­ï¼ˆå…ˆå°è¯•UUIDåŒ¹é…ï¼Œå†å°è¯•å§“ååŒ¹é…ï¼‰
                                let memberInGroup = allGroups[groupKey].find(m => m.uuid === member.uuid);
                                if (!memberInGroup) {
                                    // UUIDåŒ¹é…å¤±è´¥ï¼Œå°è¯•å§“ååŒ¹é…
                                    memberInGroup = allGroups[groupKey].find(m => m.name === member.name);
                                    if (memberInGroup) {
                                        console.log(`âœ… æˆå‘˜ ${member.name} åœ¨å°ç»„ ${groupKey} ä¸­æ‰¾åˆ°ï¼ˆé€šè¿‡å§“ååŒ¹é…ï¼‰`);
                                    }
                                } else {
                                    console.log(`âœ… æˆå‘˜ ${member.name} åœ¨å°ç»„ ${groupKey} ä¸­æ‰¾åˆ°ï¼ˆé€šè¿‡UUIDåŒ¹é…ï¼‰`);
                                }
                                
                                if (memberInGroup) {
                                    isActuallyAssigned = true;
                                    assignedGroup = groupKey;
                                    break;
                                } else {
                                    console.log(`âŒ æˆå‘˜ ${member.name} ä¸åœ¨å°ç»„ ${groupKey} ä¸­ï¼ˆUUIDå’Œå§“åéƒ½ä¸åŒ¹é…ï¼‰`);
                                }
                            }
                        }
                        if (isActuallyAssigned) break;
                    }
                    
                    if (!isActuallyAssigned) {
                        console.log(`ğŸ” æœªåˆ†ç»„æˆå‘˜: ${member.name} (${member.uuid}) - ç­¾åˆ°å°ç»„: ${Array.from(member.groups).join(', ')}`);
                        analysisResults.unassignedMembers.push(member);
                    } else {
                        console.log(`âœ… å·²åˆ†ç»„æˆå‘˜: ${member.name} (${member.uuid}) - åˆ†é…å°ç»„: ${assignedGroup} (é€šè¿‡ç­¾åˆ°å°ç»„æ˜ å°„æ‰¾åˆ°)`);
                    }
                } else {
                    console.log(`âœ… å·²åˆ†ç»„æˆå‘˜: ${member.name} (${member.uuid}) - åˆ†é…å°ç»„: ${assignedGroup}`);
                }
            });
            
            // æ‰¾å‡ºå¤šç»„é‡å¤äººå‘˜ï¼ˆåœ¨å¤šä¸ªä¸åŒå°ç»„ä¸­éƒ½æœ‰æˆå‘˜è®°å½•ï¼‰
            Object.values(signinMembers).forEach(member => {
                // æ£€æŸ¥æˆå‘˜æ˜¯å¦åœ¨å¤šä¸ªä¸åŒçš„å°ç»„ä¸­
                const assignedGroups = [];
                Object.keys(allGroups).forEach(groupKey => {
                    if (allGroups[groupKey] && Array.isArray(allGroups[groupKey])) {
                        const memberInGroup = allGroups[groupKey].find(m => m.uuid === member.uuid);
                        if (memberInGroup) {
                            assignedGroups.push(groupKey);
                        }
                    }
                });
                
                // åªæœ‰åœ¨å¤šä¸ªä¸åŒå°ç»„ä¸­æ‰ç®—é‡å¤
                if (assignedGroups.length > 1) {
                    member.assignedGroups = assignedGroups;
                    analysisResults.duplicateMembers.push(member);
                }
            });
            
            // è°ƒè¯•ä¿¡æ¯
            console.log('ğŸ” åˆ†æç»“æœ:', {
                unassignedMembers: analysisResults.unassignedMembers.length,
                duplicateMembers: analysisResults.duplicateMembers.length,
                totalSigninMembers: Object.keys(signinMembers).length
            });
            
            // æ›´æ–°ç»Ÿè®¡é¢æ¿
            document.getElementById('unassignedCount').textContent = analysisResults.unassignedMembers.length;
            
            // æ˜¾ç¤ºç»“æœ
            displayAnalysisResults();
            
            addLog('success', `åˆ†æå®Œæˆï¼å‘ç° ${analysisResults.unassignedMembers.length} åæœªåˆ†ç»„äººå‘˜ï¼Œ${analysisResults.duplicateMembers.length} åå¤šç»„é‡å¤äººå‘˜`);
        }
        
        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayAnalysisResults() {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.style.display = 'block';
            
            // æ˜¾ç¤ºæœªåˆ†ç»„äººå‘˜
            displayUnassignedMembers();
            
            // æ˜¾ç¤ºé‡å¤äººå‘˜
            displayDuplicateMembers();
            
            // æ˜¾ç¤ºå°ç»„ç»Ÿè®¡
            displayGroupSummary();
            
            // æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹
            document.getElementById('exportSection').style.display = 'block';
        }
        
        // æ˜¾ç¤ºæœªåˆ†ç»„äººå‘˜
        function displayUnassignedMembers() {
            const container = document.getElementById('unassignedMembersList');
            container.innerHTML = '';
            
            if (analysisResults.unassignedMembers.length === 0) {
                container.innerHTML = '<p style="color: #27ae60; text-align: center; padding: 20px;">âœ… æ‰€æœ‰ç­¾åˆ°äººå‘˜éƒ½å·²åˆ†é…åˆ°å°ç»„ä¸­</p>';
                return;
            }
            
            analysisResults.unassignedMembers.forEach(member => {
                const memberCard = document.createElement('div');
                memberCard.className = 'member-card unassigned';
                
                const groups = Array.from(member.groups).join(', ');
                const lastSignin = member.lastSignin ? new Date(member.lastSignin).toLocaleDateString('zh-CN') : 'æœªçŸ¥';
                
                memberCard.innerHTML = `
                    <div class="member-name">${member.name} ${member.nickname ? `(${member.nickname})` : ''}</div>
                    <div class="member-info">UUID: ${member.uuid}</div>
                    <div class="member-info">ç­¾åˆ°å°ç»„: ${groups}</div>
                    <div class="member-stats">ç­¾åˆ° ${member.signinCount} æ¬¡ï¼Œæœ€åç­¾åˆ°: ${lastSignin}</div>
                `;
                
                container.appendChild(memberCard);
            });
        }
        
        // æ˜¾ç¤ºé‡å¤äººå‘˜
        function displayDuplicateMembers() {
            const container = document.getElementById('duplicateMembersList');
            container.innerHTML = '';
            
            if (analysisResults.duplicateMembers.length === 0) {
                container.innerHTML = '<p style="color: #27ae60; text-align: center; padding: 20px;">âœ… æ²¡æœ‰å‘ç°å¤šç»„é‡å¤äººå‘˜</p>';
                return;
            }
            
            analysisResults.duplicateMembers.forEach(member => {
                const memberCard = document.createElement('div');
                memberCard.className = 'member-card duplicate';
                
                const groups = Array.from(member.groups).join(', ');
                const lastSignin = member.lastSignin ? new Date(member.lastSignin).toLocaleDateString('zh-CN') : 'æœªçŸ¥';
                
                memberCard.innerHTML = `
                    <div class="member-name">${member.name} ${member.nickname ? `(${member.nickname})` : ''}</div>
                    <div class="member-info">UUID: ${member.uuid}</div>
                    <div class="member-info">ç­¾åˆ°å°ç»„: ${groups}</div>
                    <div class="member-stats">ç­¾åˆ° ${member.signinCount} æ¬¡ï¼Œæœ€åç­¾åˆ°: ${lastSignin}</div>
                `;
                
                container.appendChild(memberCard);
            });
        }
        
        // æ˜¾ç¤ºå°ç»„ç»Ÿè®¡
        function displayGroupSummary() {
            const tbody = document.getElementById('groupSummaryBody');
            tbody.innerHTML = '';
            
            Object.keys(analysisResults.groupSigninStats).forEach(groupName => {
                const stats = analysisResults.groupSigninStats[groupName];
                const memberCount = stats.members.size;
                const avgSignins = memberCount > 0 ? (stats.signinCount / memberCount).toFixed(1) : '0';
                const lastSignin = stats.lastSignin ? new Date(stats.lastSignin).toLocaleDateString('zh-CN') : 'æ— ';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${groupName}</strong></td>
                    <td>${memberCount}</td>
                    <td>${stats.signinCount}</td>
                    <td>${avgSignins}</td>
                    <td>${lastSignin}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // å¯¼å‡ºåŠŸèƒ½
        function exportUnassignedMembers() {
            if (!analysisResults.unassignedMembers || analysisResults.unassignedMembers.length === 0) {
                alert('æ²¡æœ‰æœªåˆ†ç»„äººå‘˜å¯å¯¼å‡º');
                return;
            }
            
            const data = analysisResults.unassignedMembers.map(member => ({
                name: member.name,
                nickname: member.nickname,
                uuid: member.uuid,
                groups: Array.from(member.groups).join(', '),
                signinCount: member.signinCount,
                lastSignin: member.lastSignin ? new Date(member.lastSignin).toLocaleString('zh-CN') : 'æœªçŸ¥'
            }));
            
            const jsonData = JSON.stringify(data, null, 2);
            const csvData = convertToCSV(data);
            
            downloadFile('unassigned-members.json', jsonData, 'application/json');
            downloadFile('unassigned-members.csv', csvData, 'text/csv');
            
            addLog('success', `å·²å¯¼å‡º ${data.length} åæœªåˆ†ç»„äººå‘˜æ•°æ®`);
        }
        
        function exportDuplicateMembers() {
            if (!analysisResults.duplicateMembers || analysisResults.duplicateMembers.length === 0) {
                alert('æ²¡æœ‰é‡å¤äººå‘˜å¯å¯¼å‡º');
                return;
            }
            
            const data = analysisResults.duplicateMembers.map(member => ({
                name: member.name,
                nickname: member.nickname,
                uuid: member.uuid,
                groups: Array.from(member.groups).join(', '),
                signinCount: member.signinCount,
                lastSignin: member.lastSignin ? new Date(member.lastSignin).toLocaleString('zh-CN') : 'æœªçŸ¥'
            }));
            
            const jsonData = JSON.stringify(data, null, 2);
            const csvData = convertToCSV(data);
            
            downloadFile('duplicate-members.json', jsonData, 'application/json');
            downloadFile('duplicate-members.csv', csvData, 'text/csv');
            
            addLog('success', `å·²å¯¼å‡º ${data.length} åé‡å¤äººå‘˜æ•°æ®`);
        }
        
        function exportFullReport() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    totalSignins: allAttendanceRecords.length,
                    uniqueMembers: Object.keys(analysisResults.signinMembers || {}).length,
                    groupCount: Object.keys(allGroups).length,
                    unassignedMembers: analysisResults.unassignedMembers?.length || 0,
                    duplicateMembers: analysisResults.duplicateMembers?.length || 0
                },
                unassignedMembers: analysisResults.unassignedMembers || [],
                duplicateMembers: analysisResults.duplicateMembers || [],
                groupStats: analysisResults.groupSigninStats || {}
            };
            
            const jsonData = JSON.stringify(report, null, 2);
            downloadFile('member-distribution-report.json', jsonData, 'application/json');
            
            addLog('success', 'å·²å¯¼å‡ºå®Œæ•´æˆå‘˜åˆ†å¸ƒæŠ¥å‘Š');
        }
        
        function exportResults() {
            if (!analysisResults || Object.keys(analysisResults).length === 0) {
                alert('è¯·å…ˆè¿›è¡Œåˆ†æ');
                return;
            }
            
            exportFullReport();
        }
        
        // å¯¼å…¥åŠŸèƒ½
        let importedData = null;
        
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    console.log('æ–‡ä»¶å†…å®¹:', content);
                    
                    // å°è¯•è§£æJavaScriptæ–‡ä»¶
                    if (file.name.endsWith('.js')) {
                        // æå–JavaScriptå¯¹è±¡
                        const match = content.match(/const\s+\w+\s*=\s*(\[.*?\]);/s);
                        if (match) {
                            importedData = JSON.parse(match[1]);
                        } else {
                            // å°è¯•ç›´æ¥æ‰§è¡ŒJavaScriptä»£ç 
                            eval(content);
                            // å‡è®¾æ•°æ®å­˜å‚¨åœ¨æŸä¸ªå˜é‡ä¸­ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
                            if (typeof window.exportedMembers !== 'undefined') {
                                importedData = window.exportedMembers;
                            }
                        }
                    } else if (file.name.endsWith('.json')) {
                        importedData = JSON.parse(content);
                    }
                    
                    if (importedData && Array.isArray(importedData)) {
                        addLog('success', `æˆåŠŸåŠ è½½å¯¼å…¥æ•°æ®: ${importedData.length} ä¸ªæˆå‘˜`);
                        document.getElementById('importPreview').style.display = 'block';
                        previewImport();
                    } else {
                        addLog('error', 'æ— æ³•è§£æå¯¼å…¥æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                    }
                } catch (error) {
                    console.error('å¯¼å…¥æ–‡ä»¶å¤±è´¥:', error);
                    addLog('error', 'å¯¼å…¥æ–‡ä»¶å¤±è´¥: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function previewImport() {
            if (!importedData) {
                alert('è¯·å…ˆé€‰æ‹©å¯¼å…¥æ–‡ä»¶');
                return;
            }
            
            // è·å–å½“å‰æ•°æ®ç”¨äºè¯†åˆ«
            const localGroupsData = localStorage.getItem('msh_groups');
            const localGroupNamesData = localStorage.getItem('msh_groupNames');
            
            let previewContent = '';
            
            if (localGroupsData && localGroupNamesData) {
                const localGroups = JSON.parse(localGroupsData);
                const unassignedMembers = identifyUnassignedMembers(importedData, localGroups);
                
                previewContent = `
                    <div class="import-data">
                        <h5>å¯¼å…¥æ•°æ®é¢„è§ˆ</h5>
                        <p><strong>æ€»æˆå‘˜æ•°:</strong> ${importedData.length}</p>
                        <p><strong>è¯†åˆ«æœªåˆ†ç»„æˆå‘˜:</strong> ${unassignedMembers.length}</p>
                        <p><strong>å·²åˆ†ç»„æˆå‘˜:</strong> ${importedData.length - unassignedMembers.length}</p>
                        <hr>
                        <h6>æœªåˆ†ç»„æˆå‘˜ç¤ºä¾‹ (å‰5ä¸ª):</h6>
                        <pre>${JSON.stringify(unassignedMembers.slice(0, 5), null, 2)}</pre>
                        ${unassignedMembers.length > 5 ? '<p>... è¿˜æœ‰ ' + (unassignedMembers.length - 5) + ' ä¸ªæœªåˆ†ç»„æˆå‘˜</p>' : ''}
                    </div>
                `;
            } else {
                previewContent = `
                    <div class="import-data">
                        <h5>å¯¼å…¥æ•°æ®é¢„è§ˆ (${importedData.length} ä¸ªæˆå‘˜)</h5>
                        <p>âš ï¸ æ— æ³•è·å–å½“å‰å°ç»„æ•°æ®ï¼Œæ— æ³•è¿›è¡Œæ™ºèƒ½è¯†åˆ«</p>
                        <pre>${JSON.stringify(importedData.slice(0, 5), null, 2)}</pre>
                        ${importedData.length > 5 ? '<p>... è¿˜æœ‰ ' + (importedData.length - 5) + ' ä¸ªæˆå‘˜</p>' : ''}
                    </div>
                `;
            }
            
            const previewDiv = document.getElementById('importData');
            previewDiv.innerHTML = previewContent;
        }
        
        async function importToGroup0() {
            if (!importedData) {
                alert('è¯·å…ˆé€‰æ‹©å¯¼å…¥æ–‡ä»¶');
                return;
            }
            
            try {
                addLog('info', 'å¼€å§‹è¯†åˆ«å¹¶å¯¼å…¥æœªåˆ†ç»„æˆå‘˜...');
                
                // è·å–å½“å‰æ•°æ®
                const localGroupsData = localStorage.getItem('msh_groups');
                const localGroupNamesData = localStorage.getItem('msh_groupNames');
                
                if (!localGroupsData || !localGroupNamesData) {
                    throw new Error('æœ¬åœ°æ•°æ®æœªæ‰¾åˆ°');
                }
                
                const localGroups = JSON.parse(localGroupsData);
                const localGroupNames = JSON.parse(localGroupNamesData);
                
                // è¯†åˆ«æœªåˆ†ç»„æˆå‘˜
                const unassignedMembers = identifyUnassignedMembers(importedData, localGroups);
                
                if (unassignedMembers.length === 0) {
                    addLog('warning', 'æœªæ‰¾åˆ°æœªåˆ†ç»„æˆå‘˜ï¼Œæ‰€æœ‰æˆå‘˜éƒ½å·²åˆ†é…åˆ°å…·ä½“å°ç»„');
                    return;
                }
                
                addLog('info', `è¯†åˆ«åˆ° ${unassignedMembers.length} ä¸ªæœªåˆ†ç»„æˆå‘˜`);
                
                // ç¡®ä¿group0å­˜åœ¨
                if (!localGroups.group0) {
                    localGroups.group0 = [];
                    localGroupNames.group0 = 'æœªåˆ†ç»„';
                }
                
                // æ·»åŠ æœªåˆ†ç»„æˆå‘˜åˆ°group0
                const existingMembers = localGroups.group0 || [];
                const newMembers = unassignedMembers.map(member => ({
                    ...member,
                    group: 'group0',
                    groupName: 'æœªåˆ†ç»„',
                    importedAt: new Date().toISOString()
                }));
                
                localGroups.group0 = [...existingMembers, ...newMembers];
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('msh_groups', JSON.stringify(localGroups));
                localStorage.setItem('msh_groupNames', JSON.stringify(localGroupNames));
                
                // åŒæ­¥åˆ°Firebase
                if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                    const db = firebase.database();
                    await db.ref('groups/group0').set(localGroups.group0);
                    await db.ref('groupNames/group0').set('æœªåˆ†ç»„');
                    addLog('success', 'å·²åŒæ­¥åˆ°Firebase');
                }
                
                addLog('success', `æˆåŠŸå¯¼å…¥ ${newMembers.length} ä¸ªæœªåˆ†ç»„æˆå‘˜åˆ°æœªåˆ†ç»„`);
                
                // æ¸…ç©ºå¯¼å…¥æ•°æ®
                importedData = null;
                document.getElementById('importPreview').style.display = 'none';
                
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                addLog('error', 'å¯¼å…¥å¤±è´¥: ' + error.message);
            }
        }
        
        // åŒæ­¥æ§åˆ¶å‡½æ•°
        async function syncToFirebase() {
            try {
                addLog('info', 'å¼€å§‹åŒæ­¥æœ¬åœ°æ•°æ®åˆ°Firebase...');
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebaseæœªåˆå§‹åŒ–');
                }
                
                const db = firebase.database();
                
                // è·å–æœ¬åœ°æ•°æ®
                const localGroups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                const localGroupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
                const localAttendanceRecords = JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]');
                const localExcludedMembers = JSON.parse(localStorage.getItem('msh_excludedMembers') || '[]');
                
                // åŒæ­¥åˆ°Firebase
                await db.ref('groups').set(localGroups);
                await db.ref('groupNames').set(localGroupNames);
                await db.ref('attendanceRecords').set(localAttendanceRecords);
                await db.ref('excludedMembers').set(localExcludedMembers);
                
                addLog('success', 'âœ… æœ¬åœ°æ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°Firebase');
                addLog('info', `åŒæ­¥æ•°æ®: ${Object.keys(localGroups).length}ä¸ªå°ç»„, ${localAttendanceRecords.length}æ¡ç­¾åˆ°è®°å½•, ${localExcludedMembers.length}ä¸ªæ’é™¤äººå‘˜`);
                
            } catch (error) {
                console.error('åŒæ­¥åˆ°Firebaseå¤±è´¥:', error);
                addLog('error', 'åŒæ­¥åˆ°Firebaseå¤±è´¥: ' + error.message);
            }
        }
        
        async function syncFromFirebase() {
            try {
                addLog('info', 'å¼€å§‹ä»FirebaseåŒæ­¥æ•°æ®åˆ°æœ¬åœ°...');
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebaseæœªåˆå§‹åŒ–');
                }
                
                const db = firebase.database();
                
                // ä»Firebaseè·å–æ•°æ®
                const groupsSnapshot = await db.ref('groups').once('value');
                const groupNamesSnapshot = await db.ref('groupNames').once('value');
                const attendanceSnapshot = await db.ref('attendanceRecords').once('value');
                const excludedSnapshot = await db.ref('excludedMembers').once('value');
                
                const firebaseGroups = groupsSnapshot.val() || {};
                const firebaseGroupNames = groupNamesSnapshot.val() || {};
                const firebaseAttendanceRecords = attendanceSnapshot.val() || [];
                const firebaseExcludedMembers = excludedSnapshot.val() || [];
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('msh_groups', JSON.stringify(firebaseGroups));
                localStorage.setItem('msh_groupNames', JSON.stringify(firebaseGroupNames));
                localStorage.setItem('msh_attendanceRecords', JSON.stringify(firebaseAttendanceRecords));
                localStorage.setItem('msh_excludedMembers', JSON.stringify(firebaseExcludedMembers));
                
                addLog('success', 'âœ… Firebaseæ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°æœ¬åœ°');
                addLog('info', `åŒæ­¥æ•°æ®: ${Object.keys(firebaseGroups).length}ä¸ªå°ç»„, ${firebaseAttendanceRecords.length}æ¡ç­¾åˆ°è®°å½•, ${firebaseExcludedMembers.length}ä¸ªæ’é™¤äººå‘˜`);
                
                // é‡æ–°åŠ è½½æ•°æ®
                await loadAllData();
                
            } catch (error) {
                console.error('ä»FirebaseåŒæ­¥å¤±è´¥:', error);
                addLog('error', 'ä»FirebaseåŒæ­¥å¤±è´¥: ' + error.message);
            }
        }
        
        async function forceSyncAll() {
            try {
                addLog('info', 'å¼€å§‹å¼ºåˆ¶å…¨é‡åŒæ­¥...');
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebaseæœªåˆå§‹åŒ–');
                }
                
                const db = firebase.database();
                
                // è·å–æœ¬åœ°æ•°æ®
                const localGroups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                const localGroupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
                const localAttendanceRecords = JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]');
                const localExcludedMembers = JSON.parse(localStorage.getItem('msh_excludedMembers') || '[]');
                
                // è·å–Firebaseæ•°æ®
                const groupsSnapshot = await db.ref('groups').once('value');
                const groupNamesSnapshot = await db.ref('groupNames').once('value');
                const attendanceSnapshot = await db.ref('attendanceRecords').once('value');
                const excludedSnapshot = await db.ref('excludedMembers').once('value');
                
                const firebaseGroups = groupsSnapshot.val() || {};
                const firebaseGroupNames = groupNamesSnapshot.val() || {};
                const firebaseAttendanceRecords = attendanceSnapshot.val() || [];
                const firebaseExcludedMembers = excludedSnapshot.val() || [];
                
                // æ¯”è¾ƒæ•°æ®å¹¶é€‰æ‹©æœ€æ–°ç‰ˆæœ¬
                const mergedGroups = { ...firebaseGroups, ...localGroups };
                const mergedGroupNames = { ...firebaseGroupNames, ...localGroupNames };
                const mergedAttendanceRecords = [...firebaseAttendanceRecords, ...localAttendanceRecords];
                const mergedExcludedMembers = [...firebaseExcludedMembers, ...localExcludedMembers];
                
                // åŒæ­¥åˆ°Firebase
                await db.ref('groups').set(mergedGroups);
                await db.ref('groupNames').set(mergedGroupNames);
                await db.ref('attendanceRecords').set(mergedAttendanceRecords);
                await db.ref('excludedMembers').set(mergedExcludedMembers);
                
                // æ›´æ–°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('msh_groups', JSON.stringify(mergedGroups));
                localStorage.setItem('msh_groupNames', JSON.stringify(mergedGroupNames));
                localStorage.setItem('msh_attendanceRecords', JSON.stringify(mergedAttendanceRecords));
                localStorage.setItem('msh_excludedMembers', JSON.stringify(mergedExcludedMembers));
                
                addLog('success', 'âœ… å¼ºåˆ¶å…¨é‡åŒæ­¥å®Œæˆ');
                addLog('info', `åˆå¹¶æ•°æ®: ${Object.keys(mergedGroups).length}ä¸ªå°ç»„, ${mergedAttendanceRecords.length}æ¡ç­¾åˆ°è®°å½•, ${mergedExcludedMembers.length}ä¸ªæ’é™¤äººå‘˜`);
                
                // é‡æ–°åŠ è½½æ•°æ®
                await loadAllData();
                
            } catch (error) {
                console.error('å¼ºåˆ¶å…¨é‡åŒæ­¥å¤±è´¥:', error);
                addLog('error', 'å¼ºåˆ¶å…¨é‡åŒæ­¥å¤±è´¥: ' + error.message);
            }
        }
        
        async function checkSyncStatus() {
            try {
                addLog('info', 'æ£€æŸ¥åŒæ­¥çŠ¶æ€...');
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebaseæœªåˆå§‹åŒ–');
                }
                
                const db = firebase.database();
                
                // è·å–æœ¬åœ°æ•°æ®
                const localGroups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                const localGroupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
                const localAttendanceRecords = JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]');
                const localExcludedMembers = JSON.parse(localStorage.getItem('msh_excludedMembers') || '[]');
                
                // è·å–Firebaseæ•°æ®
                const groupsSnapshot = await db.ref('groups').once('value');
                const groupNamesSnapshot = await db.ref('groupNames').once('value');
                const attendanceSnapshot = await db.ref('attendanceRecords').once('value');
                const excludedSnapshot = await db.ref('excludedMembers').once('value');
                
                const firebaseGroups = groupsSnapshot.val() || {};
                const firebaseGroupNames = groupNamesSnapshot.val() || {};
                const firebaseAttendanceRecords = attendanceSnapshot.val() || [];
                const firebaseExcludedMembers = excludedSnapshot.val() || [];
                
                // æ¯”è¾ƒæ•°æ®
                const groupsMatch = JSON.stringify(localGroups) === JSON.stringify(firebaseGroups);
                const groupNamesMatch = JSON.stringify(localGroupNames) === JSON.stringify(firebaseGroupNames);
                const attendanceMatch = JSON.stringify(localAttendanceRecords) === JSON.stringify(firebaseAttendanceRecords);
                const excludedMatch = JSON.stringify(localExcludedMembers) === JSON.stringify(firebaseExcludedMembers);
                
                const statusData = {
                    timestamp: new Date().toLocaleString('zh-CN'),
                    local: {
                        groups: Object.keys(localGroups).length,
                        groupNames: Object.keys(localGroupNames).length,
                        attendanceRecords: localAttendanceRecords.length,
                        excludedMembers: localExcludedMembers.length
                    },
                    firebase: {
                        groups: Object.keys(firebaseGroups).length,
                        groupNames: Object.keys(firebaseGroupNames).length,
                        attendanceRecords: firebaseAttendanceRecords.length,
                        excludedMembers: firebaseExcludedMembers.length
                    },
                    syncStatus: {
                        groups: groupsMatch ? 'âœ… åŒæ­¥' : 'âŒ ä¸åŒæ­¥',
                        groupNames: groupNamesMatch ? 'âœ… åŒæ­¥' : 'âŒ ä¸åŒæ­¥',
                        attendanceRecords: attendanceMatch ? 'âœ… åŒæ­¥' : 'âŒ ä¸åŒæ­¥',
                        excludedMembers: excludedMatch ? 'âœ… åŒæ­¥' : 'âŒ ä¸åŒæ­¥'
                    }
                };
                
                // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
                document.getElementById('syncStatus').style.display = 'block';
                document.getElementById('syncStatusData').textContent = JSON.stringify(statusData, null, 2);
                
                addLog('success', 'âœ… åŒæ­¥çŠ¶æ€æ£€æŸ¥å®Œæˆ');
                addLog('info', `æœ¬åœ°: ${Object.keys(localGroups).length}ä¸ªå°ç»„, ${localAttendanceRecords.length}æ¡è®°å½•`);
                addLog('info', `Firebase: ${Object.keys(firebaseGroups).length}ä¸ªå°ç»„, ${firebaseAttendanceRecords.length}æ¡è®°å½•`);
                
            } catch (error) {
                console.error('æ£€æŸ¥åŒæ­¥çŠ¶æ€å¤±è´¥:', error);
                addLog('error', 'æ£€æŸ¥åŒæ­¥çŠ¶æ€å¤±è´¥: ' + error.message);
            }
        }
        
        function identifyUnassignedMembers(allMembers, currentGroups) {
            // è·å–æ‰€æœ‰å·²åˆ†ç»„æˆå‘˜çš„UUIDåˆ—è¡¨
            const assignedMemberUUIDs = new Set();
            Object.keys(currentGroups).forEach(groupKey => {
                if (currentGroups[groupKey] && Array.isArray(currentGroups[groupKey])) {
                    currentGroups[groupKey].forEach(member => {
                        if (member.uuid) {
                            assignedMemberUUIDs.add(member.uuid);
                        }
                    });
                }
            });
            
            console.log('ğŸ” å·²åˆ†ç»„æˆå‘˜UUIDæ•°é‡:', assignedMemberUUIDs.size);
            console.log('ğŸ” å¯¼å…¥æ•°æ®æ€»æˆå‘˜æ•°:', allMembers.length);
            
            // è¯†åˆ«æœªåˆ†ç»„æˆå‘˜ - ä¼˜å…ˆé€šè¿‡UUIDè¯†åˆ«
            const unassignedMembers = allMembers.filter(member => {
                // å¦‚æœæˆå‘˜æœ‰UUIDä¸”å·²å­˜åœ¨äºä»»ä½•å°ç»„ä¸­ï¼Œè·³è¿‡
                if (member.uuid && assignedMemberUUIDs.has(member.uuid)) {
                    console.log(`â­ï¸ è·³è¿‡å·²åˆ†ç»„æˆå‘˜: ${member.name} (UUID: ${member.uuid})`);
                    return false;
                }
                
                // å¦‚æœæˆå‘˜æœ‰UUIDä½†ä¸åœ¨å·²åˆ†é…åˆ—è¡¨ä¸­ï¼Œè®¤ä¸ºæ˜¯æœªåˆ†ç»„
                if (member.uuid && !assignedMemberUUIDs.has(member.uuid)) {
                    console.log(`âœ… è¯†åˆ«æœªåˆ†ç»„æˆå‘˜: ${member.name} (UUID: ${member.uuid})`);
                    return true;
                }
                
                // å¦‚æœæ²¡æœ‰UUIDï¼Œé€šè¿‡å§“ååŒ¹é…æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                if (!member.uuid) {
                    const isAssigned = Object.keys(currentGroups).some(groupKey => {
                        if (currentGroups[groupKey] && Array.isArray(currentGroups[groupKey])) {
                            return currentGroups[groupKey].some(existingMember => 
                                existingMember.name === member.name
                            );
                        }
                        return false;
                    });
                    
                    if (isAssigned) {
                        console.log(`â­ï¸ è·³è¿‡å·²åˆ†ç»„æˆå‘˜: ${member.name} (é€šè¿‡å§“ååŒ¹é…)`);
                        return false;
                    } else {
                        console.log(`âœ… è¯†åˆ«æœªåˆ†ç»„æˆå‘˜: ${member.name} (æ— UUIDï¼Œæœªåœ¨ç°æœ‰å°ç»„ä¸­æ‰¾åˆ°)`);
                        return true;
                    }
                }
                
                return false;
            });
            
            console.log(`ğŸ¯ æœ€ç»ˆè¯†åˆ«æœªåˆ†ç»„æˆå‘˜æ•°é‡: ${unassignedMembers.length}`);
            return unassignedMembers;
        }
        
        // å·¥å…·å‡½æ•°
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }
        
        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function clearResults() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('exportSection').style.display = 'none';
            analysisResults = {};
            
            // é‡ç½®ç»Ÿè®¡é¢æ¿
            document.getElementById('totalSignins').textContent = '-';
            document.getElementById('uniqueMembers').textContent = '-';
            document.getElementById('groupCount').textContent = '-';
            document.getElementById('unassignedCount').textContent = '-';
            
            addLog('info', 'ç»“æœå·²æ¸…ç©º');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            addLog('info', 'æˆå‘˜åˆ†å¸ƒæ£€æŸ¥å·¥å…·å·²å¯åŠ¨');
            addLog('info', 'è¯·ç‚¹å‡»"åŠ è½½æ‰€æœ‰æ•°æ®"å¼€å§‹åˆ†æ');
        });
    </script>
</body>
</html>





