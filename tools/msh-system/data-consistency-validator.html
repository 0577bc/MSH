<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®ä¸€è‡´æ€§éªŒè¯å·¥å…·</title>
    
    <!-- Firebase SDK v8 (å…¼å®¹ç‰ˆæœ¬) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- ç³»ç»Ÿä¾èµ–æ–‡ä»¶ -->
    <script src="../../src/smart-config-loader.js"></script>
    <script src="../../src/core/firebase-utils.js"></script>
  <script src="../../src/core/time-utils.js"></script>
  <script src="../../src/core/security-utils.js"></script>
  <script src="../../src/data/uuid-manager.js"></script>
  <script src="../../src/features/sunday-tracking-utils.js"></script>
  <script src="../../src/data/sync-managers.js"></script>
  <script src="../../src/utils.js"></script>
    <script src="../../src/new-data-manager.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }
        .content {
            padding: 30px;
        }
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .tool-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .tool-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .tool-card p {
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .tool-button {
            display: inline-block;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 500;
            transition: background 0.3s ease;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        .tool-button:hover {
            background: #0056b3;
        }
        .tool-button.success {
            background: #28a745;
        }
        .tool-button.success:hover {
            background: #1e7e34;
        }
        .tool-button.warning {
            background: #ffc107;
            color: #212529;
        }
        .tool-button.warning:hover {
            background: #e0a800;
        }
        .tool-button.danger {
            background: #dc3545;
        }
        .tool-button.danger:hover {
            background: #c82333;
        }
        .results {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #007bff;
        }
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 500;
        }
        .back-link:hover {
            background: #5a6268;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-danger { background: #dc3545; }
        .status-info { background: #17a2b8; }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }
        
        .tab-button:hover {
            color: #007bff;
            background: #f8f9fa;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* æ•°æ®æºå¯¹æ¯”æ ·å¼ */
        .data-sources {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .data-source-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .data-source-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .data-source-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .data-source-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .data-source-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .comparison-table-container {
            grid-column: 1 / -1;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .comparison-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .comparison-table tr:hover {
            background: #f8f9fa;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .stat-label {
            color: #718096;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .filter-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” æ•°æ®ä¸€è‡´æ€§éªŒè¯å·¥å…·</h1>
            <p>åŸºäºç°æœ‰ç³»ç»ŸåŠŸèƒ½çš„æ•°æ®éªŒè¯å’Œä¸€è‡´æ€§æ£€æŸ¥å·¥å…·</p>
        </div>
        <div class="content">
            <a href="index.html" class="back-link">â† è¿”å›MSHç³»ç»Ÿå·¥å…·</a>
            
            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('validation')">ğŸ” æ•°æ®éªŒè¯</button>
                    <button class="tab-button" onclick="switchTab('comparison')">ğŸ“Š æ•°æ®æºå¯¹æ¯”</button>
                </div>
                
                <!-- æ•°æ®éªŒè¯æ ‡ç­¾é¡µ -->
                <div id="validation-tab" class="tab-content active">
                    <h2>ğŸ“‹ éªŒè¯åŠŸèƒ½</h2>
                    <p>åŸºäºç³»ç»Ÿä¸­ç°æœ‰çš„æ•°æ®ä¸€è‡´æ€§éªŒè¯åŠŸèƒ½ï¼Œæä¾›ä»¥ä¸‹éªŒè¯æœåŠ¡ï¼š</p>
                    
                    <div class="tool-grid">
                <div class="tool-card">
                    <h3>ğŸ”„ æ•°æ®åŒæ­¥éªŒè¯</h3>
                    <p>éªŒè¯æœ¬åœ°æ•°æ®ä¸Firebaseè¿œç¨‹æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæ£€æµ‹æ•°æ®åŒæ­¥çŠ¶æ€ã€‚</p>
                    <button onclick="verifyDataSync()" class="tool-button">éªŒè¯åŒæ­¥çŠ¶æ€</button>
                </div>
                
                <div class="tool-card">
                    <h3>âš”ï¸ æ•°æ®å†²çªæ£€æµ‹</h3>
                    <p>æ£€æµ‹æœ¬åœ°æ•°æ®ä¸è¿œç¨‹æ•°æ®ä¹‹é—´çš„å†²çªï¼Œè¯†åˆ«æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚</p>
                    <button onclick="detectDataConflicts()" class="tool-button warning">æ£€æµ‹å†²çª</button>
                </div>
                
                <div class="tool-card">
                    <h3>ğŸ“Š ç­¾åˆ°è®°å½•éªŒè¯</h3>
                    <p>éªŒè¯ç­¾åˆ°è®°å½•çš„å®Œæ•´æ€§ï¼Œæ£€æŸ¥ç¼ºå¤±å­—æ®µå’Œæ ¼å¼é—®é¢˜ã€‚</p>
                    <button onclick="validateAttendanceRecords()" class="tool-button">éªŒè¯ç­¾åˆ°è®°å½•</button>
                </div>
                
                <div class="tool-card">
                    <h3>ğŸ‘¥ æˆå‘˜æ•°æ®éªŒè¯</h3>
                    <p>éªŒè¯æˆå‘˜æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ï¼Œæ£€æŸ¥UUIDå’Œç»„åˆ«ä¿¡æ¯ã€‚</p>
                    <button onclick="validateMemberData()" class="tool-button">éªŒè¯æˆå‘˜æ•°æ®</button>
                </div>
                
                <div class="tool-card">
                    <h3>ğŸ“ ç»„åˆ«æ•°æ®éªŒè¯</h3>
                    <p>éªŒè¯ç»„åˆ«æ•°æ®çš„å®Œæ•´æ€§å’Œå‘½åä¸€è‡´æ€§ã€‚</p>
                    <button onclick="validateGroupData()" class="tool-button">éªŒè¯ç»„åˆ«æ•°æ®</button>
                </div>
                
                <div class="tool-card">
                    <h3>ğŸ”§ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
                    <p>æ£€æŸ¥ç³»ç»Ÿæ•´ä½“çŠ¶æ€ï¼ŒéªŒè¯Firebaseè¿æ¥å’Œæ•°æ®åŠ è½½çŠ¶æ€ã€‚</p>
                    <button onclick="checkSystemStatus()" class="tool-button success">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
                </div>
                    </div>
                    
                    <div id="results" class="results" style="display: none;">
                        <h3>ğŸ“Š éªŒè¯ç»“æœ</h3>
                        <div id="resultsContent"></div>
                    </div>
                    
                    <div id="log" class="log" style="display: none;"></div>
                </div>
                
                <!-- æ•°æ®æºå¯¹æ¯”æ ‡ç­¾é¡µ -->
                <div id="comparison-tab" class="tab-content">
                    <h2>ğŸ“Š æ•°æ®æºå¯¹æ¯”</h2>
                    <p>æ ¸å¯¹Firebaseæ•°æ®åº“ã€MSHç³»ç»Ÿç¼“å­˜ã€å¤–éƒ¨è¡¨å•ä¸‰ä¸ªæ•°æ®æºçš„ä¿¡æ¯ä¸€è‡´æ€§</p>
                    <p style="font-size: 14px; opacity: 0.8; margin-top: 10px;">
                        <strong>æ³¨æ„ï¼š</strong>Firebaseå’ŒMSHæ•°æ®åº”è¯¥å®Œå…¨ä¸€è‡´ï¼ˆMSHä»Firebaseæ‹‰å–ï¼‰ï¼Œä¸»è¦æ ¸å¯¹ä¸å¤–éƒ¨è¡¨å•çš„ä¸€è‡´æ€§
                    </p>
                    
                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalMembers">0</div>
                            <div class="stat-label">æ€»æˆå‘˜æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="matchedData">0</div>
                            <div class="stat-label">æ•°æ®ä¸€è‡´</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="mismatchedData">0</div>
                            <div class="stat-label">æ•°æ®ä¸ä¸€è‡´</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="missingData">0</div>
                            <div class="stat-label">æ•°æ®ç¼ºå¤±</div>
                        </div>
                    </div>

                    <!-- ç­›é€‰æ§ä»¶ -->
                    <div class="filter-controls">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="groupFilter">å°ç»„ç­›é€‰</label>
                                <select id="groupFilter">
                                    <option value="">å…¨éƒ¨å°ç»„</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="nameSearch">å§“åæœç´¢</label>
                                <input type="text" id="nameSearch" placeholder="è¾“å…¥å§“åæˆ–èŠ±å">
                            </div>
                            <div class="filter-group">
                                <label for="statusFilter">çŠ¶æ€ç­›é€‰</label>
                                <select id="statusFilter">
                                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                    <option value="match">æ•°æ®ä¸€è‡´</option>
                                    <option value="mismatch">æ•°æ®ä¸ä¸€è‡´</option>
                                    <option value="missing">æ•°æ®ç¼ºå¤±</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <button class="tool-button" onclick="refreshComparisonData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                            </div>
                            <div class="filter-group">
                                <button class="tool-button success" onclick="exportComparisonReport()">ğŸ“Š å¯¼å‡ºæŠ¥å‘Š</button>
                            </div>
                        </div>
                    </div>

                    <!-- æ•°æ®æºå¯¹æ¯” -->
                    <div class="data-sources">
                        <!-- Firebaseæ•°æ® -->
                        <div class="data-source-card">
                            <div class="data-source-header">
                                <div class="data-source-title">ğŸ”¥ Firebaseæ•°æ®åº“</div>
                                <div class="data-source-subtitle">åŸå§‹æ•°æ®æº</div>
                            </div>
                            <div class="data-source-content" id="firebaseData">
                                <div class="loading">åŠ è½½ä¸­...</div>
                            </div>
                        </div>

                        <!-- MSHç³»ç»Ÿæ•°æ® -->
                        <div class="data-source-card">
                            <div class="data-source-header">
                                <div class="data-source-title">ğŸ“± MSHç³»ç»Ÿç¼“å­˜</div>
                                <div class="data-source-subtitle">æœ¬åœ°å­˜å‚¨çš„Firebaseæ•°æ®å‰¯æœ¬</div>
                            </div>
                            <div class="data-source-content" id="mshData">
                                <div class="loading">åŠ è½½ä¸­...</div>
                            </div>
                        </div>

                        <!-- å¤–éƒ¨è¡¨å•æ•°æ® -->
                        <div class="data-source-card">
                            <div class="data-source-header">
                                <div class="data-source-title">ğŸ“ å¤–éƒ¨è¡¨å•</div>
                                <div class="data-source-subtitle">æ¥æ”¶åˆ°çš„ä¿¡æ¯</div>
                            </div>
                            <div class="data-source-content" id="externalFormData">
                                <div class="loading">åŠ è½½ä¸­...</div>
                            </div>
                        </div>
                    </div>

                    <!-- è¯¦ç»†å¯¹æ¯”è¡¨æ ¼ -->
                    <div class="data-source-card comparison-table-container">
                        <div class="data-source-header">
                            <div class="data-source-title">ğŸ“Š è¯¦ç»†å¯¹æ¯”è¡¨æ ¼</div>
                            <div class="data-source-subtitle">ä¸‰ä¸ªæ•°æ®æºçš„è¯¦ç»†å¯¹æ¯”</div>
                        </div>
                        <div class="data-source-content">
                            <table class="comparison-table" id="comparisonTable">
                                <thead>
                                    <tr>
                                        <th>æˆå‘˜å§“å</th>
                                        <th>å°ç»„åç§°</th>
                                        <th>UUID</th>
                                        <th>èŠ±å</th>
                                        <th>Firebase</th>
                                        <th>MSHç³»ç»Ÿ</th>
                                        <th>å¤–éƒ¨è¡¨å•</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody id="comparisonTableBody">
                                    <tr>
                                        <td colspan="8" class="loading">åŠ è½½ä¸­...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let logContent = '';
        let comparisonData = {
            firebase: {},
            msh: {},
            externalForm: {}
        };
        
        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„æŒ‰é’®
            event.target.classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ°æ•°æ®æºå¯¹æ¯”æ ‡ç­¾é¡µï¼ŒåŠ è½½æ•°æ®
            if (tabName === 'comparison') {
                loadComparisonData();
            }
        }
        
        // åŠ è½½æ•°æ®æºå¯¹æ¯”æ•°æ®
        async function loadComparisonData() {
            try {
                log('å¼€å§‹åŠ è½½æ•°æ®æºå¯¹æ¯”æ•°æ®...');
                
                // åŠ è½½Firebaseæ•°æ®
                const db = firebase.database();
                const firebaseGroups = await db.ref('groups').once('value').then(snapshot => snapshot.val() || {});
                const firebaseGroupNames = await db.ref('groupNames').once('value').then(snapshot => snapshot.val() || {});
                const firebaseAttendanceRecords = await db.ref('attendanceRecords').once('value').then(snapshot => {
                    const data = snapshot.val();
                    return Array.isArray(data) ? data : (data ? Object.values(data) : []);
                });
                
                comparisonData.firebase = {
                    groups: firebaseGroups,
                    groupNames: firebaseGroupNames,
                    attendanceRecords: firebaseAttendanceRecords
                };
                
                // åŠ è½½MSHç³»ç»Ÿæ•°æ®
                comparisonData.msh = {
                    groups: JSON.parse(localStorage.getItem('msh_groups') || '{}'),
                    groupNames: JSON.parse(localStorage.getItem('msh_groupNames') || '{}'),
                    attendanceRecords: JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]')
                };
                
                // åŠ è½½å¤–éƒ¨è¡¨å•æ•°æ®ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”è¯¥ä»APIè·å–ï¼‰
                comparisonData.externalForm = {
                    groups: {},
                    groupNames: {},
                    attendanceRecords: []
                };
                
                // æ›´æ–°UI
                updateComparisonUI();
                log('æ•°æ®æºå¯¹æ¯”æ•°æ®åŠ è½½å®Œæˆ', 'success');
                
            } catch (error) {
                log(`åŠ è½½æ•°æ®æºå¯¹æ¯”æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ›´æ–°æ•°æ®æºå¯¹æ¯”UI
        function updateComparisonUI() {
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            const totalMembers = Object.values(comparisonData.firebase.groups).reduce((total, group) => {
                return total + (Array.isArray(group) ? group.length : 0);
            }, 0);
            
            document.getElementById('totalMembers').textContent = totalMembers;
            
            // æ›´æ–°æ•°æ®æºæ˜¾ç¤º
            updateDataSourceDisplay('firebaseData', comparisonData.firebase);
            updateDataSourceDisplay('mshData', comparisonData.msh);
            updateDataSourceDisplay('externalFormData', comparisonData.externalForm);
            
            // æ›´æ–°å¯¹æ¯”è¡¨æ ¼
            updateComparisonTable();
        }
        
        // æ›´æ–°æ•°æ®æºæ˜¾ç¤º
        function updateDataSourceDisplay(elementId, data) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const groupsCount = Object.keys(data.groups).length;
            const membersCount = Object.values(data.groups).reduce((total, group) => {
                return total + (Array.isArray(group) ? group.length : 0);
            }, 0);
            const recordsCount = data.attendanceRecords.length;
            
            element.innerHTML = `
                <div style="font-size: 14px;">
                    <div style="margin-bottom: 10px;">
                        <strong>å°ç»„æ•°é‡:</strong> ${groupsCount}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>æˆå‘˜æ•°é‡:</strong> ${membersCount}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>ç­¾åˆ°è®°å½•:</strong> ${recordsCount}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>æœ€åæ›´æ–°:</strong> ${new Date().toLocaleString()}
                    </div>
                </div>
            `;
        }
        
        // æ›´æ–°å¯¹æ¯”è¡¨æ ¼
        function updateComparisonTable() {
            const tbody = document.getElementById('comparisonTableBody');
            if (!tbody) return;
            
            // æ”¶é›†æ‰€æœ‰æˆå‘˜ä¿¡æ¯
            const allMembers = new Map();
            
            // ä»Firebaseæ•°æ®æ”¶é›†æˆå‘˜
            Object.entries(comparisonData.firebase.groups).forEach(([groupKey, group]) => {
                if (Array.isArray(group)) {
                    group.forEach(member => {
                        const key = member.name || member.èŠ±å;
                        if (key) {
                            if (!allMembers.has(key)) {
                                allMembers.set(key, {
                                    name: key,
                                    group: groupKey,
                                    uuid: member.uuid,
                                    nickname: member.èŠ±å || member.nickname,
                                    firebase: true,
                                    msh: false,
                                    externalForm: false
                                });
                            } else {
                                allMembers.get(key).firebase = true;
                            }
                        }
                    });
                }
            });
            
            // ä»MSHæ•°æ®æ”¶é›†æˆå‘˜
            Object.entries(comparisonData.msh.groups).forEach(([groupKey, group]) => {
                if (Array.isArray(group)) {
                    group.forEach(member => {
                        const key = member.name || member.èŠ±å;
                        if (key) {
                            if (!allMembers.has(key)) {
                                allMembers.set(key, {
                                    name: key,
                                    group: groupKey,
                                    uuid: member.uuid,
                                    nickname: member.èŠ±å || member.nickname,
                                    firebase: false,
                                    msh: true,
                                    externalForm: false
                                });
                            } else {
                                allMembers.get(key).msh = true;
                            }
                        }
                    });
                }
            });
            
            // ç”Ÿæˆè¡¨æ ¼è¡Œ
            let html = '';
            allMembers.forEach(member => {
                const status = getMemberStatus(member);
                const statusClass = getStatusClass(status);
                
                html += `
                    <tr>
                        <td>${member.name}</td>
                        <td>${member.group}</td>
                        <td>${member.uuid || 'N/A'}</td>
                        <td>${member.nickname || 'N/A'}</td>
                        <td>${member.firebase ? 'âœ…' : 'âŒ'}</td>
                        <td>${member.msh ? 'âœ…' : 'âŒ'}</td>
                        <td>${member.externalForm ? 'âœ…' : 'âŒ'}</td>
                        <td><span class="${statusClass}">${status}</span></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="8">æš‚æ— æ•°æ®</td></tr>';
        }
        
        // è·å–æˆå‘˜çŠ¶æ€
        function getMemberStatus(member) {
            if (member.firebase && member.msh && member.externalForm) {
                return 'æ•°æ®ä¸€è‡´';
            } else if (member.firebase && member.msh) {
                return 'MSHä¸€è‡´';
            } else if (member.firebase) {
                return 'ä»…Firebase';
            } else if (member.msh) {
                return 'ä»…MSH';
            } else {
                return 'æ•°æ®ç¼ºå¤±';
            }
        }
        
        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            switch (status) {
                case 'æ•°æ®ä¸€è‡´': return 'status-success';
                case 'MSHä¸€è‡´': return 'status-info';
                case 'ä»…Firebase': return 'status-warning';
                case 'ä»…MSH': return 'status-warning';
                case 'æ•°æ®ç¼ºå¤±': return 'status-danger';
                default: return '';
            }
        }
        
        // åˆ·æ–°æ•°æ®æºå¯¹æ¯”æ•°æ®
        function refreshComparisonData() {
            loadComparisonData();
        }
        
        // å¯¼å‡ºæ•°æ®æºå¯¹æ¯”æŠ¥å‘Š
        function exportComparisonReport() {
            const report = {
                timestamp: new Date().toISOString(),
                data: comparisonData,
                summary: {
                    totalMembers: document.getElementById('totalMembers').textContent,
                    matchedData: document.getElementById('matchedData').textContent,
                    mismatchedData: document.getElementById('mismatchedData').textContent,
                    missingData: document.getElementById('missingData').textContent
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `data-comparison-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            const logMessage = `[${timestamp}] ${prefix} ${message}\n`;
            logContent += logMessage;
            
            const logElement = document.getElementById('log');
            logElement.textContent = logContent;
            logElement.style.display = 'block';
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(message);
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResults(title, content) {
            const resultsElement = document.getElementById('results');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsContent.innerHTML = `<h4>${title}</h4>${content}`;
            resultsElement.style.display = 'block';
        }
        
        // éªŒè¯æ•°æ®åŒæ­¥çŠ¶æ€
        async function verifyDataSync() {
            log('å¼€å§‹éªŒè¯æ•°æ®åŒæ­¥çŠ¶æ€...');
            
            try {
                if (!window.newDataManager) {
                    log('NewDataManageræœªåˆå§‹åŒ–ï¼Œæ­£åœ¨åˆå§‹åŒ–...', 'warning');
                    await initializeNewDataManager();
                }
                
                const localData = {
                    groups: JSON.parse(localStorage.getItem('msh_groups') || '{}'),
                    attendanceRecords: JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]'),
                    groupNames: JSON.parse(localStorage.getItem('msh_groupNames') || '[]')
                };
                
                log('æ­£åœ¨è·å–è¿œç¨‹æ•°æ®...');
                const db = firebase.database();
                const remoteData = {};
                
                // è·å–è¿œç¨‹æ•°æ®
                for (const [key, value] of Object.entries(localData)) {
                    const snapshot = await db.ref(key).once('value');
                    remoteData[key] = snapshot.val();
                }
                
                // ä½¿ç”¨NewDataManagerçš„éªŒè¯åŠŸèƒ½
                const syncResults = {};
                for (const dataType of Object.keys(localData)) {
                    const isValid = window.newDataManager.verifyDataSync(
                        localData[dataType], 
                        remoteData[dataType], 
                        dataType
                    );
                    syncResults[dataType] = isValid;
                    log(`${dataType}æ•°æ®åŒæ­¥éªŒè¯: ${isValid ? 'é€šè¿‡' : 'å¤±è´¥'}`, isValid ? 'success' : 'error');
                }
                
                // æ˜¾ç¤ºç»“æœ
                let resultHtml = '<div class="tool-grid">';
                for (const [dataType, isValid] of Object.entries(syncResults)) {
                    const statusClass = isValid ? 'status-success' : 'status-danger';
                    const statusText = isValid ? 'åŒæ­¥æ­£å¸¸' : 'åŒæ­¥å¼‚å¸¸';
                    resultHtml += `
                        <div class="tool-card">
                            <h4>${dataType}</h4>
                            <p><span class="status-indicator ${statusClass}"></span>${statusText}</p>
                        </div>
                    `;
                }
                resultHtml += '</div>';
                
                showResults('æ•°æ®åŒæ­¥éªŒè¯ç»“æœ', resultHtml);
                log('æ•°æ®åŒæ­¥éªŒè¯å®Œæˆ', 'success');
                
            } catch (error) {
                log(`æ•°æ®åŒæ­¥éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ£€æµ‹æ•°æ®å†²çª
        async function detectDataConflicts() {
            log('å¼€å§‹æ£€æµ‹æ•°æ®å†²çª...');
            
            try {
                const localData = {
                    attendanceRecords: JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]')
                };
                
                const db = firebase.database();
                const remoteSnapshot = await db.ref('attendanceRecords').once('value');
                const remoteData = remoteSnapshot.val();
                
                // ä½¿ç”¨utils.jsä¸­çš„å†²çªæ£€æµ‹åŠŸèƒ½
                const conflicts = DataConflictResolver.detectConflicts(
                    localData.attendanceRecords, 
                    remoteData, 
                    'attendanceRecords'
                );
                
                if (conflicts.length === 0) {
                    log('æœªå‘ç°æ•°æ®å†²çª', 'success');
                    showResults('æ•°æ®å†²çªæ£€æµ‹ç»“æœ', '<p>âœ… æœªå‘ç°æ•°æ®å†²çªï¼Œæ•°æ®ä¸€è‡´æ€§è‰¯å¥½ã€‚</p>');
                } else {
                    log(`å‘ç° ${conflicts.length} ä¸ªæ•°æ®å†²çª`, 'warning');
                    let conflictHtml = `<p>âš ï¸ å‘ç° ${conflicts.length} ä¸ªæ•°æ®å†²çªï¼š</p><ul>`;
                    conflicts.forEach((conflict, index) => {
                        conflictHtml += `<li>å†²çª ${index + 1}: ${conflict.description}</li>`;
                    });
                    conflictHtml += '</ul>';
                    showResults('æ•°æ®å†²çªæ£€æµ‹ç»“æœ', conflictHtml);
                }
                
            } catch (error) {
                log(`æ•°æ®å†²çªæ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // éªŒè¯ç­¾åˆ°è®°å½•
        async function validateAttendanceRecords() {
            log('å¼€å§‹éªŒè¯ç­¾åˆ°è®°å½•...');
            
            try {
                const attendanceRecords = JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]');
                const issues = [];
                
                attendanceRecords.forEach((record, index) => {
                    if (!record.name) issues.push(`è®°å½• ${index + 1}: ç¼ºå°‘å§“å`);
                    if (!record.group) issues.push(`è®°å½• ${index + 1}: ç¼ºå°‘ç»„åˆ«`);
                    if (!record.time) issues.push(`è®°å½• ${index + 1}: ç¼ºå°‘æ—¶é—´`);
                    if (!record.uuid && !record.id) issues.push(`è®°å½• ${index + 1}: ç¼ºå°‘UUIDæˆ–ID`);
                });
                
                if (issues.length === 0) {
                    log('ç­¾åˆ°è®°å½•éªŒè¯é€šè¿‡', 'success');
                    showResults('ç­¾åˆ°è®°å½•éªŒè¯ç»“æœ', `<p>âœ… æ‰€æœ‰ç­¾åˆ°è®°å½•éªŒè¯é€šè¿‡ï¼Œå…± ${attendanceRecords.length} æ¡è®°å½•ã€‚</p>`);
                } else {
                    log(`å‘ç° ${issues.length} ä¸ªç­¾åˆ°è®°å½•é—®é¢˜`, 'warning');
                    let issuesHtml = `<p>âš ï¸ å‘ç° ${issues.length} ä¸ªé—®é¢˜ï¼š</p><ul>`;
                    issues.forEach(issue => {
                        issuesHtml += `<li>${issue}</li>`;
                    });
                    issuesHtml += '</ul>';
                    showResults('ç­¾åˆ°è®°å½•éªŒè¯ç»“æœ', issuesHtml);
                }
                
            } catch (error) {
                log(`ç­¾åˆ°è®°å½•éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // éªŒè¯æˆå‘˜æ•°æ®
        async function validateMemberData() {
            log('å¼€å§‹éªŒè¯æˆå‘˜æ•°æ®...');
            
            try {
                const groups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                const issues = [];
                let totalMembers = 0;
                
                for (const [groupName, groupData] of Object.entries(groups)) {
                    if (groupData.members && Array.isArray(groupData.members)) {
                        totalMembers += groupData.members.length;
                        groupData.members.forEach((member, index) => {
                            if (!member.name) issues.push(`${groupName}ç»„ æˆå‘˜ ${index + 1}: ç¼ºå°‘å§“å`);
                            if (!member.uuid && !member.id) issues.push(`${groupName}ç»„ æˆå‘˜ ${index + 1}: ç¼ºå°‘UUIDæˆ–ID`);
                        });
                    }
                }
                
                if (issues.length === 0) {
                    log('æˆå‘˜æ•°æ®éªŒè¯é€šè¿‡', 'success');
                    showResults('æˆå‘˜æ•°æ®éªŒè¯ç»“æœ', `<p>âœ… æ‰€æœ‰æˆå‘˜æ•°æ®éªŒè¯é€šè¿‡ï¼Œå…± ${totalMembers} ä¸ªæˆå‘˜ã€‚</p>`);
                } else {
                    log(`å‘ç° ${issues.length} ä¸ªæˆå‘˜æ•°æ®é—®é¢˜`, 'warning');
                    let issuesHtml = `<p>âš ï¸ å‘ç° ${issues.length} ä¸ªé—®é¢˜ï¼š</p><ul>`;
                    issues.forEach(issue => {
                        issuesHtml += `<li>${issue}</li>`;
                    });
                    issuesHtml += '</ul>';
                    showResults('æˆå‘˜æ•°æ®éªŒè¯ç»“æœ', issuesHtml);
                }
                
            } catch (error) {
                log(`æˆå‘˜æ•°æ®éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // éªŒè¯ç»„åˆ«æ•°æ®
        async function validateGroupData() {
            log('å¼€å§‹éªŒè¯ç»„åˆ«æ•°æ®...');
            
            try {
                const groups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                const groupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '[]');
                const issues = [];
                
                // æ£€æŸ¥ç»„åˆ«åç§°ä¸€è‡´æ€§
                const groupKeys = Object.keys(groups);
                groupNames.forEach(name => {
                    if (!groupKeys.includes(name)) {
                        issues.push(`ç»„åˆ«åç§° "${name}" åœ¨groupsä¸­ä¸å­˜åœ¨`);
                    }
                });
                
                groupKeys.forEach(key => {
                    if (!groupNames.includes(key)) {
                        issues.push(`ç»„åˆ« "${key}" åœ¨groupNamesä¸­ä¸å­˜åœ¨`);
                    }
                });
                
                if (issues.length === 0) {
                    log('ç»„åˆ«æ•°æ®éªŒè¯é€šè¿‡', 'success');
                    showResults('ç»„åˆ«æ•°æ®éªŒè¯ç»“æœ', `<p>âœ… æ‰€æœ‰ç»„åˆ«æ•°æ®éªŒè¯é€šè¿‡ï¼Œå…± ${groupKeys.length} ä¸ªç»„åˆ«ã€‚</p>`);
                } else {
                    log(`å‘ç° ${issues.length} ä¸ªç»„åˆ«æ•°æ®é—®é¢˜`, 'warning');
                    let issuesHtml = `<p>âš ï¸ å‘ç° ${issues.length} ä¸ªé—®é¢˜ï¼š</p><ul>`;
                    issues.forEach(issue => {
                        issuesHtml += `<li>${issue}</li>`;
                    });
                    issuesHtml += '</ul>';
                    showResults('ç»„åˆ«æ•°æ®éªŒè¯ç»“æœ', issuesHtml);
                }
                
            } catch (error) {
                log(`ç»„åˆ«æ•°æ®éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            log('å¼€å§‹æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...');
            
            try {
                const status = {
                    firebase: !!window.db,
                    newDataManager: !!window.newDataManager,
                    localData: {
                        groups: !!localStorage.getItem('msh_groups'),
                        attendanceRecords: !!localStorage.getItem('msh_attendanceRecords'),
                        groupNames: !!localStorage.getItem('msh_groupNames')
                    }
                };
                
                let statusHtml = '<div class="tool-grid">';
                
                // FirebaseçŠ¶æ€
                const firebaseStatus = status.firebase ? 'success' : 'danger';
                const firebaseText = status.firebase ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
                statusHtml += `
                    <div class="tool-card">
                        <h4>Firebaseè¿æ¥</h4>
                        <p><span class="status-indicator status-${firebaseStatus}"></span>${firebaseText}</p>
                    </div>
                `;
                
                // NewDataManagerçŠ¶æ€
                const managerStatus = status.newDataManager ? 'success' : 'warning';
                const managerText = status.newDataManager ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–';
                statusHtml += `
                    <div class="tool-card">
                        <h4>NewDataManager</h4>
                        <p><span class="status-indicator status-${managerStatus}"></span>${managerText}</p>
                    </div>
                `;
                
                // æœ¬åœ°æ•°æ®çŠ¶æ€
                for (const [dataType, exists] of Object.entries(status.localData)) {
                    const dataStatus = exists ? 'success' : 'warning';
                    const dataText = exists ? 'å·²ç¼“å­˜' : 'æœªç¼“å­˜';
                    statusHtml += `
                        <div class="tool-card">
                            <h4>${dataType}</h4>
                            <p><span class="status-indicator status-${dataStatus}"></span>${dataText}</p>
                        </div>
                    `;
                }
                
                statusHtml += '</div>';
                
                showResults('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ç»“æœ', statusHtml);
                log('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆ', 'success');
                
            } catch (error) {
                log(`ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // åˆå§‹åŒ–NewDataManager
        async function initializeNewDataManager() {
            if (typeof NewDataManager !== 'undefined') {
                window.newDataManager = new NewDataManager();
                await window.newDataManager.initialize();
                log('NewDataManageråˆå§‹åŒ–å®Œæˆ', 'success');
            } else {
                log('NewDataManagerç±»æœªæ‰¾åˆ°', 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', async () => {
            log('æ•°æ®ä¸€è‡´æ€§éªŒè¯å·¥å…·å·²åŠ è½½');
            
            // ç­‰å¾…Firebase SDKåŠ è½½
            await new Promise(resolve => {
                const checkFirebase = () => {
                    if (typeof firebase !== 'undefined') {
                        log('Firebase SDKå·²åŠ è½½', 'success');
                        resolve(true);
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
            
            // åˆå§‹åŒ–Firebase
            if (window.firebaseConfig) {
                firebase.initializeApp(window.firebaseConfig);
                window.db = firebase.database();
                log('Firebaseå·²åˆå§‹åŒ–', 'success');
            } else {
                log('Firebaseé…ç½®æœªæ‰¾åˆ°', 'error');
            }
        });
    </script>
</body>
</html>


