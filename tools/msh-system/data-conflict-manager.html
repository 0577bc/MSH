<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSH数据冲突管理系统</title>
    <link rel="stylesheet" href="../../src/style.css">
    <style>
        .conflict-manager-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .conflict-manager-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .conflict-manager-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .conflict-manager-header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .conflict-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .conflict-section h2 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .conflict-item {
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #f7fafc;
        }

        .conflict-item.uuid-conflict {
            border-color: #f56565;
            background: #fed7d7;
        }

        .conflict-item.group-conflict {
            border-color: #f6ad55;
            background: #fef5e7;
        }

        .conflict-item.data-mismatch {
            border-color: #ed8936;
            background: #fef5e7;
        }

        .conflict-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .conflict-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
        }

        .conflict-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .conflict-type.uuid {
            background: #fed7d7;
            color: #c53030;
        }

        .conflict-type.group {
            background: #fef5e7;
            color: #d68910;
        }

        .conflict-type.data {
            background: #fef5e7;
            color: #d68910;
        }

        .conflict-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .data-source {
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            background: white;
        }

        .data-source h4 {
            color: #2d3748;
            font-size: 14px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-source-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .data-source-item strong {
            color: #4a5568;
        }

        .data-source-item span {
            color: #718096;
        }

        .conflict-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-warning {
            background: #f6ad55;
            color: white;
        }

        .btn-warning:hover {
            background: #ed8936;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .conflict-resolution-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .conflict-resolution-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .conflict-resolution-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .conflict-resolution-header h3 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .conflict-resolution-body {
            margin-bottom: 20px;
        }

        .conflict-resolution-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* 进度对话框样式 */
        .progress-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .progress-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }
        
        .progress-content h3 {
            margin-bottom: 20px;
            color: #2d3748;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            color: #666;
            font-size: 14px;
        }
        
        /* 冲突详情样式 */
        .conflict-details {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .conflict-detail-item {
            color: #495057;
        }
        
        .conflict-detail-item strong {
            color: #212529;
            font-weight: 600;
        }
        
        .conflict-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 12px;
            background: white;
            transition: box-shadow 0.2s ease;
        }
        
        .conflict-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .conflict-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .conflict-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .conflict-type.high {
            background: #f8d7da;
            color: #721c24;
        }
        
        .conflict-type.medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .conflict-type.low {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .conflict-description {
            flex: 1;
            font-weight: 500;
            color: #495057;
        }
        
        .conflict-actions {
            padding: 12px 16px;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .resolution-option {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .resolution-option:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .resolution-option.selected {
            border-color: #667eea;
            background: #e6f3ff;
        }

        .resolution-option h4 {
            color: #2d3748;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .resolution-option p {
            color: #718096;
            font-size: 14px;
            margin: 0;
        }
        
        /* 标签页样式 */
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-button:hover {
            color: #667eea;
            background: #f7fafc;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 隔离管理样式 */
        .quarantine-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .quarantine-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .quarantine-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .quarantine-list {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .quarantine-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quarantine-item:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }
        
        .quarantine-item.selected {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .quarantine-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .quarantine-item-title {
            font-weight: bold;
            color: #333;
        }
        
        .quarantine-item-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .quarantine-item-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .quarantine-item-status.resolved {
            background: #d4edda;
            color: #155724;
        }
        
        .quarantine-item-details {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }
        
        .quarantine-details {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .quarantine-details h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .quarantine-details-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* 删除管理样式 */
        .delete-section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #f56565;
        }
        
        .delete-section h3 {
            margin: 0 0 20px 0;
            color: #f56565;
            font-size: 1.4em;
            display: flex;
            align-items: center;
        }
        
        .delete-section h3 .icon {
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .delete-button {
            background: #f56565;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .delete-button:hover {
            background: #e53e3e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
        }
        
        .delete-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .log-section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
        }
        
        .log-section h3 {
            margin: 0 0 15px 0;
            color: #4a5568;
        }
        
        .log-container {
            background: #2d3748;
            color: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.info {
            color: #63b3ed;
        }
        
        .log-entry.success {
            color: #68d391;
        }
        
        .log-entry.warning {
            color: #f6e05e;
        }
        
        .log-entry.error {
            color: #fc8181;
        }
        
        .clear-log {
            margin-top: 10px;
        }
        
        /* 记录项样式 */
        .record-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .record-item strong {
            color: #495057;
            font-weight: 600;
        }
        
        .no-conflicts {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }
        
        .no-conflicts h4 {
            margin: 0 0 10px 0;
            color: #155724;
        }
        
        .no-conflicts p {
            margin: 0;
            opacity: 0.8;
        }
        
        .warning-banner {
            background: #fef5e7;
            border: 1px solid #f6ad55;
            color: #c05621;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }
        
        .warning-banner .icon {
            font-size: 1.5em;
            margin-right: 10px;
        }
        
        .multi-select-controls {
            margin-top: 10px;
        }
        
        .select-all-btn {
            margin-right: 10px;
        }
        
        /* 返回按钮样式 */
        .back-button-container {
            margin-bottom: 20px;
        }
        
        .back-button {
            background: #4a5568;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-button:hover {
            background: #2d3748;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .back-button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="conflict-manager-container">
        <!-- 返回按钮 -->
        <div class="back-button-container">
            <button class="back-button" onclick="goBack()">
                ← 返回管理页面
            </button>
        </div>
        
        <!-- 页面头部 -->
        <div class="conflict-manager-header">
            <h1>⚔️ MSH数据冲突管理系统</h1>
            <p>检测和解决Firebase、MSH系统、外部表单之间的数据冲突</p>
        </div>
        
        <!-- 标签页导航 -->
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('conflict')">⚔️ 冲突管理</button>
                <button class="tab-button" onclick="switchTab('delete')">🗑️ 删除管理</button>
                <button class="tab-button" onclick="switchTab('quarantine')">🛡️ 冲突隔离</button>
            </div>
            
            <!-- 冲突管理标签页 -->
            <div id="conflict-tab" class="tab-content active">

        <!-- 统计信息 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalConflicts">0</div>
                <div class="stat-label">总冲突数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uuidConflicts">0</div>
                <div class="stat-label">UUID冲突</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="groupConflicts">0</div>
                <div class="stat-label">小组冲突</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="dataConflicts">0</div>
                <div class="stat-label">数据冲突</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="resolvedConflicts">0</div>
                <div class="stat-label">已解决</div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="conflict-section">
            <h2>🔍 冲突检测操作</h2>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="detectConflicts()">🔍 检测冲突</button>
                <button class="btn btn-success" onclick="resolveAllConflicts()">✅ 解决所有冲突</button>
                <button class="btn btn-info" onclick="compareAttendanceRecords()">📋 对比签到记录</button>
                <button class="btn btn-info" onclick="compareMemberRecords()">👥 对比成员信息</button>
                <button class="btn btn-warning" onclick="clearExternalFormData()">🗑️ 清空外部表单数据</button>
                <button class="btn btn-primary" onclick="exportConflictReport()">📊 导出冲突报告</button>
            </div>
        </div>

        <!-- 冲突列表 -->
        <div class="conflict-section">
            <h2>⚠️ 检测到的冲突</h2>
            <div id="conflictResults">
                <div class="loading">点击"检测冲突"开始检测...</div>
            </div>
        </div>

            </div>
            
            <!-- 删除管理标签页 -->
            <div id="delete-tab" class="tab-content">
                <div class="warning-banner">
                    <span class="icon">⚠️</span>
                    <strong>警告：</strong>所有删除操作都是不可撤销的，请确保您知道自己在做什么！
                </div>
                
                <!-- 删除人员 -->
                <div class="delete-section">
                    <h3><span class="icon">👤</span>删除人员</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deleteGroupSelect">选择小组</label>
                            <select id="deleteGroupSelect" onchange="loadMembers()">
                                <option value="">--请选择小组--</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deleteMemberSelect">选择人员</label>
                            <select id="deleteMemberSelect">
                                <option value="">--请先选择小组--</option>
                            </select>
                        </div>
                    </div>
                    <button class="delete-button" onclick="deleteMember()" id="deleteMemberBtn" disabled>
                        删除选中人员
                    </button>
                </div>
                
                <!-- 删除签到记录 -->
                <div class="delete-section">
                    <h3><span class="icon">📝</span>删除签到记录</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deleteDate">选择日期：</label>
                            <input type="date" id="deleteDate" onchange="loadMemberRecords()" class="date-input">
                        </div>
                        <div class="form-group">
                            <label for="deleteMemberName">选择人员：</label>
                            <select id="deleteMemberName" class="form-control">
                                <option value="">--请选择人员--</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="deleteRecordSelect">选择要删除的签到记录（可多选）</label>
                        <select id="deleteRecordSelect" multiple size="5" class="multi-select" onchange="checkRecordSelection()">
                            <option value="">--请先选择日期和人员--</option>
                        </select>
                        <div class="multi-select-controls">
                            <button type="button" onclick="selectAllRecords()" class="btn btn-warning select-all-btn">全选</button>
                            <button type="button" onclick="clearAllRecords()" class="btn btn-secondary">清空选择</button>
                        </div>
                    </div>
                    <button class="delete-button" onclick="deleteSelectedAttendanceRecords()" id="deleteSelectedRecordsBtn" disabled>
                        删除选中的签到记录
                    </button>
                </div>
                
                <!-- 删除小组 -->
                <div class="delete-section">
                    <h3><span class="icon">🏢</span>删除小组</h3>
                    <div class="form-group">
                        <label for="deleteGroupSelect2">选择要删除的小组</label>
                        <select id="deleteGroupSelect2">
                            <option value="">--请选择小组--</option>
                        </select>
                    </div>
                    <button class="delete-button" onclick="deleteGroup()" id="deleteGroupBtn" disabled>
                        删除选中小组
                    </button>
                </div>
                
                <!-- 批量清理 -->
                <div class="delete-section">
                    <h3><span class="icon">🧹</span>批量清理</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cleanupDays">清理多少天前的签到记录</label>
                            <select id="cleanupDays">
                                <option value="30">30天前</option>
                                <option value="60">60天前</option>
                                <option value="90">90天前</option>
                                <option value="180">180天前</option>
                                <option value="365">365天前</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cleanupType">清理类型</label>
                            <select id="cleanupType">
                                <option value="attendance">签到记录</option>
                                <option value="all">所有数据</option>
                            </select>
                        </div>
                    </div>
                    <button class="delete-button" onclick="batchCleanup()" id="cleanupBtn">
                        执行批量清理
                    </button>
                </div>
                
                <!-- 操作日志 -->
                <div class="log-section">
                    <h3>📋 操作日志</h3>
                    <div class="log-container" id="deleteLogContainer">
                        <div class="log-entry info">等待操作...</div>
                    </div>
                    <button class="btn btn-warning clear-log" onclick="clearDeleteLog()">清空日志</button>
                </div>
            </div>
            
            <!-- 冲突隔离标签页 -->
            <div id="quarantine-tab" class="tab-content">
                <div class="quarantine-header">
                    <h2>🛡️ 冲突隔离管理</h2>
                    <p>管理被隔离的冲突数据，防止数据污染</p>
                </div>
                
                <!-- 隔离统计 -->
                <div class="quarantine-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="quarantineCount">0</div>
                        <div class="stat-label">隔离数据</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="quarantineResolved">0</div>
                        <div class="stat-label">已解决</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="quarantinePending">0</div>
                        <div class="stat-label">待处理</div>
                    </div>
                </div>
                
                <!-- 隔离操作 -->
                <div class="quarantine-actions">
                    <button class="btn btn-primary" onclick="loadQuarantineData()">🔄 刷新隔离数据</button>
                    <button class="btn btn-success" onclick="resolveQuarantineItem()">✅ 解决选中项</button>
                    <button class="btn btn-warning" onclick="restoreQuarantineItem()">↩️ 恢复选中项</button>
                    <button class="btn btn-danger" onclick="deleteQuarantineItem()">🗑️ 删除选中项</button>
                    <button class="btn btn-info" onclick="clearAllQuarantine()">🧹 清空所有隔离</button>
                </div>
                
                <!-- 隔离数据列表 -->
                <div class="quarantine-list">
                    <h3>📋 隔离数据列表</h3>
                    <div id="quarantineDataList">
                        <div class="loading">点击"刷新隔离数据"加载数据...</div>
                    </div>
                </div>
                
                <!-- 隔离详情 -->
                <div class="quarantine-details" id="quarantineDetails" style="display: none;">
                    <h3>🔍 隔离数据详情</h3>
                    <div id="quarantineDetailsContent"></div>
                </div>
            </div>
        </div>
        
        <!-- 冲突解决对话框 -->
        <div class="conflict-resolution-dialog" id="conflictResolutionDialog">
            <div class="conflict-resolution-content">
                <div class="conflict-resolution-header">
                    <h3>🔧 解决数据冲突</h3>
                    <p id="conflictResolutionTitle">请选择解决冲突的方式</p>
                </div>
                <div class="conflict-resolution-body" id="conflictResolutionBody">
                    <!-- 动态内容 -->
                </div>
                <div class="conflict-resolution-actions">
                    <button class="btn btn-primary" onclick="applyConflictResolution()">✅ 应用解决方案</button>
                    <button class="btn btn-warning" onclick="closeConflictResolution()">❌ 取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入必要的脚本 -->
    <script src="../../config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="../../src/utils.js"></script>
    <script src="../../src/new-data-manager.js"></script>
    
    <script>
        // 数据冲突管理系统的JavaScript功能
        let detectedConflicts = [];
        let currentConflictIndex = 0;
        let deleteData = {
            groups: {},
            groupNames: {},
            attendanceRecords: []
        };
        
        // 隔离管理相关变量
        let quarantineData = [];
        let selectedQuarantineItem = null;
        
        // 返回管理页面
        function goBack() {
            // 确认是否要离开页面
            if (confirm('确定要返回管理页面吗？未保存的更改将丢失。')) {
                window.location.href = '../../admin.html';
            }
        }
        
        // 标签页切换功能
        function switchTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有按钮的激活状态
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 显示选中的标签页
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // 激活对应的按钮
            event.target.classList.add('active');
            
            // 如果切换到删除管理标签页，加载数据
            if (tabName === 'delete') {
                loadDeleteData();
            }
        }
        
        // 加载删除管理数据
        async function loadDeleteData() {
            try {
                deleteLog('开始加载删除管理数据...');
                
                // 加载Firebase数据
                const db = firebase.database();
                deleteData.groups = await db.ref('groups').once('value').then(snapshot => snapshot.val() || {});
                deleteData.groupNames = await db.ref('groupNames').once('value').then(snapshot => snapshot.val() || {});
                const attendanceData = await db.ref('attendanceRecords').once('value').then(snapshot => snapshot.val());
                deleteData.attendanceRecords = Array.isArray(attendanceData) ? attendanceData : (attendanceData ? Object.values(attendanceData) : []);
                
                // 更新UI
                updateGroupSelects();
                updateDeleteDate();
                
                deleteLog('删除管理数据加载完成', 'success');
                
            } catch (error) {
                deleteLog(`加载删除管理数据失败: ${error.message}`, 'error');
            }
        }
        
        // 更新小组选择器
        function updateGroupSelects() {
            const groupSelect1 = document.getElementById('deleteGroupSelect');
            const groupSelect2 = document.getElementById('deleteGroupSelect2');
            
            if (!groupSelect1 || !groupSelect2) return;
            
            // 清空现有选项
            groupSelect1.innerHTML = '<option value="">--请选择小组--</option>';
            groupSelect2.innerHTML = '<option value="">--请选择小组--</option>';
            
            // 添加所有小组选项
            Object.keys(deleteData.groups).forEach(groupKey => {
                const groupName = deleteData.groupNames[groupKey] || groupKey;
                const memberCount = deleteData.groups[groupKey] ? deleteData.groups[groupKey].length : 0;
                
                const option1 = new Option(`${groupName} (${memberCount}人)`, groupKey);
                const option2 = new Option(`${groupName} (${memberCount}人)`, groupKey);
                
                groupSelect1.add(option1);
                groupSelect2.add(option2);
            });
        }
        
        // 更新删除日期为今天
        function updateDeleteDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('deleteDate');
            if (dateInput) {
                dateInput.value = today;
            }
        }
        
        // 加载成员列表
        function loadMembers() {
            const groupSelect = document.getElementById('deleteGroupSelect');
            const memberSelect = document.getElementById('deleteMemberSelect');
            const deleteBtn = document.getElementById('deleteMemberBtn');
            
            if (!groupSelect || !memberSelect || !deleteBtn) return;
            
            const selectedGroup = groupSelect.value;
            
            // 清空成员选择器
            memberSelect.innerHTML = '<option value="">--请选择人员--</option>';
            deleteBtn.disabled = true;
            
            if (selectedGroup && deleteData.groups[selectedGroup]) {
                deleteData.groups[selectedGroup].forEach(member => {
                    const option = new Option(member.name || member, member.name || member);
                    memberSelect.add(option);
                });
                
                if (deleteData.groups[selectedGroup].length > 0) {
                    deleteBtn.disabled = false;
                }
            }
        }
        
        // 防重复调用标志
        let isLoadingMembers = false;
        
        // 加载指定日期的签到记录
        function loadMemberRecords() {
            // 防止重复调用
            if (isLoadingMembers) {
                console.log('⚠️ 正在加载中，跳过重复调用');
                return;
            }
            
            const dateInput = document.getElementById('deleteDate');
            const memberSelect = document.getElementById('deleteMemberName');
            
            if (!dateInput || !memberSelect) return;
            
            const selectedDate = dateInput.value;
            if (!selectedDate) {
                memberSelect.innerHTML = '<option value="">--请先选择日期--</option>';
                return;
            }
            
            // 设置加载标志
            isLoadingMembers = true;
            console.log('🔍 加载日期:', selectedDate, '的签到记录');
            
            // 清空选择器
            memberSelect.innerHTML = '<option value="">--请选择人员--</option>';
            
            // 从attendanceRecords中筛选指定日期的记录
            const recordsForDate = deleteData.attendanceRecords.filter(record => {
                if (!record.date || !record.time) return false;
                
                // 将时间戳转换为日期字符串进行比较
                const recordDate = new Date(record.time).toISOString().split('T')[0];
                return recordDate === selectedDate;
            });
            
            console.log('🔍 找到', recordsForDate.length, '条签到记录');
            
            if (recordsForDate.length === 0) {
                memberSelect.innerHTML = '<option value="">--该日期无签到记录--</option>';
                isLoadingMembers = false;
                return;
            }
            
            // 获取签到人员列表（去重）
            const signinMembers = [...new Set(recordsForDate.map(record => record.name))];
            
            // 填充选择器
            signinMembers.forEach(memberName => {
                const option = new Option(memberName, memberName);
                memberSelect.add(option);
            });
            
            console.log('✅ 已加载', signinMembers.length, '名签到人员');
            console.log('🔍 选择器选项数量:', memberSelect.options.length);
            console.log('🔍 选择器是否禁用:', memberSelect.disabled);
            console.log('🔍 选择器是否只读:', memberSelect.readOnly);
            
            // 重置加载标志
            isLoadingMembers = false;
            
            // 测试选择器是否可操作
            setTimeout(() => {
                console.log('🔍 测试选择器状态:');
                console.log('- 选择器元素:', memberSelect);
                console.log('- 选择器可见性:', memberSelect.offsetParent !== null);
                console.log('- 选择器样式:', window.getComputedStyle(memberSelect).display);
                console.log('- 选择器指针事件:', window.getComputedStyle(memberSelect).pointerEvents);
                
                // 添加测试事件监听器
                memberSelect.addEventListener('change', function() {
                    console.log('🔍 选择器值改变:', this.value);
                    // 当选择人员后，加载对应的签到记录
                    loadAttendanceRecords();
                });
                
                memberSelect.addEventListener('click', function() {
                    console.log('🔍 选择器被点击');
                });
            }, 100);
        }
        
        // 加载签到记录
        function loadAttendanceRecords() {
            const dateInput = document.getElementById('deleteDate');
            const memberSelect = document.getElementById('deleteMemberName');
            const recordSelect = document.getElementById('deleteRecordSelect');
            
            if (!dateInput || !memberSelect || !recordSelect) return;
            
            const selectedDate = dateInput.value;
            const selectedMember = memberSelect.value;
            
            if (!selectedDate || !selectedMember) {
                recordSelect.innerHTML = '<option value="">--请先选择日期和人员--</option>';
                return;
            }
            
            console.log('🔍 加载签到记录:', selectedDate, selectedMember);
            
            // 清空记录选择器
            recordSelect.innerHTML = '';
            
            // 筛选指定日期和人员的签到记录
            const recordsForMember = deleteData.attendanceRecords.filter(record => {
                if (!record.date || !record.time || !record.name) return false;
                
                // 检查日期匹配
                const recordDate = new Date(record.time).toISOString().split('T')[0];
                const dateMatch = recordDate === selectedDate;
                
                // 检查人员匹配
                const memberMatch = record.name === selectedMember;
                
                return dateMatch && memberMatch;
            });
            
            console.log('🔍 找到', recordsForMember.length, '条签到记录');
            
            if (recordsForMember.length === 0) {
                recordSelect.innerHTML = '<option value="">--该人员在该日期无签到记录--</option>';
                return;
            }
            
            // 填充记录选择器
            recordsForMember.forEach((record, index) => {
                const time = new Date(record.time).toLocaleString('zh-CN');
                const optionText = `${time} - ${record.timeSlot || '未知时段'}`;
                const optionValue = record.recordId || `record_${index}`;
                
                const option = new Option(optionText, optionValue);
                recordSelect.add(option);
            });
            
            console.log('✅ 已加载', recordsForMember.length, '条签到记录');
        }
        
        // 检查记录选择状态
        function checkRecordSelection() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            const selectAllBtn = document.querySelector('.select-all-btn');
            const clearAllBtn = document.querySelector('.btn-secondary');
            const deleteRecordsBtn = document.getElementById('deleteSelectedRecordsBtn');
            
            if (!recordSelect) return;
            
            const selectedOptions = Array.from(recordSelect.selectedOptions);
            const hasSelection = selectedOptions.length > 0;
            
            console.log('🔍 记录选择状态:', selectedOptions.length, '个选项被选中');
            
            // 更新按钮状态
            if (selectAllBtn) {
                selectAllBtn.disabled = !hasSelection && recordSelect.options.length > 1;
            }
            if (clearAllBtn) {
                clearAllBtn.disabled = !hasSelection;
            }
            if (deleteRecordsBtn) {
                deleteRecordsBtn.disabled = !hasSelection;
            }
        }
        
        // 全选记录
        function selectAllRecords() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            if (!recordSelect) return;
            
            for (let i = 0; i < recordSelect.options.length; i++) {
                recordSelect.options[i].selected = true;
            }
            
            checkRecordSelection();
            console.log('✅ 已全选所有记录');
        }
        
        // 清空选择
        function clearAllRecords() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            if (!recordSelect) return;
            
            for (let i = 0; i < recordSelect.options.length; i++) {
                recordSelect.options[i].selected = false;
            }
            
            checkRecordSelection();
            console.log('✅ 已清空所有选择');
        }
        
        // 删除选中的签到记录
        async function deleteSelectedAttendanceRecords() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            if (!recordSelect) return;
            
            const selectedOptions = Array.from(recordSelect.selectedOptions);
            if (selectedOptions.length === 0) {
                alert('请先选择要删除的签到记录');
                return;
            }
            
            // 确认删除
            const confirmDelete = confirm(`确定要删除 ${selectedOptions.length} 条签到记录吗？\n\n此操作不可撤销！`);
            if (!confirmDelete) return;
            
            try {
                console.log('🔍 开始删除签到记录...');
                
                // 获取要删除的记录ID
                const recordIdsToDelete = selectedOptions.map(option => option.value);
                console.log('📋 要删除的记录ID:', recordIdsToDelete);
                
                // 从attendanceRecords中移除这些记录
                const updatedRecords = deleteData.attendanceRecords.filter(record => {
                    const recordId = record.recordId || `record_${deleteData.attendanceRecords.indexOf(record)}`;
                    return !recordIdsToDelete.includes(recordId);
                });
                
                console.log(`📊 删除前记录数: ${deleteData.attendanceRecords.length}, 删除后记录数: ${updatedRecords.length}`);
                
                // 更新数据
                deleteData.attendanceRecords = updatedRecords;
                
                // 1. 同步到Firebase
                if (window.db) {
                    console.log('🔄 开始同步到Firebase...');
                    await window.db.ref('attendanceRecords').set(updatedRecords);
                    console.log('✅ Firebase同步成功');
                } else {
                    console.warn('⚠️ window.db未设置，无法同步到Firebase');
                    console.log('🔍 Firebase状态:', {
                        firebase: typeof firebase !== 'undefined',
                        firebaseConfig: !!window.firebaseConfig,
                        windowDb: !!window.db
                    });
                }
                
                // 2. 更新本地存储（使用正确的键名）
                localStorage.setItem('msh_attendanceRecords', JSON.stringify(updatedRecords));
                console.log('✅ 本地存储已更新 (msh_attendanceRecords)');
                
                // 3. 更新全局变量
                if (window.attendanceRecords) {
                    window.attendanceRecords = updatedRecords;
                    console.log('✅ 全局变量已更新 (window.attendanceRecords)');
                }
                
                // 4. 如果使用NewDataManager，同步更新其状态
                if (window.newDataManager) {
                    try {
                        // 保存到NewDataManager的本地存储
                        window.newDataManager.saveToLocalStorage('attendanceRecords', updatedRecords);
                        
                        // 标记数据变更
                        window.newDataManager.markDataChange('attendanceRecords', 'deleted', `delete_records_${recordIdsToDelete.length}`);
                        
                        // 清除hasLocalChanges标志（因为已经同步到Firebase）
                        window.newDataManager.hasLocalChanges = false;
                        
                        console.log('✅ NewDataManager状态已更新');
                    } catch (managerError) {
                        console.warn('⚠️ NewDataManager更新失败:', managerError);
                    }
                }
                
                // 5. 触发数据同步事件（供其他页面监听）
                try {
                    const event = new CustomEvent('attendanceRecordsUpdated', {
                        detail: { 
                            records: updatedRecords,
                            deletedCount: recordIdsToDelete.length,
                            source: 'data-conflict-manager'
                        }
                    });
                    window.dispatchEvent(event);
                    console.log('✅ 数据同步事件已触发');
                } catch (eventError) {
                    console.warn('⚠️ 触发数据同步事件失败:', eventError);
                }
                
                // 6. 重新加载记录
                loadAttendanceRecords();
                
                // 7. 显示成功提示
                alert(`✅ 已成功删除 ${recordIdsToDelete.length} 条签到记录\n\n✓ Firebase已更新\n✓ 本地存储已更新\n✓ 数据已同步`);
                
                // 8. 添加操作日志
                addLog('success', `成功删除 ${recordIdsToDelete.length} 条签到记录`);
                
            } catch (error) {
                console.error('❌ 删除签到记录失败:', error);
                addLog('error', `删除签到记录失败: ${error.message}`);
                alert(`删除失败: ${error.message}\n\n请检查控制台日志`);
            }
        }
        
        // 删除人员
        async function deleteMember() {
            const groupSelect = document.getElementById('deleteGroupSelect');
            const memberSelect = document.getElementById('deleteMemberSelect');
            
            if (!groupSelect || !memberSelect) return;
            
            const groupKey = groupSelect.value;
            const memberName = memberSelect.value;
            
            if (!groupKey || !memberName) {
                alert('请选择小组和人员');
                return;
            }
            
            // 多重确认
            const confirm1 = confirm(`确定要删除 ${memberName} 吗？\n\n小组：${deleteData.groupNames[groupKey] || groupKey}`);
            if (!confirm1) return;
            
            const confirm2 = confirm(`⚠️ 此操作不可撤销！\n\n确定要永久删除 ${memberName} 吗？`);
            if (!confirm2) return;
            
            try {
                deleteLog(`开始删除人员: ${memberName}`);
                
                // 从小组中移除成员
                const updatedMembers = deleteData.groups[groupKey].filter(member => 
                    (member.name || member) !== memberName
                );
                
                // 更新Firebase
                const db = firebase.database();
                await db.ref(`groups/${groupKey}`).set(updatedMembers);
                
                // 删除相关的签到记录
                const memberRecords = deleteData.attendanceRecords.filter(record => 
                    record.name === memberName && record.group === groupKey
                );
                
                for (const record of memberRecords) {
                    const recordIndex = deleteData.attendanceRecords.findIndex(r => 
                        r.name === record.name && 
                        r.group === record.group && 
                        r.time === record.time
                    );
                    if (recordIndex !== -1) {
                        await db.ref(`attendanceRecords/${recordIndex}`).remove();
                    }
                }
                
                deleteLog(`人员删除成功: ${memberName}`, 'success');
                deleteLog(`同时删除了 ${memberRecords.length} 条相关签到记录`, 'info');
                
                // 重新加载数据
                await loadDeleteData();
                
                alert(`✅ 人员 ${memberName} 删除成功！\n同时删除了 ${memberRecords.length} 条相关签到记录。`);
                
            } catch (error) {
                deleteLog(`删除人员失败: ${error.message}`, 'error');
                alert('删除失败: ' + error.message);
            }
        }
        
        // 删除日志记录
        function deleteLog(message, type = 'info') {
            const logContainer = document.getElementById('deleteLogContainer');
            if (!logContainer) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // 限制日志条数
            const entries = logContainer.children;
            if (entries.length > 100) {
                logContainer.removeChild(entries[0]);
            }
        }
        
        // 清空删除日志
        function clearDeleteLog() {
            const logContainer = document.getElementById('deleteLogContainer');
            if (logContainer) {
                logContainer.innerHTML = '<div class="log-entry info">日志已清空</div>';
            }
        }
        
        // 初始化系统
        document.addEventListener('DOMContentLoaded', function() {
            console.log('数据冲突管理系统已加载');
            // 初始化Firebase
            if (typeof firebase !== 'undefined' && window.firebaseConfig) {
                firebase.initializeApp(window.firebaseConfig);
                window.db = firebase.database();
                console.log('Firebase已初始化');
                console.log('✅ window.db已设置');
            } else {
                console.error('❌ Firebase配置未找到或Firebase未加载');
            }
        });
        
        // 检测数据冲突
        async function detectConflicts() {
            console.log('开始检测数据冲突...');
            
            try {
                // 获取本地数据
                const localGroups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                const localGroupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
                const localAttendanceRecords = JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]');
                
                console.log('本地数据统计:', {
                    groups: Object.keys(localGroups).length,
                    groupNames: Object.keys(localGroupNames).length,
                    attendanceRecords: localAttendanceRecords.length
                });
                
                // 获取Firebase数据
                const db = firebase.database();
                const firebaseGroups = await db.ref('groups').once('value').then(snapshot => snapshot.val() || {});
                const firebaseGroupNames = await db.ref('groupNames').once('value').then(snapshot => snapshot.val() || {});
                const firebaseAttendanceRecords = await db.ref('attendanceRecords').once('value').then(snapshot => {
                    const data = snapshot.val();
                    return Array.isArray(data) ? data : (data ? Object.values(data) : []);
                });
                
                // 将Firebase数据存储到全局变量，供统计函数使用
                window.firebaseGroups = firebaseGroups;
                window.firebaseGroupNames = firebaseGroupNames;
                window.firebaseAttendanceRecords = firebaseAttendanceRecords;
                
                console.log('Firebase数据统计:', {
                    groups: Object.keys(firebaseGroups).length,
                    groupNames: Object.keys(firebaseGroupNames).length,
                    attendanceRecords: firebaseAttendanceRecords.length
                });
                
                // 详细数据对比分析
                console.log('\n=== 详细数据对比分析 ===');
                const dataComparison = performDetailedDataComparison(localGroups, firebaseGroups, localAttendanceRecords, firebaseAttendanceRecords);
                
                // 检测冲突
                const conflicts = [];
                
                // 检测UUID冲突
                const uuidConflicts = detectUUIDConflicts(localGroups, firebaseGroups);
                console.log(`UUID冲突: ${uuidConflicts.length} 个`);
                conflicts.push(...uuidConflicts);
                
                // 检测小组名称冲突
                const groupNameConflicts = detectGroupNameConflicts(localGroups, firebaseGroups);
                console.log(`小组名称冲突: ${groupNameConflicts.length} 个`);
                conflicts.push(...groupNameConflicts);
                
                // 检测数据不一致冲突
                const dataInconsistencyConflicts = detectDataInconsistencyConflicts(localGroups, firebaseGroups, localGroupNames, firebaseGroupNames);
                console.log(`数据不一致冲突: ${dataInconsistencyConflicts.length} 个`);
                conflicts.push(...dataInconsistencyConflicts);
                
                // 检测签到记录冲突
                const attendanceConflicts = detectAttendanceConflicts(localAttendanceRecords, firebaseAttendanceRecords);
                console.log(`签到记录冲突: ${attendanceConflicts.length} 个`);
                conflicts.push(...attendanceConflicts);
                
                detectedConflicts = conflicts;
                displayConflicts(conflicts);
                
                console.log(`检测到 ${conflicts.length} 个冲突`);
                
            } catch (error) {
                console.error('检测冲突时出错:', error);
                alert('检测冲突时出错: ' + error.message);
            }
        }
        
        // 检测UUID冲突
        function detectUUIDConflicts(localGroups, firebaseGroups) {
            const conflicts = [];
            const uuidMap = new Map();
            const duplicateRecords = []; // 记录重复记录
            
            console.log('=== UUID冲突检测详细分析 ===');
            console.log('本地小组数据:', localGroups);
            console.log('Firebase小组数据:', firebaseGroups);
            
            // 收集所有UUID - 分别处理本地和Firebase数据
            console.log('\n--- 处理本地数据 ---');
            Object.entries(localGroups).forEach(([groupName, group]) => {
                if (Array.isArray(group)) {
                    console.log(`本地小组 ${groupName}:`, group);
                    group.forEach((member, memberIndex) => {
                        if (member && member.uuid) {
                            // 为本地成员添加来源标识
                            const localMember = {
                                ...member,
                                _source: 'local',
                                _groupName: groupName,
                                _originalData: member
                            };
                            
                            console.log(`本地成员 ${memberIndex}:`, {
                                uuid: localMember.uuid,
                                name: localMember.name,
                                group: localMember.group,
                                _source: localMember._source,
                                _groupName: localMember._groupName,
                                fullData: localMember
                            });
                            
                            if (uuidMap.has(localMember.uuid)) {
                                const existingMember = uuidMap.get(localMember.uuid);
                                console.log(`发现重复UUID: ${localMember.uuid}`);
                                console.log('现有成员:', existingMember);
                                console.log('新成员:', localMember);
                                
                                // 检查是否是同一个人（姓名和小组相同）
                                const isSamePerson = existingMember.name === localMember.name && 
                                                   (existingMember.group === localMember.group || 
                                                    existingMember._groupName === localMember._groupName);
                                
                                console.log('是否同一人:', isSamePerson);
                                console.log('姓名匹配:', existingMember.name === localMember.name);
                                console.log('小组匹配:', existingMember.group === localMember.group || existingMember._groupName === localMember._groupName);
                                
                                if (isSamePerson) {
                                    // 检查是否只是数据来源不同
                                    const isOnlySourceDifferent = checkIfOnlySourceDifferent(existingMember, localMember);
                                    
                                    if (isOnlySourceDifferent) {
                                        console.log('判断为同步数据重复（仅来源不同）');
                                        // 不记录为冲突，这是正常的同步数据
                                    } else {
                                        console.log('判断为重复记录');
                                        duplicateRecords.push({
                                            uuid: localMember.uuid,
                                            name: localMember.name,
                                            group: localMember.group || localMember._groupName,
                                            existingMember: existingMember,
                                            duplicateMember: localMember
                                        });
                                    }
                                } else {
                                    console.log('判断为UUID冲突');
                                    conflicts.push({
                                        type: 'uuid_conflict',
                                        description: `UUID冲突: ${localMember.uuid} 被多个不同成员使用`,
                                        members: [existingMember, localMember],
                                        severity: 'high'
                                    });
                                }
                            } else {
                                uuidMap.set(localMember.uuid, localMember);
                            }
                        }
                    });
                }
            });
            
            console.log('\n--- 处理Firebase数据 ---');
            Object.entries(firebaseGroups).forEach(([groupName, group]) => {
                if (Array.isArray(group)) {
                    console.log(`Firebase小组 ${groupName}:`, group);
                    group.forEach((member, memberIndex) => {
                        if (member && member.uuid) {
                            // 为Firebase成员添加来源标识
                            const firebaseMember = {
                                ...member,
                                _source: 'firebase',
                                _groupName: groupName,
                                _originalData: member
                            };
                            
                            console.log(`Firebase成员 ${memberIndex}:`, {
                                uuid: firebaseMember.uuid,
                                name: firebaseMember.name,
                                group: firebaseMember.group,
                                _source: firebaseMember._source,
                                _groupName: firebaseMember._groupName,
                                fullData: firebaseMember
                            });
                            
                            if (uuidMap.has(firebaseMember.uuid)) {
                                const existingMember = uuidMap.get(firebaseMember.uuid);
                                console.log(`发现重复UUID: ${firebaseMember.uuid}`);
                                console.log('现有成员:', existingMember);
                                console.log('新成员:', firebaseMember);
                                
                                // 检查是否是同一个人（姓名和小组相同）
                                const isSamePerson = existingMember.name === firebaseMember.name && 
                                                   (existingMember.group === firebaseMember.group || 
                                                    existingMember._groupName === firebaseMember._groupName);
                                
                                console.log('是否同一人:', isSamePerson);
                                console.log('姓名匹配:', existingMember.name === firebaseMember.name);
                                console.log('小组匹配:', existingMember.group === firebaseMember.group || existingMember._groupName === firebaseMember._groupName);
                                
                                if (isSamePerson) {
                                    // 检查是否只是数据来源不同
                                    const isOnlySourceDifferent = checkIfOnlySourceDifferent(existingMember, firebaseMember);
                                    
                                    if (isOnlySourceDifferent) {
                                        console.log('判断为同步数据重复（仅来源不同）');
                                        // 不记录为冲突，这是正常的同步数据
                                    } else {
                                        console.log('判断为重复记录');
                                        duplicateRecords.push({
                                            uuid: firebaseMember.uuid,
                                            name: firebaseMember.name,
                                            group: firebaseMember.group || firebaseMember._groupName,
                                            existingMember: existingMember,
                                            duplicateMember: firebaseMember
                                        });
                                    }
                                } else {
                                    console.log('判断为UUID冲突');
                                    conflicts.push({
                                        type: 'uuid_conflict',
                                        description: `UUID冲突: ${firebaseMember.uuid} 被多个不同成员使用`,
                                        members: [existingMember, firebaseMember],
                                        severity: 'high'
                                    });
                                }
                            } else {
                                uuidMap.set(firebaseMember.uuid, firebaseMember);
                            }
                        }
                    });
                }
            });
            
            // 处理重复记录
            duplicateRecords.forEach(duplicate => {
                conflicts.push({
                    type: 'duplicate_record',
                    description: `重复记录: ${duplicate.name} (${duplicate.group}) 存在重复记录`,
                    uuid: duplicate.uuid,
                    name: duplicate.name,
                    group: duplicate.group,
                    existingMember: duplicate.existingMember,
                    duplicateMember: duplicate.duplicateMember,
                    severity: 'medium'
                });
            });
            
            console.log('\n=== 检测结果统计 ===');
            console.log(`检测到 ${conflicts.filter(c => c.type === 'uuid_conflict').length} 个UUID冲突`);
            console.log(`检测到 ${conflicts.filter(c => c.type === 'duplicate_record').length} 个重复记录`);
            console.log('所有冲突:', conflicts);
            
            return conflicts;
        }
        
        // 检测小组名称冲突
        function detectGroupNameConflicts(localGroups, firebaseGroups) {
            const conflicts = [];
            const memberMap = new Map();
            
            console.log('=== 小组名称冲突检测 ===');
            console.log('本地小组数据:', localGroups);
            console.log('Firebase小组数据:', firebaseGroups);
            
            // 收集所有成员，分别处理本地和Firebase数据
            console.log('\n--- 处理本地数据 ---');
            Object.entries(localGroups).forEach(([groupName, group]) => {
                if (Array.isArray(group)) {
                    console.log(`本地小组 ${groupName}:`, group);
                    group.forEach(member => {
                        if (member && (member.name || member.花名)) {
                            const key = member.name || member.花名;
                            const memberWithSource = {
                                ...member,
                                _source: 'local',
                                _groupName: groupName
                            };
                            
                            console.log(`本地成员: ${key} 在小组 ${groupName}`);
                            
                            if (memberMap.has(key)) {
                                const existing = memberMap.get(key);
                                console.log(`发现重复成员: ${key}`);
                                console.log('现有成员:', existing);
                                console.log('新成员:', memberWithSource);
                                
                                if (existing.group !== member.group && existing._groupName !== groupName) {
                                    console.log(`小组冲突: ${existing.group || existing._groupName} vs ${member.group || groupName}`);
                                    conflicts.push({
                                        type: 'group_name',
                                        description: `小组名称冲突: ${key} 在不同小组中`,
                                        members: [existing, memberWithSource],
                                        severity: 'medium'
                                    });
                                }
                            } else {
                                memberMap.set(key, memberWithSource);
                            }
                        }
                    });
                }
            });
            
            console.log('\n--- 处理Firebase数据 ---');
            Object.entries(firebaseGroups).forEach(([groupName, group]) => {
                if (Array.isArray(group)) {
                    console.log(`Firebase小组 ${groupName}:`, group);
                    group.forEach(member => {
                        if (member && (member.name || member.花名)) {
                            const key = member.name || member.花名;
                            const memberWithSource = {
                                ...member,
                                _source: 'firebase',
                                _groupName: groupName
                            };
                            
                            console.log(`Firebase成员: ${key} 在小组 ${groupName}`);
                            
                            if (memberMap.has(key)) {
                                const existing = memberMap.get(key);
                                console.log(`发现重复成员: ${key}`);
                                console.log('现有成员:', existing);
                                console.log('新成员:', memberWithSource);
                                
                                if (existing.group !== member.group && existing._groupName !== groupName) {
                                    console.log(`小组冲突: ${existing.group || existing._groupName} vs ${member.group || groupName}`);
                                    conflicts.push({
                                        type: 'group_name',
                                        description: `小组名称冲突: ${key} 在不同小组中`,
                                        members: [existing, memberWithSource],
                                        severity: 'medium'
                                    });
                                }
                            } else {
                                memberMap.set(key, memberWithSource);
                            }
                        }
                    });
                }
            });
            
            console.log('\n=== 小组名称冲突检测结果 ===');
            console.log(`检测到 ${conflicts.length} 个小组名称冲突`);
            console.log('冲突详情:', conflicts);
            
            return conflicts;
        }
        
        // 检测数据不一致冲突
        function detectDataInconsistencyConflicts(localGroups, firebaseGroups, localGroupNames, firebaseGroupNames) {
            const conflicts = [];
            
            // 检测小组数据不一致
            const allGroupNames = new Set([...Object.keys(localGroups), ...Object.keys(firebaseGroups)]);
            allGroupNames.forEach(groupName => {
                const localGroup = localGroups[groupName] || [];
                const firebaseGroup = firebaseGroups[groupName] || [];
                
                if (localGroup.length !== firebaseGroup.length) {
                    conflicts.push({
                        type: 'data_inconsistency',
                        description: `数据不一致: ${groupName} 小组成员数量不同 (本地:${localGroup.length}, Firebase:${firebaseGroup.length})`,
                        groupName: groupName,
                        localCount: localGroup.length,
                        firebaseCount: firebaseGroup.length,
                        severity: 'medium'
                    });
                }
            });
            
            return conflicts;
        }
        
        // 检测签到记录冲突
        function detectAttendanceConflicts(localRecords, firebaseRecords) {
            const conflicts = [];
            const processedRecords = new Set();
            
            console.log('=== 签到记录冲突检测开始 ===');
            console.log('本地签到记录数量:', localRecords.length);
            console.log('Firebase签到记录数量:', firebaseRecords.length);
            console.log('本地签到记录示例:', localRecords.slice(0, 3));
            console.log('Firebase签到记录示例:', firebaseRecords.slice(0, 3));
            
            // 检查每条本地记录
            localRecords.forEach((localRecord, localIndex) => {
                if (!localRecord || !localRecord.name) return;
                
                const recordKey = `${localRecord.name}_${localRecord.time || localRecord.date}`;
                if (processedRecords.has(recordKey)) return;
                processedRecords.add(recordKey);
                
                console.log(`\n--- 检查本地记录 ${localIndex + 1}: ${localRecord.name} ---`);
                console.log('本地记录详情:', localRecord);
                
                // 在Firebase记录中查找匹配的记录
                const matchingFirebaseRecord = firebaseRecords.find(firebaseRecord => {
                    if (!firebaseRecord || !firebaseRecord.name) return false;
                    
                    // 匹配条件：姓名相同且时间相同
                    const nameMatch = firebaseRecord.name === localRecord.name;
                    
                    // 精确时间匹配：只匹配完全相同的时间，不进行日期模糊匹配
                    const timeMatch = (firebaseRecord.time === localRecord.time);
                    
                    console.log(`检查匹配: ${localRecord.name}`, {
                        localTime: localRecord.time,
                        firebaseTime: firebaseRecord.time,
                        nameMatch: nameMatch,
                        timeMatch: timeMatch,
                        firebaseRecord: firebaseRecord
                    });
                    
                    return nameMatch && timeMatch;
                });
                
                if (matchingFirebaseRecord) {
                    console.log('找到匹配的Firebase记录:', matchingFirebaseRecord);
                    
                    // 检查记录内容是否一致
                    const isContentSame = JSON.stringify({
                        name: localRecord.name,
                        group: localRecord.group,
                        time: localRecord.time,
                        date: localRecord.date
                    }) === JSON.stringify({
                        name: matchingFirebaseRecord.name,
                        group: matchingFirebaseRecord.group,
                        time: matchingFirebaseRecord.time,
                        date: matchingFirebaseRecord.date
                    });
                    
                    console.log('记录内容是否一致:', isContentSame);
                    
                    if (!isContentSame) {
                        console.log('检测到签到记录冲突，添加到冲突列表');
                        conflicts.push({
                            type: 'attendance_conflict',
                            description: `签到记录冲突: ${localRecord.name} 在 ${localRecord.time || localRecord.date} 的记录内容不一致`,
                            localRecord: localRecord,
                            firebaseRecord: matchingFirebaseRecord,
                            severity: 'medium'
                        });
                    } else {
                        console.log('记录内容一致，无冲突');
                    }
                } else {
                    console.log('未找到匹配的Firebase记录');
                    // 本地有但Firebase没有的记录
                    conflicts.push({
                        type: 'attendance_missing',
                        description: `签到记录缺失: ${localRecord.name} 在 ${localRecord.time || localRecord.date} 的记录在Firebase中缺失`,
                        localRecord: localRecord,
                        severity: 'low'
                    });
                }
            });
            
            // 检查Firebase中有但本地没有的记录
            firebaseRecords.forEach(firebaseRecord => {
                if (!firebaseRecord || !firebaseRecord.name) return;
                
                const recordKey = `${firebaseRecord.name}_${firebaseRecord.time || firebaseRecord.date}`;
                if (processedRecords.has(recordKey)) return;
                processedRecords.add(recordKey);
                
                const matchingLocalRecord = localRecords.find(localRecord => {
                    if (!localRecord || !localRecord.name) return false;
                    
                    const nameMatch = firebaseRecord.name === localRecord.name;
                    const timeMatch = (firebaseRecord.time === localRecord.time);
                    
                    return nameMatch && timeMatch;
                });
                
                if (!matchingLocalRecord) {
                    conflicts.push({
                        type: 'attendance_extra',
                        description: `签到记录多余: ${firebaseRecord.name} 在 ${firebaseRecord.time || firebaseRecord.date} 的记录在本地缺失`,
                        firebaseRecord: firebaseRecord,
                        severity: 'low'
                    });
                }
            });
            
            return conflicts;
        }
        
        // 显示冲突
        function displayConflicts(conflicts) {
            const container = document.getElementById('conflictResults');
            if (!container) return;
            
            if (conflicts.length === 0) {
                container.innerHTML = '<div class="no-conflicts">✅ 未检测到数据冲突</div>';
                return;
            }
            
            // 分析冲突类型统计
            const conflictStats = analyzeConflictTypes(conflicts);
            
            let html = `
                <div class="conflict-summary">
                    <h3>📊 冲突分析报告</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${conflicts.length}</div>
                            <div class="stat-label">总冲突数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.uuid_conflict || 0}</div>
                            <div class="stat-label">UUID冲突</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.duplicate_record || 0}</div>
                            <div class="stat-label">重复记录</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.group_name}</div>
                            <div class="stat-label">小组名称冲突</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.data_inconsistency}</div>
                            <div class="stat-label">数据不一致</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.attendance_conflict || 0}</div>
                            <div class="stat-label">签到记录冲突</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.attendance_missing || 0}</div>
                            <div class="stat-label">签到记录缺失</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.attendance_extra || 0}</div>
                            <div class="stat-label">签到记录多余</div>
                        </div>
                    </div>
                </div>
                <div class="conflicts-list">
            `;
            
            conflicts.forEach((conflict, index) => {
                html += `
                    <div class="conflict-item">
                        <div class="conflict-header">
                            <span class="conflict-type ${conflict.severity}">${conflict.type}</span>
                            <span class="conflict-description">${conflict.description}</span>
                        </div>
                        <div class="conflict-details">
                            ${getConflictDetails(conflict)}
                        </div>
                        <div class="conflict-actions">
                            <button class="btn btn-sm btn-primary" onclick="resolveConflict(${index})">解决</button>
                            <button class="btn btn-sm btn-warning" onclick="ignoreConflict(${index})">忽略</button>
                            <button class="btn btn-sm btn-info" onclick="showConflictDetails(${index})">详情</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // 获取冲突详情
        function getConflictDetails(conflict) {
            switch (conflict.type) {
                case 'uuid_conflict':
                    return `
                        <div class="conflict-detail-item">
                            <strong>UUID:</strong> ${conflict.members?.[0]?.uuid || 'N/A'}<br>
                            <strong>冲突成员:</strong> 
                            ${conflict.members?.map(member => `${member.name || member} (${member.group || '未知小组'})`).join(', ') || 'N/A'}<br>
                            <strong>问题类型:</strong> 不同的人使用相同UUID
                        </div>
                    `;
                case 'duplicate_record':
                    // 分析重复记录的详细信息
                    const analysis = analyzeDuplicateRecord(conflict);
                    return `
                        <div class="conflict-detail-item">
                            <strong>UUID:</strong> ${conflict.uuid || 'N/A'}<br>
                            <strong>重复成员:</strong> ${conflict.name} (${conflict.group})<br>
                            <strong>问题类型:</strong> 同一个人存在重复记录<br>
                            <strong>重复来源:</strong> ${analysis.source}<br>
                            <strong>重复类型:</strong> ${analysis.type}<br>
                            <strong>详细信息:</strong><br>
                            ${analysis.details}
                            <strong>解决方案:</strong> 建议合并重复记录，保留一个记录
                        </div>
                    `;
                case 'uuid':
                    return `
                        <div class="conflict-detail-item">
                            <strong>UUID:</strong> ${conflict.members?.[0]?.uuid || 'N/A'}<br>
                            <strong>冲突成员:</strong> 
                            ${conflict.members?.map(member => `${member.name || member} (${member.group || '未知小组'})`).join(', ') || 'N/A'}
                        </div>
                    `;
                case 'group_name':
                    // 分析小组名称冲突的详细信息
                    const groupConflictAnalysis = analyzeGroupNameConflict(conflict);
                    return `
                        <div class="conflict-detail-item">
                            <strong>成员姓名:</strong> ${conflict.members?.[0]?.name || 'N/A'}<br>
                            <strong>冲突类型:</strong> ${groupConflictAnalysis.type}<br>
                            <strong>冲突详情:</strong><br>
                            ${groupConflictAnalysis.details}
                            <strong>解决方案:</strong> ${groupConflictAnalysis.solution}
                        </div>
                    `;
                case 'data_inconsistency':
                    return `
                        <div class="conflict-detail-item">
                            <strong>小组:</strong> ${conflict.groupName || 'N/A'}<br>
                            <strong>本地成员数:</strong> ${conflict.localCount || 0}<br>
                            <strong>Firebase成员数:</strong> ${conflict.firebaseCount || 0}
                        </div>
                    `;
                case 'attendance_conflict':
                    // 分析签到记录冲突的详细信息
                    const attendanceAnalysis = analyzeAttendanceConflict(conflict);
                    return `
                        <div class="conflict-detail-item">
                            <strong>姓名:</strong> ${conflict.localRecord?.name || 'N/A'}<br>
                            <strong>时间:</strong> ${conflict.localRecord?.time || conflict.localRecord?.date || 'N/A'}<br>
                            <strong>冲突类型:</strong> ${attendanceAnalysis.type}<br>
                            <strong>冲突详情:</strong><br>
                            ${attendanceAnalysis.details}
                            <strong>解决方案:</strong> ${attendanceAnalysis.solution}
                        </div>
                    `;
                case 'attendance_missing':
                    return `
                        <div class="conflict-detail-item">
                            <strong>姓名:</strong> ${conflict.localRecord?.name || 'N/A'}<br>
                            <strong>时间:</strong> ${conflict.localRecord?.time || conflict.localRecord?.date || 'N/A'}<br>
                            <strong>小组:</strong> ${conflict.localRecord?.group || 'N/A'}<br>
                            <strong>状态:</strong> 本地有，Firebase缺失
                        </div>
                    `;
                case 'attendance_extra':
                    return `
                        <div class="conflict-detail-item">
                            <strong>姓名:</strong> ${conflict.firebaseRecord?.name || 'N/A'}<br>
                            <strong>时间:</strong> ${conflict.firebaseRecord?.time || conflict.firebaseRecord?.date || 'N/A'}<br>
                            <strong>小组:</strong> ${conflict.firebaseRecord?.group || 'N/A'}<br>
                            <strong>状态:</strong> Firebase有，本地缺失
                        </div>
                    `;
                default:
                    return `
                        <div class="conflict-detail-item">
                            <strong>详细信息:</strong> ${JSON.stringify(conflict, null, 2)}
                        </div>
                    `;
            }
        }
        
        // 显示冲突详情
        function showConflictDetails(index) {
            if (index >= 0 && index < detectedConflicts.length) {
                const conflict = detectedConflicts[index];
                const details = getConflictDetails(conflict);
                
                alert(`冲突详情 (${conflict.type}):\n\n${conflict.description}\n\n详细信息:\n${details}`);
            }
        }
        
        // 详细数据对比分析
        function performDetailedDataComparison(localGroups, firebaseGroups, localAttendanceRecords, firebaseAttendanceRecords) {
            console.log('\n=== 详细数据对比分析 ===');
            
            const comparison = {
                localOnly: [],
                firebaseOnly: [],
                common: [],
                conflicts: []
            };
            
            // 收集所有本地成员
            const localMembers = [];
            Object.entries(localGroups).forEach(([groupName, members]) => {
                if (Array.isArray(members)) {
                    members.forEach(member => {
                        if (member && member.name) {
                            localMembers.push({
                                ...member,
                                _source: 'local',
                                _groupName: groupName
                            });
                        }
                    });
                }
            });
            
            // 收集所有Firebase成员
            const firebaseMembers = [];
            Object.entries(firebaseGroups).forEach(([groupName, members]) => {
                if (Array.isArray(members)) {
                    members.forEach(member => {
                        if (member && member.name) {
                            firebaseMembers.push({
                                ...member,
                                _source: 'firebase',
                                _groupName: groupName
                            });
                        }
                    });
                }
            });
            
            console.log('本地成员总数:', localMembers.length);
            console.log('Firebase成员总数:', firebaseMembers.length);
            console.log('本地成员详情:', localMembers);
            console.log('Firebase成员详情:', firebaseMembers);
            
            // 按UUID分组分析
            const uuidMap = new Map();
            
            // 添加本地成员到UUID映射
            localMembers.forEach(member => {
                if (member.uuid) {
                    if (!uuidMap.has(member.uuid)) {
                        uuidMap.set(member.uuid, []);
                    }
                    uuidMap.get(member.uuid).push(member);
                }
            });
            
            // 添加Firebase成员到UUID映射
            firebaseMembers.forEach(member => {
                if (member.uuid) {
                    if (!uuidMap.has(member.uuid)) {
                        uuidMap.set(member.uuid, []);
                    }
                    uuidMap.get(member.uuid).push(member);
                }
            });
            
            // 分析每个UUID的情况
            console.log('\n=== UUID分析 ===');
            uuidMap.forEach((members, uuid) => {
                console.log(`\nUUID: ${uuid}`);
                console.log('成员数量:', members.length);
                console.log('成员详情:', members);
                
                if (members.length === 1) {
                    const member = members[0];
                    if (member._source === 'local') {
                        comparison.localOnly.push(member);
                        console.log('仅存在于本地');
                    } else {
                        comparison.firebaseOnly.push(member);
                        console.log('仅存在于Firebase');
                    }
                } else {
                    // 多个成员使用相同UUID
                    const localMembers = members.filter(m => m._source === 'local');
                    const firebaseMembers = members.filter(m => m._source === 'firebase');
                    
                    console.log('本地成员:', localMembers.length);
                    console.log('Firebase成员:', firebaseMembers.length);
                    
                    if (localMembers.length > 0 && firebaseMembers.length > 0) {
                        // 跨数据源重复
                        comparison.conflicts.push({
                            type: 'cross_source_duplicate',
                            uuid: uuid,
                            localMembers: localMembers,
                            firebaseMembers: firebaseMembers,
                            description: `UUID ${uuid} 在本地和Firebase中都存在`
                        });
                        console.log('跨数据源重复');
                    } else if (localMembers.length > 1) {
                        // 本地内部重复
                        comparison.conflicts.push({
                            type: 'local_duplicate',
                            uuid: uuid,
                            members: localMembers,
                            description: `UUID ${uuid} 在本地数据中存在重复`
                        });
                        console.log('本地内部重复');
                    } else if (firebaseMembers.length > 1) {
                        // Firebase内部重复
                        comparison.conflicts.push({
                            type: 'firebase_duplicate',
                            uuid: uuid,
                            members: firebaseMembers,
                            description: `UUID ${uuid} 在Firebase数据中存在重复`
                        });
                        console.log('Firebase内部重复');
                    }
                    
                    // 检查是否是同一人
                    const firstMember = members[0];
                    const isSamePerson = members.every(member => 
                        member.name === firstMember.name && 
                        member._groupName === firstMember._groupName
                    );
                    
                    console.log('是否同一人:', isSamePerson);
                    if (isSamePerson) {
                        console.log('判断为同一人重复记录');
                    } else {
                        console.log('判断为不同人使用相同UUID');
                    }
                }
            });
            
            // 按姓名分组分析（没有UUID的情况）
            console.log('\n=== 姓名分析 ===');
            const nameMap = new Map();
            
            // 添加所有成员到姓名映射
            [...localMembers, ...firebaseMembers].forEach(member => {
                if (!member.uuid && member.name) {
                    if (!nameMap.has(member.name)) {
                        nameMap.set(member.name, []);
                    }
                    nameMap.get(member.name).push(member);
                }
            });
            
            nameMap.forEach((members, name) => {
                if (members.length > 1) {
                    console.log(`\n姓名: ${name}`);
                    console.log('成员数量:', members.length);
                    console.log('成员详情:', members);
                    
                    const localMembers = members.filter(m => m._source === 'local');
                    const firebaseMembers = members.filter(m => m._source === 'firebase');
                    
                    if (localMembers.length > 0 && firebaseMembers.length > 0) {
                        comparison.conflicts.push({
                            type: 'name_cross_source',
                            name: name,
                            localMembers: localMembers,
                            firebaseMembers: firebaseMembers,
                            description: `姓名 ${name} 在本地和Firebase中都存在`
                        });
                        console.log('跨数据源同名');
                    }
                }
            });
            
            console.log('\n=== 对比结果统计 ===');
            console.log('仅本地存在:', comparison.localOnly.length);
            console.log('仅Firebase存在:', comparison.firebaseOnly.length);
            console.log('冲突数量:', comparison.conflicts.length);
            console.log('详细冲突列表:', comparison.conflicts);
            
            return comparison;
        }
        
        // 分析重复记录的详细信息
        function analyzeDuplicateRecord(conflict) {
            const existingMember = conflict.existingMember;
            const duplicateMember = conflict.duplicateMember;
            
            console.log('=== 重复记录详细分析 ===');
            console.log('现有成员:', existingMember);
            console.log('重复成员:', duplicateMember);
            
            // 检查数据来源
            let source = '未知';
            if (existingMember && duplicateMember) {
                // 检查是否来自不同数据源
                const existingSource = existingMember._source || 'unknown';
                const duplicateSource = duplicateMember._source || 'unknown';
                
                console.log('数据来源检查:', {
                    existingSource: existingSource,
                    duplicateSource: duplicateSource,
                    existingMember: existingMember,
                    duplicateMember: duplicateMember
                });
                
                if (existingSource === 'local' && duplicateSource === 'firebase') {
                    source = '本地数据与Firebase数据重复';
                } else if (existingSource === 'firebase' && duplicateSource === 'local') {
                    source = 'Firebase数据与本地数据重复';
                } else if (existingSource === 'local' && duplicateSource === 'local') {
                    source = '本地数据内部重复';
                } else if (existingSource === 'firebase' && duplicateSource === 'firebase') {
                    source = 'Firebase数据内部重复';
                } else {
                    // 详细分析数据来源
                    const existingDetails = analyzeDataSource(existingMember);
                    const duplicateDetails = analyzeDataSource(duplicateMember);
                    source = `数据来源分析: 现有记录(${existingDetails}) vs 重复记录(${duplicateDetails})`;
                }
            }
            
            // 统计该成员在本地和Firebase中的数量
            const memberCounts = countMemberInDataSources(conflict.uuid, conflict.name);
            
            // 检查重复类型
            let type = '未知';
            let details = '';
            
            // 添加统计信息
            details += `<strong>数据统计:</strong><br>
                        本地数据中: ${memberCounts.localCount} 条记录<br>
                        Firebase数据中: ${memberCounts.firebaseCount} 条记录<br>
                        总计: ${memberCounts.totalCount} 条记录<br><br>`;
            
            // 检查签到记录重复
            if (existingMember.attendanceRecords && duplicateMember.attendanceRecords) {
                const existingRecords = existingMember.attendanceRecords;
                const duplicateRecords = duplicateMember.attendanceRecords;
                
                console.log('现有成员签到记录:', existingRecords);
                console.log('重复成员签到记录:', duplicateRecords);
                
                // 检查同一天签到
                const sameDayRecords = [];
                existingRecords.forEach(existing => {
                    duplicateRecords.forEach(duplicate => {
                        if (existing.date === duplicate.date) {
                            sameDayRecords.push({
                                date: existing.date,
                                existingStatus: existing.status,
                                duplicateStatus: duplicate.status,
                                existingTime: existing.time,
                                duplicateTime: duplicate.time
                            });
                        }
                    });
                });
                
                if (sameDayRecords.length > 0) {
                    type = '同一天签到记录重复';
                    details = sameDayRecords.map(record => 
                        `日期: ${record.date}, 现有状态: ${record.existingStatus} (${record.existingTime}), 重复状态: ${record.duplicateStatus} (${record.duplicateTime})`
                    ).join('<br>');
                } else {
                    type = '不同日期签到记录重复';
                    details = `现有成员签到天数: ${existingRecords.length}, 重复成员签到天数: ${duplicateRecords.length}`;
                }
            } else if (existingMember.attendanceRecords || duplicateMember.attendanceRecords) {
                type = '部分签到记录重复';
                details = `现有成员签到记录: ${existingMember.attendanceRecords ? existingMember.attendanceRecords.length : 0} 条<br>
                          重复成员签到记录: ${duplicateMember.attendanceRecords ? duplicateMember.attendanceRecords.length : 0} 条`;
            } else {
                type = '基础信息重复';
                details += '仅基础成员信息重复，无签到记录';
            }
            
            // 检查其他字段差异
            const fieldDifferences = [];
            const fieldsToCheck = ['name', 'group', 'phone', 'email', 'joinDate', 'status', 'uuid', '_groupName'];
            
            // 详细对比两个成员的所有字段
            console.log('=== 详细字段对比 ===');
            console.log('现有成员完整数据:', existingMember);
            console.log('重复成员完整数据:', duplicateMember);
            
            fieldsToCheck.forEach(field => {
                const existingValue = existingMember[field];
                const duplicateValue = duplicateMember[field];
                
                console.log(`字段 ${field}: 现有值="${existingValue}", 重复值="${duplicateValue}"`);
                
                if (existingValue !== duplicateValue) {
                    fieldDifferences.push(`${field}: 现有值="${existingValue}", 重复值="${duplicateValue}"`);
                }
            });
            
            // 检查所有字段（包括动态字段）
            const allFields = new Set([...Object.keys(existingMember), ...Object.keys(duplicateMember)]);
            console.log('所有字段:', Array.from(allFields));
            
            allFields.forEach(field => {
                if (!fieldsToCheck.includes(field)) {
                    const existingValue = existingMember[field];
                    const duplicateValue = duplicateMember[field];
                    
                    if (existingValue !== duplicateValue) {
                        fieldDifferences.push(`${field}: 现有值="${existingValue}", 重复值="${duplicateValue}"`);
                        console.log(`额外字段差异 ${field}: 现有值="${existingValue}", 重复值="${duplicateValue}"`);
                    }
                }
            });
            
            if (fieldDifferences.length > 0) {
                details += '<br><strong>字段差异:</strong><br>' + fieldDifferences.join('<br>');
                console.log('发现字段差异:', fieldDifferences);
            } else {
                details += '<br><strong>字段对比:</strong> 所有字段完全一致';
                console.log('所有字段完全一致');
            }
            
            console.log('分析结果:', { source, type, details });
            
            return { source, type, details };
        }
        
        // 检查是否只是数据来源不同
        function checkIfOnlySourceDifferent(member1, member2) {
            console.log('检查是否只是数据来源不同:', member1, member2);
            
            // 获取所有字段（排除来源标识字段）
            const excludeFields = ['_source', '_groupName', '_originalData'];
            const allFields = new Set([...Object.keys(member1), ...Object.keys(member2)]);
            
            let hasRealDifference = false;
            
            allFields.forEach(field => {
                if (!excludeFields.includes(field)) {
                    const value1 = member1[field];
                    const value2 = member2[field];
                    
                    console.log(`检查字段 ${field}: "${value1}" vs "${value2}"`);
                    
                    if (value1 !== value2) {
                        console.log(`发现真实差异: ${field} = "${value1}" vs "${value2}"`);
                        hasRealDifference = true;
                    }
                }
            });
            
            const isOnlySourceDifferent = !hasRealDifference;
            console.log('是否只是来源不同:', isOnlySourceDifferent);
            
            return isOnlySourceDifferent;
        }
        
        // 分析小组名称冲突的详细信息
        function analyzeGroupNameConflict(conflict) {
            console.log('=== 小组名称冲突详细分析 ===');
            console.log('冲突对象:', conflict);
            
            const members = conflict.members || [];
            if (members.length < 2) {
                return {
                    type: '数据不完整',
                    details: '无法分析冲突详情',
                    solution: '请检查数据完整性'
                };
            }
            
            const member1 = members[0];
            const member2 = members[1];
            
            console.log('成员1:', member1);
            console.log('成员2:', member2);
            
            // 分析数据来源
            const source1 = member1._source || 'unknown';
            const source2 = member2._source || 'unknown';
            const group1 = member1.group || member1._groupName || '未知小组';
            const group2 = member2.group || member2._groupName || '未知小组';
            
            console.log('数据来源分析:', {
                member1: { source: source1, group: group1 },
                member2: { source: source2, group: group2 }
            });
            
            let type = '未知冲突';
            let details = '';
            let solution = '';
            
            if (source1 === 'local' && source2 === 'firebase') {
                type = '本地与Firebase小组不一致';
                details = `
                    本地数据: ${member1.name} 在小组 "${group1}"<br>
                    Firebase数据: ${member2.name} 在小组 "${group2}"<br>
                    <strong>问题:</strong> 同一成员在本地和Firebase中被分配到不同小组
                `;
                solution = '建议统一小组分配，以最新数据为准或手动调整';
            } else if (source1 === 'firebase' && source2 === 'local') {
                type = 'Firebase与本地小组不一致';
                details = `
                    Firebase数据: ${member1.name} 在小组 "${group1}"<br>
                    本地数据: ${member2.name} 在小组 "${group2}"<br>
                    <strong>问题:</strong> 同一成员在Firebase和本地中被分配到不同小组
                `;
                solution = '建议统一小组分配，以最新数据为准或手动调整';
            } else if (source1 === 'local' && source2 === 'local') {
                type = '本地数据内部小组冲突';
                details = `
                    本地记录1: ${member1.name} 在小组 "${group1}"<br>
                    本地记录2: ${member2.name} 在小组 "${group2}"<br>
                    <strong>问题:</strong> 本地数据中存在重复记录，小组分配不一致
                `;
                solution = '建议合并重复记录，保留一个记录';
            } else if (source1 === 'firebase' && source2 === 'firebase') {
                type = 'Firebase数据内部小组冲突';
                details = `
                    Firebase记录1: ${member1.name} 在小组 "${group1}"<br>
                    Firebase记录2: ${member2.name} 在小组 "${group2}"<br>
                    <strong>问题:</strong> Firebase数据中存在重复记录，小组分配不一致
                `;
                solution = '建议在Firebase中合并重复记录';
            } else {
                type = '未知数据源冲突';
                details = `
                    记录1: ${member1.name} (来源: ${source1}) 在小组 "${group1}"<br>
                    记录2: ${member2.name} (来源: ${source2}) 在小组 "${group2}"<br>
                    <strong>问题:</strong> 数据来源不明确，小组分配不一致
                `;
                solution = '建议检查数据来源和同步状态';
            }
            
            // 添加UUID信息
            if (member1.uuid && member2.uuid) {
                details += `<br><strong>UUID信息:</strong><br>
                            记录1 UUID: ${member1.uuid}<br>
                            记录2 UUID: ${member2.uuid}`;
                
                if (member1.uuid === member2.uuid) {
                    details += '<br><strong>UUID状态:</strong> 相同UUID，确认是同一人';
                } else {
                    details += '<br><strong>UUID状态:</strong> 不同UUID，可能是不同的人';
                }
            }
            
            console.log('分析结果:', { type, details, solution });
            
            return { type, details, solution };
        }
        
        // 分析签到记录冲突的详细信息
        function analyzeAttendanceConflict(conflict) {
            console.log('=== 签到记录冲突详细分析 ===');
            console.log('冲突对象:', conflict);
            
            const localRecord = conflict.localRecord;
            const firebaseRecord = conflict.firebaseRecord;
            
            if (!localRecord || !firebaseRecord) {
                return {
                    type: '数据不完整',
                    details: '无法分析冲突详情',
                    solution: '请检查数据完整性'
                };
            }
            
            console.log('本地记录:', localRecord);
            console.log('Firebase记录:', firebaseRecord);
            
            // 收集所有字段进行对比
            const allFields = new Set([...Object.keys(localRecord), ...Object.keys(firebaseRecord)]);
            const fieldDifferences = [];
            
            console.log('所有字段:', Array.from(allFields));
            
            allFields.forEach(field => {
                const localValue = localRecord[field];
                const firebaseValue = firebaseRecord[field];
                
                console.log(`字段 ${field}: 本地="${localValue}", Firebase="${firebaseValue}"`);
                
                if (localValue !== firebaseValue) {
                    fieldDifferences.push({
                        field: field,
                        localValue: localValue,
                        firebaseValue: firebaseValue
                    });
                }
            });
            
            console.log('字段差异:', fieldDifferences);
            
            let type = '签到记录不一致';
            let details = '';
            let solution = '';
            
            if (fieldDifferences.length === 0) {
                type = '记录完全一致';
                details = '本地和Firebase记录完全相同，可能是检测逻辑问题';
                solution = '建议检查冲突检测逻辑';
            } else {
                // 构建详细信息
                details = '<strong>字段差异对比:</strong><br>';
                fieldDifferences.forEach(diff => {
                    details += `${diff.field}: 本地="${diff.localValue}" vs Firebase="${diff.firebaseValue}"<br>`;
                });
                
                // 分析具体的冲突类型
                const nameConflict = fieldDifferences.find(diff => diff.field === 'name');
                const timeConflict = fieldDifferences.find(diff => diff.field === 'time' || diff.field === 'date');
                const groupConflict = fieldDifferences.find(diff => diff.field === 'group');
                const statusConflict = fieldDifferences.find(diff => diff.field === 'status');
                
                if (nameConflict) {
                    type = '姓名不一致';
                    solution = '建议统一成员姓名，以最新数据为准';
                } else if (timeConflict) {
                    type = '签到时间不一致';
                    solution = '建议以最新签到时间为准，或手动确认正确时间';
                } else if (groupConflict) {
                    type = '小组归属不一致';
                    solution = '建议统一小组归属，以最新数据为准';
                } else if (statusConflict) {
                    type = '签到状态不一致';
                    solution = '建议以最新签到状态为准，或手动确认正确状态';
                } else {
                    type = '其他字段不一致';
                    solution = '建议以最新数据为准，或手动确认正确信息';
                }
                
                // 添加记录摘要
                details += '<br><strong>记录摘要:</strong><br>';
                details += `本地记录: ${localRecord.name || 'N/A'} 在 ${localRecord.time || localRecord.date || 'N/A'} 签到到小组 ${localRecord.group || 'N/A'}<br>`;
                details += `Firebase记录: ${firebaseRecord.name || 'N/A'} 在 ${firebaseRecord.time || firebaseRecord.date || 'N/A'} 签到到小组 ${firebaseRecord.group || 'N/A'}`;
            }
            
            console.log('分析结果:', { type, details, solution });
            
            return { type, details, solution };
        }
        
        // 统计成员在数据源中的数量
        function countMemberInDataSources(uuid, name) {
            console.log(`统计成员 ${name} (${uuid}) 在数据源中的数量`);
            
            const counts = {
                localCount: 0,
                firebaseCount: 0,
                totalCount: 0
            };
            
            // 统计本地数据
            try {
                const localGroups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                console.log('本地小组数据:', localGroups);
                Object.entries(localGroups).forEach(([groupName, members]) => {
                    if (Array.isArray(members)) {
                        console.log(`检查本地小组 ${groupName}:`, members);
                        members.forEach(member => {
                            if (member && member.uuid === uuid && member.name === name) {
                                counts.localCount++;
                                console.log(`本地发现: ${member.name} (${member.uuid}) 在小组 ${groupName}`);
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('统计本地数据时出错:', error);
            }
            
            // 统计Firebase数据
            try {
                console.log('Firebase小组数据:', window.firebaseGroups);
                const firebaseGroups = window.firebaseGroups || {};
                Object.entries(firebaseGroups).forEach(([groupName, members]) => {
                    if (Array.isArray(members)) {
                        console.log(`检查Firebase小组 ${groupName}:`, members);
                        members.forEach(member => {
                            if (member && member.uuid === uuid && member.name === name) {
                                counts.firebaseCount++;
                                console.log(`Firebase发现: ${member.name} (${member.uuid}) 在小组 ${groupName}`);
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('统计Firebase数据时出错:', error);
            }
            
            counts.totalCount = counts.localCount + counts.firebaseCount;
            
            console.log('统计结果:', counts);
            return counts;
        }
        
        // 分析数据来源
        function analyzeDataSource(member) {
            if (!member) return '无数据';
            
            console.log('分析成员数据来源:', member);
            
            // 检查是否有_source标识
            if (member._source) {
                return `${member._source} (${member._groupName || '未知小组'})`;
            }
            
            // 通过其他特征判断数据来源
            const indicators = [];
            
            // 检查是否有Firebase特有的字段
            if (member.firebaseId || member.firebaseKey) {
                indicators.push('Firebase特征');
            }
            
            // 检查是否有本地存储特有的字段
            if (member.localId || member.localKey) {
                indicators.push('本地特征');
            }
            
            // 检查时间戳格式
            if (member.createdAt || member.updatedAt) {
                const timestamp = member.createdAt || member.updatedAt;
                if (typeof timestamp === 'number' && timestamp > 1000000000000) {
                    indicators.push('Firebase时间戳');
                } else if (typeof timestamp === 'string' && timestamp.includes('T')) {
                    indicators.push('ISO时间格式');
                }
            }
            
            // 检查数据结构特征
            if (member.attendanceRecords && Array.isArray(member.attendanceRecords)) {
                indicators.push('包含签到记录');
            }
            
            // 检查UUID格式
            if (member.uuid) {
                if (member.uuid.length === 36 && member.uuid.includes('-')) {
                    indicators.push('标准UUID格式');
                } else {
                    indicators.push('非标准UUID格式');
                }
            }
            
            // 检查小组信息
            if (member.group || member._groupName) {
                indicators.push(`小组: ${member.group || member._groupName}`);
            }
            
            // 检查数据完整性
            const hasAllFields = member.name && member.uuid && (member.group || member._groupName);
            if (hasAllFields) {
                indicators.push('数据完整');
            } else {
                indicators.push('数据不完整');
            }
            
            // 检查是否有额外的元数据
            const hasMetadata = member.lastModified || member.version || member.syncStatus;
            if (hasMetadata) {
                indicators.push('包含元数据');
            }
            
            // 检查数据新鲜度（通过时间戳判断）
            if (member.createdAt || member.updatedAt) {
                const timestamp = new Date(member.createdAt || member.updatedAt);
                const now = new Date();
                const diffHours = (now - timestamp) / (1000 * 60 * 60);
                if (diffHours < 24) {
                    indicators.push('最近更新');
                } else {
                    indicators.push('较旧数据');
                }
            }
            
            console.log('数据来源特征:', indicators);
            
            return indicators.length > 0 ? indicators.join(', ') : '未知来源';
        }
        
        // 分析冲突类型统计
        function analyzeConflictTypes(conflicts) {
            const stats = {
                uuid_conflict: 0,
                duplicate_record: 0,
                uuid: 0,
                group_name: 0,
                data_inconsistency: 0,
                attendance_conflict: 0,
                attendance_missing: 0,
                attendance_extra: 0
            };
            
            conflicts.forEach(conflict => {
                if (stats.hasOwnProperty(conflict.type)) {
                    stats[conflict.type]++;
                } else {
                    // 统计未知类型的冲突
                    if (!stats.unknown) stats.unknown = 0;
                    stats.unknown++;
                }
            });
            
            return stats;
        }
        
        // 解决冲突
        function resolveConflict(index) {
            if (index >= 0 && index < detectedConflicts.length) {
                const conflict = detectedConflicts[index];
                showConflictResolutionDialog(conflict, index);
            }
        }
        
        // 忽略冲突
        function ignoreConflict(index) {
            if (index >= 0 && index < detectedConflicts.length) {
                detectedConflicts.splice(index, 1);
                displayConflicts(detectedConflicts);
            }
        }
        
        // 显示冲突解决对话框
        function showConflictResolutionDialog(conflict, index) {
            const dialog = document.getElementById('conflictResolutionDialog');
            const title = document.getElementById('conflictResolutionTitle');
            const body = document.getElementById('conflictResolutionBody');
            
            if (!dialog || !title || !body) return;
            
            title.textContent = `解决冲突: ${conflict.description}`;
            
            let html = '';
            switch (conflict.type) {
                case 'uuid':
                    html = `
                        <div class="conflict-resolution-options">
                            <label>
                                <input type="radio" name="resolution" value="keep_first" checked>
                                保留第一个成员
                            </label>
                            <label>
                                <input type="radio" name="resolution" value="keep_second">
                                保留第二个成员
                            </label>
                            <label>
                                <input type="radio" name="resolution" value="generate_new">
                                为第二个成员生成新UUID
                            </label>
                        </div>
                    `;
                    break;
                case 'group_name':
                    html = `
                        <div class="conflict-resolution-options">
                            <label>
                                <input type="radio" name="resolution" value="keep_local" checked>
                                保留本地数据
                            </label>
                            <label>
                                <input type="radio" name="resolution" value="keep_firebase">
                                保留Firebase数据
                            </label>
                            <label>
                                <input type="radio" name="resolution" value="merge">
                                合并数据
                            </label>
                        </div>
                    `;
                    break;
                case 'data_inconsistency':
                    html = `
                        <div class="conflict-resolution-options">
                            <label>
                                <input type="radio" name="resolution" value="sync_local" checked>
                                同步本地数据到Firebase
                            </label>
                            <label>
                                <input type="radio" name="resolution" value="sync_firebase">
                                从Firebase同步数据到本地
                            </label>
                        </div>
                    `;
                    break;
            }
            
            body.innerHTML = html;
            currentConflictIndex = index;
            dialog.style.display = 'block';
        }
        
        // 应用冲突解决方案
        function applyConflictResolution() {
            const selectedResolution = document.querySelector('input[name="resolution"]:checked');
            if (!selectedResolution) {
                alert('请选择一个解决方案');
                return;
            }
            
            const conflict = detectedConflicts[currentConflictIndex];
            const resolution = selectedResolution.value;
            
            console.log('应用解决方案:', { conflict, resolution });
            
            // 这里应该实现具体的解决逻辑
            alert(`已应用解决方案: ${resolution}`);
            
            // 移除已解决的冲突
            detectedConflicts.splice(currentConflictIndex, 1);
            displayConflicts(detectedConflicts);
            closeConflictResolution();
        }
        
        // 关闭冲突解决对话框
        function closeConflictResolution() {
            const dialog = document.getElementById('conflictResolutionDialog');
            if (dialog) {
                dialog.style.display = 'none';
            }
        }
        
        // 解决所有冲突
        async function resolveAllConflicts() {
            if (detectedConflicts.length === 0) {
                alert('没有需要解决的冲突');
                return;
            }
            
            if (confirm(`确定要自动解决所有 ${detectedConflicts.length} 个冲突吗？\n\n这将执行以下操作：\n1. UUID冲突：为重复成员生成新UUID\n2. 小组名称冲突：保留本地数据\n3. 数据不一致：同步本地数据到Firebase`)) {
                await batchResolveConflicts();
            }
        }
        
        // 批量解决冲突
        async function batchResolveConflicts() {
            console.log('开始批量解决冲突...');
            const totalConflicts = detectedConflicts.length;
            let resolvedCount = 0;
            
            // 显示进度
            const progressDialog = showProgressDialog(totalConflicts);
            
            try {
                // 按类型分组处理冲突
                const uuidConflicts = detectedConflicts.filter(c => c.type === 'uuid');
                const groupNameConflicts = detectedConflicts.filter(c => c.type === 'group_name');
                const dataInconsistencyConflicts = detectedConflicts.filter(c => c.type === 'data_inconsistency');
                
                // 处理UUID冲突
                console.log(`处理 ${uuidConflicts.length} 个UUID冲突...`);
                for (const conflict of uuidConflicts) {
                    await resolveUUIDConflict(conflict);
                    resolvedCount++;
                    updateProgress(progressDialog, resolvedCount, totalConflicts);
                    await new Promise(resolve => setTimeout(resolve, 100)); // 避免阻塞UI
                }
                
                // 处理小组名称冲突
                console.log(`处理 ${groupNameConflicts.length} 个小组名称冲突...`);
                for (const conflict of groupNameConflicts) {
                    await resolveGroupNameConflict(conflict);
                    resolvedCount++;
                    updateProgress(progressDialog, resolvedCount, totalConflicts);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // 处理数据不一致冲突
                console.log(`处理 ${dataInconsistencyConflicts.length} 个数据不一致冲突...`);
                for (const conflict of dataInconsistencyConflicts) {
                    await resolveDataInconsistencyConflict(conflict);
                    resolvedCount++;
                    updateProgress(progressDialog, resolvedCount, totalConflicts);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // 完成批量解决
                closeProgressDialog(progressDialog);
                alert(`✅ 批量解决完成！\n\n已解决 ${resolvedCount} 个冲突\n剩余 ${totalConflicts - resolvedCount} 个冲突`);
                
                // 重新检测冲突
                await detectConflicts();
                
            } catch (error) {
                console.error('批量解决冲突时出错:', error);
                closeProgressDialog(progressDialog);
                alert('批量解决冲突时出错: ' + error.message);
            }
        }
        
        // 解决UUID冲突
        async function resolveUUIDConflict(conflict) {
            // 为第二个成员生成新UUID
            if (conflict.members && conflict.members.length >= 2) {
                const secondMember = conflict.members[1];
                const newUUID = generateUUID();
                
                // 更新本地数据
                const localGroups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                Object.keys(localGroups).forEach(groupName => {
                    const group = localGroups[groupName];
                    if (Array.isArray(group)) {
                        group.forEach(member => {
                            if (member.uuid === secondMember.uuid && member.name === secondMember.name) {
                                member.uuid = newUUID;
                                console.log(`为成员 ${member.name} 生成新UUID: ${newUUID}`);
                            }
                        });
                    }
                });
                
                localStorage.setItem('msh_groups', JSON.stringify(localGroups));
            }
        }
        
        // 解决小组名称冲突
        async function resolveGroupNameConflict(conflict) {
            // 保留本地数据，同步到Firebase
            if (conflict.members && conflict.members.length >= 2) {
                const localMember = conflict.members.find(m => m.group && m.group !== 'undefined');
                if (localMember) {
                    console.log(`保留本地成员数据: ${localMember.name} 在 ${localMember.group}`);
                    // 这里可以添加同步到Firebase的逻辑
                }
            }
        }
        
        // 解决数据不一致冲突
        async function resolveDataInconsistencyConflict(conflict) {
            // 同步本地数据到Firebase
            if (conflict.localCount > conflict.firebaseCount) {
                console.log(`同步本地数据到Firebase: ${conflict.groupName}`);
                // 这里可以添加同步到Firebase的逻辑
            }
        }
        
        // 生成UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // 显示进度对话框
        function showProgressDialog(total) {
            const dialog = document.createElement('div');
            dialog.className = 'progress-dialog';
            dialog.innerHTML = `
                <div class="progress-content">
                    <h3>🔄 批量解决冲突中...</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text">0 / ${total}</div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            return dialog;
        }
        
        // 更新进度
        function updateProgress(dialog, current, total) {
            const progressFill = dialog.querySelector('.progress-fill');
            const progressText = dialog.querySelector('.progress-text');
            const percentage = (current / total) * 100;
            
            if (progressFill) progressFill.style.width = percentage + '%';
            if (progressText) progressText.textContent = `${current} / ${total}`;
        }
        
        // 关闭进度对话框
        function closeProgressDialog(dialog) {
            if (dialog && dialog.parentNode) {
                dialog.parentNode.removeChild(dialog);
            }
        }
        
        // 清空外部表单数据
        function clearExternalFormData() {
            if (confirm('确定要清空外部表单数据吗？此操作不可撤销！')) {
                // 这里应该实现清空外部表单数据的逻辑
                alert('清空外部表单数据功能正在开发中');
            }
        }
        
        // 对比签到记录
        async function compareAttendanceRecords() {
            console.log('开始对比签到记录...');
            
            try {
                // 获取本地签到记录
                const localAttendanceRecords = JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]');
                
                // 获取Firebase签到记录
                const db = firebase.database();
                const firebaseAttendanceRecords = await db.ref('attendanceRecords').once('value').then(snapshot => {
                    const data = snapshot.val();
                    return Array.isArray(data) ? data : (data ? Object.values(data) : []);
                });
                
                console.log('本地签到记录数量:', localAttendanceRecords.length);
                console.log('Firebase签到记录数量:', firebaseAttendanceRecords.length);
                
                // 详细对比分析
                const comparison = performDetailedAttendanceComparison(localAttendanceRecords, firebaseAttendanceRecords);
                
                // 显示对比结果
                displayAttendanceComparison(comparison);
                
            } catch (error) {
                console.error('对比签到记录时出错:', error);
                alert('对比签到记录时出错: ' + error.message);
            }
        }
        
        // 详细签到记录对比分析
        function performDetailedAttendanceComparison(localRecords, firebaseRecords) {
            console.log('\n=== 详细签到记录对比分析 ===');
            
            const comparison = {
                localOnly: [],
                firebaseOnly: [],
                matched: [],
                conflicts: [],
                summary: {
                    localCount: localRecords.length,
                    firebaseCount: firebaseRecords.length,
                    matchedCount: 0,
                    conflictCount: 0,
                    localOnlyCount: 0,
                    firebaseOnlyCount: 0
                }
            };
            
            // 创建本地记录映射
            const localRecordMap = new Map();
            localRecords.forEach((record, index) => {
                if (record && record.name) {
                    const key = `${record.name}_${record.time || record.date}`;
                    localRecordMap.set(key, { ...record, _index: index, _source: 'local' });
                }
            });
            
            // 创建Firebase记录映射
            const firebaseRecordMap = new Map();
            firebaseRecords.forEach((record, index) => {
                if (record && record.name) {
                    const key = `${record.name}_${record.time || record.date}`;
                    firebaseRecordMap.set(key, { ...record, _index: index, _source: 'firebase' });
                }
            });
            
            console.log('本地记录映射:', localRecordMap);
            console.log('Firebase记录映射:', firebaseRecordMap);
            
            // 检查匹配的记录
            localRecordMap.forEach((localRecord, key) => {
                const firebaseRecord = firebaseRecordMap.get(key);
                
                if (firebaseRecord) {
                    // 找到匹配记录，检查内容是否一致
                    const isContentSame = JSON.stringify({
                        name: localRecord.name,
                        group: localRecord.group,
                        time: localRecord.time,
                        date: localRecord.date,
                        status: localRecord.status,
                        timeSlot: localRecord.timeSlot
                    }) === JSON.stringify({
                        name: firebaseRecord.name,
                        group: firebaseRecord.group,
                        time: firebaseRecord.time,
                        date: firebaseRecord.date,
                        status: firebaseRecord.status,
                        timeSlot: firebaseRecord.timeSlot
                    });
                    
                    if (isContentSame) {
                        comparison.matched.push({
                            key: key,
                            localRecord: localRecord,
                            firebaseRecord: firebaseRecord,
                            status: '一致'
                        });
                        comparison.summary.matchedCount++;
                    } else {
                        // 内容不一致，记录冲突
                        const fieldDifferences = [];
                        const allFields = new Set([...Object.keys(localRecord), ...Object.keys(firebaseRecord)]);
                        
                        allFields.forEach(field => {
                            if (!['_index', '_source'].includes(field)) {
                                const localValue = localRecord[field];
                                const firebaseValue = firebaseRecord[field];
                                
                                if (localValue !== firebaseValue) {
                                    fieldDifferences.push({
                                        field: field,
                                        localValue: localValue,
                                        firebaseValue: firebaseValue
                                    });
                                }
                            }
                        });
                        
                        comparison.conflicts.push({
                            key: key,
                            localRecord: localRecord,
                            firebaseRecord: firebaseRecord,
                            status: '冲突',
                            fieldDifferences: fieldDifferences
                        });
                        comparison.summary.conflictCount++;
                    }
                } else {
                    // 本地有但Firebase没有
                    comparison.localOnly.push(localRecord);
                    comparison.summary.localOnlyCount++;
                }
            });
            
            // 检查Firebase有但本地没有的记录
            firebaseRecordMap.forEach((firebaseRecord, key) => {
                if (!localRecordMap.has(key)) {
                    comparison.firebaseOnly.push(firebaseRecord);
                    comparison.summary.firebaseOnlyCount++;
                }
            });
            
            console.log('对比结果:', comparison);
            return comparison;
        }
        
        // 显示签到记录对比结果
        function displayAttendanceComparison(comparison) {
            const container = document.getElementById('conflictResults');
            if (!container) return;
            
            const { summary } = comparison;
            const totalInconsistencies = summary.conflictCount + summary.localOnlyCount + summary.firebaseOnlyCount;
            
            let html = `
                <div class="attendance-comparison">
                    <h3>📋 签到记录不一致报告</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${summary.localCount}</div>
                            <div class="stat-label">本地记录数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.firebaseCount}</div>
                            <div class="stat-label">Firebase记录数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.matchedCount}</div>
                            <div class="stat-label">完全一致</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalInconsistencies}</div>
                            <div class="stat-label">总不一致数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.conflictCount}</div>
                            <div class="stat-label">内容冲突</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.localOnlyCount}</div>
                            <div class="stat-label">仅本地有</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.firebaseOnlyCount}</div>
                            <div class="stat-label">仅Firebase有</div>
                        </div>
                    </div>
            `;
            
            if (totalInconsistencies === 0) {
                html += `
                    <div class="no-conflicts">
                        <h4>✅ 所有签到记录完全一致</h4>
                        <p>本地和Firebase的签到记录完全匹配，没有发现任何不一致。</p>
                    </div>
                `;
            } else {
                // 显示内容冲突记录
                if (comparison.conflicts.length > 0) {
                    html += `
                        <div class="conflicts-section">
                            <h4>⚠️ 内容冲突记录 (${comparison.conflicts.length} 条)</h4>
                    `;
                    
                    comparison.conflicts.forEach((conflict, index) => {
                        html += `
                            <div class="conflict-item">
                                <div class="conflict-header">
                                    <span class="conflict-type medium">内容冲突</span>
                                    <span class="conflict-description">${conflict.localRecord.name} - ${conflict.localRecord.time || conflict.localRecord.date}</span>
                                </div>
                                <div class="conflict-details">
                                    <div class="conflict-detail-item">
                                        <strong>字段差异:</strong><br>
                                        ${conflict.fieldDifferences.map(diff => 
                                            `${diff.field}: 本地="${diff.localValue}" vs Firebase="${diff.firebaseValue}"`
                                        ).join('<br>')}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // 显示仅本地有的记录
                if (comparison.localOnly.length > 0) {
                    html += `
                        <div class="local-only-section">
                            <h4>📱 仅本地有的记录 (${comparison.localOnly.length} 条)</h4>
                    `;
                    
                    comparison.localOnly.forEach(record => {
                        html += `
                            <div class="record-item">
                                <strong>${record.name}</strong> - ${record.time || record.date} - 小组: ${record.group || '未知'}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // 显示仅Firebase有的记录
                if (comparison.firebaseOnly.length > 0) {
                    html += `
                        <div class="firebase-only-section">
                            <h4>☁️ 仅Firebase有的记录 (${comparison.firebaseOnly.length} 条)</h4>
                    `;
                    
                    comparison.firebaseOnly.forEach(record => {
                        html += `
                            <div class="record-item">
                                <strong>${record.name}</strong> - ${record.time || record.date} - 小组: ${record.group || '未知'}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // 对比成员信息
        async function compareMemberRecords() {
            console.log('开始对比成员信息...');
            
            try {
                // 获取本地成员数据
                const localGroups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                const localGroupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
                
                // 获取Firebase成员数据
                const db = firebase.database();
                const firebaseGroups = await db.ref('groups').once('value').then(snapshot => snapshot.val() || {});
                const firebaseGroupNames = await db.ref('groupNames').once('value').then(snapshot => snapshot.val() || {});
                
                console.log('本地小组数量:', Object.keys(localGroups).length);
                console.log('Firebase小组数量:', Object.keys(firebaseGroups).length);
                
                // 详细对比分析
                const comparison = performDetailedMemberComparison(localGroups, firebaseGroups, localGroupNames, firebaseGroupNames);
                
                // 显示对比结果
                displayMemberComparison(comparison);
                
            } catch (error) {
                console.error('对比成员信息时出错:', error);
                alert('对比成员信息时出错: ' + error.message);
            }
        }
        
        // 详细成员信息对比分析
        function performDetailedMemberComparison(localGroups, firebaseGroups, localGroupNames, firebaseGroupNames) {
            console.log('\n=== 详细成员信息对比分析 ===');
            
            const comparison = {
                localOnly: [],
                firebaseOnly: [],
                matched: [],
                conflicts: [],
                summary: {
                    localMemberCount: 0,
                    firebaseMemberCount: 0,
                    matchedCount: 0,
                    conflictCount: 0,
                    localOnlyCount: 0,
                    firebaseOnlyCount: 0
                }
            };
            
            // 收集所有本地成员
            const localMembers = [];
            Object.entries(localGroups).forEach(([groupKey, members]) => {
                if (Array.isArray(members)) {
                    members.forEach(member => {
                        if (member && member.name) {
                            localMembers.push({
                                ...member,
                                _groupKey: groupKey,
                                _groupName: localGroupNames[groupKey] || groupKey,
                                _source: 'local'
                            });
                        }
                    });
                }
            });
            
            // 收集所有Firebase成员
            const firebaseMembers = [];
            Object.entries(firebaseGroups).forEach(([groupKey, members]) => {
                if (Array.isArray(members)) {
                    members.forEach(member => {
                        if (member && member.name) {
                            firebaseMembers.push({
                                ...member,
                                _groupKey: groupKey,
                                _groupName: firebaseGroupNames[groupKey] || groupKey,
                                _source: 'firebase'
                            });
                        }
                    });
                }
            });
            
            comparison.summary.localMemberCount = localMembers.length;
            comparison.summary.firebaseMemberCount = firebaseMembers.length;
            
            console.log('本地成员总数:', localMembers.length);
            console.log('Firebase成员总数:', firebaseMembers.length);
            
            // 创建本地成员映射（按UUID）
            const localMemberMap = new Map();
            localMembers.forEach(member => {
                if (member.uuid) {
                    localMemberMap.set(member.uuid, member);
                }
            });
            
            // 创建Firebase成员映射（按UUID）
            const firebaseMemberMap = new Map();
            firebaseMembers.forEach(member => {
                if (member.uuid) {
                    firebaseMemberMap.set(member.uuid, member);
                }
            });
            
            console.log('本地成员映射:', localMemberMap);
            console.log('Firebase成员映射:', firebaseMemberMap);
            
            // 检查匹配的成员
            localMemberMap.forEach((localMember, uuid) => {
                const firebaseMember = firebaseMemberMap.get(uuid);
                
                if (firebaseMember) {
                    // 找到匹配成员，检查内容是否一致
                    const isContentSame = JSON.stringify({
                        name: localMember.name,
                        group: localMember.group,
                        phone: localMember.phone,
                        email: localMember.email,
                        joinDate: localMember.joinDate,
                        status: localMember.status,
                        _groupName: localMember._groupName
                    }) === JSON.stringify({
                        name: firebaseMember.name,
                        group: firebaseMember.group,
                        phone: firebaseMember.phone,
                        email: firebaseMember.email,
                        joinDate: firebaseMember.joinDate,
                        status: firebaseMember.status,
                        _groupName: firebaseMember._groupName
                    });
                    
                    if (isContentSame) {
                        comparison.matched.push({
                            uuid: uuid,
                            localMember: localMember,
                            firebaseMember: firebaseMember,
                            status: '一致'
                        });
                        comparison.summary.matchedCount++;
                    } else {
                        // 内容不一致，记录冲突
                        const fieldDifferences = [];
                        const allFields = new Set([...Object.keys(localMember), ...Object.keys(firebaseMember)]);
                        
                        allFields.forEach(field => {
                            if (!['_groupKey', '_source'].includes(field)) {
                                const localValue = localMember[field];
                                const firebaseValue = firebaseMember[field];
                                
                                if (localValue !== firebaseValue) {
                                    fieldDifferences.push({
                                        field: field,
                                        localValue: localValue,
                                        firebaseValue: firebaseValue
                                    });
                                }
                            }
                        });
                        
                        comparison.conflicts.push({
                            uuid: uuid,
                            localMember: localMember,
                            firebaseMember: firebaseMember,
                            status: '冲突',
                            fieldDifferences: fieldDifferences
                        });
                        comparison.summary.conflictCount++;
                    }
                } else {
                    // 本地有但Firebase没有
                    comparison.localOnly.push(localMember);
                    comparison.summary.localOnlyCount++;
                }
            });
            
            // 检查Firebase有但本地没有的成员
            firebaseMemberMap.forEach((firebaseMember, uuid) => {
                if (!localMemberMap.has(uuid)) {
                    comparison.firebaseOnly.push(firebaseMember);
                    comparison.summary.firebaseOnlyCount++;
                }
            });
            
            console.log('对比结果:', comparison);
            return comparison;
        }
        
        // 显示成员信息对比结果
        function displayMemberComparison(comparison) {
            const container = document.getElementById('conflictResults');
            if (!container) return;
            
            const { summary } = comparison;
            const totalInconsistencies = summary.conflictCount + summary.localOnlyCount + summary.firebaseOnlyCount;
            
            let html = `
                <div class="member-comparison">
                    <h3>👥 成员信息不一致报告</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${summary.localMemberCount}</div>
                            <div class="stat-label">本地成员数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.firebaseMemberCount}</div>
                            <div class="stat-label">Firebase成员数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.matchedCount}</div>
                            <div class="stat-label">完全一致</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalInconsistencies}</div>
                            <div class="stat-label">总不一致数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.conflictCount}</div>
                            <div class="stat-label">内容冲突</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.localOnlyCount}</div>
                            <div class="stat-label">仅本地有</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.firebaseOnlyCount}</div>
                            <div class="stat-label">仅Firebase有</div>
                        </div>
                    </div>
            `;
            
            if (totalInconsistencies === 0) {
                html += `
                    <div class="no-conflicts">
                        <h4>✅ 所有成员信息完全一致</h4>
                        <p>本地和Firebase的成员信息完全匹配，没有发现任何不一致。</p>
                    </div>
                `;
            } else {
                // 显示内容冲突记录
                if (comparison.conflicts.length > 0) {
                    html += `
                        <div class="conflicts-section">
                            <h4>⚠️ 成员信息冲突记录 (${comparison.conflicts.length} 条)</h4>
                    `;
                    
                    comparison.conflicts.forEach((conflict, index) => {
                        html += `
                            <div class="conflict-item">
                                <div class="conflict-header">
                                    <span class="conflict-type medium">信息冲突</span>
                                    <span class="conflict-description">${conflict.localMember.name} (${conflict.localMember._groupName})</span>
                                </div>
                                <div class="conflict-details">
                                    <div class="conflict-detail-item">
                                        <strong>UUID:</strong> ${conflict.uuid}<br>
                                        <strong>字段差异:</strong><br>
                                        ${conflict.fieldDifferences.map(diff => 
                                            `${diff.field}: 本地="${diff.localValue}" vs Firebase="${diff.firebaseValue}"`
                                        ).join('<br>')}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // 显示仅本地有的成员
                if (comparison.localOnly.length > 0) {
                    html += `
                        <div class="local-only-section">
                            <h4>📱 仅本地有的成员 (${comparison.localOnly.length} 条)</h4>
                    `;
                    
                    comparison.localOnly.forEach(member => {
                        html += `
                            <div class="record-item">
                                <strong>${member.name}</strong> - UUID: ${member.uuid} - 小组: ${member._groupName || '未知'}
                                ${member.phone ? `<br>电话: ${member.phone}` : ''}
                                ${member.email ? `<br>邮箱: ${member.email}` : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // 显示仅Firebase有的成员
                if (comparison.firebaseOnly.length > 0) {
                    html += `
                        <div class="firebase-only-section">
                            <h4>☁️ 仅Firebase有的成员 (${comparison.firebaseOnly.length} 条)</h4>
                    `;
                    
                    comparison.firebaseOnly.forEach(member => {
                        html += `
                            <div class="record-item">
                                <strong>${member.name}</strong> - UUID: ${member.uuid} - 小组: ${member._groupName || '未知'}
                                ${member.phone ? `<br>电话: ${member.phone}` : ''}
                                ${member.email ? `<br>邮箱: ${member.email}` : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // 导出冲突报告
        function exportConflictReport() {
            if (detectedConflicts.length === 0) {
                alert('没有冲突需要导出');
                return;
            }
            
            const report = {
                timestamp: new Date().toISOString(),
                totalConflicts: detectedConflicts.length,
                conflicts: detectedConflicts
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conflict-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ==================== 隔离管理功能 ====================
        
        // 加载隔离数据
        async function loadQuarantineData() {
            try {
                console.log('🔄 开始加载隔离数据...');
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebase未初始化');
                }
                
                const db = firebase.database();
                const snapshot = await db.ref('quarantine').once('value');
                const data = snapshot.val() || {};
                
                quarantineData = Object.keys(data).map(key => ({
                    id: key,
                    ...data[key],
                    quarantinedAt: data[key].quarantinedAt || new Date().toISOString()
                }));
                
                console.log(`📊 加载到 ${quarantineData.length} 条隔离数据`);
                displayQuarantineData();
                updateQuarantineStats();
                
            } catch (error) {
                console.error('❌ 加载隔离数据失败:', error);
                alert('加载隔离数据失败: ' + error.message);
            }
        }
        
        // 显示隔离数据
        function displayQuarantineData() {
            const container = document.getElementById('quarantineDataList');
            
            if (quarantineData.length === 0) {
                container.innerHTML = '<div class="loading">暂无隔离数据</div>';
                return;
            }
            
            let html = '';
            quarantineData.forEach((item, index) => {
                const statusClass = item.status === 'resolved' ? 'resolved' : 'pending';
                const statusText = item.status === 'resolved' ? '已解决' : '待处理';
                
                html += `
                    <div class="quarantine-item" onclick="selectQuarantineItem(${index})">
                        <div class="quarantine-item-header">
                            <div class="quarantine-item-title">${item.type || '未知类型'} - ${item.name || '未知名称'}</div>
                            <div class="quarantine-item-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="quarantine-item-details">
                            <div><strong>隔离时间:</strong> ${new Date(item.quarantinedAt).toLocaleString('zh-CN')}</div>
                            <div><strong>冲突原因:</strong> ${item.reason || '未知原因'}</div>
                            <div><strong>数据来源:</strong> ${item.source || '未知来源'}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 选择隔离项
        function selectQuarantineItem(index) {
            // 移除之前的选择
            document.querySelectorAll('.quarantine-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // 选择当前项
            const items = document.querySelectorAll('.quarantine-item');
            if (items[index]) {
                items[index].classList.add('selected');
                selectedQuarantineItem = quarantineData[index];
                showQuarantineDetails(selectedQuarantineItem);
            }
        }
        
        // 显示隔离详情
        function showQuarantineDetails(item) {
            const detailsContainer = document.getElementById('quarantineDetails');
            const contentContainer = document.getElementById('quarantineDetailsContent');
            
            if (!item) {
                detailsContainer.style.display = 'none';
                return;
            }
            
            const details = {
                'ID': item.id,
                '类型': item.type || '未知',
                '名称': item.name || '未知',
                '状态': item.status === 'resolved' ? '已解决' : '待处理',
                '隔离时间': new Date(item.quarantinedAt).toLocaleString('zh-CN'),
                '冲突原因': item.reason || '未知原因',
                '数据来源': item.source || '未知来源',
                '原始数据': JSON.stringify(item.originalData || {}, null, 2),
                '冲突数据': JSON.stringify(item.conflictData || {}, null, 2)
            };
            
            let detailsHtml = '';
            Object.keys(details).forEach(key => {
                detailsHtml += `${key}: ${details[key]}\n`;
            });
            
            contentContainer.textContent = detailsHtml;
            detailsContainer.style.display = 'block';
        }
        
        // 更新隔离统计
        function updateQuarantineStats() {
            const total = quarantineData.length;
            const resolved = quarantineData.filter(item => item.status === 'resolved').length;
            const pending = total - resolved;
            
            document.getElementById('quarantineCount').textContent = total;
            document.getElementById('quarantineResolved').textContent = resolved;
            document.getElementById('quarantinePending').textContent = pending;
        }
        
        // 解决隔离项
        async function resolveQuarantineItem() {
            if (!selectedQuarantineItem) {
                alert('请先选择要解决的隔离项');
                return;
            }
            
            if (!confirm(`确定要解决 "${selectedQuarantineItem.name || '未知'}" 的冲突吗？`)) {
                return;
            }
            
            try {
                console.log('✅ 开始解决隔离项:', selectedQuarantineItem.id);
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebase未初始化');
                }
                
                const db = firebase.database();
                
                // 更新隔离项状态
                await db.ref(`quarantine/${selectedQuarantineItem.id}`).update({
                    status: 'resolved',
                    resolvedAt: new Date().toISOString(),
                    resolvedBy: 'system'
                });
                
                console.log('✅ 隔离项已标记为已解决');
                
                // 重新加载数据
                await loadQuarantineData();
                
                alert('隔离项已成功解决');
                
            } catch (error) {
                console.error('❌ 解决隔离项失败:', error);
                alert('解决隔离项失败: ' + error.message);
            }
        }
        
        // 恢复隔离项
        async function restoreQuarantineItem() {
            if (!selectedQuarantineItem) {
                alert('请先选择要恢复的隔离项');
                return;
            }
            
            if (!confirm(`确定要恢复 "${selectedQuarantineItem.name || '未知'}" 到正常数据吗？`)) {
                return;
            }
            
            try {
                console.log('↩️ 开始恢复隔离项:', selectedQuarantineItem.id);
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebase未初始化');
                }
                
                const db = firebase.database();
                
                // 根据数据类型恢复
                if (selectedQuarantineItem.type === 'attendance') {
                    // 恢复签到记录
                    const attendanceRecords = JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]');
                    attendanceRecords.push(selectedQuarantineItem.originalData);
                    localStorage.setItem('msh_attendanceRecords', JSON.stringify(attendanceRecords));
                    
                    // 同步到Firebase
                    await db.ref('attendanceRecords').set(attendanceRecords);
                    
                } else if (selectedQuarantineItem.type === 'member') {
                    // 恢复成员信息
                    const groups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                    const groupKey = selectedQuarantineItem.originalData.group || 'group0';
                    
                    if (!groups[groupKey]) {
                        groups[groupKey] = [];
                    }
                    groups[groupKey].push(selectedQuarantineItem.originalData);
                    
                    localStorage.setItem('msh_groups', JSON.stringify(groups));
                    
                    // 同步到Firebase
                    await db.ref('groups').set(groups);
                }
                
                // 从隔离区删除
                await db.ref(`quarantine/${selectedQuarantineItem.id}`).remove();
                
                console.log('✅ 隔离项已恢复并删除');
                
                // 重新加载数据
                await loadQuarantineData();
                
                alert('隔离项已成功恢复');
                
            } catch (error) {
                console.error('❌ 恢复隔离项失败:', error);
                alert('恢复隔离项失败: ' + error.message);
            }
        }
        
        // 删除隔离项
        async function deleteQuarantineItem() {
            if (!selectedQuarantineItem) {
                alert('请先选择要删除的隔离项');
                return;
            }
            
            if (!confirm(`确定要永久删除 "${selectedQuarantineItem.name || '未知'}" 吗？此操作不可撤销！`)) {
                return;
            }
            
            try {
                console.log('🗑️ 开始删除隔离项:', selectedQuarantineItem.id);
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebase未初始化');
                }
                
                const db = firebase.database();
                
                // 从隔离区删除
                await db.ref(`quarantine/${selectedQuarantineItem.id}`).remove();
                
                console.log('✅ 隔离项已永久删除');
                
                // 重新加载数据
                await loadQuarantineData();
                
                alert('隔离项已成功删除');
                
            } catch (error) {
                console.error('❌ 删除隔离项失败:', error);
                alert('删除隔离项失败: ' + error.message);
            }
        }
        
        // 清空所有隔离
        async function clearAllQuarantine() {
            if (!confirm('确定要清空所有隔离数据吗？此操作不可撤销！')) {
                return;
            }
            
            try {
                console.log('🧹 开始清空所有隔离数据...');
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebase未初始化');
                }
                
                const db = firebase.database();
                
                // 清空隔离区
                await db.ref('quarantine').remove();
                
                console.log('✅ 所有隔离数据已清空');
                
                // 重新加载数据
                await loadQuarantineData();
                
                alert('所有隔离数据已成功清空');
                
            } catch (error) {
                console.error('❌ 清空隔离数据失败:', error);
                alert('清空隔离数据失败: ' + error.message);
            }
        }
    </script>
</body>
</html>
