<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSHæ•°æ®å†²çªç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../../src/style.css">
    <style>
        .conflict-manager-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .conflict-manager-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .conflict-manager-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .conflict-manager-header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .conflict-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .conflict-section h2 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .conflict-item {
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #f7fafc;
        }

        .conflict-item.uuid-conflict {
            border-color: #f56565;
            background: #fed7d7;
        }

        .conflict-item.group-conflict {
            border-color: #f6ad55;
            background: #fef5e7;
        }

        .conflict-item.data-mismatch {
            border-color: #ed8936;
            background: #fef5e7;
        }

        .conflict-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .conflict-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
        }

        .conflict-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .conflict-type.uuid {
            background: #fed7d7;
            color: #c53030;
        }

        .conflict-type.group {
            background: #fef5e7;
            color: #d68910;
        }

        .conflict-type.data {
            background: #fef5e7;
            color: #d68910;
        }

        .conflict-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .data-source {
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            background: white;
        }

        .data-source h4 {
            color: #2d3748;
            font-size: 14px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-source-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .data-source-item strong {
            color: #4a5568;
        }

        .data-source-item span {
            color: #718096;
        }

        .conflict-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-warning {
            background: #f6ad55;
            color: white;
        }

        .btn-warning:hover {
            background: #ed8936;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .conflict-resolution-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .conflict-resolution-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .conflict-resolution-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .conflict-resolution-header h3 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .conflict-resolution-body {
            margin-bottom: 20px;
        }

        .conflict-resolution-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* è¿›åº¦å¯¹è¯æ¡†æ ·å¼ */
        .progress-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .progress-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }
        
        .progress-content h3 {
            margin-bottom: 20px;
            color: #2d3748;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            color: #666;
            font-size: 14px;
        }
        
        /* å†²çªè¯¦æƒ…æ ·å¼ */
        .conflict-details {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .conflict-detail-item {
            color: #495057;
        }
        
        .conflict-detail-item strong {
            color: #212529;
            font-weight: 600;
        }
        
        .conflict-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 12px;
            background: white;
            transition: box-shadow 0.2s ease;
        }
        
        .conflict-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .conflict-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .conflict-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .conflict-type.high {
            background: #f8d7da;
            color: #721c24;
        }
        
        .conflict-type.medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .conflict-type.low {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .conflict-description {
            flex: 1;
            font-weight: 500;
            color: #495057;
        }
        
        .conflict-actions {
            padding: 12px 16px;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .resolution-option {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .resolution-option:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .resolution-option.selected {
            border-color: #667eea;
            background: #e6f3ff;
        }

        .resolution-option h4 {
            color: #2d3748;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .resolution-option p {
            color: #718096;
            font-size: 14px;
            margin: 0;
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-button:hover {
            color: #667eea;
            background: #f7fafc;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* éš”ç¦»ç®¡ç†æ ·å¼ */
        .quarantine-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .quarantine-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .quarantine-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .quarantine-list {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .quarantine-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quarantine-item:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }
        
        .quarantine-item.selected {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .quarantine-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .quarantine-item-title {
            font-weight: bold;
            color: #333;
        }
        
        .quarantine-item-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .quarantine-item-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .quarantine-item-status.resolved {
            background: #d4edda;
            color: #155724;
        }
        
        .quarantine-item-details {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }
        
        .quarantine-details {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .quarantine-details h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .quarantine-details-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* åˆ é™¤ç®¡ç†æ ·å¼ */
        .delete-section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #f56565;
        }
        
        .delete-section h3 {
            margin: 0 0 20px 0;
            color: #f56565;
            font-size: 1.4em;
            display: flex;
            align-items: center;
        }
        
        .delete-section h3 .icon {
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .delete-button {
            background: #f56565;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .delete-button:hover {
            background: #e53e3e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
        }
        
        .delete-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .log-section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
        }
        
        .log-section h3 {
            margin: 0 0 15px 0;
            color: #4a5568;
        }
        
        .log-container {
            background: #2d3748;
            color: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.info {
            color: #63b3ed;
        }
        
        .log-entry.success {
            color: #68d391;
        }
        
        .log-entry.warning {
            color: #f6e05e;
        }
        
        .log-entry.error {
            color: #fc8181;
        }
        
        .clear-log {
            margin-top: 10px;
        }
        
        /* è®°å½•é¡¹æ ·å¼ */
        .record-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .record-item strong {
            color: #495057;
            font-weight: 600;
        }
        
        .no-conflicts {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }
        
        .no-conflicts h4 {
            margin: 0 0 10px 0;
            color: #155724;
        }
        
        .no-conflicts p {
            margin: 0;
            opacity: 0.8;
        }
        
        .warning-banner {
            background: #fef5e7;
            border: 1px solid #f6ad55;
            color: #c05621;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }
        
        .warning-banner .icon {
            font-size: 1.5em;
            margin-right: 10px;
        }
        
        .multi-select-controls {
            margin-top: 10px;
        }
        
        .select-all-btn {
            margin-right: 10px;
        }
        
        /* è¿”å›æŒ‰é’®æ ·å¼ */
        .back-button-container {
            margin-bottom: 20px;
        }
        
        .back-button {
            background: #4a5568;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-button:hover {
            background: #2d3748;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .back-button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="conflict-manager-container">
        <!-- è¿”å›æŒ‰é’® -->
        <div class="back-button-container">
            <button class="back-button" onclick="goBack()">
                â† è¿”å›ç®¡ç†é¡µé¢
            </button>
        </div>
        
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="conflict-manager-header">
            <h1>âš”ï¸ MSHæ•°æ®å†²çªç®¡ç†ç³»ç»Ÿ</h1>
            <p>æ£€æµ‹å’Œè§£å†³Firebaseã€MSHç³»ç»Ÿã€å¤–éƒ¨è¡¨å•ä¹‹é—´çš„æ•°æ®å†²çª</p>
        </div>
        
        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('conflict')">âš”ï¸ å†²çªç®¡ç†</button>
                <button class="tab-button" onclick="switchTab('delete')">ğŸ—‘ï¸ åˆ é™¤ç®¡ç†</button>
                <button class="tab-button" onclick="switchTab('quarantine')">ğŸ›¡ï¸ å†²çªéš”ç¦»</button>
            </div>
            
            <!-- å†²çªç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="conflict-tab" class="tab-content active">

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalConflicts">0</div>
                <div class="stat-label">æ€»å†²çªæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uuidConflicts">0</div>
                <div class="stat-label">UUIDå†²çª</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="groupConflicts">0</div>
                <div class="stat-label">å°ç»„å†²çª</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="dataConflicts">0</div>
                <div class="stat-label">æ•°æ®å†²çª</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="resolvedConflicts">0</div>
                <div class="stat-label">å·²è§£å†³</div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="conflict-section">
            <h2>ğŸ” å†²çªæ£€æµ‹æ“ä½œ</h2>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="detectConflicts()">ğŸ” æ£€æµ‹å†²çª</button>
                <button class="btn btn-success" onclick="resolveAllConflicts()">âœ… è§£å†³æ‰€æœ‰å†²çª</button>
                <button class="btn btn-info" onclick="compareAttendanceRecords()">ğŸ“‹ å¯¹æ¯”ç­¾åˆ°è®°å½•</button>
                <button class="btn btn-info" onclick="compareMemberRecords()">ğŸ‘¥ å¯¹æ¯”æˆå‘˜ä¿¡æ¯</button>
                <button class="btn btn-warning" onclick="clearExternalFormData()">ğŸ—‘ï¸ æ¸…ç©ºå¤–éƒ¨è¡¨å•æ•°æ®</button>
                <button class="btn btn-primary" onclick="exportConflictReport()">ğŸ“Š å¯¼å‡ºå†²çªæŠ¥å‘Š</button>
            </div>
        </div>

        <!-- å†²çªåˆ—è¡¨ -->
        <div class="conflict-section">
            <h2>âš ï¸ æ£€æµ‹åˆ°çš„å†²çª</h2>
            <div id="conflictResults">
                <div class="loading">ç‚¹å‡»"æ£€æµ‹å†²çª"å¼€å§‹æ£€æµ‹...</div>
            </div>
        </div>

            </div>
            
            <!-- åˆ é™¤ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="delete-tab" class="tab-content">
                <div class="warning-banner">
                    <span class="icon">âš ï¸</span>
                    <strong>è­¦å‘Šï¼š</strong>æ‰€æœ‰åˆ é™¤æ“ä½œéƒ½æ˜¯ä¸å¯æ’¤é”€çš„ï¼Œè¯·ç¡®ä¿æ‚¨çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆï¼
                </div>
                
                <!-- åˆ é™¤äººå‘˜ -->
                <div class="delete-section">
                    <h3><span class="icon">ğŸ‘¤</span>åˆ é™¤äººå‘˜</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deleteGroupSelect">é€‰æ‹©å°ç»„</label>
                            <select id="deleteGroupSelect" onchange="loadMembers()">
                                <option value="">--è¯·é€‰æ‹©å°ç»„--</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deleteMemberSelect">é€‰æ‹©äººå‘˜</label>
                            <select id="deleteMemberSelect">
                                <option value="">--è¯·å…ˆé€‰æ‹©å°ç»„--</option>
                            </select>
                        </div>
                    </div>
                    <button class="delete-button" onclick="deleteMember()" id="deleteMemberBtn" disabled>
                        åˆ é™¤é€‰ä¸­äººå‘˜
                    </button>
                </div>
                
                <!-- åˆ é™¤ç­¾åˆ°è®°å½• -->
                <div class="delete-section">
                    <h3><span class="icon">ğŸ“</span>åˆ é™¤ç­¾åˆ°è®°å½•</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deleteDate">é€‰æ‹©æ—¥æœŸï¼š</label>
                            <input type="date" id="deleteDate" onchange="loadMemberRecords()" class="date-input">
                        </div>
                        <div class="form-group">
                            <label for="deleteMemberName">é€‰æ‹©äººå‘˜ï¼š</label>
                            <select id="deleteMemberName" class="form-control">
                                <option value="">--è¯·é€‰æ‹©äººå‘˜--</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="deleteRecordSelect">é€‰æ‹©è¦åˆ é™¤çš„ç­¾åˆ°è®°å½•ï¼ˆå¯å¤šé€‰ï¼‰</label>
                        <select id="deleteRecordSelect" multiple size="5" class="multi-select" onchange="checkRecordSelection()">
                            <option value="">--è¯·å…ˆé€‰æ‹©æ—¥æœŸå’Œäººå‘˜--</option>
                        </select>
                        <div class="multi-select-controls">
                            <button type="button" onclick="selectAllRecords()" class="btn btn-warning select-all-btn">å…¨é€‰</button>
                            <button type="button" onclick="clearAllRecords()" class="btn btn-secondary">æ¸…ç©ºé€‰æ‹©</button>
                        </div>
                    </div>
                    <button class="delete-button" onclick="deleteSelectedAttendanceRecords()" id="deleteSelectedRecordsBtn" disabled>
                        åˆ é™¤é€‰ä¸­çš„ç­¾åˆ°è®°å½•
                    </button>
                </div>
                
                <!-- åˆ é™¤å°ç»„ -->
                <div class="delete-section">
                    <h3><span class="icon">ğŸ¢</span>åˆ é™¤å°ç»„</h3>
                    <div class="form-group">
                        <label for="deleteGroupSelect2">é€‰æ‹©è¦åˆ é™¤çš„å°ç»„</label>
                        <select id="deleteGroupSelect2">
                            <option value="">--è¯·é€‰æ‹©å°ç»„--</option>
                        </select>
                    </div>
                    <button class="delete-button" onclick="deleteGroup()" id="deleteGroupBtn" disabled>
                        åˆ é™¤é€‰ä¸­å°ç»„
                    </button>
                </div>
                
                <!-- æ‰¹é‡æ¸…ç† -->
                <div class="delete-section">
                    <h3><span class="icon">ğŸ§¹</span>æ‰¹é‡æ¸…ç†</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cleanupDays">æ¸…ç†å¤šå°‘å¤©å‰çš„ç­¾åˆ°è®°å½•</label>
                            <select id="cleanupDays">
                                <option value="30">30å¤©å‰</option>
                                <option value="60">60å¤©å‰</option>
                                <option value="90">90å¤©å‰</option>
                                <option value="180">180å¤©å‰</option>
                                <option value="365">365å¤©å‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cleanupType">æ¸…ç†ç±»å‹</label>
                            <select id="cleanupType">
                                <option value="attendance">ç­¾åˆ°è®°å½•</option>
                                <option value="all">æ‰€æœ‰æ•°æ®</option>
                            </select>
                        </div>
                    </div>
                    <button class="delete-button" onclick="batchCleanup()" id="cleanupBtn">
                        æ‰§è¡Œæ‰¹é‡æ¸…ç†
                    </button>
                </div>
                
                <!-- æ“ä½œæ—¥å¿— -->
                <div class="log-section">
                    <h3>ğŸ“‹ æ“ä½œæ—¥å¿—</h3>
                    <div class="log-container" id="deleteLogContainer">
                        <div class="log-entry info">ç­‰å¾…æ“ä½œ...</div>
                    </div>
                    <button class="btn btn-warning clear-log" onclick="clearDeleteLog()">æ¸…ç©ºæ—¥å¿—</button>
                </div>
            </div>
            
            <!-- å†²çªéš”ç¦»æ ‡ç­¾é¡µ -->
            <div id="quarantine-tab" class="tab-content">
                <div class="quarantine-header">
                    <h2>ğŸ›¡ï¸ å†²çªéš”ç¦»ç®¡ç†</h2>
                    <p>ç®¡ç†è¢«éš”ç¦»çš„å†²çªæ•°æ®ï¼Œé˜²æ­¢æ•°æ®æ±¡æŸ“</p>
                </div>
                
                <!-- éš”ç¦»ç»Ÿè®¡ -->
                <div class="quarantine-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="quarantineCount">0</div>
                        <div class="stat-label">éš”ç¦»æ•°æ®</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="quarantineResolved">0</div>
                        <div class="stat-label">å·²è§£å†³</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="quarantinePending">0</div>
                        <div class="stat-label">å¾…å¤„ç†</div>
                    </div>
                </div>
                
                <!-- éš”ç¦»æ“ä½œ -->
                <div class="quarantine-actions">
                    <button class="btn btn-primary" onclick="loadQuarantineData()">ğŸ”„ åˆ·æ–°éš”ç¦»æ•°æ®</button>
                    <button class="btn btn-success" onclick="resolveQuarantineItem()">âœ… è§£å†³é€‰ä¸­é¡¹</button>
                    <button class="btn btn-warning" onclick="restoreQuarantineItem()">â†©ï¸ æ¢å¤é€‰ä¸­é¡¹</button>
                    <button class="btn btn-danger" onclick="deleteQuarantineItem()">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­é¡¹</button>
                    <button class="btn btn-info" onclick="clearAllQuarantine()">ğŸ§¹ æ¸…ç©ºæ‰€æœ‰éš”ç¦»</button>
                </div>
                
                <!-- éš”ç¦»æ•°æ®åˆ—è¡¨ -->
                <div class="quarantine-list">
                    <h3>ğŸ“‹ éš”ç¦»æ•°æ®åˆ—è¡¨</h3>
                    <div id="quarantineDataList">
                        <div class="loading">ç‚¹å‡»"åˆ·æ–°éš”ç¦»æ•°æ®"åŠ è½½æ•°æ®...</div>
                    </div>
                </div>
                
                <!-- éš”ç¦»è¯¦æƒ… -->
                <div class="quarantine-details" id="quarantineDetails" style="display: none;">
                    <h3>ğŸ” éš”ç¦»æ•°æ®è¯¦æƒ…</h3>
                    <div id="quarantineDetailsContent"></div>
                </div>
            </div>
        </div>
        
        <!-- å†²çªè§£å†³å¯¹è¯æ¡† -->
        <div class="conflict-resolution-dialog" id="conflictResolutionDialog">
            <div class="conflict-resolution-content">
                <div class="conflict-resolution-header">
                    <h3>ğŸ”§ è§£å†³æ•°æ®å†²çª</h3>
                    <p id="conflictResolutionTitle">è¯·é€‰æ‹©è§£å†³å†²çªçš„æ–¹å¼</p>
                </div>
                <div class="conflict-resolution-body" id="conflictResolutionBody">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
                <div class="conflict-resolution-actions">
                    <button class="btn btn-primary" onclick="applyConflictResolution()">âœ… åº”ç”¨è§£å†³æ–¹æ¡ˆ</button>
                    <button class="btn btn-warning" onclick="closeConflictResolution()">âŒ å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="../../config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="../../src/utils.js"></script>
    <script src="../../src/new-data-manager.js"></script>
    
    <script>
        // æ•°æ®å†²çªç®¡ç†ç³»ç»Ÿçš„JavaScriptåŠŸèƒ½
        let detectedConflicts = [];
        let currentConflictIndex = 0;
        let deleteData = {
            groups: {},
            groupNames: {},
            attendanceRecords: []
        };
        
        // éš”ç¦»ç®¡ç†ç›¸å…³å˜é‡
        let quarantineData = [];
        let selectedQuarantineItem = null;
        
        // è¿”å›ç®¡ç†é¡µé¢
        function goBack() {
            // ç¡®è®¤æ˜¯å¦è¦ç¦»å¼€é¡µé¢
            if (confirm('ç¡®å®šè¦è¿”å›ç®¡ç†é¡µé¢å—ï¼Ÿæœªä¿å­˜çš„æ›´æ”¹å°†ä¸¢å¤±ã€‚')) {
                window.location.href = '../../admin.html';
            }
        }
        
        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„æŒ‰é’®
            event.target.classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ°åˆ é™¤ç®¡ç†æ ‡ç­¾é¡µï¼ŒåŠ è½½æ•°æ®
            if (tabName === 'delete') {
                loadDeleteData();
            }
        }
        
        // åŠ è½½åˆ é™¤ç®¡ç†æ•°æ®
        async function loadDeleteData() {
            try {
                deleteLog('å¼€å§‹åŠ è½½åˆ é™¤ç®¡ç†æ•°æ®...');
                
                // åŠ è½½Firebaseæ•°æ®
                const db = firebase.database();
                deleteData.groups = await db.ref('groups').once('value').then(snapshot => snapshot.val() || {});
                deleteData.groupNames = await db.ref('groupNames').once('value').then(snapshot => snapshot.val() || {});
                const attendanceData = await db.ref('attendanceRecords').once('value').then(snapshot => snapshot.val());
                deleteData.attendanceRecords = Array.isArray(attendanceData) ? attendanceData : (attendanceData ? Object.values(attendanceData) : []);
                
                // æ›´æ–°UI
                updateGroupSelects();
                updateDeleteDate();
                
                deleteLog('åˆ é™¤ç®¡ç†æ•°æ®åŠ è½½å®Œæˆ', 'success');
                
            } catch (error) {
                deleteLog(`åŠ è½½åˆ é™¤ç®¡ç†æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ›´æ–°å°ç»„é€‰æ‹©å™¨
        function updateGroupSelects() {
            const groupSelect1 = document.getElementById('deleteGroupSelect');
            const groupSelect2 = document.getElementById('deleteGroupSelect2');
            
            if (!groupSelect1 || !groupSelect2) return;
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            groupSelect1.innerHTML = '<option value="">--è¯·é€‰æ‹©å°ç»„--</option>';
            groupSelect2.innerHTML = '<option value="">--è¯·é€‰æ‹©å°ç»„--</option>';
            
            // æ·»åŠ æ‰€æœ‰å°ç»„é€‰é¡¹
            Object.keys(deleteData.groups).forEach(groupKey => {
                const groupName = deleteData.groupNames[groupKey] || groupKey;
                const memberCount = deleteData.groups[groupKey] ? deleteData.groups[groupKey].length : 0;
                
                const option1 = new Option(`${groupName} (${memberCount}äºº)`, groupKey);
                const option2 = new Option(`${groupName} (${memberCount}äºº)`, groupKey);
                
                groupSelect1.add(option1);
                groupSelect2.add(option2);
            });
        }
        
        // æ›´æ–°åˆ é™¤æ—¥æœŸä¸ºä»Šå¤©
        function updateDeleteDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('deleteDate');
            if (dateInput) {
                dateInput.value = today;
            }
        }
        
        // åŠ è½½æˆå‘˜åˆ—è¡¨
        function loadMembers() {
            const groupSelect = document.getElementById('deleteGroupSelect');
            const memberSelect = document.getElementById('deleteMemberSelect');
            const deleteBtn = document.getElementById('deleteMemberBtn');
            
            if (!groupSelect || !memberSelect || !deleteBtn) return;
            
            const selectedGroup = groupSelect.value;
            
            // æ¸…ç©ºæˆå‘˜é€‰æ‹©å™¨
            memberSelect.innerHTML = '<option value="">--è¯·é€‰æ‹©äººå‘˜--</option>';
            deleteBtn.disabled = true;
            
            if (selectedGroup && deleteData.groups[selectedGroup]) {
                deleteData.groups[selectedGroup].forEach(member => {
                    const option = new Option(member.name || member, member.name || member);
                    memberSelect.add(option);
                });
                
                if (deleteData.groups[selectedGroup].length > 0) {
                    deleteBtn.disabled = false;
                }
            }
        }
        
        // é˜²é‡å¤è°ƒç”¨æ ‡å¿—
        let isLoadingMembers = false;
        
        // åŠ è½½æŒ‡å®šæ—¥æœŸçš„ç­¾åˆ°è®°å½•
        function loadMemberRecords() {
            // é˜²æ­¢é‡å¤è°ƒç”¨
            if (isLoadingMembers) {
                console.log('âš ï¸ æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
                return;
            }
            
            const dateInput = document.getElementById('deleteDate');
            const memberSelect = document.getElementById('deleteMemberName');
            
            if (!dateInput || !memberSelect) return;
            
            const selectedDate = dateInput.value;
            if (!selectedDate) {
                memberSelect.innerHTML = '<option value="">--è¯·å…ˆé€‰æ‹©æ—¥æœŸ--</option>';
                return;
            }
            
            // è®¾ç½®åŠ è½½æ ‡å¿—
            isLoadingMembers = true;
            console.log('ğŸ” åŠ è½½æ—¥æœŸ:', selectedDate, 'çš„ç­¾åˆ°è®°å½•');
            
            // æ¸…ç©ºé€‰æ‹©å™¨
            memberSelect.innerHTML = '<option value="">--è¯·é€‰æ‹©äººå‘˜--</option>';
            
            // ä»attendanceRecordsä¸­ç­›é€‰æŒ‡å®šæ—¥æœŸçš„è®°å½•
            const recordsForDate = deleteData.attendanceRecords.filter(record => {
                if (!record.date || !record.time) return false;
                
                // å°†æ—¶é—´æˆ³è½¬æ¢ä¸ºæ—¥æœŸå­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒ
                const recordDate = new Date(record.time).toISOString().split('T')[0];
                return recordDate === selectedDate;
            });
            
            console.log('ğŸ” æ‰¾åˆ°', recordsForDate.length, 'æ¡ç­¾åˆ°è®°å½•');
            
            if (recordsForDate.length === 0) {
                memberSelect.innerHTML = '<option value="">--è¯¥æ—¥æœŸæ— ç­¾åˆ°è®°å½•--</option>';
                isLoadingMembers = false;
                return;
            }
            
            // è·å–ç­¾åˆ°äººå‘˜åˆ—è¡¨ï¼ˆå»é‡ï¼‰
            const signinMembers = [...new Set(recordsForDate.map(record => record.name))];
            
            // å¡«å……é€‰æ‹©å™¨
            signinMembers.forEach(memberName => {
                const option = new Option(memberName, memberName);
                memberSelect.add(option);
            });
            
            console.log('âœ… å·²åŠ è½½', signinMembers.length, 'åç­¾åˆ°äººå‘˜');
            console.log('ğŸ” é€‰æ‹©å™¨é€‰é¡¹æ•°é‡:', memberSelect.options.length);
            console.log('ğŸ” é€‰æ‹©å™¨æ˜¯å¦ç¦ç”¨:', memberSelect.disabled);
            console.log('ğŸ” é€‰æ‹©å™¨æ˜¯å¦åªè¯»:', memberSelect.readOnly);
            
            // é‡ç½®åŠ è½½æ ‡å¿—
            isLoadingMembers = false;
            
            // æµ‹è¯•é€‰æ‹©å™¨æ˜¯å¦å¯æ“ä½œ
            setTimeout(() => {
                console.log('ğŸ” æµ‹è¯•é€‰æ‹©å™¨çŠ¶æ€:');
                console.log('- é€‰æ‹©å™¨å…ƒç´ :', memberSelect);
                console.log('- é€‰æ‹©å™¨å¯è§æ€§:', memberSelect.offsetParent !== null);
                console.log('- é€‰æ‹©å™¨æ ·å¼:', window.getComputedStyle(memberSelect).display);
                console.log('- é€‰æ‹©å™¨æŒ‡é’ˆäº‹ä»¶:', window.getComputedStyle(memberSelect).pointerEvents);
                
                // æ·»åŠ æµ‹è¯•äº‹ä»¶ç›‘å¬å™¨
                memberSelect.addEventListener('change', function() {
                    console.log('ğŸ” é€‰æ‹©å™¨å€¼æ”¹å˜:', this.value);
                    // å½“é€‰æ‹©äººå‘˜åï¼ŒåŠ è½½å¯¹åº”çš„ç­¾åˆ°è®°å½•
                    loadAttendanceRecords();
                });
                
                memberSelect.addEventListener('click', function() {
                    console.log('ğŸ” é€‰æ‹©å™¨è¢«ç‚¹å‡»');
                });
            }, 100);
        }
        
        // åŠ è½½ç­¾åˆ°è®°å½•
        function loadAttendanceRecords() {
            const dateInput = document.getElementById('deleteDate');
            const memberSelect = document.getElementById('deleteMemberName');
            const recordSelect = document.getElementById('deleteRecordSelect');
            
            if (!dateInput || !memberSelect || !recordSelect) return;
            
            const selectedDate = dateInput.value;
            const selectedMember = memberSelect.value;
            
            if (!selectedDate || !selectedMember) {
                recordSelect.innerHTML = '<option value="">--è¯·å…ˆé€‰æ‹©æ—¥æœŸå’Œäººå‘˜--</option>';
                return;
            }
            
            console.log('ğŸ” åŠ è½½ç­¾åˆ°è®°å½•:', selectedDate, selectedMember);
            
            // æ¸…ç©ºè®°å½•é€‰æ‹©å™¨
            recordSelect.innerHTML = '';
            
            // ç­›é€‰æŒ‡å®šæ—¥æœŸå’Œäººå‘˜çš„ç­¾åˆ°è®°å½•
            const recordsForMember = deleteData.attendanceRecords.filter(record => {
                if (!record.date || !record.time || !record.name) return false;
                
                // æ£€æŸ¥æ—¥æœŸåŒ¹é…
                const recordDate = new Date(record.time).toISOString().split('T')[0];
                const dateMatch = recordDate === selectedDate;
                
                // æ£€æŸ¥äººå‘˜åŒ¹é…
                const memberMatch = record.name === selectedMember;
                
                return dateMatch && memberMatch;
            });
            
            console.log('ğŸ” æ‰¾åˆ°', recordsForMember.length, 'æ¡ç­¾åˆ°è®°å½•');
            
            if (recordsForMember.length === 0) {
                recordSelect.innerHTML = '<option value="">--è¯¥äººå‘˜åœ¨è¯¥æ—¥æœŸæ— ç­¾åˆ°è®°å½•--</option>';
                return;
            }
            
            // å¡«å……è®°å½•é€‰æ‹©å™¨
            recordsForMember.forEach((record, index) => {
                const time = new Date(record.time).toLocaleString('zh-CN');
                const optionText = `${time} - ${record.timeSlot || 'æœªçŸ¥æ—¶æ®µ'}`;
                const optionValue = record.recordId || `record_${index}`;
                
                const option = new Option(optionText, optionValue);
                recordSelect.add(option);
            });
            
            console.log('âœ… å·²åŠ è½½', recordsForMember.length, 'æ¡ç­¾åˆ°è®°å½•');
        }
        
        // æ£€æŸ¥è®°å½•é€‰æ‹©çŠ¶æ€
        function checkRecordSelection() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            const selectAllBtn = document.querySelector('.select-all-btn');
            const clearAllBtn = document.querySelector('.btn-secondary');
            const deleteRecordsBtn = document.getElementById('deleteSelectedRecordsBtn');
            
            if (!recordSelect) return;
            
            const selectedOptions = Array.from(recordSelect.selectedOptions);
            const hasSelection = selectedOptions.length > 0;
            
            console.log('ğŸ” è®°å½•é€‰æ‹©çŠ¶æ€:', selectedOptions.length, 'ä¸ªé€‰é¡¹è¢«é€‰ä¸­');
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            if (selectAllBtn) {
                selectAllBtn.disabled = !hasSelection && recordSelect.options.length > 1;
            }
            if (clearAllBtn) {
                clearAllBtn.disabled = !hasSelection;
            }
            if (deleteRecordsBtn) {
                deleteRecordsBtn.disabled = !hasSelection;
            }
        }
        
        // å…¨é€‰è®°å½•
        function selectAllRecords() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            if (!recordSelect) return;
            
            for (let i = 0; i < recordSelect.options.length; i++) {
                recordSelect.options[i].selected = true;
            }
            
            checkRecordSelection();
            console.log('âœ… å·²å…¨é€‰æ‰€æœ‰è®°å½•');
        }
        
        // æ¸…ç©ºé€‰æ‹©
        function clearAllRecords() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            if (!recordSelect) return;
            
            for (let i = 0; i < recordSelect.options.length; i++) {
                recordSelect.options[i].selected = false;
            }
            
            checkRecordSelection();
            console.log('âœ… å·²æ¸…ç©ºæ‰€æœ‰é€‰æ‹©');
        }
        
        // åˆ é™¤é€‰ä¸­çš„ç­¾åˆ°è®°å½•
        async function deleteSelectedAttendanceRecords() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            if (!recordSelect) return;
            
            const selectedOptions = Array.from(recordSelect.selectedOptions);
            if (selectedOptions.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ç­¾åˆ°è®°å½•');
                return;
            }
            
            // ç¡®è®¤åˆ é™¤
            const confirmDelete = confirm(`ç¡®å®šè¦åˆ é™¤ ${selectedOptions.length} æ¡ç­¾åˆ°è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);
            if (!confirmDelete) return;
            
            try {
                console.log('ğŸ” å¼€å§‹åˆ é™¤ç­¾åˆ°è®°å½•...');
                
                // è·å–è¦åˆ é™¤çš„è®°å½•ID
                const recordIdsToDelete = selectedOptions.map(option => option.value);
                console.log('ğŸ“‹ è¦åˆ é™¤çš„è®°å½•ID:', recordIdsToDelete);
                
                // ä»attendanceRecordsä¸­ç§»é™¤è¿™äº›è®°å½•
                const updatedRecords = deleteData.attendanceRecords.filter(record => {
                    const recordId = record.recordId || `record_${deleteData.attendanceRecords.indexOf(record)}`;
                    return !recordIdsToDelete.includes(recordId);
                });
                
                console.log(`ğŸ“Š åˆ é™¤å‰è®°å½•æ•°: ${deleteData.attendanceRecords.length}, åˆ é™¤åè®°å½•æ•°: ${updatedRecords.length}`);
                
                // æ›´æ–°æ•°æ®
                deleteData.attendanceRecords = updatedRecords;
                
                // 1. åŒæ­¥åˆ°Firebase
                if (window.db) {
                    console.log('ğŸ”„ å¼€å§‹åŒæ­¥åˆ°Firebase...');
                    await window.db.ref('attendanceRecords').set(updatedRecords);
                    console.log('âœ… FirebaseåŒæ­¥æˆåŠŸ');
                } else {
                    console.warn('âš ï¸ window.dbæœªè®¾ç½®ï¼Œæ— æ³•åŒæ­¥åˆ°Firebase');
                    console.log('ğŸ” FirebaseçŠ¶æ€:', {
                        firebase: typeof firebase !== 'undefined',
                        firebaseConfig: !!window.firebaseConfig,
                        windowDb: !!window.db
                    });
                }
                
                // 2. æ›´æ–°æœ¬åœ°å­˜å‚¨ï¼ˆä½¿ç”¨æ­£ç¡®çš„é”®åï¼‰
                localStorage.setItem('msh_attendanceRecords', JSON.stringify(updatedRecords));
                console.log('âœ… æœ¬åœ°å­˜å‚¨å·²æ›´æ–° (msh_attendanceRecords)');
                
                // 3. æ›´æ–°å…¨å±€å˜é‡
                if (window.attendanceRecords) {
                    window.attendanceRecords = updatedRecords;
                    console.log('âœ… å…¨å±€å˜é‡å·²æ›´æ–° (window.attendanceRecords)');
                }
                
                // 4. å¦‚æœä½¿ç”¨NewDataManagerï¼ŒåŒæ­¥æ›´æ–°å…¶çŠ¶æ€
                if (window.newDataManager) {
                    try {
                        // ä¿å­˜åˆ°NewDataManagerçš„æœ¬åœ°å­˜å‚¨
                        window.newDataManager.saveToLocalStorage('attendanceRecords', updatedRecords);
                        
                        // æ ‡è®°æ•°æ®å˜æ›´
                        window.newDataManager.markDataChange('attendanceRecords', 'deleted', `delete_records_${recordIdsToDelete.length}`);
                        
                        // æ¸…é™¤hasLocalChangesæ ‡å¿—ï¼ˆå› ä¸ºå·²ç»åŒæ­¥åˆ°Firebaseï¼‰
                        window.newDataManager.hasLocalChanges = false;
                        
                        console.log('âœ… NewDataManagerçŠ¶æ€å·²æ›´æ–°');
                    } catch (managerError) {
                        console.warn('âš ï¸ NewDataManageræ›´æ–°å¤±è´¥:', managerError);
                    }
                }
                
                // 5. è§¦å‘æ•°æ®åŒæ­¥äº‹ä»¶ï¼ˆä¾›å…¶ä»–é¡µé¢ç›‘å¬ï¼‰
                try {
                    const event = new CustomEvent('attendanceRecordsUpdated', {
                        detail: { 
                            records: updatedRecords,
                            deletedCount: recordIdsToDelete.length,
                            source: 'data-conflict-manager'
                        }
                    });
                    window.dispatchEvent(event);
                    console.log('âœ… æ•°æ®åŒæ­¥äº‹ä»¶å·²è§¦å‘');
                } catch (eventError) {
                    console.warn('âš ï¸ è§¦å‘æ•°æ®åŒæ­¥äº‹ä»¶å¤±è´¥:', eventError);
                }
                
                // 6. é‡æ–°åŠ è½½è®°å½•
                loadAttendanceRecords();
                
                // 7. æ˜¾ç¤ºæˆåŠŸæç¤º
                alert(`âœ… å·²æˆåŠŸåˆ é™¤ ${recordIdsToDelete.length} æ¡ç­¾åˆ°è®°å½•\n\nâœ“ Firebaseå·²æ›´æ–°\nâœ“ æœ¬åœ°å­˜å‚¨å·²æ›´æ–°\nâœ“ æ•°æ®å·²åŒæ­¥`);
                
                // 8. æ·»åŠ æ“ä½œæ—¥å¿—
                addLog('success', `æˆåŠŸåˆ é™¤ ${recordIdsToDelete.length} æ¡ç­¾åˆ°è®°å½•`);
                
            } catch (error) {
                console.error('âŒ åˆ é™¤ç­¾åˆ°è®°å½•å¤±è´¥:', error);
                addLog('error', `åˆ é™¤ç­¾åˆ°è®°å½•å¤±è´¥: ${error.message}`);
                alert(`åˆ é™¤å¤±è´¥: ${error.message}\n\nè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—`);
            }
        }
        
        // åˆ é™¤äººå‘˜
        async function deleteMember() {
            const groupSelect = document.getElementById('deleteGroupSelect');
            const memberSelect = document.getElementById('deleteMemberSelect');
            
            if (!groupSelect || !memberSelect) return;
            
            const groupKey = groupSelect.value;
            const memberName = memberSelect.value;
            
            if (!groupKey || !memberName) {
                alert('è¯·é€‰æ‹©å°ç»„å’Œäººå‘˜');
                return;
            }
            
            // å¤šé‡ç¡®è®¤
            const confirm1 = confirm(`ç¡®å®šè¦åˆ é™¤ ${memberName} å—ï¼Ÿ\n\nå°ç»„ï¼š${deleteData.groupNames[groupKey] || groupKey}`);
            if (!confirm1) return;
            
            const confirm2 = confirm(`âš ï¸ æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼\n\nç¡®å®šè¦æ°¸ä¹…åˆ é™¤ ${memberName} å—ï¼Ÿ`);
            if (!confirm2) return;
            
            try {
                deleteLog(`å¼€å§‹åˆ é™¤äººå‘˜: ${memberName}`);
                
                // ä»å°ç»„ä¸­ç§»é™¤æˆå‘˜
                const updatedMembers = deleteData.groups[groupKey].filter(member => 
                    (member.name || member) !== memberName
                );
                
                // æ›´æ–°Firebase
                const db = firebase.database();
                await db.ref(`groups/${groupKey}`).set(updatedMembers);
                
                // åˆ é™¤ç›¸å…³çš„ç­¾åˆ°è®°å½•
                const memberRecords = deleteData.attendanceRecords.filter(record => 
                    record.name === memberName && record.group === groupKey
                );
                
                for (const record of memberRecords) {
                    const recordIndex = deleteData.attendanceRecords.findIndex(r => 
                        r.name === record.name && 
                        r.group === record.group && 
                        r.time === record.time
                    );
                    if (recordIndex !== -1) {
                        await db.ref(`attendanceRecords/${recordIndex}`).remove();
                    }
                }
                
                deleteLog(`äººå‘˜åˆ é™¤æˆåŠŸ: ${memberName}`, 'success');
                deleteLog(`åŒæ—¶åˆ é™¤äº† ${memberRecords.length} æ¡ç›¸å…³ç­¾åˆ°è®°å½•`, 'info');
                
                // é‡æ–°åŠ è½½æ•°æ®
                await loadDeleteData();
                
                alert(`âœ… äººå‘˜ ${memberName} åˆ é™¤æˆåŠŸï¼\nåŒæ—¶åˆ é™¤äº† ${memberRecords.length} æ¡ç›¸å…³ç­¾åˆ°è®°å½•ã€‚`);
                
            } catch (error) {
                deleteLog(`åˆ é™¤äººå‘˜å¤±è´¥: ${error.message}`, 'error');
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ é™¤æ—¥å¿—è®°å½•
        function deleteLog(message, type = 'info') {
            const logContainer = document.getElementById('deleteLogContainer');
            if (!logContainer) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ¡æ•°
            const entries = logContainer.children;
            if (entries.length > 100) {
                logContainer.removeChild(entries[0]);
            }
        }
        
        // æ¸…ç©ºåˆ é™¤æ—¥å¿—
        function clearDeleteLog() {
            const logContainer = document.getElementById('deleteLogContainer');
            if (logContainer) {
                logContainer.innerHTML = '<div class="log-entry info">æ—¥å¿—å·²æ¸…ç©º</div>';
            }
        }
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æ•°æ®å†²çªç®¡ç†ç³»ç»Ÿå·²åŠ è½½');
            // åˆå§‹åŒ–Firebase
            if (typeof firebase !== 'undefined' && window.firebaseConfig) {
                firebase.initializeApp(window.firebaseConfig);
                window.db = firebase.database();
                console.log('Firebaseå·²åˆå§‹åŒ–');
                console.log('âœ… window.dbå·²è®¾ç½®');
            } else {
                console.error('âŒ Firebaseé…ç½®æœªæ‰¾åˆ°æˆ–FirebaseæœªåŠ è½½');
            }
        });
        
        // æ£€æµ‹æ•°æ®å†²çª
        async function detectConflicts() {
            console.log('å¼€å§‹æ£€æµ‹æ•°æ®å†²çª...');
            
            try {
                // è·å–æœ¬åœ°æ•°æ®
                const localGroups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                const localGroupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
                const localAttendanceRecords = JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]');
                
                console.log('æœ¬åœ°æ•°æ®ç»Ÿè®¡:', {
                    groups: Object.keys(localGroups).length,
                    groupNames: Object.keys(localGroupNames).length,
                    attendanceRecords: localAttendanceRecords.length
                });
                
                // è·å–Firebaseæ•°æ®
                const db = firebase.database();
                const firebaseGroups = await db.ref('groups').once('value').then(snapshot => snapshot.val() || {});
                const firebaseGroupNames = await db.ref('groupNames').once('value').then(snapshot => snapshot.val() || {});
                const firebaseAttendanceRecords = await db.ref('attendanceRecords').once('value').then(snapshot => {
                    const data = snapshot.val();
                    return Array.isArray(data) ? data : (data ? Object.values(data) : []);
                });
                
                // å°†Firebaseæ•°æ®å­˜å‚¨åˆ°å…¨å±€å˜é‡ï¼Œä¾›ç»Ÿè®¡å‡½æ•°ä½¿ç”¨
                window.firebaseGroups = firebaseGroups;
                window.firebaseGroupNames = firebaseGroupNames;
                window.firebaseAttendanceRecords = firebaseAttendanceRecords;
                
                console.log('Firebaseæ•°æ®ç»Ÿè®¡:', {
                    groups: Object.keys(firebaseGroups).length,
                    groupNames: Object.keys(firebaseGroupNames).length,
                    attendanceRecords: firebaseAttendanceRecords.length
                });
                
                // è¯¦ç»†æ•°æ®å¯¹æ¯”åˆ†æ
                console.log('\n=== è¯¦ç»†æ•°æ®å¯¹æ¯”åˆ†æ ===');
                const dataComparison = performDetailedDataComparison(localGroups, firebaseGroups, localAttendanceRecords, firebaseAttendanceRecords);
                
                // æ£€æµ‹å†²çª
                const conflicts = [];
                
                // æ£€æµ‹UUIDå†²çª
                const uuidConflicts = detectUUIDConflicts(localGroups, firebaseGroups);
                console.log(`UUIDå†²çª: ${uuidConflicts.length} ä¸ª`);
                conflicts.push(...uuidConflicts);
                
                // æ£€æµ‹å°ç»„åç§°å†²çª
                const groupNameConflicts = detectGroupNameConflicts(localGroups, firebaseGroups);
                console.log(`å°ç»„åç§°å†²çª: ${groupNameConflicts.length} ä¸ª`);
                conflicts.push(...groupNameConflicts);
                
                // æ£€æµ‹æ•°æ®ä¸ä¸€è‡´å†²çª
                const dataInconsistencyConflicts = detectDataInconsistencyConflicts(localGroups, firebaseGroups, localGroupNames, firebaseGroupNames);
                console.log(`æ•°æ®ä¸ä¸€è‡´å†²çª: ${dataInconsistencyConflicts.length} ä¸ª`);
                conflicts.push(...dataInconsistencyConflicts);
                
                // æ£€æµ‹ç­¾åˆ°è®°å½•å†²çª
                const attendanceConflicts = detectAttendanceConflicts(localAttendanceRecords, firebaseAttendanceRecords);
                console.log(`ç­¾åˆ°è®°å½•å†²çª: ${attendanceConflicts.length} ä¸ª`);
                conflicts.push(...attendanceConflicts);
                
                detectedConflicts = conflicts;
                displayConflicts(conflicts);
                
                console.log(`æ£€æµ‹åˆ° ${conflicts.length} ä¸ªå†²çª`);
                
            } catch (error) {
                console.error('æ£€æµ‹å†²çªæ—¶å‡ºé”™:', error);
                alert('æ£€æµ‹å†²çªæ—¶å‡ºé”™: ' + error.message);
            }
        }
        
        // æ£€æµ‹UUIDå†²çª
        function detectUUIDConflicts(localGroups, firebaseGroups) {
            const conflicts = [];
            const uuidMap = new Map();
            const duplicateRecords = []; // è®°å½•é‡å¤è®°å½•
            
            console.log('=== UUIDå†²çªæ£€æµ‹è¯¦ç»†åˆ†æ ===');
            console.log('æœ¬åœ°å°ç»„æ•°æ®:', localGroups);
            console.log('Firebaseå°ç»„æ•°æ®:', firebaseGroups);
            
            // æ”¶é›†æ‰€æœ‰UUID - åˆ†åˆ«å¤„ç†æœ¬åœ°å’ŒFirebaseæ•°æ®
            console.log('\n--- å¤„ç†æœ¬åœ°æ•°æ® ---');
            Object.entries(localGroups).forEach(([groupName, group]) => {
                if (Array.isArray(group)) {
                    console.log(`æœ¬åœ°å°ç»„ ${groupName}:`, group);
                    group.forEach((member, memberIndex) => {
                        if (member && member.uuid) {
                            // ä¸ºæœ¬åœ°æˆå‘˜æ·»åŠ æ¥æºæ ‡è¯†
                            const localMember = {
                                ...member,
                                _source: 'local',
                                _groupName: groupName,
                                _originalData: member
                            };
                            
                            console.log(`æœ¬åœ°æˆå‘˜ ${memberIndex}:`, {
                                uuid: localMember.uuid,
                                name: localMember.name,
                                group: localMember.group,
                                _source: localMember._source,
                                _groupName: localMember._groupName,
                                fullData: localMember
                            });
                            
                            if (uuidMap.has(localMember.uuid)) {
                                const existingMember = uuidMap.get(localMember.uuid);
                                console.log(`å‘ç°é‡å¤UUID: ${localMember.uuid}`);
                                console.log('ç°æœ‰æˆå‘˜:', existingMember);
                                console.log('æ–°æˆå‘˜:', localMember);
                                
                                // æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€ä¸ªäººï¼ˆå§“åå’Œå°ç»„ç›¸åŒï¼‰
                                const isSamePerson = existingMember.name === localMember.name && 
                                                   (existingMember.group === localMember.group || 
                                                    existingMember._groupName === localMember._groupName);
                                
                                console.log('æ˜¯å¦åŒä¸€äºº:', isSamePerson);
                                console.log('å§“ååŒ¹é…:', existingMember.name === localMember.name);
                                console.log('å°ç»„åŒ¹é…:', existingMember.group === localMember.group || existingMember._groupName === localMember._groupName);
                                
                                if (isSamePerson) {
                                    // æ£€æŸ¥æ˜¯å¦åªæ˜¯æ•°æ®æ¥æºä¸åŒ
                                    const isOnlySourceDifferent = checkIfOnlySourceDifferent(existingMember, localMember);
                                    
                                    if (isOnlySourceDifferent) {
                                        console.log('åˆ¤æ–­ä¸ºåŒæ­¥æ•°æ®é‡å¤ï¼ˆä»…æ¥æºä¸åŒï¼‰');
                                        // ä¸è®°å½•ä¸ºå†²çªï¼Œè¿™æ˜¯æ­£å¸¸çš„åŒæ­¥æ•°æ®
                                    } else {
                                        console.log('åˆ¤æ–­ä¸ºé‡å¤è®°å½•');
                                        duplicateRecords.push({
                                            uuid: localMember.uuid,
                                            name: localMember.name,
                                            group: localMember.group || localMember._groupName,
                                            existingMember: existingMember,
                                            duplicateMember: localMember
                                        });
                                    }
                                } else {
                                    console.log('åˆ¤æ–­ä¸ºUUIDå†²çª');
                                    conflicts.push({
                                        type: 'uuid_conflict',
                                        description: `UUIDå†²çª: ${localMember.uuid} è¢«å¤šä¸ªä¸åŒæˆå‘˜ä½¿ç”¨`,
                                        members: [existingMember, localMember],
                                        severity: 'high'
                                    });
                                }
                            } else {
                                uuidMap.set(localMember.uuid, localMember);
                            }
                        }
                    });
                }
            });
            
            console.log('\n--- å¤„ç†Firebaseæ•°æ® ---');
            Object.entries(firebaseGroups).forEach(([groupName, group]) => {
                if (Array.isArray(group)) {
                    console.log(`Firebaseå°ç»„ ${groupName}:`, group);
                    group.forEach((member, memberIndex) => {
                        if (member && member.uuid) {
                            // ä¸ºFirebaseæˆå‘˜æ·»åŠ æ¥æºæ ‡è¯†
                            const firebaseMember = {
                                ...member,
                                _source: 'firebase',
                                _groupName: groupName,
                                _originalData: member
                            };
                            
                            console.log(`Firebaseæˆå‘˜ ${memberIndex}:`, {
                                uuid: firebaseMember.uuid,
                                name: firebaseMember.name,
                                group: firebaseMember.group,
                                _source: firebaseMember._source,
                                _groupName: firebaseMember._groupName,
                                fullData: firebaseMember
                            });
                            
                            if (uuidMap.has(firebaseMember.uuid)) {
                                const existingMember = uuidMap.get(firebaseMember.uuid);
                                console.log(`å‘ç°é‡å¤UUID: ${firebaseMember.uuid}`);
                                console.log('ç°æœ‰æˆå‘˜:', existingMember);
                                console.log('æ–°æˆå‘˜:', firebaseMember);
                                
                                // æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€ä¸ªäººï¼ˆå§“åå’Œå°ç»„ç›¸åŒï¼‰
                                const isSamePerson = existingMember.name === firebaseMember.name && 
                                                   (existingMember.group === firebaseMember.group || 
                                                    existingMember._groupName === firebaseMember._groupName);
                                
                                console.log('æ˜¯å¦åŒä¸€äºº:', isSamePerson);
                                console.log('å§“ååŒ¹é…:', existingMember.name === firebaseMember.name);
                                console.log('å°ç»„åŒ¹é…:', existingMember.group === firebaseMember.group || existingMember._groupName === firebaseMember._groupName);
                                
                                if (isSamePerson) {
                                    // æ£€æŸ¥æ˜¯å¦åªæ˜¯æ•°æ®æ¥æºä¸åŒ
                                    const isOnlySourceDifferent = checkIfOnlySourceDifferent(existingMember, firebaseMember);
                                    
                                    if (isOnlySourceDifferent) {
                                        console.log('åˆ¤æ–­ä¸ºåŒæ­¥æ•°æ®é‡å¤ï¼ˆä»…æ¥æºä¸åŒï¼‰');
                                        // ä¸è®°å½•ä¸ºå†²çªï¼Œè¿™æ˜¯æ­£å¸¸çš„åŒæ­¥æ•°æ®
                                    } else {
                                        console.log('åˆ¤æ–­ä¸ºé‡å¤è®°å½•');
                                        duplicateRecords.push({
                                            uuid: firebaseMember.uuid,
                                            name: firebaseMember.name,
                                            group: firebaseMember.group || firebaseMember._groupName,
                                            existingMember: existingMember,
                                            duplicateMember: firebaseMember
                                        });
                                    }
                                } else {
                                    console.log('åˆ¤æ–­ä¸ºUUIDå†²çª');
                                    conflicts.push({
                                        type: 'uuid_conflict',
                                        description: `UUIDå†²çª: ${firebaseMember.uuid} è¢«å¤šä¸ªä¸åŒæˆå‘˜ä½¿ç”¨`,
                                        members: [existingMember, firebaseMember],
                                        severity: 'high'
                                    });
                                }
                            } else {
                                uuidMap.set(firebaseMember.uuid, firebaseMember);
                            }
                        }
                    });
                }
            });
            
            // å¤„ç†é‡å¤è®°å½•
            duplicateRecords.forEach(duplicate => {
                conflicts.push({
                    type: 'duplicate_record',
                    description: `é‡å¤è®°å½•: ${duplicate.name} (${duplicate.group}) å­˜åœ¨é‡å¤è®°å½•`,
                    uuid: duplicate.uuid,
                    name: duplicate.name,
                    group: duplicate.group,
                    existingMember: duplicate.existingMember,
                    duplicateMember: duplicate.duplicateMember,
                    severity: 'medium'
                });
            });
            
            console.log('\n=== æ£€æµ‹ç»“æœç»Ÿè®¡ ===');
            console.log(`æ£€æµ‹åˆ° ${conflicts.filter(c => c.type === 'uuid_conflict').length} ä¸ªUUIDå†²çª`);
            console.log(`æ£€æµ‹åˆ° ${conflicts.filter(c => c.type === 'duplicate_record').length} ä¸ªé‡å¤è®°å½•`);
            console.log('æ‰€æœ‰å†²çª:', conflicts);
            
            return conflicts;
        }
        
        // æ£€æµ‹å°ç»„åç§°å†²çª
        function detectGroupNameConflicts(localGroups, firebaseGroups) {
            const conflicts = [];
            const memberMap = new Map();
            
            console.log('=== å°ç»„åç§°å†²çªæ£€æµ‹ ===');
            console.log('æœ¬åœ°å°ç»„æ•°æ®:', localGroups);
            console.log('Firebaseå°ç»„æ•°æ®:', firebaseGroups);
            
            // æ”¶é›†æ‰€æœ‰æˆå‘˜ï¼Œåˆ†åˆ«å¤„ç†æœ¬åœ°å’ŒFirebaseæ•°æ®
            console.log('\n--- å¤„ç†æœ¬åœ°æ•°æ® ---');
            Object.entries(localGroups).forEach(([groupName, group]) => {
                if (Array.isArray(group)) {
                    console.log(`æœ¬åœ°å°ç»„ ${groupName}:`, group);
                    group.forEach(member => {
                        if (member && (member.name || member.èŠ±å)) {
                            const key = member.name || member.èŠ±å;
                            const memberWithSource = {
                                ...member,
                                _source: 'local',
                                _groupName: groupName
                            };
                            
                            console.log(`æœ¬åœ°æˆå‘˜: ${key} åœ¨å°ç»„ ${groupName}`);
                            
                            if (memberMap.has(key)) {
                                const existing = memberMap.get(key);
                                console.log(`å‘ç°é‡å¤æˆå‘˜: ${key}`);
                                console.log('ç°æœ‰æˆå‘˜:', existing);
                                console.log('æ–°æˆå‘˜:', memberWithSource);
                                
                                if (existing.group !== member.group && existing._groupName !== groupName) {
                                    console.log(`å°ç»„å†²çª: ${existing.group || existing._groupName} vs ${member.group || groupName}`);
                                    conflicts.push({
                                        type: 'group_name',
                                        description: `å°ç»„åç§°å†²çª: ${key} åœ¨ä¸åŒå°ç»„ä¸­`,
                                        members: [existing, memberWithSource],
                                        severity: 'medium'
                                    });
                                }
                            } else {
                                memberMap.set(key, memberWithSource);
                            }
                        }
                    });
                }
            });
            
            console.log('\n--- å¤„ç†Firebaseæ•°æ® ---');
            Object.entries(firebaseGroups).forEach(([groupName, group]) => {
                if (Array.isArray(group)) {
                    console.log(`Firebaseå°ç»„ ${groupName}:`, group);
                    group.forEach(member => {
                        if (member && (member.name || member.èŠ±å)) {
                            const key = member.name || member.èŠ±å;
                            const memberWithSource = {
                                ...member,
                                _source: 'firebase',
                                _groupName: groupName
                            };
                            
                            console.log(`Firebaseæˆå‘˜: ${key} åœ¨å°ç»„ ${groupName}`);
                            
                            if (memberMap.has(key)) {
                                const existing = memberMap.get(key);
                                console.log(`å‘ç°é‡å¤æˆå‘˜: ${key}`);
                                console.log('ç°æœ‰æˆå‘˜:', existing);
                                console.log('æ–°æˆå‘˜:', memberWithSource);
                                
                                if (existing.group !== member.group && existing._groupName !== groupName) {
                                    console.log(`å°ç»„å†²çª: ${existing.group || existing._groupName} vs ${member.group || groupName}`);
                                    conflicts.push({
                                        type: 'group_name',
                                        description: `å°ç»„åç§°å†²çª: ${key} åœ¨ä¸åŒå°ç»„ä¸­`,
                                        members: [existing, memberWithSource],
                                        severity: 'medium'
                                    });
                                }
                            } else {
                                memberMap.set(key, memberWithSource);
                            }
                        }
                    });
                }
            });
            
            console.log('\n=== å°ç»„åç§°å†²çªæ£€æµ‹ç»“æœ ===');
            console.log(`æ£€æµ‹åˆ° ${conflicts.length} ä¸ªå°ç»„åç§°å†²çª`);
            console.log('å†²çªè¯¦æƒ…:', conflicts);
            
            return conflicts;
        }
        
        // æ£€æµ‹æ•°æ®ä¸ä¸€è‡´å†²çª
        function detectDataInconsistencyConflicts(localGroups, firebaseGroups, localGroupNames, firebaseGroupNames) {
            const conflicts = [];
            
            // æ£€æµ‹å°ç»„æ•°æ®ä¸ä¸€è‡´
            const allGroupNames = new Set([...Object.keys(localGroups), ...Object.keys(firebaseGroups)]);
            allGroupNames.forEach(groupName => {
                const localGroup = localGroups[groupName] || [];
                const firebaseGroup = firebaseGroups[groupName] || [];
                
                if (localGroup.length !== firebaseGroup.length) {
                    conflicts.push({
                        type: 'data_inconsistency',
                        description: `æ•°æ®ä¸ä¸€è‡´: ${groupName} å°ç»„æˆå‘˜æ•°é‡ä¸åŒ (æœ¬åœ°:${localGroup.length}, Firebase:${firebaseGroup.length})`,
                        groupName: groupName,
                        localCount: localGroup.length,
                        firebaseCount: firebaseGroup.length,
                        severity: 'medium'
                    });
                }
            });
            
            return conflicts;
        }
        
        // æ£€æµ‹ç­¾åˆ°è®°å½•å†²çª
        function detectAttendanceConflicts(localRecords, firebaseRecords) {
            const conflicts = [];
            const processedRecords = new Set();
            
            console.log('=== ç­¾åˆ°è®°å½•å†²çªæ£€æµ‹å¼€å§‹ ===');
            console.log('æœ¬åœ°ç­¾åˆ°è®°å½•æ•°é‡:', localRecords.length);
            console.log('Firebaseç­¾åˆ°è®°å½•æ•°é‡:', firebaseRecords.length);
            console.log('æœ¬åœ°ç­¾åˆ°è®°å½•ç¤ºä¾‹:', localRecords.slice(0, 3));
            console.log('Firebaseç­¾åˆ°è®°å½•ç¤ºä¾‹:', firebaseRecords.slice(0, 3));
            
            // æ£€æŸ¥æ¯æ¡æœ¬åœ°è®°å½•
            localRecords.forEach((localRecord, localIndex) => {
                if (!localRecord || !localRecord.name) return;
                
                const recordKey = `${localRecord.name}_${localRecord.time || localRecord.date}`;
                if (processedRecords.has(recordKey)) return;
                processedRecords.add(recordKey);
                
                console.log(`\n--- æ£€æŸ¥æœ¬åœ°è®°å½• ${localIndex + 1}: ${localRecord.name} ---`);
                console.log('æœ¬åœ°è®°å½•è¯¦æƒ…:', localRecord);
                
                // åœ¨Firebaseè®°å½•ä¸­æŸ¥æ‰¾åŒ¹é…çš„è®°å½•
                const matchingFirebaseRecord = firebaseRecords.find(firebaseRecord => {
                    if (!firebaseRecord || !firebaseRecord.name) return false;
                    
                    // åŒ¹é…æ¡ä»¶ï¼šå§“åç›¸åŒä¸”æ—¶é—´ç›¸åŒ
                    const nameMatch = firebaseRecord.name === localRecord.name;
                    
                    // ç²¾ç¡®æ—¶é—´åŒ¹é…ï¼šåªåŒ¹é…å®Œå…¨ç›¸åŒçš„æ—¶é—´ï¼Œä¸è¿›è¡Œæ—¥æœŸæ¨¡ç³ŠåŒ¹é…
                    const timeMatch = (firebaseRecord.time === localRecord.time);
                    
                    console.log(`æ£€æŸ¥åŒ¹é…: ${localRecord.name}`, {
                        localTime: localRecord.time,
                        firebaseTime: firebaseRecord.time,
                        nameMatch: nameMatch,
                        timeMatch: timeMatch,
                        firebaseRecord: firebaseRecord
                    });
                    
                    return nameMatch && timeMatch;
                });
                
                if (matchingFirebaseRecord) {
                    console.log('æ‰¾åˆ°åŒ¹é…çš„Firebaseè®°å½•:', matchingFirebaseRecord);
                    
                    // æ£€æŸ¥è®°å½•å†…å®¹æ˜¯å¦ä¸€è‡´
                    const isContentSame = JSON.stringify({
                        name: localRecord.name,
                        group: localRecord.group,
                        time: localRecord.time,
                        date: localRecord.date
                    }) === JSON.stringify({
                        name: matchingFirebaseRecord.name,
                        group: matchingFirebaseRecord.group,
                        time: matchingFirebaseRecord.time,
                        date: matchingFirebaseRecord.date
                    });
                    
                    console.log('è®°å½•å†…å®¹æ˜¯å¦ä¸€è‡´:', isContentSame);
                    
                    if (!isContentSame) {
                        console.log('æ£€æµ‹åˆ°ç­¾åˆ°è®°å½•å†²çªï¼Œæ·»åŠ åˆ°å†²çªåˆ—è¡¨');
                        conflicts.push({
                            type: 'attendance_conflict',
                            description: `ç­¾åˆ°è®°å½•å†²çª: ${localRecord.name} åœ¨ ${localRecord.time || localRecord.date} çš„è®°å½•å†…å®¹ä¸ä¸€è‡´`,
                            localRecord: localRecord,
                            firebaseRecord: matchingFirebaseRecord,
                            severity: 'medium'
                        });
                    } else {
                        console.log('è®°å½•å†…å®¹ä¸€è‡´ï¼Œæ— å†²çª');
                    }
                } else {
                    console.log('æœªæ‰¾åˆ°åŒ¹é…çš„Firebaseè®°å½•');
                    // æœ¬åœ°æœ‰ä½†Firebaseæ²¡æœ‰çš„è®°å½•
                    conflicts.push({
                        type: 'attendance_missing',
                        description: `ç­¾åˆ°è®°å½•ç¼ºå¤±: ${localRecord.name} åœ¨ ${localRecord.time || localRecord.date} çš„è®°å½•åœ¨Firebaseä¸­ç¼ºå¤±`,
                        localRecord: localRecord,
                        severity: 'low'
                    });
                }
            });
            
            // æ£€æŸ¥Firebaseä¸­æœ‰ä½†æœ¬åœ°æ²¡æœ‰çš„è®°å½•
            firebaseRecords.forEach(firebaseRecord => {
                if (!firebaseRecord || !firebaseRecord.name) return;
                
                const recordKey = `${firebaseRecord.name}_${firebaseRecord.time || firebaseRecord.date}`;
                if (processedRecords.has(recordKey)) return;
                processedRecords.add(recordKey);
                
                const matchingLocalRecord = localRecords.find(localRecord => {
                    if (!localRecord || !localRecord.name) return false;
                    
                    const nameMatch = firebaseRecord.name === localRecord.name;
                    const timeMatch = (firebaseRecord.time === localRecord.time);
                    
                    return nameMatch && timeMatch;
                });
                
                if (!matchingLocalRecord) {
                    conflicts.push({
                        type: 'attendance_extra',
                        description: `ç­¾åˆ°è®°å½•å¤šä½™: ${firebaseRecord.name} åœ¨ ${firebaseRecord.time || firebaseRecord.date} çš„è®°å½•åœ¨æœ¬åœ°ç¼ºå¤±`,
                        firebaseRecord: firebaseRecord,
                        severity: 'low'
                    });
                }
            });
            
            return conflicts;
        }
        
        // æ˜¾ç¤ºå†²çª
        function displayConflicts(conflicts) {
            const container = document.getElementById('conflictResults');
            if (!container) return;
            
            if (conflicts.length === 0) {
                container.innerHTML = '<div class="no-conflicts">âœ… æœªæ£€æµ‹åˆ°æ•°æ®å†²çª</div>';
                return;
            }
            
            // åˆ†æå†²çªç±»å‹ç»Ÿè®¡
            const conflictStats = analyzeConflictTypes(conflicts);
            
            let html = `
                <div class="conflict-summary">
                    <h3>ğŸ“Š å†²çªåˆ†ææŠ¥å‘Š</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${conflicts.length}</div>
                            <div class="stat-label">æ€»å†²çªæ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.uuid_conflict || 0}</div>
                            <div class="stat-label">UUIDå†²çª</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.duplicate_record || 0}</div>
                            <div class="stat-label">é‡å¤è®°å½•</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.group_name}</div>
                            <div class="stat-label">å°ç»„åç§°å†²çª</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.data_inconsistency}</div>
                            <div class="stat-label">æ•°æ®ä¸ä¸€è‡´</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.attendance_conflict || 0}</div>
                            <div class="stat-label">ç­¾åˆ°è®°å½•å†²çª</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.attendance_missing || 0}</div>
                            <div class="stat-label">ç­¾åˆ°è®°å½•ç¼ºå¤±</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${conflictStats.attendance_extra || 0}</div>
                            <div class="stat-label">ç­¾åˆ°è®°å½•å¤šä½™</div>
                        </div>
                    </div>
                </div>
                <div class="conflicts-list">
            `;
            
            conflicts.forEach((conflict, index) => {
                html += `
                    <div class="conflict-item">
                        <div class="conflict-header">
                            <span class="conflict-type ${conflict.severity}">${conflict.type}</span>
                            <span class="conflict-description">${conflict.description}</span>
                        </div>
                        <div class="conflict-details">
                            ${getConflictDetails(conflict)}
                        </div>
                        <div class="conflict-actions">
                            <button class="btn btn-sm btn-primary" onclick="resolveConflict(${index})">è§£å†³</button>
                            <button class="btn btn-sm btn-warning" onclick="ignoreConflict(${index})">å¿½ç•¥</button>
                            <button class="btn btn-sm btn-info" onclick="showConflictDetails(${index})">è¯¦æƒ…</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // è·å–å†²çªè¯¦æƒ…
        function getConflictDetails(conflict) {
            switch (conflict.type) {
                case 'uuid_conflict':
                    return `
                        <div class="conflict-detail-item">
                            <strong>UUID:</strong> ${conflict.members?.[0]?.uuid || 'N/A'}<br>
                            <strong>å†²çªæˆå‘˜:</strong> 
                            ${conflict.members?.map(member => `${member.name || member} (${member.group || 'æœªçŸ¥å°ç»„'})`).join(', ') || 'N/A'}<br>
                            <strong>é—®é¢˜ç±»å‹:</strong> ä¸åŒçš„äººä½¿ç”¨ç›¸åŒUUID
                        </div>
                    `;
                case 'duplicate_record':
                    // åˆ†æé‡å¤è®°å½•çš„è¯¦ç»†ä¿¡æ¯
                    const analysis = analyzeDuplicateRecord(conflict);
                    return `
                        <div class="conflict-detail-item">
                            <strong>UUID:</strong> ${conflict.uuid || 'N/A'}<br>
                            <strong>é‡å¤æˆå‘˜:</strong> ${conflict.name} (${conflict.group})<br>
                            <strong>é—®é¢˜ç±»å‹:</strong> åŒä¸€ä¸ªäººå­˜åœ¨é‡å¤è®°å½•<br>
                            <strong>é‡å¤æ¥æº:</strong> ${analysis.source}<br>
                            <strong>é‡å¤ç±»å‹:</strong> ${analysis.type}<br>
                            <strong>è¯¦ç»†ä¿¡æ¯:</strong><br>
                            ${analysis.details}
                            <strong>è§£å†³æ–¹æ¡ˆ:</strong> å»ºè®®åˆå¹¶é‡å¤è®°å½•ï¼Œä¿ç•™ä¸€ä¸ªè®°å½•
                        </div>
                    `;
                case 'uuid':
                    return `
                        <div class="conflict-detail-item">
                            <strong>UUID:</strong> ${conflict.members?.[0]?.uuid || 'N/A'}<br>
                            <strong>å†²çªæˆå‘˜:</strong> 
                            ${conflict.members?.map(member => `${member.name || member} (${member.group || 'æœªçŸ¥å°ç»„'})`).join(', ') || 'N/A'}
                        </div>
                    `;
                case 'group_name':
                    // åˆ†æå°ç»„åç§°å†²çªçš„è¯¦ç»†ä¿¡æ¯
                    const groupConflictAnalysis = analyzeGroupNameConflict(conflict);
                    return `
                        <div class="conflict-detail-item">
                            <strong>æˆå‘˜å§“å:</strong> ${conflict.members?.[0]?.name || 'N/A'}<br>
                            <strong>å†²çªç±»å‹:</strong> ${groupConflictAnalysis.type}<br>
                            <strong>å†²çªè¯¦æƒ…:</strong><br>
                            ${groupConflictAnalysis.details}
                            <strong>è§£å†³æ–¹æ¡ˆ:</strong> ${groupConflictAnalysis.solution}
                        </div>
                    `;
                case 'data_inconsistency':
                    return `
                        <div class="conflict-detail-item">
                            <strong>å°ç»„:</strong> ${conflict.groupName || 'N/A'}<br>
                            <strong>æœ¬åœ°æˆå‘˜æ•°:</strong> ${conflict.localCount || 0}<br>
                            <strong>Firebaseæˆå‘˜æ•°:</strong> ${conflict.firebaseCount || 0}
                        </div>
                    `;
                case 'attendance_conflict':
                    // åˆ†æç­¾åˆ°è®°å½•å†²çªçš„è¯¦ç»†ä¿¡æ¯
                    const attendanceAnalysis = analyzeAttendanceConflict(conflict);
                    return `
                        <div class="conflict-detail-item">
                            <strong>å§“å:</strong> ${conflict.localRecord?.name || 'N/A'}<br>
                            <strong>æ—¶é—´:</strong> ${conflict.localRecord?.time || conflict.localRecord?.date || 'N/A'}<br>
                            <strong>å†²çªç±»å‹:</strong> ${attendanceAnalysis.type}<br>
                            <strong>å†²çªè¯¦æƒ…:</strong><br>
                            ${attendanceAnalysis.details}
                            <strong>è§£å†³æ–¹æ¡ˆ:</strong> ${attendanceAnalysis.solution}
                        </div>
                    `;
                case 'attendance_missing':
                    return `
                        <div class="conflict-detail-item">
                            <strong>å§“å:</strong> ${conflict.localRecord?.name || 'N/A'}<br>
                            <strong>æ—¶é—´:</strong> ${conflict.localRecord?.time || conflict.localRecord?.date || 'N/A'}<br>
                            <strong>å°ç»„:</strong> ${conflict.localRecord?.group || 'N/A'}<br>
                            <strong>çŠ¶æ€:</strong> æœ¬åœ°æœ‰ï¼ŒFirebaseç¼ºå¤±
                        </div>
                    `;
                case 'attendance_extra':
                    return `
                        <div class="conflict-detail-item">
                            <strong>å§“å:</strong> ${conflict.firebaseRecord?.name || 'N/A'}<br>
                            <strong>æ—¶é—´:</strong> ${conflict.firebaseRecord?.time || conflict.firebaseRecord?.date || 'N/A'}<br>
                            <strong>å°ç»„:</strong> ${conflict.firebaseRecord?.group || 'N/A'}<br>
                            <strong>çŠ¶æ€:</strong> Firebaseæœ‰ï¼Œæœ¬åœ°ç¼ºå¤±
                        </div>
                    `;
                default:
                    return `
                        <div class="conflict-detail-item">
                            <strong>è¯¦ç»†ä¿¡æ¯:</strong> ${JSON.stringify(conflict, null, 2)}
                        </div>
                    `;
            }
        }
        
        // æ˜¾ç¤ºå†²çªè¯¦æƒ…
        function showConflictDetails(index) {
            if (index >= 0 && index < detectedConflicts.length) {
                const conflict = detectedConflicts[index];
                const details = getConflictDetails(conflict);
                
                alert(`å†²çªè¯¦æƒ… (${conflict.type}):\n\n${conflict.description}\n\nè¯¦ç»†ä¿¡æ¯:\n${details}`);
            }
        }
        
        // è¯¦ç»†æ•°æ®å¯¹æ¯”åˆ†æ
        function performDetailedDataComparison(localGroups, firebaseGroups, localAttendanceRecords, firebaseAttendanceRecords) {
            console.log('\n=== è¯¦ç»†æ•°æ®å¯¹æ¯”åˆ†æ ===');
            
            const comparison = {
                localOnly: [],
                firebaseOnly: [],
                common: [],
                conflicts: []
            };
            
            // æ”¶é›†æ‰€æœ‰æœ¬åœ°æˆå‘˜
            const localMembers = [];
            Object.entries(localGroups).forEach(([groupName, members]) => {
                if (Array.isArray(members)) {
                    members.forEach(member => {
                        if (member && member.name) {
                            localMembers.push({
                                ...member,
                                _source: 'local',
                                _groupName: groupName
                            });
                        }
                    });
                }
            });
            
            // æ”¶é›†æ‰€æœ‰Firebaseæˆå‘˜
            const firebaseMembers = [];
            Object.entries(firebaseGroups).forEach(([groupName, members]) => {
                if (Array.isArray(members)) {
                    members.forEach(member => {
                        if (member && member.name) {
                            firebaseMembers.push({
                                ...member,
                                _source: 'firebase',
                                _groupName: groupName
                            });
                        }
                    });
                }
            });
            
            console.log('æœ¬åœ°æˆå‘˜æ€»æ•°:', localMembers.length);
            console.log('Firebaseæˆå‘˜æ€»æ•°:', firebaseMembers.length);
            console.log('æœ¬åœ°æˆå‘˜è¯¦æƒ…:', localMembers);
            console.log('Firebaseæˆå‘˜è¯¦æƒ…:', firebaseMembers);
            
            // æŒ‰UUIDåˆ†ç»„åˆ†æ
            const uuidMap = new Map();
            
            // æ·»åŠ æœ¬åœ°æˆå‘˜åˆ°UUIDæ˜ å°„
            localMembers.forEach(member => {
                if (member.uuid) {
                    if (!uuidMap.has(member.uuid)) {
                        uuidMap.set(member.uuid, []);
                    }
                    uuidMap.get(member.uuid).push(member);
                }
            });
            
            // æ·»åŠ Firebaseæˆå‘˜åˆ°UUIDæ˜ å°„
            firebaseMembers.forEach(member => {
                if (member.uuid) {
                    if (!uuidMap.has(member.uuid)) {
                        uuidMap.set(member.uuid, []);
                    }
                    uuidMap.get(member.uuid).push(member);
                }
            });
            
            // åˆ†ææ¯ä¸ªUUIDçš„æƒ…å†µ
            console.log('\n=== UUIDåˆ†æ ===');
            uuidMap.forEach((members, uuid) => {
                console.log(`\nUUID: ${uuid}`);
                console.log('æˆå‘˜æ•°é‡:', members.length);
                console.log('æˆå‘˜è¯¦æƒ…:', members);
                
                if (members.length === 1) {
                    const member = members[0];
                    if (member._source === 'local') {
                        comparison.localOnly.push(member);
                        console.log('ä»…å­˜åœ¨äºæœ¬åœ°');
                    } else {
                        comparison.firebaseOnly.push(member);
                        console.log('ä»…å­˜åœ¨äºFirebase');
                    }
                } else {
                    // å¤šä¸ªæˆå‘˜ä½¿ç”¨ç›¸åŒUUID
                    const localMembers = members.filter(m => m._source === 'local');
                    const firebaseMembers = members.filter(m => m._source === 'firebase');
                    
                    console.log('æœ¬åœ°æˆå‘˜:', localMembers.length);
                    console.log('Firebaseæˆå‘˜:', firebaseMembers.length);
                    
                    if (localMembers.length > 0 && firebaseMembers.length > 0) {
                        // è·¨æ•°æ®æºé‡å¤
                        comparison.conflicts.push({
                            type: 'cross_source_duplicate',
                            uuid: uuid,
                            localMembers: localMembers,
                            firebaseMembers: firebaseMembers,
                            description: `UUID ${uuid} åœ¨æœ¬åœ°å’ŒFirebaseä¸­éƒ½å­˜åœ¨`
                        });
                        console.log('è·¨æ•°æ®æºé‡å¤');
                    } else if (localMembers.length > 1) {
                        // æœ¬åœ°å†…éƒ¨é‡å¤
                        comparison.conflicts.push({
                            type: 'local_duplicate',
                            uuid: uuid,
                            members: localMembers,
                            description: `UUID ${uuid} åœ¨æœ¬åœ°æ•°æ®ä¸­å­˜åœ¨é‡å¤`
                        });
                        console.log('æœ¬åœ°å†…éƒ¨é‡å¤');
                    } else if (firebaseMembers.length > 1) {
                        // Firebaseå†…éƒ¨é‡å¤
                        comparison.conflicts.push({
                            type: 'firebase_duplicate',
                            uuid: uuid,
                            members: firebaseMembers,
                            description: `UUID ${uuid} åœ¨Firebaseæ•°æ®ä¸­å­˜åœ¨é‡å¤`
                        });
                        console.log('Firebaseå†…éƒ¨é‡å¤');
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€äºº
                    const firstMember = members[0];
                    const isSamePerson = members.every(member => 
                        member.name === firstMember.name && 
                        member._groupName === firstMember._groupName
                    );
                    
                    console.log('æ˜¯å¦åŒä¸€äºº:', isSamePerson);
                    if (isSamePerson) {
                        console.log('åˆ¤æ–­ä¸ºåŒä¸€äººé‡å¤è®°å½•');
                    } else {
                        console.log('åˆ¤æ–­ä¸ºä¸åŒäººä½¿ç”¨ç›¸åŒUUID');
                    }
                }
            });
            
            // æŒ‰å§“ååˆ†ç»„åˆ†æï¼ˆæ²¡æœ‰UUIDçš„æƒ…å†µï¼‰
            console.log('\n=== å§“ååˆ†æ ===');
            const nameMap = new Map();
            
            // æ·»åŠ æ‰€æœ‰æˆå‘˜åˆ°å§“åæ˜ å°„
            [...localMembers, ...firebaseMembers].forEach(member => {
                if (!member.uuid && member.name) {
                    if (!nameMap.has(member.name)) {
                        nameMap.set(member.name, []);
                    }
                    nameMap.get(member.name).push(member);
                }
            });
            
            nameMap.forEach((members, name) => {
                if (members.length > 1) {
                    console.log(`\nå§“å: ${name}`);
                    console.log('æˆå‘˜æ•°é‡:', members.length);
                    console.log('æˆå‘˜è¯¦æƒ…:', members);
                    
                    const localMembers = members.filter(m => m._source === 'local');
                    const firebaseMembers = members.filter(m => m._source === 'firebase');
                    
                    if (localMembers.length > 0 && firebaseMembers.length > 0) {
                        comparison.conflicts.push({
                            type: 'name_cross_source',
                            name: name,
                            localMembers: localMembers,
                            firebaseMembers: firebaseMembers,
                            description: `å§“å ${name} åœ¨æœ¬åœ°å’ŒFirebaseä¸­éƒ½å­˜åœ¨`
                        });
                        console.log('è·¨æ•°æ®æºåŒå');
                    }
                }
            });
            
            console.log('\n=== å¯¹æ¯”ç»“æœç»Ÿè®¡ ===');
            console.log('ä»…æœ¬åœ°å­˜åœ¨:', comparison.localOnly.length);
            console.log('ä»…Firebaseå­˜åœ¨:', comparison.firebaseOnly.length);
            console.log('å†²çªæ•°é‡:', comparison.conflicts.length);
            console.log('è¯¦ç»†å†²çªåˆ—è¡¨:', comparison.conflicts);
            
            return comparison;
        }
        
        // åˆ†æé‡å¤è®°å½•çš„è¯¦ç»†ä¿¡æ¯
        function analyzeDuplicateRecord(conflict) {
            const existingMember = conflict.existingMember;
            const duplicateMember = conflict.duplicateMember;
            
            console.log('=== é‡å¤è®°å½•è¯¦ç»†åˆ†æ ===');
            console.log('ç°æœ‰æˆå‘˜:', existingMember);
            console.log('é‡å¤æˆå‘˜:', duplicateMember);
            
            // æ£€æŸ¥æ•°æ®æ¥æº
            let source = 'æœªçŸ¥';
            if (existingMember && duplicateMember) {
                // æ£€æŸ¥æ˜¯å¦æ¥è‡ªä¸åŒæ•°æ®æº
                const existingSource = existingMember._source || 'unknown';
                const duplicateSource = duplicateMember._source || 'unknown';
                
                console.log('æ•°æ®æ¥æºæ£€æŸ¥:', {
                    existingSource: existingSource,
                    duplicateSource: duplicateSource,
                    existingMember: existingMember,
                    duplicateMember: duplicateMember
                });
                
                if (existingSource === 'local' && duplicateSource === 'firebase') {
                    source = 'æœ¬åœ°æ•°æ®ä¸Firebaseæ•°æ®é‡å¤';
                } else if (existingSource === 'firebase' && duplicateSource === 'local') {
                    source = 'Firebaseæ•°æ®ä¸æœ¬åœ°æ•°æ®é‡å¤';
                } else if (existingSource === 'local' && duplicateSource === 'local') {
                    source = 'æœ¬åœ°æ•°æ®å†…éƒ¨é‡å¤';
                } else if (existingSource === 'firebase' && duplicateSource === 'firebase') {
                    source = 'Firebaseæ•°æ®å†…éƒ¨é‡å¤';
                } else {
                    // è¯¦ç»†åˆ†ææ•°æ®æ¥æº
                    const existingDetails = analyzeDataSource(existingMember);
                    const duplicateDetails = analyzeDataSource(duplicateMember);
                    source = `æ•°æ®æ¥æºåˆ†æ: ç°æœ‰è®°å½•(${existingDetails}) vs é‡å¤è®°å½•(${duplicateDetails})`;
                }
            }
            
            // ç»Ÿè®¡è¯¥æˆå‘˜åœ¨æœ¬åœ°å’ŒFirebaseä¸­çš„æ•°é‡
            const memberCounts = countMemberInDataSources(conflict.uuid, conflict.name);
            
            // æ£€æŸ¥é‡å¤ç±»å‹
            let type = 'æœªçŸ¥';
            let details = '';
            
            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            details += `<strong>æ•°æ®ç»Ÿè®¡:</strong><br>
                        æœ¬åœ°æ•°æ®ä¸­: ${memberCounts.localCount} æ¡è®°å½•<br>
                        Firebaseæ•°æ®ä¸­: ${memberCounts.firebaseCount} æ¡è®°å½•<br>
                        æ€»è®¡: ${memberCounts.totalCount} æ¡è®°å½•<br><br>`;
            
            // æ£€æŸ¥ç­¾åˆ°è®°å½•é‡å¤
            if (existingMember.attendanceRecords && duplicateMember.attendanceRecords) {
                const existingRecords = existingMember.attendanceRecords;
                const duplicateRecords = duplicateMember.attendanceRecords;
                
                console.log('ç°æœ‰æˆå‘˜ç­¾åˆ°è®°å½•:', existingRecords);
                console.log('é‡å¤æˆå‘˜ç­¾åˆ°è®°å½•:', duplicateRecords);
                
                // æ£€æŸ¥åŒä¸€å¤©ç­¾åˆ°
                const sameDayRecords = [];
                existingRecords.forEach(existing => {
                    duplicateRecords.forEach(duplicate => {
                        if (existing.date === duplicate.date) {
                            sameDayRecords.push({
                                date: existing.date,
                                existingStatus: existing.status,
                                duplicateStatus: duplicate.status,
                                existingTime: existing.time,
                                duplicateTime: duplicate.time
                            });
                        }
                    });
                });
                
                if (sameDayRecords.length > 0) {
                    type = 'åŒä¸€å¤©ç­¾åˆ°è®°å½•é‡å¤';
                    details = sameDayRecords.map(record => 
                        `æ—¥æœŸ: ${record.date}, ç°æœ‰çŠ¶æ€: ${record.existingStatus} (${record.existingTime}), é‡å¤çŠ¶æ€: ${record.duplicateStatus} (${record.duplicateTime})`
                    ).join('<br>');
                } else {
                    type = 'ä¸åŒæ—¥æœŸç­¾åˆ°è®°å½•é‡å¤';
                    details = `ç°æœ‰æˆå‘˜ç­¾åˆ°å¤©æ•°: ${existingRecords.length}, é‡å¤æˆå‘˜ç­¾åˆ°å¤©æ•°: ${duplicateRecords.length}`;
                }
            } else if (existingMember.attendanceRecords || duplicateMember.attendanceRecords) {
                type = 'éƒ¨åˆ†ç­¾åˆ°è®°å½•é‡å¤';
                details = `ç°æœ‰æˆå‘˜ç­¾åˆ°è®°å½•: ${existingMember.attendanceRecords ? existingMember.attendanceRecords.length : 0} æ¡<br>
                          é‡å¤æˆå‘˜ç­¾åˆ°è®°å½•: ${duplicateMember.attendanceRecords ? duplicateMember.attendanceRecords.length : 0} æ¡`;
            } else {
                type = 'åŸºç¡€ä¿¡æ¯é‡å¤';
                details += 'ä»…åŸºç¡€æˆå‘˜ä¿¡æ¯é‡å¤ï¼Œæ— ç­¾åˆ°è®°å½•';
            }
            
            // æ£€æŸ¥å…¶ä»–å­—æ®µå·®å¼‚
            const fieldDifferences = [];
            const fieldsToCheck = ['name', 'group', 'phone', 'email', 'joinDate', 'status', 'uuid', '_groupName'];
            
            // è¯¦ç»†å¯¹æ¯”ä¸¤ä¸ªæˆå‘˜çš„æ‰€æœ‰å­—æ®µ
            console.log('=== è¯¦ç»†å­—æ®µå¯¹æ¯” ===');
            console.log('ç°æœ‰æˆå‘˜å®Œæ•´æ•°æ®:', existingMember);
            console.log('é‡å¤æˆå‘˜å®Œæ•´æ•°æ®:', duplicateMember);
            
            fieldsToCheck.forEach(field => {
                const existingValue = existingMember[field];
                const duplicateValue = duplicateMember[field];
                
                console.log(`å­—æ®µ ${field}: ç°æœ‰å€¼="${existingValue}", é‡å¤å€¼="${duplicateValue}"`);
                
                if (existingValue !== duplicateValue) {
                    fieldDifferences.push(`${field}: ç°æœ‰å€¼="${existingValue}", é‡å¤å€¼="${duplicateValue}"`);
                }
            });
            
            // æ£€æŸ¥æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬åŠ¨æ€å­—æ®µï¼‰
            const allFields = new Set([...Object.keys(existingMember), ...Object.keys(duplicateMember)]);
            console.log('æ‰€æœ‰å­—æ®µ:', Array.from(allFields));
            
            allFields.forEach(field => {
                if (!fieldsToCheck.includes(field)) {
                    const existingValue = existingMember[field];
                    const duplicateValue = duplicateMember[field];
                    
                    if (existingValue !== duplicateValue) {
                        fieldDifferences.push(`${field}: ç°æœ‰å€¼="${existingValue}", é‡å¤å€¼="${duplicateValue}"`);
                        console.log(`é¢å¤–å­—æ®µå·®å¼‚ ${field}: ç°æœ‰å€¼="${existingValue}", é‡å¤å€¼="${duplicateValue}"`);
                    }
                }
            });
            
            if (fieldDifferences.length > 0) {
                details += '<br><strong>å­—æ®µå·®å¼‚:</strong><br>' + fieldDifferences.join('<br>');
                console.log('å‘ç°å­—æ®µå·®å¼‚:', fieldDifferences);
            } else {
                details += '<br><strong>å­—æ®µå¯¹æ¯”:</strong> æ‰€æœ‰å­—æ®µå®Œå…¨ä¸€è‡´';
                console.log('æ‰€æœ‰å­—æ®µå®Œå…¨ä¸€è‡´');
            }
            
            console.log('åˆ†æç»“æœ:', { source, type, details });
            
            return { source, type, details };
        }
        
        // æ£€æŸ¥æ˜¯å¦åªæ˜¯æ•°æ®æ¥æºä¸åŒ
        function checkIfOnlySourceDifferent(member1, member2) {
            console.log('æ£€æŸ¥æ˜¯å¦åªæ˜¯æ•°æ®æ¥æºä¸åŒ:', member1, member2);
            
            // è·å–æ‰€æœ‰å­—æ®µï¼ˆæ’é™¤æ¥æºæ ‡è¯†å­—æ®µï¼‰
            const excludeFields = ['_source', '_groupName', '_originalData'];
            const allFields = new Set([...Object.keys(member1), ...Object.keys(member2)]);
            
            let hasRealDifference = false;
            
            allFields.forEach(field => {
                if (!excludeFields.includes(field)) {
                    const value1 = member1[field];
                    const value2 = member2[field];
                    
                    console.log(`æ£€æŸ¥å­—æ®µ ${field}: "${value1}" vs "${value2}"`);
                    
                    if (value1 !== value2) {
                        console.log(`å‘ç°çœŸå®å·®å¼‚: ${field} = "${value1}" vs "${value2}"`);
                        hasRealDifference = true;
                    }
                }
            });
            
            const isOnlySourceDifferent = !hasRealDifference;
            console.log('æ˜¯å¦åªæ˜¯æ¥æºä¸åŒ:', isOnlySourceDifferent);
            
            return isOnlySourceDifferent;
        }
        
        // åˆ†æå°ç»„åç§°å†²çªçš„è¯¦ç»†ä¿¡æ¯
        function analyzeGroupNameConflict(conflict) {
            console.log('=== å°ç»„åç§°å†²çªè¯¦ç»†åˆ†æ ===');
            console.log('å†²çªå¯¹è±¡:', conflict);
            
            const members = conflict.members || [];
            if (members.length < 2) {
                return {
                    type: 'æ•°æ®ä¸å®Œæ•´',
                    details: 'æ— æ³•åˆ†æå†²çªè¯¦æƒ…',
                    solution: 'è¯·æ£€æŸ¥æ•°æ®å®Œæ•´æ€§'
                };
            }
            
            const member1 = members[0];
            const member2 = members[1];
            
            console.log('æˆå‘˜1:', member1);
            console.log('æˆå‘˜2:', member2);
            
            // åˆ†ææ•°æ®æ¥æº
            const source1 = member1._source || 'unknown';
            const source2 = member2._source || 'unknown';
            const group1 = member1.group || member1._groupName || 'æœªçŸ¥å°ç»„';
            const group2 = member2.group || member2._groupName || 'æœªçŸ¥å°ç»„';
            
            console.log('æ•°æ®æ¥æºåˆ†æ:', {
                member1: { source: source1, group: group1 },
                member2: { source: source2, group: group2 }
            });
            
            let type = 'æœªçŸ¥å†²çª';
            let details = '';
            let solution = '';
            
            if (source1 === 'local' && source2 === 'firebase') {
                type = 'æœ¬åœ°ä¸Firebaseå°ç»„ä¸ä¸€è‡´';
                details = `
                    æœ¬åœ°æ•°æ®: ${member1.name} åœ¨å°ç»„ "${group1}"<br>
                    Firebaseæ•°æ®: ${member2.name} åœ¨å°ç»„ "${group2}"<br>
                    <strong>é—®é¢˜:</strong> åŒä¸€æˆå‘˜åœ¨æœ¬åœ°å’ŒFirebaseä¸­è¢«åˆ†é…åˆ°ä¸åŒå°ç»„
                `;
                solution = 'å»ºè®®ç»Ÿä¸€å°ç»„åˆ†é…ï¼Œä»¥æœ€æ–°æ•°æ®ä¸ºå‡†æˆ–æ‰‹åŠ¨è°ƒæ•´';
            } else if (source1 === 'firebase' && source2 === 'local') {
                type = 'Firebaseä¸æœ¬åœ°å°ç»„ä¸ä¸€è‡´';
                details = `
                    Firebaseæ•°æ®: ${member1.name} åœ¨å°ç»„ "${group1}"<br>
                    æœ¬åœ°æ•°æ®: ${member2.name} åœ¨å°ç»„ "${group2}"<br>
                    <strong>é—®é¢˜:</strong> åŒä¸€æˆå‘˜åœ¨Firebaseå’Œæœ¬åœ°ä¸­è¢«åˆ†é…åˆ°ä¸åŒå°ç»„
                `;
                solution = 'å»ºè®®ç»Ÿä¸€å°ç»„åˆ†é…ï¼Œä»¥æœ€æ–°æ•°æ®ä¸ºå‡†æˆ–æ‰‹åŠ¨è°ƒæ•´';
            } else if (source1 === 'local' && source2 === 'local') {
                type = 'æœ¬åœ°æ•°æ®å†…éƒ¨å°ç»„å†²çª';
                details = `
                    æœ¬åœ°è®°å½•1: ${member1.name} åœ¨å°ç»„ "${group1}"<br>
                    æœ¬åœ°è®°å½•2: ${member2.name} åœ¨å°ç»„ "${group2}"<br>
                    <strong>é—®é¢˜:</strong> æœ¬åœ°æ•°æ®ä¸­å­˜åœ¨é‡å¤è®°å½•ï¼Œå°ç»„åˆ†é…ä¸ä¸€è‡´
                `;
                solution = 'å»ºè®®åˆå¹¶é‡å¤è®°å½•ï¼Œä¿ç•™ä¸€ä¸ªè®°å½•';
            } else if (source1 === 'firebase' && source2 === 'firebase') {
                type = 'Firebaseæ•°æ®å†…éƒ¨å°ç»„å†²çª';
                details = `
                    Firebaseè®°å½•1: ${member1.name} åœ¨å°ç»„ "${group1}"<br>
                    Firebaseè®°å½•2: ${member2.name} åœ¨å°ç»„ "${group2}"<br>
                    <strong>é—®é¢˜:</strong> Firebaseæ•°æ®ä¸­å­˜åœ¨é‡å¤è®°å½•ï¼Œå°ç»„åˆ†é…ä¸ä¸€è‡´
                `;
                solution = 'å»ºè®®åœ¨Firebaseä¸­åˆå¹¶é‡å¤è®°å½•';
            } else {
                type = 'æœªçŸ¥æ•°æ®æºå†²çª';
                details = `
                    è®°å½•1: ${member1.name} (æ¥æº: ${source1}) åœ¨å°ç»„ "${group1}"<br>
                    è®°å½•2: ${member2.name} (æ¥æº: ${source2}) åœ¨å°ç»„ "${group2}"<br>
                    <strong>é—®é¢˜:</strong> æ•°æ®æ¥æºä¸æ˜ç¡®ï¼Œå°ç»„åˆ†é…ä¸ä¸€è‡´
                `;
                solution = 'å»ºè®®æ£€æŸ¥æ•°æ®æ¥æºå’ŒåŒæ­¥çŠ¶æ€';
            }
            
            // æ·»åŠ UUIDä¿¡æ¯
            if (member1.uuid && member2.uuid) {
                details += `<br><strong>UUIDä¿¡æ¯:</strong><br>
                            è®°å½•1 UUID: ${member1.uuid}<br>
                            è®°å½•2 UUID: ${member2.uuid}`;
                
                if (member1.uuid === member2.uuid) {
                    details += '<br><strong>UUIDçŠ¶æ€:</strong> ç›¸åŒUUIDï¼Œç¡®è®¤æ˜¯åŒä¸€äºº';
                } else {
                    details += '<br><strong>UUIDçŠ¶æ€:</strong> ä¸åŒUUIDï¼Œå¯èƒ½æ˜¯ä¸åŒçš„äºº';
                }
            }
            
            console.log('åˆ†æç»“æœ:', { type, details, solution });
            
            return { type, details, solution };
        }
        
        // åˆ†æç­¾åˆ°è®°å½•å†²çªçš„è¯¦ç»†ä¿¡æ¯
        function analyzeAttendanceConflict(conflict) {
            console.log('=== ç­¾åˆ°è®°å½•å†²çªè¯¦ç»†åˆ†æ ===');
            console.log('å†²çªå¯¹è±¡:', conflict);
            
            const localRecord = conflict.localRecord;
            const firebaseRecord = conflict.firebaseRecord;
            
            if (!localRecord || !firebaseRecord) {
                return {
                    type: 'æ•°æ®ä¸å®Œæ•´',
                    details: 'æ— æ³•åˆ†æå†²çªè¯¦æƒ…',
                    solution: 'è¯·æ£€æŸ¥æ•°æ®å®Œæ•´æ€§'
                };
            }
            
            console.log('æœ¬åœ°è®°å½•:', localRecord);
            console.log('Firebaseè®°å½•:', firebaseRecord);
            
            // æ”¶é›†æ‰€æœ‰å­—æ®µè¿›è¡Œå¯¹æ¯”
            const allFields = new Set([...Object.keys(localRecord), ...Object.keys(firebaseRecord)]);
            const fieldDifferences = [];
            
            console.log('æ‰€æœ‰å­—æ®µ:', Array.from(allFields));
            
            allFields.forEach(field => {
                const localValue = localRecord[field];
                const firebaseValue = firebaseRecord[field];
                
                console.log(`å­—æ®µ ${field}: æœ¬åœ°="${localValue}", Firebase="${firebaseValue}"`);
                
                if (localValue !== firebaseValue) {
                    fieldDifferences.push({
                        field: field,
                        localValue: localValue,
                        firebaseValue: firebaseValue
                    });
                }
            });
            
            console.log('å­—æ®µå·®å¼‚:', fieldDifferences);
            
            let type = 'ç­¾åˆ°è®°å½•ä¸ä¸€è‡´';
            let details = '';
            let solution = '';
            
            if (fieldDifferences.length === 0) {
                type = 'è®°å½•å®Œå…¨ä¸€è‡´';
                details = 'æœ¬åœ°å’ŒFirebaseè®°å½•å®Œå…¨ç›¸åŒï¼Œå¯èƒ½æ˜¯æ£€æµ‹é€»è¾‘é—®é¢˜';
                solution = 'å»ºè®®æ£€æŸ¥å†²çªæ£€æµ‹é€»è¾‘';
            } else {
                // æ„å»ºè¯¦ç»†ä¿¡æ¯
                details = '<strong>å­—æ®µå·®å¼‚å¯¹æ¯”:</strong><br>';
                fieldDifferences.forEach(diff => {
                    details += `${diff.field}: æœ¬åœ°="${diff.localValue}" vs Firebase="${diff.firebaseValue}"<br>`;
                });
                
                // åˆ†æå…·ä½“çš„å†²çªç±»å‹
                const nameConflict = fieldDifferences.find(diff => diff.field === 'name');
                const timeConflict = fieldDifferences.find(diff => diff.field === 'time' || diff.field === 'date');
                const groupConflict = fieldDifferences.find(diff => diff.field === 'group');
                const statusConflict = fieldDifferences.find(diff => diff.field === 'status');
                
                if (nameConflict) {
                    type = 'å§“åä¸ä¸€è‡´';
                    solution = 'å»ºè®®ç»Ÿä¸€æˆå‘˜å§“åï¼Œä»¥æœ€æ–°æ•°æ®ä¸ºå‡†';
                } else if (timeConflict) {
                    type = 'ç­¾åˆ°æ—¶é—´ä¸ä¸€è‡´';
                    solution = 'å»ºè®®ä»¥æœ€æ–°ç­¾åˆ°æ—¶é—´ä¸ºå‡†ï¼Œæˆ–æ‰‹åŠ¨ç¡®è®¤æ­£ç¡®æ—¶é—´';
                } else if (groupConflict) {
                    type = 'å°ç»„å½’å±ä¸ä¸€è‡´';
                    solution = 'å»ºè®®ç»Ÿä¸€å°ç»„å½’å±ï¼Œä»¥æœ€æ–°æ•°æ®ä¸ºå‡†';
                } else if (statusConflict) {
                    type = 'ç­¾åˆ°çŠ¶æ€ä¸ä¸€è‡´';
                    solution = 'å»ºè®®ä»¥æœ€æ–°ç­¾åˆ°çŠ¶æ€ä¸ºå‡†ï¼Œæˆ–æ‰‹åŠ¨ç¡®è®¤æ­£ç¡®çŠ¶æ€';
                } else {
                    type = 'å…¶ä»–å­—æ®µä¸ä¸€è‡´';
                    solution = 'å»ºè®®ä»¥æœ€æ–°æ•°æ®ä¸ºå‡†ï¼Œæˆ–æ‰‹åŠ¨ç¡®è®¤æ­£ç¡®ä¿¡æ¯';
                }
                
                // æ·»åŠ è®°å½•æ‘˜è¦
                details += '<br><strong>è®°å½•æ‘˜è¦:</strong><br>';
                details += `æœ¬åœ°è®°å½•: ${localRecord.name || 'N/A'} åœ¨ ${localRecord.time || localRecord.date || 'N/A'} ç­¾åˆ°åˆ°å°ç»„ ${localRecord.group || 'N/A'}<br>`;
                details += `Firebaseè®°å½•: ${firebaseRecord.name || 'N/A'} åœ¨ ${firebaseRecord.time || firebaseRecord.date || 'N/A'} ç­¾åˆ°åˆ°å°ç»„ ${firebaseRecord.group || 'N/A'}`;
            }
            
            console.log('åˆ†æç»“æœ:', { type, details, solution });
            
            return { type, details, solution };
        }
        
        // ç»Ÿè®¡æˆå‘˜åœ¨æ•°æ®æºä¸­çš„æ•°é‡
        function countMemberInDataSources(uuid, name) {
            console.log(`ç»Ÿè®¡æˆå‘˜ ${name} (${uuid}) åœ¨æ•°æ®æºä¸­çš„æ•°é‡`);
            
            const counts = {
                localCount: 0,
                firebaseCount: 0,
                totalCount: 0
            };
            
            // ç»Ÿè®¡æœ¬åœ°æ•°æ®
            try {
                const localGroups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                console.log('æœ¬åœ°å°ç»„æ•°æ®:', localGroups);
                Object.entries(localGroups).forEach(([groupName, members]) => {
                    if (Array.isArray(members)) {
                        console.log(`æ£€æŸ¥æœ¬åœ°å°ç»„ ${groupName}:`, members);
                        members.forEach(member => {
                            if (member && member.uuid === uuid && member.name === name) {
                                counts.localCount++;
                                console.log(`æœ¬åœ°å‘ç°: ${member.name} (${member.uuid}) åœ¨å°ç»„ ${groupName}`);
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('ç»Ÿè®¡æœ¬åœ°æ•°æ®æ—¶å‡ºé”™:', error);
            }
            
            // ç»Ÿè®¡Firebaseæ•°æ®
            try {
                console.log('Firebaseå°ç»„æ•°æ®:', window.firebaseGroups);
                const firebaseGroups = window.firebaseGroups || {};
                Object.entries(firebaseGroups).forEach(([groupName, members]) => {
                    if (Array.isArray(members)) {
                        console.log(`æ£€æŸ¥Firebaseå°ç»„ ${groupName}:`, members);
                        members.forEach(member => {
                            if (member && member.uuid === uuid && member.name === name) {
                                counts.firebaseCount++;
                                console.log(`Firebaseå‘ç°: ${member.name} (${member.uuid}) åœ¨å°ç»„ ${groupName}`);
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('ç»Ÿè®¡Firebaseæ•°æ®æ—¶å‡ºé”™:', error);
            }
            
            counts.totalCount = counts.localCount + counts.firebaseCount;
            
            console.log('ç»Ÿè®¡ç»“æœ:', counts);
            return counts;
        }
        
        // åˆ†ææ•°æ®æ¥æº
        function analyzeDataSource(member) {
            if (!member) return 'æ— æ•°æ®';
            
            console.log('åˆ†ææˆå‘˜æ•°æ®æ¥æº:', member);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰_sourceæ ‡è¯†
            if (member._source) {
                return `${member._source} (${member._groupName || 'æœªçŸ¥å°ç»„'})`;
            }
            
            // é€šè¿‡å…¶ä»–ç‰¹å¾åˆ¤æ–­æ•°æ®æ¥æº
            const indicators = [];
            
            // æ£€æŸ¥æ˜¯å¦æœ‰Firebaseç‰¹æœ‰çš„å­—æ®µ
            if (member.firebaseId || member.firebaseKey) {
                indicators.push('Firebaseç‰¹å¾');
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°å­˜å‚¨ç‰¹æœ‰çš„å­—æ®µ
            if (member.localId || member.localKey) {
                indicators.push('æœ¬åœ°ç‰¹å¾');
            }
            
            // æ£€æŸ¥æ—¶é—´æˆ³æ ¼å¼
            if (member.createdAt || member.updatedAt) {
                const timestamp = member.createdAt || member.updatedAt;
                if (typeof timestamp === 'number' && timestamp > 1000000000000) {
                    indicators.push('Firebaseæ—¶é—´æˆ³');
                } else if (typeof timestamp === 'string' && timestamp.includes('T')) {
                    indicators.push('ISOæ—¶é—´æ ¼å¼');
                }
            }
            
            // æ£€æŸ¥æ•°æ®ç»“æ„ç‰¹å¾
            if (member.attendanceRecords && Array.isArray(member.attendanceRecords)) {
                indicators.push('åŒ…å«ç­¾åˆ°è®°å½•');
            }
            
            // æ£€æŸ¥UUIDæ ¼å¼
            if (member.uuid) {
                if (member.uuid.length === 36 && member.uuid.includes('-')) {
                    indicators.push('æ ‡å‡†UUIDæ ¼å¼');
                } else {
                    indicators.push('éæ ‡å‡†UUIDæ ¼å¼');
                }
            }
            
            // æ£€æŸ¥å°ç»„ä¿¡æ¯
            if (member.group || member._groupName) {
                indicators.push(`å°ç»„: ${member.group || member._groupName}`);
            }
            
            // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
            const hasAllFields = member.name && member.uuid && (member.group || member._groupName);
            if (hasAllFields) {
                indicators.push('æ•°æ®å®Œæ•´');
            } else {
                indicators.push('æ•°æ®ä¸å®Œæ•´');
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é¢å¤–çš„å…ƒæ•°æ®
            const hasMetadata = member.lastModified || member.version || member.syncStatus;
            if (hasMetadata) {
                indicators.push('åŒ…å«å…ƒæ•°æ®');
            }
            
            // æ£€æŸ¥æ•°æ®æ–°é²œåº¦ï¼ˆé€šè¿‡æ—¶é—´æˆ³åˆ¤æ–­ï¼‰
            if (member.createdAt || member.updatedAt) {
                const timestamp = new Date(member.createdAt || member.updatedAt);
                const now = new Date();
                const diffHours = (now - timestamp) / (1000 * 60 * 60);
                if (diffHours < 24) {
                    indicators.push('æœ€è¿‘æ›´æ–°');
                } else {
                    indicators.push('è¾ƒæ—§æ•°æ®');
                }
            }
            
            console.log('æ•°æ®æ¥æºç‰¹å¾:', indicators);
            
            return indicators.length > 0 ? indicators.join(', ') : 'æœªçŸ¥æ¥æº';
        }
        
        // åˆ†æå†²çªç±»å‹ç»Ÿè®¡
        function analyzeConflictTypes(conflicts) {
            const stats = {
                uuid_conflict: 0,
                duplicate_record: 0,
                uuid: 0,
                group_name: 0,
                data_inconsistency: 0,
                attendance_conflict: 0,
                attendance_missing: 0,
                attendance_extra: 0
            };
            
            conflicts.forEach(conflict => {
                if (stats.hasOwnProperty(conflict.type)) {
                    stats[conflict.type]++;
                } else {
                    // ç»Ÿè®¡æœªçŸ¥ç±»å‹çš„å†²çª
                    if (!stats.unknown) stats.unknown = 0;
                    stats.unknown++;
                }
            });
            
            return stats;
        }
        
        // è§£å†³å†²çª
        function resolveConflict(index) {
            if (index >= 0 && index < detectedConflicts.length) {
                const conflict = detectedConflicts[index];
                showConflictResolutionDialog(conflict, index);
            }
        }
        
        // å¿½ç•¥å†²çª
        function ignoreConflict(index) {
            if (index >= 0 && index < detectedConflicts.length) {
                detectedConflicts.splice(index, 1);
                displayConflicts(detectedConflicts);
            }
        }
        
        // æ˜¾ç¤ºå†²çªè§£å†³å¯¹è¯æ¡†
        function showConflictResolutionDialog(conflict, index) {
            const dialog = document.getElementById('conflictResolutionDialog');
            const title = document.getElementById('conflictResolutionTitle');
            const body = document.getElementById('conflictResolutionBody');
            
            if (!dialog || !title || !body) return;
            
            title.textContent = `è§£å†³å†²çª: ${conflict.description}`;
            
            let html = '';
            switch (conflict.type) {
                case 'uuid':
                    html = `
                        <div class="conflict-resolution-options">
                            <label>
                                <input type="radio" name="resolution" value="keep_first" checked>
                                ä¿ç•™ç¬¬ä¸€ä¸ªæˆå‘˜
                            </label>
                            <label>
                                <input type="radio" name="resolution" value="keep_second">
                                ä¿ç•™ç¬¬äºŒä¸ªæˆå‘˜
                            </label>
                            <label>
                                <input type="radio" name="resolution" value="generate_new">
                                ä¸ºç¬¬äºŒä¸ªæˆå‘˜ç”Ÿæˆæ–°UUID
                            </label>
                        </div>
                    `;
                    break;
                case 'group_name':
                    html = `
                        <div class="conflict-resolution-options">
                            <label>
                                <input type="radio" name="resolution" value="keep_local" checked>
                                ä¿ç•™æœ¬åœ°æ•°æ®
                            </label>
                            <label>
                                <input type="radio" name="resolution" value="keep_firebase">
                                ä¿ç•™Firebaseæ•°æ®
                            </label>
                            <label>
                                <input type="radio" name="resolution" value="merge">
                                åˆå¹¶æ•°æ®
                            </label>
                        </div>
                    `;
                    break;
                case 'data_inconsistency':
                    html = `
                        <div class="conflict-resolution-options">
                            <label>
                                <input type="radio" name="resolution" value="sync_local" checked>
                                åŒæ­¥æœ¬åœ°æ•°æ®åˆ°Firebase
                            </label>
                            <label>
                                <input type="radio" name="resolution" value="sync_firebase">
                                ä»FirebaseåŒæ­¥æ•°æ®åˆ°æœ¬åœ°
                            </label>
                        </div>
                    `;
                    break;
            }
            
            body.innerHTML = html;
            currentConflictIndex = index;
            dialog.style.display = 'block';
        }
        
        // åº”ç”¨å†²çªè§£å†³æ–¹æ¡ˆ
        function applyConflictResolution() {
            const selectedResolution = document.querySelector('input[name="resolution"]:checked');
            if (!selectedResolution) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ');
                return;
            }
            
            const conflict = detectedConflicts[currentConflictIndex];
            const resolution = selectedResolution.value;
            
            console.log('åº”ç”¨è§£å†³æ–¹æ¡ˆ:', { conflict, resolution });
            
            // è¿™é‡Œåº”è¯¥å®ç°å…·ä½“çš„è§£å†³é€»è¾‘
            alert(`å·²åº”ç”¨è§£å†³æ–¹æ¡ˆ: ${resolution}`);
            
            // ç§»é™¤å·²è§£å†³çš„å†²çª
            detectedConflicts.splice(currentConflictIndex, 1);
            displayConflicts(detectedConflicts);
            closeConflictResolution();
        }
        
        // å…³é—­å†²çªè§£å†³å¯¹è¯æ¡†
        function closeConflictResolution() {
            const dialog = document.getElementById('conflictResolutionDialog');
            if (dialog) {
                dialog.style.display = 'none';
            }
        }
        
        // è§£å†³æ‰€æœ‰å†²çª
        async function resolveAllConflicts() {
            if (detectedConflicts.length === 0) {
                alert('æ²¡æœ‰éœ€è¦è§£å†³çš„å†²çª');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦è‡ªåŠ¨è§£å†³æ‰€æœ‰ ${detectedConflicts.length} ä¸ªå†²çªå—ï¼Ÿ\n\nè¿™å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\n1. UUIDå†²çªï¼šä¸ºé‡å¤æˆå‘˜ç”Ÿæˆæ–°UUID\n2. å°ç»„åç§°å†²çªï¼šä¿ç•™æœ¬åœ°æ•°æ®\n3. æ•°æ®ä¸ä¸€è‡´ï¼šåŒæ­¥æœ¬åœ°æ•°æ®åˆ°Firebase`)) {
                await batchResolveConflicts();
            }
        }
        
        // æ‰¹é‡è§£å†³å†²çª
        async function batchResolveConflicts() {
            console.log('å¼€å§‹æ‰¹é‡è§£å†³å†²çª...');
            const totalConflicts = detectedConflicts.length;
            let resolvedCount = 0;
            
            // æ˜¾ç¤ºè¿›åº¦
            const progressDialog = showProgressDialog(totalConflicts);
            
            try {
                // æŒ‰ç±»å‹åˆ†ç»„å¤„ç†å†²çª
                const uuidConflicts = detectedConflicts.filter(c => c.type === 'uuid');
                const groupNameConflicts = detectedConflicts.filter(c => c.type === 'group_name');
                const dataInconsistencyConflicts = detectedConflicts.filter(c => c.type === 'data_inconsistency');
                
                // å¤„ç†UUIDå†²çª
                console.log(`å¤„ç† ${uuidConflicts.length} ä¸ªUUIDå†²çª...`);
                for (const conflict of uuidConflicts) {
                    await resolveUUIDConflict(conflict);
                    resolvedCount++;
                    updateProgress(progressDialog, resolvedCount, totalConflicts);
                    await new Promise(resolve => setTimeout(resolve, 100)); // é¿å…é˜»å¡UI
                }
                
                // å¤„ç†å°ç»„åç§°å†²çª
                console.log(`å¤„ç† ${groupNameConflicts.length} ä¸ªå°ç»„åç§°å†²çª...`);
                for (const conflict of groupNameConflicts) {
                    await resolveGroupNameConflict(conflict);
                    resolvedCount++;
                    updateProgress(progressDialog, resolvedCount, totalConflicts);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // å¤„ç†æ•°æ®ä¸ä¸€è‡´å†²çª
                console.log(`å¤„ç† ${dataInconsistencyConflicts.length} ä¸ªæ•°æ®ä¸ä¸€è‡´å†²çª...`);
                for (const conflict of dataInconsistencyConflicts) {
                    await resolveDataInconsistencyConflict(conflict);
                    resolvedCount++;
                    updateProgress(progressDialog, resolvedCount, totalConflicts);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // å®Œæˆæ‰¹é‡è§£å†³
                closeProgressDialog(progressDialog);
                alert(`âœ… æ‰¹é‡è§£å†³å®Œæˆï¼\n\nå·²è§£å†³ ${resolvedCount} ä¸ªå†²çª\nå‰©ä½™ ${totalConflicts - resolvedCount} ä¸ªå†²çª`);
                
                // é‡æ–°æ£€æµ‹å†²çª
                await detectConflicts();
                
            } catch (error) {
                console.error('æ‰¹é‡è§£å†³å†²çªæ—¶å‡ºé”™:', error);
                closeProgressDialog(progressDialog);
                alert('æ‰¹é‡è§£å†³å†²çªæ—¶å‡ºé”™: ' + error.message);
            }
        }
        
        // è§£å†³UUIDå†²çª
        async function resolveUUIDConflict(conflict) {
            // ä¸ºç¬¬äºŒä¸ªæˆå‘˜ç”Ÿæˆæ–°UUID
            if (conflict.members && conflict.members.length >= 2) {
                const secondMember = conflict.members[1];
                const newUUID = generateUUID();
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                const localGroups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                Object.keys(localGroups).forEach(groupName => {
                    const group = localGroups[groupName];
                    if (Array.isArray(group)) {
                        group.forEach(member => {
                            if (member.uuid === secondMember.uuid && member.name === secondMember.name) {
                                member.uuid = newUUID;
                                console.log(`ä¸ºæˆå‘˜ ${member.name} ç”Ÿæˆæ–°UUID: ${newUUID}`);
                            }
                        });
                    }
                });
                
                localStorage.setItem('msh_groups', JSON.stringify(localGroups));
            }
        }
        
        // è§£å†³å°ç»„åç§°å†²çª
        async function resolveGroupNameConflict(conflict) {
            // ä¿ç•™æœ¬åœ°æ•°æ®ï¼ŒåŒæ­¥åˆ°Firebase
            if (conflict.members && conflict.members.length >= 2) {
                const localMember = conflict.members.find(m => m.group && m.group !== 'undefined');
                if (localMember) {
                    console.log(`ä¿ç•™æœ¬åœ°æˆå‘˜æ•°æ®: ${localMember.name} åœ¨ ${localMember.group}`);
                    // è¿™é‡Œå¯ä»¥æ·»åŠ åŒæ­¥åˆ°Firebaseçš„é€»è¾‘
                }
            }
        }
        
        // è§£å†³æ•°æ®ä¸ä¸€è‡´å†²çª
        async function resolveDataInconsistencyConflict(conflict) {
            // åŒæ­¥æœ¬åœ°æ•°æ®åˆ°Firebase
            if (conflict.localCount > conflict.firebaseCount) {
                console.log(`åŒæ­¥æœ¬åœ°æ•°æ®åˆ°Firebase: ${conflict.groupName}`);
                // è¿™é‡Œå¯ä»¥æ·»åŠ åŒæ­¥åˆ°Firebaseçš„é€»è¾‘
            }
        }
        
        // ç”ŸæˆUUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // æ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†
        function showProgressDialog(total) {
            const dialog = document.createElement('div');
            dialog.className = 'progress-dialog';
            dialog.innerHTML = `
                <div class="progress-content">
                    <h3>ğŸ”„ æ‰¹é‡è§£å†³å†²çªä¸­...</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text">0 / ${total}</div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            return dialog;
        }
        
        // æ›´æ–°è¿›åº¦
        function updateProgress(dialog, current, total) {
            const progressFill = dialog.querySelector('.progress-fill');
            const progressText = dialog.querySelector('.progress-text');
            const percentage = (current / total) * 100;
            
            if (progressFill) progressFill.style.width = percentage + '%';
            if (progressText) progressText.textContent = `${current} / ${total}`;
        }
        
        // å…³é—­è¿›åº¦å¯¹è¯æ¡†
        function closeProgressDialog(dialog) {
            if (dialog && dialog.parentNode) {
                dialog.parentNode.removeChild(dialog);
            }
        }
        
        // æ¸…ç©ºå¤–éƒ¨è¡¨å•æ•°æ®
        function clearExternalFormData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå¤–éƒ¨è¡¨å•æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                // è¿™é‡Œåº”è¯¥å®ç°æ¸…ç©ºå¤–éƒ¨è¡¨å•æ•°æ®çš„é€»è¾‘
                alert('æ¸…ç©ºå¤–éƒ¨è¡¨å•æ•°æ®åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
            }
        }
        
        // å¯¹æ¯”ç­¾åˆ°è®°å½•
        async function compareAttendanceRecords() {
            console.log('å¼€å§‹å¯¹æ¯”ç­¾åˆ°è®°å½•...');
            
            try {
                // è·å–æœ¬åœ°ç­¾åˆ°è®°å½•
                const localAttendanceRecords = JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]');
                
                // è·å–Firebaseç­¾åˆ°è®°å½•
                const db = firebase.database();
                const firebaseAttendanceRecords = await db.ref('attendanceRecords').once('value').then(snapshot => {
                    const data = snapshot.val();
                    return Array.isArray(data) ? data : (data ? Object.values(data) : []);
                });
                
                console.log('æœ¬åœ°ç­¾åˆ°è®°å½•æ•°é‡:', localAttendanceRecords.length);
                console.log('Firebaseç­¾åˆ°è®°å½•æ•°é‡:', firebaseAttendanceRecords.length);
                
                // è¯¦ç»†å¯¹æ¯”åˆ†æ
                const comparison = performDetailedAttendanceComparison(localAttendanceRecords, firebaseAttendanceRecords);
                
                // æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
                displayAttendanceComparison(comparison);
                
            } catch (error) {
                console.error('å¯¹æ¯”ç­¾åˆ°è®°å½•æ—¶å‡ºé”™:', error);
                alert('å¯¹æ¯”ç­¾åˆ°è®°å½•æ—¶å‡ºé”™: ' + error.message);
            }
        }
        
        // è¯¦ç»†ç­¾åˆ°è®°å½•å¯¹æ¯”åˆ†æ
        function performDetailedAttendanceComparison(localRecords, firebaseRecords) {
            console.log('\n=== è¯¦ç»†ç­¾åˆ°è®°å½•å¯¹æ¯”åˆ†æ ===');
            
            const comparison = {
                localOnly: [],
                firebaseOnly: [],
                matched: [],
                conflicts: [],
                summary: {
                    localCount: localRecords.length,
                    firebaseCount: firebaseRecords.length,
                    matchedCount: 0,
                    conflictCount: 0,
                    localOnlyCount: 0,
                    firebaseOnlyCount: 0
                }
            };
            
            // åˆ›å»ºæœ¬åœ°è®°å½•æ˜ å°„
            const localRecordMap = new Map();
            localRecords.forEach((record, index) => {
                if (record && record.name) {
                    const key = `${record.name}_${record.time || record.date}`;
                    localRecordMap.set(key, { ...record, _index: index, _source: 'local' });
                }
            });
            
            // åˆ›å»ºFirebaseè®°å½•æ˜ å°„
            const firebaseRecordMap = new Map();
            firebaseRecords.forEach((record, index) => {
                if (record && record.name) {
                    const key = `${record.name}_${record.time || record.date}`;
                    firebaseRecordMap.set(key, { ...record, _index: index, _source: 'firebase' });
                }
            });
            
            console.log('æœ¬åœ°è®°å½•æ˜ å°„:', localRecordMap);
            console.log('Firebaseè®°å½•æ˜ å°„:', firebaseRecordMap);
            
            // æ£€æŸ¥åŒ¹é…çš„è®°å½•
            localRecordMap.forEach((localRecord, key) => {
                const firebaseRecord = firebaseRecordMap.get(key);
                
                if (firebaseRecord) {
                    // æ‰¾åˆ°åŒ¹é…è®°å½•ï¼Œæ£€æŸ¥å†…å®¹æ˜¯å¦ä¸€è‡´
                    const isContentSame = JSON.stringify({
                        name: localRecord.name,
                        group: localRecord.group,
                        time: localRecord.time,
                        date: localRecord.date,
                        status: localRecord.status,
                        timeSlot: localRecord.timeSlot
                    }) === JSON.stringify({
                        name: firebaseRecord.name,
                        group: firebaseRecord.group,
                        time: firebaseRecord.time,
                        date: firebaseRecord.date,
                        status: firebaseRecord.status,
                        timeSlot: firebaseRecord.timeSlot
                    });
                    
                    if (isContentSame) {
                        comparison.matched.push({
                            key: key,
                            localRecord: localRecord,
                            firebaseRecord: firebaseRecord,
                            status: 'ä¸€è‡´'
                        });
                        comparison.summary.matchedCount++;
                    } else {
                        // å†…å®¹ä¸ä¸€è‡´ï¼Œè®°å½•å†²çª
                        const fieldDifferences = [];
                        const allFields = new Set([...Object.keys(localRecord), ...Object.keys(firebaseRecord)]);
                        
                        allFields.forEach(field => {
                            if (!['_index', '_source'].includes(field)) {
                                const localValue = localRecord[field];
                                const firebaseValue = firebaseRecord[field];
                                
                                if (localValue !== firebaseValue) {
                                    fieldDifferences.push({
                                        field: field,
                                        localValue: localValue,
                                        firebaseValue: firebaseValue
                                    });
                                }
                            }
                        });
                        
                        comparison.conflicts.push({
                            key: key,
                            localRecord: localRecord,
                            firebaseRecord: firebaseRecord,
                            status: 'å†²çª',
                            fieldDifferences: fieldDifferences
                        });
                        comparison.summary.conflictCount++;
                    }
                } else {
                    // æœ¬åœ°æœ‰ä½†Firebaseæ²¡æœ‰
                    comparison.localOnly.push(localRecord);
                    comparison.summary.localOnlyCount++;
                }
            });
            
            // æ£€æŸ¥Firebaseæœ‰ä½†æœ¬åœ°æ²¡æœ‰çš„è®°å½•
            firebaseRecordMap.forEach((firebaseRecord, key) => {
                if (!localRecordMap.has(key)) {
                    comparison.firebaseOnly.push(firebaseRecord);
                    comparison.summary.firebaseOnlyCount++;
                }
            });
            
            console.log('å¯¹æ¯”ç»“æœ:', comparison);
            return comparison;
        }
        
        // æ˜¾ç¤ºç­¾åˆ°è®°å½•å¯¹æ¯”ç»“æœ
        function displayAttendanceComparison(comparison) {
            const container = document.getElementById('conflictResults');
            if (!container) return;
            
            const { summary } = comparison;
            const totalInconsistencies = summary.conflictCount + summary.localOnlyCount + summary.firebaseOnlyCount;
            
            let html = `
                <div class="attendance-comparison">
                    <h3>ğŸ“‹ ç­¾åˆ°è®°å½•ä¸ä¸€è‡´æŠ¥å‘Š</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${summary.localCount}</div>
                            <div class="stat-label">æœ¬åœ°è®°å½•æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.firebaseCount}</div>
                            <div class="stat-label">Firebaseè®°å½•æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.matchedCount}</div>
                            <div class="stat-label">å®Œå…¨ä¸€è‡´</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalInconsistencies}</div>
                            <div class="stat-label">æ€»ä¸ä¸€è‡´æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.conflictCount}</div>
                            <div class="stat-label">å†…å®¹å†²çª</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.localOnlyCount}</div>
                            <div class="stat-label">ä»…æœ¬åœ°æœ‰</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.firebaseOnlyCount}</div>
                            <div class="stat-label">ä»…Firebaseæœ‰</div>
                        </div>
                    </div>
            `;
            
            if (totalInconsistencies === 0) {
                html += `
                    <div class="no-conflicts">
                        <h4>âœ… æ‰€æœ‰ç­¾åˆ°è®°å½•å®Œå…¨ä¸€è‡´</h4>
                        <p>æœ¬åœ°å’ŒFirebaseçš„ç­¾åˆ°è®°å½•å®Œå…¨åŒ¹é…ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•ä¸ä¸€è‡´ã€‚</p>
                    </div>
                `;
            } else {
                // æ˜¾ç¤ºå†…å®¹å†²çªè®°å½•
                if (comparison.conflicts.length > 0) {
                    html += `
                        <div class="conflicts-section">
                            <h4>âš ï¸ å†…å®¹å†²çªè®°å½• (${comparison.conflicts.length} æ¡)</h4>
                    `;
                    
                    comparison.conflicts.forEach((conflict, index) => {
                        html += `
                            <div class="conflict-item">
                                <div class="conflict-header">
                                    <span class="conflict-type medium">å†…å®¹å†²çª</span>
                                    <span class="conflict-description">${conflict.localRecord.name} - ${conflict.localRecord.time || conflict.localRecord.date}</span>
                                </div>
                                <div class="conflict-details">
                                    <div class="conflict-detail-item">
                                        <strong>å­—æ®µå·®å¼‚:</strong><br>
                                        ${conflict.fieldDifferences.map(diff => 
                                            `${diff.field}: æœ¬åœ°="${diff.localValue}" vs Firebase="${diff.firebaseValue}"`
                                        ).join('<br>')}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // æ˜¾ç¤ºä»…æœ¬åœ°æœ‰çš„è®°å½•
                if (comparison.localOnly.length > 0) {
                    html += `
                        <div class="local-only-section">
                            <h4>ğŸ“± ä»…æœ¬åœ°æœ‰çš„è®°å½• (${comparison.localOnly.length} æ¡)</h4>
                    `;
                    
                    comparison.localOnly.forEach(record => {
                        html += `
                            <div class="record-item">
                                <strong>${record.name}</strong> - ${record.time || record.date} - å°ç»„: ${record.group || 'æœªçŸ¥'}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // æ˜¾ç¤ºä»…Firebaseæœ‰çš„è®°å½•
                if (comparison.firebaseOnly.length > 0) {
                    html += `
                        <div class="firebase-only-section">
                            <h4>â˜ï¸ ä»…Firebaseæœ‰çš„è®°å½• (${comparison.firebaseOnly.length} æ¡)</h4>
                    `;
                    
                    comparison.firebaseOnly.forEach(record => {
                        html += `
                            <div class="record-item">
                                <strong>${record.name}</strong> - ${record.time || record.date} - å°ç»„: ${record.group || 'æœªçŸ¥'}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // å¯¹æ¯”æˆå‘˜ä¿¡æ¯
        async function compareMemberRecords() {
            console.log('å¼€å§‹å¯¹æ¯”æˆå‘˜ä¿¡æ¯...');
            
            try {
                // è·å–æœ¬åœ°æˆå‘˜æ•°æ®
                const localGroups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                const localGroupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
                
                // è·å–Firebaseæˆå‘˜æ•°æ®
                const db = firebase.database();
                const firebaseGroups = await db.ref('groups').once('value').then(snapshot => snapshot.val() || {});
                const firebaseGroupNames = await db.ref('groupNames').once('value').then(snapshot => snapshot.val() || {});
                
                console.log('æœ¬åœ°å°ç»„æ•°é‡:', Object.keys(localGroups).length);
                console.log('Firebaseå°ç»„æ•°é‡:', Object.keys(firebaseGroups).length);
                
                // è¯¦ç»†å¯¹æ¯”åˆ†æ
                const comparison = performDetailedMemberComparison(localGroups, firebaseGroups, localGroupNames, firebaseGroupNames);
                
                // æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
                displayMemberComparison(comparison);
                
            } catch (error) {
                console.error('å¯¹æ¯”æˆå‘˜ä¿¡æ¯æ—¶å‡ºé”™:', error);
                alert('å¯¹æ¯”æˆå‘˜ä¿¡æ¯æ—¶å‡ºé”™: ' + error.message);
            }
        }
        
        // è¯¦ç»†æˆå‘˜ä¿¡æ¯å¯¹æ¯”åˆ†æ
        function performDetailedMemberComparison(localGroups, firebaseGroups, localGroupNames, firebaseGroupNames) {
            console.log('\n=== è¯¦ç»†æˆå‘˜ä¿¡æ¯å¯¹æ¯”åˆ†æ ===');
            
            const comparison = {
                localOnly: [],
                firebaseOnly: [],
                matched: [],
                conflicts: [],
                summary: {
                    localMemberCount: 0,
                    firebaseMemberCount: 0,
                    matchedCount: 0,
                    conflictCount: 0,
                    localOnlyCount: 0,
                    firebaseOnlyCount: 0
                }
            };
            
            // æ”¶é›†æ‰€æœ‰æœ¬åœ°æˆå‘˜
            const localMembers = [];
            Object.entries(localGroups).forEach(([groupKey, members]) => {
                if (Array.isArray(members)) {
                    members.forEach(member => {
                        if (member && member.name) {
                            localMembers.push({
                                ...member,
                                _groupKey: groupKey,
                                _groupName: localGroupNames[groupKey] || groupKey,
                                _source: 'local'
                            });
                        }
                    });
                }
            });
            
            // æ”¶é›†æ‰€æœ‰Firebaseæˆå‘˜
            const firebaseMembers = [];
            Object.entries(firebaseGroups).forEach(([groupKey, members]) => {
                if (Array.isArray(members)) {
                    members.forEach(member => {
                        if (member && member.name) {
                            firebaseMembers.push({
                                ...member,
                                _groupKey: groupKey,
                                _groupName: firebaseGroupNames[groupKey] || groupKey,
                                _source: 'firebase'
                            });
                        }
                    });
                }
            });
            
            comparison.summary.localMemberCount = localMembers.length;
            comparison.summary.firebaseMemberCount = firebaseMembers.length;
            
            console.log('æœ¬åœ°æˆå‘˜æ€»æ•°:', localMembers.length);
            console.log('Firebaseæˆå‘˜æ€»æ•°:', firebaseMembers.length);
            
            // åˆ›å»ºæœ¬åœ°æˆå‘˜æ˜ å°„ï¼ˆæŒ‰UUIDï¼‰
            const localMemberMap = new Map();
            localMembers.forEach(member => {
                if (member.uuid) {
                    localMemberMap.set(member.uuid, member);
                }
            });
            
            // åˆ›å»ºFirebaseæˆå‘˜æ˜ å°„ï¼ˆæŒ‰UUIDï¼‰
            const firebaseMemberMap = new Map();
            firebaseMembers.forEach(member => {
                if (member.uuid) {
                    firebaseMemberMap.set(member.uuid, member);
                }
            });
            
            console.log('æœ¬åœ°æˆå‘˜æ˜ å°„:', localMemberMap);
            console.log('Firebaseæˆå‘˜æ˜ å°„:', firebaseMemberMap);
            
            // æ£€æŸ¥åŒ¹é…çš„æˆå‘˜
            localMemberMap.forEach((localMember, uuid) => {
                const firebaseMember = firebaseMemberMap.get(uuid);
                
                if (firebaseMember) {
                    // æ‰¾åˆ°åŒ¹é…æˆå‘˜ï¼Œæ£€æŸ¥å†…å®¹æ˜¯å¦ä¸€è‡´
                    const isContentSame = JSON.stringify({
                        name: localMember.name,
                        group: localMember.group,
                        phone: localMember.phone,
                        email: localMember.email,
                        joinDate: localMember.joinDate,
                        status: localMember.status,
                        _groupName: localMember._groupName
                    }) === JSON.stringify({
                        name: firebaseMember.name,
                        group: firebaseMember.group,
                        phone: firebaseMember.phone,
                        email: firebaseMember.email,
                        joinDate: firebaseMember.joinDate,
                        status: firebaseMember.status,
                        _groupName: firebaseMember._groupName
                    });
                    
                    if (isContentSame) {
                        comparison.matched.push({
                            uuid: uuid,
                            localMember: localMember,
                            firebaseMember: firebaseMember,
                            status: 'ä¸€è‡´'
                        });
                        comparison.summary.matchedCount++;
                    } else {
                        // å†…å®¹ä¸ä¸€è‡´ï¼Œè®°å½•å†²çª
                        const fieldDifferences = [];
                        const allFields = new Set([...Object.keys(localMember), ...Object.keys(firebaseMember)]);
                        
                        allFields.forEach(field => {
                            if (!['_groupKey', '_source'].includes(field)) {
                                const localValue = localMember[field];
                                const firebaseValue = firebaseMember[field];
                                
                                if (localValue !== firebaseValue) {
                                    fieldDifferences.push({
                                        field: field,
                                        localValue: localValue,
                                        firebaseValue: firebaseValue
                                    });
                                }
                            }
                        });
                        
                        comparison.conflicts.push({
                            uuid: uuid,
                            localMember: localMember,
                            firebaseMember: firebaseMember,
                            status: 'å†²çª',
                            fieldDifferences: fieldDifferences
                        });
                        comparison.summary.conflictCount++;
                    }
                } else {
                    // æœ¬åœ°æœ‰ä½†Firebaseæ²¡æœ‰
                    comparison.localOnly.push(localMember);
                    comparison.summary.localOnlyCount++;
                }
            });
            
            // æ£€æŸ¥Firebaseæœ‰ä½†æœ¬åœ°æ²¡æœ‰çš„æˆå‘˜
            firebaseMemberMap.forEach((firebaseMember, uuid) => {
                if (!localMemberMap.has(uuid)) {
                    comparison.firebaseOnly.push(firebaseMember);
                    comparison.summary.firebaseOnlyCount++;
                }
            });
            
            console.log('å¯¹æ¯”ç»“æœ:', comparison);
            return comparison;
        }
        
        // æ˜¾ç¤ºæˆå‘˜ä¿¡æ¯å¯¹æ¯”ç»“æœ
        function displayMemberComparison(comparison) {
            const container = document.getElementById('conflictResults');
            if (!container) return;
            
            const { summary } = comparison;
            const totalInconsistencies = summary.conflictCount + summary.localOnlyCount + summary.firebaseOnlyCount;
            
            let html = `
                <div class="member-comparison">
                    <h3>ğŸ‘¥ æˆå‘˜ä¿¡æ¯ä¸ä¸€è‡´æŠ¥å‘Š</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${summary.localMemberCount}</div>
                            <div class="stat-label">æœ¬åœ°æˆå‘˜æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.firebaseMemberCount}</div>
                            <div class="stat-label">Firebaseæˆå‘˜æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.matchedCount}</div>
                            <div class="stat-label">å®Œå…¨ä¸€è‡´</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalInconsistencies}</div>
                            <div class="stat-label">æ€»ä¸ä¸€è‡´æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.conflictCount}</div>
                            <div class="stat-label">å†…å®¹å†²çª</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.localOnlyCount}</div>
                            <div class="stat-label">ä»…æœ¬åœ°æœ‰</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${summary.firebaseOnlyCount}</div>
                            <div class="stat-label">ä»…Firebaseæœ‰</div>
                        </div>
                    </div>
            `;
            
            if (totalInconsistencies === 0) {
                html += `
                    <div class="no-conflicts">
                        <h4>âœ… æ‰€æœ‰æˆå‘˜ä¿¡æ¯å®Œå…¨ä¸€è‡´</h4>
                        <p>æœ¬åœ°å’ŒFirebaseçš„æˆå‘˜ä¿¡æ¯å®Œå…¨åŒ¹é…ï¼Œæ²¡æœ‰å‘ç°ä»»ä½•ä¸ä¸€è‡´ã€‚</p>
                    </div>
                `;
            } else {
                // æ˜¾ç¤ºå†…å®¹å†²çªè®°å½•
                if (comparison.conflicts.length > 0) {
                    html += `
                        <div class="conflicts-section">
                            <h4>âš ï¸ æˆå‘˜ä¿¡æ¯å†²çªè®°å½• (${comparison.conflicts.length} æ¡)</h4>
                    `;
                    
                    comparison.conflicts.forEach((conflict, index) => {
                        html += `
                            <div class="conflict-item">
                                <div class="conflict-header">
                                    <span class="conflict-type medium">ä¿¡æ¯å†²çª</span>
                                    <span class="conflict-description">${conflict.localMember.name} (${conflict.localMember._groupName})</span>
                                </div>
                                <div class="conflict-details">
                                    <div class="conflict-detail-item">
                                        <strong>UUID:</strong> ${conflict.uuid}<br>
                                        <strong>å­—æ®µå·®å¼‚:</strong><br>
                                        ${conflict.fieldDifferences.map(diff => 
                                            `${diff.field}: æœ¬åœ°="${diff.localValue}" vs Firebase="${diff.firebaseValue}"`
                                        ).join('<br>')}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // æ˜¾ç¤ºä»…æœ¬åœ°æœ‰çš„æˆå‘˜
                if (comparison.localOnly.length > 0) {
                    html += `
                        <div class="local-only-section">
                            <h4>ğŸ“± ä»…æœ¬åœ°æœ‰çš„æˆå‘˜ (${comparison.localOnly.length} æ¡)</h4>
                    `;
                    
                    comparison.localOnly.forEach(member => {
                        html += `
                            <div class="record-item">
                                <strong>${member.name}</strong> - UUID: ${member.uuid} - å°ç»„: ${member._groupName || 'æœªçŸ¥'}
                                ${member.phone ? `<br>ç”µè¯: ${member.phone}` : ''}
                                ${member.email ? `<br>é‚®ç®±: ${member.email}` : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // æ˜¾ç¤ºä»…Firebaseæœ‰çš„æˆå‘˜
                if (comparison.firebaseOnly.length > 0) {
                    html += `
                        <div class="firebase-only-section">
                            <h4>â˜ï¸ ä»…Firebaseæœ‰çš„æˆå‘˜ (${comparison.firebaseOnly.length} æ¡)</h4>
                    `;
                    
                    comparison.firebaseOnly.forEach(member => {
                        html += `
                            <div class="record-item">
                                <strong>${member.name}</strong> - UUID: ${member.uuid} - å°ç»„: ${member._groupName || 'æœªçŸ¥'}
                                ${member.phone ? `<br>ç”µè¯: ${member.phone}` : ''}
                                ${member.email ? `<br>é‚®ç®±: ${member.email}` : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // å¯¼å‡ºå†²çªæŠ¥å‘Š
        function exportConflictReport() {
            if (detectedConflicts.length === 0) {
                alert('æ²¡æœ‰å†²çªéœ€è¦å¯¼å‡º');
                return;
            }
            
            const report = {
                timestamp: new Date().toISOString(),
                totalConflicts: detectedConflicts.length,
                conflicts: detectedConflicts
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conflict-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ==================== éš”ç¦»ç®¡ç†åŠŸèƒ½ ====================
        
        // åŠ è½½éš”ç¦»æ•°æ®
        async function loadQuarantineData() {
            try {
                console.log('ğŸ”„ å¼€å§‹åŠ è½½éš”ç¦»æ•°æ®...');
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebaseæœªåˆå§‹åŒ–');
                }
                
                const db = firebase.database();
                const snapshot = await db.ref('quarantine').once('value');
                const data = snapshot.val() || {};
                
                quarantineData = Object.keys(data).map(key => ({
                    id: key,
                    ...data[key],
                    quarantinedAt: data[key].quarantinedAt || new Date().toISOString()
                }));
                
                console.log(`ğŸ“Š åŠ è½½åˆ° ${quarantineData.length} æ¡éš”ç¦»æ•°æ®`);
                displayQuarantineData();
                updateQuarantineStats();
                
            } catch (error) {
                console.error('âŒ åŠ è½½éš”ç¦»æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½éš”ç¦»æ•°æ®å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºéš”ç¦»æ•°æ®
        function displayQuarantineData() {
            const container = document.getElementById('quarantineDataList');
            
            if (quarantineData.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— éš”ç¦»æ•°æ®</div>';
                return;
            }
            
            let html = '';
            quarantineData.forEach((item, index) => {
                const statusClass = item.status === 'resolved' ? 'resolved' : 'pending';
                const statusText = item.status === 'resolved' ? 'å·²è§£å†³' : 'å¾…å¤„ç†';
                
                html += `
                    <div class="quarantine-item" onclick="selectQuarantineItem(${index})">
                        <div class="quarantine-item-header">
                            <div class="quarantine-item-title">${item.type || 'æœªçŸ¥ç±»å‹'} - ${item.name || 'æœªçŸ¥åç§°'}</div>
                            <div class="quarantine-item-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="quarantine-item-details">
                            <div><strong>éš”ç¦»æ—¶é—´:</strong> ${new Date(item.quarantinedAt).toLocaleString('zh-CN')}</div>
                            <div><strong>å†²çªåŸå› :</strong> ${item.reason || 'æœªçŸ¥åŸå› '}</div>
                            <div><strong>æ•°æ®æ¥æº:</strong> ${item.source || 'æœªçŸ¥æ¥æº'}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // é€‰æ‹©éš”ç¦»é¡¹
        function selectQuarantineItem(index) {
            // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.quarantine-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // é€‰æ‹©å½“å‰é¡¹
            const items = document.querySelectorAll('.quarantine-item');
            if (items[index]) {
                items[index].classList.add('selected');
                selectedQuarantineItem = quarantineData[index];
                showQuarantineDetails(selectedQuarantineItem);
            }
        }
        
        // æ˜¾ç¤ºéš”ç¦»è¯¦æƒ…
        function showQuarantineDetails(item) {
            const detailsContainer = document.getElementById('quarantineDetails');
            const contentContainer = document.getElementById('quarantineDetailsContent');
            
            if (!item) {
                detailsContainer.style.display = 'none';
                return;
            }
            
            const details = {
                'ID': item.id,
                'ç±»å‹': item.type || 'æœªçŸ¥',
                'åç§°': item.name || 'æœªçŸ¥',
                'çŠ¶æ€': item.status === 'resolved' ? 'å·²è§£å†³' : 'å¾…å¤„ç†',
                'éš”ç¦»æ—¶é—´': new Date(item.quarantinedAt).toLocaleString('zh-CN'),
                'å†²çªåŸå› ': item.reason || 'æœªçŸ¥åŸå› ',
                'æ•°æ®æ¥æº': item.source || 'æœªçŸ¥æ¥æº',
                'åŸå§‹æ•°æ®': JSON.stringify(item.originalData || {}, null, 2),
                'å†²çªæ•°æ®': JSON.stringify(item.conflictData || {}, null, 2)
            };
            
            let detailsHtml = '';
            Object.keys(details).forEach(key => {
                detailsHtml += `${key}: ${details[key]}\n`;
            });
            
            contentContainer.textContent = detailsHtml;
            detailsContainer.style.display = 'block';
        }
        
        // æ›´æ–°éš”ç¦»ç»Ÿè®¡
        function updateQuarantineStats() {
            const total = quarantineData.length;
            const resolved = quarantineData.filter(item => item.status === 'resolved').length;
            const pending = total - resolved;
            
            document.getElementById('quarantineCount').textContent = total;
            document.getElementById('quarantineResolved').textContent = resolved;
            document.getElementById('quarantinePending').textContent = pending;
        }
        
        // è§£å†³éš”ç¦»é¡¹
        async function resolveQuarantineItem() {
            if (!selectedQuarantineItem) {
                alert('è¯·å…ˆé€‰æ‹©è¦è§£å†³çš„éš”ç¦»é¡¹');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦è§£å†³ "${selectedQuarantineItem.name || 'æœªçŸ¥'}" çš„å†²çªå—ï¼Ÿ`)) {
                return;
            }
            
            try {
                console.log('âœ… å¼€å§‹è§£å†³éš”ç¦»é¡¹:', selectedQuarantineItem.id);
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebaseæœªåˆå§‹åŒ–');
                }
                
                const db = firebase.database();
                
                // æ›´æ–°éš”ç¦»é¡¹çŠ¶æ€
                await db.ref(`quarantine/${selectedQuarantineItem.id}`).update({
                    status: 'resolved',
                    resolvedAt: new Date().toISOString(),
                    resolvedBy: 'system'
                });
                
                console.log('âœ… éš”ç¦»é¡¹å·²æ ‡è®°ä¸ºå·²è§£å†³');
                
                // é‡æ–°åŠ è½½æ•°æ®
                await loadQuarantineData();
                
                alert('éš”ç¦»é¡¹å·²æˆåŠŸè§£å†³');
                
            } catch (error) {
                console.error('âŒ è§£å†³éš”ç¦»é¡¹å¤±è´¥:', error);
                alert('è§£å†³éš”ç¦»é¡¹å¤±è´¥: ' + error.message);
            }
        }
        
        // æ¢å¤éš”ç¦»é¡¹
        async function restoreQuarantineItem() {
            if (!selectedQuarantineItem) {
                alert('è¯·å…ˆé€‰æ‹©è¦æ¢å¤çš„éš”ç¦»é¡¹');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦æ¢å¤ "${selectedQuarantineItem.name || 'æœªçŸ¥'}" åˆ°æ­£å¸¸æ•°æ®å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                console.log('â†©ï¸ å¼€å§‹æ¢å¤éš”ç¦»é¡¹:', selectedQuarantineItem.id);
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebaseæœªåˆå§‹åŒ–');
                }
                
                const db = firebase.database();
                
                // æ ¹æ®æ•°æ®ç±»å‹æ¢å¤
                if (selectedQuarantineItem.type === 'attendance') {
                    // æ¢å¤ç­¾åˆ°è®°å½•
                    const attendanceRecords = JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]');
                    attendanceRecords.push(selectedQuarantineItem.originalData);
                    localStorage.setItem('msh_attendanceRecords', JSON.stringify(attendanceRecords));
                    
                    // åŒæ­¥åˆ°Firebase
                    await db.ref('attendanceRecords').set(attendanceRecords);
                    
                } else if (selectedQuarantineItem.type === 'member') {
                    // æ¢å¤æˆå‘˜ä¿¡æ¯
                    const groups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                    const groupKey = selectedQuarantineItem.originalData.group || 'group0';
                    
                    if (!groups[groupKey]) {
                        groups[groupKey] = [];
                    }
                    groups[groupKey].push(selectedQuarantineItem.originalData);
                    
                    localStorage.setItem('msh_groups', JSON.stringify(groups));
                    
                    // åŒæ­¥åˆ°Firebase
                    await db.ref('groups').set(groups);
                }
                
                // ä»éš”ç¦»åŒºåˆ é™¤
                await db.ref(`quarantine/${selectedQuarantineItem.id}`).remove();
                
                console.log('âœ… éš”ç¦»é¡¹å·²æ¢å¤å¹¶åˆ é™¤');
                
                // é‡æ–°åŠ è½½æ•°æ®
                await loadQuarantineData();
                
                alert('éš”ç¦»é¡¹å·²æˆåŠŸæ¢å¤');
                
            } catch (error) {
                console.error('âŒ æ¢å¤éš”ç¦»é¡¹å¤±è´¥:', error);
                alert('æ¢å¤éš”ç¦»é¡¹å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ é™¤éš”ç¦»é¡¹
        async function deleteQuarantineItem() {
            if (!selectedQuarantineItem) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„éš”ç¦»é¡¹');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤ "${selectedQuarantineItem.name || 'æœªçŸ¥'}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }
            
            try {
                console.log('ğŸ—‘ï¸ å¼€å§‹åˆ é™¤éš”ç¦»é¡¹:', selectedQuarantineItem.id);
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebaseæœªåˆå§‹åŒ–');
                }
                
                const db = firebase.database();
                
                // ä»éš”ç¦»åŒºåˆ é™¤
                await db.ref(`quarantine/${selectedQuarantineItem.id}`).remove();
                
                console.log('âœ… éš”ç¦»é¡¹å·²æ°¸ä¹…åˆ é™¤');
                
                // é‡æ–°åŠ è½½æ•°æ®
                await loadQuarantineData();
                
                alert('éš”ç¦»é¡¹å·²æˆåŠŸåˆ é™¤');
                
            } catch (error) {
                console.error('âŒ åˆ é™¤éš”ç¦»é¡¹å¤±è´¥:', error);
                alert('åˆ é™¤éš”ç¦»é¡¹å¤±è´¥: ' + error.message);
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰éš”ç¦»
        async function clearAllQuarantine() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰éš”ç¦»æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }
            
            try {
                console.log('ğŸ§¹ å¼€å§‹æ¸…ç©ºæ‰€æœ‰éš”ç¦»æ•°æ®...');
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebaseæœªåˆå§‹åŒ–');
                }
                
                const db = firebase.database();
                
                // æ¸…ç©ºéš”ç¦»åŒº
                await db.ref('quarantine').remove();
                
                console.log('âœ… æ‰€æœ‰éš”ç¦»æ•°æ®å·²æ¸…ç©º');
                
                // é‡æ–°åŠ è½½æ•°æ®
                await loadQuarantineData();
                
                alert('æ‰€æœ‰éš”ç¦»æ•°æ®å·²æˆåŠŸæ¸…ç©º');
                
            } catch (error) {
                console.error('âŒ æ¸…ç©ºéš”ç¦»æ•°æ®å¤±è´¥:', error);
                alert('æ¸…ç©ºéš”ç¦»æ•°æ®å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>
