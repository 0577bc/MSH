<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ æ‰‹åŠ¨ç­¾åˆ°è¡¥å½•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .preview {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .preview h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .preview-item {
            padding: 8px 0;
            border-bottom: 1px solid #c8e6c9;
        }

        .preview-item:last-child {
            border-bottom: none;
        }

        .preview-label {
            font-weight: 600;
            color: #1b5e20;
            display: inline-block;
            width: 120px;
        }

        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-top: 20px;
            display: none;
        }

        .log-entry {
            margin: 5px 0;
        }

        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .log-info { color: #3498db; }

        .alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .alert h4 {
            color: #856404;
            margin-bottom: 5px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ æ‰‹åŠ¨ç­¾åˆ°è¡¥å½•å·¥å…·</h1>
        <p class="subtitle">ç”¨äºè¡¥å½•å†å²ç­¾åˆ°è®°å½•</p>

        <div class="alert">
            <h4>âš ï¸ ä½¿ç”¨è¯´æ˜</h4>
            <p>æ­¤å·¥å…·ç”¨äºè¡¥å½•ç¼ºå¤±çš„ç­¾åˆ°è®°å½•ï¼Œè¯·ç¡®ä¿ä¿¡æ¯å‡†ç¡®æ— è¯¯ï¼</p>
            <p style="margin-top: 10px; color: #856404;">
                <strong>ğŸ“Œ å¦‚æœå°ç»„åˆ—è¡¨ä¸ºç©ºï¼š</strong><br>
                1. è¯·å…ˆè®¿é—®<a href="../../admin.html" style="color: #007bff;">æˆå‘˜ç®¡ç†é¡µé¢</a>åŠ è½½æ•°æ®<br>
                2. ç„¶åå†æ¬¡æ‰“å¼€æ­¤å·¥å…·ï¼Œå·¥å…·ä¼šä»å…¨å±€å˜é‡è¯»å–æ•°æ®
            </p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalRecords">0</div>
                <div class="stat-label">å½“å‰æ€»è®°å½•æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="addedCount">0</div>
                <div class="stat-label">æœ¬æ¬¡å·²è¡¥å½•</div>
            </div>
        </div>

        <div id="noDataWarning" style="background: #ffebee; border: 2px solid #f44336; border-radius: 10px; padding: 20px; margin-bottom: 20px; display: none;">
            <h4 style="color: #c62828; margin-bottom: 10px;">âš ï¸ æœªæ£€æµ‹åˆ°å°ç»„æ•°æ®</h4>
            <p style="color: #b71c1c; margin-bottom: 15px;">å·¥å…·éœ€è¦å°ç»„æ•°æ®æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚è¯·é€‰æ‹©ä»¥ä¸‹æ“ä½œï¼š</p>
            <button class="btn-primary" onclick="loadFromFirebase()">
                â˜ï¸ ä»FirebaseåŠ è½½æ•°æ®
            </button>
            <p style="margin-top: 10px; font-size: 14px; color: #d32f2f;">
                æˆ–è€…å…ˆè®¿é—®<a href="../../group-management.html" style="color: #1976d2;">æˆå‘˜ç®¡ç†é¡µé¢</a>ï¼Œç„¶åé‡æ–°æ‰“å¼€æ­¤å·¥å…·
            </p>
        </div>

        <div class="form-section">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“‹ è¡¥å½•ä¿¡æ¯</h3>
            
            <div class="form-group">
                <label for="signinDate">è¡¥å½•æ—¥æœŸ *</label>
                <input type="date" id="signinDate" required>
                <div style="margin-top: 8px; display: flex; gap: 5px; flex-wrap: wrap;">
                    <button type="button" onclick="setQuickDate('2025-10-05')" style="padding: 5px 10px; font-size: 12px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        10æœˆ5æ—¥
                    </button>
                    <button type="button" onclick="setQuickDate('2025-10-06')" style="padding: 5px 10px; font-size: 12px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        10æœˆ6æ—¥
                    </button>
                    <button type="button" onclick="setQuickDate('2025-10-07')" style="padding: 5px 10px; font-size: 12px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ä»Šå¤©
                    </button>
                </div>
            </div>

            <div class="time-inputs">
                <div class="form-group">
                    <label for="signinHour">ç­¾åˆ°æ—¶é—´ - å°æ—¶ *</label>
                    <select id="signinHour" required>
                        <option value="">--å°æ—¶--</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="signinMinute">ç­¾åˆ°æ—¶é—´ - åˆ†é’Ÿ *</label>
                    <select id="signinMinute" required>
                        <option value="">--åˆ†é’Ÿ--</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="timeSlot">æ—¶æ®µ *</label>
                <select id="timeSlot" required>
                    <option value="">--è‡ªåŠ¨åˆ¤æ–­--</option>
                    <option value="early">æ—©åˆ° (9:20å‰)</option>
                    <option value="onTime">å‡†æ—¶ (9:20-9:30)</option>
                    <option value="late">è¿Ÿåˆ° (9:30-10:40)</option>
                    <option value="afternoon">ä¸‹åˆ (10:40å)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="memberSearch">ğŸ” æœç´¢æˆå‘˜ï¼ˆè¾“å…¥å§“åç­›é€‰ï¼‰</label>
                <input type="text" id="memberSearch" placeholder="è¾“å…¥å§“åå¿«é€Ÿç­›é€‰..." oninput="filterMembers()">
            </div>

            <div class="form-group">
                <label for="signinMember">é€‰æ‹©æˆå‘˜ï¼ˆå¤šé€‰ï¼‰ *</label>
                <select id="signinMember" multiple size="15" required style="height: 400px; width: 100%;">
                </select>
                <div style="margin-top: 8px; display: flex; gap: 10px;">
                    <button type="button" onclick="selectAllMembers()" style="flex: 1; padding: 8px; font-size: 14px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        âœ… å…¨é€‰ (<span id="visibleCount">0</span>äºº)
                    </button>
                    <button type="button" onclick="clearAllMembers()" style="flex: 1; padding: 8px; font-size: 14px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        âŒ æ¸…ç©º
                    </button>
                    <button type="button" onclick="showSelected()" style="flex: 1; padding: 8px; font-size: 14px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ğŸ‘ï¸ å·²é€‰ (<span id="selectedCount">0</span>äºº)
                    </button>
                </div>
                <div style="margin-top: 8px; font-size: 12px; color: #7f8c8d;">
                    ğŸ’¡ å¤šé€‰æ–¹æ³•ï¼š<br>
                    â€¢ æŒ‰ä½ Ctrl (Windows) æˆ– Cmd (Mac) ç‚¹å‡»å¤šé€‰<br>
                    â€¢ æŒ‰ä½ Shift ç‚¹å‡»å¯è¿ç»­é€‰æ‹©<br>
                    â€¢ ç‚¹å‡»"å…¨é€‰"æŒ‰é’®ä¸€é”®é€‰æ‹©æ‰€æœ‰
                </div>
            </div>

            <button class="btn-info" onclick="previewBatchSignin()">
                ğŸ‘ï¸ é¢„è§ˆæ‰¹é‡ç­¾åˆ°
            </button>
        </div>

        <div class="preview" id="preview">
            <h3>ğŸ“‹ æ‰¹é‡ç­¾åˆ°é¢„è§ˆ</h3>
            <div id="previewContent"></div>
            <button class="btn-success" onclick="addBatchSignin()">
                âœ… ç¡®è®¤æ‰¹é‡è¡¥å½•
            </button>
        </div>

        <button class="btn-primary" onclick="batchComplete()" style="display:none;" id="completeBtn">
            ğŸš€ å®Œæˆè¡¥å½•å¹¶åŒæ­¥åˆ°Firebase
        </button>

        <div class="log" id="log"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="../../src/smart-config-loader.js"></script>
    <script src="../../src/core/firebase-utils.js"></script>
  <script src="../../src/core/time-utils.js"></script>
  <script src="../../src/core/security-utils.js"></script>
  <script src="../../src/data/uuid-manager.js"></script>
  <script src="../../src/features/sunday-tracking-utils.js"></script>
  <script src="../../src/data/sync-managers.js"></script>
  <script src="../../src/utils.js"></script>

    <script>
        let db = null;
        let groups = {};
        let groupNames = {};
        let attendanceRecords = [];
        let tempRecords = []; // ä¸´æ—¶å­˜å‚¨æœ¬æ¬¡è¡¥å½•çš„è®°å½•

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('totalRecords').textContent = attendanceRecords.length;
            document.getElementById('addedCount').textContent = tempRecords.length;
        }

        // åˆå§‹åŒ–æ—¶é—´é€‰é¡¹
        function initTimeOptions() {
            const hourSelect = document.getElementById('signinHour');
            const minuteSelect = document.getElementById('signinMinute');

            // å°æ—¶ï¼š6-12ç‚¹
            for (let i = 6; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i.toString().padStart(2, '0') + 'æ—¶';
                hourSelect.appendChild(option);
            }

            // åˆ†é’Ÿï¼šæ¯5åˆ†é’Ÿ
            for (let i = 0; i < 60; i += 5) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i.toString().padStart(2, '0') + 'åˆ†';
                minuteSelect.appendChild(option);
            }

            // é»˜è®¤é€‰æ‹©9:00
            hourSelect.value = 9;
            minuteSelect.value = 0;
        }

        // å­˜å‚¨æ‰€æœ‰æˆå‘˜çš„å®Œæ•´åˆ—è¡¨
        let allMembers = [];

        // åŠ è½½æ‰€æœ‰æˆå‘˜åˆ°åˆ—è¡¨
        function loadGroups() {
            allMembers = [];
            
            // æ”¶é›†æ‰€æœ‰å°ç»„çš„æ‰€æœ‰æˆå‘˜
            Object.keys(groups).forEach(groupKey => {
                const groupName = groupNames[groupKey] || groupKey;
                
                if (groups[groupKey] && Array.isArray(groups[groupKey])) {
                    groups[groupKey].forEach(member => {
                        allMembers.push({
                            ...member,
                            groupKey: groupKey,
                            groupName: groupName,
                            displayName: `${member.nickname || member.name} (${groupName})`
                        });
                    });
                }
            });

            log(`âœ… å·²åŠ è½½æ‰€æœ‰æˆå‘˜: ${allMembers.length} äººï¼Œæ¥è‡ª ${Object.keys(groups).length} ä¸ªå°ç»„`, 'success');
            
            // æ˜¾ç¤ºæ‰€æœ‰æˆå‘˜
            displayMembers(allMembers);
        }

        // æ˜¾ç¤ºæˆå‘˜åˆ—è¡¨
        function displayMembers(members) {
            const memberSelect = document.getElementById('signinMember');
            memberSelect.innerHTML = '';
            
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.uuid;
                option.textContent = member.displayName;
                option.dataset.name = member.name;
                option.dataset.uuid = member.uuid;
                option.dataset.groupKey = member.groupKey;
                option.dataset.groupName = member.groupName;
                memberSelect.appendChild(option);
            });
            
            // æ›´æ–°å¯è§äººæ•°
            document.getElementById('visibleCount').textContent = members.length;
            updateSelectedCount();
        }

        // æ›´æ–°å·²é€‰äººæ•°
        function updateSelectedCount() {
            const memberSelect = document.getElementById('signinMember');
            const selectedCount = memberSelect.selectedOptions.length;
            document.getElementById('selectedCount').textContent = selectedCount;
        }

        // æ˜¾ç¤ºå·²é€‰æˆå‘˜
        function showSelected() {
            const memberSelect = document.getElementById('signinMember');
            const selected = Array.from(memberSelect.selectedOptions);
            
            if (selected.length === 0) {
                alert('å°šæœªé€‰æ‹©ä»»ä½•æˆå‘˜');
                return;
            }
            
            const names = selected.map(opt => opt.textContent).join('\n');
            alert(`å·²é€‰æ‹© ${selected.length} äººï¼š\n\n${names}`);
        }

        // ç›‘å¬é€‰æ‹©å˜åŒ–
        document.addEventListener('change', function(e) {
            if (e.target.id === 'signinMember') {
                updateSelectedCount();
            }
        });

        // ç­›é€‰æˆå‘˜
        function filterMembers() {
            const searchText = document.getElementById('memberSearch').value.toLowerCase();
            
            if (!searchText) {
                // æ²¡æœ‰æœç´¢è¯ï¼Œæ˜¾ç¤ºæ‰€æœ‰æˆå‘˜
                displayMembers(allMembers);
                return;
            }
            
            // ç­›é€‰åŒ¹é…çš„æˆå‘˜
            const filtered = allMembers.filter(member => {
                const name = (member.name || '').toLowerCase();
                const nickname = (member.nickname || '').toLowerCase();
                const groupName = (member.groupName || '').toLowerCase();
                
                return name.includes(searchText) || 
                       nickname.includes(searchText) || 
                       groupName.includes(searchText);
            });
            
            displayMembers(filtered);
            log(`ğŸ” ç­›é€‰ç»“æœ: ${filtered.length} äºº`, 'info');
        }

        // å…¨é€‰æˆå‘˜
        function selectAllMembers() {
            const memberSelect = document.getElementById('signinMember');
            for (let i = 0; i < memberSelect.options.length; i++) {
                memberSelect.options[i].selected = true;
            }
            log(`âœ… å·²å…¨é€‰ ${memberSelect.selectedOptions.length} åæˆå‘˜`, 'info');
        }

        // æ¸…ç©ºé€‰æ‹©
        function clearAllMembers() {
            const memberSelect = document.getElementById('signinMember');
            memberSelect.selectedIndex = -1;
            log('âœ… å·²æ¸…ç©ºæˆå‘˜é€‰æ‹©', 'info');
        }

        // å¿«é€Ÿè®¾ç½®æ—¥æœŸ
        function setQuickDate(dateStr) {
            document.getElementById('signinDate').value = dateStr;
            log(`âœ… å·²è®¾ç½®æ—¥æœŸ: ${dateStr}`, 'info');
        }

        // è‡ªåŠ¨åˆ¤æ–­æ—¶æ®µ
        function autoDetectTimeSlot(hour, minute) {
            const timeInMinutes = hour * 60 + minute;
            
            if (timeInMinutes < 9 * 60 + 20) return 'early';      // 9:20å‰
            if (timeInMinutes < 9 * 60 + 30) return 'onTime';     // 9:20-9:30
            if (timeInMinutes < 10 * 60 + 40) return 'late';      // 9:30-10:40
            return 'afternoon';                                    // 10:40å
        }

        // é¢„è§ˆæ‰¹é‡ç­¾åˆ°ä¿¡æ¯
        function previewBatchSignin() {
            const date = document.getElementById('signinDate').value;
            const memberSelect = document.getElementById('signinMember');
            const selectedMembers = Array.from(memberSelect.selectedOptions);
            const hour = parseInt(document.getElementById('signinHour').value);
            const minute = parseInt(document.getElementById('signinMinute').value);
            const timeSlot = document.getElementById('timeSlot').value;

            // éªŒè¯å¿…å¡«é¡¹
            if (!date || selectedMembers.length === 0 || isNaN(hour) || isNaN(minute)) {
                alert('è¯·å¡«å†™æ—¥æœŸã€æ—¶é—´å¹¶è‡³å°‘é€‰æ‹©ä¸€ä¸ªæˆå‘˜ï¼');
                return;
            }

            // æ„å»ºæ—¶é—´æˆ³
            const signinTime = new Date(date);
            signinTime.setHours(hour, minute, 0, 0);
            const timestamp = signinTime.getTime();

            // è‡ªåŠ¨åˆ¤æ–­æ—¶æ®µ
            const detectedTimeSlot = timeSlot || autoDetectTimeSlot(hour, minute);

            // æ„å»ºæ‰¹é‡ç­¾åˆ°ä¿¡æ¯ï¼ˆæ¯ä¸ªæˆå‘˜ä¿ç•™è‡ªå·±çš„å°ç»„ä¿¡æ¯ï¼‰
            const batchSignins = selectedMembers.map(option => ({
                date,
                groupKey: option.dataset.groupKey,
                groupName: option.dataset.groupName,
                memberUuid: option.value,
                memberName: option.dataset.name,
                hour,
                minute,
                timestamp,
                timeSlot: detectedTimeSlot
            }));

            // ç»Ÿè®¡å°ç»„åˆ†å¸ƒ
            const groupStats = {};
            batchSignins.forEach(signin => {
                if (!groupStats[signin.groupName]) {
                    groupStats[signin.groupName] = 0;
                }
                groupStats[signin.groupName]++;
            });

            // æ˜¾ç¤ºé¢„è§ˆ
            const previewDiv = document.getElementById('preview');
            const previewContent = document.getElementById('previewContent');
            
            // æ„å»ºå°ç»„ç»Ÿè®¡æ˜¾ç¤º
            const groupStatsHTML = Object.keys(groupStats)
                .map(groupName => `${groupName}: ${groupStats[groupName]}äºº`)
                .join('ã€');
            
            let previewHTML = `
                <div class="preview-item">
                    <span class="preview-label">æ—¥æœŸï¼š</span>${date}
                </div>
                <div class="preview-item">
                    <span class="preview-label">æ—¶é—´ï¼š</span>${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}
                </div>
                <div class="preview-item">
                    <span class="preview-label">æ—¶æ®µï¼š</span>${getTimeSlotText(detectedTimeSlot)}
                </div>
                <div class="preview-item">
                    <span class="preview-label">æˆå‘˜æ€»æ•°ï¼š</span>${selectedMembers.length} äºº
                </div>
                <div class="preview-item">
                    <span class="preview-label">å°ç»„åˆ†å¸ƒï¼š</span>${groupStatsHTML}
                </div>
                <div class="preview-item">
                    <span class="preview-label">æˆå‘˜åˆ—è¡¨ï¼š</span>
                    <div style="margin-left: 120px; margin-top: 5px; max-height: 150px; overflow-y: auto; border: 1px solid #c8e6c9; padding: 10px; border-radius: 5px;">
                        ${batchSignins.map(s => `${s.memberName} (${s.groupName})`).join('ã€')}
                    </div>
                </div>
            `;
            
            previewContent.innerHTML = previewHTML;
            previewDiv.style.display = 'block';
            
            // ä¿å­˜åˆ°ä¸´æ—¶å¯¹è±¡
            window.currentBatchSignins = batchSignins;
        }

        // è·å–æ—¶æ®µæ–‡æœ¬
        function getTimeSlotText(timeSlot) {
            const map = {
                'early': 'æ—©åˆ° (9:20å‰)',
                'onTime': 'å‡†æ—¶ (9:20-9:30)',
                'late': 'è¿Ÿåˆ° (9:30-10:40)',
                'afternoon': 'ä¸‹åˆ (10:40å)'
            };
            return map[timeSlot] || timeSlot;
        }

        // æ‰¹é‡æ·»åŠ ç­¾åˆ°è®°å½•
        function addBatchSignin() {
            if (!window.currentBatchSignins || window.currentBatchSignins.length === 0) {
                alert('è¯·å…ˆé¢„è§ˆç­¾åˆ°ä¿¡æ¯ï¼');
                return;
            }

            const batchSignins = window.currentBatchSignins;
            let successCount = 0;
            let errorCount = 0;

            batchSignins.forEach(signin => {
                try {
                    // æŸ¥æ‰¾æˆå‘˜è¯¦ç»†ä¿¡æ¯
                    const member = groups[signin.groupKey].find(m => m.uuid === signin.memberUuid);
                    if (!member) {
                        log(`âš ï¸ æ‰¾ä¸åˆ°æˆå‘˜: ${signin.memberName}`, 'warning');
                        errorCount++;
                        return;
                    }

                    // ç”ŸæˆrecordIdï¼ˆæ¯ä¸ªæˆå‘˜æœ‰ç‹¬ç«‹çš„recordIdï¼‰
                    const randomSuffix = Math.random().toString(36).substr(2, 9);
                    const recordId = `att_${signin.timestamp}_${randomSuffix}`;

                    // æ„å»ºç­¾åˆ°æ—¶é—´ï¼ˆä½¿ç”¨ISOæ ‡å‡†æ ¼å¼ï¼Œç¬¦åˆç³»ç»Ÿå†å²å†³ç­–ï¼‰
                    const signinDateTime = new Date(signin.timestamp);
                    
                    // æ„å»ºç­¾åˆ°è®°å½•ï¼ˆå®Œå…¨å¯¹é½index.htmlçš„createAttendanceRecordæ ¼å¼ï¼‰
                    const record = {
                        // åŸºæœ¬ä¿¡æ¯
                        group: signin.groupKey,
                        name: signin.memberName,
                        memberUUID: signin.memberUuid,
                        time: signinDateTime.toISOString(), // âœ… ISOæ ‡å‡†æ ¼å¼ï¼ˆç¬¦åˆå†å²å†³ç­–ï¼‰
                        date: signinDateTime.toISOString().split('T')[0], // âœ… YYYY-MM-DDæ ¼å¼
                        timeSlot: signin.timeSlot,
                        
                        // ç²¾ç®€çš„äººå‘˜ä¿¡æ¯å¿«ç…§ï¼ˆåªä¿ç•™ç­¾åˆ°è®°å½•å¿…éœ€çš„ä¿¡æ¯ï¼‰
                        memberSnapshot: {
                            uuid: member.uuid || '',
                            id: member.id || '',
                            name: member.name,
                            nickname: member.nickname || ''
                        },
                        
                        // å°ç»„ä¿¡æ¯å¿«ç…§
                        groupSnapshot: {
                            groupId: signin.groupKey,
                            groupName: signin.groupName
                        },
                        
                        // è®°å½•åˆ›å»ºæ—¶é—´æˆ³
                        createdAt: signinDateTime.getTime(),
                        
                        // è®°å½•IDï¼ˆç”¨äºå”¯ä¸€æ ‡è¯†ï¼‰
                        recordId: recordId
                    };

                    // æ·»åŠ åˆ°ä¸´æ—¶è®°å½•
                    tempRecords.push(record);
                    attendanceRecords.push(record);
                    successCount++;

                    log(`âœ… å·²æ·»åŠ ç­¾åˆ°: ${signin.memberName} - ${signin.date} ${signin.hour}:${signin.minute.toString().padStart(2, '0')}`, 'success');
                } catch (error) {
                    log(`âŒ æ·»åŠ å¤±è´¥: ${signin.memberName} - ${error.message}`, 'error');
                    errorCount++;
                }
            });
            
            updateStats();
            
            // æ˜¾ç¤ºå®ŒæˆæŒ‰é’®
            document.getElementById('completeBtn').style.display = 'block';
            
            // æ¸…ç©ºé€‰æ‹©
            document.getElementById('signinMember').selectedIndex = -1;
            document.getElementById('preview').style.display = 'none';
            
            log(`ğŸ“Š æ‰¹é‡è¡¥å½•å®Œæˆ: æˆåŠŸ${successCount}æ¡, å¤±è´¥${errorCount}æ¡`, 'info');
            alert(`âœ… æ‰¹é‡è¡¥å½•å®Œæˆï¼\næˆåŠŸï¼š${successCount} æ¡\nå¤±è´¥ï¼š${errorCount} æ¡\næ€»è®¡å·²è¡¥å½•ï¼š${tempRecords.length} æ¡`);
        }

        // å®Œæˆè¡¥å½•å¹¶åŒæ­¥
        async function batchComplete() {
            if (tempRecords.length === 0) {
                alert('æ²¡æœ‰éœ€è¦åŒæ­¥çš„è®°å½•ï¼');
                return;
            }

            const confirm = window.confirm(`ç¡®å®šè¦åŒæ­¥ ${tempRecords.length} æ¡è¡¥å½•è®°å½•å—ï¼Ÿ\n\nå°†åŒæ­¥åˆ°ï¼š\n1. Firebaseæ•°æ®åº“\n2. æœ¬åœ°å­˜å‚¨\n3. å…¨å±€å˜é‡`);
            if (!confirm) return;

            try {
                log('ğŸ”„ å¼€å§‹åŒæ­¥è¡¥å½•è®°å½•...', 'info');

                // 1. åŒæ­¥åˆ°Firebase
                if (db) {
                    await db.ref('attendanceRecords').set(attendanceRecords);
                    log('âœ… å·²åŒæ­¥åˆ°Firebase', 'success');
                } else {
                    log('âš ï¸ Firebaseæœªè¿æ¥ï¼Œè·³è¿‡FirebaseåŒæ­¥', 'warning');
                }

                // 2. æ›´æ–°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('msh_attendanceRecords', JSON.stringify(attendanceRecords));
                log('âœ… å·²æ›´æ–°æœ¬åœ°å­˜å‚¨', 'success');

                // 3. æ›´æ–°å…¨å±€å˜é‡
                window.attendanceRecords = attendanceRecords;
                log('âœ… å·²æ›´æ–°å…¨å±€å˜é‡', 'success');

                // 4. è§¦å‘æ•°æ®åŒæ­¥äº‹ä»¶
                try {
                    const event = new CustomEvent('attendanceRecordsUpdated', {
                        detail: { records: attendanceRecords }
                    });
                    window.dispatchEvent(event);
                    log('âœ… å·²è§¦å‘æ•°æ®åŒæ­¥äº‹ä»¶', 'success');
                } catch (eventError) {
                    log('âš ï¸ è§¦å‘äº‹ä»¶å¤±è´¥: ' + eventError.message, 'warning');
                }

                // 5. æ¸…é™¤ç¼“å­˜
                sessionStorage.clear();
                log('âœ… å·²æ¸…é™¤é¡µé¢ç¼“å­˜', 'success');

                log(`ğŸ‰ è¡¥å½•å®Œæˆï¼å…±æ·»åŠ  ${tempRecords.length} æ¡è®°å½•`, 'success');
                alert(`ğŸ‰ è¡¥å½•å®Œæˆï¼\nå…±æ·»åŠ  ${tempRecords.length} æ¡è®°å½•\n\nè¯·åˆ·æ–°å…¶ä»–é¡µé¢æŸ¥çœ‹æ•°æ®`);

                // æ¸…ç©ºä¸´æ—¶è®°å½•
                tempRecords = [];
                updateStats();
                document.getElementById('completeBtn').style.display = 'none';

            } catch (error) {
                log(`âŒ åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
                alert('åŒæ­¥å¤±è´¥: ' + error.message);
            }
        }

        // åˆå§‹åŒ–Firebase
        function initFirebase() {
            try {
                if (typeof firebase !== 'undefined' && window.firebaseConfig) {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(window.firebaseConfig);
                    }
                    db = firebase.database();
                    log('âœ… Firebaseåˆå§‹åŒ–æˆåŠŸ', 'success');
                    return true;
                }
            } catch (error) {
                log(`âŒ Firebaseåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
            return false;
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                log('ğŸ” å¼€å§‹åŠ è½½æ•°æ®...', 'info');
                log(`ğŸ” æ£€æŸ¥å…¨å±€å˜é‡: window.groups=${!!window.groups}, window.groupNames=${!!window.groupNames}`, 'info');
                log(`ğŸ” æ£€æŸ¥æœ¬åœ°å­˜å‚¨é”®: msh_groups=${!!localStorage.getItem('msh_groups')}, msh_groupNames=${!!localStorage.getItem('msh_groupNames')}`, 'info');
                
                // ä¼˜å…ˆä»å…¨å±€å˜é‡åŠ è½½
                if (window.groups && Object.keys(window.groups).length > 0) {
                    groups = window.groups;
                    log(`âœ… ä»å…¨å±€å˜é‡åŠ è½½å°ç»„æ•°æ®: ${Object.keys(groups).length} ä¸ªå°ç»„`, 'success');
                } else {
                    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                    const groupsData = localStorage.getItem('msh_groups');
                    if (groupsData) {
                        const parsed = JSON.parse(groupsData);
                        // å¤„ç†å¯èƒ½çš„æ•°ç»„æˆ–å¯¹è±¡æ ¼å¼
                        groups = parsed;
                        log(`âœ… ä»æœ¬åœ°å­˜å‚¨åŠ è½½å°ç»„æ•°æ®: ${Object.keys(groups).length} ä¸ªå°ç»„`, 'success');
                        log(`ğŸ” å°ç»„è¯¦æƒ…: ${JSON.stringify(Object.keys(groups))}`, 'info');
                    } else {
                        log('âš ï¸ æœªæ‰¾åˆ°æœ¬åœ°å°ç»„æ•°æ®ï¼Œå°è¯•ä»FirebaseåŠ è½½...', 'warning');
                        // ä»FirebaseåŠ è½½
                        if (db) {
                            const snapshot = await db.ref('groups').once('value');
                            groups = snapshot.val() || {};
                            log(`âœ… ä»FirebaseåŠ è½½å°ç»„æ•°æ®: ${Object.keys(groups).length} ä¸ªå°ç»„`, 'success');
                        } else {
                            log('âŒ Firebaseä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½å°ç»„æ•°æ®', 'error');
                        }
                    }
                }

                // åŠ è½½å°ç»„åç§°
                if (window.groupNames && Object.keys(window.groupNames).length > 0) {
                    groupNames = window.groupNames;
                } else {
                    const groupNamesData = localStorage.getItem('msh_groupNames');
                    if (groupNamesData) {
                        groupNames = JSON.parse(groupNamesData);
                    } else if (db) {
                        const snapshot = await db.ref('groupNames').once('value');
                        groupNames = snapshot.val() || {};
                    }
                }

                // åŠ è½½ç­¾åˆ°è®°å½•
                if (window.attendanceRecords && window.attendanceRecords.length > 0) {
                    attendanceRecords = window.attendanceRecords;
                    log(`âœ… ä»å…¨å±€å˜é‡åŠ è½½ç­¾åˆ°è®°å½•: ${attendanceRecords.length} æ¡`, 'success');
                } else {
                    const attendanceData = localStorage.getItem('msh_attendanceRecords');
                    if (attendanceData) {
                        attendanceRecords = JSON.parse(attendanceData);
                        log(`âœ… ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç­¾åˆ°è®°å½•: ${attendanceRecords.length} æ¡`, 'success');
                    } else if (db) {
                        const snapshot = await db.ref('attendanceRecords').once('value');
                        const data = snapshot.val();
                        attendanceRecords = Array.isArray(data) ? data : Object.values(data || {});
                        log(`âœ… ä»FirebaseåŠ è½½ç­¾åˆ°è®°å½•: ${attendanceRecords.length} æ¡`, 'success');
                    }
                }

                log(`ğŸ“Š æ•°æ®åŠ è½½æ€»ç»“: ${Object.keys(groups).length}ä¸ªå°ç»„, ${attendanceRecords.length}æ¡è®°å½•`, 'info');

                // æ£€æŸ¥æ˜¯å¦æˆåŠŸåŠ è½½å°ç»„æ•°æ®
                if (Object.keys(groups).length === 0) {
                    document.getElementById('noDataWarning').style.display = 'block';
                    log('âš ï¸ æœªåŠ è½½åˆ°å°ç»„æ•°æ®ï¼Œè¯·ä»FirebaseåŠ è½½æˆ–è®¿é—®å…¶ä»–é¡µé¢', 'warning');
                } else {
                    document.getElementById('noDataWarning').style.display = 'none';
                }

                // åˆå§‹åŒ–ç•Œé¢
                loadGroups();
                initTimeOptions();
                updateStats();

            } catch (error) {
                log(`âŒ æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                alert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
            }
        }

        // ä»FirebaseåŠ è½½æ•°æ®
        async function loadFromFirebase() {
            if (!db) {
                alert('Firebaseæœªè¿æ¥ï¼Œæ— æ³•åŠ è½½ï¼');
                return;
            }

            try {
                log('ğŸ”„ ä»FirebaseåŠ è½½æ‰€æœ‰æ•°æ®...', 'info');

                // åŠ è½½å°ç»„æ•°æ®
                const groupsSnapshot = await db.ref('groups').once('value');
                groups = groupsSnapshot.val() || {};
                log(`âœ… å·²åŠ è½½å°ç»„: ${Object.keys(groups).length} ä¸ª`, 'success');

                // åŠ è½½å°ç»„åç§°
                const groupNamesSnapshot = await db.ref('groupNames').once('value');
                groupNames = groupNamesSnapshot.val() || {};
                log(`âœ… å·²åŠ è½½å°ç»„åç§°: ${Object.keys(groupNames).length} ä¸ª`, 'success');

                // åŠ è½½ç­¾åˆ°è®°å½•
                const recordsSnapshot = await db.ref('attendanceRecords').once('value');
                const data = recordsSnapshot.val();
                attendanceRecords = Array.isArray(data) ? data : Object.values(data || {});
                log(`âœ… å·²åŠ è½½ç­¾åˆ°è®°å½•: ${attendanceRecords.length} æ¡`, 'success');

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('msh_groups', JSON.stringify(groups));
                localStorage.setItem('msh_groupNames', JSON.stringify(groupNames));
                localStorage.setItem('msh_attendanceRecords', JSON.stringify(attendanceRecords));

                // éšè—è­¦å‘Š
                document.getElementById('noDataWarning').style.display = 'none';

                // é‡æ–°åˆå§‹åŒ–ç•Œé¢
                loadGroups();
                updateStats();

                alert(`âœ… æ•°æ®åŠ è½½æˆåŠŸï¼\nå°ç»„: ${Object.keys(groups).length} ä¸ª\nè®°å½•: ${attendanceRecords.length} æ¡`);

            } catch (error) {
                log(`âŒ FirebaseåŠ è½½å¤±è´¥: ${error.message}`, 'error');
                alert('FirebaseåŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            log('ğŸš€ ç­¾åˆ°è¡¥å½•å·¥å…·å¯åŠ¨', 'info');
            
            if (initFirebase()) {
                await loadData();
                log('âœ… ç³»ç»Ÿå°±ç»ªï¼Œå¯ä»¥å¼€å§‹è¡¥å½•', 'success');
            } else {
                log('âš ï¸ Firebaseåˆå§‹åŒ–å¤±è´¥ï¼Œä»…èƒ½æ›´æ–°æœ¬åœ°å­˜å‚¨', 'warning');
                await loadData();
            }
        });
    </script>
</body>
</html>

