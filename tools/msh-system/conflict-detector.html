<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSHå†²çªæ£€æµ‹ä¸è§£å†³å·¥å…·</title>
    <link rel="stylesheet" href="../../src/style.css">
    <link rel="stylesheet" href="conflict-tools-shared.css">
</head>
<body>
    <div class="conflict-manager-container">
        <!-- ç®¡ç†å‘˜è­¦å‘Šæ¨ªå¹… -->
        <div class="admin-warning-banner">
            <h2>
                <span class="warning-icon">ğŸš¨</span>
                ç®¡ç†å‘˜ä¸“ç”¨å·¥å…· - æ•°æ®å†²çªè¯Šæ–­åŒº
            </h2>
            <p><strong>âš ï¸ è­¦å‘Šï¼šæ­¤é¡µé¢ç”¨äºæ£€æµ‹å’Œè§£å†³ç³»ç»Ÿæ•°æ®å†²çªï¼</strong></p>
            <p>æœ¬é¡µé¢åŠŸèƒ½ï¼š</p>
            <ul>
                <li>ğŸ” æ£€æµ‹ <strong>UUIDå†²çª</strong>ï¼ˆé‡å¤UUIDï¼‰</li>
                <li>ğŸ” æ£€æµ‹ <strong>å°ç»„åç§°å†²çª</strong>ï¼ˆä¸ä¸€è‡´ï¼‰</li>
                <li>ğŸ” æ£€æµ‹ <strong>æ•°æ®ä¸ä¸€è‡´</strong>ï¼ˆgroups vs groupNamesï¼‰</li>
                <li>âš”ï¸ <strong>è§£å†³å†²çª</strong>ï¼ˆå¯èƒ½ä¿®æ”¹æ•°æ®ï¼‰</li>
            </ul>
            <p><strong>è¯·åœ¨æ‰§è¡Œä»»ä½•æ“ä½œå‰å…ˆå¤‡ä»½æ•°æ®ï¼</strong></p>
        </div>
        
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="conflict-manager-header">
            <h1>âš”ï¸ MSHå†²çªæ£€æµ‹ä¸è§£å†³</h1>
            <p>æ£€æµ‹å’Œè§£å†³Firebaseæ•°æ®å†²çª</p>
        </div>
        
        <!-- è¿”å›æŒ‰é’® -->
        <div class="back-button-container">
            <button class="back-button" onclick="goBack()">
                â† è¿”å›ç®¡ç†é¡µé¢
            </button>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalConflicts">0</div>
                <div class="stat-label">æ€»å†²çªæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uuidConflicts">0</div>
                <div class="stat-label">UUIDå†²çª</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="groupConflicts">0</div>
                <div class="stat-label">å°ç»„å†²çª</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="dataConflicts">0</div>
                <div class="stat-label">æ•°æ®ä¸ä¸€è‡´</div>
            </div>
        </div>

        <!-- å†²çªæ£€æµ‹åŒºåŸŸ -->
        <div class="conflict-section">
            <h2>ğŸ” å†²çªæ£€æµ‹</h2>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="detectConflicts()">
                    ğŸ” æ£€æµ‹æ‰€æœ‰å†²çª
                </button>
                <button class="btn btn-success" onclick="exportConflictReport()">
                    ğŸ“„ å¯¼å‡ºå†²çªæŠ¥å‘Š
                </button>
                <button class="btn btn-warning" onclick="clearConflicts()">
                    ğŸ§¹ æ¸…ç©ºç»“æœ
                </button>
            </div>
            
            <div id="conflictResults" style="margin-top: 20px;">
                <p style="color: #666; text-align: center;">ç‚¹å‡»"æ£€æµ‹æ‰€æœ‰å†²çª"å¼€å§‹åˆ†æ</p>
            </div>
        </div>

        <!-- å†²çªåˆ—è¡¨ -->
        <div id="conflictList" class="conflict-section" style="display: none;">
            <h2>âš ï¸ æ£€æµ‹åˆ°çš„å†²çª</h2>
            <div id="conflictItems"></div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="../../src/smart-config-loader.js"></script>
    <script src="../../src/core/firebase-utils.js"></script>
  <script src="../../src/core/time-utils.js"></script>
  <script src="../../src/core/security-utils.js"></script>
  <script src="../../src/data/uuid-manager.js"></script>
  <script src="../../src/features/sunday-tracking-utils.js"></script>
  <script src="../../src/data/sync-managers.js"></script>
  <script src="../../src/utils.js"></script>
    <script src="../../src/new-data-manager.js"></script>
    
    <script>
        // åˆå§‹åŒ–Firebase
        if (typeof firebase !== 'undefined' && !firebase.apps.length && window.firebaseConfig) {
            try {
                firebase.initializeApp(window.firebaseConfig);
                console.log('âœ… Firebaseåˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('âŒ Firebaseåˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
        
        // å†²çªæ£€æµ‹ç³»ç»Ÿçš„JavaScriptåŠŸèƒ½
        let detectedConflicts = [];
        
        // è¿”å›ç®¡ç†é¡µé¢
        function goBack() {
            console.log('ğŸ”™ è¿”å›ç®¡ç†é¡µé¢');
            window.location.href = '../../admin.html';
        }
        
        // æ£€æµ‹æ‰€æœ‰å†²çª
        async function detectConflicts() {
            try {
                document.getElementById('conflictResults').innerHTML = 
                    '<p style="color: #667eea;">ğŸ” æ­£åœ¨æ£€æµ‹å†²çª...</p>';
                
                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                detectedConflicts = [];
                
                // ä»FirebaseåŠ è½½æ•°æ®
                const db = firebase.database();
                const groupsSnapshot = await db.ref('groups').once('value');
                const groupNamesSnapshot = await db.ref('groupNames').once('value');
                const attendanceSnapshot = await db.ref('attendanceRecords').once('value');
                
                const firebaseGroups = groupsSnapshot.val() || {};
                const firebaseGroupNames = groupNamesSnapshot.val() || {};
                const firebaseAttendance = attendanceSnapshot.val() || [];
                
                // ä»localStorageåŠ è½½æ•°æ®
                const localGroups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                const localGroupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
                const localAttendance = JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]');
                
                console.log('ğŸ“Š æ•°æ®åŠ è½½å®Œæˆ:');
                console.log('  Firebase Groups:', Object.keys(firebaseGroups).length);
                console.log('  localStorage Groups:', Object.keys(localGroups).length);
                console.log('  Firebase Attendance:', firebaseAttendance.length);
                console.log('  localStorage Attendance:', localAttendance.length);
                
                // 1. æ£€æµ‹UUIDå†²çª
                const uuidConflicts = detectUUIDConflicts(firebaseGroups);
                detectedConflicts.push(...uuidConflicts);
                
                // 2. æ£€æµ‹å°ç»„åç§°å†²çª
                const groupNameConflicts = detectGroupNameConflicts(firebaseGroups, firebaseGroupNames);
                detectedConflicts.push(...groupNameConflicts);
                
                // 3. æ£€æµ‹æ•°æ®ä¸ä¸€è‡´
                const dataConflicts = detectDataInconsistency(firebaseGroups, firebaseGroupNames);
                detectedConflicts.push(...dataConflicts);
                
                // æ›´æ–°ç»Ÿè®¡
                updateConflictStats();
                
                // æ˜¾ç¤ºç»“æœ
                displayConflicts();
                
            } catch (error) {
                console.error('å†²çªæ£€æµ‹å¤±è´¥:', error);
                document.getElementById('conflictResults').innerHTML = 
                    `<p style="color: #f56565;">âŒ æ£€æµ‹å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // æ£€æµ‹UUIDå†²çªï¼ˆåŒä¸€ä¸ªUUIDå‡ºç°åœ¨å¤šä¸ªæˆå‘˜ä¸­ï¼‰
        function detectUUIDConflicts(groups) {
            const conflicts = [];
            const uuidMap = new Map(); // uuid -> [æˆå‘˜åˆ—è¡¨]
            
            // æ”¶é›†æ‰€æœ‰UUID
            Object.keys(groups).forEach(groupKey => {
                const members = groups[groupKey] || [];
                members.forEach(member => {
                    if (member && member.uuid) {
                        if (!uuidMap.has(member.uuid)) {
                            uuidMap.set(member.uuid, []);
                        }
                        uuidMap.get(member.uuid).push({
                            ...member,
                            groupKey
                        });
                    }
                });
            });
            
            // æŸ¥æ‰¾é‡å¤çš„UUID
            uuidMap.forEach((members, uuid) => {
                if (members.length > 1) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯çœŸæ­£çš„å†²çªï¼ˆå§“åä¸åŒï¼‰
                    const uniqueNames = [...new Set(members.map(m => m.name))];
                    
                    if (uniqueNames.length > 1) {
                        conflicts.push({
                            type: 'uuid_conflict',
                            severity: 'high',
                            uuid,
                            members,
                            description: `UUID ${uuid} è¢« ${members.length} ä¸ªä¸åŒæˆå‘˜ä½¿ç”¨`
                        });
                    }
                }
            });
            
            return conflicts;
        }
        
        // æ£€æµ‹å°ç»„åç§°å†²çª
        function detectGroupNameConflicts(groups, groupNames) {
            const conflicts = [];
            
            Object.keys(groups).forEach(groupKey => {
                const expectedName = groupNames[groupKey];
                if (!expectedName) {
                    conflicts.push({
                        type: 'group_name_missing',
                        severity: 'medium',
                        groupKey,
                        description: `å°ç»„ ${groupKey} ç¼ºå°‘åç§°å®šä¹‰`
                    });
                }
            });
            
            // æ£€æŸ¥groupNamesä¸­æ˜¯å¦æœ‰å¤šä½™çš„æ¡ç›®
            Object.keys(groupNames).forEach(groupKey => {
                if (!groups[groupKey]) {
                    conflicts.push({
                        type: 'orphan_group_name',
                        severity: 'low',
                        groupKey,
                        groupName: groupNames[groupKey],
                        description: `å°ç»„åç§° "${groupNames[groupKey]}" (${groupKey}) æ²¡æœ‰å¯¹åº”çš„æˆå‘˜æ•°æ®`
                    });
                }
            });
            
            return conflicts;
        }
        
        // æ£€æµ‹æ•°æ®ä¸ä¸€è‡´
        function detectDataInconsistency(groups, groupNames) {
            const conflicts = [];
            
            // æ£€æŸ¥ç©ºå°ç»„
            Object.keys(groups).forEach(groupKey => {
                const members = groups[groupKey];
                if (!members || members.length === 0) {
                    conflicts.push({
                        type: 'empty_group',
                        severity: 'low',
                        groupKey,
                        groupName: groupNames[groupKey],
                        description: `å°ç»„ "${groupNames[groupKey]}" æ²¡æœ‰æˆå‘˜`
                    });
                }
            });
            
            return conflicts;
        }
        
        // æ›´æ–°å†²çªç»Ÿè®¡
        function updateConflictStats() {
            const uuidConflicts = detectedConflicts.filter(c => c.type === 'uuid_conflict').length;
            const groupConflicts = detectedConflicts.filter(c => 
                c.type === 'group_name_missing' || c.type === 'orphan_group_name'
            ).length;
            const dataConflicts = detectedConflicts.filter(c => c.type === 'empty_group').length;
            
            document.getElementById('totalConflicts').textContent = detectedConflicts.length;
            document.getElementById('uuidConflicts').textContent = uuidConflicts;
            document.getElementById('groupConflicts').textContent = groupConflicts;
            document.getElementById('dataConflicts').textContent = dataConflicts;
        }
        
        // æ˜¾ç¤ºå†²çª
        function displayConflicts() {
            const conflictList = document.getElementById('conflictList');
            const conflictItems = document.getElementById('conflictItems');
            const conflictResults = document.getElementById('conflictResults');
            
            if (detectedConflicts.length === 0) {
                conflictResults.innerHTML = `
                    <div class="no-conflicts">
                        <h4>âœ… æœªæ£€æµ‹åˆ°å†²çª</h4>
                        <p>ç³»ç»Ÿæ•°æ®ä¸€è‡´æ€§è‰¯å¥½</p>
                    </div>
                `;
                conflictList.style.display = 'none';
                return;
            }
            
            conflictResults.innerHTML = `
                <p style="color: #f56565; font-weight: bold;">
                    âš ï¸ æ£€æµ‹åˆ° ${detectedConflicts.length} ä¸ªå†²çª
                </p>
            `;
            
            conflictList.style.display = 'block';
            conflictItems.innerHTML = '';
            
            detectedConflicts.forEach((conflict, index) => {
                const conflictDiv = document.createElement('div');
                conflictDiv.className = `conflict-item ${conflict.type.replace('_', '-')}`;
                
                const severityClass = conflict.severity === 'high' ? 'uuid' : 
                                     conflict.severity === 'medium' ? 'group' : 'data';
                
                conflictDiv.innerHTML = `
                    <div class="conflict-header">
                        <div>
                            <span class="conflict-type ${severityClass}">${conflict.severity.toUpperCase()}</span>
                            <span class="conflict-title">#${index + 1} ${conflict.description}</span>
                        </div>
                    </div>
                    <div class="conflict-details">
                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px;">
${JSON.stringify(conflict, null, 2)}
                        </pre>
                    </div>
                    <div class="conflict-actions">
                        <button class="btn btn-primary" onclick="showConflictDetails(${index})">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                        <button class="btn btn-warning" onclick="ignoreConflict(${index})">
                            å¿½ç•¥
                        </button>
                    </div>
                `;
                
                conflictItems.appendChild(conflictDiv);
            });
        }
        
        // æ˜¾ç¤ºå†²çªè¯¦æƒ…
        function showConflictDetails(index) {
            const conflict = detectedConflicts[index];
            alert(`å†²çªè¯¦æƒ… #${index + 1}\n\n${JSON.stringify(conflict, null, 2)}`);
        }
        
        // å¿½ç•¥å†²çª
        function ignoreConflict(index) {
            if (confirm('ç¡®å®šè¦å¿½ç•¥è¿™ä¸ªå†²çªå—ï¼Ÿ')) {
                detectedConflicts.splice(index, 1);
                updateConflictStats();
                displayConflicts();
            }
        }
        
        // æ¸…ç©ºå†²çªç»“æœ
        function clearConflicts() {
            detectedConflicts = [];
            updateConflictStats();
            document.getElementById('conflictResults').innerHTML = 
                '<p style="color: #666; text-align: center;">ç‚¹å‡»"æ£€æµ‹æ‰€æœ‰å†²çª"å¼€å§‹åˆ†æ</p>';
            document.getElementById('conflictList').style.display = 'none';
        }
        
        // å¯¼å‡ºå†²çªæŠ¥å‘Š
        function exportConflictReport() {
            if (detectedConflicts.length === 0) {
                alert('æ²¡æœ‰å†²çªæ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            const report = {
                timestamp: new Date().toISOString(),
                conflictCount: detectedConflicts.length,
                conflicts: detectedConflicts
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conflict-report-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('å†²çªæŠ¥å‘Šå·²å¯¼å‡º');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', async function() {
            console.log('å†²çªæ£€æµ‹å·¥å…·åŠ è½½å®Œæˆ');
            
            if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                console.error('âŒ Firebaseæœªåˆå§‹åŒ–');
            } else {
                console.log('âœ… Firebaseå·²åˆå§‹åŒ–');
            }
        });
    </script>
</body>
</html>

