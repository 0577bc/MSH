<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSHå†²çªéš”ç¦»ç®¡ç†å·¥å…·</title>
    <link rel="stylesheet" href="../../src/style.css">
    <link rel="stylesheet" href="conflict-tools-shared.css">
</head>
<body>
    <div class="conflict-manager-container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="quarantine-header">
            <h2>ğŸ›¡ï¸ å†²çªéš”ç¦»ç®¡ç†</h2>
            <p>ç®¡ç†è¢«éš”ç¦»çš„å†²çªæ•°æ®ï¼Œé˜²æ­¢æ•°æ®æ±¡æŸ“</p>
        </div>
        
        <!-- è¿”å›æŒ‰é’® -->
        <div class="back-button-container">
            <button class="back-button" onclick="goBack()">
                â† è¿”å›ç®¡ç†é¡µé¢
            </button>
        </div>
        
        <!-- éš”ç¦»ç»Ÿè®¡ -->
        <div class="quarantine-stats">
            <div class="stat-card">
                <div class="stat-number" id="quarantineCount">0</div>
                <div class="stat-label">éš”ç¦»æ•°æ®</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="quarantineResolved">0</div>
                <div class="stat-label">å·²è§£å†³</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="quarantinePending">0</div>
                <div class="stat-label">å¾…å¤„ç†</div>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="quarantine-actions">
            <button class="btn btn-primary" onclick="loadQuarantineData()">
                ğŸ”„ åˆ·æ–°æ•°æ®
            </button>
            <button class="btn btn-success" onclick="resolveQuarantineItem()" id="resolveBtn" disabled>
                âœ… è§£å†³é€‰ä¸­é¡¹
            </button>
            <button class="btn btn-warning" onclick="restoreQuarantineItem()" id="restoreBtn" disabled>
                â™»ï¸ æ¢å¤é€‰ä¸­é¡¹
            </button>
            <button class="btn btn-danger" onclick="deleteQuarantineItem()" id="deleteBtn" disabled>
                ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­é¡¹
            </button>
            <button class="btn btn-danger" onclick="clearAllQuarantine()">
                ğŸ§¹ æ¸…ç©ºæ‰€æœ‰éš”ç¦»æ•°æ®
            </button>
        </div>
        
        <!-- éš”ç¦»æ•°æ®åˆ—è¡¨ -->
        <div class="quarantine-list">
            <h3>ğŸ“‹ éš”ç¦»æ•°æ®åˆ—è¡¨</h3>
            <div id="quarantineItems">
                <p style="color: #666; text-align: center;">ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½éš”ç¦»æ•°æ®</p>
            </div>
        </div>
        
        <!-- éš”ç¦»æ•°æ®è¯¦æƒ… -->
        <div class="quarantine-details" id="quarantineDetails" style="display: none;">
            <h3>ğŸ“„ æ•°æ®è¯¦æƒ…</h3>
            <div class="quarantine-details-content" id="quarantineDetailsContent">
                
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="../../src/smart-config-loader.js"></script>
    <script src="../../src/core/firebase-utils.js"></script>
  <script src="../../src/core/time-utils.js"></script>
  <script src="../../src/core/security-utils.js"></script>
  <script src="../../src/data/uuid-manager.js"></script>
  <script src="../../src/features/sunday-tracking-utils.js"></script>
  <script src="../../src/data/sync-managers.js"></script>
  <script src="../../src/utils.js"></script>
    <script src="../../src/new-data-manager.js"></script>
    
    <script>
        // åˆå§‹åŒ–Firebase
        if (typeof firebase !== 'undefined' && !firebase.apps.length && window.firebaseConfig) {
            try {
                firebase.initializeApp(window.firebaseConfig);
                console.log('âœ… Firebaseåˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('âŒ Firebaseåˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
        
        // å†²çªéš”ç¦»ç®¡ç†ç³»ç»Ÿçš„JavaScriptåŠŸèƒ½
        let quarantineData = [];
        let selectedQuarantineItem = null;
        
        // è¿”å›ç®¡ç†é¡µé¢
        function goBack() {
            console.log('ğŸ”™ è¿”å›ç®¡ç†é¡µé¢');
            window.location.href = '../../admin.html';
        }
        
        // åŠ è½½éš”ç¦»æ•°æ®
        async function loadQuarantineData() {
            try {
                console.log('ğŸ” å¼€å§‹åŠ è½½éš”ç¦»æ•°æ®...');
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebaseæœªåˆå§‹åŒ–');
                }
                
                const db = firebase.database();
                const snapshot = await db.ref('quarantine').once('value');
                const data = snapshot.val();
                
                if (!data) {
                    quarantineData = [];
                } else if (Array.isArray(data)) {
                    quarantineData = data.filter(item => item !== null && item !== undefined);
                } else {
                    quarantineData = Object.values(data).filter(item => item !== null && item !== undefined);
                }
                
                console.log(`âœ… åŠ è½½äº† ${quarantineData.length} æ¡éš”ç¦»æ•°æ®`);
                
                // æ›´æ–°ç»Ÿè®¡
                updateQuarantineStats();
                
                // æ˜¾ç¤ºæ•°æ®
                displayQuarantineData();
                
            } catch (error) {
                console.error('âŒ åŠ è½½éš”ç¦»æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½éš”ç¦»æ•°æ®å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºéš”ç¦»æ•°æ®
        function displayQuarantineData() {
            const itemsContainer = document.getElementById('quarantineItems');
            
            if (quarantineData.length === 0) {
                itemsContainer.innerHTML = `
                    <div class="no-conflicts">
                        <h4>âœ… æ²¡æœ‰éš”ç¦»æ•°æ®</h4>
                        <p>ç³»ç»Ÿä¸­æ²¡æœ‰è¢«éš”ç¦»çš„å†²çªæ•°æ®</p>
                    </div>
                `;
                return;
            }
            
            itemsContainer.innerHTML = '';
            
            quarantineData.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'quarantine-item';
                itemDiv.onclick = () => selectQuarantineItem(index);
                
                const status = item.resolved ? 'resolved' : 'pending';
                const statusText = item.resolved ? 'å·²è§£å†³' : 'å¾…å¤„ç†';
                
                const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';
                const type = item.type || 'æœªçŸ¥ç±»å‹';
                const description = item.description || 'æ— æè¿°';
                
                itemDiv.innerHTML = `
                    <div class="quarantine-item-header">
                        <div class="quarantine-item-title">
                            #${index + 1} ${type}
                        </div>
                        <span class="quarantine-item-status ${status}">${statusText}</span>
                    </div>
                    <div class="quarantine-item-details">
                        <div><strong>æ—¶é—´ï¼š</strong>${timestamp}</div>
                        <div><strong>æè¿°ï¼š</strong>${description}</div>
                    </div>
                `;
                
                itemsContainer.appendChild(itemDiv);
            });
        }
        
        // é€‰æ‹©éš”ç¦»é¡¹
        function selectQuarantineItem(index) {
            selectedQuarantineItem = index;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.quarantine-item').forEach((item, idx) => {
                if (idx === index) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            // æ˜¾ç¤ºè¯¦æƒ…
            showQuarantineDetails(quarantineData[index]);
            
            // å¯ç”¨æŒ‰é’®
            document.getElementById('resolveBtn').disabled = false;
            document.getElementById('restoreBtn').disabled = false;
            document.getElementById('deleteBtn').disabled = false;
        }
        
        // æ˜¾ç¤ºéš”ç¦»æ•°æ®è¯¦æƒ…
        function showQuarantineDetails(item) {
            const detailsContainer = document.getElementById('quarantineDetails');
            const detailsContent = document.getElementById('quarantineDetailsContent');
            
            detailsContainer.style.display = 'block';
            detailsContent.textContent = JSON.stringify(item, null, 2);
        }
        
        // æ›´æ–°éš”ç¦»ç»Ÿè®¡
        function updateQuarantineStats() {
            const totalCount = quarantineData.length;
            const resolvedCount = quarantineData.filter(item => item.resolved).length;
            const pendingCount = totalCount - resolvedCount;
            
            document.getElementById('quarantineCount').textContent = totalCount;
            document.getElementById('quarantineResolved').textContent = resolvedCount;
            document.getElementById('quarantinePending').textContent = pendingCount;
        }
        
        // è§£å†³éš”ç¦»é¡¹
        async function resolveQuarantineItem() {
            if (selectedQuarantineItem === null) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªéš”ç¦»é¡¹');
                return;
            }
            
            try {
                const item = quarantineData[selectedQuarantineItem];
                
                if (!confirm(`ç¡®å®šè¦æ ‡è®°ä¸ºå·²è§£å†³å—ï¼Ÿ\n\nç±»å‹: ${item.type}\næè¿°: ${item.description}`)) {
                    return;
                }
                
                console.log('âœ… æ ‡è®°ä¸ºå·²è§£å†³:', item);
                
                // æ›´æ–°çŠ¶æ€
                item.resolved = true;
                item.resolvedAt = new Date().toISOString();
                
                // ä¿å­˜åˆ°Firebase
                const db = firebase.database();
                await db.ref(`quarantine/${selectedQuarantineItem}`).update({
                    resolved: true,
                    resolvedAt: item.resolvedAt
                });
                
                console.log('âœ… éš”ç¦»é¡¹å·²æ ‡è®°ä¸ºå·²è§£å†³');
                
                // åˆ·æ–°æ˜¾ç¤º
                await loadQuarantineData();
                alert('å·²æ ‡è®°ä¸ºå·²è§£å†³');
                
            } catch (error) {
                console.error('âŒ è§£å†³éš”ç¦»é¡¹å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }
        
        // æ¢å¤éš”ç¦»é¡¹
        async function restoreQuarantineItem() {
            if (selectedQuarantineItem === null) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªéš”ç¦»é¡¹');
                return;
            }
            
            try {
                const item = quarantineData[selectedQuarantineItem];
                
                if (!confirm(`ç¡®å®šè¦æ¢å¤è¿™ä¸ªéš”ç¦»é¡¹å—ï¼Ÿ\n\nç±»å‹: ${item.type}\næè¿°: ${item.description}\n\nè¿™å°†ä»éš”ç¦»åŒºåˆ é™¤è¯¥é¡¹`)) {
                    return;
                }
                
                console.log('â™»ï¸ æ¢å¤éš”ç¦»é¡¹:', item);
                
                // ä»Firebaseéš”ç¦»åŒºåˆ é™¤
                const db = firebase.database();
                await db.ref(`quarantine/${selectedQuarantineItem}`).remove();
                
                console.log('âœ… éš”ç¦»é¡¹å·²æ¢å¤ï¼ˆä»éš”ç¦»åŒºåˆ é™¤ï¼‰');
                
                // åˆ·æ–°æ˜¾ç¤º
                selectedQuarantineItem = null;
                await loadQuarantineData();
                
                // éšè—è¯¦æƒ…
                document.getElementById('quarantineDetails').style.display = 'none';
                
                // ç¦ç”¨æŒ‰é’®
                document.getElementById('resolveBtn').disabled = true;
                document.getElementById('restoreBtn').disabled = true;
                document.getElementById('deleteBtn').disabled = true;
                
                alert('éš”ç¦»é¡¹å·²æ¢å¤');
                
            } catch (error) {
                console.error('âŒ æ¢å¤éš”ç¦»é¡¹å¤±è´¥:', error);
                alert('æ¢å¤å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ é™¤éš”ç¦»é¡¹
        async function deleteQuarantineItem() {
            if (selectedQuarantineItem === null) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªéš”ç¦»é¡¹');
                return;
            }
            
            try {
                const item = quarantineData[selectedQuarantineItem];
                
                if (!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ä¸ªéš”ç¦»é¡¹å—ï¼Ÿ\n\nç±»å‹: ${item.type}\næè¿°: ${item.description}\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                    return;
                }
                
                console.log('ğŸ—‘ï¸ åˆ é™¤éš”ç¦»é¡¹:', item);
                
                // ä»Firebaseåˆ é™¤
                const db = firebase.database();
                await db.ref(`quarantine/${selectedQuarantineItem}`).remove();
                
                console.log('âœ… éš”ç¦»é¡¹å·²åˆ é™¤');
                
                // åˆ·æ–°æ˜¾ç¤º
                selectedQuarantineItem = null;
                await loadQuarantineData();
                
                // éšè—è¯¦æƒ…
                document.getElementById('quarantineDetails').style.display = 'none';
                
                // ç¦ç”¨æŒ‰é’®
                document.getElementById('resolveBtn').disabled = true;
                document.getElementById('restoreBtn').disabled = true;
                document.getElementById('deleteBtn').disabled = true;
                
                alert('éš”ç¦»é¡¹å·²åˆ é™¤');
                
            } catch (error) {
                console.error('âŒ åˆ é™¤éš”ç¦»é¡¹å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰éš”ç¦»æ•°æ®
        async function clearAllQuarantine() {
            if (quarantineData.length === 0) {
                alert('æ²¡æœ‰éš”ç¦»æ•°æ®å¯æ¸…ç©º');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${quarantineData.length} æ¡éš”ç¦»æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }
            
            try {
                console.log('ğŸ§¹ å¼€å§‹æ¸…ç©ºæ‰€æœ‰éš”ç¦»æ•°æ®...');
                
                if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                    throw new Error('Firebaseæœªåˆå§‹åŒ–');
                }
                
                const db = firebase.database();
                
                // æ¸…ç©ºéš”ç¦»åŒº
                await db.ref('quarantine').remove();
                
                console.log('âœ… æ‰€æœ‰éš”ç¦»æ•°æ®å·²æ¸…ç©º');
                
                // åˆ·æ–°æ˜¾ç¤º
                selectedQuarantineItem = null;
                await loadQuarantineData();
                
                // éšè—è¯¦æƒ…
                document.getElementById('quarantineDetails').style.display = 'none';
                
                // ç¦ç”¨æŒ‰é’®
                document.getElementById('resolveBtn').disabled = true;
                document.getElementById('restoreBtn').disabled = true;
                document.getElementById('deleteBtn').disabled = true;
                
                alert('æ‰€æœ‰éš”ç¦»æ•°æ®å·²æˆåŠŸæ¸…ç©º');
                
            } catch (error) {
                console.error('âŒ æ¸…ç©ºéš”ç¦»æ•°æ®å¤±è´¥:', error);
                alert('æ¸…ç©ºéš”ç¦»æ•°æ®å¤±è´¥: ' + error.message);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', async function() {
            console.log('å†²çªéš”ç¦»ç®¡ç†å·¥å…·åŠ è½½å®Œæˆ');
            
            if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
                console.error('âŒ Firebaseæœªåˆå§‹åŒ–');
            } else {
                console.log('âœ… Firebaseå·²åˆå§‹åŒ–');
                // è‡ªåŠ¨åŠ è½½æ•°æ®
                await loadQuarantineData();
            }
        });
    </script>
</body>
</html>

