<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统验证工具 - MSH签到系统</title>
    <link rel="stylesheet" href="../../src/style.css">
    <style>
        .verification-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .verification-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .verification-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .verification-header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .verification-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .verification-section h2 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .verification-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .verification-item:hover {
            background: #e2e8f0;
            border-color: #4299e1;
        }

        .verification-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .verification-item-title {
            font-weight: bold;
            color: #2d3748;
        }

        .verification-item-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .verification-item-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .verification-item-status.running {
            background: #d1ecf1;
            color: #0c5460;
        }

        .verification-item-status.passed {
            background: #d4edda;
            color: #155724;
        }

        .verification-item-status.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .verification-item-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .verification-results {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }

        .verification-results.show {
            display: block;
        }

        .verification-log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-info { color: #4299e1; }
        .log-success { color: #48bb78; }
        .log-warning { color: #ed8936; }
        .log-error { color: #f56565; }

        .verification-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .verification-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="verification-container">
        <div class="verification-header">
            <h1>🔍 系统验证工具</h1>
            <p>验证MSH系统的所有功能是否正常工作</p>
        </div>
        
        <!-- 验证统计 -->
        <div class="verification-section">
            <h2>📊 验证统计</h2>
            <div class="verification-summary">
                <div class="summary-card">
                    <div class="summary-number" id="totalVerifications">0</div>
                    <div class="summary-label">总验证项</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="passedVerifications">0</div>
                    <div class="summary-label">通过验证</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="failedVerifications">0</div>
                    <div class="summary-label">失败验证</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="pendingVerifications">0</div>
                    <div class="summary-label">待验证</div>
                </div>
            </div>
        </div>
        
        <!-- 验证操作 -->
        <div class="verification-section">
            <h2>🔄 验证操作</h2>
            <div class="verification-actions">
                <button class="btn btn-primary" onclick="runAllVerifications()">🚀 运行所有验证</button>
                <button class="btn btn-success" onclick="runPassedVerifications()">✅ 运行通过验证</button>
                <button class="btn btn-warning" onclick="runFailedVerifications()">❌ 运行失败验证</button>
                <button class="btn btn-danger" onclick="resetAllVerifications()">🔄 重置所有验证</button>
            </div>
        </div>
        
        <!-- 核心功能验证 -->
        <div class="verification-section">
            <h2>⚙️ 核心功能验证</h2>
            <div class="verification-item" id="verification-firebase-connection">
                <div class="verification-item-header">
                    <div class="verification-item-title">Firebase连接验证</div>
                    <div class="verification-item-status pending">待验证</div>
                </div>
                <div class="verification-item-actions">
                    <button class="btn btn-primary" onclick="runVerification('firebase-connection')">运行验证</button>
                </div>
                <div class="verification-results" id="results-firebase-connection"></div>
            </div>
            
            <div class="verification-item" id="verification-data-sync">
                <div class="verification-item-header">
                    <div class="verification-item-title">数据同步验证</div>
                    <div class="verification-item-status pending">待验证</div>
                </div>
                <div class="verification-item-actions">
                    <button class="btn btn-primary" onclick="runVerification('data-sync')">运行验证</button>
                </div>
                <div class="verification-results" id="results-data-sync"></div>
            </div>
            
            <div class="verification-item" id="verification-excluded-members">
                <div class="verification-item-header">
                    <div class="verification-item-title">排除人员标记化验证</div>
                    <div class="verification-item-status pending">待验证</div>
                </div>
                <div class="verification-item-actions">
                    <button class="btn btn-primary" onclick="runVerification('excluded-members')">运行验证</button>
                </div>
                <div class="verification-results" id="results-excluded-members"></div>
            </div>
        </div>
        
        <!-- 新增功能验证 -->
        <div class="verification-section">
            <h2>🆕 新增功能验证</h2>
            <div class="verification-item" id="verification-quarantine-mechanism">
                <div class="verification-item-header">
                    <div class="verification-item-title">冲突隔离机制验证</div>
                    <div class="verification-item-status pending">待验证</div>
                </div>
                <div class="verification-item-actions">
                    <button class="btn btn-primary" onclick="runVerification('quarantine-mechanism')">运行验证</button>
                </div>
                <div class="verification-results" id="results-quarantine-mechanism"></div>
            </div>
            
            <div class="verification-item" id="verification-data-backup">
                <div class="verification-item-header">
                    <div class="verification-item-title">数据备份机制验证</div>
                    <div class="verification-item-status pending">待验证</div>
                </div>
                <div class="verification-item-actions">
                    <button class="btn btn-primary" onclick="runVerification('data-backup')">运行验证</button>
                </div>
                <div class="verification-results" id="results-data-backup"></div>
            </div>
            
            <div class="verification-item" id="verification-performance-monitor">
                <div class="verification-item-header">
                    <div class="verification-item-title">性能监控验证</div>
                    <div class="verification-item-status pending">待验证</div>
                </div>
                <div class="verification-item-actions">
                    <button class="btn btn-primary" onclick="runVerification('performance-monitor')">运行验证</button>
                </div>
                <div class="verification-results" id="results-performance-monitor"></div>
            </div>
            
            <div class="verification-item" id="verification-user-feedback">
                <div class="verification-item-header">
                    <div class="verification-item-title">用户反馈收集验证</div>
                    <div class="verification-item-status pending">待验证</div>
                </div>
                <div class="verification-item-actions">
                    <button class="btn btn-primary" onclick="runVerification('user-feedback')">运行验证</button>
                </div>
                <div class="verification-results" id="results-user-feedback"></div>
            </div>
        </div>
        
        <!-- 系统集成验证 -->
        <div class="verification-section">
            <h2>🔗 系统集成验证</h2>
            <div class="verification-item" id="verification-system-integration">
                <div class="verification-item-header">
                    <div class="verification-item-title">系统集成验证</div>
                    <div class="verification-item-status pending">待验证</div>
                </div>
                <div class="verification-item-actions">
                    <button class="btn btn-primary" onclick="runVerification('system-integration')">运行验证</button>
                </div>
                <div class="verification-results" id="results-system-integration"></div>
            </div>
            
            <div class="verification-item" id="verification-data-consistency">
                <div class="verification-item-header">
                    <div class="verification-item-title">数据一致性验证</div>
                    <div class="verification-item-status pending">待验证</div>
                </div>
                <div class="verification-item-actions">
                    <button class="btn btn-primary" onclick="runVerification('data-consistency')">运行验证</button>
                </div>
                <div class="verification-results" id="results-data-consistency"></div>
            </div>
        </div>
        
        <!-- 验证日志 -->
        <div class="verification-section">
            <h2>📝 验证日志</h2>
            <div class="verification-log" id="verificationLog">
                <div class="log-entry info">系统验证工具已加载</div>
            </div>
            <button class="btn btn-warning" onclick="clearVerificationLog()">清空日志</button>
        </div>
    </div>

    <!-- 引入必要的脚本 -->
    <script src="../../config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="../../src/utils.js"></script>
    <script src="../../src/new-data-manager.js"></script>
    <script src="../../src/data-backup-manager.js"></script>
    <script src="../../src/performance-monitor.js"></script>
    <script src="../../src/user-feedback-collector.js"></script>
    
    <script>
        // 系统验证工具
        let verificationResults = {};
        let totalVerifications = 0;
        let passedVerifications = 0;
        let failedVerifications = 0;
        let pendingVerifications = 0;
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            addVerificationLog('info', '系统验证工具已加载');
            updateVerificationStats();
        });
        
        // 运行单个验证
        async function runVerification(verificationId) {
            try {
                addVerificationLog('info', `开始运行验证: ${verificationId}`);
                
                // 更新验证状态
                updateVerificationStatus(verificationId, 'running');
                
                // 执行验证
                const result = await executeVerification(verificationId);
                
                // 更新验证结果
                verificationResults[verificationId] = result;
                updateVerificationStatus(verificationId, result.passed ? 'passed' : 'failed');
                displayVerificationResults(verificationId, result);
                
                // 更新统计
                updateVerificationStats();
                
                addVerificationLog(result.passed ? 'success' : 'error', 
                    `验证 ${verificationId} ${result.passed ? '通过' : '失败'}: ${result.message}`);
                
            } catch (error) {
                console.error(`验证 ${verificationId} 失败:`, error);
                addVerificationLog('error', `验证 ${verificationId} 失败: ${error.message}`);
                updateVerificationStatus(verificationId, 'failed');
                updateVerificationStats();
            }
        }
        
        // 执行具体验证
        async function executeVerification(verificationId) {
            switch (verificationId) {
                case 'firebase-connection':
                    return await verifyFirebaseConnection();
                case 'data-sync':
                    return await verifyDataSync();
                case 'excluded-members':
                    return await verifyExcludedMembers();
                case 'quarantine-mechanism':
                    return await verifyQuarantineMechanism();
                case 'data-backup':
                    return await verifyDataBackup();
                case 'performance-monitor':
                    return await verifyPerformanceMonitor();
                case 'user-feedback':
                    return await verifyUserFeedback();
                case 'system-integration':
                    return await verifySystemIntegration();
                case 'data-consistency':
                    return await verifyDataConsistency();
                default:
                    throw new Error(`未知验证: ${verificationId}`);
            }
        }
        
        // Firebase连接验证
        async function verifyFirebaseConnection() {
            try {
                if (typeof firebase === 'undefined') {
                    return { passed: false, message: 'Firebase SDK未加载' };
                }
                
                if (firebase.apps.length === 0) {
                    return { passed: false, message: 'Firebase未初始化' };
                }
                
                const db = firebase.database();
                await db.ref('test').once('value');
                
                return { passed: true, message: 'Firebase连接正常' };
            } catch (error) {
                return { passed: false, message: `Firebase连接失败: ${error.message}` };
            }
        }
        
        // 数据同步验证
        async function verifyDataSync() {
            try {
                // 检查数据同步机制
                const groups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                const groupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
                
                if (Object.keys(groups).length === 0) {
                    return { passed: false, message: '没有小组数据' };
                }
                
                // 检查数据一致性
                const groupKeys = Object.keys(groups);
                const nameKeys = Object.keys(groupNames);
                
                if (groupKeys.length !== nameKeys.length) {
                    return { passed: false, message: '小组数据与名称数据不一致' };
                }
                
                return { passed: true, message: `数据同步正常，共 ${groupKeys.length} 个小组` };
            } catch (error) {
                return { passed: false, message: `数据同步验证失败: ${error.message}` };
            }
        }
        
        // 排除人员标记化验证
        async function verifyExcludedMembers() {
            try {
                // 检查排除人员标记化功能
                if (typeof window.utils === 'undefined' || !window.utils.setMemberExcluded) {
                    return { passed: false, message: '排除人员标记化功能未实现' };
                }
                
                // 检查迁移功能
                if (typeof window.utils.migrateExcludedMembers === 'undefined') {
                    return { passed: false, message: '排除人员迁移功能未实现' };
                }
                
                return { passed: true, message: '排除人员标记化功能正常' };
            } catch (error) {
                return { passed: false, message: `排除人员标记化验证失败: ${error.message}` };
            }
        }
        
        // 冲突隔离机制验证
        async function verifyQuarantineMechanism() {
            try {
                // 检查冲突隔离功能
                const conflictManager = document.querySelector('[href*="data-conflict-manager"]');
                if (!conflictManager) {
                    return { passed: false, message: '冲突管理工具未找到' };
                }
                
                // 检查隔离功能
                if (typeof loadQuarantineData === 'undefined') {
                    return { passed: false, message: '隔离功能未实现' };
                }
                
                return { passed: true, message: '冲突隔离机制正常' };
            } catch (error) {
                return { passed: false, message: `冲突隔离机制验证失败: ${error.message}` };
            }
        }
        
        // 数据备份验证
        async function verifyDataBackup() {
            try {
                // 检查数据备份管理器
                if (typeof window.dataBackupManager === 'undefined') {
                    return { passed: false, message: '数据备份管理器未加载' };
                }
                
                // 检查备份功能
                if (typeof window.dataBackupManager.createFullBackup === 'undefined') {
                    return { passed: false, message: '数据备份功能未实现' };
                }
                
                return { passed: true, message: '数据备份机制正常' };
            } catch (error) {
                return { passed: false, message: `数据备份验证失败: ${error.message}` };
            }
        }
        
        // 性能监控验证
        async function verifyPerformanceMonitor() {
            try {
                // 检查性能监控器
                if (typeof window.performanceMonitor === 'undefined') {
                    return { passed: false, message: '性能监控器未加载' };
                }
                
                // 检查监控功能
                if (typeof window.performanceMonitor.getPerformanceReport === 'undefined') {
                    return { passed: false, message: '性能监控功能未实现' };
                }
                
                return { passed: true, message: '性能监控正常' };
            } catch (error) {
                return { passed: false, message: `性能监控验证失败: ${error.message}` };
            }
        }
        
        // 用户反馈收集验证
        async function verifyUserFeedback() {
            try {
                // 检查用户反馈收集器
                if (typeof window.userFeedbackCollector === 'undefined') {
                    return { passed: false, message: '用户反馈收集器未加载' };
                }
                
                // 检查反馈功能
                if (typeof window.userFeedbackCollector.submitFeedback === 'undefined') {
                    return { passed: false, message: '用户反馈功能未实现' };
                }
                
                return { passed: true, message: '用户反馈收集正常' };
            } catch (error) {
                return { passed: false, message: `用户反馈验证失败: ${error.message}` };
            }
        }
        
        // 系统集成验证
        async function verifySystemIntegration() {
            try {
                // 检查所有核心组件
                const components = [
                    { name: 'Firebase', check: () => typeof firebase !== 'undefined' },
                    { name: 'Utils', check: () => typeof window.utils !== 'undefined' },
                    { name: 'NewDataManager', check: () => typeof window.newDataManager !== 'undefined' },
                    { name: 'DataBackupManager', check: () => typeof window.dataBackupManager !== 'undefined' },
                    { name: 'PerformanceMonitor', check: () => typeof window.performanceMonitor !== 'undefined' },
                    { name: 'UserFeedbackCollector', check: () => typeof window.userFeedbackCollector !== 'undefined' }
                ];
                
                const missingComponents = components.filter(component => !component.check());
                
                if (missingComponents.length > 0) {
                    return { passed: false, message: `缺少组件: ${missingComponents.map(c => c.name).join(', ')}` };
                }
                
                return { passed: true, message: '系统集成正常，所有组件已加载' };
            } catch (error) {
                return { passed: false, message: `系统集成验证失败: ${error.message}` };
            }
        }
        
        // 数据一致性验证
        async function verifyDataConsistency() {
            try {
                // 检查数据一致性
                const groups = JSON.parse(localStorage.getItem('msh_groups') || '{}');
                const groupNames = JSON.parse(localStorage.getItem('msh_groupNames') || '{}');
                const attendanceRecords = JSON.parse(localStorage.getItem('msh_attendanceRecords') || '[]');
                
                // 检查小组数据一致性
                const groupKeys = Object.keys(groups);
                const nameKeys = Object.keys(groupNames);
                
                if (groupKeys.length !== nameKeys.length) {
                    return { passed: false, message: '小组数据与名称数据不一致' };
                }
                
                // 检查签到记录中的小组引用
                const invalidGroups = attendanceRecords.filter(record => 
                    record.group && !groupKeys.includes(record.group)
                );
                
                if (invalidGroups.length > 0) {
                    return { passed: false, message: `发现 ${invalidGroups.length} 条无效小组引用的签到记录` };
                }
                
                return { passed: true, message: '数据一致性检查通过' };
            } catch (error) {
                return { passed: false, message: `数据一致性验证失败: ${error.message}` };
            }
        }
        
        // 运行所有验证
        async function runAllVerifications() {
            addVerificationLog('info', '开始运行所有验证...');
            
            const verificationIds = [
                'firebase-connection', 'data-sync', 'excluded-members',
                'quarantine-mechanism', 'data-backup', 'performance-monitor',
                'user-feedback', 'system-integration', 'data-consistency'
            ];
            
            for (const verificationId of verificationIds) {
                await runVerification(verificationId);
                await new Promise(resolve => setTimeout(resolve, 500)); // 延迟500ms
            }
            
            addVerificationLog('success', '所有验证运行完成');
        }
        
        // 运行通过的验证
        async function runPassedVerifications() {
            const passedVerificationIds = Object.keys(verificationResults).filter(id => verificationResults[id].passed);
            addVerificationLog('info', `开始运行 ${passedVerificationIds.length} 个通过的验证...`);
            
            for (const verificationId of passedVerificationIds) {
                await runVerification(verificationId);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }
        
        // 运行失败的验证
        async function runFailedVerifications() {
            const failedVerificationIds = Object.keys(verificationResults).filter(id => !verificationResults[id].passed);
            addVerificationLog('info', `开始运行 ${failedVerificationIds.length} 个失败的验证...`);
            
            for (const verificationId of failedVerificationIds) {
                await runVerification(verificationId);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }
        
        // 重置所有验证
        function resetAllVerifications() {
            verificationResults = {};
            updateVerificationStats();
            
            // 重置所有验证状态
            document.querySelectorAll('.verification-item-status').forEach(status => {
                status.textContent = '待验证';
                status.className = 'verification-item-status pending';
            });
            
            // 隐藏所有验证结果
            document.querySelectorAll('.verification-results').forEach(results => {
                results.style.display = 'none';
            });
            
            addVerificationLog('info', '所有验证已重置');
        }
        
        // 更新验证状态
        function updateVerificationStatus(verificationId, status) {
            const statusElement = document.querySelector(`#verification-${verificationId} .verification-item-status`);
            if (statusElement) {
                statusElement.textContent = {
                    'pending': '待验证',
                    'running': '运行中',
                    'passed': '通过',
                    'failed': '失败'
                }[status];
                statusElement.className = `verification-item-status ${status}`;
            }
        }
        
        // 显示验证结果
        function displayVerificationResults(verificationId, result) {
            const resultsElement = document.getElementById(`results-${verificationId}`);
            if (resultsElement) {
                resultsElement.innerHTML = `
                    <div style="color: ${result.passed ? '#48bb78' : '#f56565'}; font-weight: bold;">
                        ${result.passed ? '✅ 通过' : '❌ 失败'}: ${result.message}
                    </div>
                `;
                resultsElement.style.display = 'block';
            }
        }
        
        // 更新验证统计
        function updateVerificationStats() {
            totalVerifications = document.querySelectorAll('.verification-item').length;
            passedVerifications = Object.values(verificationResults).filter(result => result.passed).length;
            failedVerifications = Object.values(verificationResults).filter(result => !result.passed).length;
            pendingVerifications = totalVerifications - Object.keys(verificationResults).length;
            
            document.getElementById('totalVerifications').textContent = totalVerifications;
            document.getElementById('passedVerifications').textContent = passedVerifications;
            document.getElementById('failedVerifications').textContent = failedVerifications;
            document.getElementById('pendingVerifications').textContent = pendingVerifications;
        }
        
        // 添加验证日志
        function addVerificationLog(type, message) {
            const container = document.getElementById('verificationLog');
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }
        
        // 清空验证日志
        function clearVerificationLog() {
            document.getElementById('verificationLog').innerHTML = '<div class="log-entry info">验证日志已清空</div>';
        }
    </script>
</body>
</html>


