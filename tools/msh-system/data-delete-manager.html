<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSH数据删除管理工具</title>
    <link rel="stylesheet" href="../../src/style.css">
    <link rel="stylesheet" href="conflict-tools-shared.css">
</head>
<body>
    <div class="conflict-manager-container">
        <!-- 管理员警告横幅 -->
        <div class="admin-warning-banner">
            <h2>
                <span class="warning-icon">🚨</span>
                管理员专用工具 - 高风险操作区
            </h2>
            <p><strong>⚠️ 警告：此页面仅供系统管理员使用！</strong></p>
            <p>本页面包含以下高风险操作：</p>
            <ul>
                <li>🗑️ <strong>永久删除</strong>小组、成员、签到记录</li>
                <li>🧹 <strong>批量清理</strong>历史数据</li>
            </ul>
            <p><strong>所有操作都是不可撤销的！</strong>请确保您：</p>
            <ul>
                <li>✅ 已备份重要数据</li>
                <li>✅ 完全理解每个操作的影响</li>
                <li>✅ 有权限执行这些操作</li>
            </ul>
        </div>
        
        <!-- 页面头部 -->
        <div class="conflict-manager-header">
            <h1>🗑️ MSH数据删除管理</h1>
            <p>管理和删除系统数据</p>
        </div>
        
        <!-- 返回按钮 -->
        <div class="back-button-container">
            <button class="back-button" onclick="goBack()">
                ← 返回管理页面
            </button>
        </div>
        
        <div class="warning-banner">
            <span class="icon">⚠️</span>
            <strong>警告：</strong>所有删除操作都是不可撤销的，请确保您知道自己在做什么！
        </div>
        
        <!-- 删除人员 -->
        <div class="delete-section">
            <h3><span class="icon">👤</span>删除人员</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="deleteGroupSelect">选择小组</label>
                    <select id="deleteGroupSelect" onchange="loadMembers()">
                        <option value="">--请选择小组--</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deleteMemberSelect">选择人员</label>
                    <select id="deleteMemberSelect">
                        <option value="">--请先选择小组--</option>
                    </select>
                </div>
            </div>
            <button class="delete-button" onclick="deleteMember()" id="deleteMemberBtn" disabled>
                删除选中人员
            </button>
        </div>
        
        <!-- 删除签到记录 -->
        <div class="delete-section">
            <h3><span class="icon">📝</span>删除签到记录</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="deleteDate">选择日期：</label>
                    <input type="date" id="deleteDate" onchange="loadMemberRecords()" class="date-input">
                </div>
                <div class="form-group">
                    <label for="deleteMemberName">选择人员：</label>
                    <select id="deleteMemberName" class="form-control" onchange="loadAttendanceRecords()">
                        <option value="">--请选择人员--</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="deleteRecordSelect">选择要删除的签到记录（可多选）</label>
                <select id="deleteRecordSelect" multiple size="5" class="multi-select" onchange="checkRecordSelection()">
                    <option value="">--请先选择日期--</option>
                </select>
                <div class="multi-select-controls">
                    <button type="button" onclick="selectAllRecords()" class="btn btn-warning select-all-btn">全选</button>
                    <button type="button" onclick="clearAllRecords()" class="btn btn-secondary">清空选择</button>
                </div>
            </div>
            <button class="delete-button" onclick="deleteSelectedAttendanceRecords()" id="deleteSelectedRecordsBtn" disabled>
                删除选中的签到记录
            </button>
        </div>
        
        <!-- 删除小组 -->
        <div class="delete-section">
            <h3><span class="icon">🏢</span>删除小组</h3>
            <div class="form-group">
                <label for="deleteGroupSelect2">选择要删除的小组</label>
                <select id="deleteGroupSelect2">
                    <option value="">--请选择小组--</option>
                </select>
            </div>
            <button class="delete-button" onclick="deleteGroup()" id="deleteGroupBtn" disabled>
                删除选中小组
            </button>
        </div>
        
        <!-- 批量清理 -->
        <div class="delete-section">
            <h3><span class="icon">🧹</span>批量清理</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="cleanupDays">清理多少天前的签到记录</label>
                    <select id="cleanupDays">
                        <option value="30">30天前</option>
                        <option value="60">60天前</option>
                        <option value="90">90天前</option>
                        <option value="180">180天前</option>
                        <option value="365">365天前</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cleanupType">清理类型</label>
                    <select id="cleanupType">
                        <option value="attendance">签到记录</option>
                        <option value="all">所有数据</option>
                    </select>
                </div>
            </div>
            <button class="delete-button" onclick="batchCleanup()" id="cleanupBtn">
                执行批量清理
            </button>
        </div>
        
        <!-- 操作日志 -->
        <div class="log-section">
            <h3>📋 操作日志</h3>
            <div class="log-container" id="deleteLogContainer">
                <div class="log-entry info">等待操作...</div>
            </div>
            <button class="btn btn-warning clear-log" onclick="clearDeleteLog()">清空日志</button>
        </div>
    </div>

    <!-- 引入必要的脚本 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="../../src/smart-config-loader.js"></script>
    <script src="../../src/core/firebase-utils.js"></script>
  <script src="../../src/core/time-utils.js"></script>
  <script src="../../src/core/security-utils.js"></script>
  <script src="../../src/data/uuid-manager.js"></script>
  <script src="../../src/features/sunday-tracking-utils.js"></script>
  <script src="../../src/data/sync-managers.js"></script>
  <script src="../../src/utils.js"></script>
    <script src="../../src/new-data-manager.js"></script>
    
    <script>
        // 初始化Firebase
        if (typeof firebase !== 'undefined' && !firebase.apps.length && window.firebaseConfig) {
            try {
                firebase.initializeApp(window.firebaseConfig);
                console.log('✅ Firebase初始化成功');
                window.db = firebase.database();
            } catch (error) {
                console.error('❌ Firebase初始化失败:', error);
            }
        }
        
        // 数据删除管理系统的JavaScript功能
        let deleteData = {
            groups: {},
            groupNames: {},
            attendanceRecords: []
        };
        
        // 返回管理页面
        function goBack() {
            console.log('🔙 返回管理页面');
            window.location.href = '../../admin.html';
        }
        
        // 加载删除管理数据
        async function loadDeleteData() {
            try {
                deleteLog('开始加载删除管理数据...');
                
                // 加载Firebase数据（不加载全部签到记录，按需加载）
                const db = firebase.database();
                deleteData.groups = await db.ref('groups').once('value').then(snapshot => snapshot.val() || {});
                deleteData.groupNames = await db.ref('groupNames').once('value').then(snapshot => snapshot.val() || {});
                // ⚠️ 不再初始化时加载全部attendanceRecords，改为按需加载
                deleteData.attendanceRecords = [];
                
                // 更新UI
                updateGroupSelects();
                updateDeleteDate();
                
                deleteLog('删除管理数据加载完成（签到记录将按需加载）', 'success');
                
            } catch (error) {
                deleteLog(`加载删除管理数据失败: ${error.message}`, 'error');
            }
        }
        
        // 更新小组选择器
        function updateGroupSelects() {
            const groupSelect1 = document.getElementById('deleteGroupSelect');
            const groupSelect2 = document.getElementById('deleteGroupSelect2');
            
            if (!groupSelect1 || !groupSelect2) return;
            
            // 清空现有选项
            groupSelect1.innerHTML = '<option value="">--请选择小组--</option>';
            groupSelect2.innerHTML = '<option value="">--请选择小组--</option>';
            
            // 添加所有小组选项
            Object.keys(deleteData.groups).forEach(groupKey => {
                const groupName = deleteData.groupNames[groupKey] || groupKey;
                const memberCount = deleteData.groups[groupKey] ? deleteData.groups[groupKey].length : 0;
                
                const option1 = new Option(`${groupName} (${memberCount}人)`, groupKey);
                const option2 = new Option(`${groupName} (${memberCount}人)`, groupKey);
                
                groupSelect1.add(option1);
                groupSelect2.add(option2);
            });
        }
        
        // 更新删除日期为今天
        function updateDeleteDate() {
            const dateInput = document.getElementById('deleteDate');
            if (dateInput) {
                // 不设置默认日期，让用户主动选择
                dateInput.value = '';
            }
        }
        
        // 加载成员列表
        function loadMembers() {
            const groupSelect = document.getElementById('deleteGroupSelect');
            const memberSelect = document.getElementById('deleteMemberSelect');
            const deleteBtn = document.getElementById('deleteMemberBtn');
            
            if (!groupSelect || !memberSelect) return;
            
            const selectedGroup = groupSelect.value;
            
            // 清空成员选择器
            memberSelect.innerHTML = '<option value="">--请选择人员--</option>';
            deleteBtn.disabled = true;
            
            if (!selectedGroup) return;
            
            // 加载选中小组的成员
            const members = deleteData.groups[selectedGroup] || [];
            members.forEach(member => {
                const option = new Option(
                    `${member.name} (${member.source || '未知来源'})`,
                    JSON.stringify(member)
                );
                memberSelect.add(option);
            });
            
            // 启用删除按钮选择监听
            memberSelect.onchange = function() {
                deleteBtn.disabled = !this.value;
            };
        }
        
        // 加载指定日期的签到记录（按需加载）
        async function loadMemberRecords() {
            const dateInput = document.getElementById('deleteDate');
            const deleteMemberName = document.getElementById('deleteMemberName');
            const recordSelect = document.getElementById('deleteRecordSelect');
            
            if (!dateInput || !deleteMemberName || !recordSelect) return;
            
            const selectedDate = dateInput.value;
            
            // 清空人员列表和记录列表
            deleteMemberName.innerHTML = '<option value="">--请选择人员--</option>';
            recordSelect.innerHTML = '';
            
            if (!selectedDate) {
                deleteLog('请先选择日期', 'warning');
                recordSelect.innerHTML = '<option value="">--请先选择日期--</option>';
                deleteData.attendanceRecords = [];
                return;
            }
            
            try {
                deleteLog(`正在加载 ${selectedDate} 的签到记录...`, 'info');
                
                // 从Firebase加载该日期的所有签到记录
                const db = firebase.database();
                const snapshot = await db.ref('attendanceRecords').once('value');
                const rawData = snapshot.val();
                
                if (!rawData) {
                    deleteLog(`${selectedDate} Firebase中没有数据`, 'warning');
                    recordSelect.innerHTML = '<option value="">Firebase中没有签到记录</option>';
                    deleteData.attendanceRecords = [];
                    deleteData.currentDateRecords = [];
                    return;
                }
                
                // 处理Firebase数据格式（可能是数组或对象）
                let allRecords = [];
                let recordKeys = {}; // 保存每条记录的Firebase键
                
                if (Array.isArray(rawData)) {
                    // 数组格式：保存索引作为键
                    rawData.forEach((r, index) => {
                        if (r !== null && r !== undefined) {
                            allRecords.push(r);
                            recordKeys[JSON.stringify(r)] = index;
                        }
                    });
                    deleteLog(`从Firebase加载数组格式: ${allRecords.length} 条记录`, 'info');
                } else if (typeof rawData === 'object') {
                    // 对象格式：保存键名
                    Object.entries(rawData).forEach(([key, r]) => {
                        if (r !== null && r !== undefined) {
                            allRecords.push(r);
                            recordKeys[JSON.stringify(r)] = key;
                        }
                    });
                    deleteLog(`从Firebase加载对象格式，转换为数组: ${allRecords.length} 条记录`, 'info');
                }
                
                // 筛选出该日期的记录
                const dateRecords = allRecords.filter(r => {
                    if (!r || !r.time) return false;
                    const recordDate = new Date(r.time).toISOString().split('T')[0];
                    return recordDate === selectedDate;
                });
                
                // 保存到deleteData
                deleteData.attendanceRecords = allRecords; // 保存全部记录用于后续删除操作
                deleteData.recordKeys = recordKeys; // 保存记录的Firebase键映射
                deleteData.currentDateRecords = dateRecords; // 保存当天记录用于显示
                deleteData.isObjectFormat = typeof rawData === 'object' && !Array.isArray(rawData); // 标记格式类型
                
                if (dateRecords.length === 0) {
                    deleteLog(`${selectedDate} 没有签到记录`, 'warning');
                    recordSelect.innerHTML = '<option value="">该日期没有签到记录</option>';
                    return;
                }
                
                deleteLog(`成功加载 ${dateRecords.length} 条签到记录`, 'success');
                
                // 收集该日期内有签到的唯一人员名字
                const uniqueNames = [...new Set(dateRecords
                    .filter(r => r && r.name)
                    .map(r => r.name))];
                
                // 按拼音排序
                uniqueNames.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                
                // 添加到人员下拉列表
                uniqueNames.forEach(name => {
                    const option = new Option(name, name);
                    deleteMemberName.add(option);
                });
                
                deleteLog(`找到 ${uniqueNames.length} 个有签到记录的人员`, 'info');
                
                // 加载签到记录显示
                loadAttendanceRecords();
                
            } catch (error) {
                deleteLog(`加载签到记录失败: ${error.message}`, 'error');
                recordSelect.innerHTML = '<option value="">加载失败，请重试</option>';
            }
        }
        
        // 加载签到记录显示
        function loadAttendanceRecords() {
            const memberNameSelect = document.getElementById('deleteMemberName');
            const recordSelect = document.getElementById('deleteRecordSelect');
            
            if (!recordSelect) return;
            
            const selectedName = memberNameSelect ? memberNameSelect.value : '';
            
            // 清空记录选择器
            recordSelect.innerHTML = '';
            
            // 使用已加载的当天记录
            if (!deleteData.currentDateRecords || deleteData.currentDateRecords.length === 0) {
                recordSelect.innerHTML = '<option value="">--请先选择日期--</option>';
                return;
            }
            
            // 根据选择的人员筛选记录
            const filteredRecords = selectedName 
                ? deleteData.currentDateRecords.filter(r => r.name === selectedName)
                : deleteData.currentDateRecords;
            
            if (filteredRecords.length === 0) {
                recordSelect.innerHTML = '<option value="">没有找到符合条件的记录</option>';
                return;
            }
            
            // 显示找到的记录
            filteredRecords.forEach((record) => {
                // 获取记录的Firebase键
                const recordKey = deleteData.recordKeys ? deleteData.recordKeys[JSON.stringify(record)] : null;
                const time = new Date(record.time).toLocaleString('zh-CN');
                const optionText = `${record.name} - ${time} - ${record.group || '未知小组'}`;
                const option = new Option(optionText, `record_${recordKey}`);
                recordSelect.add(option);
            });
            
            if (selectedName) {
                deleteLog(`显示 ${filteredRecords.length} 条 ${selectedName} 的签到记录`, 'info');
            }
        }
        
        // 检查记录选择
        function checkRecordSelection() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            const deleteBtn = document.getElementById('deleteSelectedRecordsBtn');
            
            if (!recordSelect || !deleteBtn) return;
            
            const selectedOptions = Array.from(recordSelect.selectedOptions);
            deleteBtn.disabled = selectedOptions.length === 0;
        }
        
        // 全选记录
        function selectAllRecords() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            if (!recordSelect) return;
            
            Array.from(recordSelect.options).forEach(option => {
                option.selected = true;
            });
            
            checkRecordSelection();
        }
        
        // 清空选择
        function clearAllRecords() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            if (!recordSelect) return;
            
            Array.from(recordSelect.options).forEach(option => {
                option.selected = false;
            });
            
            checkRecordSelection();
        }
        
        // 删除选中的签到记录（增强安全版本）
        async function deleteSelectedAttendanceRecords() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            if (!recordSelect) return;
            
            const selectedOptions = Array.from(recordSelect.selectedOptions);
            if (selectedOptions.length === 0) {
                alert('请先选择要删除的签到记录');
                return;
            }
            
            // 确认删除
            const confirmDelete = confirm(`确定要删除 ${selectedOptions.length} 条签到记录吗？\n\n此操作不可撤销！`);
            if (!confirmDelete) return;
            
            try {
                console.log('🔍 开始删除签到记录...');
                
                if (!window.db) {
                    throw new Error('Firebase未初始化');
                }
                
                // 获取要删除的记录键（可能是索引或Firebase对象键）
                const recordKeysToDelete = selectedOptions.map(option => {
                    const match = option.value.match(/record_(.+)/);
                    return match ? match[1] : null;
                }).filter(key => key !== null);
                
                console.log(`📋 要删除的记录键:`, recordKeysToDelete);
                
                // 🚨 安全检查：防止误删除（并发检测）
                const latestSnapshot = await window.db.ref('attendanceRecords').once('value');
                const latestRecordsRaw = latestSnapshot.val() || [];
                const latestCount = Array.isArray(latestRecordsRaw) 
                    ? latestRecordsRaw.filter(r => r !== null && r !== undefined).length
                    : (typeof latestRecordsRaw === 'object' ? Object.keys(latestRecordsRaw).length : 0);
                
                if (latestCount !== deleteData.attendanceRecords.length) {
                    const proceed = confirm(
                        `⚠️ 数据并发冲突检测\n\n` +
                        `页面加载时记录数: ${deleteData.attendanceRecords.length}\n` +
                        `当前最新记录数: ${latestCount}\n\n` +
                        `数据已被其他用户修改！\n` +
                        `建议刷新页面后重试。\n\n` +
                        `是否仍要继续删除？（不推荐）`
                    );
                    if (!proceed) {
                        console.log('❌ 用户取消操作（数据冲突）');
                        return;
                    }
                }
                
                // 💾 创建数据备份
                console.log('💾 创建数据备份...');
                const deletedRecords = recordKeysToDelete.map(key => {
                    // 如果是数字键，转换为数字索引
                    const idx = parseInt(key);
                    return isNaN(idx) ? null : deleteData.attendanceRecords[idx];
                }).filter(r => r !== null);
                const backupData = {
                    timestamp: new Date().toISOString(),
                    timestampMs: Date.now(),
                    operation: 'delete_attendance_records',
                    recordCount: recordKeysToDelete.length,
                    deletedRecords: deletedRecords,
                    recordKeys: recordKeysToDelete
                };
                try {
                    await window.db.ref(`backups/attendanceRecords/${Date.now()}`).set(backupData);
                    console.log('✅ 数据备份已创建');
                } catch (backupError) {
                    console.warn('⚠️ 数据备份创建失败（权限不足）:', backupError.message);
                }
                
                // 重新读取Firebase最新数据
                console.log('📡 重新读取Firebase全部最新数据...');
                const allRecordsSnapshot = await window.db.ref('attendanceRecords').once('value');
                const allRecordsRaw = allRecordsSnapshot.val() || [];
                
                // 计算记录总数（支持数组和对象格式）
                const totalRecordCount = Array.isArray(allRecordsRaw) 
                    ? allRecordsRaw.filter(r => r !== null && r !== undefined).length
                    : (typeof allRecordsRaw === 'object' ? Object.keys(allRecordsRaw).length : 0);
                
                // 数据量验证
                console.log('🔍 删除前数据验证:');
                console.log(`  - Firebase当前记录总数: ${totalRecordCount}`);
                console.log(`  - 要删除的记录数: ${recordKeysToDelete.length}`);
                console.log(`  - 删除后应保留记录数: ${totalRecordCount - recordKeysToDelete.length}`);
                
                // 🚨 安全检查：删除后至少应该有大量历史数据
                const expectedCount = totalRecordCount - recordKeysToDelete.length;
                if (expectedCount < 400) {
                    const proceed = confirm(
                        `⚠️ 数据安全警告\n\n` +
                        `删除后将只剩 ${expectedCount} 条记录\n` +
                        `这似乎不正常（历史数据应该有几百条）\n\n` +
                        `是否继续？（建议取消，检查数据）`
                    );
                    if (!proceed) {
                        console.log('❌ 用户取消操作（数据量异常保护）');
                        return;
                    }
                }
                
                // 创建增强数据备份
                console.log('💾 创建增强数据备份...');
                const enhancedDeletedRecords = recordKeysToDelete.map(key => {
                    // 如果是数组格式，key是索引；如果是对象格式，key是键名
                    if (Array.isArray(allRecordsRaw)) {
                        const idx = parseInt(key);
                        return isNaN(idx) ? null : allRecordsRaw[idx];
                    } else {
                        return allRecordsRaw[key];
                    }
                }).filter(r => r !== null && r !== undefined);
                
                const enhancedBackupData = {
                    timestamp: new Date().toISOString(),
                    timestampMs: Date.now(),
                    operation: 'delete_attendance_records',
                    beforeDelete: {
                        totalCount: totalRecordCount,
                        recordsToDelete: recordKeysToDelete.length,
                        expectedAfterCount: expectedCount
                    },
                    deletedRecords: enhancedDeletedRecords,
                    recordKeys: recordKeysToDelete
                };
                
                // 保存到localStorage作为紧急备份
                const emergencyBackupKey = `emergency_backup_${Date.now()}`;
                localStorage.setItem(emergencyBackupKey, JSON.stringify(allRecordsRaw));
                console.log(`✅ 紧急备份已保存到localStorage (key: ${emergencyBackupKey})`);
                
                // 尝试保存到Firebase backup节点
                try {
                    await window.db.ref(`backups/enhanced_delete/${Date.now()}`).set(enhancedBackupData);
                    console.log('✅ 增强备份已保存到Firebase');
                } catch (backupError) {
                    console.warn('⚠️ Firebase备份失败（权限不足），但localStorage备份已完成');
                }
                
                // 执行删除操作（使用update增量更新，而非set覆盖）
                console.log('🗑️ 执行删除操作（使用增量更新）...');
                
                // 创建更新对象：将要删除的键设置为null
                const updates = {};
                recordKeysToDelete.forEach(key => {
                    updates[key] = null; // 删除该键的记录
                });
                
                console.log('🔍 删除操作详情:', { 
                    keysToDelete: recordKeysToDelete, 
                    updateCount: Object.keys(updates).length 
                });
                
                // 使用update而非set，确保只删除指定记录
                await window.db.ref('attendanceRecords').update(updates);
                console.log('✅ Firebase删除操作完成');
                
                // 重新读取验证删除结果
                const verifySnapshot = await window.db.ref('attendanceRecords').once('value');
                let finalRecords = verifySnapshot.val() || [];
                
                // 清理null值和undefined（update操作可能留下null）
                finalRecords = Array.isArray(finalRecords) 
                    ? finalRecords.filter(r => r !== null && r !== undefined)
                    : Object.values(finalRecords).filter(r => r !== null && r !== undefined);
                
                console.log('🔍 删除后数据验证:');
                console.log(`  - 删除后实际记录数: ${finalRecords.length}`);
                console.log(`  - 预期记录数: ${expectedCount}`);
                
                // 🚨 数据完整性验证
                if (Math.abs(finalRecords.length - expectedCount) > 5) {
                    throw new Error(
                        `删除后数据量异常！\n` +
                        `预期: ${expectedCount}条\n` +
                        `实际: ${finalRecords.length}条\n` +
                        `差异: ${Math.abs(finalRecords.length - expectedCount)}条\n` +
                        `紧急备份key: ${emergencyBackupKey}`
                    );
                }
                
                console.log('✅ 数据完整性验证通过');
                
                // 更新本地数据和缓存
                deleteData.attendanceRecords = finalRecords;
                localStorage.setItem('msh_attendanceRecords', JSON.stringify(finalRecords));
                console.log('✅ 本地存储已更新');
                
                // 清除相关日期的缓存
                const deletedDates = new Set(
                    enhancedDeletedRecords
                        .filter(r => r && r.time)
                        .map(r => new Date(r.time).toISOString().split('T')[0])
                );
                deletedDates.forEach(date => {
                    sessionStorage.removeItem(`attendance_${date}`);
                    console.log(`🗑️ 已清除 ${date} 的sessionStorage缓存`);
                });
                
                // 更新全局变量
                if (window.attendanceRecords) {
                    window.attendanceRecords = finalRecords;
                }
                
                // 如果使用NewDataManager，同步更新其状态
                if (window.NewDataManager && window.NewDataManager.updateAttendanceRecords) {
                    window.NewDataManager.updateAttendanceRecords(finalRecords);
                    console.log('✅ NewDataManager状态已同步');
                }
                
                // 记录操作到Firebase（可选，如果有权限）
                try {
                    await logOperationToFirebase('delete_attendance_records', {
                        recordCount: recordKeysToDelete.length,
                        timestamp: new Date().toISOString(),
                        deletedKeys: recordKeysToDelete
                    });
                } catch (logError) {
                    console.warn('⚠️ 操作日志记录失败（权限不足）');
                }
                
                deleteLog(`✅ 成功删除 ${recordKeysToDelete.length} 条签到记录`, 'success');
                console.log(`✅ 删除操作完成！删除了 ${recordKeysToDelete.length} 条记录`);
                
                // 刷新显示
                const dateInput = document.getElementById('deleteDate');
                if (dateInput && dateInput.value) {
                    await loadMemberRecords(); // 重新加载以更新显示
                }
                alert(`删除成功！\n\n已删除 ${recordKeysToDelete.length} 条签到记录`);
                
            } catch (error) {
                console.error('❌ 删除签到记录失败:', error);
                deleteLog(`❌ 删除失败: ${error.message}`, 'error');
                alert(`删除失败: ${error.message}`);
            }
        }
        
        // 删除人员
        async function deleteMember() {
            const memberSelect = document.getElementById('deleteMemberSelect');
            if (!memberSelect || !memberSelect.value) {
                alert('请先选择要删除的人员');
                return;
            }
            
            try {
                const member = JSON.parse(memberSelect.value);
                const groupKey = document.getElementById('deleteGroupSelect').value;
                
                // 计算要删除的记录数
                const recordsToDelete = deleteData.attendanceRecords.filter(r => 
                    r.name === member.name && r.uuid === member.uuid
                ).length;
                
                // 确认删除
                if (!confirm(
                    `确定要删除人员 "${member.name}" 吗？\n\n` +
                    `此操作将同时删除：\n` +
                    `- 该人员的所有签到记录（${recordsToDelete}条）\n\n` +
                    `此操作不可撤销！`
                )) {
                    return;
                }
                
                deleteLog(`开始删除人员: ${member.name}...`);
                deleteLog(`该人员有 ${recordsToDelete} 条签到记录`, 'info');
                
                const db = firebase.database();
                
                // 🚨 并发检测：重新读取Firebase最新数据
                const latestSnapshot = await db.ref('attendanceRecords').once('value');
                const latestRecords = latestSnapshot.val() || [];
                const latestCount = Array.isArray(latestRecords) 
                    ? latestRecords.filter(r => r !== null && r !== undefined).length
                    : (typeof latestRecords === 'object' ? Object.keys(latestRecords).length : 0);
                
                if (latestCount !== deleteData.attendanceRecords.length) {
                    const proceed = confirm(
                        `⚠️ 数据并发冲突检测\n\n` +
                        `页面加载时记录数: ${deleteData.attendanceRecords.length}\n` +
                        `当前最新记录数: ${latestCount}\n\n` +
                        `数据已被其他用户修改！建议刷新页面后重试。\n\n` +
                        `是否仍要继续？（不推荐）`
                    );
                    if (!proceed) {
                        deleteLog('❌ 用户取消操作（数据冲突）', 'warning');
                        return;
                    }
                }
                
                // 从小组中删除成员
                const groupMembers = deleteData.groups[groupKey] || [];
                const updatedMembers = groupMembers.filter(m => 
                    !(m.name === member.name && m.uuid === member.uuid)
                );
                
                await db.ref(`groups/${groupKey}`).set(updatedMembers);
                deleteLog(`已从小组中删除人员`, 'success');
                
                // 删除该人员的所有签到记录
                const beforeCount = deleteData.attendanceRecords.length;
                const updatedRecords = deleteData.attendanceRecords.filter(r => 
                    !(r.name === member.name && r.uuid === member.uuid)
                );
                const afterCount = updatedRecords.length;
                const actualDeleted = beforeCount - afterCount;
                
                // 🚨 数据量安全检查
                if (afterCount < 400) {
                    const proceed = confirm(
                        `⚠️ 数据安全警告\n\n` +
                        `删除后将只剩 ${afterCount} 条记录\n` +
                        `这似乎不正常（历史数据应该有几百条）\n\n` +
                        `是否继续？（建议取消，检查数据）`
                    );
                    if (!proceed) {
                        deleteLog('❌ 用户取消操作（数据量异常保护）', 'warning');
                        return;
                    }
                }
                
                // 💾 创建备份
                const backupData = {
                    timestamp: new Date().toISOString(),
                    operation: 'delete_member',
                    memberName: member.name,
                    memberUUID: member.uuid,
                    recordsDeleted: actualDeleted,
                    beforeCount: beforeCount,
                    afterCount: afterCount
                };
                localStorage.setItem(`backup_delete_member_${Date.now()}`, JSON.stringify(backupData));
                deleteLog(`已创建本地备份`, 'success');
                
                // 执行删除（使用set覆盖，因为已加载全量数据）
                await db.ref('attendanceRecords').set(updatedRecords);
                deleteLog(`已删除 ${actualDeleted} 条签到记录`, 'success');
                
                // 更新本地数据
                deleteData.groups[groupKey] = updatedMembers;
                deleteData.attendanceRecords = updatedRecords;
                
                // 刷新UI
                updateGroupSelects();
                loadMembers();
                
                alert(`人员 "${member.name}" 已成功删除\n删除了 ${actualDeleted} 条签到记录`);
                deleteLog(`✅ 人员删除完成`, 'success');
                
            } catch (error) {
                deleteLog(`删除人员失败: ${error.message}`, 'error');
                alert(`删除失败: ${error.message}`);
            }
        }
        
        // 删除小组
        async function deleteGroup() {
            const groupSelect2 = document.getElementById('deleteGroupSelect2');
            if (!groupSelect2 || !groupSelect2.value) {
                alert('请先选择要删除的小组');
                return;
            }
            
            try {
                const groupKey = groupSelect2.value;
                const groupName = deleteData.groupNames[groupKey];
                const members = deleteData.groups[groupKey] || [];
                const memberCount = members.length;
                const memberUUIDs = members.map(m => m.uuid);
                
                // 计算要删除的记录数
                const recordsToDelete = deleteData.attendanceRecords.filter(r => 
                    memberUUIDs.includes(r.uuid)
                ).length;
                
                // 确认删除
                if (!confirm(
                    `确定要删除小组 "${groupName}" 吗？\n\n` +
                    `该小组有 ${memberCount} 个成员\n` +
                    `此操作将同时删除：\n` +
                    `- 小组本身\n` +
                    `- 所有成员（${memberCount}人）\n` +
                    `- 所有成员的签到记录（${recordsToDelete}条）\n\n` +
                    `此操作不可撤销！`
                )) {
                    return;
                }
                
                deleteLog(`开始删除小组: ${groupName}...`);
                deleteLog(`小组有 ${memberCount} 个成员，${recordsToDelete} 条签到记录`, 'info');
                
                const db = firebase.database();
                
                // 🚨 并发检测：重新读取Firebase最新数据
                const latestSnapshot = await db.ref('attendanceRecords').once('value');
                const latestRecords = latestSnapshot.val() || [];
                const latestCount = Array.isArray(latestRecords) 
                    ? latestRecords.filter(r => r !== null && r !== undefined).length
                    : (typeof latestRecords === 'object' ? Object.keys(latestRecords).length : 0);
                
                if (latestCount !== deleteData.attendanceRecords.length) {
                    const proceed = confirm(
                        `⚠️ 数据并发冲突检测\n\n` +
                        `页面加载时记录数: ${deleteData.attendanceRecords.length}\n` +
                        `当前最新记录数: ${latestCount}\n\n` +
                        `数据已被其他用户修改！建议刷新页面后重试。\n\n` +
                        `是否仍要继续？（不推荐）`
                    );
                    if (!proceed) {
                        deleteLog('❌ 用户取消操作（数据冲突）', 'warning');
                        return;
                    }
                }
                
                // 删除小组
                await db.ref(`groups/${groupKey}`).remove();
                deleteLog(`已删除小组数据`, 'success');
                
                // 删除小组名称
                await db.ref(`groupNames/${groupKey}`).remove();
                deleteLog(`已删除小组名称`, 'success');
                
                // 删除该小组所有成员的签到记录
                const beforeCount = deleteData.attendanceRecords.length;
                const updatedRecords = deleteData.attendanceRecords.filter(r => 
                    !memberUUIDs.includes(r.uuid)
                );
                const afterCount = updatedRecords.length;
                const actualDeleted = beforeCount - afterCount;
                
                // 🚨 数据量安全检查
                if (afterCount < 400) {
                    const proceed = confirm(
                        `⚠️ 数据安全警告\n\n` +
                        `删除后将只剩 ${afterCount} 条记录\n` +
                        `这似乎不正常（历史数据应该有几百条）\n\n` +
                        `是否继续？（建议取消，检查数据）`
                    );
                    if (!proceed) {
                        deleteLog('❌ 用户取消操作（数据量异常保护）', 'warning');
                        return;
                    }
                }
                
                // 💾 创建备份
                const backupData = {
                    timestamp: new Date().toISOString(),
                    operation: 'delete_group',
                    groupKey: groupKey,
                    groupName: groupName,
                    memberCount: memberCount,
                    recordsDeleted: actualDeleted,
                    beforeCount: beforeCount,
                    afterCount: afterCount,
                    memberUUIDs: memberUUIDs
                };
                localStorage.setItem(`backup_delete_group_${Date.now()}`, JSON.stringify(backupData));
                deleteLog(`已创建本地备份`, 'success');
                
                // 执行删除（使用set覆盖，因为已加载全量数据）
                await db.ref('attendanceRecords').set(updatedRecords);
                deleteLog(`已删除 ${actualDeleted} 条签到记录`, 'success');
                
                // 更新本地数据
                delete deleteData.groups[groupKey];
                delete deleteData.groupNames[groupKey];
                deleteData.attendanceRecords = updatedRecords;
                
                // 刷新UI
                updateGroupSelects();
                
                alert(`小组 "${groupName}" 已成功删除\n删除了 ${memberCount} 个成员和 ${actualDeleted} 条签到记录`);
                deleteLog(`✅ 小组删除完成`, 'success');
                
            } catch (error) {
                deleteLog(`删除小组失败: ${error.message}`, 'error');
                alert(`删除失败: ${error.message}`);
            }
        }
        
        // 批量清理
        async function batchCleanup() {
            const cleanupDays = parseInt(document.getElementById('cleanupDays').value);
            const cleanupType = document.getElementById('cleanupType').value;
            
            // 计算截止日期
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - cleanupDays);
            const cutoffTime = cutoffDate.getTime();
            
            // 确认清理
            if (!confirm(
                `确定要清理 ${cleanupDays} 天前的数据吗？\n\n` +
                `清理类型: ${cleanupType === 'attendance' ? '仅签到记录' : '所有数据'}\n` +
                `截止日期: ${cutoffDate.toLocaleDateString('zh-CN')}\n\n` +
                `此操作不可撤销！`
            )) {
                return;
            }
            
            try {
                deleteLog(`开始批量清理 ${cleanupDays} 天前的数据...`);
                
                const db = firebase.database();
                
                if (cleanupType === 'attendance') {
                    // 只清理签到记录
                    const filteredRecords = deleteData.attendanceRecords.filter(r => {
                        if (!r || !r.time) return true; // 保留无效记录
                        return new Date(r.time).getTime() >= cutoffTime;
                    });
                    
                    const removedCount = deleteData.attendanceRecords.length - filteredRecords.length;
                    
                    await db.ref('attendanceRecords').set(filteredRecords);
                    deleteData.attendanceRecords = filteredRecords;
                    
                    deleteLog(`✅ 清理完成，删除了 ${removedCount} 条签到记录`, 'success');
                    alert(`清理成功！\n删除了 ${removedCount} 条签到记录`);
                    
                } else {
                    // 清理所有数据（谨慎使用）
                    alert('此功能需要更高级的权限，请联系系统管理员');
                }
                
                // 刷新显示
                loadAttendanceRecords();
                
            } catch (error) {
                deleteLog(`批量清理失败: ${error.message}`, 'error');
                alert(`清理失败: ${error.message}`);
            }
        }
        
        // 记录操作到Firebase
        async function logOperationToFirebase(operation, details) {
            try {
                const db = firebase.database();
                const logEntry = {
                    operation,
                    details,
                    timestamp: new Date().toISOString(),
                    timestampMs: Date.now()
                };
                
                await db.ref(`operationLogs/${Date.now()}`).set(logEntry);
            } catch (error) {
                // 静默失败，不影响主要操作
                console.warn('操作日志记录失败:', error);
            }
        }
        
        // 日志输出函数
        function deleteLog(message, type = 'info') {
            const logContainer = document.getElementById('deleteLogContainer');
            if (!logContainer) return;
            
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // 同时输出到控制台
            const consoleMethod = type === 'error' ? 'error' : type === 'warning' ? 'warn' : 'log';
            console[consoleMethod](`[删除管理] ${message}`);
        }
        
        // 清空日志
        function clearDeleteLog() {
            const logContainer = document.getElementById('deleteLogContainer');
            if (logContainer) {
                logContainer.innerHTML = '<div class="log-entry info">日志已清空</div>';
            }
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', async function() {
            deleteLog('删除管理工具加载中...');
            
            // 确保Firebase已初始化
            if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                deleteLog('Firebase已初始化', 'success');
                if (!window.db) {
                    window.db = firebase.database();
                }
                await loadDeleteData();
            } else {
                deleteLog('Firebase未初始化，请刷新页面重试', 'error');
            }
        });
    </script>
</body>
</html>

