<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSHæ•°æ®åˆ é™¤ç®¡ç†å·¥å…·</title>
    <link rel="stylesheet" href="../../src/style.css">
    <link rel="stylesheet" href="conflict-tools-shared.css">
</head>
<body>
    <div class="conflict-manager-container">
        <!-- ç®¡ç†å‘˜è­¦å‘Šæ¨ªå¹… -->
        <div class="admin-warning-banner">
            <h2>
                <span class="warning-icon">ğŸš¨</span>
                ç®¡ç†å‘˜ä¸“ç”¨å·¥å…· - é«˜é£é™©æ“ä½œåŒº
            </h2>
            <p><strong>âš ï¸ è­¦å‘Šï¼šæ­¤é¡µé¢ä»…ä¾›ç³»ç»Ÿç®¡ç†å‘˜ä½¿ç”¨ï¼</strong></p>
            <p>æœ¬é¡µé¢åŒ…å«ä»¥ä¸‹é«˜é£é™©æ“ä½œï¼š</p>
            <ul>
                <li>ğŸ—‘ï¸ <strong>æ°¸ä¹…åˆ é™¤</strong>å°ç»„ã€æˆå‘˜ã€ç­¾åˆ°è®°å½•</li>
                <li>ğŸ§¹ <strong>æ‰¹é‡æ¸…ç†</strong>å†å²æ•°æ®</li>
            </ul>
            <p><strong>æ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¸å¯æ’¤é”€çš„ï¼</strong>è¯·ç¡®ä¿æ‚¨ï¼š</p>
            <ul>
                <li>âœ… å·²å¤‡ä»½é‡è¦æ•°æ®</li>
                <li>âœ… å®Œå…¨ç†è§£æ¯ä¸ªæ“ä½œçš„å½±å“</li>
                <li>âœ… æœ‰æƒé™æ‰§è¡Œè¿™äº›æ“ä½œ</li>
            </ul>
        </div>
        
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="conflict-manager-header">
            <h1>ğŸ—‘ï¸ MSHæ•°æ®åˆ é™¤ç®¡ç†</h1>
            <p>ç®¡ç†å’Œåˆ é™¤ç³»ç»Ÿæ•°æ®</p>
        </div>
        
        <!-- è¿”å›æŒ‰é’® -->
        <div class="back-button-container">
            <button class="back-button" onclick="goBack()">
                â† è¿”å›ç®¡ç†é¡µé¢
            </button>
        </div>
        
        <div class="warning-banner">
            <span class="icon">âš ï¸</span>
            <strong>è­¦å‘Šï¼š</strong>æ‰€æœ‰åˆ é™¤æ“ä½œéƒ½æ˜¯ä¸å¯æ’¤é”€çš„ï¼Œè¯·ç¡®ä¿æ‚¨çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆï¼
        </div>
        
        <!-- åˆ é™¤äººå‘˜ -->
        <div class="delete-section">
            <h3><span class="icon">ğŸ‘¤</span>åˆ é™¤äººå‘˜</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="deleteGroupSelect">é€‰æ‹©å°ç»„</label>
                    <select id="deleteGroupSelect" onchange="loadMembers()">
                        <option value="">--è¯·é€‰æ‹©å°ç»„--</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deleteMemberSelect">é€‰æ‹©äººå‘˜</label>
                    <select id="deleteMemberSelect">
                        <option value="">--è¯·å…ˆé€‰æ‹©å°ç»„--</option>
                    </select>
                </div>
            </div>
            <button class="delete-button" onclick="deleteMember()" id="deleteMemberBtn" disabled>
                åˆ é™¤é€‰ä¸­äººå‘˜
            </button>
        </div>
        
        <!-- åˆ é™¤ç­¾åˆ°è®°å½• -->
        <div class="delete-section">
            <h3><span class="icon">ğŸ“</span>åˆ é™¤ç­¾åˆ°è®°å½•</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="deleteDate">é€‰æ‹©æ—¥æœŸï¼š</label>
                    <input type="date" id="deleteDate" onchange="loadMemberRecords()" class="date-input">
                </div>
                <div class="form-group">
                    <label for="deleteMemberName">é€‰æ‹©äººå‘˜ï¼š</label>
                    <select id="deleteMemberName" class="form-control" onchange="loadAttendanceRecords()">
                        <option value="">--è¯·é€‰æ‹©äººå‘˜--</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="deleteRecordSelect">é€‰æ‹©è¦åˆ é™¤çš„ç­¾åˆ°è®°å½•ï¼ˆå¯å¤šé€‰ï¼‰</label>
                <select id="deleteRecordSelect" multiple size="5" class="multi-select" onchange="checkRecordSelection()">
                    <option value="">--è¯·å…ˆé€‰æ‹©æ—¥æœŸ--</option>
                </select>
                <div class="multi-select-controls">
                    <button type="button" onclick="selectAllRecords()" class="btn btn-warning select-all-btn">å…¨é€‰</button>
                    <button type="button" onclick="clearAllRecords()" class="btn btn-secondary">æ¸…ç©ºé€‰æ‹©</button>
                </div>
            </div>
            <button class="delete-button" onclick="deleteSelectedAttendanceRecords()" id="deleteSelectedRecordsBtn" disabled>
                åˆ é™¤é€‰ä¸­çš„ç­¾åˆ°è®°å½•
            </button>
        </div>
        
        <!-- åˆ é™¤å°ç»„ -->
        <div class="delete-section">
            <h3><span class="icon">ğŸ¢</span>åˆ é™¤å°ç»„</h3>
            <div class="form-group">
                <label for="deleteGroupSelect2">é€‰æ‹©è¦åˆ é™¤çš„å°ç»„</label>
                <select id="deleteGroupSelect2">
                    <option value="">--è¯·é€‰æ‹©å°ç»„--</option>
                </select>
            </div>
            <button class="delete-button" onclick="deleteGroup()" id="deleteGroupBtn" disabled>
                åˆ é™¤é€‰ä¸­å°ç»„
            </button>
        </div>
        
        <!-- æ‰¹é‡æ¸…ç† -->
        <div class="delete-section">
            <h3><span class="icon">ğŸ§¹</span>æ‰¹é‡æ¸…ç†</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="cleanupDays">æ¸…ç†å¤šå°‘å¤©å‰çš„ç­¾åˆ°è®°å½•</label>
                    <select id="cleanupDays">
                        <option value="30">30å¤©å‰</option>
                        <option value="60">60å¤©å‰</option>
                        <option value="90">90å¤©å‰</option>
                        <option value="180">180å¤©å‰</option>
                        <option value="365">365å¤©å‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cleanupType">æ¸…ç†ç±»å‹</label>
                    <select id="cleanupType">
                        <option value="attendance">ç­¾åˆ°è®°å½•</option>
                        <option value="all">æ‰€æœ‰æ•°æ®</option>
                    </select>
                </div>
            </div>
            <button class="delete-button" onclick="batchCleanup()" id="cleanupBtn">
                æ‰§è¡Œæ‰¹é‡æ¸…ç†
            </button>
        </div>
        
        <!-- æ“ä½œæ—¥å¿— -->
        <div class="log-section">
            <h3>ğŸ“‹ æ“ä½œæ—¥å¿—</h3>
            <div class="log-container" id="deleteLogContainer">
                <div class="log-entry info">ç­‰å¾…æ“ä½œ...</div>
            </div>
            <button class="btn btn-warning clear-log" onclick="clearDeleteLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="../../src/smart-config-loader.js"></script>
    <script src="../../src/core/firebase-utils.js"></script>
  <script src="../../src/core/time-utils.js"></script>
  <script src="../../src/core/security-utils.js"></script>
  <script src="../../src/data/uuid-manager.js"></script>
  <script src="../../src/features/sunday-tracking-utils.js"></script>
  <script src="../../src/data/sync-managers.js"></script>
  <script src="../../src/utils.js"></script>
    <script src="../../src/new-data-manager.js"></script>
    
    <script>
        // åˆå§‹åŒ–Firebase
        if (typeof firebase !== 'undefined' && !firebase.apps.length && window.firebaseConfig) {
            try {
                firebase.initializeApp(window.firebaseConfig);
                console.log('âœ… Firebaseåˆå§‹åŒ–æˆåŠŸ');
                window.db = firebase.database();
            } catch (error) {
                console.error('âŒ Firebaseåˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
        
        // æ•°æ®åˆ é™¤ç®¡ç†ç³»ç»Ÿçš„JavaScriptåŠŸèƒ½
        let deleteData = {
            groups: {},
            groupNames: {},
            attendanceRecords: []
        };
        
        // è¿”å›ç®¡ç†é¡µé¢
        function goBack() {
            console.log('ğŸ”™ è¿”å›ç®¡ç†é¡µé¢');
            window.location.href = '../../admin.html';
        }
        
        // åŠ è½½åˆ é™¤ç®¡ç†æ•°æ®
        async function loadDeleteData() {
            try {
                deleteLog('å¼€å§‹åŠ è½½åˆ é™¤ç®¡ç†æ•°æ®...');
                
                // åŠ è½½Firebaseæ•°æ®ï¼ˆä¸åŠ è½½å…¨éƒ¨ç­¾åˆ°è®°å½•ï¼ŒæŒ‰éœ€åŠ è½½ï¼‰
                const db = firebase.database();
                deleteData.groups = await db.ref('groups').once('value').then(snapshot => snapshot.val() || {});
                deleteData.groupNames = await db.ref('groupNames').once('value').then(snapshot => snapshot.val() || {});
                // âš ï¸ ä¸å†åˆå§‹åŒ–æ—¶åŠ è½½å…¨éƒ¨attendanceRecordsï¼Œæ”¹ä¸ºæŒ‰éœ€åŠ è½½
                deleteData.attendanceRecords = [];
                
                // æ›´æ–°UI
                updateGroupSelects();
                updateDeleteDate();
                
                deleteLog('åˆ é™¤ç®¡ç†æ•°æ®åŠ è½½å®Œæˆï¼ˆç­¾åˆ°è®°å½•å°†æŒ‰éœ€åŠ è½½ï¼‰', 'success');
                
            } catch (error) {
                deleteLog(`åŠ è½½åˆ é™¤ç®¡ç†æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ›´æ–°å°ç»„é€‰æ‹©å™¨
        function updateGroupSelects() {
            const groupSelect1 = document.getElementById('deleteGroupSelect');
            const groupSelect2 = document.getElementById('deleteGroupSelect2');
            
            if (!groupSelect1 || !groupSelect2) return;
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            groupSelect1.innerHTML = '<option value="">--è¯·é€‰æ‹©å°ç»„--</option>';
            groupSelect2.innerHTML = '<option value="">--è¯·é€‰æ‹©å°ç»„--</option>';
            
            // æ·»åŠ æ‰€æœ‰å°ç»„é€‰é¡¹
            Object.keys(deleteData.groups).forEach(groupKey => {
                const groupName = deleteData.groupNames[groupKey] || groupKey;
                const memberCount = deleteData.groups[groupKey] ? deleteData.groups[groupKey].length : 0;
                
                const option1 = new Option(`${groupName} (${memberCount}äºº)`, groupKey);
                const option2 = new Option(`${groupName} (${memberCount}äºº)`, groupKey);
                
                groupSelect1.add(option1);
                groupSelect2.add(option2);
            });
        }
        
        // æ›´æ–°åˆ é™¤æ—¥æœŸä¸ºä»Šå¤©
        function updateDeleteDate() {
            const dateInput = document.getElementById('deleteDate');
            if (dateInput) {
                // ä¸è®¾ç½®é»˜è®¤æ—¥æœŸï¼Œè®©ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©
                dateInput.value = '';
            }
        }
        
        // åŠ è½½æˆå‘˜åˆ—è¡¨
        function loadMembers() {
            const groupSelect = document.getElementById('deleteGroupSelect');
            const memberSelect = document.getElementById('deleteMemberSelect');
            const deleteBtn = document.getElementById('deleteMemberBtn');
            
            if (!groupSelect || !memberSelect) return;
            
            const selectedGroup = groupSelect.value;
            
            // æ¸…ç©ºæˆå‘˜é€‰æ‹©å™¨
            memberSelect.innerHTML = '<option value="">--è¯·é€‰æ‹©äººå‘˜--</option>';
            deleteBtn.disabled = true;
            
            if (!selectedGroup) return;
            
            // åŠ è½½é€‰ä¸­å°ç»„çš„æˆå‘˜
            const members = deleteData.groups[selectedGroup] || [];
            members.forEach(member => {
                const option = new Option(
                    `${member.name} (${member.source || 'æœªçŸ¥æ¥æº'})`,
                    JSON.stringify(member)
                );
                memberSelect.add(option);
            });
            
            // å¯ç”¨åˆ é™¤æŒ‰é’®é€‰æ‹©ç›‘å¬
            memberSelect.onchange = function() {
                deleteBtn.disabled = !this.value;
            };
        }
        
        // åŠ è½½æŒ‡å®šæ—¥æœŸçš„ç­¾åˆ°è®°å½•ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰
        async function loadMemberRecords() {
            const dateInput = document.getElementById('deleteDate');
            const deleteMemberName = document.getElementById('deleteMemberName');
            const recordSelect = document.getElementById('deleteRecordSelect');
            
            if (!dateInput || !deleteMemberName || !recordSelect) return;
            
            const selectedDate = dateInput.value;
            
            // æ¸…ç©ºäººå‘˜åˆ—è¡¨å’Œè®°å½•åˆ—è¡¨
            deleteMemberName.innerHTML = '<option value="">--è¯·é€‰æ‹©äººå‘˜--</option>';
            recordSelect.innerHTML = '';
            
            if (!selectedDate) {
                deleteLog('è¯·å…ˆé€‰æ‹©æ—¥æœŸ', 'warning');
                recordSelect.innerHTML = '<option value="">--è¯·å…ˆé€‰æ‹©æ—¥æœŸ--</option>';
                deleteData.attendanceRecords = [];
                return;
            }
            
            try {
                deleteLog(`æ­£åœ¨åŠ è½½ ${selectedDate} çš„ç­¾åˆ°è®°å½•...`, 'info');
                
                // ä»FirebaseåŠ è½½è¯¥æ—¥æœŸçš„æ‰€æœ‰ç­¾åˆ°è®°å½•
                const db = firebase.database();
                const snapshot = await db.ref('attendanceRecords').once('value');
                const rawData = snapshot.val();
                
                if (!rawData) {
                    deleteLog(`${selectedDate} Firebaseä¸­æ²¡æœ‰æ•°æ®`, 'warning');
                    recordSelect.innerHTML = '<option value="">Firebaseä¸­æ²¡æœ‰ç­¾åˆ°è®°å½•</option>';
                    deleteData.attendanceRecords = [];
                    deleteData.currentDateRecords = [];
                    return;
                }
                
                // å¤„ç†Firebaseæ•°æ®æ ¼å¼ï¼ˆå¯èƒ½æ˜¯æ•°ç»„æˆ–å¯¹è±¡ï¼‰
                let allRecords = [];
                let recordKeys = {}; // ä¿å­˜æ¯æ¡è®°å½•çš„Firebaseé”®
                
                if (Array.isArray(rawData)) {
                    // æ•°ç»„æ ¼å¼ï¼šä¿å­˜ç´¢å¼•ä½œä¸ºé”®
                    rawData.forEach((r, index) => {
                        if (r !== null && r !== undefined) {
                            allRecords.push(r);
                            recordKeys[JSON.stringify(r)] = index;
                        }
                    });
                    deleteLog(`ä»FirebaseåŠ è½½æ•°ç»„æ ¼å¼: ${allRecords.length} æ¡è®°å½•`, 'info');
                } else if (typeof rawData === 'object') {
                    // å¯¹è±¡æ ¼å¼ï¼šä¿å­˜é”®å
                    Object.entries(rawData).forEach(([key, r]) => {
                        if (r !== null && r !== undefined) {
                            allRecords.push(r);
                            recordKeys[JSON.stringify(r)] = key;
                        }
                    });
                    deleteLog(`ä»FirebaseåŠ è½½å¯¹è±¡æ ¼å¼ï¼Œè½¬æ¢ä¸ºæ•°ç»„: ${allRecords.length} æ¡è®°å½•`, 'info');
                }
                
                // ç­›é€‰å‡ºè¯¥æ—¥æœŸçš„è®°å½•
                const dateRecords = allRecords.filter(r => {
                    if (!r || !r.time) return false;
                    const recordDate = new Date(r.time).toISOString().split('T')[0];
                    return recordDate === selectedDate;
                });
                
                // ä¿å­˜åˆ°deleteData
                deleteData.attendanceRecords = allRecords; // ä¿å­˜å…¨éƒ¨è®°å½•ç”¨äºåç»­åˆ é™¤æ“ä½œ
                deleteData.recordKeys = recordKeys; // ä¿å­˜è®°å½•çš„Firebaseé”®æ˜ å°„
                deleteData.currentDateRecords = dateRecords; // ä¿å­˜å½“å¤©è®°å½•ç”¨äºæ˜¾ç¤º
                deleteData.isObjectFormat = typeof rawData === 'object' && !Array.isArray(rawData); // æ ‡è®°æ ¼å¼ç±»å‹
                
                if (dateRecords.length === 0) {
                    deleteLog(`${selectedDate} æ²¡æœ‰ç­¾åˆ°è®°å½•`, 'warning');
                    recordSelect.innerHTML = '<option value="">è¯¥æ—¥æœŸæ²¡æœ‰ç­¾åˆ°è®°å½•</option>';
                    return;
                }
                
                deleteLog(`æˆåŠŸåŠ è½½ ${dateRecords.length} æ¡ç­¾åˆ°è®°å½•`, 'success');
                
                // æ”¶é›†è¯¥æ—¥æœŸå†…æœ‰ç­¾åˆ°çš„å”¯ä¸€äººå‘˜åå­—
                const uniqueNames = [...new Set(dateRecords
                    .filter(r => r && r.name)
                    .map(r => r.name))];
                
                // æŒ‰æ‹¼éŸ³æ’åº
                uniqueNames.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
                
                // æ·»åŠ åˆ°äººå‘˜ä¸‹æ‹‰åˆ—è¡¨
                uniqueNames.forEach(name => {
                    const option = new Option(name, name);
                    deleteMemberName.add(option);
                });
                
                deleteLog(`æ‰¾åˆ° ${uniqueNames.length} ä¸ªæœ‰ç­¾åˆ°è®°å½•çš„äººå‘˜`, 'info');
                
                // åŠ è½½ç­¾åˆ°è®°å½•æ˜¾ç¤º
                loadAttendanceRecords();
                
            } catch (error) {
                deleteLog(`åŠ è½½ç­¾åˆ°è®°å½•å¤±è´¥: ${error.message}`, 'error');
                recordSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</option>';
            }
        }
        
        // åŠ è½½ç­¾åˆ°è®°å½•æ˜¾ç¤º
        function loadAttendanceRecords() {
            const memberNameSelect = document.getElementById('deleteMemberName');
            const recordSelect = document.getElementById('deleteRecordSelect');
            
            if (!recordSelect) return;
            
            const selectedName = memberNameSelect ? memberNameSelect.value : '';
            
            // æ¸…ç©ºè®°å½•é€‰æ‹©å™¨
            recordSelect.innerHTML = '';
            
            // ä½¿ç”¨å·²åŠ è½½çš„å½“å¤©è®°å½•
            if (!deleteData.currentDateRecords || deleteData.currentDateRecords.length === 0) {
                recordSelect.innerHTML = '<option value="">--è¯·å…ˆé€‰æ‹©æ—¥æœŸ--</option>';
                return;
            }
            
            // æ ¹æ®é€‰æ‹©çš„äººå‘˜ç­›é€‰è®°å½•
            const filteredRecords = selectedName 
                ? deleteData.currentDateRecords.filter(r => r.name === selectedName)
                : deleteData.currentDateRecords;
            
            if (filteredRecords.length === 0) {
                recordSelect.innerHTML = '<option value="">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•</option>';
                return;
            }
            
            // æ˜¾ç¤ºæ‰¾åˆ°çš„è®°å½•
            filteredRecords.forEach((record) => {
                // è·å–è®°å½•çš„Firebaseé”®
                const recordKey = deleteData.recordKeys ? deleteData.recordKeys[JSON.stringify(record)] : null;
                const time = new Date(record.time).toLocaleString('zh-CN');
                const optionText = `${record.name} - ${time} - ${record.group || 'æœªçŸ¥å°ç»„'}`;
                const option = new Option(optionText, `record_${recordKey}`);
                recordSelect.add(option);
            });
            
            if (selectedName) {
                deleteLog(`æ˜¾ç¤º ${filteredRecords.length} æ¡ ${selectedName} çš„ç­¾åˆ°è®°å½•`, 'info');
            }
        }
        
        // æ£€æŸ¥è®°å½•é€‰æ‹©
        function checkRecordSelection() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            const deleteBtn = document.getElementById('deleteSelectedRecordsBtn');
            
            if (!recordSelect || !deleteBtn) return;
            
            const selectedOptions = Array.from(recordSelect.selectedOptions);
            deleteBtn.disabled = selectedOptions.length === 0;
        }
        
        // å…¨é€‰è®°å½•
        function selectAllRecords() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            if (!recordSelect) return;
            
            Array.from(recordSelect.options).forEach(option => {
                option.selected = true;
            });
            
            checkRecordSelection();
        }
        
        // æ¸…ç©ºé€‰æ‹©
        function clearAllRecords() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            if (!recordSelect) return;
            
            Array.from(recordSelect.options).forEach(option => {
                option.selected = false;
            });
            
            checkRecordSelection();
        }
        
        // åˆ é™¤é€‰ä¸­çš„ç­¾åˆ°è®°å½•ï¼ˆå¢å¼ºå®‰å…¨ç‰ˆæœ¬ï¼‰
        async function deleteSelectedAttendanceRecords() {
            const recordSelect = document.getElementById('deleteRecordSelect');
            if (!recordSelect) return;
            
            const selectedOptions = Array.from(recordSelect.selectedOptions);
            if (selectedOptions.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ç­¾åˆ°è®°å½•');
                return;
            }
            
            // ç¡®è®¤åˆ é™¤
            const confirmDelete = confirm(`ç¡®å®šè¦åˆ é™¤ ${selectedOptions.length} æ¡ç­¾åˆ°è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`);
            if (!confirmDelete) return;
            
            try {
                console.log('ğŸ” å¼€å§‹åˆ é™¤ç­¾åˆ°è®°å½•...');
                
                if (!window.db) {
                    throw new Error('Firebaseæœªåˆå§‹åŒ–');
                }
                
                // è·å–è¦åˆ é™¤çš„è®°å½•é”®ï¼ˆå¯èƒ½æ˜¯ç´¢å¼•æˆ–Firebaseå¯¹è±¡é”®ï¼‰
                const recordKeysToDelete = selectedOptions.map(option => {
                    const match = option.value.match(/record_(.+)/);
                    return match ? match[1] : null;
                }).filter(key => key !== null);
                
                console.log(`ğŸ“‹ è¦åˆ é™¤çš„è®°å½•é”®:`, recordKeysToDelete);
                
                // ğŸš¨ å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢è¯¯åˆ é™¤ï¼ˆå¹¶å‘æ£€æµ‹ï¼‰
                const latestSnapshot = await window.db.ref('attendanceRecords').once('value');
                const latestRecordsRaw = latestSnapshot.val() || [];
                const latestCount = Array.isArray(latestRecordsRaw) 
                    ? latestRecordsRaw.filter(r => r !== null && r !== undefined).length
                    : (typeof latestRecordsRaw === 'object' ? Object.keys(latestRecordsRaw).length : 0);
                
                if (latestCount !== deleteData.attendanceRecords.length) {
                    const proceed = confirm(
                        `âš ï¸ æ•°æ®å¹¶å‘å†²çªæ£€æµ‹\n\n` +
                        `é¡µé¢åŠ è½½æ—¶è®°å½•æ•°: ${deleteData.attendanceRecords.length}\n` +
                        `å½“å‰æœ€æ–°è®°å½•æ•°: ${latestCount}\n\n` +
                        `æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼\n` +
                        `å»ºè®®åˆ·æ–°é¡µé¢åé‡è¯•ã€‚\n\n` +
                        `æ˜¯å¦ä»è¦ç»§ç»­åˆ é™¤ï¼Ÿï¼ˆä¸æ¨èï¼‰`
                    );
                    if (!proceed) {
                        console.log('âŒ ç”¨æˆ·å–æ¶ˆæ“ä½œï¼ˆæ•°æ®å†²çªï¼‰');
                        return;
                    }
                }
                
                // ğŸ’¾ åˆ›å»ºæ•°æ®å¤‡ä»½
                console.log('ğŸ’¾ åˆ›å»ºæ•°æ®å¤‡ä»½...');
                const deletedRecords = recordKeysToDelete.map(key => {
                    // å¦‚æœæ˜¯æ•°å­—é”®ï¼Œè½¬æ¢ä¸ºæ•°å­—ç´¢å¼•
                    const idx = parseInt(key);
                    return isNaN(idx) ? null : deleteData.attendanceRecords[idx];
                }).filter(r => r !== null);
                const backupData = {
                    timestamp: new Date().toISOString(),
                    timestampMs: Date.now(),
                    operation: 'delete_attendance_records',
                    recordCount: recordKeysToDelete.length,
                    deletedRecords: deletedRecords,
                    recordKeys: recordKeysToDelete
                };
                try {
                    await window.db.ref(`backups/attendanceRecords/${Date.now()}`).set(backupData);
                    console.log('âœ… æ•°æ®å¤‡ä»½å·²åˆ›å»º');
                } catch (backupError) {
                    console.warn('âš ï¸ æ•°æ®å¤‡ä»½åˆ›å»ºå¤±è´¥ï¼ˆæƒé™ä¸è¶³ï¼‰:', backupError.message);
                }
                
                // é‡æ–°è¯»å–Firebaseæœ€æ–°æ•°æ®
                console.log('ğŸ“¡ é‡æ–°è¯»å–Firebaseå…¨éƒ¨æœ€æ–°æ•°æ®...');
                const allRecordsSnapshot = await window.db.ref('attendanceRecords').once('value');
                const allRecordsRaw = allRecordsSnapshot.val() || [];
                
                // è®¡ç®—è®°å½•æ€»æ•°ï¼ˆæ”¯æŒæ•°ç»„å’Œå¯¹è±¡æ ¼å¼ï¼‰
                const totalRecordCount = Array.isArray(allRecordsRaw) 
                    ? allRecordsRaw.filter(r => r !== null && r !== undefined).length
                    : (typeof allRecordsRaw === 'object' ? Object.keys(allRecordsRaw).length : 0);
                
                // æ•°æ®é‡éªŒè¯
                console.log('ğŸ” åˆ é™¤å‰æ•°æ®éªŒè¯:');
                console.log(`  - Firebaseå½“å‰è®°å½•æ€»æ•°: ${totalRecordCount}`);
                console.log(`  - è¦åˆ é™¤çš„è®°å½•æ•°: ${recordKeysToDelete.length}`);
                console.log(`  - åˆ é™¤ååº”ä¿ç•™è®°å½•æ•°: ${totalRecordCount - recordKeysToDelete.length}`);
                
                // ğŸš¨ å®‰å…¨æ£€æŸ¥ï¼šåˆ é™¤åè‡³å°‘åº”è¯¥æœ‰å¤§é‡å†å²æ•°æ®
                const expectedCount = totalRecordCount - recordKeysToDelete.length;
                if (expectedCount < 400) {
                    const proceed = confirm(
                        `âš ï¸ æ•°æ®å®‰å…¨è­¦å‘Š\n\n` +
                        `åˆ é™¤åå°†åªå‰© ${expectedCount} æ¡è®°å½•\n` +
                        `è¿™ä¼¼ä¹ä¸æ­£å¸¸ï¼ˆå†å²æ•°æ®åº”è¯¥æœ‰å‡ ç™¾æ¡ï¼‰\n\n` +
                        `æ˜¯å¦ç»§ç»­ï¼Ÿï¼ˆå»ºè®®å–æ¶ˆï¼Œæ£€æŸ¥æ•°æ®ï¼‰`
                    );
                    if (!proceed) {
                        console.log('âŒ ç”¨æˆ·å–æ¶ˆæ“ä½œï¼ˆæ•°æ®é‡å¼‚å¸¸ä¿æŠ¤ï¼‰');
                        return;
                    }
                }
                
                // åˆ›å»ºå¢å¼ºæ•°æ®å¤‡ä»½
                console.log('ğŸ’¾ åˆ›å»ºå¢å¼ºæ•°æ®å¤‡ä»½...');
                const enhancedDeletedRecords = recordKeysToDelete.map(key => {
                    // å¦‚æœæ˜¯æ•°ç»„æ ¼å¼ï¼Œkeyæ˜¯ç´¢å¼•ï¼›å¦‚æœæ˜¯å¯¹è±¡æ ¼å¼ï¼Œkeyæ˜¯é”®å
                    if (Array.isArray(allRecordsRaw)) {
                        const idx = parseInt(key);
                        return isNaN(idx) ? null : allRecordsRaw[idx];
                    } else {
                        return allRecordsRaw[key];
                    }
                }).filter(r => r !== null && r !== undefined);
                
                const enhancedBackupData = {
                    timestamp: new Date().toISOString(),
                    timestampMs: Date.now(),
                    operation: 'delete_attendance_records',
                    beforeDelete: {
                        totalCount: totalRecordCount,
                        recordsToDelete: recordKeysToDelete.length,
                        expectedAfterCount: expectedCount
                    },
                    deletedRecords: enhancedDeletedRecords,
                    recordKeys: recordKeysToDelete
                };
                
                // ä¿å­˜åˆ°localStorageä½œä¸ºç´§æ€¥å¤‡ä»½
                const emergencyBackupKey = `emergency_backup_${Date.now()}`;
                localStorage.setItem(emergencyBackupKey, JSON.stringify(allRecordsRaw));
                console.log(`âœ… ç´§æ€¥å¤‡ä»½å·²ä¿å­˜åˆ°localStorage (key: ${emergencyBackupKey})`);
                
                // å°è¯•ä¿å­˜åˆ°Firebase backupèŠ‚ç‚¹
                try {
                    await window.db.ref(`backups/enhanced_delete/${Date.now()}`).set(enhancedBackupData);
                    console.log('âœ… å¢å¼ºå¤‡ä»½å·²ä¿å­˜åˆ°Firebase');
                } catch (backupError) {
                    console.warn('âš ï¸ Firebaseå¤‡ä»½å¤±è´¥ï¼ˆæƒé™ä¸è¶³ï¼‰ï¼Œä½†localStorageå¤‡ä»½å·²å®Œæˆ');
                }
                
                // æ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆä½¿ç”¨updateå¢é‡æ›´æ–°ï¼Œè€Œésetè¦†ç›–ï¼‰
                console.log('ğŸ—‘ï¸ æ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆä½¿ç”¨å¢é‡æ›´æ–°ï¼‰...');
                
                // åˆ›å»ºæ›´æ–°å¯¹è±¡ï¼šå°†è¦åˆ é™¤çš„é”®è®¾ç½®ä¸ºnull
                const updates = {};
                recordKeysToDelete.forEach(key => {
                    updates[key] = null; // åˆ é™¤è¯¥é”®çš„è®°å½•
                });
                
                console.log('ğŸ” åˆ é™¤æ“ä½œè¯¦æƒ…:', { 
                    keysToDelete: recordKeysToDelete, 
                    updateCount: Object.keys(updates).length 
                });
                
                // ä½¿ç”¨updateè€Œésetï¼Œç¡®ä¿åªåˆ é™¤æŒ‡å®šè®°å½•
                await window.db.ref('attendanceRecords').update(updates);
                console.log('âœ… Firebaseåˆ é™¤æ“ä½œå®Œæˆ');
                
                // é‡æ–°è¯»å–éªŒè¯åˆ é™¤ç»“æœ
                const verifySnapshot = await window.db.ref('attendanceRecords').once('value');
                let finalRecords = verifySnapshot.val() || [];
                
                // æ¸…ç†nullå€¼å’Œundefinedï¼ˆupdateæ“ä½œå¯èƒ½ç•™ä¸‹nullï¼‰
                finalRecords = Array.isArray(finalRecords) 
                    ? finalRecords.filter(r => r !== null && r !== undefined)
                    : Object.values(finalRecords).filter(r => r !== null && r !== undefined);
                
                console.log('ğŸ” åˆ é™¤åæ•°æ®éªŒè¯:');
                console.log(`  - åˆ é™¤åå®é™…è®°å½•æ•°: ${finalRecords.length}`);
                console.log(`  - é¢„æœŸè®°å½•æ•°: ${expectedCount}`);
                
                // ğŸš¨ æ•°æ®å®Œæ•´æ€§éªŒè¯
                if (Math.abs(finalRecords.length - expectedCount) > 5) {
                    throw new Error(
                        `åˆ é™¤åæ•°æ®é‡å¼‚å¸¸ï¼\n` +
                        `é¢„æœŸ: ${expectedCount}æ¡\n` +
                        `å®é™…: ${finalRecords.length}æ¡\n` +
                        `å·®å¼‚: ${Math.abs(finalRecords.length - expectedCount)}æ¡\n` +
                        `ç´§æ€¥å¤‡ä»½key: ${emergencyBackupKey}`
                    );
                }
                
                console.log('âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡');
                
                // æ›´æ–°æœ¬åœ°æ•°æ®å’Œç¼“å­˜
                deleteData.attendanceRecords = finalRecords;
                localStorage.setItem('msh_attendanceRecords', JSON.stringify(finalRecords));
                console.log('âœ… æœ¬åœ°å­˜å‚¨å·²æ›´æ–°');
                
                // æ¸…é™¤ç›¸å…³æ—¥æœŸçš„ç¼“å­˜
                const deletedDates = new Set(
                    enhancedDeletedRecords
                        .filter(r => r && r.time)
                        .map(r => new Date(r.time).toISOString().split('T')[0])
                );
                deletedDates.forEach(date => {
                    sessionStorage.removeItem(`attendance_${date}`);
                    console.log(`ğŸ—‘ï¸ å·²æ¸…é™¤ ${date} çš„sessionStorageç¼“å­˜`);
                });
                
                // æ›´æ–°å…¨å±€å˜é‡
                if (window.attendanceRecords) {
                    window.attendanceRecords = finalRecords;
                }
                
                // å¦‚æœä½¿ç”¨NewDataManagerï¼ŒåŒæ­¥æ›´æ–°å…¶çŠ¶æ€
                if (window.NewDataManager && window.NewDataManager.updateAttendanceRecords) {
                    window.NewDataManager.updateAttendanceRecords(finalRecords);
                    console.log('âœ… NewDataManagerçŠ¶æ€å·²åŒæ­¥');
                }
                
                // è®°å½•æ“ä½œåˆ°Firebaseï¼ˆå¯é€‰ï¼Œå¦‚æœæœ‰æƒé™ï¼‰
                try {
                    await logOperationToFirebase('delete_attendance_records', {
                        recordCount: recordKeysToDelete.length,
                        timestamp: new Date().toISOString(),
                        deletedKeys: recordKeysToDelete
                    });
                } catch (logError) {
                    console.warn('âš ï¸ æ“ä½œæ—¥å¿—è®°å½•å¤±è´¥ï¼ˆæƒé™ä¸è¶³ï¼‰');
                }
                
                deleteLog(`âœ… æˆåŠŸåˆ é™¤ ${recordKeysToDelete.length} æ¡ç­¾åˆ°è®°å½•`, 'success');
                console.log(`âœ… åˆ é™¤æ“ä½œå®Œæˆï¼åˆ é™¤äº† ${recordKeysToDelete.length} æ¡è®°å½•`);
                
                // åˆ·æ–°æ˜¾ç¤º
                const dateInput = document.getElementById('deleteDate');
                if (dateInput && dateInput.value) {
                    await loadMemberRecords(); // é‡æ–°åŠ è½½ä»¥æ›´æ–°æ˜¾ç¤º
                }
                alert(`åˆ é™¤æˆåŠŸï¼\n\nå·²åˆ é™¤ ${recordKeysToDelete.length} æ¡ç­¾åˆ°è®°å½•`);
                
            } catch (error) {
                console.error('âŒ åˆ é™¤ç­¾åˆ°è®°å½•å¤±è´¥:', error);
                deleteLog(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }
        
        // åˆ é™¤äººå‘˜
        async function deleteMember() {
            const memberSelect = document.getElementById('deleteMemberSelect');
            if (!memberSelect || !memberSelect.value) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„äººå‘˜');
                return;
            }
            
            try {
                const member = JSON.parse(memberSelect.value);
                const groupKey = document.getElementById('deleteGroupSelect').value;
                
                // è®¡ç®—è¦åˆ é™¤çš„è®°å½•æ•°
                const recordsToDelete = deleteData.attendanceRecords.filter(r => 
                    r.name === member.name && r.uuid === member.uuid
                ).length;
                
                // ç¡®è®¤åˆ é™¤
                if (!confirm(
                    `ç¡®å®šè¦åˆ é™¤äººå‘˜ "${member.name}" å—ï¼Ÿ\n\n` +
                    `æ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ï¼š\n` +
                    `- è¯¥äººå‘˜çš„æ‰€æœ‰ç­¾åˆ°è®°å½•ï¼ˆ${recordsToDelete}æ¡ï¼‰\n\n` +
                    `æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`
                )) {
                    return;
                }
                
                deleteLog(`å¼€å§‹åˆ é™¤äººå‘˜: ${member.name}...`);
                deleteLog(`è¯¥äººå‘˜æœ‰ ${recordsToDelete} æ¡ç­¾åˆ°è®°å½•`, 'info');
                
                const db = firebase.database();
                
                // ğŸš¨ å¹¶å‘æ£€æµ‹ï¼šé‡æ–°è¯»å–Firebaseæœ€æ–°æ•°æ®
                const latestSnapshot = await db.ref('attendanceRecords').once('value');
                const latestRecords = latestSnapshot.val() || [];
                const latestCount = Array.isArray(latestRecords) 
                    ? latestRecords.filter(r => r !== null && r !== undefined).length
                    : (typeof latestRecords === 'object' ? Object.keys(latestRecords).length : 0);
                
                if (latestCount !== deleteData.attendanceRecords.length) {
                    const proceed = confirm(
                        `âš ï¸ æ•°æ®å¹¶å‘å†²çªæ£€æµ‹\n\n` +
                        `é¡µé¢åŠ è½½æ—¶è®°å½•æ•°: ${deleteData.attendanceRecords.length}\n` +
                        `å½“å‰æœ€æ–°è®°å½•æ•°: ${latestCount}\n\n` +
                        `æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼å»ºè®®åˆ·æ–°é¡µé¢åé‡è¯•ã€‚\n\n` +
                        `æ˜¯å¦ä»è¦ç»§ç»­ï¼Ÿï¼ˆä¸æ¨èï¼‰`
                    );
                    if (!proceed) {
                        deleteLog('âŒ ç”¨æˆ·å–æ¶ˆæ“ä½œï¼ˆæ•°æ®å†²çªï¼‰', 'warning');
                        return;
                    }
                }
                
                // ä»å°ç»„ä¸­åˆ é™¤æˆå‘˜
                const groupMembers = deleteData.groups[groupKey] || [];
                const updatedMembers = groupMembers.filter(m => 
                    !(m.name === member.name && m.uuid === member.uuid)
                );
                
                await db.ref(`groups/${groupKey}`).set(updatedMembers);
                deleteLog(`å·²ä»å°ç»„ä¸­åˆ é™¤äººå‘˜`, 'success');
                
                // åˆ é™¤è¯¥äººå‘˜çš„æ‰€æœ‰ç­¾åˆ°è®°å½•
                const beforeCount = deleteData.attendanceRecords.length;
                const updatedRecords = deleteData.attendanceRecords.filter(r => 
                    !(r.name === member.name && r.uuid === member.uuid)
                );
                const afterCount = updatedRecords.length;
                const actualDeleted = beforeCount - afterCount;
                
                // ğŸš¨ æ•°æ®é‡å®‰å…¨æ£€æŸ¥
                if (afterCount < 400) {
                    const proceed = confirm(
                        `âš ï¸ æ•°æ®å®‰å…¨è­¦å‘Š\n\n` +
                        `åˆ é™¤åå°†åªå‰© ${afterCount} æ¡è®°å½•\n` +
                        `è¿™ä¼¼ä¹ä¸æ­£å¸¸ï¼ˆå†å²æ•°æ®åº”è¯¥æœ‰å‡ ç™¾æ¡ï¼‰\n\n` +
                        `æ˜¯å¦ç»§ç»­ï¼Ÿï¼ˆå»ºè®®å–æ¶ˆï¼Œæ£€æŸ¥æ•°æ®ï¼‰`
                    );
                    if (!proceed) {
                        deleteLog('âŒ ç”¨æˆ·å–æ¶ˆæ“ä½œï¼ˆæ•°æ®é‡å¼‚å¸¸ä¿æŠ¤ï¼‰', 'warning');
                        return;
                    }
                }
                
                // ğŸ’¾ åˆ›å»ºå¤‡ä»½
                const backupData = {
                    timestamp: new Date().toISOString(),
                    operation: 'delete_member',
                    memberName: member.name,
                    memberUUID: member.uuid,
                    recordsDeleted: actualDeleted,
                    beforeCount: beforeCount,
                    afterCount: afterCount
                };
                localStorage.setItem(`backup_delete_member_${Date.now()}`, JSON.stringify(backupData));
                deleteLog(`å·²åˆ›å»ºæœ¬åœ°å¤‡ä»½`, 'success');
                
                // æ‰§è¡Œåˆ é™¤ï¼ˆä½¿ç”¨setè¦†ç›–ï¼Œå› ä¸ºå·²åŠ è½½å…¨é‡æ•°æ®ï¼‰
                await db.ref('attendanceRecords').set(updatedRecords);
                deleteLog(`å·²åˆ é™¤ ${actualDeleted} æ¡ç­¾åˆ°è®°å½•`, 'success');
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                deleteData.groups[groupKey] = updatedMembers;
                deleteData.attendanceRecords = updatedRecords;
                
                // åˆ·æ–°UI
                updateGroupSelects();
                loadMembers();
                
                alert(`äººå‘˜ "${member.name}" å·²æˆåŠŸåˆ é™¤\nåˆ é™¤äº† ${actualDeleted} æ¡ç­¾åˆ°è®°å½•`);
                deleteLog(`âœ… äººå‘˜åˆ é™¤å®Œæˆ`, 'success');
                
            } catch (error) {
                deleteLog(`åˆ é™¤äººå‘˜å¤±è´¥: ${error.message}`, 'error');
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }
        
        // åˆ é™¤å°ç»„
        async function deleteGroup() {
            const groupSelect2 = document.getElementById('deleteGroupSelect2');
            if (!groupSelect2 || !groupSelect2.value) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å°ç»„');
                return;
            }
            
            try {
                const groupKey = groupSelect2.value;
                const groupName = deleteData.groupNames[groupKey];
                const members = deleteData.groups[groupKey] || [];
                const memberCount = members.length;
                const memberUUIDs = members.map(m => m.uuid);
                
                // è®¡ç®—è¦åˆ é™¤çš„è®°å½•æ•°
                const recordsToDelete = deleteData.attendanceRecords.filter(r => 
                    memberUUIDs.includes(r.uuid)
                ).length;
                
                // ç¡®è®¤åˆ é™¤
                if (!confirm(
                    `ç¡®å®šè¦åˆ é™¤å°ç»„ "${groupName}" å—ï¼Ÿ\n\n` +
                    `è¯¥å°ç»„æœ‰ ${memberCount} ä¸ªæˆå‘˜\n` +
                    `æ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ï¼š\n` +
                    `- å°ç»„æœ¬èº«\n` +
                    `- æ‰€æœ‰æˆå‘˜ï¼ˆ${memberCount}äººï¼‰\n` +
                    `- æ‰€æœ‰æˆå‘˜çš„ç­¾åˆ°è®°å½•ï¼ˆ${recordsToDelete}æ¡ï¼‰\n\n` +
                    `æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`
                )) {
                    return;
                }
                
                deleteLog(`å¼€å§‹åˆ é™¤å°ç»„: ${groupName}...`);
                deleteLog(`å°ç»„æœ‰ ${memberCount} ä¸ªæˆå‘˜ï¼Œ${recordsToDelete} æ¡ç­¾åˆ°è®°å½•`, 'info');
                
                const db = firebase.database();
                
                // ğŸš¨ å¹¶å‘æ£€æµ‹ï¼šé‡æ–°è¯»å–Firebaseæœ€æ–°æ•°æ®
                const latestSnapshot = await db.ref('attendanceRecords').once('value');
                const latestRecords = latestSnapshot.val() || [];
                const latestCount = Array.isArray(latestRecords) 
                    ? latestRecords.filter(r => r !== null && r !== undefined).length
                    : (typeof latestRecords === 'object' ? Object.keys(latestRecords).length : 0);
                
                if (latestCount !== deleteData.attendanceRecords.length) {
                    const proceed = confirm(
                        `âš ï¸ æ•°æ®å¹¶å‘å†²çªæ£€æµ‹\n\n` +
                        `é¡µé¢åŠ è½½æ—¶è®°å½•æ•°: ${deleteData.attendanceRecords.length}\n` +
                        `å½“å‰æœ€æ–°è®°å½•æ•°: ${latestCount}\n\n` +
                        `æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼å»ºè®®åˆ·æ–°é¡µé¢åé‡è¯•ã€‚\n\n` +
                        `æ˜¯å¦ä»è¦ç»§ç»­ï¼Ÿï¼ˆä¸æ¨èï¼‰`
                    );
                    if (!proceed) {
                        deleteLog('âŒ ç”¨æˆ·å–æ¶ˆæ“ä½œï¼ˆæ•°æ®å†²çªï¼‰', 'warning');
                        return;
                    }
                }
                
                // åˆ é™¤å°ç»„
                await db.ref(`groups/${groupKey}`).remove();
                deleteLog(`å·²åˆ é™¤å°ç»„æ•°æ®`, 'success');
                
                // åˆ é™¤å°ç»„åç§°
                await db.ref(`groupNames/${groupKey}`).remove();
                deleteLog(`å·²åˆ é™¤å°ç»„åç§°`, 'success');
                
                // åˆ é™¤è¯¥å°ç»„æ‰€æœ‰æˆå‘˜çš„ç­¾åˆ°è®°å½•
                const beforeCount = deleteData.attendanceRecords.length;
                const updatedRecords = deleteData.attendanceRecords.filter(r => 
                    !memberUUIDs.includes(r.uuid)
                );
                const afterCount = updatedRecords.length;
                const actualDeleted = beforeCount - afterCount;
                
                // ğŸš¨ æ•°æ®é‡å®‰å…¨æ£€æŸ¥
                if (afterCount < 400) {
                    const proceed = confirm(
                        `âš ï¸ æ•°æ®å®‰å…¨è­¦å‘Š\n\n` +
                        `åˆ é™¤åå°†åªå‰© ${afterCount} æ¡è®°å½•\n` +
                        `è¿™ä¼¼ä¹ä¸æ­£å¸¸ï¼ˆå†å²æ•°æ®åº”è¯¥æœ‰å‡ ç™¾æ¡ï¼‰\n\n` +
                        `æ˜¯å¦ç»§ç»­ï¼Ÿï¼ˆå»ºè®®å–æ¶ˆï¼Œæ£€æŸ¥æ•°æ®ï¼‰`
                    );
                    if (!proceed) {
                        deleteLog('âŒ ç”¨æˆ·å–æ¶ˆæ“ä½œï¼ˆæ•°æ®é‡å¼‚å¸¸ä¿æŠ¤ï¼‰', 'warning');
                        return;
                    }
                }
                
                // ğŸ’¾ åˆ›å»ºå¤‡ä»½
                const backupData = {
                    timestamp: new Date().toISOString(),
                    operation: 'delete_group',
                    groupKey: groupKey,
                    groupName: groupName,
                    memberCount: memberCount,
                    recordsDeleted: actualDeleted,
                    beforeCount: beforeCount,
                    afterCount: afterCount,
                    memberUUIDs: memberUUIDs
                };
                localStorage.setItem(`backup_delete_group_${Date.now()}`, JSON.stringify(backupData));
                deleteLog(`å·²åˆ›å»ºæœ¬åœ°å¤‡ä»½`, 'success');
                
                // æ‰§è¡Œåˆ é™¤ï¼ˆä½¿ç”¨setè¦†ç›–ï¼Œå› ä¸ºå·²åŠ è½½å…¨é‡æ•°æ®ï¼‰
                await db.ref('attendanceRecords').set(updatedRecords);
                deleteLog(`å·²åˆ é™¤ ${actualDeleted} æ¡ç­¾åˆ°è®°å½•`, 'success');
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                delete deleteData.groups[groupKey];
                delete deleteData.groupNames[groupKey];
                deleteData.attendanceRecords = updatedRecords;
                
                // åˆ·æ–°UI
                updateGroupSelects();
                
                alert(`å°ç»„ "${groupName}" å·²æˆåŠŸåˆ é™¤\nåˆ é™¤äº† ${memberCount} ä¸ªæˆå‘˜å’Œ ${actualDeleted} æ¡ç­¾åˆ°è®°å½•`);
                deleteLog(`âœ… å°ç»„åˆ é™¤å®Œæˆ`, 'success');
                
            } catch (error) {
                deleteLog(`åˆ é™¤å°ç»„å¤±è´¥: ${error.message}`, 'error');
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ‰¹é‡æ¸…ç†
        async function batchCleanup() {
            const cleanupDays = parseInt(document.getElementById('cleanupDays').value);
            const cleanupType = document.getElementById('cleanupType').value;
            
            // è®¡ç®—æˆªæ­¢æ—¥æœŸ
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - cleanupDays);
            const cutoffTime = cutoffDate.getTime();
            
            // ç¡®è®¤æ¸…ç†
            if (!confirm(
                `ç¡®å®šè¦æ¸…ç† ${cleanupDays} å¤©å‰çš„æ•°æ®å—ï¼Ÿ\n\n` +
                `æ¸…ç†ç±»å‹: ${cleanupType === 'attendance' ? 'ä»…ç­¾åˆ°è®°å½•' : 'æ‰€æœ‰æ•°æ®'}\n` +
                `æˆªæ­¢æ—¥æœŸ: ${cutoffDate.toLocaleDateString('zh-CN')}\n\n` +
                `æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`
            )) {
                return;
            }
            
            try {
                deleteLog(`å¼€å§‹æ‰¹é‡æ¸…ç† ${cleanupDays} å¤©å‰çš„æ•°æ®...`);
                
                const db = firebase.database();
                
                if (cleanupType === 'attendance') {
                    // åªæ¸…ç†ç­¾åˆ°è®°å½•
                    const filteredRecords = deleteData.attendanceRecords.filter(r => {
                        if (!r || !r.time) return true; // ä¿ç•™æ— æ•ˆè®°å½•
                        return new Date(r.time).getTime() >= cutoffTime;
                    });
                    
                    const removedCount = deleteData.attendanceRecords.length - filteredRecords.length;
                    
                    await db.ref('attendanceRecords').set(filteredRecords);
                    deleteData.attendanceRecords = filteredRecords;
                    
                    deleteLog(`âœ… æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† ${removedCount} æ¡ç­¾åˆ°è®°å½•`, 'success');
                    alert(`æ¸…ç†æˆåŠŸï¼\nåˆ é™¤äº† ${removedCount} æ¡ç­¾åˆ°è®°å½•`);
                    
                } else {
                    // æ¸…ç†æ‰€æœ‰æ•°æ®ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
                    alert('æ­¤åŠŸèƒ½éœ€è¦æ›´é«˜çº§çš„æƒé™ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜');
                }
                
                // åˆ·æ–°æ˜¾ç¤º
                loadAttendanceRecords();
                
            } catch (error) {
                deleteLog(`æ‰¹é‡æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
                alert(`æ¸…ç†å¤±è´¥: ${error.message}`);
            }
        }
        
        // è®°å½•æ“ä½œåˆ°Firebase
        async function logOperationToFirebase(operation, details) {
            try {
                const db = firebase.database();
                const logEntry = {
                    operation,
                    details,
                    timestamp: new Date().toISOString(),
                    timestampMs: Date.now()
                };
                
                await db.ref(`operationLogs/${Date.now()}`).set(logEntry);
            } catch (error) {
                // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ä¸»è¦æ“ä½œ
                console.warn('æ“ä½œæ—¥å¿—è®°å½•å¤±è´¥:', error);
            }
        }
        
        // æ—¥å¿—è¾“å‡ºå‡½æ•°
        function deleteLog(message, type = 'info') {
            const logContainer = document.getElementById('deleteLogContainer');
            if (!logContainer) return;
            
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
            const consoleMethod = type === 'error' ? 'error' : type === 'warning' ? 'warn' : 'log';
            console[consoleMethod](`[åˆ é™¤ç®¡ç†] ${message}`);
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearDeleteLog() {
            const logContainer = document.getElementById('deleteLogContainer');
            if (logContainer) {
                logContainer.innerHTML = '<div class="log-entry info">æ—¥å¿—å·²æ¸…ç©º</div>';
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', async function() {
            deleteLog('åˆ é™¤ç®¡ç†å·¥å…·åŠ è½½ä¸­...');
            
            // ç¡®ä¿Firebaseå·²åˆå§‹åŒ–
            if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                deleteLog('Firebaseå·²åˆå§‹åŒ–', 'success');
                if (!window.db) {
                    window.db = firebase.database();
                }
                await loadDeleteData();
            } else {
                deleteLog('Firebaseæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
        });
    </script>
</body>
</html>

