<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»æ—¥è·Ÿè¸ªé¦–æ¬¡è®¡ç®—å·¥å…·</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="../../src/smart-config-loader.js"></script>
    <script src="../../src/core/time-utils.js"></script>
    <script src="../../src/new-data-manager.js"></script>
    <script src="../../src/features/sunday-tracking-utils.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f4f7f6; 
            color: #333; 
        }
        .container { 
            max-width: 1200px; 
            margin: auto; 
            background: #fff; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .button-group { 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            margin: 30px 0; 
            flex-wrap: wrap; 
        }
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            color: white;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        button.primary { background-color: #3498db; }
        button.primary:hover:not(:disabled) { background-color: #2980b9; transform: translateY(-2px); }
        button.secondary { background-color: #2ecc71; }
        button.secondary:hover:not(:disabled) { background-color: #27ae60; transform: translateY(-2px); }
        button.warning { background-color: #f39c12; }
        button.warning:hover:not(:disabled) { background-color: #e67e22; transform: translateY(-2px); }
        .log-container { 
            background-color: #ecf0f1; 
            border-radius: 5px; 
            padding: 15px; 
            max-height: 600px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
        }
        .log-item { 
            margin-bottom: 8px; 
            font-size: 14px; 
            line-height: 1.4; 
        }
        .log-item.info { color: #34495e; }
        .log-item.success { color: #27ae60; }
        .log-item.warning { color: #f39c12; }
        .log-item.error { color: #c0392b; font-weight: bold; }
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background-color: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background-color: #3498db;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .summary {
            margin-top: 20px;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ä¸»æ—¥è·Ÿè¸ªé¦–æ¬¡è®¡ç®—å·¥å…·</h1>
        
        <div class="form-group">
            <label for="startDate">å¼€å§‹æ—¥æœŸï¼ˆé¦–ä¸ªä¸»æ—¥ï¼‰:</label>
            <input type="date" id="startDate" value="2025-08-03">
        </div>
        
        <div class="form-group">
            <label for="endDate">ç»“æŸæ—¥æœŸï¼ˆæœ€åä¸€ä¸ªä¸»æ—¥ï¼‰:</label>
            <input type="date" id="endDate">
        </div>
        
        <div class="button-group">
            <button class="primary" id="initializeButton">å¼€å§‹é¦–æ¬¡è®¡ç®—</button>
            <button class="secondary" id="generateDailyReportsButton">ç”ŸæˆDailyReports</button>
            <button class="warning" id="checkStatusButton">æ£€æŸ¥è®¡ç®—çŠ¶æ€</button>
            <button class="danger" id="clearLogButton">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
            </div>
            <div id="progressText" style="text-align: center; margin-top: 10px;"></div>
        </div>
        
        <div class="summary" id="summary"></div>
        <div class="log-container">
            <div id="log"></div>
        </div>
    </div>

    <script>
        // Firebaseåˆå§‹åŒ–
        let db;
        if (!firebase.apps.length) {
            firebase.initializeApp(window.firebaseConfig);
        }
        if (!window.db) {
            db = firebase.database();
            window.db = db;
        } else {
            db = window.db;
        }
        
        const logElement = document.getElementById('log');
        const summaryElement = document.getElementById('summary');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        
        // åˆå§‹åŒ–ç»“æŸæ—¥æœŸä¸ºä»Šå¤©
        const today = new Date();
        const nextSunday = getNextSunday(today);
        document.getElementById('endDate').value = formatDate(nextSunday);
        
        function appendLog(message, type = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(logItem);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getNextSunday(date) {
            const day = date.getDay();
            const diff = day === 0 ? 7 : 7 - day;
            const nextSunday = new Date(date);
            nextSunday.setDate(date.getDate() + diff);
            return nextSunday;
        }
        
        function getPreviousSunday(date) {
            const day = date.getDay();
            const diff = day === 0 ? 7 : day;
            const previousSunday = new Date(date);
            previousSunday.setDate(date.getDate() - diff);
            return previousSunday;
        }
        
        function getSundayDatesBetween(startDate, endDate) {
            const sundays = [];
            let current = new Date(startDate);
            const end = new Date(endDate);
            
            // ç¡®ä¿ä»å‘¨æ—¥å¼€å§‹
            if (current.getDay() !== 0) {
                current = getNextSunday(current);
            }
            
            while (current <= end) {
                sundays.push(formatDate(current));
                current.setDate(current.getDate() + 7);
            }
            
            return sundays;
        }
        
        function updateProgress(current, total, message) {
            const percentage = Math.round((current / total) * 100);
            progressFill.style.width = `${percentage}%`;
            progressFill.textContent = `${percentage}%`;
            progressText.textContent = message || `å¤„ç†ä¸­: ${current}/${total}`;
        }
        
        document.getElementById('clearLogButton').addEventListener('click', () => {
            logElement.innerHTML = '';
            summaryElement.innerHTML = '';
            appendLog('æ—¥å¿—å·²æ¸…ç©ºã€‚', 'info');
        });
        
        // æ£€æŸ¥è®¡ç®—çŠ¶æ€
        document.getElementById('checkStatusButton').addEventListener('click', async () => {
            appendLog('å¼€å§‹æ£€æŸ¥è®¡ç®—çŠ¶æ€...', 'info');
            summaryElement.innerHTML = '';
            
            try {
                const snapshot = await db.ref('sundayTrackingWeekly').once('value');
                if (!snapshot.exists()) {
                    appendLog('âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è®¡ç®—ç»“æœ', 'warning');
                    return;
                }
                
                const calculations = snapshot.val();
                const sundayDates = Object.keys(calculations).sort();
                
                appendLog(`âœ… æ‰¾åˆ° ${sundayDates.length} å‘¨çš„è®¡ç®—ç»“æœ`, 'success');
                appendLog(`æœ€æ—©: ${sundayDates[0]}`, 'info');
                appendLog(`æœ€æ–°: ${sundayDates[sundayDates.length - 1]}`, 'info');
                
                summaryElement.innerHTML = `
                    <div>æ€»å‘¨æ•°: ${sundayDates.length}</div>
                    <div>æœ€æ—©å‘¨: ${sundayDates[0]}</div>
                    <div>æœ€æ–°å‘¨: ${sundayDates[sundayDates.length - 1]}</div>
                `;
            } catch (error) {
                appendLog(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        });
        
        // ç”ŸæˆDailyReports
        document.getElementById('generateDailyReportsButton').addEventListener('click', async () => {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                appendLog('âŒ è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ', 'error');
                return;
            }
            
            appendLog('å¼€å§‹ç”ŸæˆDailyReports...', 'info');
            progressContainer.style.display = 'block';
            
            const sundayDates = getSundayDatesBetween(startDate, endDate);
            appendLog(`éœ€è¦ç”Ÿæˆ ${sundayDates.length} å‘¨çš„DailyReports`, 'info');
            
            let completed = 0;
            let failed = 0;
            
            // ç­‰å¾…æ•°æ®ç®¡ç†å™¨åˆå§‹åŒ–
            await new Promise(resolve => {
                if (window.newDataManager && window.newDataManager.isDataLoaded) {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (window.newDataManager && window.newDataManager.isDataLoaded) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                }
            });
            
            // åˆå§‹åŒ–summaryPage
            if (!window.summaryPage) {
                window.summaryPage = {
                    loadAttendanceDataForDate: async function(date) {
                        try {
                            const startOfDay = new Date(date);
                            startOfDay.setHours(0, 0, 0, 0);
                            const endOfDay = new Date(date);
                            endOfDay.setHours(23, 59, 59, 999);
                            
                            const startTime = startOfDay.toISOString();
                            const endTime = endOfDay.toISOString();
                            
                            const snapshot = await db.ref('attendanceRecords')
                                .orderByChild('time')
                                .startAt(startTime)
                                .endAt(endTime)
                                .once('value');
                            
                            if (!snapshot.exists()) {
                                return [];
                            }
                            
                            const records = [];
                            snapshot.forEach(child => {
                                records.push(child.val());
                            });
                            
                            return records;
                        } catch (error) {
                            console.error('åŠ è½½ç­¾åˆ°è®°å½•å¤±è´¥:', error);
                            return [];
                        }
                    }
                };
            }
            
            for (let i = 0; i < sundayDates.length; i++) {
                const sundayDate = sundayDates[i];
                updateProgress(i, sundayDates.length, `ç”Ÿæˆ ${sundayDate} çš„DailyReport...`);
                
                try {
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    const existingSnapshot = await db.ref(`dailyReports/${sundayDate}`).once('value');
                    if (existingSnapshot.exists()) {
                        appendLog(`â­ï¸ ${sundayDate} å·²å­˜åœ¨ï¼Œè·³è¿‡`, 'info');
                        completed++;
                        continue;
                    }
                    
                    // åŠ è½½ç­¾åˆ°è®°å½•
                    const dateRecords = await window.summaryPage.loadAttendanceDataForDate(sundayDate);
                    appendLog(`ğŸ“Š ${sundayDate}: åŠ è½½åˆ° ${dateRecords.length} æ¡ç­¾åˆ°è®°å½•`, 'info');
                    
                    // è·å–æ‰€æœ‰æˆå‘˜
                    const allMembers = window.utils.SundayTrackingManager.getAllMembers();
                    
                    // è®¡ç®—å·²ç­¾åˆ°çš„æˆå‘˜UUID
                    const signedUUIDs = new Set();
                    dateRecords.forEach(record => {
                        const identifier = record.memberUUID || record.name;
                        if (identifier) {
                            signedUUIDs.add(identifier);
                        }
                    });
                    
                    // è®¡ç®—æœªç­¾åˆ°çš„æˆå‘˜
                    const unsignedMembers = allMembers.filter(member => {
                        const memberUUID = member.uuid || member.name;
                        return !signedUUIDs.has(memberUUID);
                    });
                    
                    // æ„å»ºå·²ç­¾åˆ°æˆå‘˜åˆ—è¡¨
                    const signedMembers = [];
                    dateRecords.forEach(record => {
                        const identifier = record.memberUUID || record.name;
                        if (signedUUIDs.has(identifier)) {
                            if (!signedMembers.find(m => (m.uuid || m.name) === identifier)) {
                                signedMembers.push({
                                    uuid: record.memberUUID || record.name,
                                    name: record.name,
                                    group: record.group,
                                    time: record.time,
                                    memberSnapshot: record.memberSnapshot,
                                    groupSnapshot: record.groupSnapshot
                                });
                            }
                        }
                    });
                    
                    // æ„å»ºæœªç­¾åˆ°æˆå‘˜åˆ—è¡¨
                    const unsignedMembersList = unsignedMembers.map(member => ({
                        uuid: member.uuid,
                        name: member.name,
                        group: member.group
                    }));
                    
                    // æ„å»ºæ—¥æŠ¥è¡¨æ•°æ®
                    const dailyReportData = {
                        date: sundayDate,
                        signedMembers: signedMembers,
                        unsignedMembers: unsignedMembersList,
                        totalSigned: signedMembers.length,
                        totalUnsigned: unsignedMembersList.length,
                        totalMembers: allMembers.length,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    // ä¿å­˜åˆ°Firebase
                    await db.ref(`dailyReports/${sundayDate}`).update(dailyReportData);
                    appendLog(`âœ… ${sundayDate}: å·²ä¿å­˜DailyReport (ç­¾åˆ°: ${signedMembers.length}, æœªç­¾åˆ°: ${unsignedMembersList.length})`, 'success');
                    completed++;
                } catch (error) {
                    appendLog(`âŒ ${sundayDate}: ç”Ÿæˆå¤±è´¥ - ${error.message}`, 'error');
                    failed++;
                }
            }
            
            updateProgress(sundayDates.length, sundayDates.length, 'å®Œæˆ');
            summaryElement.innerHTML = `
                <div>å®Œæˆ: ${completed}/${sundayDates.length}</div>
                <div>å¤±è´¥: ${failed}</div>
            `;
            appendLog(`âœ… DailyReportsç”Ÿæˆå®Œæˆ: æˆåŠŸ ${completed} ä¸ªï¼Œå¤±è´¥ ${failed} ä¸ª`, 'success');
        });
        
        // å¼€å§‹é¦–æ¬¡è®¡ç®—
        document.getElementById('initializeButton').addEventListener('click', async () => {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                appendLog('âŒ è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ', 'error');
                return;
            }
            
            appendLog('å¼€å§‹é¦–æ¬¡è®¡ç®—...', 'info');
            progressContainer.style.display = 'block';
            
            const sundayDates = getSundayDatesBetween(startDate, endDate);
            appendLog(`éœ€è¦è®¡ç®— ${sundayDates.length} å‘¨çš„æ•°æ®`, 'info');
            
            // ç­‰å¾…æ•°æ®ç®¡ç†å™¨åˆå§‹åŒ–
            await new Promise(resolve => {
                if (window.newDataManager && window.newDataManager.isDataLoaded) {
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (window.newDataManager && window.newDataManager.isDataLoaded) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                }
            });
            
            let completed = 0;
            let failed = 0;
            let skipped = 0;
            
            for (let i = 0; i < sundayDates.length; i++) {
                const sundayDate = sundayDates[i];
                updateProgress(i, sundayDates.length, `è®¡ç®— ${sundayDate}...`);
                
                try {
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    const existingSnapshot = await db.ref(`sundayTrackingWeekly/${sundayDate}`).once('value');
                    if (existingSnapshot.exists()) {
                        appendLog(`â­ï¸ ${sundayDate} å·²å­˜åœ¨ï¼Œè·³è¿‡`, 'info');
                        skipped++;
                        completed++;
                        continue;
                    }
                    
                    // æ‰§è¡Œè®¡ç®—ï¼ˆæ‰¹é‡è®¡ç®—æ—¶è·³è¿‡æ¸…ç†ï¼Œæ‰¹é‡è®¡ç®—å®Œæˆåç»Ÿä¸€æ¸…ç†ï¼‰
                    if (i === 0) {
                        // ç¬¬ä¸€å‘¨ä½¿ç”¨é¦–æ¬¡è®¡ç®—
                        const result = await window.utils.SundayTrackingManager.calculateFirstWeek(sundayDate, true);
                        if (result) {
                            appendLog(`âœ… ${sundayDate}: é¦–æ¬¡è®¡ç®—å®Œæˆï¼Œè®¡ç®—äº† ${Object.keys(result).length} ä¸ªæˆå‘˜`, 'success');
                            completed++;
                        } else {
                            appendLog(`âš ï¸ ${sundayDate}: è®¡ç®—å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç¼ºå°‘dailyReportï¼‰`, 'warning');
                            failed++;
                        }
                    } else {
                        // åç»­å‘¨ä½¿ç”¨å¢é‡è®¡ç®—
                        const result = await window.utils.SundayTrackingManager.calculateIncrementalWeek(sundayDate, true);
                        if (result) {
                            appendLog(`âœ… ${sundayDate}: å¢é‡è®¡ç®—å®Œæˆï¼Œè®¡ç®—äº† ${Object.keys(result).length} ä¸ªæˆå‘˜`, 'success');
                            completed++;
                        } else {
                            appendLog(`âš ï¸ ${sundayDate}: è®¡ç®—å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç¼ºå°‘dailyReportï¼‰`, 'warning');
                            failed++;
                        }
                    }
                } catch (error) {
                    appendLog(`âŒ ${sundayDate}: è®¡ç®—å¤±è´¥ - ${error.message}`, 'error');
                    failed++;
                }
            }
            
            // æ‰¹é‡è®¡ç®—å®Œæˆåï¼Œç»Ÿä¸€æ‰§è¡Œæ¸…ç†ï¼ˆåªä¿ç•™æœ€æ–°10å‘¨ï¼‰
            appendLog('ğŸ§¹ æ‰¹é‡è®¡ç®—å®Œæˆï¼Œæ‰§è¡Œæ¸…ç†æ“ä½œ...', 'info');
            await window.utils.SundayTrackingManager.cleanupOldWeeklyCalculations(10);
            
            updateProgress(sundayDates.length, sundayDates.length, 'å®Œæˆ');
            summaryElement.innerHTML = `
                <div>å®Œæˆ: ${completed}/${sundayDates.length}</div>
                <div>è·³è¿‡: ${skipped}</div>
                <div>å¤±è´¥: ${failed}</div>
            `;
            appendLog(`âœ… é¦–æ¬¡è®¡ç®—å®Œæˆ: æˆåŠŸ ${completed} ä¸ªï¼Œè·³è¿‡ ${skipped} ä¸ªï¼Œå¤±è´¥ ${failed} ä¸ª`, 'success');
        });
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            appendLog('é¡µé¢åŠ è½½å®Œæˆï¼Œç­‰å¾…æ•°æ®ç®¡ç†å™¨åˆå§‹åŒ–...', 'info');
            
            // ç­‰å¾…æ•°æ®ç®¡ç†å™¨åˆå§‹åŒ–
            await new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (window.newDataManager && window.newDataManager.isDataLoaded) {
                        clearInterval(checkInterval);
                        appendLog('âœ… æ•°æ®ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ', 'success');
                        resolve();
                    }
                }, 100);
                
                // è¶…æ—¶å¤„ç†
                setTimeout(() => {
                    clearInterval(checkInterval);
                    appendLog('âš ï¸ æ•°æ®ç®¡ç†å™¨åˆå§‹åŒ–è¶…æ—¶ï¼Œä½†å¯ä»¥ç»§ç»­æ“ä½œ', 'warning');
                    resolve();
                }, 10000);
            });
        });
    </script>
</body>
</html>
