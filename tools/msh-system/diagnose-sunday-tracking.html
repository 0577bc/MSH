<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»æ—¥è·Ÿè¸ªæ•°æ®ç»“æ„è¯Šæ–­å·¥å…·</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="../../src/smart-config-loader.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
        .button-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            color: white;
        }
        button.primary { background-color: #3498db; }
        button.primary:hover { background-color: #2980b9; transform: translateY(-2px); }
        button.secondary { background-color: #2ecc71; }
        button.secondary:hover { background-color: #27ae60; transform: translateY(-2px); }
        button.warning { background-color: #f39c12; }
        button.warning:hover { background-color: #e67e22; transform: translateY(-2px); }
        button.danger { background-color: #e74c3c; }
        button.danger:hover { background-color: #c0392b; transform: translateY(-2px); }
        .log-container { background-color: #ecf0f1; border-radius: 5px; padding: 15px; max-height: 600px; overflow-y: auto; border: 1px solid #ddd; }
        .log-item { margin-bottom: 8px; font-size: 14px; line-height: 1.4; }
        .log-item.info { color: #34495e; }
        .log-item.success { color: #27ae60; }
        .log-item.warning { color: #f39c12; }
        .log-item.error { color: #c0392b; font-weight: bold; }
        .summary { margin-top: 20px; font-size: 16px; font-weight: bold; color: #2c3e50; }
        .data-structure { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin: 15px 0; }
        .record-item { background-color: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0; }
        .record-header { font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .record-field { margin: 2px 0; font-size: 12px; }
        .field-missing { color: #dc3545; font-weight: bold; }
        .field-present { color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ä¸»æ—¥è·Ÿè¸ªæ•°æ®ç»“æ„è¯Šæ–­å·¥å…·</h1>
        <div class="button-group">
            <button class="primary" id="diagnoseButton">è¯Šæ–­Firebaseæ•°æ®ç»“æ„</button>
            <button class="secondary" id="fixButton">ä¿®å¤æ•°æ®ç»“æ„</button>
            <button class="warning" id="regenerateButton">é‡æ–°ç”Ÿæˆäº‹ä»¶</button>
            <button class="danger" id="clearLogButton">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="summary" id="summary"></div>
        <div class="log-container">
            <div id="log"></div>
        </div>
    </div>

    <script>
        // Firebaseåˆå§‹åŒ–
        if (!firebase.apps.length) {
            firebase.initializeApp(window.firebaseConfig);
        }
        const db = firebase.database();
        const logElement = document.getElementById('log');
        const summaryElement = document.getElementById('summary');

        function appendLog(message, type = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(logItem);
            logElement.scrollTop = logElement.scrollHeight;
        }

        document.getElementById('clearLogButton').addEventListener('click', () => {
            logElement.innerHTML = '';
            summaryElement.innerHTML = '';
            appendLog('æ—¥å¿—å·²æ¸…ç©ºã€‚', 'info');
        });

        document.getElementById('diagnoseButton').addEventListener('click', async () => {
            appendLog('å¼€å§‹è¯Šæ–­Firebaseæ•°æ®ç»“æ„...', 'info');
            summaryElement.innerHTML = '';
            
            try {
                // 1. æ£€æŸ¥sundayTrackingæ ¹èŠ‚ç‚¹
                const sundayTrackingSnapshot = await db.ref('sundayTracking').once('value');
                const sundayTrackingData = sundayTrackingSnapshot.val();
                
                appendLog('=== Firebase sundayTracking æ•°æ®ç»“æ„åˆ†æ ===', 'info');
                
                if (!sundayTrackingData) {
                    appendLog('âŒ sundayTrackingèŠ‚ç‚¹ä¸å­˜åœ¨æˆ–ä¸ºç©º', 'error');
                    return;
                }
                
                // åˆ†ææ•°æ®ç»“æ„
                const dataKeys = Object.keys(sundayTrackingData);
                appendLog(`ğŸ“Š sundayTrackingèŠ‚ç‚¹åŒ…å« ${dataKeys.length} ä¸ªé”®`, 'info');
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯UUIDæ ¼å¼çš„é”®
                const uuidKeys = dataKeys.filter(key => /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(key));
                const numericKeys = dataKeys.filter(key => /^\d+$/.test(key));
                
                appendLog(`ğŸ” UUIDæ ¼å¼é”®: ${uuidKeys.length} ä¸ª`, 'info');
                appendLog(`ğŸ” æ•°å­—æ ¼å¼é”®: ${numericKeys.length} ä¸ª`, 'info');
                
                if (numericKeys.length > 0) {
                    appendLog('âš ï¸ å‘ç°æ•°å­—æ ¼å¼é”®ï¼Œè¿™å¯èƒ½æ˜¯æ•°æ®ç»“æ„é—®é¢˜', 'warning');
                }
                
                // åˆ†æå‰å‡ ä¸ªè®°å½•çš„ç»“æ„
                const sampleKeys = dataKeys.slice(0, 3);
                for (const key of sampleKeys) {
                    const record = sundayTrackingData[key];
                    appendLog(`\nğŸ“‹ è®°å½• ${key}:`, 'info');
                    appendLog(`  ç±»å‹: ${typeof record}`, 'info');
                    
                    if (typeof record === 'object' && record !== null) {
                        const recordKeys = Object.keys(record);
                        appendLog(`  åŒ…å«å­—æ®µ: ${recordKeys.join(', ')}`, 'info');
                        
                        // æ£€æŸ¥å…³é”®å­—æ®µ
                        const criticalFields = ['recordId', 'status', 'updatedAt', 'createdAt', 'memberUUID'];
                        criticalFields.forEach(field => {
                            if (record[field] !== undefined) {
                                appendLog(`  âœ… ${field}: ${record[field]}`, 'success');
                            } else {
                                appendLog(`  âŒ ${field}: ç¼ºå¤±`, 'error');
                            }
                        });
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰mainTrackingå­èŠ‚ç‚¹
                        if (record.mainTracking) {
                            appendLog(`  âœ… mainTracking: å­˜åœ¨`, 'success');
                        } else {
                            appendLog(`  âŒ mainTracking: ç¼ºå¤±`, 'error');
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰personalTrackingå­èŠ‚ç‚¹
                        if (record.personalTracking) {
                            appendLog(`  âœ… personalTracking: å­˜åœ¨`, 'success');
                        } else {
                            appendLog(`  âŒ personalTracking: ç¼ºå¤±`, 'error');
                        }
                    }
                }
                
                // 2. æ£€æŸ¥localStorageä¸­çš„æ•°æ®
                appendLog('\n=== localStorage æ•°æ®åˆ†æ ===', 'info');
                const localData = localStorage.getItem('msh_sunday_tracking');
                if (localData) {
                    const parsedData = JSON.parse(localData);
                    appendLog(`ğŸ“Š localStorageä¸­æœ‰ ${parsedData.length} æ¡è®°å½•`, 'info');
                    
                    if (parsedData.length > 0) {
                        const sampleRecord = parsedData[0];
                        appendLog(`ğŸ“‹ ç¤ºä¾‹è®°å½•ç»“æ„:`, 'info');
                        Object.keys(sampleRecord).forEach(key => {
                            const value = sampleRecord[key];
                            if (value !== undefined && value !== null) {
                                appendLog(`  âœ… ${key}: ${typeof value === 'object' ? JSON.stringify(value).substring(0, 50) + '...' : value}`, 'success');
                            } else {
                                appendLog(`  âŒ ${key}: ${value}`, 'error');
                            }
                        });
                    }
                } else {
                    appendLog('âŒ localStorageä¸­æ²¡æœ‰msh_sunday_trackingæ•°æ®', 'error');
                }
                
                summaryElement.innerHTML = `
                    <p><strong>è¯Šæ–­æ€»ç»“:</strong></p>
                    <p>Firebase sundayTracking: ${dataKeys.length} ä¸ªé”®</p>
                    <p>UUIDæ ¼å¼é”®: ${uuidKeys.length} ä¸ª</p>
                    <p>æ•°å­—æ ¼å¼é”®: ${numericKeys.length} ä¸ª</p>
                    <p>localStorageè®°å½•: ${localData ? JSON.parse(localData).length : 0} æ¡</p>
                `;
                
            } catch (error) {
                appendLog(`è¯Šæ–­å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        });

        document.getElementById('fixButton').addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦ä¿®å¤Firebaseæ•°æ®ç»“æ„å—ï¼Ÿæ­¤æ“ä½œå°†ä¿®æ”¹Firebaseæ•°æ®ã€‚')) {
                return;
            }
            
            appendLog('å¼€å§‹ä¿®å¤Firebaseæ•°æ®ç»“æ„...', 'info');
            summaryElement.innerHTML = '';
            
            try {
                // è·å–å½“å‰æ•°æ®
                const sundayTrackingSnapshot = await db.ref('sundayTracking').once('value');
                const currentData = sundayTrackingSnapshot.val();
                
                if (!currentData) {
                    appendLog('âŒ æ²¡æœ‰æ‰¾åˆ°sundayTrackingæ•°æ®', 'error');
                    return;
                }
                
                const dataKeys = Object.keys(currentData);
                const numericKeys = dataKeys.filter(key => /^\d+$/.test(key));
                
                if (numericKeys.length === 0) {
                    appendLog('âœ… æ•°æ®ç»“æ„çœ‹èµ·æ¥æ­£å¸¸ï¼Œæ— éœ€ä¿®å¤', 'success');
                    return;
                }
                
                appendLog(`å‘ç° ${numericKeys.length} ä¸ªæ•°å­—æ ¼å¼é”®ï¼Œå¼€å§‹ä¿®å¤...`, 'warning');
                
                // å¤‡ä»½åŸå§‹æ•°æ®
                await db.ref('sundayTracking_backup_before_fix').set(currentData);
                appendLog('âœ… å·²å¤‡ä»½åŸå§‹æ•°æ®åˆ° sundayTracking_backup_before_fix', 'success');
                
                // ä¿®å¤æ•°æ®ç»“æ„
                const fixedData = {};
                let fixedCount = 0;
                
                for (const key of dataKeys) {
                    const record = currentData[key];
                    
                    if (/^\d+$/.test(key)) {
                        // è¿™æ˜¯æ•°å­—æ ¼å¼çš„é”®ï¼Œéœ€è¦ä¿®å¤
                        if (record && typeof record === 'object') {
                            // ä¸ºè®°å½•æ·»åŠ å¿…è¦çš„å­—æ®µ
                            const fixedRecord = {
                                ...record,
                                recordId: record.recordId || `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                status: record.status || 'active',
                                createdAt: record.createdAt || Date.now(),
                                updatedAt: record.updatedAt || Date.now(),
                                mainTracking: record.mainTracking || {},
                                personalTracking: record.personalTracking || {}
                            };
                            
                            // ä½¿ç”¨UUIDä½œä¸ºæ–°é”®ï¼ˆå¦‚æœè®°å½•ä¸­æœ‰memberUUIDï¼‰
                            const newKey = record.memberUUID || `fixed_${key}`;
                            fixedData[newKey] = fixedRecord;
                            fixedCount++;
                            appendLog(`ä¿®å¤è®°å½• ${key} -> ${newKey}`, 'success');
                        }
                    } else {
                        // ä¿æŒåŸæœ‰è®°å½•
                        fixedData[key] = record;
                    }
                }
                
                // ä¿å­˜ä¿®å¤åçš„æ•°æ®
                await db.ref('sundayTracking').set(fixedData);
                appendLog(`âœ… æ•°æ®ç»“æ„ä¿®å¤å®Œæˆï¼å…±ä¿®å¤ ${fixedCount} æ¡è®°å½•`, 'success');
                
                summaryElement.innerHTML = `
                    <p><strong>ä¿®å¤æ€»ç»“:</strong></p>
                    <p>ä¿®å¤è®°å½•æ•°: ${fixedCount}</p>
                    <p>åŸå§‹æ•°æ®å·²å¤‡ä»½åˆ° sundayTracking_backup_before_fix</p>
                `;
                
            } catch (error) {
                appendLog(`ä¿®å¤å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        });

        document.getElementById('regenerateButton').addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆæ‰€æœ‰äº‹ä»¶å—ï¼Ÿæ­¤æ“ä½œå°†æ¸…ç©ºç°æœ‰äº‹ä»¶å¹¶é‡æ–°ç”Ÿæˆã€‚')) {
                return;
            }
            
            appendLog('å¼€å§‹é‡æ–°ç”Ÿæˆæ‰€æœ‰äº‹ä»¶...', 'info');
            summaryElement.innerHTML = '';
            
            try {
                // æ¸…ç©ºç°æœ‰æ•°æ®
                await db.ref('sundayTracking').remove();
                appendLog('âœ… å·²æ¸…ç©ºç°æœ‰sundayTrackingæ•°æ®', 'success');
                
                // è¿™é‡Œéœ€è¦è°ƒç”¨MSHç³»ç»Ÿçš„äº‹ä»¶ç”Ÿæˆé€»è¾‘
                appendLog('âš ï¸ éœ€è¦è°ƒç”¨MSHç³»ç»Ÿçš„äº‹ä»¶ç”Ÿæˆé€»è¾‘æ¥é‡æ–°ç”Ÿæˆäº‹ä»¶', 'warning');
                appendLog('è¯·ä½¿ç”¨ä¸»æ—¥è·Ÿè¸ªé¡µé¢çš„"é‡æ–°ç”Ÿæˆäº‹ä»¶"åŠŸèƒ½', 'info');
                
                summaryElement.innerHTML = `
                    <p><strong>é‡æ–°ç”Ÿæˆæ€»ç»“:</strong></p>
                    <p>å·²æ¸…ç©ºç°æœ‰æ•°æ®</p>
                    <p>è¯·ä½¿ç”¨ä¸»æ—¥è·Ÿè¸ªé¡µé¢é‡æ–°ç”Ÿæˆäº‹ä»¶</p>
                `;
                
            } catch (error) {
                appendLog(`é‡æ–°ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        });
    </script>
</body>
</html>


