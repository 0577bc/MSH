<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UUIDçŠ¶æ€åˆ†æå·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .export-section {
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 6px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .export-button {
            background: #28a745;
        }
        .export-button:hover {
            background: #1e7e34;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        .data-status {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” UUIDçŠ¶æ€åˆ†æå·¥å…·</h1>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalRecords">-</div>
                <div class="stat-label">æ€»ç­¾åˆ°è®°å½•</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="withUUID">-</div>
                <div class="stat-label">æœ‰UUIDè®°å½•</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="withoutUUID">-</div>
                <div class="stat-label">æ— UUIDè®°å½•</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="coverage">-</div>
                <div class="stat-label">UUIDè¦†ç›–ç‡</div>
            </div>
        </div>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="export-section">
            <h3>ğŸ“Š åˆ†æç»“æœ</h3>
            <button onclick="analyzeUUIDStatus()">å¼€å§‹åˆ†æ</button>
            <button onclick="checkDataAvailability()">æ£€æŸ¥æ•°æ®å¯ç”¨æ€§</button>
            <button onclick="importData()">å¯¼å…¥æ•°æ®</button>
            <button class="export-button" onclick="exportMissingUUIDs()" id="exportBtn" disabled>å¯¼å‡ºç¼ºå°‘UUIDçš„è®°å½•</button>
            <button class="export-button" onclick="exportCSV()" id="exportCSVBtn" disabled>å¯¼å‡ºCSVæ ¼å¼</button>
        </div>
        
        <div id="importSection" style="margin: 20px 0; padding: 15px; background: #e9ecef; border-radius: 6px; display: none;">
            <h4>ğŸ“¥ æ•°æ®å¯¼å…¥</h4>
            <p>å¦‚æœæ— æ³•è‡ªåŠ¨è¯»å–æ•°æ®ï¼Œè¯·æ‰‹åŠ¨å¯¼å…¥ï¼š</p>
            <input type="file" id="dataFile" accept=".json" style="margin: 10px 0;">
            <button onclick="loadImportedData()">åŠ è½½å¯¼å…¥çš„æ•°æ®</button>
            <div id="importResult" style="margin-top: 10px;"></div>
        </div>
        
        <div id="dataStatus" class="data-status">
            <h4>ğŸ“‹ æ•°æ®çŠ¶æ€</h4>
            <div id="dataStatusContent"></div>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        let analysisResults = null;
        
        function analyzeUUIDStatus() {
            console.log('ğŸ” å¼€å§‹åˆ†æUUIDçŠ¶æ€...');
            
            try {
                // å°è¯•ä»å¤šä¸ªæ¥æºè·å–æ•°æ®
                let attendanceRecords = window.attendanceRecords;
                let groups = window.groups;
                
                // å¦‚æœå…¨å±€å˜é‡ä¸å­˜åœ¨ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨è¯»å–
                if (!attendanceRecords || attendanceRecords.length === 0) {
                    console.log('ğŸ“¦ å°è¯•ä»æœ¬åœ°å­˜å‚¨è¯»å–æ•°æ®...');
                    try {
                        const storedRecords = localStorage.getItem('msh_attendanceRecords');
                        if (storedRecords) {
                            attendanceRecords = JSON.parse(storedRecords);
                            console.log('âœ… ä»æœ¬åœ°å­˜å‚¨è¯»å–ç­¾åˆ°è®°å½•:', attendanceRecords.length, 'æ¡');
                        }
                    } catch (error) {
                        console.error('âŒ è¯»å–æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
                    }
                }
                
                if (!groups || Object.keys(groups).length === 0) {
                    console.log('ğŸ“¦ å°è¯•ä»æœ¬åœ°å­˜å‚¨è¯»å–æˆå‘˜æ•°æ®...');
                    try {
                        const storedGroups = localStorage.getItem('msh_groups');
                        if (storedGroups) {
                            groups = JSON.parse(storedGroups);
                            console.log('âœ… ä»æœ¬åœ°å­˜å‚¨è¯»å–æˆå‘˜æ•°æ®:', Object.keys(groups).length, 'ä¸ªç»„');
                        }
                    } catch (error) {
                        console.error('âŒ è¯»å–æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
                    }
                }
                
                if (!attendanceRecords || attendanceRecords.length === 0) {
                    alert('âŒ æœªæ‰¾åˆ°ç­¾åˆ°è®°å½•æ•°æ®\n\nè¯·å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š\n1. å…ˆæ‰“å¼€ä¸»ç³»ç»Ÿé¡µé¢ (index.html) å¹¶ç­‰å¾…æ•°æ®åŠ è½½\n2. æˆ–è€…ä½¿ç”¨"å¯¼å…¥æ•°æ®"åŠŸèƒ½æ‰‹åŠ¨å¯¼å…¥æ•°æ®');
                    return;
                }
                
                // è®¾ç½®å…¨å±€å˜é‡ä»¥ä¾¿å…¶ä»–å‡½æ•°ä½¿ç”¨
                window.attendanceRecords = attendanceRecords;
                window.groups = groups || {};
                
                let withUUID = 0;
                let withoutUUID = 0;
                const missingUUIDRecords = [];
                const uuidStats = {};
                const timeAnalysis = {};
                
                attendanceRecords.forEach(record => {
                    if (record.memberUUID) {
                        withUUID++;
                        const uuidType = record.memberUUID.startsWith('M') ? 'Member' : 'Other';
                        uuidStats[uuidType] = (uuidStats[uuidType] || 0) + 1;
                    } else {
                        withoutUUID++;
                        missingUUIDRecords.push({
                            name: record.name,
                            time: record.time,
                            group: record.group,
                            status: record.status,
                            id: record.id || 'N/A'
                        });
                        
                        const date = new Date(record.time).toLocaleDateString('zh-CN');
                        timeAnalysis[date] = (timeAnalysis[date] || 0) + 1;
                    }
                });
                
                let membersWithUUID = 0;
                let membersWithoutUUID = 0;
                const missingMemberUUIDs = [];
                
                Object.entries(groups).forEach(([groupName, members]) => {
                    members.forEach(member => {
                        if (member.uuid) {
                            membersWithUUID++;
                        } else {
                            membersWithoutUUID++;
                            missingMemberUUIDs.push({
                                name: member.name,
                                group: groupName,
                                id: member.id || 'N/A'
                            });
                        }
                    });
                });
                
                document.getElementById('totalRecords').textContent = attendanceRecords.length;
                document.getElementById('withUUID').textContent = withUUID;
                document.getElementById('withoutUUID').textContent = withoutUUID;
                document.getElementById('coverage').textContent = Math.round((withUUID / attendanceRecords.length) * 100) + '%';
                
                const coverage = (withUUID / attendanceRecords.length) * 100;
                document.getElementById('progressBar').style.width = coverage + '%';
                
                analysisResults = {
                    attendanceRecords: {
                        total: attendanceRecords.length,
                        withUUID,
                        withoutUUID,
                        coverage,
                        missingRecords: missingUUIDRecords,
                        timeAnalysis
                    },
                    members: {
                        total: membersWithUUID + membersWithoutUUID,
                        withUUID: membersWithUUID,
                        withoutUUID: membersWithoutUUID,
                        coverage: Math.round((membersWithUUID / (membersWithUUID + membersWithoutUUID)) * 100),
                        missingRecords: missingMemberUUIDs
                    },
                    uuidStats
                };
                
                displayResults();
                
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('exportCSVBtn').disabled = false;
                
                console.log('âœ… åˆ†æå®Œæˆ:', analysisResults);
                
            } catch (error) {
                console.error('âŒ åˆ†æå¤±è´¥:', error);
                alert('åˆ†æå¤±è´¥: ' + error.message);
            }
        }
        
        function displayResults() {
            if (!analysisResults) return;
            
            const resultsDiv = document.getElementById('results');
            const { attendanceRecords, members, uuidStats } = analysisResults;
            
            let html = '<h3>ğŸ“ˆ è¯¦ç»†åˆ†æç»“æœ</h3>';
            
            html += '<h4>ğŸ“ ç­¾åˆ°è®°å½•åˆ†æ</h4>';
            html += `<p>æ€»è®°å½•æ•°: ${attendanceRecords.total} | æœ‰UUID: ${attendanceRecords.withUUID} | æ— UUID: ${attendanceRecords.withoutUUID} | è¦†ç›–ç‡: ${attendanceRecords.coverage.toFixed(1)}%</p>`;
            
            if (Object.keys(uuidStats).length > 0) {
                html += '<h5>UUIDç±»å‹åˆ†å¸ƒ:</h5><ul>';
                Object.entries(uuidStats).forEach(([type, count]) => {
                    html += `<li>${type} UUID: ${count} æ¡</li>`;
                });
                html += '</ul>';
            }
            
            if (Object.keys(attendanceRecords.timeAnalysis).length > 0) {
                html += '<h5>ç¼ºå°‘UUIDçš„è®°å½•æŒ‰æ—¥æœŸåˆ†å¸ƒ:</h5><ul>';
                Object.entries(attendanceRecords.timeAnalysis)
                    .sort(([a], [b]) => new Date(a) - new Date(b))
                    .slice(0, 10)
                    .forEach(([date, count]) => {
                        html += `<li>${date}: ${count} æ¡</li>`;
                    });
                if (Object.keys(attendanceRecords.timeAnalysis).length > 10) {
                    html += `<li>... è¿˜æœ‰ ${Object.keys(attendanceRecords.timeAnalysis).length - 10} ä¸ªæ—¥æœŸ</li>`;
                }
                html += '</ul>';
            }
            
            html += '<h4>ğŸ‘¥ æˆå‘˜åˆ†æ</h4>';
            html += `<p>æ€»æˆå‘˜æ•°: ${members.total} | æœ‰UUID: ${members.withUUID} | æ— UUID: ${members.withoutUUID} | è¦†ç›–ç‡: ${members.coverage}%</p>`;
            
            resultsDiv.innerHTML = html;
        }
        
        function exportMissingUUIDs() {
            if (!analysisResults) {
                alert('è¯·å…ˆè¿›è¡Œåˆ†æ');
                return;
            }
            
            const data = {
                analysis: analysisResults,
                exportTime: new Date().toISOString(),
                systemInfo: {
                    userAgent: navigator.userAgent,
                    url: window.location.href
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `missing_uuids_analysis_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('âœ… å·²å¯¼å‡ºåˆ†æç»“æœ');
        }
        
        function exportCSV() {
            if (!analysisResults) {
                alert('è¯·å…ˆè¿›è¡Œåˆ†æ');
                return;
            }
            
            const { missingRecords } = analysisResults.attendanceRecords;
            
            const csvContent = [
                'å§“å,æ—¶é—´,ç»„åˆ«,çŠ¶æ€,å»ºè®®UUID',
                ...missingRecords.map(record => {
                    const suggestedUUID = `M_${record.name}_${new Date(record.time).getFullYear()}`;
                    return `${record.name},${record.time},${record.group},${record.status},${suggestedUUID}`;
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `missing_uuids_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('âœ… å·²å¯¼å‡ºCSVæ ¼å¼');
        }
        
        function checkDataAvailability() {
            console.log('ğŸ” æ£€æŸ¥æ•°æ®å¯ç”¨æ€§...');
            
            const statusDiv = document.getElementById('dataStatus');
            const contentDiv = document.getElementById('dataStatusContent');
            
            let html = '<ul>';
            
            // æ£€æŸ¥å…¨å±€å˜é‡
            if (window.attendanceRecords && window.attendanceRecords.length > 0) {
                html += `<li>âœ… ç­¾åˆ°è®°å½• (å…¨å±€å˜é‡): ${window.attendanceRecords.length} æ¡</li>`;
            } else {
                html += '<li>âŒ ç­¾åˆ°è®°å½• (å…¨å±€å˜é‡): æœªæ‰¾åˆ°</li>';
            }
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
            try {
                const storedRecords = localStorage.getItem('msh_attendanceRecords');
                if (storedRecords) {
                    const records = JSON.parse(storedRecords);
                    html += `<li>âœ… ç­¾åˆ°è®°å½• (æœ¬åœ°å­˜å‚¨): ${records.length} æ¡</li>`;
                } else {
                    html += '<li>âŒ ç­¾åˆ°è®°å½• (æœ¬åœ°å­˜å‚¨): æœªæ‰¾åˆ°</li>';
                }
            } catch (error) {
                html += '<li>âŒ ç­¾åˆ°è®°å½• (æœ¬åœ°å­˜å‚¨): è¯»å–å¤±è´¥</li>';
            }
            
            if (window.groups && Object.keys(window.groups).length > 0) {
                const totalMembers = Object.values(window.groups).flat().length;
                html += `<li>âœ… æˆå‘˜æ•°æ® (å…¨å±€å˜é‡): ${Object.keys(window.groups).length} ä¸ªç»„ï¼Œ${totalMembers} ä¸ªæˆå‘˜</li>`;
            } else {
                html += '<li>âŒ æˆå‘˜æ•°æ® (å…¨å±€å˜é‡): æœªæ‰¾åˆ°</li>';
            }
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„æˆå‘˜æ•°æ®
            try {
                const storedGroups = localStorage.getItem('msh_groups');
                if (storedGroups) {
                    const groups = JSON.parse(storedGroups);
                    const totalMembers = Object.values(groups).flat().length;
                    html += `<li>âœ… æˆå‘˜æ•°æ® (æœ¬åœ°å­˜å‚¨): ${Object.keys(groups).length} ä¸ªç»„ï¼Œ${totalMembers} ä¸ªæˆå‘˜</li>`;
                } else {
                    html += '<li>âŒ æˆå‘˜æ•°æ® (æœ¬åœ°å­˜å‚¨): æœªæ‰¾åˆ°</li>';
                }
            } catch (error) {
                html += '<li>âŒ æˆå‘˜æ•°æ® (æœ¬åœ°å­˜å‚¨): è¯»å–å¤±è´¥</li>';
            }
            
            html += '</ul>';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ•°æ®å¯ç”¨
            const hasGlobalData = window.attendanceRecords && window.attendanceRecords.length > 0;
            const hasLocalData = localStorage.getItem('msh_attendanceRecords');
            
            if (!hasGlobalData && !hasLocalData) {
                html += '<div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px;">';
                html += '<strong>ğŸ’¡ ä½¿ç”¨å»ºè®®:</strong><br>';
                html += '1. è¯·å…ˆæ‰“å¼€ä¸»ç³»ç»Ÿé¡µé¢ (index.html) å¹¶ç­‰å¾…æ•°æ®åŠ è½½<br>';
                html += '2. æˆ–è€…ç‚¹å‡»"å¯¼å…¥æ•°æ®"æŒ‰é’®æ‰‹åŠ¨å¯¼å…¥æ•°æ®æ–‡ä»¶<br>';
                html += '3. ç„¶åå›åˆ°æ­¤é¡µé¢è¿›è¡Œåˆ†æ';
                html += '</div>';
            }
            
            contentDiv.innerHTML = html;
            statusDiv.style.display = 'block';
            
            console.log('âœ… æ•°æ®å¯ç”¨æ€§æ£€æŸ¥å®Œæˆ');
        }
        
        function importData() {
            const importSection = document.getElementById('importSection');
            importSection.style.display = importSection.style.display === 'none' ? 'block' : 'none';
        }
        
        function loadImportedData() {
            const fileInput = document.getElementById('dataFile');
            const resultDiv = document.getElementById('importResult');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div style="color: red;">è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶</div>';
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    console.log('ğŸ“¥ å¯¼å…¥çš„æ•°æ®:', data);
                    
                    // æ£€æŸ¥æ•°æ®æ ¼å¼
                    if (data.attendanceRecords && Array.isArray(data.attendanceRecords)) {
                        window.attendanceRecords = data.attendanceRecords;
                        localStorage.setItem('msh_attendanceRecords', JSON.stringify(data.attendanceRecords));
                        console.log('âœ… ç­¾åˆ°è®°å½•å·²å¯¼å…¥:', data.attendanceRecords.length, 'æ¡');
                    }
                    
                    if (data.groups && typeof data.groups === 'object') {
                        window.groups = data.groups;
                        localStorage.setItem('msh_groups', JSON.stringify(data.groups));
                        console.log('âœ… æˆå‘˜æ•°æ®å·²å¯¼å…¥:', Object.keys(data.groups).length, 'ä¸ªç»„');
                    }
                    
                    resultDiv.innerHTML = '<div style="color: green;">âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼ç°åœ¨å¯ä»¥å¼€å§‹åˆ†æäº†ã€‚</div>';
                    
                    // è‡ªåŠ¨å¼€å§‹åˆ†æ
                    setTimeout(() => {
                        analyzeUUIDStatus();
                    }, 1000);
                    
                } catch (error) {
                    console.error('âŒ å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                    resultDiv.innerHTML = '<div style="color: red;">âŒ å¯¼å…¥å¤±è´¥: ' + error.message + '</div>';
                }
            };
            
            reader.readAsText(file);
        }
        
        window.addEventListener('load', () => {
            console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥æ•°æ®...');
            setTimeout(() => {
                if (window.attendanceRecords && window.attendanceRecords.length > 0) {
                    console.log('âœ… æ•°æ®å·²åŠ è½½ï¼Œå¼€å§‹è‡ªåŠ¨åˆ†æ');
                    analyzeUUIDStatus();
                } else {
                    console.log('â³ ç­‰å¾…æ•°æ®åŠ è½½...');
                    console.log('ğŸ’¡ è¯·ç¡®ä¿å·²æ‰“å¼€ä¸»ç³»ç»Ÿé¡µé¢å¹¶åŠ è½½äº†æ•°æ®');
                }
            }, 2000);
        });
        
        window.addEventListener('error', (event) => {
            console.error('âŒ é¡µé¢é”™è¯¯:', event.error);
            alert('é¡µé¢å‘ç”Ÿé”™è¯¯: ' + event.error.message);
        });
    </script>
</body>
</html>
