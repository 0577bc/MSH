<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UUID状态分析工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .export-section {
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 6px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .export-button {
            background: #28a745;
        }
        .export-button:hover {
            background: #1e7e34;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        .data-status {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 UUID状态分析工具</h1>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalRecords">-</div>
                <div class="stat-label">总签到记录</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="withUUID">-</div>
                <div class="stat-label">有UUID记录</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="withoutUUID">-</div>
                <div class="stat-label">无UUID记录</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="coverage">-</div>
                <div class="stat-label">UUID覆盖率</div>
            </div>
        </div>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="export-section">
            <h3>📊 分析结果</h3>
            <button onclick="analyzeUUIDStatus()">开始分析</button>
            <button onclick="checkDataAvailability()">检查数据可用性</button>
            <button onclick="importData()">导入数据</button>
            <button class="export-button" onclick="exportMissingUUIDs()" id="exportBtn" disabled>导出缺少UUID的记录</button>
            <button class="export-button" onclick="exportCSV()" id="exportCSVBtn" disabled>导出CSV格式</button>
        </div>
        
        <div id="importSection" style="margin: 20px 0; padding: 15px; background: #e9ecef; border-radius: 6px; display: none;">
            <h4>📥 数据导入</h4>
            <p>如果无法自动读取数据，请手动导入：</p>
            <input type="file" id="dataFile" accept=".json" style="margin: 10px 0;">
            <button onclick="loadImportedData()">加载导入的数据</button>
            <div id="importResult" style="margin-top: 10px;"></div>
        </div>
        
        <div id="dataStatus" class="data-status">
            <h4>📋 数据状态</h4>
            <div id="dataStatusContent"></div>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        let analysisResults = null;
        
        function analyzeUUIDStatus() {
            console.log('🔍 开始分析UUID状态...');
            
            try {
                // 尝试从多个来源获取数据
                let attendanceRecords = window.attendanceRecords;
                let groups = window.groups;
                
                // 如果全局变量不存在，尝试从本地存储读取
                if (!attendanceRecords || attendanceRecords.length === 0) {
                    console.log('📦 尝试从本地存储读取数据...');
                    try {
                        const storedRecords = localStorage.getItem('msh_attendanceRecords');
                        if (storedRecords) {
                            attendanceRecords = JSON.parse(storedRecords);
                            console.log('✅ 从本地存储读取签到记录:', attendanceRecords.length, '条');
                        }
                    } catch (error) {
                        console.error('❌ 读取本地存储失败:', error);
                    }
                }
                
                if (!groups || Object.keys(groups).length === 0) {
                    console.log('📦 尝试从本地存储读取成员数据...');
                    try {
                        const storedGroups = localStorage.getItem('msh_groups');
                        if (storedGroups) {
                            groups = JSON.parse(storedGroups);
                            console.log('✅ 从本地存储读取成员数据:', Object.keys(groups).length, '个组');
                        }
                    } catch (error) {
                        console.error('❌ 读取本地存储失败:', error);
                    }
                }
                
                if (!attendanceRecords || attendanceRecords.length === 0) {
                    alert('❌ 未找到签到记录数据\n\n请尝试以下方法：\n1. 先打开主系统页面 (index.html) 并等待数据加载\n2. 或者使用"导入数据"功能手动导入数据');
                    return;
                }
                
                // 设置全局变量以便其他函数使用
                window.attendanceRecords = attendanceRecords;
                window.groups = groups || {};
                
                let withUUID = 0;
                let withoutUUID = 0;
                const missingUUIDRecords = [];
                const uuidStats = {};
                const timeAnalysis = {};
                
                attendanceRecords.forEach(record => {
                    if (record.memberUUID) {
                        withUUID++;
                        const uuidType = record.memberUUID.startsWith('M') ? 'Member' : 'Other';
                        uuidStats[uuidType] = (uuidStats[uuidType] || 0) + 1;
                    } else {
                        withoutUUID++;
                        missingUUIDRecords.push({
                            name: record.name,
                            time: record.time,
                            group: record.group,
                            status: record.status,
                            id: record.id || 'N/A'
                        });
                        
                        const date = new Date(record.time).toLocaleDateString('zh-CN');
                        timeAnalysis[date] = (timeAnalysis[date] || 0) + 1;
                    }
                });
                
                let membersWithUUID = 0;
                let membersWithoutUUID = 0;
                const missingMemberUUIDs = [];
                
                Object.entries(groups).forEach(([groupName, members]) => {
                    members.forEach(member => {
                        if (member.uuid) {
                            membersWithUUID++;
                        } else {
                            membersWithoutUUID++;
                            missingMemberUUIDs.push({
                                name: member.name,
                                group: groupName,
                                id: member.id || 'N/A'
                            });
                        }
                    });
                });
                
                document.getElementById('totalRecords').textContent = attendanceRecords.length;
                document.getElementById('withUUID').textContent = withUUID;
                document.getElementById('withoutUUID').textContent = withoutUUID;
                document.getElementById('coverage').textContent = Math.round((withUUID / attendanceRecords.length) * 100) + '%';
                
                const coverage = (withUUID / attendanceRecords.length) * 100;
                document.getElementById('progressBar').style.width = coverage + '%';
                
                analysisResults = {
                    attendanceRecords: {
                        total: attendanceRecords.length,
                        withUUID,
                        withoutUUID,
                        coverage,
                        missingRecords: missingUUIDRecords,
                        timeAnalysis
                    },
                    members: {
                        total: membersWithUUID + membersWithoutUUID,
                        withUUID: membersWithUUID,
                        withoutUUID: membersWithoutUUID,
                        coverage: Math.round((membersWithUUID / (membersWithUUID + membersWithoutUUID)) * 100),
                        missingRecords: missingMemberUUIDs
                    },
                    uuidStats
                };
                
                displayResults();
                
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('exportCSVBtn').disabled = false;
                
                console.log('✅ 分析完成:', analysisResults);
                
            } catch (error) {
                console.error('❌ 分析失败:', error);
                alert('分析失败: ' + error.message);
            }
        }
        
        function displayResults() {
            if (!analysisResults) return;
            
            const resultsDiv = document.getElementById('results');
            const { attendanceRecords, members, uuidStats } = analysisResults;
            
            let html = '<h3>📈 详细分析结果</h3>';
            
            html += '<h4>📝 签到记录分析</h4>';
            html += `<p>总记录数: ${attendanceRecords.total} | 有UUID: ${attendanceRecords.withUUID} | 无UUID: ${attendanceRecords.withoutUUID} | 覆盖率: ${attendanceRecords.coverage.toFixed(1)}%</p>`;
            
            if (Object.keys(uuidStats).length > 0) {
                html += '<h5>UUID类型分布:</h5><ul>';
                Object.entries(uuidStats).forEach(([type, count]) => {
                    html += `<li>${type} UUID: ${count} 条</li>`;
                });
                html += '</ul>';
            }
            
            if (Object.keys(attendanceRecords.timeAnalysis).length > 0) {
                html += '<h5>缺少UUID的记录按日期分布:</h5><ul>';
                Object.entries(attendanceRecords.timeAnalysis)
                    .sort(([a], [b]) => new Date(a) - new Date(b))
                    .slice(0, 10)
                    .forEach(([date, count]) => {
                        html += `<li>${date}: ${count} 条</li>`;
                    });
                if (Object.keys(attendanceRecords.timeAnalysis).length > 10) {
                    html += `<li>... 还有 ${Object.keys(attendanceRecords.timeAnalysis).length - 10} 个日期</li>`;
                }
                html += '</ul>';
            }
            
            html += '<h4>👥 成员分析</h4>';
            html += `<p>总成员数: ${members.total} | 有UUID: ${members.withUUID} | 无UUID: ${members.withoutUUID} | 覆盖率: ${members.coverage}%</p>`;
            
            resultsDiv.innerHTML = html;
        }
        
        function exportMissingUUIDs() {
            if (!analysisResults) {
                alert('请先进行分析');
                return;
            }
            
            const data = {
                analysis: analysisResults,
                exportTime: new Date().toISOString(),
                systemInfo: {
                    userAgent: navigator.userAgent,
                    url: window.location.href
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `missing_uuids_analysis_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('✅ 已导出分析结果');
        }
        
        function exportCSV() {
            if (!analysisResults) {
                alert('请先进行分析');
                return;
            }
            
            const { missingRecords } = analysisResults.attendanceRecords;
            
            const csvContent = [
                '姓名,时间,组别,状态,建议UUID',
                ...missingRecords.map(record => {
                    const suggestedUUID = `M_${record.name}_${new Date(record.time).getFullYear()}`;
                    return `${record.name},${record.time},${record.group},${record.status},${suggestedUUID}`;
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `missing_uuids_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('✅ 已导出CSV格式');
        }
        
        function checkDataAvailability() {
            console.log('🔍 检查数据可用性...');
            
            const statusDiv = document.getElementById('dataStatus');
            const contentDiv = document.getElementById('dataStatusContent');
            
            let html = '<ul>';
            
            // 检查全局变量
            if (window.attendanceRecords && window.attendanceRecords.length > 0) {
                html += `<li>✅ 签到记录 (全局变量): ${window.attendanceRecords.length} 条</li>`;
            } else {
                html += '<li>❌ 签到记录 (全局变量): 未找到</li>';
            }
            
            // 检查本地存储
            try {
                const storedRecords = localStorage.getItem('msh_attendanceRecords');
                if (storedRecords) {
                    const records = JSON.parse(storedRecords);
                    html += `<li>✅ 签到记录 (本地存储): ${records.length} 条</li>`;
                } else {
                    html += '<li>❌ 签到记录 (本地存储): 未找到</li>';
                }
            } catch (error) {
                html += '<li>❌ 签到记录 (本地存储): 读取失败</li>';
            }
            
            if (window.groups && Object.keys(window.groups).length > 0) {
                const totalMembers = Object.values(window.groups).flat().length;
                html += `<li>✅ 成员数据 (全局变量): ${Object.keys(window.groups).length} 个组，${totalMembers} 个成员</li>`;
            } else {
                html += '<li>❌ 成员数据 (全局变量): 未找到</li>';
            }
            
            // 检查本地存储的成员数据
            try {
                const storedGroups = localStorage.getItem('msh_groups');
                if (storedGroups) {
                    const groups = JSON.parse(storedGroups);
                    const totalMembers = Object.values(groups).flat().length;
                    html += `<li>✅ 成员数据 (本地存储): ${Object.keys(groups).length} 个组，${totalMembers} 个成员</li>`;
                } else {
                    html += '<li>❌ 成员数据 (本地存储): 未找到</li>';
                }
            } catch (error) {
                html += '<li>❌ 成员数据 (本地存储): 读取失败</li>';
            }
            
            html += '</ul>';
            
            // 检查是否有任何数据可用
            const hasGlobalData = window.attendanceRecords && window.attendanceRecords.length > 0;
            const hasLocalData = localStorage.getItem('msh_attendanceRecords');
            
            if (!hasGlobalData && !hasLocalData) {
                html += '<div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px;">';
                html += '<strong>💡 使用建议:</strong><br>';
                html += '1. 请先打开主系统页面 (index.html) 并等待数据加载<br>';
                html += '2. 或者点击"导入数据"按钮手动导入数据文件<br>';
                html += '3. 然后回到此页面进行分析';
                html += '</div>';
            }
            
            contentDiv.innerHTML = html;
            statusDiv.style.display = 'block';
            
            console.log('✅ 数据可用性检查完成');
        }
        
        function importData() {
            const importSection = document.getElementById('importSection');
            importSection.style.display = importSection.style.display === 'none' ? 'block' : 'none';
        }
        
        function loadImportedData() {
            const fileInput = document.getElementById('dataFile');
            const resultDiv = document.getElementById('importResult');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div style="color: red;">请选择要导入的文件</div>';
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    console.log('📥 导入的数据:', data);
                    
                    // 检查数据格式
                    if (data.attendanceRecords && Array.isArray(data.attendanceRecords)) {
                        window.attendanceRecords = data.attendanceRecords;
                        localStorage.setItem('msh_attendanceRecords', JSON.stringify(data.attendanceRecords));
                        console.log('✅ 签到记录已导入:', data.attendanceRecords.length, '条');
                    }
                    
                    if (data.groups && typeof data.groups === 'object') {
                        window.groups = data.groups;
                        localStorage.setItem('msh_groups', JSON.stringify(data.groups));
                        console.log('✅ 成员数据已导入:', Object.keys(data.groups).length, '个组');
                    }
                    
                    resultDiv.innerHTML = '<div style="color: green;">✅ 数据导入成功！现在可以开始分析了。</div>';
                    
                    // 自动开始分析
                    setTimeout(() => {
                        analyzeUUIDStatus();
                    }, 1000);
                    
                } catch (error) {
                    console.error('❌ 导入数据失败:', error);
                    resultDiv.innerHTML = '<div style="color: red;">❌ 导入失败: ' + error.message + '</div>';
                }
            };
            
            reader.readAsText(file);
        }
        
        window.addEventListener('load', () => {
            console.log('📄 页面加载完成，开始检查数据...');
            setTimeout(() => {
                if (window.attendanceRecords && window.attendanceRecords.length > 0) {
                    console.log('✅ 数据已加载，开始自动分析');
                    analyzeUUIDStatus();
                } else {
                    console.log('⏳ 等待数据加载...');
                    console.log('💡 请确保已打开主系统页面并加载了数据');
                }
            }, 2000);
        });
        
        window.addEventListener('error', (event) => {
            console.error('❌ 页面错误:', event.error);
            alert('页面发生错误: ' + event.error.message);
        });
    </script>
</body>
</html>
